
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GTA地图 - 洛圣都</title>
    
    <!-- Base URL for relative paths -->
    <base href="/">
        <!-- FontAwesome 6 Free for custom checkbox icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />

    <style>
        /* CSS变量系统 - 定义GTA风格的蓝色主题 */
        :root {
            --gta-bg-dark: #0a1929;
            --gta-bg-medium: rgba(15, 25, 35, 0.95);
            --gta-bg-light: rgba(25, 40, 55, 0.7);
            --gta-primary: #1976d2;
            --gta-primary-glow: rgba(25, 118, 210, 0.7);
            --gta-secondary: #2196f3;
            --gta-border: #2e5c8a;
            --gta-border-light: #4a90e2;
            --gta-text: #ffffff;
            --gta-text-secondary: #b3d9ff;
            --gta-accent: #42a5f5;
            /* 兼容变量映射，供佩里科样式复用（蓝色主题） */
            --bg-darker: var(--gta-bg-medium);
            --primary-color: var(--gta-primary);
            --primary-dark: #145a9e;
            --accent-color: var(--gta-accent);
            --border-color: var(--gta-border);
            --text-secondary: var(--gta-text-secondary);
            --transition: all 0.15s ease;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--gta-bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* 禁止移动端缩放（捏合/双击） */
            touch-action: manipulation; /* 限制手势为基本交互，阻止双指缩放 */
            -ms-touch-action: manipulation;
            -webkit-text-size-adjust: 100%; /* 防止 iOS 双击放大文本 */
        }

        /* 隐藏整体页面的滚动条（右侧和底部），但不影响内部可滚动面板样式 */
        html, body {
            overflow: hidden; /* 隐藏全局滚动 */
        }

        /* WebKit 浏览器隐藏滚动条轨道，但保留滚动功能（用于内部滚动容器） */
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* Firefox 隐藏滚动条（仍可滚动） */
        html, body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }

        /* 主容器 */
        #map-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
            overflow: visible !important;
        }
        #map-container:active { cursor: grabbing; }

        /* #tile-pane 已废弃（DOM 标记层已移除） */

        /* 隐藏地图上的游戏原点显示（若存在） */
        #origin-marker {
            display: none !important;
        }

        /* 加载动画 */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gta-text);
            background: var(--gta-bg-medium);
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 800;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
            pointer-events: none;
            border: 1px solid var(--gta-border);
        }
        .loader.visible { opacity: 1; pointer-events: auto; }

        /* 文件识别状态 */
        #file-status {
            position: absolute;
            left: 15px;
            top: 15px;
            background: rgba(0,0,0,0.7);
            color: var(--gta-text);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
            z-index: 750;
            font-size: 13px;
            pointer-events: none;
            min-width: 180px;
        }
        #file-status.ok { background: rgba(21,128,61,0.9); }
        #file-status.warn { background: rgba(170,85,0,0.9); }
        #file-status.err { background: rgba(128,20,20,0.9); }

        /* 物品标记样式（已废弃，DOM 标记已移除） */

        /* 佩里科岛风格：物品选择器（蓝色主题） */
        .item-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .item-checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            width: 100%;
        }

        .item-checkbox {
            display: none;
        }

        /* 隐藏原生复选，使用紧凑的 label 做替代 */
        .item-checkbox + label {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
            width: 100%;
            color: var(--gta-text);
            gap: 4px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            /* 放在标题后面显示，不再需要额外左边距 */
            margin-left: 0;
            align-items: center;
        }

        .nav-links a {
            color: white; /* 链接字体改为白色 */
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        /* 当时间/天气位于导航链接旁时的微调样式 */
        .gta-nav .nav-left #game-time-weather {
            margin-left: 8px;
            font-size: 13px;
            opacity: 0.95;
            color: rgba(255,255,255,0.95);
            pointer-events: none;
        }

        .gta-nav .nav-left .nav-weather {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            color: white !important;
            font-size: 13px;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .gta-nav .nav-left #game-time-weather {
                margin-left: 10px;
                display: inline-flex !important;
                align-items: center;
                color: white !important;
            }
        }

        /* 强覆盖，保证移动端/导航内始终可见 */
        .gta-nav .nav-left #game-time-weather {
            display: inline-flex !important;
            align-items: center !important;
            color: white !important;
        }

        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        /* 移动端强制覆盖：确保标题左对齐，不被后续全局规则影响 */
        @media (max-width: 768px) {
            .gta-nav .nav-left {
                flex: 0 0 auto !important;
                flex-grow: 0 !important;
                justify-content: flex-start !important;
            }
            .gta-nav .nav-right {
                margin-left: auto !important;
            }
            .gta-title { text-align: left !important; }
        }

        .nav-buttons-desktop {
            display: flex;
            gap: 15px;
        }

        /* 移动端样式 */
        .nav-buttons-mobile {
            display: none;
        }

        /* 移动端导航：仅显示标题与“更多”按钮，其余链接放入下拉菜单 */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .nav-buttons-desktop { display: none; }
            .nav-buttons-mobile { display: block; }
            .gta-nav { padding: 8px 12px; }
            .gta-title { font-size: 18px; padding: 6px 10px; }

            /* 保持导航栏在一行 */
            .gta-nav { flex-wrap: nowrap; align-items: center; }
            .gta-title { white-space: nowrap; }
            /* 左侧标题固定宽度，不占满剩余空间 */
            .nav-left { flex: 0 0 auto; display: flex; align-items: center; gap: 8px; }
            /* 右侧靠右显示，保持为内联横向布局 */
            .nav-right { flex: 0 0 auto; margin-left: auto; display: flex; align-items: center; }
            .nav-buttons-mobile { display: flex; align-items: center; }
            .menu-toggle { white-space: nowrap; }

            .mobile-menu {
                display: none;
                position: absolute;
                top: 56px;
                right: 12px;
                /* Use same visual style as the title bar for consistency */
                background: linear-gradient(90deg, rgba(10, 25, 41, 0.95) 0%, rgba(25, 118, 210, 0.95) 100%);
                border: 1px solid #42a5f5;
                padding: 10px;
                border-radius: 8px;
                z-index: 1100;
                box-shadow: 0 8px 22px rgba(20,30,50,0.5);
                flex-direction: column;
                gap: 8px;
                min-width: 160px;
                backdrop-filter: blur(6px);
            }

            .mobile-menu.show { display: flex; }

            .mobile-menu .nav-button,
            .mobile-menu .nav-link {
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(255,255,255,0.06);
                color: white;
                padding: 8px 10px;
                border-radius: 8px;
                text-decoration: none;
                border: none;
                cursor: pointer;
            }

            .menu-toggle {
                background: rgba(255,255,255,0.06);
                color: white;
                border: 1px solid rgba(255,255,255,0.08);
                padding: 8px 12px;
                border-radius: 14px;
                cursor: pointer;
                font-size: 14px;
            }
        }

        .item-checkbox + label:before {
            /* 使用 FontAwesome 的方框图标作为占位（回退） */
            content: "\f0c8";
            font-family: "Font Awesome 6 Free";
            margin-right: 4px;
            color: var(--text-secondary);
            transition: var(--transition);
            font-weight: 900;
            font-size: 16px;
            display: inline-block;
            width: 16px;
            text-align: center;
        }

        .item-checkbox:checked + label {
            background: var(--primary-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--gta-primary-glow);
        }

        .item-checkbox:checked + label:before {
            content: "\f14a"; /* FontAwesome checked */
            color: var(--accent-color);
        }

        .item-checkbox + label:hover {
            border-color: var(--primary-color);
            background: rgba(25,118,210,0.12);
        }

        .item-icon {
            width: 16px;
            height: 16px;
            margin-right: 0;
            display: inline-block;
            object-fit: contain;
        }

        /* 搜索框样式（匹配侧边栏风格） */
        .item-search-wrapper input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            display: block;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: var(--transition);
        }
        .item-search-wrapper input[type="text"]:focus {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        /* 分组标题样式 */
        .item-group-title {
            margin: 8px 0 6px 0;
            font-size: 12px;
            color: var(--gta-accent);
            text-transform: uppercase;
            opacity: 0.9;
        }

        /* 可折叠分组头部与内容 */
        .item-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 6px 0;
            font-size: 12px;
            color: var(--gta-accent);
            text-transform: uppercase;
            opacity: 0.95;
            cursor: pointer;
            user-select: none;
        }
        .item-group-header .chevron {
            color: var(--gta-text-secondary);
            transition: transform 0.15s ease;
        }
        .item-group-content.collapsed { display: none; }

        /* GTA风格导航栏 - 佩里科岛风格蓝色主题 */
        .gta-nav {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(10, 25, 41, 0.7) 0%, rgba(25, 118, 210, 0.7) 100%);
            border-bottom: 2px solid #42a5f5;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .gta-nav .nav-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-grow: 1;
        }

        .gta-title {
            font-family: 'Impact', sans-serif;
            color: white;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin: 0;
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .gta-title i {
            margin-right: 8px;
            color: var(--gta-primary);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        .nav-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:hover {
            background: var(--gta-primary);
            color: var(--gta-bg-dark);
            box-shadow: 0 0 15px var(--gta-primary-glow);
            transform: translateY(-1px);
        }

        .nav-button.back-button {
            background: var(--gta-secondary);
            border-color: var(--gta-secondary);
        }

        /* 侧边栏（佩里科岛样式） */
        .side-panel {
            position: absolute;
            top: 80px;
            left: 10px;
            width: 320px;
            max-height: calc(100% - 120px);
            background: linear-gradient(180deg, rgba(10,20,30,0.85), rgba(15,25,35,0.9));
            border: 1px solid var(--gta-border);
            border-radius: 10px;
            color: var(--gta-text);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
        }

        .side-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .side-panel-title {
            font-weight: bold;
            color: var(--gta-text);
            font-size: 14px;
            text-transform: uppercase;
        }

        .side-panel-content {
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            scrollbar-width: thin;
        }

        /* 蓝色自定义滚动条（webkit） */
        .side-panel-content::-webkit-scrollbar {
            width: 8px;
            background: rgba(25, 118, 210, 0.08);
        }
        .side-panel-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #42a5f5 0%, #1976d2 100%);
            border-radius: 6px;
        }
        .side-panel-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1976d2 0%, #42a5f5 100%);
        }
        /* Firefox */
        .side-panel-content {
            scrollbar-color: #42a5f5 rgba(25, 118, 210, 0.08);
            scrollbar-width: thin;
        }

        .side-panel-section { margin-bottom: 14px; }
        .side-panel-section-title { font-size: 13px; color: var(--gta-accent); margin-bottom: 8px; }

        /* item selector */
        .item-selector-container { display:flex; flex-direction:column; gap:6px; }
        .item-checkbox + label { display:flex; align-items:center; gap:8px; padding:8px; background: rgba(255,255,255,0.02); border-radius:6px; cursor:pointer; }

        /* 隐藏默认 leaflet 缩放控件 */
        .leaflet-control-zoom { display: none; }

        /* 底部缩放控制 */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 7px; /* 放大 1/3（5px -> 7px） */
            background: rgba(10,20,30,0.85);
            padding: 5px; /* 4px -> 5px */
            border-radius: 13px; /* 10px -> 13px */
            border: 1px solid var(--gta-border);
            box-shadow: 0 6px 14px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* 折叠状态样式：当面板添加 .collapsed 时收起内容并缩窄宽度 */
        .side-panel.collapsed {
            width: 56px;
            overflow: hidden;
            transition: width 0.25s ease;
        }

        .side-panel.collapsed .side-panel-content {
            display: none;
        }

        .side-panel.collapsed .side-panel-title {
            display: none;
        }

        .side-panel.collapsed .side-panel-header {
            justify-content: center;
        }

        .zoom-button {
            width: 30px; /* 22px * 4/3 ≈ 29.3 -> 30px */
            height: 30px; /* 30px */
            background: linear-gradient(160deg, #145a9e 60%, #1976d2 100%);
            color: #fff;
            border: 1.5px solid #1565c0; /* 略增边框以适配尺寸 */
            border-radius: 50%;
            font-size: 0.9rem; /* 从0.65rem放大1/3 -> ~0.87rem，取0.9rem */
            box-shadow: 0 0 0 1.3px rgba(25, 118, 210, 0.13), 0 3px 10px rgba(20, 90, 158, 0.22);
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            user-select: none;
        }
        .zoom-button:active {
            background: linear-gradient(160deg, #0d305a 60%, #145a9e 100%);
            box-shadow: 0 0 0 1.3px #145a9e, 0 1px 5px rgba(20,90,158,0.18);
            transform: scale(0.98);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(160deg, #1976d2 0%, #145a9e 100%);
            box-shadow: 0 0 0 2px #1976d2, 0 5px 16px rgba(20,90,158,0.32);
            transform: scale(1.05);
        }
        .zoom-button i {
            font-size: 16px; /* 适配 30px 按钮 */
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }

        /* 右上角地图控制菜单按钮美化 */
        .side-panel-toggle {
            width: 40px;
            height: 40px;
            background: transparent !important;
            color: #fff;
            border: none !important;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: none !important;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            padding: 0;
            user-select: none;
        }
        .side-panel-toggle:active {
            background: rgba(25, 118, 210, 0.10);
            box-shadow: none;
            transform: scale(0.96);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: rgba(25, 118, 210, 0.13);
            box-shadow: 0 0 0 2px #1976d233, 0 2px 8px #1976d211;
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            font-size: 1.2em;
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }
        /* 右上角地图控制菜单按钮美化 */
        .side-panel-toggle {
            width: 38px;
            height: 38px;
            background: linear-gradient(145deg, var(--gta-accent) 0%, var(--gta-primary) 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18), 0 1px 0 #fff inset;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        .side-panel-toggle:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 1px 4px rgba(25, 118, 210, 0.12);
            transform: scale(0.97);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.22);
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            pointer-events: none;
        }
        .zoom-button:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18);
            transform: scale(0.97);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 6px 24px rgba(25, 118, 210, 0.32);
            transform: scale(1.10);
        }
        .zoom-button i {
            pointer-events: none;
        }

        /* 蓝色滚动条（GTA 风格） */
        .side-panel-content::-webkit-scrollbar { width: 10px; }
        .side-panel-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 6px; }
        .side-panel-content::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--gta-primary),var(--gta-accent)); border-radius: 6px; box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }

        .nav-button.back-button:hover {
            background: var(--gta-accent);
            border-color: var(--gta-accent);
        }

        .nav-section select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-section select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        .nav-section select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* 物品类型选择器 */
        /* 地图样式选择器：放在侧边栏内，不使用绝对定位以避免遮挡地图 */
        .map-style-selector {
            position: static;
            margin-bottom: 12px;
            background: transparent;
            border-radius: 6px;
            border: none;
            box-shadow: none;
            padding: 0;
            z-index: auto;
            width: 100%;
        }

        .map-style-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--gta-text);
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-style-selector select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .map-style-selector select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        .map-style-selector select:focus {
            outline: none;
            border-color: var(--gta-accent);
            box-shadow: 0 0 12px rgba(30, 144, 255, 0.4);
        }

        .item-selector-wrapper {
            position: absolute;
            top: 150px;
            right: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            width: 200px;
        }

        .item-selector-label {
            color: var(--gta-text);
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #item-type-select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #item-type-select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        #item-type-select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* 物品信息弹窗 */
        #item-info {
            position: absolute;
            bottom: 120px;
            left: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            max-width: 300px;
            display: none;
        }

        #item-info .close {
            position: absolute;
            top: 5px;
            right: 10px;
            color: var(--gta-text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #item-info .close:hover {
            color: var(--gta-secondary);
        }

        #item-title {
            color: var(--gta-primary);
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #item-coords, #item-location, #item-details {
            color: var(--gta-text);
            font-size: 14px;
            margin: 5px 0;
            line-height: 1.4;
        }

        /* 通用确认弹窗 */
        #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1400;
        }
        #confirm-modal.show { display: flex; }
        #confirm-modal .confirm-modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,20,30,0.6);
            backdrop-filter: blur(2px);
        }
        #confirm-modal .confirm-modal-content {
            position: relative;
            background: var(--gta-bg-medium);
            border: 1px solid var(--gta-border);
            border-radius: 10px;
            padding: 16px;
            width: 380px;
            max-width: calc(100% - 40px);
            color: var(--gta-text);
            box-shadow: 0 8px 22px rgba(0,0,0,0.5);
        }
        #confirm-modal .confirm-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--gta-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #confirm-modal .confirm-modal-message {
            font-size: 14px;
            color: var(--gta-text);
            opacity: 0.95;
            line-height: 1.6;
            margin-bottom: 14px;
        }
        #confirm-modal .confirm-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* 右下角缩放按钮 - 缩小为 50% */
        .zoom-controls {
            position: absolute;
            right: 32px;
            bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px; /* 50% */
            z-index: 1200;
            user-select: none;
        }

        #vertical-links a {
            color: var(--gta-primary);
            text-decoration: none;
            padding: 6px 12px;
            margin: 2px 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        #vertical-links a:hover {
            color: white;
            background: rgba(25, 118, 210, 0.2);
        }

        /* 游戏时间/天气 - 默认作为导航下的内联项，去掉底部蓝色框 */
        #game-time-weather {
            font-size: 14px;
            color: #fff;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 1300;
            pointer-events: none;
            letter-spacing: 0.6px;
            min-width: 0;
            text-align: left;
            user-select: none;
            display: inline-block;
            opacity: 0.95;
        }

        /* 保持静止，无动画 */

        /* 响应式设计 */
        @media (max-width: 768px) {
            .gta-nav {
                padding: 8px 15px;
                /* 在移动端也保持一行：标题左，更多按钮右 */
                flex-direction: row;
                justify-content: space-between;
                gap: 8px;
                align-items: center;
            }

            .gta-title {
                font-size: 18px;
            }

            .nav-button {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* 移动端只显示：标题、时间/天气、更多（隐藏其它左侧/右侧项） */
            .gta-nav .nav-left > *:not(.gta-title):not(#game-time-weather) {
                display: none !important;
            }

            .gta-nav .nav-right > *:not(.nav-buttons-mobile) {
                display: none !important;
            }

            .nav-buttons-desktop { display: none !important; }
            .nav-buttons-mobile { display: flex !important; }

            .map-style-selector {
                top: 120px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            .item-selector-wrapper {
                top: 190px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            #item-info {
                bottom: 100px;
                left: 10px;
                max-width: 250px;
                padding: 10px;
            }

            /* Keep game time/weather inline on mobile so JS can place it next to the title.
               Previously it was forced to bottom-right with !important which conflicted
               with the runtime placement logic. */
            #game-time-weather {
                display: inline-flex !important;
                align-items: center !important;
                color: white !important;
                font-size: 14px !important;
                margin-left: 8px !important;
                background: transparent !important;
                padding: 0 6px !important;
                pointer-events: none !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>

    <!-- 地图容器 -->
    <div id="map-container">
        <!-- 左侧控制面板（佩里科岛样式） -->
        <div class="side-panel" id="side-panel">
            <div class="side-panel-header">
                <div class="side-panel-title">地图控制</div>
                <button class="side-panel-toggle" id="panel-toggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="side-panel-content">
                <div class="side-panel-section">
                    <div class="side-panel-section-title">地图样式</div>
                    <div class="map-style-selector">

                        <select id="map-style-select" style="width:100%; margin-top:6px;">
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_game">游戏 (Game)</option>
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_render">渲染 (Render)</option>
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_print">印刷 (Print)</option>
                        </select>
                    </div>
                </div>

                <div class="side-panel-section">
                    <div style="display:flex; gap:8px; margin: 6px 0 10px 0;">
                        <button id="show-all-items" class="nav-button" style="flex:1;">
                            <i class="fas fa-eye"></i> 显示全部
                        </button>
                        <button id="hide-all-items" class="nav-button" style="flex:1;">
                            <i class="fas fa-eye-slash"></i> 隐藏全部
                        </button>
                    </div>
                    <div class="item-search-wrapper" style="margin-bottom: 10px;">
                        <input id="sidebar-item-search" type="text" placeholder="搜索物品..." aria-label="搜索物品" />
                    </div>
                    <div class="item-selector-container" id="sidebar-item-selectors">
                        <!-- 复用现有 item 选择（稍后通过 JS 填充） -->
                    </div>
                </div>

                <div class="side-panel-section">
                    <button id="reset-checkboxes" class="nav-button" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-undo"></i> 重置选择
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GTA风格导航栏 -->
    <div class="gta-nav">
        <div class="nav-left">
            <h1 class="gta-title">🏙️ 洛圣都地图</h1>
            <div class="nav-links">
                <a href="https://www.antwen.com" target="_blank">安稳</a>
                <a href="https://share.antwen.com" target="_blank">在线文件</a>
            </div>
        </div>
        <div class="nav-right">
            <!-- PC端显示 -->
            <div class="nav-buttons-desktop">
                <a href="../" class="nav-button">🏠 首页</a>
                <a href="gta-map/cp" class="nav-button">🏝️ 佩里科岛</a>
                <a href="../vehicles" class="nav-button">🚗 车辆数据库</a>
            </div>
            <!-- 移动端显示 -->
            <div class="nav-buttons-mobile">
                <button class="menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i> 更多
                </button>
                <div class="mobile-menu" id="mobile-menu">
                    <a href="../" class="nav-button">🏠 首页</a>
                    <a href="gta-map/cp" class="nav-button">🏝️ 佩里科岛</a>
                    <a href="../vehicles" class="nav-button">🚗 车辆数据库</a>
                    <a href="https://www.antwen.com" target="_blank" class="nav-link">🔗 安稳</a>
                    <a href="https://share.antwen.com" target="_blank" class="nav-link">☁️ 在线文件</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图样式选择器 已移入侧边栏 -->

    <!-- 物品类型复选项已移入侧边栏 -->

    <!-- 物品信息弹窗 -->
    <div id="item-info">
        <span class="close" onclick="hideItemInfoText()">×</span>
        <h3 id="item-title">物品信息</h3>
        <p id="item-coords">坐标: </p>
        <p id="item-location">位置: </p>
        <p id="item-details">详细信息: </p>
    </div>

    <!-- 通用确认弹窗（网页内样式） -->
    <div id="confirm-modal" aria-hidden="true">
        <div class="confirm-modal-overlay"></div>
        <div class="confirm-modal-content" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
            <div class="confirm-modal-title" id="confirm-title">
                <i class="fas fa-triangle-exclamation"></i>
                性能提示
            </div>
            <div class="confirm-modal-message" id="confirm-message">物品信息较多，显示全部可能造成卡顿，是否继续显示？</div>
            <div class="confirm-modal-actions">
                <button class="nav-button" id="confirm-cancel">取消</button>
                <button class="nav-button" id="confirm-ok">继续显示</button>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loader" id="loader">地图加载中...</div>

        <!-- 底部缩放控制 -->
        <div class="zoom-controls">
            <button class="zoom-button" id="zoom-in">
                <i class="fas fa-plus"></i>
            </button>
            <button class="zoom-button" id="zoom-out">
                <i class="fas fa-minus"></i>
            </button>
        </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // --- 配置/常量 ---
        const TILE_SIZE = 256;
        const GAME_LEFT = -4140;
        const GAME_RIGHT = 4860;
        const GAME_BOTTOM = -5100;
        const GAME_TOP = 8400;

        const zoomLevels = [
            { zoom: 3, cols: 4, rows: 6 },   // 最小缩放级别
            { zoom: 4, cols: 8, rows: 12 },
            { zoom: 5, cols: 16, rows: 24 },
            { zoom: 6, cols: 32, rows: 48 } ,
            { zoom: 7, cols: 64, rows: 96 }  // 最大缩放级别
        ];

        // 试点标记类型（使用Leaflet原生标记）
        const pilotMarkerTypes = new Set([
            // 第0组：试点组
            'hidden_caches',
            'dead_drop', 
            'stunt_jumps',
            'spray',
            
            // 第1组：基础收集品
            'shipwrecked',
            'gun_van',
            'ls_tags',
            'street_dealers',
            
            // 第2组：娱乐活动
            'playing_cards',
            'smoke_on_the_water_product',
            'action_figures',
            'yuanbao',
            'letter_scraps',
            'sp_hidden_packages',
            'peyote_sp_land',
            'peyote_sp_air',
            'peyote_sp_water',
            'peyote_sp_special',
            'submarine_pieces',
            'spaceship_parts',
            'nuclear_waste',
            'humans_of_ls',
            'monkey_mosaics',
            'murder_mystery_message',
            'assuming_the_truth',
            'epsilon_tracts',
            'for_sale_sign',
            'the_big_score_gauntlet',
            'hitchhikers',
            'chasing_the_truth',
            
            // 第3组：设施服务
            'ld_organics_products',
            'signal_jammers',
            'jack_o_lanterns',
            'payphone_hits',
            
            // 第4组：运动挑战
            'golf_holes',
            'snowmen',
            'rc_time_trial',
            'bike_time_trial',
            
            // 第5组：载具相关（部分）
            'skydives',
            'drug_vehicle',
            'smuggler_plane',
            'smuggler_trail',
            'metal_detector',
            
            // 特殊标记：有特殊处理逻辑的标记
            'media_sticks',
            'police_rescue_patrick_mcreary',
            
            // 第6组：任务系统
            'stash_houses',
            'madrazo_hits',
            'random_missions',
            'convoy',
            'convoy_final',
            'armored_truck',
            
            // 第13组：基础设施
            'metro',
            'police',
            'v_telescopes',
            'fire_stations',
            
            // 第14组：商业设施
            'hospitals',
            'clothing',
            'tattoos',
            'barbers',
            
            // 第15组：车行设施
            'casino',
            'car_meet', 
            'premium_deluxe_motorsport',
            'luxury_autos',
            
            // 第16组：服务设施
            'ammunation',
            'mod_shop',
            'car_wash',
            'shops_to_rob',
            'drunk_guard',
            
            // 第17组：便民设施
            'gas_stations',
            'atms',
            
            // 第18组：售卖机
            'vend_sprunk',
            'vend_ecola',
            
            // 第8组：出口贸易（新增）
            'exotic_exports1',
            'exotic_exports2',
            'happy_holidays_hauler',
            'wea',
            
            // 第9组：特殊生物
            'halloween_slashers',
            'gang_attacks',
            'ghosts3',
            'cerberus',
            'possessed_animals',
            'yeti',
            
            // 第10组：悬赏系统
            'maude_bounty_targets',

            // 新增迁移类型
            'serial_killer_slasher',
            'treasure_hunt_dba_revolver',
            'movie_props',
            'crime_scenes',
            'ufo',
            'community_outreach',
            'store_robbery',
            'ppl',
            'ppw'
        ]);

        // Leaflet标记存储
        let leafletMarkers = [];

        // 游戏坐标转像素坐标函数（参考CP地图实现）
        function gameToPixel(gx, gy, z) {
            const level = getLevelByZoom(z);
            if (!level) return { x: 0, y: 0 };
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            const gameWidth = GAME_RIGHT - GAME_LEFT;
            const gameHeight = GAME_TOP - GAME_BOTTOM;
            const percentX = (gx - GAME_LEFT) / gameWidth;
            const percentY = (GAME_TOP - gy) / gameHeight;
            
            return { 
                x: percentX * totalWidth, 
                y: percentY * totalHeight 
            };
        }

        // 应用 assuming_the_truth 可见性缓存
        function applyAssumingTheTruthVisibilityCache() {
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('assuming_the_truth') || {};
                markers.forEach((marker, index) => {
                    const hidden = !!visibilityMap[index];
                    if (!marker) return;
                    if (marker.setOpacity) {
                        marker.setOpacity(hidden ? 0.3 : 1);
                    } else if (marker.getElement) {
                        const el = marker.getElement();
                        if (el) el.style.opacity = hidden ? '0.3' : '1';
                    }
                });
            }
        }

        // 物品图标路径映射
        const itemIcons = {
            hidden_caches: '../src/assets/cache.png',
            shipwrecked: '../src/assets/shipwrecked.png',
            gun_van: '../src/assets/van.png',
            dead_drop: '../src/assets/dead_drop.svg',
            stunt_jumps: '../src/assets/stunt_jumps.svg',
            spray: '../src/assets/spray.svg',
            ls_tags: '../src/assets/ls_tags.svg',
            street_dealers: '../src/assets/dealer.png',
            playing_cards: '../src/assets/playing_cards.svg',
            smoke_on_the_water_product: '../src/assets/smoke_product.svg',
            action_figures: '../src/assets/action_figures.svg',
            yuanbao: '../src/assets/yuanbao.svg',
            ld_organics_products: '../src/assets/organic_farm.svg',
            signal_jammers: '../src/assets/signal_jammer.svg',
            jack_o_lanterns: '../src/assets/jack.svg',
            payphone_hits: '../src/assets/payphone.svg',
            golf_holes: '../src/assets/golf.svg',
            snowmen: '../src/assets/snowmen.svg',
            letter_scraps: '../src/assets/letter.svg',
            sp_hidden_packages: '../src/assets/sp_hidden_packages.svg',
            peyote_sp_land: '../src/assets/peyote_sp_land.svg',
            peyote_sp_air: '../src/assets/peyote_sp_air.svg',
            peyote_sp_water: '../src/assets/peyote_sp_water.svg',
            peyote_sp_special: '../src/assets/peyote_sp_special.svg',
            submarine_pieces: '../src/assets/submarine_pieces.svg',
            spaceship_parts: '../src/assets/spaceship_parts.svg',
            nuclear_waste: '../src/assets/nuclear_waste.svg',
            humans_of_ls: '../src/assets/humans_of_ls.svg',
            monkey_mosaics: '../src/assets/monkey_mosaics.svg',
            murder_mystery_message: '../src/assets/murder_mystery_message.svg',
            assuming_the_truth: '../src/assets/assuming_the_truth_car.svg',
            chasing_the_truth: '../src/assets/chasing_the_truth.svg',
            epsilon_tracts: '../src/assets/epsilon_tracts.svg',
            the_big_score_gauntlet: '../src/assets/the_big_score_gauntlet.svg',
            for_sale_sign: '../src/assets/for_sale_sign.svg',
            hitchhikers: '../src/assets/hitchhikers.svg',
            rc_time_trial: '../src/assets/rctt.png',
            bike_time_trial: '../src/assets/btt.png',
            skydives: '../src/assets/skydive.png',
            gang_attacks: '../src/assets/gang_attack.svg',
            ghosts3: '../src/assets/ge251.svg',
            treasure_hunt_dba_revolver: '../src/assets/th1.svg',
            // 洛圣都杀人狂（first 用 slasher.svg，last 用 slasher2.svg；Leaflet入口按类型分支）
            serial_killer_slasher: '../src/assets/slasher.svg',
            // 茉德悬赏目标图标
            maude_bounty_targets: '../src/assets/mp_static.svg', // 临时使用，后续需要创建专用图标
            // 媒体记忆棒图标
            media_sticks: '../src/assets/media.svg',
            // 藏匿屋图标
            stash_houses: '../src/assets/stash.svg',
            // 玛德拉索雇凶图标
            madrazo_hits: '../src/assets/hits.svg',
            // 帕特里克救援图标
            police_rescue_patrick_mcreary: '../src/assets/patrick.svg',
            // 随机任务图标
            random_missions: '../src/assets/random.svg',
            // 毒品载具图标
            drug_vehicle: '../src/assets/drug_vehicle.svg',
            // 电影道具图标
            movie_props: '../src/assets/mp_static.svg',
            // 车行图标
            casino: '../src/assets/casino.svg',
            car_meet: '../src/assets/lscm.svg',
            premium_deluxe_motorsport: '../src/assets/sem.svg',
            luxury_autos: '../src/assets/lux.svg',
            // 沉睡的保安
            drunk_guard: '../src/assets/drunk_guard.svg',
            // 金属探测器
            metal_detector: '../src/assets/metal.svg',
            // 走私贩飞机
            smuggler_plane: '../src/assets/smuggler_plane.svg',
            // 走私贩踪迹
            smuggler_trail: '../src/assets/smuggler_trail.svg',
            // 犯罪现场
            crime_scenes: '../src/assets/crime_scenes.svg',
            // UFO观光
            ufo: '../src/assets/ufo.svg',
            // 万圣节杀人狂
            halloween_slashers: '../src/assets/slasher.svg',
            // 鬼上身的动物
            possessed_animals: '../src/assets/blank.svg',
            // 地狱犬
            cerberus: '../src/assets/cerberus.svg',
            // 雪怪
            yeti: '../src/assets/what.svg',
            // 社区边界
            community_outreach: '../src/assets/community_outreach.svg',
            // 商店抢劫
            store_robbery: '../src/assets/store_robbery.svg',
            // 车队
            convoy: '../src/assets/convoy.svg',
            // 车队终点
            convoy_final: '../src/assets/convoy_final.svg',
            // 装甲运钞车
            armored_truck: '../src/assets/armored_truck.svg',
            // 外贸出口载具1
            exotic_exports1: '../src/assets/exotic_exports1.svg',
            // 外贸出口载具2
            exotic_exports2: '../src/assets/exotic_exports2.svg',
            // 节日快乐卡车
            happy_holidays_hauler: '../src/assets/happy.svg',
            // 威泽尔大楼枪战
            wea: '../src/assets/wea.svg',
            // 陆地迷幻仙人掌
            ppl: '../src/assets/ppl.svg',
            // 水下迷幻仙人掌
            ppw: '../src/assets/ppw.svg',
            // 地铁站
            metro: '../src/assets/metro.svg',
            // 警察局
            police: '../src/assets/police.svg',
            // 望远镜
            v_telescopes: '../src/assets/telescopes.svg',
            // 消防局
            fire_stations: '../src/assets/fire.svg',
            // 医院
            hospitals: '../src/assets/hospitals.svg',
            // 服装店
            clothing: '../src/assets/clothing.svg',
            // 纹身店
            tattoos: '../src/assets/tattoos.svg',
            // 理发店
            barbers: '../src/assets/barbers.svg',
            // 武装国度
            ammunation: '../src/assets/ammunation.svg',
            // 洛圣都改车王
            mod_shop: '../src/assets/mod_shop.svg',
            // 洗车店
            car_wash: '../src/assets/car_wash.svg',
            // 可抢劫的商店
            shops_to_rob: '../src/assets/shops_to_rob.svg',
            // 加油站
            gas_stations: '../src/assets/gas_stations.svg',
            // ATM机
            atms: '../src/assets/atms.svg',
            // 霜碧售卖机
            vend_sprunk: '../src/assets/vend_sprunk.svg',
            // 易可乐售卖机
            vend_ecola: '../src/assets/vend_ecola.svg'
        };

        // 物品数据（从JSON文件加载）
        const itemData = {
            hidden_caches: [],
            shipwrecked: [],
            gun_van: [],
            dead_drop: [],
            ls_tags: [],
            street_dealers: [],
            playing_cards: [],
            smoke_on_the_water_product: [],
            action_figures: [],
            yuanbao: [],
            letter_scraps: [],
            sp_hidden_packages: [],
            peyote_sp_land: [],
            peyote_sp_air: [],
            peyote_sp_water: [],
            peyote_sp_special: [],
            submarine_pieces: [],
            spaceship_parts: [],
            nuclear_waste: [],
            humans_of_ls: [],
            monkey_mosaics: [],
            murder_mystery_message: [],
            assuming_the_truth: [],
            chasing_the_truth: [],
            epsilon_tracts: [],
            the_big_score_gauntlet: [],
            for_sale_sign: [],
            hitchhikers: [],
            ld_organics_products: [],
            signal_jammers: [],
            jack_o_lanterns: [],
            payphone_hits: [],
            golf_holes: [],
            snowmen: [],
            stunt_jumps: [],
            spray: [],
            rc_time_trial: [],
            bike_time_trial: [],
            skydives: [],
            gang_attacks: [],
            ghosts3: [],
            treasure_hunt_dba_revolver: { random_clue: [], static_clues: [] },
            movie_props: { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } },
            serial_killer_slasher: { first: [], last: [] },
            maude_bounty_targets: { areas: [], endpoints: [] },
            media_sticks: [],
            stash_houses: [],
            madrazo_hits: [],
            police_rescue_patrick_mcreary: { spawn: [], dropoff: [] },
            random_missions: {
                // 测试数据 - 一些示例随机任务位置
                "morning": [
                    [100, 200],
                    [300, 400]
                ],
                "afternoon": [
                    [500, 600],
                    [700, 800]
                ]
            },
            drug_vehicle: [],
            drunk_guard: [],
            metal_detector: [],
            smuggler_plane: [],
            smuggler_trail: [],
            crime_scenes: [],
            ufo: [],
            halloween_slashers: [],
            possessed_animals: [],
            cerberus: [],
            yeti: [],
            happy_holidays_hauler: [],
            // 威泽尔大楼枪战
            wea: [],
            // 陆地迷幻仙人掌
            ppl: [],
            // 水下迷幻仙人掌
            ppw: [],
            // 地铁站
            metro: [],
            // 警察局
            police: [],
            // 望远镜
            v_telescopes: [],
            // 消防局
            fire_stations: [],
            // 医院
            hospitals: [],
            // 服装店
            clothing: {},
            // 纹身店
            tattoos: [],
            // 理发店
            barbers: [],
            // 武装国度
            ammunation: {},
            // 洛圣都改车王
            mod_shop: {},
            // 洗车店
            car_wash: [],
            // 可抢劫的商店
            shops_to_rob: [],
            // 加油站
            gas_stations: [],
            // ATM机
            atms: [],
            // 霜碧售卖机
            vend_sprunk: [],
            // 易可乐售卖机
            vend_ecola: [],
            community_outreach: [],
            store_robbery: [],
            convoy: [],
            convoy_final: [],
            armored_truck: [],
            exotic_exports1: [],
            exotic_exports2: []
        };

        // 车行位置数据
        const dealershipData = {
            casino: {
                coordinates: [[939.1505, 26.4848]],
                name: '赌场',
                icon: 'casino'
            },
            car_meet: {
                coordinates: [[781.25, -1868.553]],
                name: '车友会',
                icon: 'car_meet'
            },
            premium_deluxe_motorsport: {
                coordinates: [[-42.6786, -1097.2642]],
                name: '西米恩',
                icon: 'premium_deluxe_motorsport'
            },
            luxury_autos: {
                coordinates: [[-788.722, -239.5369]],
                name: '豪华',
                icon: 'luxury_autos'
            }
        };

        // 车行标记数组
        let dealershipMarkers = [];

        // 武器厢型车位置缓存（每天变化）
        let gunVanLocation = null;
        let gunVanLastUpdate = 0;
        
        // LS涂鸦位置缓存（每天变化）
        let lsTagsLastUpdate = 0;
        
        // 隐藏包裹位置缓存（每天变化）
        let hiddenCachesLastUpdate = 0;
        
        // 沉船位置缓存（每天变化）
        let shipwreckedLastUpdate = 0;

        // ==================== 缓存管理系统 ====================
        // 缓存键名常量
        const CACHE_KEYS = {
            SIDEBAR_STATE: 'gta_map_sidebar_state',
            ITEM_VISIBILITY: 'gta_map_item_visibility',
            COUNTERS: 'gta_map_counters',
            USER_PREFERENCES: 'gta_map_preferences'
        };

        // 缓存管理器
        const CacheManager = {
            // 保存数据到localStorage
            save(key, data) {
                try {
                    const serialized = JSON.stringify({
                        data: data,
                        timestamp: Date.now(),
                        version: '1.0'
                    });
                    localStorage.setItem(key, serialized);
                    console.log(`缓存已保存: ${key}`, data);
                } catch (error) {
                    console.warn(`保存缓存失败: ${key}`, error);
                }
            },

            // 从localStorage加载数据
            load(key, defaultValue = null) {
                try {
                    const stored = localStorage.getItem(key);
                    if (!stored) return defaultValue;
                    
                    const parsed = JSON.parse(stored);
                    // 检查版本兼容性（可选）
                    if (parsed.version && parsed.version !== '1.0') {
                        console.warn(`缓存版本不匹配: ${key}, 期望 1.0, 实际 ${parsed.version}`);
                    }
                    
                    console.log(`缓存已加载: ${key}`, parsed.data);
                    return parsed.data;
                } catch (error) {
                    console.warn(`加载缓存失败: ${key}`, error);
                    return defaultValue;
                }
            },

            // 删除缓存
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    console.log(`缓存已删除: ${key}`);
                } catch (error) {
                    console.warn(`删除缓存失败: ${key}`, error);
                }
            },

            // 清空所有GTA地图相关缓存
            clearAll() {
                Object.values(CACHE_KEYS).forEach(key => {
                    this.remove(key);
                });
                console.log('所有GTA地图缓存已清空');
            },

            // 获取缓存信息（用于调试）
            getCacheInfo() {
                const info = {};
                Object.entries(CACHE_KEYS).forEach(([name, key]) => {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            info[name] = {
                                size: stored.length,
                                timestamp: parsed.timestamp,
                                version: parsed.version
                            };
                        } catch (e) {
                            info[name] = { error: '解析失败' };
                        }
                    } else {
                        info[name] = null;
                    }
                });
                return info;
            }
        };

        // 侧边栏状态缓存
        const SidebarCache = {
            // 保存侧边栏选择状态
            saveState(activeTypes) {
                const state = Array.from(activeTypes);
                console.log('保存侧边栏状态:', state);
                const result = CacheManager.save(CACHE_KEYS.SIDEBAR_STATE, state);
                console.log('保存结果:', result);
                return result;
            },

            // 加载侧边栏选择状态
            loadState() {
                return CacheManager.load(CACHE_KEYS.SIDEBAR_STATE, []);
            },

            // 应用缓存的侧边栏状态
            applyState(activeTypes) {
                const cachedState = this.loadState();
                console.log('尝试恢复侧边栏状态，缓存数据:', cachedState);
                if (cachedState.length > 0) {
                    console.log('恢复侧边栏状态:', cachedState);
                    // 清空当前状态
                    activeTypes.clear();
                    // 恢复缓存状态
                    cachedState.forEach(type => {
                        if (typeof type === 'string') {
                            activeTypes.add(type);
                        }
                    });
                    console.log('恢复后的activeItemTypes:', Array.from(activeTypes));
                    return true;
                }
                console.log('无缓存状态可恢复');
                return false;
            }
        };

        // 物品可见性缓存
        const VisibilityCache = {
            // 保存物品可见性状态
            saveVisibility(itemType, visibilityMap) {
                const allVisibility = CacheManager.load(CACHE_KEYS.ITEM_VISIBILITY, {});
                allVisibility[itemType] = visibilityMap;
                CacheManager.save(CACHE_KEYS.ITEM_VISIBILITY, allVisibility);
            },

            // 加载物品可见性状态
            loadVisibility(itemType) {
                const allVisibility = CacheManager.load(CACHE_KEYS.ITEM_VISIBILITY, {});
                return allVisibility[itemType] || {};
            },

            // 应用可见性状态到标记
            applyVisibility(itemType, markers) {
                const visibilityMap = this.loadVisibility(itemType);
                if (Object.keys(visibilityMap).length > 0) {
                    console.log(`恢复 ${itemType} 可见性状态:`, visibilityMap);
                    markers.forEach((marker, index) => {
                        const isHidden = visibilityMap[index];
                        if (isHidden && marker.setOpacity) {
                            marker.setOpacity(0.3);
                        }
                    });
                    return true;
                }
                return false;
            },

            // 更新单个物品的可见性状态
            updateItemVisibility(itemType, index, isHidden) {
                const visibilityMap = this.loadVisibility(itemType);
                visibilityMap[index] = isHidden;
                this.saveVisibility(itemType, visibilityMap);
            }
        };

        // 计数器缓存
        const CounterCache = {
            // 保存计数器状态
            saveCounters(counters) {
                CacheManager.save(CACHE_KEYS.COUNTERS, counters);
            },

            // 加载计数器状态
            loadCounters() {
                return CacheManager.load(CACHE_KEYS.COUNTERS, {});
            },

            // 更新特定物品类型的计数器
            updateCounter(itemType, hiddenCount, totalCount) {
                const counters = this.loadCounters();
                counters[itemType] = { hidden: hiddenCount, total: totalCount };
                this.saveCounters(counters);
            },

            // 获取特定物品类型的计数器
            getCounter(itemType) {
                const counters = this.loadCounters();
                return counters[itemType] || { hidden: 0, total: 0 };
            }
        };

        // ==================== 增强版走私贩飞机模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 smuggler_plane 增加一个计数器占位
        function attachSmugglerPlaneCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.smuggler-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'smuggler-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSmugglerPlaneSidebarCount();
        }

        // ==================== 增强版街头毒贩模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 street_dealers 增加一个计数器占位
        function attachStreetDealersCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.street-dealers-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'street-dealers-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateStreetDealersSidebarCount();
        }

        // ==================== 增强版幽灵曝光2025模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ghosts3 增加一个计数器占位
        function attachGhosts3CounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ghosts3-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ghosts3-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateGhosts3SidebarCount();
        }

        // ==================== 增强版雪人模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 snowmen 增加一个计数器占位
        function attachSnowmenCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.snowmen-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'snowmen-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSnowmenSidebarCount();
        }

        // ==================== 增强版喷罐位置模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 spray 增加一个计数器占位
        function attachSprayCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.spray-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'spray-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSpraySidebarCount();
        }

        // ==================== 增强版特技跳跃点模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 stunt_jumps 增加一个计数器占位
        function attachStuntJumpsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.stunt-jumps-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'stunt-jumps-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateStuntJumpsSidebarCount();
        }

        // ==================== 增强版手办模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 action_figures 增加一个计数器占位
        function attachActionFiguresCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.action-figures-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'action-figures-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateActionFiguresSidebarCount();
        }

        // ==================== 增强版纸牌模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 playing_cards 增加一个计数器占位
        function attachPlayingCardsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.playing-cards-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'playing-cards-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updatePlayingCardsSidebarCount();
        }

        // ==================== 增强版陆地迷幻仙人掌模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ppl 增加一个计数器占位
        function attachPplCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppl-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppl-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updatePplSidebarCount();
        }

        // ==================== 增强版水下迷幻仙人掌模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ppw 增加一个计数器占位
        function attachPpwCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppw-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppw-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updatePpwSidebarCount();
        }

        // ==================== 增强版有机坊产品模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ld_organics_products 增加一个计数器占位
        function attachOrganicFarmCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.organic-farm-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'organic-farm-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateOrganicFarmSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateOrganicFarmSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ld_organics_products + label .organic-farm-counter');
                if (!counterEl) return;

                // 获取有机坊产品标记
                const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时
                    total = Array.isArray(window.itemData?.ld_organics_products) ? window.itemData.ld_organics_products.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('ld_organics_products');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('ld_organics_products', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新有机坊产品计数器失败:', e);
            }
        }

        // ==================== 增强版跳伞模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 skydives 增加一个计数器占位
        function attachSkydivesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.skydives-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'skydives-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSkydivesSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSkydivesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-skydives + label .skydives-counter');
                if (!counterEl) return;

                // 获取跳伞标记
                const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
                let total = 10; // 固定10个跳伞位置
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时，从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('skydives');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('skydives', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新跳伞计数器失败:', e);
            }
        }

        // ==================== 增强版RC时间挑战赛模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 rc_time_trial 增加一个计数器占位
        function attachRCTimeTrialCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.rc-time-trial-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'rc-time-trial-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateRCTimeTrialSidebarCount();
        }

        // ==================== 增强版自行车时间挑战赛模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 bike_time_trial 增加一个计数器占位
        function attachBikeTimeTrialCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.bike-time-trial-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'bike-time-trial-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateBikeTimeTrialSidebarCount();
        }

        // ==================== 增强版玛德拉索雇凶模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 madrazo_hits 增加一个计数器占位
        function attachMadrazoHitsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.madrazo-hits-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'madrazo-hits-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateMadrazoHitsSidebarCount();
        }

        // ==================== 增强版藏匿屋模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 stash_houses 增加一个计数器占位
        function attachStashHousesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.stash-houses-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'stash-houses-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateStashHousesSidebarCount();
        }

        // ==================== 增强版LS涂鸦模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ls_tags 增加一个计数器占位
        function attachLSTagsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ls-tags-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ls-tags-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateLSTagsSidebarCount();
        }

        // ==================== 增强版沉船模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 shipwrecked 增加一个计数器占位
        function attachShipwreckedCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.shipwrecked-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'shipwrecked-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateShipwreckedSidebarCount();
        }

        // ==================== 增强版隐藏包裹模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 hidden_caches 增加一个计数器占位
        function attachHiddenCachesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.hidden-caches-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'hidden-caches-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateHiddenCachesSidebarCount();
        }

        // ==================== 增强版吞云吐雾馆产品模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 smoke_on_the_water_product 增加一个计数器占位
        function attachSmokeProductCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.smoke-product-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'smoke-product-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSmokeProductSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSmugglerPlaneSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smuggler_plane + label .smuggler-counter');
                if (!counterEl) return;

                // groups: window.smugglerGroupMarkers['smuggler_plane'] 结构：每组为数组，含 marker 与 polyline
                const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(groups) && groups.length > 0) {
                    total = groups.length;
                    groups.forEach((groupMarkers, index) => {
                        if (groupMarkers && groupMarkers.length > 0) {
                            const first = groupMarkers[0];
                            if (first && first.getElement) {
                                const el = first.getElement();
                                if (el && el.style.opacity === '0.3') {
                                    hidden++;
                                }
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时
                    total = Array.isArray(window.itemData?.smuggler_plane) ? window.itemData.smuggler_plane.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('smuggler_plane');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('smuggler_plane', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新走私贩飞机计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSpraySidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spray + label .spray-counter');
                if (!counterEl) return;

                // 计数器固定为1，隐藏状态通过全局变量控制
                const totalCount = 1;
                const hiddenCount = window.sprayHidden ? 1 : 0;

                // 更新缓存
                CounterCache.updateCounter('spray', hiddenCount, totalCount);
                counterEl.textContent = totalCount > 0 ? ` (${hiddenCount}/${totalCount})` : '';
            } catch (e) {
                console.warn('更新喷罐位置计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateMoviePropsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-movie_props + label .movie-props-counter');
                if (!counterEl) return;

                const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
                const total = 10; // 固定为10个（7固定 + 3载具按组计数）

                // 读取子类型数量（从数据源）
                const mp = (window.itemData && window.itemData.movie_props) || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                const rumpoCount = mp.vehicles?.rumpo?.length || 0;

                // 可见性来源：优先缓存
                let visibilityMap;
                try { visibilityMap = VisibilityCache.loadVisibility('movie_props') || []; } catch (_) { visibilityMap = []; }

                const getHiddenByIndex = (i) => {
                    if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                    if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                    const m = markers[i];
                    if (!m) return false;
                    if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                    if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                    if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                    return false;
                };

                // 固定点逐一统计
                let hiddenFixed = 0;
                for (let i = 0; i < fixedCount; i++) if (getHiddenByIndex(i)) hiddenFixed++;

                // 组范围
                const ponyStart = fixedCount;
                const ponyEnd = ponyStart + ponyCount;
                const rebelStart = ponyEnd;
                const rebelEnd = rebelStart + rebelCount;
                const rumpoStart = rebelEnd;
                const rumpoEnd = rumpoStart + rumpoCount;

                const rangeAllHidden = (start, end) => {
                    if (start >= end) return false;
                    for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                    return true;
                };

                const ponyHidden = rangeAllHidden(ponyStart, ponyEnd);
                const rebelHidden = rangeAllHidden(rebelStart, rebelEnd);
                const rumpoHidden = rangeAllHidden(rumpoStart, rumpoEnd);

                const hidden = hiddenFixed + (ponyHidden ? 1 : 0) + (rebelHidden ? 1 : 0) + (rumpoHidden ? 1 : 0);

                CounterCache.updateCounter('movie_props', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新电影道具计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateStreetDealersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-street_dealers + label .street-dealers-counter');
                if (!counterEl) {
                    console.log('街头毒贩计数器元素未找到');
                    return;
                }

                // 街头毒贩总数固定为3
                const total = 3;
                let hidden = 0;

                // 获取街头毒贩标记
                const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量计算隐藏数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('street_dealers');
                    hidden = cachedCounter.hidden || 0;
                }

                console.log('街头毒贩计数器更新:', { 
                    total, 
                    hidden, 
                    markers: markers.length, 
                    data: window.itemData?.street_dealers?.length,
                    itemDataExists: !!window.itemData,
                    streetDealersExists: !!window.itemData?.street_dealers,
                    streetDealersType: typeof window.itemData?.street_dealers,
                    streetDealersIsArray: Array.isArray(window.itemData?.street_dealers)
                });

                // 更新缓存
                CounterCache.updateCounter('street_dealers', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('更新街头毒贩计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSlasherSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-serial_killer_slasher + label .slasher-counter');
                if (!counterEl) return;

                const markers = (window.slasherMarkers && window.slasherMarkers) || [];
                const total = 4; // 固定为4个（3个slasher1.svg + 1个slasher2.svg组）

                // 读取子类型数量（从数据源）
                const slasherData = (window.itemData && window.itemData.serial_killer_slasher) || { first: [], last: [] };
                const firstCount = slasherData.first?.length || 0;
                const lastCount = slasherData.last?.length || 0;

                // 可见性来源：优先缓存
                let visibilityMap;
                try { visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher') || []; } catch (_) { visibilityMap = []; }

                const getHiddenByIndex = (i) => {
                    if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                    if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                    const m = markers[i];
                    if (!m) return false;
                    if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                    if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                    if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                    return false;
                };

                // slasher1.svg 逐一统计（前3个）
                let hiddenFirst = 0;
                for (let i = 0; i < firstCount; i++) if (getHiddenByIndex(i)) hiddenFirst++;

                // slasher2.svg 组范围（最后1个组，包含所有last标记）
                const lastStart = firstCount;
                const lastEnd = firstCount + lastCount;

                const rangeAllHidden = (start, end) => {
                    if (start >= end) return false;
                    for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                    return true;
                };

                const lastHidden = rangeAllHidden(lastStart, lastEnd);

                const hidden = hiddenFirst + (lastHidden ? 1 : 0);

                CounterCache.updateCounter('serial_killer_slasher', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新洛圣都杀人狂计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateTreasureHuntSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-treasure_hunt_dba_revolver + label .treasure-hunt-counter');
                if (!counterEl) {
                    console.log('左轮寻宝计数器元素未找到');
                    return;
                }

                // 获取左轮寻宝标记
                const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
                const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
                
                let total = 4; // 总数为4
                let hidden = 0;

                // 检查th1标记（任意一个隐藏则全部隐藏，但计数器只+1）
                let th1Hidden = false;
                th1Markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') {
                            th1Hidden = true;
                        }
                    }
                });
                if (th1Hidden) {
                    hidden += 1; // th1隐藏时计数器只+1
                }

                // 检查th2标记（单独计算）
                th2Markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') {
                            hidden++;
                        }
                    }
                });

                console.log('左轮寻宝计数器更新:', { 
                    total, 
                    hidden, 
                    th1Markers: th1Markers.length, 
                    th2Markers: th2Markers.length,
                    th1Hidden
                });

                // 更新缓存
                CounterCache.updateCounter('treasure_hunt_dba_revolver', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('更新左轮寻宝计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateUfoSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ufo + label .ufo-counter');
                if (!counterEl) {
                    console.log('UFO观光计数器元素未找到');
                    return;
                }

                // 获取UFO观光标记
                const markers = (window.ufoMarkers && window.ufoMarkers) || [];
                const total = Array.isArray(window.itemData?.ufo) ? window.itemData.ufo.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存，避免重新显示后计数被清零
                const cachedCounter = CounterCache.getCounter('ufo');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('ufo', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新UFO观光计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSignalJammersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-signal_jammers + label .signal-jammers-counter');
                if (!counterEl) {
                    console.log('信号干扰器计数器元素未找到');
                    return;
                }

                // 获取信号干扰器标记
                const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量（当天实际显示的数量）
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时，使用实际数据长度
                    total = Array.isArray(window.itemData?.signal_jammers) ? window.itemData.signal_jammers.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('signal_jammers');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('signal_jammers', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新信号干扰器计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateRCTimeTrialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-rc_time_trial + label .rc-time-trial-counter');
                if (!counterEl) {
                    console.log('RC时间挑战赛计数器元素未找到');
                    return;
                }

                // RC时间挑战赛总数固定为1
                const total = 1;
                let hidden = 0;

                // 获取RC时间挑战赛标记
                const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量计算隐藏数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('rc_time_trial');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('rc_time_trial', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('更新RC时间挑战赛计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateBikeTimeTrialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-bike_time_trial + label .bike-time-trial-counter');
                if (!counterEl) {
                    console.log('自行车时间挑战赛计数器元素未找到');
                    return;
                }

                // 自行车时间挑战赛总数固定为1
                const total = 1;
                let hidden = 0;

                // 获取自行车时间挑战赛标记
                const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量计算隐藏数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('bike_time_trial');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('bike_time_trial', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('更新自行车时间挑战赛计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSmokeProductSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smoke_on_the_water_product + label .smoke-product-counter');
                if (!counterEl) return;

                // 获取吞云吐雾馆产品标记
                const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
                let total = 5; // 固定显示5个
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量（最多5个）
                    total = Math.min(markers.length, 5);
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时，使用固定数量5
                    total = 5;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('smoke_on_the_water_product');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('smoke_on_the_water_product', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新吞云吐雾馆产品计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateHiddenCachesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-hidden_caches + label .hidden-caches-counter');
                if (!counterEl) return;

                // 获取隐藏包裹标记
                const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
                let total = 10; // 固定为10个
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时，从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('hidden_caches');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('hidden_caches', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新隐藏包裹计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateShipwreckedSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-shipwrecked + label .shipwrecked-counter');
                if (!counterEl) return;

                // 获取沉船标记
                const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
                let total = 1; // 沉船固定为1个
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // 使用实际渲染的标记数量
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时，从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('shipwrecked');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('shipwrecked', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新沉船计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateLSTagsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ls_tags + label .ls-tags-counter');
                if (!counterEl) return;

                // 获取LS涂鸦标记
                const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
                const total = 5; // 固定5个
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存，避免重新显示后计数被清零
                const cachedCounter = CounterCache.getCounter('ls_tags');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('ls_tags', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新LS涂鸦计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（藏匿屋特殊：固定为1个）
        function updateStashHousesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-stash_houses + label .stash-houses-counter');
                if (!counterEl) return;

                // 藏匿屋特殊：固定为1个，虽然会显示多个图标
                const total = 1;
                let hidden = 0;

                // 检查是否有缓存的隐藏状态
                const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // 更新缓存
                CounterCache.updateCounter('stash_houses', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新藏匿屋计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateActionFiguresSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-action_figures + label .action-figures-counter');
                if (!counterEl) return;

                // 获取手办标记
                const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时
                    total = Array.isArray(window.itemData?.action_figures) ? window.itemData.action_figures.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('action_figures');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('action_figures', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新手办计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updatePlayingCardsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-playing_cards + label .playing-cards-counter');
                if (!counterEl) return;

                // 获取纸牌标记
                const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
                const total = Array.isArray(window.itemData?.playing_cards) ? window.itemData.playing_cards.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存
                const cachedCounter = CounterCache.getCounter('playing_cards');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('playing_cards', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新纸牌计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（南瓜灯，集成缓存）
        function updateJackOLanternsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-jack_o_lanterns + label .jack-counter');
                if (!counterEl) return;

                const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
                const total = Array.isArray(window.itemData?.jack_o_lanterns) ? window.itemData.jack_o_lanterns.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存，避免重新显示后计数被清零
                const cachedCounter = CounterCache.getCounter('jack_o_lanterns');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('jack_o_lanterns', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新南瓜灯计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSpraySidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spray + label .spray-counter');
                if (!counterEl) return;

                // 喷灌位置计数器固定为1，隐藏一个标记后隐藏全部图标
                const totalCount = 1;
                let hiddenCount = 0;

                // 检查是否隐藏（从缓存获取）
                const cachedCounter = CounterCache.getCounter('spray');
                hiddenCount = cachedCounter.hidden || 0;

                // 更新缓存
                CounterCache.updateCounter('spray', hiddenCount, totalCount);
                counterEl.textContent = totalCount > 0 ? ` (${hiddenCount}/${totalCount})` : '';
            } catch (e) {
                console.warn('更新喷灌位置计数器失败:', e);
            }
        }

        // ==================== 增强版陆地迷幻仙人掌模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ppl 增加一个计数器占位
        function attachPplCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppl-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppl-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updatePplSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updatePplSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ppl + label .ppl-counter');
                if (!counterEl) return;

                // 获取陆地迷幻仙人掌标记
                const markers = (window.pplMarkers && window.pplMarkers) || [];
                const total = Array.isArray(window.itemData?.ppl) ? window.itemData.ppl.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存
                const cachedCounter = CounterCache.getCounter('ppl');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('ppl', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新陆地迷幻仙人掌计数器失败:', e);
            }
        }

        // ==================== 增强版水下迷幻仙人掌模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 ppw 增加一个计数器占位
        function attachPpwCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppw-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppw-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updatePpwSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updatePpwSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ppw + label .ppw-counter');
                if (!counterEl) return;

                // 获取水下迷幻仙人掌标记
                const markers = (window.ppwMarkers && window.ppwMarkers) || [];
                const total = Array.isArray(window.itemData?.ppw) ? window.itemData.ppw.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存
                const cachedCounter = CounterCache.getCounter('ppw');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('ppw', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新水下迷幻仙人掌计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateYuanbaoSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-yuanbao + label .yuanbao-counter');
                if (!counterEl) return;

                // 获取元宝标记
                const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
                const total = Array.isArray(window.itemData?.yuanbao) ? window.itemData.yuanbao.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存
                const cachedCounter = CounterCache.getCounter('yuanbao');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('yuanbao', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新元宝计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateStuntJumpsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-stunt_jumps + label .stunt-jumps-counter');
                if (!counterEl) return;

                // 获取特技跳跃点标记
                const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时
                    total = Array.isArray(window.itemData?.stunt_jumps) ? window.itemData.stunt_jumps.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('stunt_jumps');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('stunt_jumps', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新特技跳跃点计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSnowmenSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-snowmen + label .snowmen-counter');
                if (!counterEl) return;

                // 获取雪人标记
                const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
                const total = Array.isArray(window.itemData?.snowmen) ? window.itemData.snowmen.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 合并缓存，避免重新显示后计数被清零
                const cachedCounter = CounterCache.getCounter('snowmen');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('snowmen', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新雪人计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateGhosts3SidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ghosts3 + label .ghosts3-counter');
                if (!counterEl) return;

                // 获取幽灵曝光2025标记
                const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                const opacity = el.style.opacity;
                                if (opacity === '0.3' || opacity === 0.3 || opacity === '0.30') {
                                    hidden++;
                                }
                            }
                        }
                    });
                } else {
                    // 回退：仅有数据尚未渲染 Leaflet 标记时
                    total = Array.isArray(window.itemData?.ghosts3) ? window.itemData.ghosts3.length : 0;
                    // 从缓存中获取隐藏数量
                    const cachedCounter = CounterCache.getCounter('ghosts3');
                    hidden = cachedCounter.hidden || 0;
                }

                // 更新缓存
                CounterCache.updateCounter('ghosts3', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新幽灵曝光2025计数器失败:', e);
            }
        }

        // 弹窗模板（含隐藏/显示联动红线与计数器、图片点击放大、缓存集成）
        function showSmugglerPlanePopup(item, index) {
            const content = `在飞机坠毁处收集装有 25.000 GTA$ 和 2.000 RP 的公文包。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/smuggler_plane/smuggler_plane.webp';

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.smuggler-plane-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const smugglerGroups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
            const totalCount = smugglerGroups.length;

            let hiddenCount = 0;
            smugglerGroups.forEach((groupMarkers) => {
                const first = groupMarkers && groupMarkers[0];
                if (first && first.getElement) {
                    const el = first.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentGroupMarkers = smugglerGroups[index] || [];
            let isCurrentHidden = false;
            if (currentGroupMarkers && currentGroupMarkers.length > 0) {
                const first = currentGroupMarkers[0];
                if (first && first.getElement) {
                    const el = first.getElement();
                    isCurrentHidden = el && el.style.opacity === '0.3';
                }
            }

            const title = `✈️ 走私贩飞机 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'smuggler-plane-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="走私贩飞机图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-smuggler-plane-btn');
            const hideBtn = popup.querySelector('#hide-smuggler-plane-btn');
            const showBtn = popup.querySelector('#show-smuggler-plane-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'smuggler-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前组（包含 marker 与 polyline；兼容旧 DOM 红线）
            function setCurrentGroupVisibility(opacity) {
                if (currentGroupMarkers && currentGroupMarkers.length > 0) {
                    currentGroupMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                // 同步旧版 DOM 红线
                document.querySelectorAll(`.smuggler-connector-line[data-type="smuggler_plane_line"][data-index="${index}"]`).forEach((el) => {
                    el.style.opacity = String(opacity);
                });
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('smuggler_plane', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentGroupVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `✈️ 走私贩飞机 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSmugglerPlaneSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentGroupVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `✈️ 走私贩飞机 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSmugglerPlaneSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 待售标志弹窗（含隐藏/显示与可见性缓存）
        function showForSaleSignPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/for_sale_sign/for_sale_sign_${sequenceNumber}.webp`;

            const existing = document.querySelector('.for-sale-sign-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'for-sale-sign-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px; z-index: 10000; width: min(92vw, 520px); max-height: 80vh;
                color: var(--gta-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto;`;

            const title = `🪧 待售标志 #${sequenceNumber}`;
            const content = `在陌生人和怪胎任务额外佣金（崔佛）中，您需要摧毁这些“待售”标志以推进任务。`;

            // 当前标记句柄
            const markers = (window.forSaleSignMarkers && window.forSaleSignMarkers) || [];
            const currentMarker = markers[index];

            // 是否隐藏（来自缓存）
            const vm = VisibilityCache.loadVisibility('for_sale_sign') || {};
            let isHidden = vm[index] === true;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="for_sale_sign #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-fss-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-fss-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-fss-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">关闭</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-fss-btn');
            const hideBtn = popup.querySelector('#hide-fss-btn');
            const showBtn = popup.querySelector('#show-fss-btn');

            const setOpacity = (opacity) => {
                if (!currentMarker) return;
                if (typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
            };

            if (hideBtn) hideBtn.addEventListener('click', () => {
                setOpacity(0.3);
                VisibilityCache.updateItemVisibility('for_sale_sign', index, true);
                if (hideBtn) hideBtn.style.display = 'none';
                if (showBtn) showBtn.style.display = 'inline-block';
                isHidden = true;
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                setOpacity(1);
                VisibilityCache.updateItemVisibility('for_sale_sign', index, false);
                if (showBtn) showBtn.style.display = 'none';
                if (hideBtn) hideBtn.style.display = 'inline-block';
                isHidden = false;
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            });

            // 关闭弹窗与外部点击关闭
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（覆盖层，不打开新标签）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            document.body.appendChild(popup);
        }

        // 侧边栏计数器：for_sale_sign（基于 VisibilityCache 统计隐藏/总数）
        function updateForSaleSignSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-for_sale_sign + label .for-sale-sign-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.for_sale_sign) ? window.itemData.for_sale_sign.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('for_sale_sign') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('for_sale_sign', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新 for_sale_sign 计数器失败:', e);
            }
        }

        // 应用 for_sale_sign 可见性缓存（设置透明度）
        function applyForSaleSignVisibilityCache() {
            try {
                const markers = (window.forSaleSignMarkers && window.forSaleSignMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const vm = VisibilityCache.loadVisibility('for_sale_sign') || {};
                markers.forEach((marker, i) => {
                    const isHidden = !!vm[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (!marker) return;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                    else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                });
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('应用 for_sale_sign 可见性缓存失败:', e); }
        }

        // 大干一票（巧妙）- 铁腕 弹窗（含隐藏/显示与可见性缓存、计数器）
        function showTheBigScoreGauntletPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/the_big_score_gauntlet/the_big_score_gauntlet_${sequenceNumber}.webp`;

            // 关闭已存在的同类弹窗
            const existing = document.querySelector('.the-big-score-gauntlet-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'the-big-score-gauntlet-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px; z-index: 10000; width: min(92vw, 520px); max-height: 80vh;
                color: var(--gta-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto;`;

            const title = `🚗 大干一票（巧妙）- 铁腕 #${sequenceNumber}`;
            const content = `主线任务“大干一票（巧妙）”的前置任务中所需偷取并改装的铁腕。莱斯特会给每个角色发送有关铁腕位置的电子邮件，但它们的位置不会标记在游戏内地图上。当然，您可以在街上偷取别的铁腕，或者干脆自己买一台；不过这么做不能解锁前置任务的金牌。您需要偷取 3 台铁腕，分别对应 3 个不同的前置任务。`;

            // 当前标记句柄与隐藏状态
            const markers = (window.theBigScoreGauntletMarkers && window.theBigScoreGauntletMarkers) || [];
            const currentMarker = markers[index];
            const vm = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
            let isHidden = vm[index] === true;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="the_big_score_gauntlet #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-tbsg-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-tbsg-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-tbsg-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">关闭</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-tbsg-btn');
            const hideBtn = popup.querySelector('#hide-tbsg-btn');
            const showBtn = popup.querySelector('#show-tbsg-btn');

            const setOpacity = (opacity) => {
                if (!currentMarker) return;
                if (typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
            };

            if (hideBtn) hideBtn.addEventListener('click', () => {
                setOpacity(0.3);
                VisibilityCache.updateItemVisibility('the_big_score_gauntlet', index, true);
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isHidden = true;
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                setOpacity(1);
                VisibilityCache.updateItemVisibility('the_big_score_gauntlet', index, false);
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isHidden = false;
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            });

            // 关闭弹窗与外部点击
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（覆盖层，不打开新标签）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            document.body.appendChild(popup);
        }

        // 侧边栏计数器：the_big_score_gauntlet（基于 VisibilityCache 统计隐藏/总数）
        function updateTheBigScoreGauntletSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-the_big_score_gauntlet + label .the-big-score-gauntlet-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.the_big_score_gauntlet) ? window.itemData.the_big_score_gauntlet.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('the_big_score_gauntlet', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新 the_big_score_gauntlet 计数器失败:', e);
            }
        }

        // 应用 the_big_score_gauntlet 可见性缓存（设置透明度）
        function applyTheBigScoreGauntletVisibilityCache() {
            try {
                const markers = (window.theBigScoreGauntletMarkers && window.theBigScoreGauntletMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const vm = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
                markers.forEach((marker, i) => {
                    const isHidden = !!vm[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (!marker) return;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                    else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                });
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('应用 the_big_score_gauntlet 可见性缓存失败:', e); }
        }

        // 搭便车（潜在的利他邪教受害者）文本弹窗（无图片，含隐藏/显示+计数器）
        function showHitchhikersPopup(item, index) {
            const sequenceNumber = index + 1;
            const baseTitle = `🚶 搭便车 #${sequenceNumber}`;
            const extra = `您可以为需要搭便车的人伸出援手，特别地，崔佛则还可以选择将搭车人送到利他主义邪教营地并赚取 1.000 GTA$。在崔佛带过 4 名搭车人（不是带人 4 次。一次带来 2 人，进度加 2）到利他营地后，邪教徒会试图让他成为下一个受害者。`;

            const notes = Array.isArray(item?.notes) ? item.notes : [];

            // 统计隐藏/总数（基于 VisibilityCache）
            const arr = Array.isArray(window.itemData?.hitchhikers) ? window.itemData.hitchhikers : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('hitchhikers') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) if (visibilityMap[i] === true) hiddenCount++;
            let isCurrentHidden = visibilityMap[index] === true;

            // 关闭已存在的弹窗
            const existing = document.querySelector('.hitchhikers-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'hitchhikers-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 16px; z-index: 10000; width: min(92vw, 540px); max-height: 80vh;
                color: var(--gta-text); overflow-y: auto;`;

            const htmlNotes = notes.map(n => `<li style="margin: 6px 0; line-height: 1.6;">${n}</li>`).join('');
            popup.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <h3 id="hitch-title" style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: 700;">${baseTitle} (${hiddenCount}/${totalCount})</h3>
                </div>
                <div style="padding: 8px 10px; background: rgba(33,150,243,0.08); border: 1px solid var(--gta-border); border-radius: 6px;">
                    ${notes.length ? `<ul style=\"padding-left:18px;margin:8px 0;\">${htmlNotes}</ul>` : '<div style="opacity:0.8;">暂无说明</div>'}
                    <div style="margin-top:8px; line-height:1.7;">${extra}</div>
                </div>
                <div style="margin-top: 14px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-hitch-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-hitch-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-hitch-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">关闭</button>
                </div>
            `;

            // 当前标记与设置函数
            const markers = (window.hitchhikersMarkers && window.hitchhikersMarkers) || [];
            const currentMarker = markers[index];
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (currentMarker && typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (currentMarker && typeof currentMarker.getElement === 'function') { const el = currentMarker.getElement(); if (el) el.style.opacity = String(opacity); }
                VisibilityCache.updateItemVisibility('hitchhikers', index, opacity === 0.3);
            }

            // 绑定元素
            const titleElement = popup.querySelector('#hitch-title');
            const closeBtn = popup.querySelector('#close-hitch-btn');
            const hideBtn = popup.querySelector('#hide-hitch-btn');
            const showBtn = popup.querySelector('#show-hitch-btn');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 20);

            // 隐藏/显示按钮逻辑
            if (hideBtn) hideBtn.addEventListener('click', () => {
                if (!isCurrentHidden) hiddenCount = hiddenCount + 1;
                setCurrentMarkerVisibility(0.3);
                titleElement && (titleElement.textContent = `${baseTitle} (${hiddenCount}/${totalCount})`);
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isCurrentHidden = true;
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                if (isCurrentHidden && hiddenCount > 0) hiddenCount = hiddenCount - 1;
                setCurrentMarkerVisibility(1);
                titleElement && (titleElement.textContent = `${baseTitle} (${hiddenCount}/${totalCount})`);
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isCurrentHidden = false;
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            });

            document.body.appendChild(popup);
        }

        // 侧边栏计数器：hitchhikers（基于 VisibilityCache 统计隐藏/总数）
        function updateHitchhikersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-hitchhikers + label .hitchhikers-counter');
                if (!counterEl) return;
                const total = Array.isArray(window.itemData?.hitchhikers) ? window.itemData.hitchhikers.length : 0;
                const vm = VisibilityCache.loadVisibility('hitchhikers') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (vm[i] === true) hidden++;
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) { console.warn('更新 hitchhikers 计数器失败:', e); }
        }

        // 应用 hitchhikers 可见性缓存（设置透明度+刷新计数器）
        function applyHitchhikersVisibilityCache() {
            try {
                const markers = (window.hitchhikersMarkers && window.hitchhikersMarkers) || [];
                const vm = VisibilityCache.loadVisibility('hitchhikers') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!vm[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                        else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                        else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                    });
                }
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('应用 hitchhikers 可见性缓存失败:', e); }
        }

        // 谋杀之谜信息弹窗（含隐藏/显示联动与计数器、缓存集成）
        function showMurderMysteryMessageImage(index) {
            const item = (itemData.murder_mystery_message && itemData.murder_mystery_message[index]) || null;
            if (!item) return;

            // 图片命名按合并后的连续序号 1..N（而不是 按组-组内序号）
            const sequenceNumber = index + 1;
            const group = item.group || '?';
            const groupIndex = item.groupIndex || sequenceNumber;
            const titleSeq = `${sequenceNumber}`; // 标题主序号使用合并序号
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/murder_mystery_message/murder_mystery_message_${sequenceNumber}.webp`;

            // 关闭已存在的同类弹窗
            const existingPopup = document.querySelector('.murder-mystery-message-popup');
            if (existingPopup) existingPopup.remove();

            // 统计
            const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
            const totalCount = Array.isArray(itemData.murder_mystery_message) ? itemData.murder_mystery_message.length : markers.length;
            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🕵️ 谋杀之谜信息 #${titleSeq}（组 ${group} - ${groupIndex}） (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'murder-mystery-message-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="谋杀之谜信息 ${titleSeq}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    该特性仅限曾经于 PlayStation 3 或 Xbox 360 主机游玩过 GTA V 的玩家可用。受漏洞影响，全体玩家均能享受回归玩家福利——即使您并未在上世代主机上游玩过 GTA V，您也可以享受这些福利。
                </div>
                <div style="margin: 10px 0; padding: 12px; background: rgba(0,0,0,0.35); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.7;">
                    <div style="font-weight: 700; color: var(--gta-primary); margin-bottom: 6px;">🕵️ 谋杀之谜流程说明</div>
                    <div style="margin-bottom: 8px;">谋杀之谜仅能由 <b>麦克</b> 解开。</div>
                    <ol style="padding-left: 18px; margin: 6px 0;">
                        <li>首先，他需要找到四条刻在墙上的信息和沉没的尸体。</li>
                        <li>之后，他需要在所罗门·理查兹的办公室阅读一封信件。要进入办公室，玩家须在完成主线任务<b>法律纠纷</b>后，再于<b>晚上 9:00 至 早上 6:00</b>前往。</li>
                        <li>为解开谜题，他还需要找到另一具尸体。</li>
                    </ol>
                    <div style="margin-top: 8px;"><b>奖励</b>：2 个复古滤镜。与艾萨克的尸体互动，或打他的电话（所有角色都将获得他的电话），即可在游戏中应用复古滤镜。</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-mmm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-mmm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-mmm-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-mmm-btn');
            const hideBtn = popup.querySelector('#hide-mmm-btn');
            const showBtn = popup.querySelector('#show-mmm-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popupClose && popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（覆盖层，不打开新标签）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记 + 缓存
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('murder_mystery_message', index, opacity === 0.3);
            }

            // 隐藏/显示按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🕵️ 谋杀之谜信息 #${titleSeq}（组 ${group} - ${groupIndex}） (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    // 刷新侧边栏计数
                    try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🕵️ 谋杀之谜信息 #${titleSeq}（组 ${group} - ${groupIndex}） (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    // 刷新侧边栏计数
                    try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // 应用谋杀之谜信息可见性缓存
        function applyMurderMysteryMessageVisibilityCache() {
            try {
                const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const visibilityMap = VisibilityCache.loadVisibility('murder_mystery_message') || {};
                markers.forEach((marker, i) => {
                    if (!marker) return;
                    const isHidden = !!visibilityMap[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                });
                // 应用缓存后尝试刷新计数器
                try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('应用谋杀之谜信息可见性缓存失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateMurderMysteryMessageSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-murder_mystery_message + label .murder-mystery-message-counter');
                if (!counterEl) return;

                // 获取当前标记与总数
                const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                } else {
                    // 图层未显示时：使用数据总量 + 可见性缓存来统计隐藏数量，避免重置为0
                    const dataArr = Array.isArray(window.itemData?.murder_mystery_message) ? window.itemData.murder_mystery_message : [];
                    total = dataArr.length;
                    const visibilityMap = VisibilityCache.loadVisibility('murder_mystery_message') || {};
                    for (let i = 0; i < total; i++) {
                        if (visibilityMap[i] === true) hidden++;
                    }
                    // 如果尚无可见性缓存，则尝试使用上次计数器缓存
                    const cached = CounterCache.getCounter('murder_mystery_message');
                    if (hidden === 0 && cached && typeof cached.hidden === 'number') hidden = cached.hidden;
                    // 若数据数组为空（例如图层被取消选中导致未渲染且有时间过滤），使用缓存中的总数，避免显示为0
                    if ((total === 0 || !Number.isFinite(total)) && cached && typeof cached.total === 'number') total = cached.total;
                }

                // 更新缓存与UI
                CounterCache.updateCounter('murder_mystery_message', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新谋杀之谜信息计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（玛德拉索雇凶特殊：固定为1个）
        function updateMadrazoHitsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-madrazo_hits + label .madrazo-hits-counter');
                if (!counterEl) return;

                // 玛德拉索雇凶特殊：固定为1个，虽然会显示多个图标
                const total = 1;
                let hidden = 0;

                // 检查是否有缓存的隐藏状态
                const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // 更新缓存
                CounterCache.updateCounter('madrazo_hits', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新玛德拉索雇凶计数器失败:', e);
            }
        }

        // 街头毒贩弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showStreetDealersPopup(item, index) {
            // 从API动态获取街头毒贩信息
            fetch('https://api-gta.antwen.com/api/items/street-dealers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStreetDealersPopup(data.data.message, item, index);
                    } else {
                        console.error('获取街头毒贩信息失败:', data.error);
                        alert('获取街头毒贩信息失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    alert('网络请求失败，请检查网络连接');
                });
        }

        function displayStreetDealersPopup(message, item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.street-dealers-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数（使用当天实际显示的数量）
            const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `💊 街头毒贩 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'street-dealers-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${message.replace(/\n/g, '<br>')}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-street-dealers-btn');
            const hideBtn = popup.querySelector('#hide-street-dealers-btn');
            const showBtn = popup.querySelector('#show-street-dealers-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('street_dealers', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `💊 街头毒贩 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateStreetDealersSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `💊 街头毒贩 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateStreetDealersSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // LS涂鸦弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showLSTagsPopup(item, index) {
            // 使用API返回的编号数字
            const sequenceNumber = item.sequenceNumber;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ls_tags/ls_tags_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.ls-tags-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
            const totalCount = 5; // 固定5个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🎨 LS涂鸦 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'ls-tags-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="LS涂鸦 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 87, 34, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！找到并收集所有LS涂鸦，解锁独特奖励！
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-ls-tags-btn');
            const hideBtn = popup.querySelector('#hide-ls-tags-btn');
            const showBtn = popup.querySelector('#show-ls-tags-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ls-tags-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ls_tags', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🎨 LS涂鸦 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateLSTagsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🎨 LS涂鸦 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateLSTagsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 隐藏包裹弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showHiddenCachesPopup(item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.hidden-caches-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
            const totalCount = 10; // 固定为10个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `📦 隐藏包裹 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'hidden-caches-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="https://gtaweb.eu/_sources/maps_gtao/tips/ls_dc_hc.webp" alt="隐藏包裹图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    在指定位置寻找隐藏的包裹，收集后可获得金钱和RP奖励。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-hidden-caches-btn');
            const hideBtn = popup.querySelector('#hide-hidden-caches-btn');
            const showBtn = popup.querySelector('#show-hidden-caches-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'hidden-caches-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('hidden_caches', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `📦 隐藏包裹 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateHiddenCachesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `📦 隐藏包裹 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateHiddenCachesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到隐藏包裹标记
        function applyHiddenCachesVisibilityCache() {
            const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('hidden_caches');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用隐藏包裹可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 猴子马赛克：计数器、弹窗、缓存 ====================
        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateMonkeyMosaicsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-monkey_mosaics + label .monkey-mosaics-counter');
                if (!counterEl) return;

                const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
                const total = Array.isArray(window.itemData?.monkey_mosaics) ? window.itemData.monkey_mosaics.length : 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                }

                // 与缓存合并
                const cachedCounter = CounterCache.getCounter('monkey_mosaics');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存与UI
                CounterCache.updateCounter('monkey_mosaics', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新猴子马赛克计数器失败:', e);
            }
        }

        // 猴子马赛克弹窗（样式与核废料/洛圣都的人类一致），含奖励图片弹出
        function showMonkeyMosaicsImage(index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/monkey_mosaics/monkey_mosaics_${sequenceNumber}.webp`;

            // 关闭已存在的同类弹窗
            const existingPopup = document.querySelector('.monkey-mosaics-popup');
            if (existingPopup) existingPopup.remove();

            // 统计
            const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
            const totalCount = markers.length;
            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🐒 猴子马赛克 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'monkey-mosaics-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            const awardsTip = `游戏中共有 50 个马赛克可以通过操控任意角色进行拍摄。完成收藏品，您将获得 <a href="#" class="award-outfit">崔佛的一套衣服</a>，并解锁与猴子马赛克相关的事件。完成此事件，您还将获得一辆 <a href="#" class="award-vehicle">冲冲猴旅行家</a>。`;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="猴子马赛克 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${awardsTip}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-monkey-mosaics-btn');
            const hideBtn = popup.querySelector('#hide-monkey-mosaics-btn');
            const showBtn = popup.querySelector('#show-monkey-mosaics-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 奖励图片弹出
            const outfitLink = popup.querySelector('.award-outfit');
            const vehicleLink = popup.querySelector('.award-vehicle');
            function showAwardOverlay(url) {
                const overlay = document.createElement('div');
                overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                const img = document.createElement('img');
                img.src = url;
                img.style.cssText = 'max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);';
                overlay.appendChild(img);
                const remove = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                const onKey = (ev) => { if (ev.key === 'Escape') remove(); };
                overlay.addEventListener('click', remove);
                document.addEventListener('keydown', onKey);
                document.body.appendChild(overlay);
            }
            if (outfitLink) {
                outfitLink.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    showAwardOverlay('https://gtaweb.eu/_sources/maps_gtao/tips/monkey_mosaics_awards.webp');
                });
            }
            if (vehicleLink) {
                vehicleLink.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    showAwardOverlay('https://gtaweb.eu/_sources/maps_gtao/tips/monkey_mosaics_random_event_award.webp');
                });
            }

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'monkey-mosaics-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记 + 缓存
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('monkey_mosaics', index, opacity === 0.3);
            }

            // 隐藏/显示按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🐒 猴子马赛克 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    updateMonkeyMosaicsSidebarCount();
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🐒 猴子马赛克 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    updateMonkeyMosaicsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到 monkey_mosaics 标记
        function applyMonkeyMosaicsVisibilityCache() {
            const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('monkey_mosaics');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用猴子马赛克可见性缓存');
                return true;
            }
            return false;
        }

        // 沉船弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showShipwreckedPopup(item, index) {
            // 从API消息中提取沉船编号
            let sequenceNumber = index + 1; // 默认使用index+1
            
            // 如果有API消息，尝试从中提取正确的编号
            if (itemData.shipwreckedMessage) {
                const match = itemData.shipwreckedMessage.match(/#(\d+)/);
                if (match && match[1]) {
                    sequenceNumber = parseInt(match[1]);
                    console.log('从API消息中提取的沉船编号:', sequenceNumber);
                }
            }
            
            console.log('沉船sequenceNumber:', sequenceNumber);
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/shipwrecks/shipwrecks_${sequenceNumber}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.shipwrecked-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
            const totalCount = 1; // 沉船固定为1个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `⚓ 沉船 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'shipwrecked-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="沉船 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(121, 85, 72, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #5D4037; margin-bottom: 5px;">🎯 收集奖励</div>
                    收集所有沉船可获得：边境套装
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-shipwrecked-btn');
            const hideBtn = popup.querySelector('#hide-shipwrecked-btn');
            const showBtn = popup.querySelector('#show-shipwrecked-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'shipwrecked-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('shipwrecked', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `⚓ 沉船 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateShipwreckedSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `⚓ 沉船 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateShipwreckedSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到沉船标记
        function applyShipwreckedVisibilityCache() {
            const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('shipwrecked');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用沉船可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到藏匿屋标记
        function applyStashHousesVisibilityCache() {
            const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
            const isHidden = visibilityMap[0] === true;
            
            if (isHidden) {
                // 隐藏所有藏匿屋相关的标记
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('stash')) {
                        marker.style.opacity = '0.3';
                    }
                });

                // 同时处理通用的 Leaflet 标记（通过图标URL识别 stash_houses）
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('stash')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(0.3);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity: 0.3 });
                                }
                            }
                        } catch (e) {
                            // 忽略错误
                        }
                    });
                }

                // 同时处理Leaflet标记（如果存在）
                if (window.stashHousesMarkers && Array.isArray(window.stashHousesMarkers)) {
                    window.stashHousesMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(0.3);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity: 0.3 });
                        }
                    });
                }
                
                console.log('已应用藏匿屋可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到RC时间挑战赛标记
        function applyRCTimeTrialVisibilityCache() {
            const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('rc_time_trial');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用RC时间挑战赛可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到自行车时间挑战赛标记
        function applyBikeTimeTrialVisibilityCache() {
            const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('bike_time_trial');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用自行车时间挑战赛可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到玛德拉索雇凶标记
        function applyMadrazoHitsVisibilityCache() {
            const markers = (window.madrazoHitsMarkers && window.madrazoHitsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
                const isHidden = visibilityMap[0] === true;
                if (isHidden) {
                    markers.forEach((marker) => {
                        if (marker) {
                            if (typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        }
                    });
                }
                console.log('已应用玛德拉索雇凶可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到有机坊产品标记
        function applyOrganicFarmVisibilityCache() {
            const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ld_organics_products');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用有机坊产品可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到特技跳跃点标记
        function applyStuntJumpsVisibilityCache() {
            const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('stunt_jumps');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用特技跳跃点可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到电影道具标记
        function applyMoviePropsVisibilityCache() {
            const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('movie_props');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用电影道具可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到街头毒贩标记
        function applyStreetDealersVisibilityCache() {
            const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('street_dealers');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用街头毒贩可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到洛圣都杀人狂标记
        function applySlasherVisibilityCache() {
            const markers = (window.slasherMarkers && window.slasherMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用洛圣都杀人狂可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到幽灵曝光2025标记
        function applyGhosts3VisibilityCache() {
            const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ghosts3');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        } else if (typeof marker.getElement === 'function') {
                            // 对于divIcon，直接设置元素的透明度
                            const el = marker.getElement();
                            if (el) {
                                el.style.opacity = 0.3;
                            }
                        }
                    }
                });
                console.log('已应用幽灵曝光2025可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到雪人标记
        function applySnowmenVisibilityCache() {
            const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('snowmen');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用雪人可见性缓存');
                return true;
            }
            return false;
        }

        // 吞云吐雾馆产品弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSmokeProductPopup(item, index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/smoke_on_the_water_product/smoke_on_the_water_product_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.smoke-product-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
            const totalCount = 5; // 固定显示5个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `💨 吞云吐雾馆产品 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'smoke-product-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="吞云吐雾馆产品 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！<br>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; border-left: 3px solid #FF9800;">
                        <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">🎯 收集奖励</div>
                        <div style="color: var(--gta-text); font-size: 13px; line-height: 1.4;">
                            收集所有吞云吐雾馆产品可获得：<br>
                            • 特殊载具奖励<br>
                            • 游戏币奖励<br>
                            • 解锁隐藏成就
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-smoke-product-btn');
            const hideBtn = popup.querySelector('#hide-smoke-product-btn');
            const showBtn = popup.querySelector('#show-smoke-product-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'smoke-product-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('smoke_on_the_water_product', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `💨 吞云吐雾馆产品 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSmokeProductSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `💨 吞云吐雾馆产品 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSmokeProductSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到吞云吐雾馆产品标记
        function applySmokeProductVisibilityCache() {
            const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('smoke_on_the_water_product');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用吞云吐雾馆产品可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到LS涂鸦标记
        function applyLSTagsVisibilityCache() {
            const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ls_tags');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用LS涂鸦可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到纸牌标记
        function applyPlayingCardsVisibilityCache() {
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('playing_cards');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用纸牌可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到喷灌位置标记
        function applySprayVisibilityCache() {
            const markers = (window.sprayMarkers && window.sprayMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('spray');
                // 喷灌位置：隐藏一个标记后隐藏全部图标
                const isHidden = visibilityMap[0]; // 只检查第一个标记的状态
                if (isHidden) {
                    markers.forEach((marker) => {
                        if (marker) {
                            if (typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        }
                    });
                }
                console.log('已应用喷灌位置可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到陆地迷幻仙人掌标记
        function applyPplVisibilityCache() {
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppl');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用陆地迷幻仙人掌可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到水下迷幻仙人掌标记
        function applyPpwVisibilityCache() {
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppw');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用水下迷幻仙人掌可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到走私贩飞机标记
        function applySmugglerPlaneVisibilityCache() {
            const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
            if (groups.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('smuggler_plane');
                groups.forEach((groupMarkers, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && groupMarkers && groupMarkers.length > 0) {
                        groupMarkers.forEach((layer) => {
                            if (layer && typeof layer.setOpacity === 'function') {
                                layer.setOpacity(0.3);
                            } else if (layer && typeof layer.setStyle === 'function') {
                                layer.setStyle({ opacity: 0.3 });
                            }
                        });
                    }
                });
                console.log('已应用走私贩飞机可见性缓存');
                return true;
            }
            return false;
        }

        // 恢复缓存后的显示状态（优先调用显示逻辑而非加载坐标）
        function restoreCachedDisplayState() {
            try {
                // 1) 应用侧边栏缓存到 activeItemTypes
                const hadState = SidebarCache.applyState(activeItemTypes);

                // 2) 同步侧边栏复选框的勾选状态
                try {
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(chk => {
                        const t = chk && chk.dataset ? chk.dataset.itemType : undefined;
                        if (t) chk.checked = activeItemTypes.has(t);
                    });
                } catch (e) { /* no-op */ }

                // 3) 若有缓存状态，则渲染标记（此时 itemData 已通过每日逻辑过滤）
                if (hadState) {
                    updateItemMarkers();
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                }

                // 4) 渲染完成后再应用可见性缓存（需在标记存在后）
                try { applySmugglerPlaneVisibilityCache(); } catch (e) {}
                try { applyStreetDealersVisibilityCache(); } catch (e) {}
                try { applySubmarinePiecesVisibilityCache(); } catch (e) {}
                try { applyNuclearWasteVisibilityCache(); } catch (e) {}
                try { applySlasherVisibilityCache(); } catch (e) {}
                try { applyTreasureHuntVisibilityCache(); } catch (e) {}
                try { applyUfoVisibilityCache(); } catch (e) {}
                try { applyGhosts3VisibilityCache(); } catch (e) {}
                try { applySnowmenVisibilityCache(); } catch (e) {}
                try { applyMediaStickVisibilityCache(); } catch (e) {}
                try { applyMoviePropsVisibilityCache(); } catch (e) {}
                try { applyStuntJumpsVisibilityCache(); } catch (e) {}
                try { applyYuanbaoVisibilityCache(); } catch (e) {}
                try { applySignalJammersVisibilityCache(); } catch (e) {}
                try { applyActionFiguresVisibilityCache(); } catch (e) {}
                try { applyPlayingCardsVisibilityCache(); } catch (e) {}
                try { applyLetterScrapsVisibilityCache(); } catch (e) {}
                try { applySpaceshipPartsVisibilityCache(); } catch (e) {}
                try { applySprayVisibilityCache(); } catch (e) {}
                try { applyPplVisibilityCache(); } catch (e) {}
                try { applyPpwVisibilityCache(); } catch (e) {}
                try { applyHumansOfLsVisibilityCache(); } catch (e) {}
                try { applyMonkeyMosaicsVisibilityCache(); } catch (e) {}
                try { applyOrganicFarmVisibilityCache(); } catch (e) {}
                try { applySkydivesVisibilityCache(); } catch (e) {}
                try { applyRCTimeTrialVisibilityCache(); } catch (e) {}
                try { applyBikeTimeTrialVisibilityCache(); } catch (e) {}
                try { applyMadrazoHitsVisibilityCache(); } catch (e) {}
                try { applyStashHousesVisibilityCache(); } catch (e) {}
                try { applyLSTagsVisibilityCache(); } catch (e) {}
                try { applyShipwreckedVisibilityCache(); } catch (e) {}
                try { applyHiddenCachesVisibilityCache(); } catch (e) {}
                try { applySmokeProductVisibilityCache(); } catch (e) {}
                try { applyDeadDropVisibilityCache(); } catch (e) {}
                try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
                try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
                try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
                try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
                try { applyForSaleSignVisibilityCache(); } catch (e) {}
                try { applyTheBigScoreGauntletVisibilityCache(); } catch (e) {}

                // 5) 刷新计数器（如有）
                try { updateSmugglerPlaneSidebarCount(); } catch (e) {}
                try { updateStreetDealersSidebarCount(); } catch (e) {}
                try { updateSubmarinePiecesSidebarCount(); } catch (e) {}
                try { updateNuclearWasteSidebarCount(); } catch (e) {}
                try { updateAssumingTheTruthSidebarCount(); } catch (e) {}
                try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                try { updateForSaleSignSidebarCount(); } catch (e) {}
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
                try { updateSlasherSidebarCount(); } catch (e) {}
                try { updateTreasureHuntSidebarCount(); } catch (e) {}
                try { updateUfoSidebarCount(); } catch (e) {}
                try { updateGhosts3SidebarCount(); } catch (e) {}
                try { updateSnowmenSidebarCount(); } catch (e) {}
                try { updateStuntJumpsSidebarCount(); } catch (e) {}
                try { updateYuanbaoSidebarCount(); } catch (e) {}
                try { updateSignalJammersSidebarCount(); } catch (e) {}
                try { updateActionFiguresSidebarCount(); } catch (e) {}
                try { updatePlayingCardsSidebarCount(); } catch (e) {}
                try { updateLetterScrapsSidebarCount(); } catch (e) {}
                try { updateSpaceshipPartsSidebarCount(); } catch (e) {}
                try { updateSpraySidebarCount(); } catch (e) {}
                try { updatePplSidebarCount(); } catch (e) {}
                try { updatePpwSidebarCount(); } catch (e) {}
                try { updateHumansOfLsSidebarCount(); } catch (e) {}
                try { updateMonkeyMosaicsSidebarCount(); } catch (e) {}
                try { updateOrganicFarmSidebarCount(); } catch (e) {}
                try { updateSkydivesSidebarCount(); } catch (e) {}
                try { updateMadrazoHitsSidebarCount(); } catch (e) {}
                try { updateStashHousesSidebarCount(); } catch (e) {}
                try { updateLSTagsSidebarCount(); } catch (e) {}
                try { updateShipwreckedSidebarCount(); } catch (e) {}
                try { updateHiddenCachesSidebarCount(); } catch (e) {}
                try { updateSmokeProductSidebarCount(); } catch (e) {}
                try { updateDeadDropSidebarCount(); } catch (e) {}
                try { updateGunVanSidebarCount(); } catch (e) {}
                try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}

                console.log('已按缓存恢复显示状态');
            } catch (e) {
                console.warn('恢复缓存显示状态失败:', e);
            }
        }

        // 启动/结束恢复阶段时隐藏/显示 Leaflet 图层面板，避免短暂的“全量坐标”闪烁
        function hideLeafletPanesForRestore() {
            try {
                const panes = map && typeof map.getPanes === 'function' ? map.getPanes() : null;
                if (!panes) return;
                if (panes.markerPane) panes.markerPane.style.visibility = 'hidden';
                if (panes.overlayPane) panes.overlayPane.style.visibility = 'hidden';
                if (panes.shadowPane) panes.shadowPane.style.visibility = 'hidden';
                if (panes.tooltipPane) panes.tooltipPane.style.visibility = 'hidden';
                if (panes.popupPane) panes.popupPane.style.visibility = 'hidden';
            } catch (e) { /* no-op */ }
        }
        function showLeafletPanesForRestore() {
            try {
                const panes = map && typeof map.getPanes === 'function' ? map.getPanes() : null;
                if (!panes) return;
                if (panes.markerPane) panes.markerPane.style.visibility = 'visible';
                if (panes.overlayPane) panes.overlayPane.style.visibility = 'visible';
                if (panes.shadowPane) panes.shadowPane.style.visibility = 'visible';
                if (panes.tooltipPane) panes.tooltipPane.style.visibility = 'visible';
                if (panes.popupPane) panes.popupPane.style.visibility = 'visible';
            } catch (e) { /* no-op */ }
        }

        // ==================== 杰拉德包裹增强版弹窗（集成缓存） ====================
        
        // 创建侧边栏条目时，为 dead_drop 增加一个计数器占位
        function attachDeadDropCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.dead-drop-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'dead-drop-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateDeadDropSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（杰拉德包裹特殊：0/1）
        function updateDeadDropSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-dead_drop + label .dead-drop-counter');
                if (!counterEl) return;

                // 杰拉德包裹特殊：只有一个标记，所以总数固定为1
                const total = 1;
                let hidden = 0;

                // 检查是否有缓存的隐藏状态
                const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // 更新缓存
                CounterCache.updateCounter('dead_drop', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新杰拉德包裹计数器失败:', e);
            }
        }


        // 杰拉德包裹增强版弹窗（集成缓存，特殊处理：隐藏全部标记）
        function showDeadDropPopup(item, index) {
            const content = `杰拉德提供的秘密包裹投递点，完成可获得丰厚奖励。`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/dead_drop/dead_drop_${index + 1}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.dead-drop-popup');
            if (existingPopup) existingPopup.remove();

            // 杰拉德包裹特殊：只有一个标记，所以总数固定为1
            const totalCount = 1;
            let hiddenCount = 0;

            // 检查当前隐藏状态
            const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
            const isCurrentHidden = visibilityMap[0] === true;
            if (isCurrentHidden) {
                hiddenCount = 1;
            }

            const title = `📦 杰拉德包裹 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'dead-drop-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: #9C6EAF; font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="杰拉德包裹图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 110, 175, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-dead-drop-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-dead-drop-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-dead-drop-btn" style="padding: 8px 16px; background: #9C6EAF; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-dead-drop-btn');
            const hideBtn = popup.querySelector('#hide-dead-drop-btn');
            const showBtn = popup.querySelector('#show-dead-drop-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'dead-drop-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示杰拉德包裹标记（特殊：隐藏全部标记）
            function setDeadDropVisibility(opacity) {
                // 隐藏所有杰拉德包裹相关的标记
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('dead_drop')) {
                        marker.style.opacity = String(opacity);
                    }
                });

            // 同时处理通用的 Leaflet 标记（通过图标URL识别 dead_drop）
            if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                leafletMarkers.forEach((layer) => {
                    try {
                        const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                        if (iconUrl && iconUrl.includes('dead_drop')) {
                            if (typeof layer.setOpacity === 'function') {
                                layer.setOpacity(opacity);
                            } else if (typeof layer.setStyle === 'function') {
                                layer.setStyle({ opacity });
                            } else if (layer.getElement && layer.getElement()) {
                                layer.getElement().style.opacity = String(opacity);
                            }
                        }
                    } catch (e) { /* no-op */ }
                });
            }

                // 同时处理Leaflet标记（如果存在）
                if (window.smugglerGroupMarkers && window.smugglerGroupMarkers['dead_drop']) {
                    window.smugglerGroupMarkers['dead_drop'].forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('dead_drop', 0, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setDeadDropVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `📦 杰拉德包裹 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateDeadDropSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setDeadDropVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `📦 杰拉德包裹 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateDeadDropSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 藏匿屋增强版弹窗（集成缓存，特殊处理：隐藏全部标记）
        function showStashHousesPopup(item, index) {
            const content = `藏匿屋随机生成在 25 个可能位置之一，其位置会直接标记在游戏内地图上。

袭击藏匿屋即可获得 1.000 RP 与 30.000 GTA$ 奖励，或为您正在运营的产业之一补充原材料。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/stash_house/stash_house.webp';

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.stash-houses-popup');
            if (existingPopup) existingPopup.remove();

            // 藏匿屋特殊：只有一个标记，所以总数固定为1
            const totalCount = 1;
            let hiddenCount = 0;

            // 检查当前隐藏状态
            const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
            const isCurrentHidden = visibilityMap[0] === true;
            if (isCurrentHidden) {
                hiddenCount = 1;
            }

            const title = `🏠 藏匿屋 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'stash-houses-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="藏匿屋图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-stash-houses-btn');
            const hideBtn = popup.querySelector('#hide-stash-houses-btn');
            const showBtn = popup.querySelector('#show-stash-houses-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'stash-houses-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示藏匿屋标记（特殊：隐藏全部标记）
            function setStashHousesVisibility(opacity) {
                // 隐藏所有藏匿屋相关的标记
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('stash')) {
                        marker.style.opacity = String(opacity);
                    }
                });

                // 同时处理通用的 Leaflet 标记（通过图标URL识别 stash_houses）
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('stash')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(opacity);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity });
                                } else if (layer.getElement && layer.getElement()) {
                                    layer.getElement().style.opacity = String(opacity);
                                }
                            }
                        } catch (e) { /* no-op */ }
                    });
                }

                // 同时处理Leaflet标记（如果存在）
                if (window.stashHousesMarkers && Array.isArray(window.stashHousesMarkers)) {
                    window.stashHousesMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('stash_houses', 0, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setStashHousesVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `🏠 藏匿屋 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateStashHousesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setStashHousesVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `🏠 藏匿屋 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateStashHousesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到杰拉德包裹标记
        function applyDeadDropVisibilityCache() {
            const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
            const isHidden = visibilityMap[0] === true;
            
            if (isHidden) {
                // 隐藏所有杰拉德包裹相关的标记
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('dead_drop')) {
                        marker.style.opacity = '0.3';
                    }
                });

                // 同时处理通用的 Leaflet 标记（通过图标URL识别 dead_drop）
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('dead_drop')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(0.3);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity: 0.3 });
                                } else if (layer.getElement && layer.getElement()) {
                                    layer.getElement().style.opacity = '0.3';
                                }
                            }
                        } catch (e) { /* no-op */ }
                    });
                }

                // 同时处理Leaflet标记（如果存在）
                if (window.smugglerGroupMarkers && window.smugglerGroupMarkers['dead_drop']) {
                    window.smugglerGroupMarkers['dead_drop'].forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(0.3);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity: 0.3 });
                        }
                    });
                }
                
                console.log('已应用杰拉德包裹可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 缓存管理工具 ====================
        
        // 创建缓存管理面板
        function createCacheManagementPanel() {
            const panel = document.createElement('div');
            panel.id = 'cache-management-panel';
            panel.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                z-index: 10001; background: var(--gta-bg-medium); border: 1px solid var(--gta-border);
                border-radius: 8px; padding: 15px; min-width: 300px; max-width: 90vw;
                color: var(--gta-text); font-family: 'Segoe UI', sans-serif;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 80vh;
                overflow-y: auto; display: none;
            `;

            const cacheInfo = CacheManager.getCacheInfo();
            let infoHtml = '<h3 style="margin: 0 0 15px 0; color: var(--gta-primary);">缓存管理</h3>';
            
            // 添加调试信息
            infoHtml += `<div style="margin: 8px 0; padding: 8px; background: rgba(0, 150, 136, 0.1); border-radius: 4px;">
                <strong>当前状态:</strong><br>
                侧边栏选择: ${Array.from(activeItemTypes).join(', ') || '无'}<br>
                缓存键数量: ${Object.keys(cacheInfo).length}
            </div>`;
            
            Object.entries(cacheInfo).forEach(([name, info]) => {
                if (info) {
                    const sizeKB = (info.size / 1024).toFixed(2);
                    const date = new Date(info.timestamp).toLocaleString();
                    infoHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(25, 118, 210, 0.1); border-radius: 4px;">
                            <strong>${name}:</strong><br>
                            大小: ${sizeKB} KB<br>
                            时间: ${date}<br>
                            版本: ${info.version || 'N/A'}
                        </div>
                    `;
                } else {
                    infoHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">
                            <strong>${name}:</strong> 无缓存数据
                        </div>
                    `;
                }
            });

            infoHtml += `
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="save-cache-btn" style="padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">保存当前状态</button>
                    <button id="clear-cache-btn" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">清空缓存</button>
                    <button id="refresh-cache-btn" style="padding: 8px 12px; background: var(--gta-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">刷新信息</button>
                    <button id="close-cache-panel" style="padding: 8px 12px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 4px; cursor: pointer;">关闭</button>
                </div>
            `;

            panel.innerHTML = infoHtml;
            document.body.appendChild(panel);

            // 绑定事件
            panel.querySelector('#save-cache-btn').addEventListener('click', () => {
                try {
                    SidebarCache.saveState(activeItemTypes);
                    alert('当前状态已保存到缓存');
                    panel.remove();
                    createCacheManagementPanel().style.display = 'block';
                } catch (error) {
                    alert('保存失败: ' + error.message);
                }
            });

            panel.querySelector('#clear-cache-btn').addEventListener('click', () => {
                if (confirm('确定要清空所有缓存吗？这将重置所有用户设置和进度。')) {
                    CacheManager.clearAll();
                    alert('缓存已清空');
                    panel.remove();
                }
            });

            panel.querySelector('#refresh-cache-btn').addEventListener('click', () => {
                panel.remove();
                createCacheManagementPanel();
            });

            panel.querySelector('#close-cache-panel').addEventListener('click', () => {
                panel.remove();
            });

            return panel;
        }

        // 添加缓存管理按钮到页面（放在侧边栏最底下）
        function addCacheManagementButton() {
            // 查找侧边栏内容容器
            const sidePanelContent = document.querySelector('.side-panel-content');
            if (!sidePanelContent) {
                console.warn('未找到侧边栏内容容器，将按钮放在页面底部');
                // 如果找不到侧边栏容器，放在页面底部
                const button = document.createElement('button');
                button.id = 'cache-management-btn';
                button.innerHTML = '🗄️ 缓存';
                button.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px; z-index: 10000;
                    padding: 8px 12px; background: var(--gta-bg-medium);
                    color: var(--gta-text); border: 1px solid var(--gta-border);
                    border-radius: 6px; cursor: pointer; font-size: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;
                `;
                addButtonEvents(button);
                document.body.appendChild(button);
                return;
            }

            // 在侧边栏内容容器内创建按钮
            const button = document.createElement('button');
            button.id = 'cache-management-btn';
            button.innerHTML = '🗄️ 缓存';
            button.style.cssText = `
                width: 100%; margin-top: 8px; padding: 8px 12px; 
                background: var(--gta-bg-medium); color: var(--gta-text); 
                border: 1px solid var(--gta-border); border-radius: 6px; 
                cursor: pointer; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            `;

            addButtonEvents(button);
            sidePanelContent.appendChild(button);
        }

        // 添加按钮事件处理
        function addButtonEvents(button) {
            button.addEventListener('mouseenter', () => {
                button.style.background = 'var(--gta-primary)';
                button.style.color = 'white';
            });

            button.addEventListener('mouseleave', () => {
                button.style.background = 'var(--gta-bg-medium)';
                button.style.color = 'var(--gta-text)';
            });

            button.addEventListener('click', () => {
                const existingPanel = document.getElementById('cache-management-panel');
                if (existingPanel) {
                    existingPanel.remove();
                } else {
                    createCacheManagementPanel().style.display = 'block';
                }
            });
        }

        // DOM元素
        const styleSelect = document.getElementById('map-style-select');
        // 右上角的 item-type-select 已移除，侧边栏使用静态选项数组生成复选框
        const sidebarItemOptions = [
            { value: 'dealerships', text: '🏦 车行位置' },
            { value: 'hidden_caches', text: '隐藏包裹' },
            { value: 'shipwrecked', text: '沉船' },
            { value: 'gun_van', text: '武器厢型车' },
            { value: 'dead_drop', text: '杰拉德包裹' },
            { value: 'ls_tags', text: 'LS涂鸦' },
            { value: 'street_dealers', text: '街头毒贩' },
            { value: 'playing_cards', text: '纸牌' },
            { value: 'smoke_on_the_water_product', text: '吞云吐雾馆产品（测试）' },
            { value: 'action_figures', text: '手办' },
            { value: 'yuanbao', text: '元宝' },
            { value: 'letter_scraps', text: '残缺信件' },
            { value: 'sp_hidden_packages', text: '隐藏包裹（线下）' },
            { value: 'peyote_sp_land', text: '迷幻仙人掌陆地' },
            { value: 'peyote_sp_air', text: '迷幻仙人掌鸟类' },
            { value: 'peyote_sp_water', text: '迷幻仙人掌水下' },
            { value: 'peyote_sp_special', text: '迷幻仙人掌金色' },
            { value: 'submarine_pieces', text: '潜水艇碎片' },
            { value: 'spaceship_parts', text: '宇宙飞船部件' },
            { value: 'nuclear_waste', text: '核废料' },
            { value: 'humans_of_ls', text: '洛圣都的人类', icon: '../src/assets/humans_of_ls.svg' },
            { value: 'monkey_mosaics', text: '猴子马赛克', icon: '../src/assets/monkey_mosaics.svg' },
            { value: 'murder_mystery_message', text: '谋杀之谜', icon: '../src/assets/murder_mystery_message.svg' },
            { value: 'assuming_the_truth', text: '埃普西隆质疑真理-载具', icon: '../src/assets/assuming_the_truth_car.svg' },
            { value: 'epsilon_tracts', text: '埃普西隆传单', icon: '../src/assets/epsilon_tracts.svg' },
            { value: 'for_sale_sign', text: '待售标志', icon: '../src/assets/for_sale_sign.svg' },
            { value: 'the_big_score_gauntlet', text: '大干一票（巧妙）- 铁腕', icon: '../src/assets/the_big_score_gauntlet.svg' },
            { value: 'hitchhikers', text: '搭便车(潜在利他教受害者)', icon: '../src/assets/hitchhikers.svg' },
            { value: 'chasing_the_truth', text: '埃普斯隆追求真理-神器', icon: '../src/assets/chasing_the_truth.svg' },
            { value: 'stunt_jumps', text: '特技跳跃点' },
            { value: 'spray', text: '喷罐位置' },
            { value: 'ld_organics_products', text: '有机坊产品' },
            { value: 'signal_jammers', text: '信号干扰器' },
            { value: 'jack_o_lanterns', text: '南瓜灯' },
            { value: 'payphone_hits', text: '电话暗杀' },
            { value: 'golf_holes', text: '高尔夫球洞' },
            { value: 'snowmen', text: '雪人' },
            { value: 'rc_time_trial', text: 'RC时间挑战赛' },
            { value: 'bike_time_trial', text: '自行车时间挑战赛' },
            { value: 'skydives', text: '跳伞' },
            { value: 'gang_attacks', text: '🎆 帮派攻击' },
            { value: 'ghosts3', text: '幽灵曝光2025' },
            { value: 'treasure_hunt_dba_revolver', text: '左轮寻宝' },
            { value: 'movie_props', text: '电影道具' },
            { value: 'serial_killer_slasher', text: '洛圣都杀人狂' },
            { value: 'maude_bounty_targets', text: '茉德悬赏目标' },
            { value: 'media_sticks', text: '媒体记忆棒' },
            { value: 'stash_houses', text: '藏匿屋' },
            { value: 'madrazo_hits', text: '玛德拉索雇凶' },
            { value: 'police_rescue_patrick_mcreary', text: '帕特里克救援', icon: '../src/assets/patrick.svg' },
            { value: 'random_missions', text: '随机任务', icon: '../src/assets/random.svg' },
            { value: 'drug_vehicle', text: '毒品载具', icon: '../src/assets/drug_vehicle.svg' },
            { value: 'drunk_guard', text: '沉睡的保安', icon: '../src/assets/drunk_guard.svg' },
            { value: 'metal_detector', text: '金属探测器', icon: '../src/assets/metal.svg' },
            { value: 'smuggler_plane', text: '走私贩飞机', icon: '../src/assets/smuggler_plane.svg' },
            { value: 'smuggler_trail', text: '走私贩踪迹', icon: '../src/assets/smuggler_trail.svg' },
            { value: 'crime_scenes', text: '犯罪现场', icon: '../src/assets/crime_scenes.svg' },
            { value: 'ufo', text: 'UFO观光', icon: '../src/assets/ufo.svg' },
            { value: 'halloween_slashers', text: '万圣节杀人狂', icon: '../src/assets/slasher.svg' },
            { value: 'possessed_animals', text: '鬼上身的动物', icon: '../src/assets/cerberus.svg' },
            { value: 'cerberus', text: '万圣节地狱犬事件', icon: '../src/assets/cerberus.svg' },
            { value: 'yeti', text: '雪怪', icon: '../src/assets/what.svg' },
            { value: 'happy_holidays_hauler', text: '节日快乐卡车', icon: '../src/assets/happy.svg' },
            { value: 'wea', text: '威泽尔大楼枪战', icon: '../src/assets/wea.svg' },
            { value: 'ppl', text: '陆地迷幻仙人掌', icon: '../src/assets/ppl.svg' },
            { value: 'ppw', text: '水下迷幻仙人掌', icon: '../src/assets/ppw.svg' },
            { value: 'metro', text: '地铁站', icon: '../src/assets/metro.svg' },
            { value: 'police', text: '警察局', icon: '../src/assets/police.svg' },
            { value: 'v_telescopes', text: '望远镜', icon: '../src/assets/telescopes.svg' },
            { value: 'fire_stations', text: '消防局', icon: '../src/assets/fire.svg' },
            { value: 'hospitals', text: '医院', icon: '../src/assets/hospitals.svg' },
            { value: 'clothing', text: '服装店', icon: '../src/assets/clothing.svg' },
            { value: 'tattoos', text: '纹身店', icon: '../src/assets/tattoos.svg' },
            { value: 'barbers', text: '理发店', icon: '../src/assets/barbers.svg' },
            { value: 'ammunation', text: '武装国度', icon: '../src/assets/ammunation.svg' },
            { value: 'mod_shop', text: '洛圣都改车王', icon: '../src/assets/mod_shop.svg' },
            { value: 'car_wash', text: '洗车店', icon: '../src/assets/car_wash.svg' },
            { value: 'shops_to_rob', text: '可抢劫的商店', icon: '../src/assets/shops_to_rob.svg' },
            { value: 'gas_stations', text: '加油站', icon: '../src/assets/gas_stations.svg' },
            { value: 'atms', text: 'ATM机', icon: '../src/assets/atms.svg' },
            { value: 'vend_sprunk', text: '霜碧售卖机', icon: '../src/assets/vend_sprunk.svg' },
            { value: 'vend_ecola', text: '易可乐售卖机', icon: '../src/assets/vend_ecola.svg' },
            { value: 'community_outreach', text: '社区边界', icon: '../src/assets/community_outreach.svg' },
            { value: 'store_robbery', text: '商店抢劫', icon: '../src/assets/store_robbery.svg' },
            { value: 'convoy', text: '车队', icon: '../src/assets/convoy.svg' },
            { value: 'armored_truck', text: '装甲运钞车', icon: '../src/assets/armored_truck.svg' },
            { value: 'exotic_exports1', text: '外贸出口载具1', icon: '../src/assets/exotic_exports1.svg' },
            { value: 'exotic_exports2', text: '外贸出口载具2', icon: '../src/assets/exotic_exports2.svg' }
        ];
        const loader = document.getElementById('loader');
        const fileStatus = document.getElementById('file-status');
        const itemInfo = document.getElementById('item-info');

        let currentStyle = styleSelect.value;
    let currentItemType = '';
    // 支持同时显示多个物品类型
    let activeItemTypes = new Set();
    // 存储每个标记对象：{type, index, el}
    let itemMarkers = [];

        // --- 地图初始化 ---
        function getLevelByZoom(z) {
            return zoomLevels.find(l => l.zoom === z);
        }
        // 当缩放为小数（缩放动画过程中）时，选择最近的缩放级别用于像素尺寸/列行数计算
        function getNearestLevelByZoom(z) {
            if (!Array.isArray(zoomLevels) || zoomLevels.length === 0) return null;
            return zoomLevels.reduce((best, cur) => Math.abs(cur.zoom - z) < Math.abs(best.zoom - z) ? cur : best, zoomLevels[0]);
        }
        function getLevelOrNearest(z) {
            return getLevelByZoom(z) || getNearestLevelByZoom(z);
        }
        function totalSizeForZoom(z) {
            const level = getLevelByZoom(z);
            if (!level) return { width: 0, height: 0 };
            return { width: level.cols * TILE_SIZE, height: level.rows * TILE_SIZE };
        }

        const errorTileSVG = encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}">` +
            `<rect width="100%" height="100%" fill="#1a1a1a"/></svg>`
        );
        const errorTileDataUrl = `data:image/svg+xml;charset=UTF-8,${errorTileSVG}`;

        const initialZoom = zoomLevels[0].zoom;
        const initialSize = totalSizeForZoom(initialZoom);
        const initialCenterPoint = L.point(initialSize.width / 2, initialSize.height / 2);

        const map = L.map('map-container', {
            crs: L.CRS.Simple,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true
        });

        function resetViewForZoom(z, centerPixel) {
            const size = totalSizeForZoom(z);
            if (size.width === 0) return;

            // 使用传入的中心点，如果没有则使用地图中心
            let centerPoint = centerPixel ? L.point(centerPixel.x, centerPixel.y) : L.point(size.width / 2, size.height / 2);
            
            const centerLatLng = map.unproject(centerPoint, z);

            const southWest = map.unproject(L.point(0, size.height), z);
            const northEast = map.unproject(L.point(size.width, 0), z);
            const bounds = new L.LatLngBounds(southWest, northEast);

            map.setMaxBounds(bounds);
            
            // 设置视图到指定位置，不再强制居中
                map.setView(centerLatLng, z, { animate: false });

            // DOM 标记层已移除
        }

        resetViewForZoom(initialZoom);

        // 根据当前样式获取错误瓦片的纯色背景
        function getErrorTileUrl(style) {
            // 提取样式名称（从URL中获取最后一部分）
            let styleName = 'game'; // 默认样式
            if (style.includes('game')) {
                styleName = 'game';
            } else if (style.includes('render')) {
                styleName = 'render';
            } else if (style.includes('print')) {
                styleName = 'print';
            }
            
            // 不同地图样式对应的RGB颜色值
            const colors = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            // 获取当前样式对应的颜色，如果没有则使用默认颜色
            const color = colors[styleName] || '#1a1a1a';
            
            // 返回纯色背景的SVG数据URL
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">' +
                '<rect width="100%" height="100%" fill="' + color + '"/>' +
                '</svg>'
            );
        }

        const CustomTileLayer = L.TileLayer.extend({
            getTileUrl: function(coords) {
                return `${currentStyle}/${coords.z}/${coords.x}_${coords.y}.jpg`;
            }
        });

        const tileLayer = new CustomTileLayer('', {
            tileSize: TILE_SIZE,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            noWrap: true,
            subdomains: [],
            errorTileUrl: getErrorTileUrl(currentStyle)
        });

        tileLayer.on('loading', () => loader.classList.add('visible'));
        tileLayer.on('load', () => loader.classList.remove('visible'));
        tileLayer.on('tileerror', (err) => {
            loader.classList.remove('visible');
        });

        tileLayer.addTo(map);

        // 样式选择事件
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            // 更新错误瓦片URL以匹配新样式
            tileLayer.options.errorTileUrl = getErrorTileUrl(currentStyle);
            tileLayer.redraw();
        });

        // --- 物品标记功能 ---
        function updateTilePanePosition() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;

            const bounds = map.getBounds();
            const topLeftLatLng = bounds.getNorthWest();
            const topLeftPoint = map.project(topLeftLatLng, z);
            
            const size = { width: level.cols * TILE_SIZE, height: level.rows * TILE_SIZE };
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            
            // 计算基础偏移量
            let translateX = -topLeftPoint.x;
            let translateY = -topLeftPoint.y;
            // 移除额外的居中偏移，避免在地图尺寸小于容器时重复居中导致偏差

            // DOM 标记层已移除，无需同步 transform
            updateOriginMarker();
            updateLeafletMarkersRadius(); // 更新Leaflet标记半径以响应缩放
            updateDealershipMarkers(); // 更新车行标记位置
        }

        function updateOriginMarker() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            const percentX = (0 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
            const percentY = (GAME_TOP - 0) / (GAME_TOP - GAME_BOTTOM);

            const originX = percentX * totalWidth;
            const originY = percentY * totalHeight;
            // Origin marker display removed by design. If needed later,
            // position can be computed here without creating DOM elements.
        }

        // 加载物品数据
        async function loadItemData() {
            try {
                const response = await fetch('../src/data/zones.json');
                const data = await response.json();
                
                // 将数据复制到itemData对象
                Object.keys(itemData).forEach(key => {
                    if (data[key]) {
                        if (key === 'ghosts3') {
                            try {
                                // ghosts3 为嵌套数组结构： [ [ [x,y,[label],[time,day,idx]], ... ], [ ... ] ...]
                                // 将其拍平成统一结构：{x, y, time}
                                itemData[key] = [];
                                data[key].forEach(group => {
                                    if (Array.isArray(group)) {
                                        group.forEach(item => {
                                            if (Array.isArray(item) && item.length >= 4) {
                                                const x = item[0];
                                                const y = item[1];
                                                const timeInfo = item[3];
                                                const time = Array.isArray(timeInfo) && timeInfo.length > 0 ? String(timeInfo[0]) : '';
                                                itemData[key].push({ x, y, time });
                                            }
                                        });
                                    }
                                });
                            } catch (err) {
                                console.error('解析ghosts3数据失败:', err);
                                itemData[key] = [];
                            }
                        } else if (['metro', 'police', 'fire_stations', 'hospitals'].includes(key)) {
                            // 新物品类型：地铁站、警察局、消防局、医院
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 2) {
                                            const x = item[0];
                                            const y = item[1];
                                            const labels = item[2] || [];
                                            const label = Array.isArray(labels) && labels.length > 0 ? labels[0] : '';
                                            itemData[key].push({ 
                                                x, 
                                                y, 
                                                name: `${key === 'metro' ? '地铁站' : key === 'police' ? '警察局' : key === 'fire_stations' ? '消防局' : '医院'} ${index + 1}`,
                                                label: label
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} 数据加载成功：${itemData[key].length} 个位置`);
                            } catch (err) {
                                console.error(`加载${key}数据失败:`, err);
                                itemData[key] = [];
                            }
                        } else if (key === 'v_telescopes') {
                            // 望远镜特殊处理：嵌套数组结构
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((group, groupIndex) => {
                                        if (Array.isArray(group)) {
                                            group.forEach((item, itemIndex) => {
                                                if (Array.isArray(item) && item.length >= 2) {
                                                    const x = item[0];
                                                    const y = item[1];
                                                    itemData[key].push({ 
                                                        x, 
                                                        y, 
                                                        name: `望远镜 ${groupIndex + 1}-${itemIndex + 1}`,
                                                        groupIndex: groupIndex,
                                                        itemIndex: itemIndex
                                                    });
                                                }
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} 数据加载成功：${itemData[key].length} 个位置`);
                            } catch (err) {
                                console.error(`加载${key}数据失败:`, err);
                                itemData[key] = [];
                            }
                        } else if (['tattoos', 'barbers', 'car_wash', 'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'].includes(key)) {
                            // 简单数组结构的商店类型
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 2) {
                                            const x = item[0];
                                            const y = item[1];
                                            const labels = item[2] || [];
                                            const label = Array.isArray(labels) && labels.length > 0 ? labels[0] : '';
                                            
                                            let name = '';
                                            switch(key) {
                                                case 'tattoos': name = `纹身店 ${index + 1}`; break;
                                                case 'barbers': name = `理发店 ${index + 1}`; break;
                                                case 'car_wash': name = `洗车店 ${index + 1}`; break;
                                                case 'shops_to_rob': name = `可抢劫商店 ${index + 1}`; break;
                                                case 'gas_stations': name = `加油站 ${index + 1}`; break;
                                                case 'atms': name = `ATM机 ${index + 1}`; break;
                                                case 'vend_sprunk': name = `霜碧售卖机 ${index + 1}`; break;
                                                case 'vend_ecola': name = `易可乐售卖机 ${index + 1}`; break;
                                            }
                                            
                                            itemData[key].push({ 
                                                x, 
                                                y, 
                                                name: name,
                                                label: label
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} 数据加载成功：${itemData[key].length} 个位置`);
                            } catch (err) {
                                console.error(`加载${key}数据失败:`, err);
                                itemData[key] = [];
                            }
                        } else if (['clothing', 'ammunation', 'mod_shop'].includes(key)) {
                            // 对象结构的商店类型（clothing, ammunation）
                            try {
                                itemData[key] = [];
                                if (data[key] && typeof data[key] === 'object') {
                                    Object.keys(data[key]).forEach((category, categoryIndex) => {
                                        if (Array.isArray(data[key][category])) {
                                            data[key][category].forEach((item, itemIndex) => {
                                                if (Array.isArray(item) && item.length >= 2) {
                                                    const x = item[0];
                                                    const y = item[1];
                                                    
                                                    let name = '';
                                                    if (key === 'clothing') {
                                                        const categoryNames = { 'cheap': '便宜服装店', 'mid': '中等服装店', 'high': '高档服装店' };
                                                        name = `${categoryNames[category] || category} ${itemIndex + 1}`;
                                                    } else if (key === 'ammunation') {
                                                        name = `武装国度 ${category} ${itemIndex + 1}`;
                                                    } else if (key === 'mod_shop') {
                                                        const categoryNames = { 'lsc': '洛圣都改车王', 'lsc2': '洛圣都改车王2', 'bennys': '班尼改装坊', 'tuning_lscm': '洛圣都车友会' };
                                                        name = `${categoryNames[category] || category} ${itemIndex + 1}`;
                                                    }
                                                    
                                                    itemData[key].push({ 
                                                        x, 
                                                        y, 
                                                        name: name,
                                                        category: category,
                                                        categoryIndex: categoryIndex
                                                    });
                                                }
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} 数据加载成功：${itemData[key].length} 个位置`);
                            } catch (err) {
                                console.error(`加载${key}数据失败:`, err);
                                itemData[key] = [];
                            }
                        } else {
                            itemData[key] = data[key];
                        }
                    }
                });

                // 显式覆盖：metal_detector 来自 data（一次）
                try {
                    if (Array.isArray(data.metal_detector)) {
                        itemData.metal_detector = data.metal_detector.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `金属探测器 ${index + 1}`
                        }));
                    }
                } catch (e) {}

                // 单独处理 treasure_hunt_dba_revolver 结构
                if (data.treasure_hunt_dba_revolver) {
                    try {
                        const th = data.treasure_hunt_dba_revolver;
                        const rc = Array.isArray(th.random_clue) ? th.random_clue : [];
                        const sc = Array.isArray(th.static_clues) ? th.static_clues : [];
                        itemData.treasure_hunt_dba_revolver = {
                            random_clue: rc.map(p => ({ x: p[0], y: p[1] })),
                            static_clues: sc.map(p => ({ x: p[0], y: p[1] }))
                        };
                    } catch (e) {
                        console.error('解析treasure_hunt_dba_revolver失败', e);
                        itemData.treasure_hunt_dba_revolver = { random_clue: [], static_clues: [] };
                    }
                }
                
                // 加载所有物品数据（从zones.json）
                try {
                    const cardsResponse = await fetch('../src/data/zones.json');
                    const cardsData = await cardsResponse.json();
                    
                    // 加载playing_cards数据
                    if (cardsData.playing_cards) {
                        itemData.playing_cards = cardsData.playing_cards.map(card => ({
                            x: card[0],
                            y: card[1],
                            name: card[2] || '纸牌位置'
                        }));
                        console.log('纸牌位置数据加载成功，共', itemData.playing_cards.length, '个位置');
                    }
                    
                    // 加载letter_scraps数据
                    if (cardsData.letter_scraps) {
                        itemData.letter_scraps = cardsData.letter_scraps.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `信件残片 ${index + 1}`
                        }));
                        console.log('信件残片数据加载成功，共', itemData.letter_scraps.length, '个位置');
                    }
                    
                    // 加载sp_hidden_packages数据
                    if (cardsData.sp_hidden_packages) {
                        itemData.sp_hidden_packages = cardsData.sp_hidden_packages.map((item, index) => ({
                            x: item[0],
                            y: item[1],
                            description: item[2] || '',
                            name: `隐藏包裹 ${index + 1}`
                        }));
                        console.log('隐藏包裹（线下）数据加载成功，共', itemData.sp_hidden_packages.length, '个位置');
                    }
                    
                    // 加载peyote_sp数据
                    if (cardsData.peyote_sp && Array.isArray(cardsData.peyote_sp) && cardsData.peyote_sp.length > 0) {
                        const peyoteData = cardsData.peyote_sp[0]; // 取数组中的第一个对象
                        
                        // 陆地迷幻仙人掌
                        if (peyoteData.land) {
                            itemData.peyote_sp_land = peyoteData.land.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `迷幻仙人掌陆地 ${index + 1}`
                            }));
                            console.log('迷幻仙人掌陆地数据加载成功，共', itemData.peyote_sp_land.length, '个位置');
                        }
                        
                        // 鸟类迷幻仙人掌
                        if (peyoteData.air) {
                            itemData.peyote_sp_air = peyoteData.air.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `迷幻仙人掌鸟类 ${index + 1}`
                            }));
                            console.log('迷幻仙人掌鸟类数据加载成功，共', itemData.peyote_sp_air.length, '个位置');
                        }
                        
                        // 水下迷幻仙人掌
                        if (peyoteData.water) {
                            itemData.peyote_sp_water = peyoteData.water.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `迷幻仙人掌水下 ${index + 1}`
                            }));
                            console.log('迷幻仙人掌水下数据加载成功，共', itemData.peyote_sp_water.length, '个位置');
                        }
                        
                        // 金色迷幻仙人掌
                        if (peyoteData.special) {
                            itemData.peyote_sp_special = peyoteData.special.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `迷幻仙人掌金色 ${index + 1}`
                            }));
                            console.log('迷幻仙人掌金色数据加载成功，共', itemData.peyote_sp_special.length, '个位置');
                        }
                    }
                    
                    // 加载submarine_pieces数据
                    if (cardsData.submarine_pieces) {
                        itemData.submarine_pieces = cardsData.submarine_pieces.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `潜水艇碎片 ${index + 1}`
                        }));
                        console.log('潜水艇碎片数据加载成功，共', itemData.submarine_pieces.length, '个位置');
                    }
                    
                    // 加载spaceship_parts数据
                    if (cardsData.spaceship_parts) {
                        itemData.spaceship_parts = cardsData.spaceship_parts.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `宇宙飞船部件 ${index + 1}`
                        }));
                        console.log('宇宙飞船部件数据加载成功，共', itemData.spaceship_parts.length, '个位置');
                    }
                    
                    // 加载nuclear_waste数据
                    if (cardsData.nuclear_waste) {
                        itemData.nuclear_waste = cardsData.nuclear_waste.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `核废料 ${index + 1}`
                        }));
                        console.log('核废料数据加载成功，共', itemData.nuclear_waste.length, '个位置');
                    }
                    
                    // 加载 humans_of_ls 数据（数组形式：[x, y, [id]]）
                    if (Array.isArray(cardsData.humans_of_ls)) {
                        itemData.humans_of_ls = cardsData.humans_of_ls.map((arr, index) => {
                            const x = arr[0];
                            const y = arr[1];
                            const ids = Array.isArray(arr[2]) ? arr[2] : [];
                            const id = ids[0] || `humans_of_ls_${index + 1}`;
                            return { x, y, id, name: `洛圣都的人类 ${index + 1}` };
                        });
                        console.log('humans_of_ls 数据加载成功，共', itemData.humans_of_ls.length, '个位置');
                    } else {
                        itemData.humans_of_ls = [];
                    }
                    
                    // 加载 monkey_mosaics 数据（数组元素为对象：{x:..., y:...}）
                    if (Array.isArray(cardsData.monkey_mosaics)) {
                        itemData.monkey_mosaics = cardsData.monkey_mosaics.map((obj, index) => ({
                            x: obj.x,
                            y: obj.y,
                            name: `猴子马赛克 ${index + 1}`
                        }));
                        console.log('monkey_mosaics 数据加载成功，共', itemData.monkey_mosaics.length, '个位置');
                    } else {
                        itemData.monkey_mosaics = [];
                    }

                    // 加载 murder_mystery_message 数据（zones.json.murder_mystery_message）
                    try {
                        const m3 = cardsData.murder_mystery_message || {};
                        const flattened = [];
                        Object.keys(m3).forEach((groupKey) => {
                            const arr = Array.isArray(m3[groupKey]) ? m3[groupKey] : [];
                            arr.forEach((pair, idx) => {
                                if (Array.isArray(pair) && pair.length >= 2) {
                                    flattened.push({ x: pair[0], y: pair[1], group: String(groupKey), groupIndex: idx + 1, name: `谋杀之谜信息 ${groupKey}-${idx+1}` });
                                }
                            });
                        });
                        itemData.murder_mystery_message = flattened;
                        console.log('murder_mystery_message 数据加载成功，共', itemData.murder_mystery_message.length, '个点');
                    } catch (e) {
                        console.warn('加载 murder_mystery_message 失败:', e);
                        itemData.murder_mystery_message = [];
                    }
                    
                    // 加载 assuming_the_truth 数据（zones.json.assuming_the_truth）
                    try {
                        if (Array.isArray(cardsData.assuming_the_truth)) {
                            itemData.assuming_the_truth = cardsData.assuming_the_truth.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('assuming_the_truth 数据加载成功，共', itemData.assuming_the_truth.length, '个位置');
                        } else {
                            itemData.assuming_the_truth = [];
                        }
                    } catch (e) {
                        console.warn('加载 assuming_the_truth 失败:', e);
                        itemData.assuming_the_truth = [];
                    }
                    
                    // 加载 chasing_the_truth 数据（zones.json.chasing_the_truth）
                    try {
                        if (Array.isArray(cardsData.chasing_the_truth)) {
                            itemData.chasing_the_truth = cardsData.chasing_the_truth.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('chasing_the_truth 数据加载成功，共', itemData.chasing_the_truth.length, '个位置');
                        } else {
                            itemData.chasing_the_truth = [];
                        }
                    } catch (e) {
                        console.warn('加载 chasing_the_truth 失败:', e);
                        itemData.chasing_the_truth = [];
                    }

                    // 加载 epsilon_tracts 数据（zones.json.epsilon_tracts）
                    try {
                        if (Array.isArray(cardsData.epsilon_tracts)) {
                            itemData.epsilon_tracts = cardsData.epsilon_tracts.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('epsilon_tracts 数据加载成功，共', itemData.epsilon_tracts.length, '个位置');
                        } else {
                            itemData.epsilon_tracts = [];
                        }
                    } catch (e) {
                        console.warn('加载 epsilon_tracts 失败:', e);
                        itemData.epsilon_tracts = [];
                    }
                    // 加载 hitchhikers 数据（zones.json.hitchhikers），包含说明文字数组
                    try {
                        if (Array.isArray(cardsData.hitchhikers)) {
                            itemData.hitchhikers = cardsData.hitchhikers.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const notes = Array.isArray(arr[2]) ? arr[2].map(s => String(s)) : [];
                                return { x, y, notes, name: `搭便车 ${index + 1}` };
                            });
                            console.log('hitchhikers 数据加载成功，共', itemData.hitchhikers.length, '个位置');
                        } else {
                            itemData.hitchhikers = [];
                        }
                    } catch (e) {
                        console.warn('加载 hitchhikers 失败:', e);
                        itemData.hitchhikers = [];
                    }
                    // 加载其他物品数据
                    const itemTypes = [
                        'smoke_on_the_water_product',
                        'action_figures', 
                        'yuanbao',
                        'ld_organics_products',
                        'signal_jammers',
                        'jack_o_lanterns',
                        'payphone_hits',
                        'golf_holes',
                        'snowmen',
                        'spray',
                        'for_sale_sign',
                        'the_big_score_gauntlet',
                        // 杀人狂单独加载，不走通用分支
                    ];
                    
                    itemTypes.forEach(type => {
                        try {
                            // 特殊：杀人狂（从嵌套对象加载）
                            if (type === 'serial_killer_slasher_first' || type === 'serial_killer_slasher_last') {
                                // 跳过（我们不再把这两个伪类型放在通用数组里）
                            } else if (cardsData[type]) {
                                // 处理action_figures的特殊嵌套结构
                                if (type === 'action_figures' && cardsData[type].regular) {
                                    // 合并regular和last_two数组
                                    const regularItems = cardsData[type].regular || [];
                                    const lastTwoItems = cardsData[type].last_two || [];
                                    itemData[type] = [...regularItems, ...lastTwoItems].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else if (Array.isArray(cardsData[type])) {
                                    // 只对数组类型调用map方法
                                    itemData[type] = cardsData[type].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else {
                                    itemData[type] = [];
                                }
                                console.log(`${type}数据加载成功，共${itemData[type].length}个位置`);
                            }
                        } catch (error) {
                            console.error(`加载${type}数据失败`);
                            itemData[type] = []; // 提供默认值，避免后续错误
                        }
                    });

                    // 单独加载：洛圣都杀人狂（from zones.json.serial_killer_slasher）
                    try {
                        if (cardsData.serial_killer_slasher) {
                            const f = cardsData.serial_killer_slasher.first || [];
                            const l = cardsData.serial_killer_slasher.last || [];
                            itemData.serial_killer_slasher.first = f.map((p, i) => ({ x: p[0], y: p[1], name: `杀人狂线索 ${i+1}` }));
                            itemData.serial_killer_slasher.last = l.map((p, i) => ({ x: p[0], y: p[1], name: `杀人狂最终 ${i+1}` }));
                            console.log('serial_killer_slasher 数据加载成功：', itemData.serial_killer_slasher.first.length, itemData.serial_killer_slasher.last.length);
                        }
                    } catch (e) {
                        console.error('加载 serial_killer_slasher 失败', e);
                        itemData.serial_killer_slasher.first = [];
                        itemData.serial_killer_slasher.last = [];
                    }
                    
                    // 单独加载：茉德悬赏目标（from zones.json.maude_bounty_targets）
                    try {
                        if (cardsData.maude_bounty_targets) {
                            const areas = cardsData.maude_bounty_targets.areas || [];
                            const endpoints = cardsData.maude_bounty_targets.endpoints || [];
                            itemData.maude_bounty_targets.areas = areas.map((p, i) => ({ x: p[0], y: p[1], name: `悬赏区域 ${i+1}` }));
                            itemData.maude_bounty_targets.endpoints = endpoints.map((p, i) => ({ x: p[0], y: p[1], name: `悬赏终点 ${i+1}` }));
                            console.log('maude_bounty_targets 数据加载成功：', itemData.maude_bounty_targets.areas.length, '个区域，', itemData.maude_bounty_targets.endpoints.length, '个终点');
                        }
                    } catch (e) {
                        console.error('加载 maude_bounty_targets 失败', e);
                        itemData.maude_bounty_targets.areas = [];
                        itemData.maude_bounty_targets.endpoints = [];
                    }
                    
                    // 单独加载：媒体记忆棒（from zones.json.media_sticks）
                    try {
                        if (cardsData.media_sticks) {
                            itemData.media_sticks = cardsData.media_sticks.map((item, i) => ({
                                x: item[0],
                                y: item[1],
                                name: item[2] || `媒体记忆棒 ${i+1}`,
                                label: item[2] || `media_stick_${i+1}` // 保存标签信息用于弹窗匹配
                            }));
                            console.log('media_sticks 数据加载成功：', itemData.media_sticks.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 media_sticks 失败', e);
                        itemData.media_sticks = [];
                    }
                    
                    // 单独加载：藏匿屋（from zones.json.stash_houses）
                    try {
                        if (cardsData.stash_houses) {
                            itemData.stash_houses = cardsData.stash_houses.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `藏匿屋 ${i+1}`
                            }));
                            console.log('stash_houses 数据加载成功：', itemData.stash_houses.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 stash_houses 失败', e);
                        itemData.stash_houses = [];
                    }
                    
                    // 单独加载：玛德拉索雇凶（from zones.json.madrazo_hits）
                    try {
                        if (cardsData.madrazo_hits) {
                            itemData.madrazo_hits = cardsData.madrazo_hits.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `玛德拉索雇凶 ${i+1}`
                            }));
                            console.log('madrazo_hits 数据加载成功：', itemData.madrazo_hits.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 madrazo_hits 失败', e);
                        itemData.madrazo_hits = [];
                    }
                    
                    // 确保stunt_jumps数据被加载
                    try {
                        if (cardsData && cardsData.stunt_jumps) {
                            // 转换为需要的格式
                            itemData.stunt_jumps = cardsData.stunt_jumps.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `特技跳跃点 ${index + 1}`
                            }));
                            console.log(`stunt_jumps数据加载成功，共${itemData.stunt_jumps.length}个位置`);
                        } else {
                            console.error('加载stunt_jumps数据失败：未找到数据');
                            itemData.stunt_jumps = [];
                        }
                    } catch (error) {
                        console.error('加载stunt_jumps数据失败');
                        itemData.stunt_jumps = [];
                    }
                     
                    // 确保spray数据被加载
                    try {
                        if (cardsData && cardsData.spray_can) {
                            // 转换为需要的格式
                            itemData.spray = cardsData.spray_can.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `喷罐位置 ${index + 1}`
                            }));
                            console.log(`spray数据加载成功，共${itemData.spray.length}个位置`);
                        } else {
                            console.error('加载spray数据失败：未找到数据');
                            itemData.spray = [];
                        }
                    } catch (error) {
                        console.error('加载spray数据失败');
                        itemData.spray = [];
                    }
                    
                    // 额外加载：沉睡的保安（drunk_guard）
                    try {
                        if (cardsData && Array.isArray(cardsData.drunk_guard)) {
                            itemData.drunk_guard = cardsData.drunk_guard.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `沉睡的保安 ${index + 1}`
                            }));
                            console.log(`drunk_guard 数据加载成功，共${itemData.drunk_guard.length}个位置`);
                        }
                    } catch (error) {
                        console.error('加载drunk_guard数据失败');
                        itemData.drunk_guard = [];
                    }
                    
                    // 额外加载：金属探测器（metal_detector）
                    try {
                        if (cardsData && Array.isArray(cardsData.metal_detector)) {
                            itemData.metal_detector = cardsData.metal_detector.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `金属探测器 ${index + 1}`
                            }));
                            console.log(`metal_detector 数据加载成功（二次加载覆盖）：${itemData.metal_detector.length} 个位置`);
                        }
                    } catch (error) {
                        console.error('加载metal_detector数据失败');
                        itemData.metal_detector = [];
                    }

                    // 额外加载：走私贩飞机（smuggler_plane）
                    try {
                        if (cardsData && Array.isArray(cardsData.smuggler_plane)) {
                            itemData.smuggler_plane = cardsData.smuggler_plane.map((group, index) => ({
                                triggerpoint: group.triggerpoint,
                                routes: group.routes
                            }));
                            console.log(`smuggler_plane 数据加载成功：${itemData.smuggler_plane.length} 组`);
                        }
                    } catch (error) {
                        console.error('加载smuggler_plane数据失败');
                        itemData.smuggler_plane = [];
                    }
                    
                    // 额外加载：走私贩踪迹（smuggler_trail）
                    try {
                        if (cardsData && Array.isArray(cardsData.smuggler_trail)) {
                            itemData.smuggler_trail = cardsData.smuggler_trail.map((group, index) => ({
                                triggerpoint: group.triggerpoint,
                                routes: group.routes
                            }));
                            console.log(`smuggler_trail 数据加载成功：${itemData.smuggler_trail.length} 组`);
                        }
                    } catch (error) {
                        console.error('加载smuggler_trail数据失败');
                        itemData.smuggler_trail = [];
                    }
                    
                    // 额外加载：犯罪现场（crime_scenes）
                    try {
                        if (cardsData && Array.isArray(cardsData.crime_scenes)) {
                            itemData.crime_scenes = cardsData.crime_scenes.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `犯罪现场 ${index + 1}`
                            }));
                            console.log(`crime_scenes 数据加载成功：${itemData.crime_scenes.length} 个犯罪现场位置`);
                            console.log('crime_scenes 数据示例:', itemData.crime_scenes[0]);
                        } else {
                            console.log('crime_scenes 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载crime_scenes数据失败:', error);
                        itemData.crime_scenes = [];
                    }
                    
                    // 额外加载：UFO观光（ufo）
                    try {
                        if (cardsData && Array.isArray(cardsData.ufo)) {
                            itemData.ufo = cardsData.ufo.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `UFO观光 ${index + 1}`
                            }));
                            console.log(`ufo 数据加载成功：${itemData.ufo.length} 个UFO观光位置`);
                            console.log('ufo 数据示例:', itemData.ufo[0]);
                        } else {
                            console.log('ufo 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载ufo数据失败:', error);
                        itemData.ufo = [];
                    }
                    
                    // 额外加载：万圣节杀人狂（halloween_slashers）
                    try {
                        if (cardsData && cardsData.halloween_slashers && typeof cardsData.halloween_slashers === 'object') {
                            itemData.halloween_slashers = [];
                            Object.keys(cardsData.halloween_slashers).forEach(slasherType => {
                                const slasherData = cardsData.halloween_slashers[slasherType];
                                if (Array.isArray(slasherData)) {
                                    slasherData.forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 5) {
                                            itemData.halloween_slashers.push({
                                                x: item[0],
                                                y: item[1],
                                                radius: item[4],
                                                type: slasherType,
                                                name: `${slasherType} ${index + 1}`
                                            });
                                        }
                                    });
                                }
                            });
                            console.log(`halloween_slashers 数据加载成功：${itemData.halloween_slashers.length} 个万圣节杀人狂位置`);
                            console.log('halloween_slashers 数据示例:', itemData.halloween_slashers[0]);
                        } else {
                            console.log('halloween_slashers 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载halloween_slashers数据失败:', error);
                        itemData.halloween_slashers = [];
                    }
                    
                    // 额外加载：鬼上身的动物（possessed_animals）
                    try {
                        if (cardsData && cardsData.possessed_animals && typeof cardsData.possessed_animals === 'object') {
                            itemData.possessed_animals = [];
                            
                            // 加载areas数据（圆形区域）
                            if (cardsData.possessed_animals.areas && Array.isArray(cardsData.possessed_animals.areas)) {
                                cardsData.possessed_animals.areas.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 5) {
                                        // 从数据结构中正确提取动物类型
                                        // 数据结构：[x, y, [["animal_boar"]], [["boar"]], radius]
                                        const animalType = item[3] && item[3][0] ? item[3][0] : 'unknown';
                                        itemData.possessed_animals.push({
                                            x: item[0],
                                            y: item[1],
                                            radius: item[4],
                                            type: 'area',
                                            animalType: animalType,
                                            name: `${animalType} 区域 ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            // 加载spawns数据（具体位置）
                            if (cardsData.possessed_animals.spawns && typeof cardsData.possessed_animals.spawns === 'object') {
                                Object.keys(cardsData.possessed_animals.spawns).forEach(animalType => {
                                    const spawnData = cardsData.possessed_animals.spawns[animalType];
                                    if (Array.isArray(spawnData)) {
                                        spawnData.forEach((item, index) => {
                                            if (Array.isArray(item) && item.length >= 2) {
                                                // 从spawns数据结构中提取动物类型
                                                // 数据结构：[x, y, [["animal_boar"]], [["boar"]]]
                                                const extractedAnimalType = item[3] && item[3][0] ? item[3][0] : animalType;
                                                itemData.possessed_animals.push({
                                                    x: item[0],
                                                    y: item[1],
                                                    radius: 50, // 默认小半径用于spawns
                                                    type: 'spawn',
                                                    animalType: extractedAnimalType,
                                                    name: `${extractedAnimalType} 生成点 ${index + 1}`
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                            
                            console.log(`possessed_animals 数据加载成功：${itemData.possessed_animals.length} 个鬼上身动物位置`);
                            console.log('possessed_animals 数据示例:', itemData.possessed_animals[0]);
                        } else {
                            console.log('possessed_animals 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载possessed_animals数据失败:', error);
                        itemData.possessed_animals = [];
                    }
                    
                    // 额外加载：地狱犬（cerberus）
                    try {
                        if (cardsData && cardsData.cerberus && Array.isArray(cardsData.cerberus)) {
                            itemData.cerberus = cardsData.cerberus.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `地狱犬 ${index + 1}`
                            }));
                            console.log(`cerberus 数据加载成功：${itemData.cerberus.length} 个地狱犬位置`);
                        } else {
                            console.log('cerberus 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载cerberus数据失败:', error);
                        itemData.cerberus = [];
                    }
                    
                    // 额外加载：雪怪（yeti）
                    try {
                        if (cardsData && cardsData.yeti && typeof cardsData.yeti === 'object') {
                            itemData.yeti = [];
                            
                            // 加载area数据（雪怪区域）
                            if (cardsData.yeti.area && Array.isArray(cardsData.yeti.area)) {
                                cardsData.yeti.area.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 5) {
                                        itemData.yeti.push({
                                            x: item[0],
                                            y: item[1],
                                            radius: item[4],
                                            type: 'area',
                                            name: `雪怪区域 ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            // 加载clues数据（线索位置）
                            if (cardsData.yeti.clues && Array.isArray(cardsData.yeti.clues)) {
                                cardsData.yeti.clues.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 2) {
                                        itemData.yeti.push({
                                            x: item[0],
                                            y: item[1],
                                            type: 'clue',
                                            clueIndex: index + 1,
                                            name: `线索 ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            console.log(`yeti 数据加载成功：${itemData.yeti.length} 个雪怪相关位置`);
                            console.log('yeti 数据示例:', itemData.yeti[0]);
                        } else {
                            console.log('yeti 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载yeti数据失败:', error);
                        itemData.yeti = [];
                    }
                    
                    // 额外加载：社区边界（community_outreach）
                    try {
                        if (cardsData && Array.isArray(cardsData.community_outreach)) {
                            itemData.community_outreach = cardsData.community_outreach.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `社区边界 ${index + 1}`
                            }));
                            console.log(`community_outreach 数据加载成功：${itemData.community_outreach.length} 个社区边界位置`);
                            console.log('community_outreach 数据示例:', itemData.community_outreach[0]);
                        } else {
                            console.log('community_outreach 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载community_outreach数据失败:', error);
                        itemData.community_outreach = [];
                    }
                    
                    // 额外加载：外贸出口载具（exotic_exports1和exotic_exports2）
                    try {
                        // 从API获取外贸出口载具数据
                        const response = await fetch('https://api-gta.antwen.com/api/items/exotic-exports');
                        let vehicleList = [];
                        let apiData = null;
                        
                        if (response.ok) {
                            const apiResponse = await response.json();
                            if (apiResponse.success && apiResponse.data && apiResponse.data.message) {
                                // 解析车辆列表
                                vehicleList = apiResponse.data.message.trim().split('\n').filter(vehicle => vehicle.trim());
                                apiData = apiResponse.data;
                                console.log(`exotic_exports API数据加载成功：${vehicleList.length} 辆车辆`);
                                console.log('exotic_exports 车辆列表:', vehicleList);
                            } else {
                                console.log('exotic_exports API数据格式不正确');
                            }
                        } else {
                            console.log('exotic_exports API请求失败');
                        }
                        
                        // 从zones.json加载exotic_exports1坐标数据
                        if (cardsData && Array.isArray(cardsData.exotic_exports1)) {
                            itemData.exotic_exports1 = cardsData.exotic_exports1.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `外贸出口载具1 ${index + 1}`,
                                vehicleList: vehicleList,
                                apiData: apiData
                            }));
                            console.log(`exotic_exports1 坐标数据加载成功：${itemData.exotic_exports1.length} 个位置`);
                        } else {
                            console.log('exotic_exports1 坐标数据未找到或格式不正确');
                            itemData.exotic_exports1 = [];
                        }
                        
                        // 从zones.json加载exotic_exports2坐标数据
                        if (cardsData && Array.isArray(cardsData.exotic_exports2)) {
                            itemData.exotic_exports2 = cardsData.exotic_exports2.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `外贸出口载具2 ${index + 1}`,
                                vehicleList: vehicleList,
                                apiData: apiData
                            }));
                            console.log(`exotic_exports2 坐标数据加载成功：${itemData.exotic_exports2.length} 个位置`);
                        } else {
                            console.log('exotic_exports2 坐标数据未找到或格式不正确');
                            itemData.exotic_exports2 = [];
                        }
                    } catch (error) {
                        console.error('加载exotic_exports数据失败:', error);
                        itemData.exotic_exports1 = [];
                        itemData.exotic_exports2 = [];
                    }
                    
                    // 额外加载：商店抢劫（store_robbery）
                    try {
                        if (cardsData && Array.isArray(cardsData.store_robbery)) {
                            itemData.store_robbery = cardsData.store_robbery.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `商店抢劫 ${index + 1}`
                            }));
                            console.log(`store_robbery 数据加载成功：${itemData.store_robbery.length} 个商店抢劫位置`);
                            console.log('store_robbery 数据示例:', itemData.store_robbery[0]);
                        } else {
                            console.log('store_robbery 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载store_robbery数据失败:', error);
                        itemData.store_robbery = [];
                    }
                    
                    // 额外加载：车队（convoy）
                    try {
                        if (cardsData && Array.isArray(cardsData.convoy)) {
                            itemData.convoy = cardsData.convoy.map((convoy, index) => ({
                                triggerpoint: convoy.triggerpoint,
                                routes: convoy.routes,
                                name: `车队 ${index + 1}`
                            }));
                            console.log(`convoy 数据加载成功：${itemData.convoy.length} 个车队位置`);
                            console.log('convoy 数据示例:', itemData.convoy[0]);
                        } else {
                            console.log('convoy 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载convoy数据失败:', error);
                        itemData.convoy = [];
                    }
                    
                    // 额外加载：车队终点（convoy_final）
                    try {
                        if (cardsData && Array.isArray(cardsData.convoy_final)) {
                            itemData.convoy_final = cardsData.convoy_final.map((point, index) => ({
                                x: point[0],
                                y: point[1],
                                name: `车队终点 ${index + 1}`
                            }));
                            console.log(`convoy_final 数据加载成功：${itemData.convoy_final.length} 个车队终点位置`);
                            console.log('convoy_final 数据示例:', itemData.convoy_final[0]);
                        } else {
                            console.log('convoy_final 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载convoy_final数据失败:', error);
                        itemData.convoy_final = [];
                    }
                    
                    // 额外加载：装甲运钞车（armored_truck）
                    try {
                        if (cardsData && Array.isArray(cardsData.armored_truck)) {
                            itemData.armored_truck = cardsData.armored_truck.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `装甲运钞车 ${index + 1}`
                            }));
                            console.log(`armored_truck 数据加载成功：${itemData.armored_truck.length} 个装甲运钞车位置`);
                            console.log('armored_truck 数据示例:', itemData.armored_truck[0]);
                        } else {
                            console.log('armored_truck 数据未找到或格式不正确');
                        }
                    } catch (error) {
                        console.error('加载armored_truck数据失败:', error);
                        itemData.armored_truck = [];
                    }
                    
                    // 单独加载dead_drop数据（从zones.json）
                    try {
                        // 检查data是否存在且包含dead_drop数据
                        if (data && Array.isArray(data.dead_drop)) {
                            // 转换为需要的格式
                            itemData.dead_drop = data.dead_drop.map(item => ({
                                x: item.x,
                                y: item.y,
                                name: item.name || 'Dead Drop'
                            }));
                            console.log(`dead_drop数据加载成功，共${itemData.dead_drop.length}个位置`);
                        } else {
                            console.error('加载dead_drop数据失败：未找到数据');
                            itemData.dead_drop = [];
                        }
                    } catch (error) {
                        console.error('加载dead_drop数据失败');
                        itemData.dead_drop = [];
                    }
                    
                    // 加载电影道具数据
                    try {
                        if (cardsData.movie_props) {
                            const mp = cardsData.movie_props;
                            
                            // 加载固定位置
                            if (mp.fixed_position && Array.isArray(mp.fixed_position)) {
                                itemData.movie_props.fixed_position = mp.fixed_position.map(item => ({
                                    x: item[0],
                                    y: item[1],
                                    name: item[2] || '固定位置',
                                    type: 'fixed_position'
                                }));
                            }
                            
                            // 加载载具位置
                            if (mp.vehicles) {
                                if (mp.vehicles.pony && Array.isArray(mp.vehicles.pony)) {
                                    itemData.movie_props.vehicles.pony = mp.vehicles.pony.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Pony载具',
                                        type: 'pony'
                                    }));
                                }
                                if (mp.vehicles.rebel && Array.isArray(mp.vehicles.rebel)) {
                                    itemData.movie_props.vehicles.rebel = mp.vehicles.rebel.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rebel载具',
                                        type: 'rebel'
                                    }));
                                }
                                if (mp.vehicles.rumpo && Array.isArray(mp.vehicles.rumpo)) {
                                    itemData.movie_props.vehicles.rumpo = mp.vehicles.rumpo.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rumpo载具',
                                        type: 'rumpo'
                                    }));
                                }
                            }
                            
                            console.log('电影道具数据加载成功');
                            console.log('固定位置:', itemData.movie_props.fixed_position.length);
                            console.log('Pony载具:', itemData.movie_props.vehicles.pony.length);
                            console.log('Rebel载具:', itemData.movie_props.vehicles.rebel.length);
                            console.log('Rumpo载具:', itemData.movie_props.vehicles.rumpo.length);
                        } else {
                            console.error('加载电影道具数据失败：未找到数据');
                        }
                    } catch (error) {
                        console.error('加载电影道具数据失败:', error);
                    }
                    
                } catch (cardsError) {
                    console.warn('加载物品位置数据失败:', cardsError);
                    console.log('尝试加载的URL:', '../src/data/zones.json');
                }
                
                // 将itemData赋值给window.itemData，供计数器函数使用
                window.itemData = itemData;
                
                // 动态计算武器厢型车位置
                await updateGunVanLocation();
                
                // 动态获取街头毒贩位置
                await updateStreetDealersLocation();
                
                // 动态获取LS涂鸦位置
                await updateLSTagsLocation();
                
                // 动态获取隐藏包裹位置
                await updateHiddenCachesLocation();
                
                // 动态获取沉船位置
                await updateShipwreckedLocation();
                
                // 动态获取时间挑战赛位置
                await updateTimeTrialsLocation();
                
                // 动态获取跳伞位置
                await updateSkydivesLocation();
                
                console.log('物品数据加载成功');
                
                // 数据加载完成后更新所有计数器
                try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                try { updateStreetDealersSidebarCount(); } catch(e) {}
                try { updateSnowmenSidebarCount(); } catch(e) {}
                try { updateMoviePropsSidebarCount(); } catch(e) {}
                try { updateSpraySidebarCount(); } catch(e) {}
                try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                try { updateStuntJumpsSidebarCount(); } catch(e) {}
                try { updateYuanbaoSidebarCount(); } catch(e) {}
                try { updateSignalJammersSidebarCount(); } catch(e) {}
                try { updateActionFiguresSidebarCount(); } catch(e) {}
                try { updatePlayingCardsSidebarCount(); } catch(e) {}
                try { updateLetterScrapsSidebarCount(); } catch(e) {}
                try { updateJackOLanternsSidebarCount(); } catch(e) {}
                try { updateSpraySidebarCount(); } catch(e) {}
                try { updateOrganicFarmSidebarCount(); } catch(e) {}
                try { updateSkydivesSidebarCount(); } catch(e) {}
                try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                try { updateStashHousesSidebarCount(); } catch(e) {}
                try { updateLSTagsSidebarCount(); } catch(e) {}
                try { updateShipwreckedSidebarCount(); } catch(e) {}
                try { updateHiddenCachesSidebarCount(); } catch(e) {}
                try { updateSmokeProductSidebarCount(); } catch(e) {}
                try { updateDeadDropSidebarCount(); } catch(e) {}
                try { updateGunVanSidebarCount(); } catch(e) {}
                
                // 重新渲染侧边栏，确保计数器正确显示
                setTimeout(() => {
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                }, 200);
            } catch (error) {
                console.error('加载物品数据失败:', error);
            }
        }

        // 动态获取街头毒贩位置
        async function updateStreetDealersLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/street-dealers');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的街头毒贩坐标数据
                    itemData.street_dealers = result.data.coordinate;
                    // 同步更新window.itemData
                    if (window.itemData) {
                        window.itemData.street_dealers = result.data.coordinate;
                    }
                    console.log('街头毒贩位置获取成功，数据长度:', result.data.coordinate.length);
                    // 更新计数器
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                } else {
                    console.warn('街头毒贩API返回数据格式异常，使用静态数据');
                    // 确保有默认数据
                    if (!itemData.street_dealers || !Array.isArray(itemData.street_dealers)) {
                        itemData.street_dealers = [];
                    }
                    if (window.itemData && (!window.itemData.street_dealers || !Array.isArray(window.itemData.street_dealers))) {
                        window.itemData.street_dealers = [];
                    }
                }
            } catch (error) {
                console.warn('获取街头毒贩位置失败，使用静态数据:', error);
                // 确保有默认数据
                if (!itemData.street_dealers || !Array.isArray(itemData.street_dealers)) {
                    itemData.street_dealers = [];
                }
                if (window.itemData && (!window.itemData.street_dealers || !Array.isArray(window.itemData.street_dealers))) {
                    window.itemData.street_dealers = [];
                }
            }
        }

        // 动态获取LS涂鸦位置（通过API获取当天位置）
        async function updateLSTagsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/ls-tags');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的LS涂鸦坐标数据
                    itemData.ls_tags = result.data.coordinate;
                    
                    // 从message字段中提取涂鸦编号并添加到每个tag对象中（改进匹配，避免重复/误匹配）
                    if (result.data.message) {
                        const message = result.data.message;
                        // 捕获多词名称：直到换行或下一个#
                        const tagInfoRegex = /#(\d+)\s+([^\n#]+)/g;
                        /**
                         * 规范化名称：小写、移除标点、合并空白
                         */
                        const normalize = (s) => (s || '')
                            .toLowerCase()
                            .replace(/[^a-z0-9\u4e00-\u9fa5\s]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();

                        // 解析消息为列表，保留顺序，便于一对一分配
                        const tagInfoList = [];
                        let match;
                        while ((match = tagInfoRegex.exec(message)) !== null) {
                            const sequenceNumber = parseInt(match[1]);
                            const locationNameRaw = (match[2] || '').trim();
                            const locationNameNorm = normalize(locationNameRaw);
                            if (!Number.isNaN(sequenceNumber) && locationNameNorm) {
                                tagInfoList.push({ seq: sequenceNumber, nameRaw: locationNameRaw, nameNorm: locationNameNorm });
                            }
                        }

                        // 已分配的编号，避免重复
                        const assignedSeq = new Set();
                        const usedIndex = new Set();

                        // 为每个 tag 分配最合适的编号
                        itemData.ls_tags.forEach(tag => {
                            if (!tag || !tag.name) return;
                            const tagNameNorm = normalize(tag.name);
                            const tagWords = tagNameNorm.split(' ');
                            const lastWord = tagWords[tagWords.length - 1] || '';

                            let bestIdx = -1;
                            // 1) 优先：完整相等匹配
                            for (let i = 0; i < tagInfoList.length; i++) {
                                if (usedIndex.has(i)) continue;
                                const info = tagInfoList[i];
                                if (assignedSeq.has(info.seq)) continue;
                                if (tagNameNorm === info.nameNorm) { bestIdx = i; break; }
                            }
                            // 2) 次优：包含（以词边界近似）
                            if (bestIdx === -1) {
                                const paddedTag = ' ' + tagNameNorm + ' ';
                                for (let i = 0; i < tagInfoList.length; i++) {
                                    if (usedIndex.has(i)) continue;
                                    const info = tagInfoList[i];
                                    if (assignedSeq.has(info.seq)) continue;
                                    const paddedInfo = ' ' + info.nameNorm + ' ';
                                    if (paddedTag.includes(paddedInfo) || paddedInfo.includes(paddedTag)) { bestIdx = i; break; }
                                }
                            }
                            // 3) 备选：末尾词精确匹配
                            if (bestIdx === -1 && lastWord) {
                                for (let i = 0; i < tagInfoList.length; i++) {
                                    if (usedIndex.has(i)) continue;
                                    const info = tagInfoList[i];
                                    if (assignedSeq.has(info.seq)) continue;
                                    const infoWords = info.nameNorm.split(' ');
                                    const infoLast = infoWords[infoWords.length - 1] || '';
                                    if (lastWord && infoLast && lastWord === infoLast) { bestIdx = i; break; }
                                }
                            }

                            if (bestIdx !== -1) {
                                const info = tagInfoList[bestIdx];
                                tag.sequenceNumber = info.seq;
                                usedIndex.add(bestIdx);
                                assignedSeq.add(info.seq);
                            } else {
                                // 未匹配的，保持不赋值，避免错误编号
                                // 可选：tag.sequenceNumber = undefined;
                            }
                        });

                        // 调试输出：检测是否仍有重复
                        const seqCount = new Map();
                        (itemData.ls_tags || []).forEach(t => {
                            if (typeof t?.sequenceNumber === 'number') {
                                seqCount.set(t.sequenceNumber, (seqCount.get(t.sequenceNumber) || 0) + 1);
                            }
                        });
                        const duplicates = Array.from(seqCount.entries()).filter(([, c]) => c > 1).map(([k]) => k);
                        if (duplicates.length) {
                            console.warn('LS涂鸦编号存在重复：', duplicates);
                        } else {
                            console.log('LS涂鸦编号信息提取成功');
                        }
                    }
                    
                    console.log('LS涂鸦位置获取成功');
                } else {
                    console.warn('LS涂鸦API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取LS涂鸦位置失败，使用静态数据:', error);
            }
        }

        // 动态获取隐藏包裹位置（通过API获取当天位置）
        async function updateHiddenCachesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/hidden-caches');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的隐藏包裹坐标数据
                    itemData.hidden_caches = result.data.coordinate;
                    console.log('隐藏包裹位置获取成功');
                    // 更新计数器
                    try { updateHiddenCachesSidebarCount(); } catch(e) {}
                } else {
                    console.warn('隐藏包裹API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取隐藏包裹位置失败，使用静态数据:', error);
            }
        }

        // 动态获取沉船位置（通过API获取当天位置）
        async function updateShipwreckedLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/shipwrecked');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的沉船坐标数据
                    itemData.shipwrecked = result.data.coordinate;
                    // 保存API返回的消息用于提取沉船编号
                    itemData.shipwreckedMessage = result.data.message;
                    console.log('沉船位置获取成功');
                    // 更新计数器
                    try { updateShipwreckedSidebarCount(); } catch(e) {}
                } else {
                    console.warn('沉船API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取沉船位置失败，使用静态数据:', error);
            }
        }

        // 动态获取时间挑战赛位置（通过API获取当天位置）
        async function updateTimeTrialsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/time-trials');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的时间挑战赛坐标数据
                    const { rc_time_trial, bike_time_trial } = result.data.coordinate;
                    
                    // 设置RC时间挑战赛数据（仅一个位置）
                    if (rc_time_trial) {
                        itemData.rc_time_trial = [{
                            x: rc_time_trial.x,
                            y: rc_time_trial.y,
                            name: rc_time_trial.name,
                            time: rc_time_trial.time
                        }];
                        console.log('RC时间挑战赛位置获取成功');
                    } else {
                        itemData.rc_time_trial = [];
                    }
                    
                    // 设置自行车时间挑战赛数据（仅一个位置）
                    if (bike_time_trial) {
                        itemData.bike_time_trial = [{
                            x: bike_time_trial.x,
                            y: bike_time_trial.y,
                            name: bike_time_trial.name,
                            time: bike_time_trial.time
                        }];
                        console.log('自行车时间挑战赛位置获取成功');
                    } else {
                        itemData.bike_time_trial = [];
                    }
                    
                    // 保存API返回的消息用于显示
                    itemData.timeTrialsMessage = result.data.message;
                    
                } else {
                    console.warn('时间挑战赛API返回数据格式异常，使用静态数据');
                    itemData.rc_time_trial = [];
                    itemData.bike_time_trial = [];
                }
            } catch (error) {
                console.warn('获取时间挑战赛位置失败，使用静态数据:', error);
                itemData.rc_time_trial = [];
                itemData.bike_time_trial = [];
            }
        }

        // 动态获取跳伞位置（通过API获取当天位置）
        async function updateSkydivesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/skydives');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的跳伞坐标数据
                    itemData.skydives = result.data.coordinate;
                    console.log('跳伞位置获取成功');
                } else {
                    console.warn('跳伞API返回数据格式异常，使用静态数据');
                    // 使用zones.json中的静态数据作为备用
                    const zonesResponse = await fetch('../src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                }
            } catch (error) {
                console.warn('获取跳伞位置失败，使用静态数据:', error);
                try {
                    // 使用zones.json中的静态数据作为备用
                    const zonesResponse = await fetch('../src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                } catch (fallbackError) {
                    console.error('加载静态跳伞数据也失败:', fallbackError);
                    itemData.skydives = [];
                }
            }
        }



        // 动态计算武器厢型车位置
        async function updateGunVanLocation() {
            const currentDay = Math.floor(Date.now() / 86400000); // 每天变化
            
            if (gunVanLastUpdate !== currentDay) {
                gunVanLastUpdate = currentDay;
                
                // 模拟游戏中的随机数生成逻辑
                const seed = getSeedValue();
                const location = getRandomGunVanLocation(seed);
                
                // 只保留当天的位置
                if (itemData.gun_van && itemData.gun_van.length > 0) {
                    itemData.gun_van = [itemData.gun_van[location]];
                }
                
                console.log(`武器厢型车今日位置: ${location + 1}`);
            }
        }

        // 模拟游戏中的种子值计算
        function getSeedValue() {
            const cloudTime = BigInt(Math.floor(Date.now() / 1000));
            return (cloudTime - 21600n) / 86400n;
        }

        // 模拟游戏中的随机位置选择（使用正确的RNG算法）
        function getRandomGunVanLocation(seed) {
            const DISABLED_LOCATION = 4;
            
            // 使用游戏中的随机数生成算法
            class GameRNG {
                constructor(seed) {
                    this.mask = (2n ** 32n - 1n);
                    this.magicNumber = 1557985959n;
                    const rolval = ((seed << 16n) & this.mask) | ((seed >> 16n) & this.mask);
                    this.seed0 = seed || 1n;
                    this.seed1 = seed ^ rolval;
                }
                
                nextSeed() {
                    const next_seed = this.magicNumber * this.seed0 + this.seed1;
                    this.seed0 = next_seed & BigInt(0xFFFFFFFF);
                    this.seed1 = next_seed >> 32n;
                    return next_seed;
                }
                
                getRandomInt(min, max) {
                    if (min === max) return Number(min);
                    if (min >= max) return 0;
                    const next_seed = this.nextSeed();
                    return Number(min + (next_seed & BigInt(0x7FFFFFFF)) % (max - min + 1n));
                }
            }
            
            const rng = new GameRNG(seed);
            let location = rng.getRandomInt(0n, 29n);
            
            // 跳过禁用位置
            while (location === DISABLED_LOCATION) {
                location = rng.getRandomInt(0n, 29n);
            }
            
            return location;
        }

        // 创建走私标记的Leaflet版本（特殊处理）
        function createSmugglerLeafletMarkers(type) {
            const groups = itemData[type] || [];
            const z = map.getZoom();
            
            // 初始化组标记存储
            if (!window.smugglerGroupMarkers) {
                window.smugglerGroupMarkers = {};
            }
            if (!window.smugglerGroupMarkers[type]) {
                window.smugglerGroupMarkers[type] = [];
            }
            
            groups.forEach((group, gIndex) => {
                // 为每个组创建标记数组
                const groupMarkers = [];
                const tp = group.triggerpoint; // [x, y]
                const routes = Array.isArray(group.routes) ? group.routes : [];
                
                if (Array.isArray(tp) && tp.length === 2) {
                    // 创建触发点标记
                    const pixel = gameToPixel(tp[0], tp[1], z);
                    const latlng = map.unproject(L.point(pixel.x, pixel.y), z);
                    
                    const iconUrl = type === 'smuggler_plane' ? '../src/assets/smuggler_plane.svg' : '../src/assets/smuggler_trail.svg';
                    const customIcon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14],
                        popupAnchor: [0, -14]
                    });
                    
                    const triggerMarker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    // 为走私贩飞机标记添加CSS类名，用于隐藏/显示功能
                    if (type === 'smuggler_plane') {
                        triggerMarker.getElement().classList.add('smuggler-plane-marker');
                    }
                    
                    // 添加点击事件
                    triggerMarker.on('click', function(e) {
                        if (type === 'smuggler_plane') {
                            showSmugglerPlanePopup(group, gIndex);
                        } else {
                            showSmugglerTrailPopup(group, gIndex);
                        }
                    });
                    
                    leafletMarkers.push(triggerMarker);
                    groupMarkers.push(triggerMarker); // 添加到组标记数组
                    
                    // 创建路线标记和连接线
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            
                            const routePixel = gameToPixel(rx, ry, z);
                            const routeLatlng = map.unproject(L.point(routePixel.x, routePixel.y), z);
                            
                            // 创建路线点标记（数字标记）
                            const routeIcon = L.divIcon({
                                html: `<div style="
                                    width: 24px; 
                                    height: 24px; 
                                    border-radius: 50%; 
                                    background-color: #2196F3; 
                                    border: 2px solid #fff; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    font-weight: bold; 
                                    color: #fff;
                                ">${rIndex + 1}</div>`,
                                className: 'custom-div-icon',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            const routeMarker = L.marker(routeLatlng, {
                                icon: routeIcon,
                                interactive: true,
                                zIndexOffset: 1000
                            }).addTo(map);
                            
                            // 为走私贩飞机路线标记添加CSS类名，用于隐藏/显示功能
                            if (type === 'smuggler_plane') {
                                routeMarker.getElement().classList.add('smuggler-plane-marker');
                            }
                            
                            // 添加点击事件
                            routeMarker.on('click', function(e) {
                                if (type === 'smuggler_plane') {
                                    showSmugglerPlanePopup(group, gIndex);
                                } else {
                                    showSmugglerTrailPopup(group, gIndex);
                                }
                            });
                            
                            leafletMarkers.push(routeMarker);
                            groupMarkers.push(routeMarker); // 添加到组标记数组
                            
                            // 创建连接线
                            const line = L.polyline([latlng, routeLatlng], {
                                color: '#ff0000',
                                weight: 2,
                                opacity: 0.8,
                                interactive: false
                            }).addTo(map);
                            
                            leafletMarkers.push(line);
                            groupMarkers.push(line); // 添加到组标记数组
                        }
                    });
                }
                
                // 将组标记数组存储到全局变量中
                window.smugglerGroupMarkers[type][gIndex] = groupMarkers;
            });
        }

        // 创建Leaflet标记（试点函数）
        function createLeafletMarker(item, index, type) {
            const z = map.getZoom();
            const pixel = gameToPixel(item.x, item.y, z);
            const latlng = map.unproject(L.point(pixel.x, pixel.y), z);
            
            // 特殊处理serial_killer_slasher - first/last 用不同图标
            if (type === 'serial_killer_slasher') {
                const iconUrl = (item && item.subtype === 'last') ? '../src/assets/slasher2.svg' : '../src/assets/slasher.svg';
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                marker.on('click', function(e) {
                    const firstCount = itemData.serial_killer_slasher?.first?.length || 0;
                    const isFirst = item && item.subtype !== 'last';
                    const displayIndex = index;
                    showSlasherPopup(item, displayIndex, isFirst ? 'first' : 'last');
                });
                
                // 存储标记到全局数组
                if (!window.slasherMarkers) window.slasherMarkers = [];
                window.slasherMarkers[index] = marker;
                
                return marker;
            }

            // 特殊处理 epsilon_tracts - 传单图标（带序号）
            if (type === 'epsilon_tracts') {
                const sequenceNumber = index + 1;

                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                            <img src="../src/assets/epsilon_tracts.svg" style="width: 32px; height: 32px;" />
                            <div style="
                                position: absolute;
                                top: 34px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                padding: 2px 6px;
                                border-radius: 10px;
                                min-width: 16px;
                                text-align: center;
                                border: 1px solid #fff;
                            ">${sequenceNumber}</div>
                        </div>
                    `,
                    className: 'epsilon-tracts-marker',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showEpsilonTractsPopup(item, index);
                });

                // 记录 epsilon_tracts 标记
                if (!window.epsilonTractsMarkers) window.epsilonTractsMarkers = [];
                window.epsilonTractsMarkers[index] = marker;

                return marker;
            }

            // 特殊处理 murder_mystery_message - 图标叠加数字徽章（显示组号 1/2/3）
            if (type === 'murder_mystery_message') {
                const badge = (item && item.group) ? String(item.group) : '?';
                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: inline-block;">
                          <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                          <div style="position: absolute; right: -6px; top: -6px; background: #E53935; color: #fff; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.6);">${badge}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', function(e) {
                    showMurderMysteryMessageImage(index);
                });

                // 记录谋杀之谜信息标记（用于隐藏/显示控制与可见性缓存）
                try {
                    if (!window.murderMysteryMessageMarkers) window.murderMysteryMessageMarkers = [];
                    window.murderMysteryMessageMarkers[index] = marker;
                } catch (e) {}

                return marker;
            }

            // 特殊处理media_sticks - 带文字标签
            if (type === 'media_sticks') {
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${item.name || `媒体记忆棒 ${index+1}`}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showMediaStickPopup(item, index);
                });
                
                // 记录媒体记忆棒标记（用于隐藏/显示）
                try {
                    if (!window.mediaStickMarkers) window.mediaStickMarkers = [];
                    window.mediaStickMarkers[index] = marker;
                } catch (e) {}
                
                return marker;
            }
            
            // 特殊处理police_rescue_patrick_mcreary - 需要处理spawn和dropoff
            if (type === 'police_rescue_patrick_mcreary') {
                // 这里需要根据item的子类型来决定图标
                let iconUrl = itemIcons[type]; // 默认图标
                if (item.subtype === 'dropoff') {
                    iconUrl = '../src/assets/patrick_drop.svg'; // 黄色图标
                }
                
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('点击帕特里克救援标记:', item, index, item.subtype);
                    showPatrickRescuePopup(item, index, item.subtype || 'spawn');
                });
                
                return marker;
            }
            
            // 特殊处理convoy - 车队标记（不包含路线，路线需要单独处理）
            if (type === 'convoy') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showConvoyPopup(item, index);
                });
                
                return marker;
            }
            
            // 特殊处理convoy_final - 车队终点标记
            if (type === 'convoy_final') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showConvoyFinalPopup(item, index);
                });
                
                return marker;
            }
            
            // 特殊处理random_missions - 随机任务标记（带时间段标签）
            if (type === 'random_missions') {
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${item.timeSlot || '未知时间'}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('点击随机任务标记:', item, index, item.timeSlot, item.missionIndex);
                    // 构造完整的任务数据数组
                    const missionData = [item.x, item.y, item.taskName || '未知任务', [item.level || 1, item.players || 1, item.timeRange || '全天']];
                    showRandomMissionPopup(missionData, item.timeSlot, item.missionIndex);
                });
                
                return marker;
            }
            
            // 特殊处理treasure_hunt_dba_revolver - 区分随机/固定图标
            if (type === 'treasure_hunt_dba_revolver') {
                const isRandom = item && item.subtype === 'random';
                const iconUrl = isRandom ? '../src/assets/th1.svg' : '../src/assets/th2.svg';
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    const mode = isRandom ? 'random' : 'static';
                    showTreasureHuntPopup(item, index, mode);
                });
                
                return marker;
            }
            
            // 特殊处理exotic_exports1 - 外贸出口载具1（显示车辆信息）
            if (type === 'exotic_exports1') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showExoticExportsPopup(item, 'exotic_exports1', index);
                });
                
                return marker;
            }
            
            // 特殊处理exotic_exports2 - 外贸出口载具2（显示车辆信息）
            if (type === 'exotic_exports2') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showExoticExportsPopup(item, 'exotic_exports2', index);
                });
                
                return marker;
            }
            
            // 特殊处理happy_holidays_hauler - 节日快乐卡车（triggerpoint标记）
            if (type === 'happy_holidays_hauler') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showHappyHolidaysHaulerPopup(item, index);
                });
                
                return marker;
            }
            
            // 特殊处理wea - 威泽尔大楼枪战
            if (type === 'wea') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showItemInfo(item, type, index);
                });
                
                return marker;
            }
            
            // 特殊处理movie_props - 不同子类型不同图标
            if (type === 'movie_props') {
                let iconUrl = '../src/assets/mp_static.svg';
                if (item && item.type === 'pony') {
                    iconUrl = '../src/assets/mp_pony.svg';
                } else if (item && item.type === 'rebel') {
                    iconUrl = '../src/assets/mp_rebel.svg';
                } else if (item && item.type === 'rumpo') {
                    iconUrl = '../src/assets/mp_rumpo.svg';
                } else if (item && item.type === 'fixed_position') {
                    iconUrl = '../src/assets/mp_static.svg';
                }
                
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    // 优先使用数据里的子类型
                    let subtype = item && item.type ? item.type : undefined;
                    if (!subtype) {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        const fixedCount = mp.fixed_position?.length || 0;
                        const ponyCount = mp.vehicles?.pony?.length || 0;
                        const rebelCount = mp.vehicles?.rebel?.length || 0;
                        if (index < fixedCount) subtype = 'fixed_position';
                        else if (index < fixedCount + ponyCount) subtype = 'pony';
                        else if (index < fixedCount + ponyCount + rebelCount) subtype = 'rebel';
                        else subtype = 'rumpo';
                    }
                    showMoviePropsPopup(item, index, subtype);
                });
                
                // 记录 movie_props 标记以便弹窗隐藏/显示控制与可见性缓存
                if (!window.moviePropsMarkers) window.moviePropsMarkers = [];
                window.moviePropsMarkers[index] = marker;
                
                return marker;
            }
            
            // 特殊处理halloween_slashers - 万圣节杀人狂圆形区域
            if (type === 'halloween_slashers') {
                // 计算圆形半径（使用像素坐标，与原DOM实现一致）
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const radiusPixels = (item.radius / gameWidth) * totalWidth;
                
                // 使用circleMarker而不是circle，以像素为单位
                const circle = L.circleMarker(latlng, {
                    color: getSlasherColor(item.type).border,
                    fillColor: getSlasherColor(item.type).fill,
                    fillOpacity: 0.3,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // 在圆心添加图标
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // 为圆形和图标都添加点击事件
                const clickHandler = function(e) {
                    showHalloweenSlasherPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // 返回一个包含圆形和图标的组合对象
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // 保存item数据用于缩放时更新半径
                    type: type, // 保存标记类型用于半径更新
                    // 实现与单个marker相同的接口
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // 特殊处理possessed_animals - 鬼上身动物圆形区域
            if (type === 'possessed_animals') {
                // 计算圆形半径（使用像素坐标，与原DOM实现一致）
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const radiusPixels = (item.radius / gameWidth) * totalWidth;
                
                // 使用circleMarker而不是circle，以像素为单位
                const circle = L.circleMarker(latlng, {
                    color: getPossessedAnimalColor(item.animalType).border,
                    fillColor: getPossessedAnimalColor(item.animalType).fill,
                    fillOpacity: 0.3,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // 在圆心添加图标
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // 为圆形和图标都添加点击事件
                const clickHandler = function(e) {
                    showPossessedAnimalPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // 返回一个包含圆形和图标的组合对象
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // 保存item数据用于缩放时更新半径
                    type: type, // 保存标记类型用于半径更新
                    // 实现与单个marker相同的接口
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // 特殊处理yeti - 雪怪（圆形区域和线索点）
            if (type === 'yeti') {
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                if (item.type === 'area') {
                    // 处理雪怪区域（白色圆圈）
                    const totalWidth = level.cols * TILE_SIZE;
                    const gameWidth = GAME_RIGHT - GAME_LEFT;
                    const radiusPixels = (item.radius / gameWidth) * totalWidth;
                    
                    const circle = L.circleMarker(latlng, {
                        color: '#FFFFFF',
                        fillColor: 'rgba(255, 255, 255, 0.1)',
                        fillOpacity: 0.3,
                        weight: 3,
                        radius: radiusPixels,
                        interactive: true
                    }).addTo(map);
                    
                    // 雪怪区域只显示圆圈，不显示图标
                    const clickHandler = function(e) {
                        showYetiPopup(item, index);
                    };
                    
                    circle.on('click', clickHandler);
                    
                    return {
                        circle: circle,
                        icon: null,
                        item: item,
                        type: type, // 保存标记类型用于半径更新
                        addTo: function(map) { return this; },
                        removeFrom: function(map) {
                            map.removeLayer(this.circle);
                            return this;
                        }
                    };
                } else if (item.type === 'clue') {
                    // 处理线索点（what.svg图标）
                    const customIcon = L.icon({
                        iconUrl: '../src/assets/what.svg',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    const marker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    marker.on('click', function(e) {
                        showYetiPopup(item, index);
                    });
                    
                    return marker;
                }
            }
            
            // 特殊处理maude_bounty_targets - 茉德悬赏目标
            if (type === 'maude_bounty_targets') {
                if (item.subtype === 'area') {
                    // 悬赏区域：黄色圆圈，半径185游戏单位
                    const level = getLevelByZoom(z);
                    if (!level) return null;
                    
                    const totalWidth = level.cols * TILE_SIZE;
                    const gameWidth = GAME_RIGHT - GAME_LEFT;
                    const bountyRadius = 185; // 固定半径185游戏单位
                    const radiusPixels = (bountyRadius / gameWidth) * totalWidth;
                    
                    // 创建黄色圆圈
                    const circle = L.circleMarker(latlng, {
                        color: '#FFD700', // 金黄色边框
                        fillColor: '#FFD700',
                        fillOpacity: 0.2,
                        weight: 3,
                        radius: radiusPixels,
                        interactive: true
                    }).addTo(map);
                    
                    // 添加点击事件
                    circle.on('click', function(e) {
                        showMaudeBountyPopup(item, index, 'area');
                    });
                    
                    return {
                        circle: circle,
                        icon: null,
                        item: { ...item, radius: bountyRadius }, // 添加半径信息用于缩放更新
                        addTo: function(map) { return this; },
                        removeFrom: function(map) {
                            map.removeLayer(this.circle);
                            return this;
                        }
                    };
                } else if (item.subtype === 'endpoint') {
                    // 悬赏终点：黄色小叉号
                    const customIcon = L.divIcon({
                        html: `
                            <div style="width: 16px; height: 16px; position: relative;">
                                <div style="position: absolute; top: 50%; left: 50%; width: 12px; height: 2px; background: #FFD700; transform: translate(-50%, -50%) rotate(45deg);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; width: 12px; height: 2px; background: #FFD700; transform: translate(-50%, -50%) rotate(-45deg);"></div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -8]
                    });
                    
                    const marker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1001
                    }).addTo(map);
                    
                    marker.on('click', function(e) {
                        showMaudeBountyPopup(item, index, 'endpoint');
                    });
                    
                    return marker;
                }
            }
            
            // 特殊处理gang_attacks - 帮派攻击圆形区域
            if (type === 'gang_attacks') {
                // 检查时间是否匹配
                if (!isGangAttackActive(item.time)) {
                    return null; // 不在时间范围内，不显示
                }
                
                // 计算圆形半径（固定100游戏单位）
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const gameRadius = 100; // 游戏坐标半径
                const radiusPixels = (gameRadius / gameWidth) * totalWidth;
                
                // 使用circleMarker创建固定像素大小的圆形
                const circle = L.circleMarker(latlng, {
                    color: '#FF0000',
                    fillColor: '#FF0000',
                    fillOpacity: 0.1,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // 在圆心添加图标
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // 为圆形和图标都添加点击事件
                const clickHandler = function(e) {
                    showGangAttackPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // 返回一个包含圆形和图标的组合对象
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // 保存item数据用于缩放时更新半径
                    type: type, // 保存标记类型用于半径更新
                    // 实现与单个marker相同的接口
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // 特殊处理ghosts3 - 幽灵曝光（最后一个用不同图标 + 时间标签）
            if (type === 'ghosts3') {
                // 检查是否为最后一个标记
                const isLast = index === (itemData[type]?.length ?? 0) - 1;
                const iconUrl = isLast ? '../src/assets/ge252.svg' : '../src/assets/ge251.svg';
                
                // 使用divIcon创建包含时间标签的复合标记
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center; position: relative;">
                            <img src="${iconUrl}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); pointer-events: none;">${item.time || '未知时间'}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showGhosts3Popup(item, index);
                });
                
                return marker;
            }
            
            // 特殊处理 assuming_the_truth - 车/摩托动态图标（双T 用摩托）
            if (type === 'assuming_the_truth') {
                const isBike = (item && item.name === '双T');
                const iconUrl = isBike
                    ? '../src/assets/assuming_the_truth_bike.svg'
                    : '../src/assets/assuming_the_truth_car.svg';

                const customIcon = L.icon({
                    iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showAssumingTheTruthPopup(item, index);
                });

                // 记录 assuming_the_truth 标记
                if (!window.assumingTheTruthMarkers) window.assumingTheTruthMarkers = [];
                window.assumingTheTruthMarkers[index] = marker;

                return marker;
            }
            
            // 特殊处理 chasing_the_truth - 神器图标（带序号）
            if (type === 'chasing_the_truth') {
                const sequenceNumber = index + 1;
                
                // 使用 divIcon 来同时显示图标和序号
                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                            <img src="../src/assets/chasing_the_truth.svg" style="width: 32px; height: 32px;" />
                            <div style="
                                position: absolute;
                                top: 34px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                padding: 2px 6px;
                                border-radius: 10px;
                                min-width: 16px;
                                text-align: center;
                                border: 1px solid #fff;
                            ">${sequenceNumber}</div>
                        </div>
                    `,
                    className: 'chasing-the-truth-marker',
                    iconSize: [32, 50], // 增加高度以容纳序号
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showChasingTheTruthPopup(item, index);
                });

                // 记录 chasing_the_truth 标记
                if (!window.chasingTheTruthMarkers) window.chasingTheTruthMarkers = [];
                window.chasingTheTruthMarkers[index] = marker;

                return marker;
            }
            
            // 特殊处理cerberus - 地狱犬（只显示图标，无圆圈）
            if (type === 'cerberus') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('点击万圣节地狱犬事件标记:', item, index);
                    showCerberusPopup(item, index);
                });
                
                return marker;
            }
            
            // 创建自定义图标
            const customIcon = L.icon({
                iconUrl: itemIcons[type],
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
            
            // 创建Leaflet标记
            const marker = L.marker(latlng, {
                icon: customIcon,
                interactive: true,
                zIndexOffset: 1000
            }).addTo(map);
            
            // 记录 gun_van 标记以便弹窗隐藏/显示控制
            try {
                if (type === 'gun_van') {
                    if (!window.gunVanMarkers) window.gunVanMarkers = [];
                    window.gunVanMarkers[index] = marker;
                }
                // 记录 street_dealers 标记以便弹窗隐藏/显示控制
                else if (type === 'street_dealers') {
                    if (!window.streetDealersMarkers) window.streetDealersMarkers = [];
                    window.streetDealersMarkers[index] = marker;
                }
                // 记录 media_sticks 标记以便弹窗隐藏/显示控制
                else if (type === 'media_sticks') {
                    if (!window.mediaStickMarkers) window.mediaStickMarkers = [];
                    window.mediaStickMarkers[index] = marker;
                }
                // 记录 movie_props 标记以便弹窗隐藏/显示控制
                else if (type === 'movie_props') {
                    if (!window.moviePropsMarkers) window.moviePropsMarkers = [];
                    window.moviePropsMarkers[index] = marker;
                }
                // 记录 ld_organics_products 标记以便弹窗隐藏/显示控制
                else if (type === 'ld_organics_products') {
                    if (!window.organicFarmMarkers) window.organicFarmMarkers = [];
                    window.organicFarmMarkers[index] = marker;
                }
                // 记录 action_figures 标记以便弹窗隐藏/显示控制
                else if (type === 'action_figures') {
                    if (!window.actionFiguresMarkers) window.actionFiguresMarkers = [];
                    window.actionFiguresMarkers[index] = marker;
                }
                // 记录 playing_cards 标记以便弹窗隐藏/显示控制
                else if (type === 'playing_cards') {
                    if (!window.playingCardsMarkers) window.playingCardsMarkers = [];
                    window.playingCardsMarkers[index] = marker;
                }
                // 记录 letter_scraps 标记以便弹窗隐藏/显示控制
                else if (type === 'letter_scraps') {
                    if (!window.letterScrapsMarkers) window.letterScrapsMarkers = [];
                    window.letterScrapsMarkers[index] = marker;
                }
                // 记录 sp_hidden_packages 标记以便弹窗隐藏/显示控制
                else if (type === 'sp_hidden_packages') {
                    if (!window.spHiddenPackagesMarkers) window.spHiddenPackagesMarkers = [];
                    window.spHiddenPackagesMarkers[index] = marker;
                }
                // 记录 peyote_sp_land 标记以便弹窗隐藏/显示控制
                else if (type === 'peyote_sp_land') {
                    if (!window.peyoteSpLandMarkers) window.peyoteSpLandMarkers = [];
                    window.peyoteSpLandMarkers[index] = marker;
                }
                // 记录 peyote_sp_air 标记以便弹窗隐藏/显示控制
                else if (type === 'peyote_sp_air') {
                    if (!window.peyoteSpAirMarkers) window.peyoteSpAirMarkers = [];
                    window.peyoteSpAirMarkers[index] = marker;
                }
                // 记录 peyote_sp_water 标记以便弹窗隐藏/显示控制
                else if (type === 'peyote_sp_water') {
                    if (!window.peyoteSpWaterMarkers) window.peyoteSpWaterMarkers = [];
                    window.peyoteSpWaterMarkers[index] = marker;
                }
                // 记录 peyote_sp_special 标记以便弹窗隐藏/显示控制
                else if (type === 'peyote_sp_special') {
                    if (!window.peyoteSpSpecialMarkers) window.peyoteSpSpecialMarkers = [];
                    window.peyoteSpSpecialMarkers[index] = marker;
                }
                // 记录 submarine_pieces 标记以便弹窗隐藏/显示控制
                else if (type === 'submarine_pieces') {
                    if (!window.submarinePiecesMarkers) window.submarinePiecesMarkers = [];
                    window.submarinePiecesMarkers[index] = marker;
                }
                // 记录 spaceship_parts 标记以便弹窗隐藏/显示控制
                else if (type === 'spaceship_parts') {
                    if (!window.spaceshipPartsMarkers) window.spaceshipPartsMarkers = [];
                    window.spaceshipPartsMarkers[index] = marker;
                }
                // 记录 nuclear_waste 标记以便弹窗隐藏/显示控制
                else if (type === 'nuclear_waste') {
                    if (!window.nuclearWasteMarkers) window.nuclearWasteMarkers = [];
                    window.nuclearWasteMarkers[index] = marker;
                }
                // 记录 humans_of_ls 标记以便弹窗隐藏/显示控制
                else if (type === 'humans_of_ls') {
                    if (!window.humansOfLsMarkers) window.humansOfLsMarkers = [];
                    window.humansOfLsMarkers[index] = marker;
                }
                // 记录 monkey_mosaics 标记以便弹窗隐藏/显示控制
                else if (type === 'monkey_mosaics') {
                    if (!window.monkeyMosaicsMarkers) window.monkeyMosaicsMarkers = [];
                    window.monkeyMosaicsMarkers[index] = marker;
                }
                // 记录 skydives 标记以便弹窗隐藏/显示控制
                else if (type === 'skydives') {
                    if (!window.skydivesMarkers) window.skydivesMarkers = [];
                    window.skydivesMarkers[index] = marker;
                }
                // 记录 madrazo_hits 标记以便弹窗隐藏/显示控制
                else if (type === 'madrazo_hits') {
                    if (!window.madrazoHitsMarkers) window.madrazoHitsMarkers = [];
                    window.madrazoHitsMarkers[index] = marker;
                }
                // 记录 ls_tags 标记以便弹窗隐藏/显示控制
                else if (type === 'ls_tags') {
                    if (!window.lsTagsMarkers) window.lsTagsMarkers = [];
                    window.lsTagsMarkers[index] = marker;
                }
                // 记录 shipwrecked 标记以便弹窗隐藏/显示控制
                else if (type === 'shipwrecked') {
                    if (!window.shipwreckedMarkers) window.shipwreckedMarkers = [];
                    window.shipwreckedMarkers[index] = marker;
                }
                // 记录 hidden_caches 标记以便弹窗隐藏/显示控制
                else if (type === 'hidden_caches') {
                    if (!window.hiddenCachesMarkers) window.hiddenCachesMarkers = [];
                    window.hiddenCachesMarkers[index] = marker;
                }
                // 记录 smoke_on_the_water_product 标记以便弹窗隐藏/显示控制
                else if (type === 'smoke_on_the_water_product') {
                    if (!window.smokeProductMarkers) window.smokeProductMarkers = [];
                    window.smokeProductMarkers[index] = marker;
                }
                // 记录 rc_time_trial 标记以便弹窗隐藏/显示控制
                else if (type === 'rc_time_trial') {
                    if (!window.rcTimeTrialMarkers) window.rcTimeTrialMarkers = [];
                    window.rcTimeTrialMarkers[index] = marker;
                }
                // 记录 bike_time_trial 标记以便弹窗隐藏/显示控制
                else if (type === 'bike_time_trial') {
                    if (!window.bikeTimeTrialMarkers) window.bikeTimeTrialMarkers = [];
                    window.bikeTimeTrialMarkers[index] = marker;
                }
                // 记录 signal_jammers 标记以便弹窗隐藏/显示控制
                else if (type === 'signal_jammers') {
                    if (!window.signalJammersMarkers) window.signalJammersMarkers = [];
                    window.signalJammersMarkers[index] = marker;
                }
                // 记录 jack_o_lanterns 标记以便弹窗隐藏/显示控制
                else if (type === 'jack_o_lanterns') {
                    if (!window.jackOLanternMarkers) window.jackOLanternMarkers = [];
                    window.jackOLanternMarkers[index] = marker;
                }
                // 记录 snowmen 标记以便弹窗隐藏/显示控制
                else if (type === 'snowmen') {
                    if (!window.snowmenMarkers) window.snowmenMarkers = [];
                    window.snowmenMarkers[index] = marker;
                }
                // 记录 yuanbao 标记以便弹窗隐藏/显示控制
                else if (type === 'yuanbao') {
                    if (!window.yuanbaoMarkers) window.yuanbaoMarkers = [];
                    window.yuanbaoMarkers[index] = marker;
                }
                // 记录 stunt_jumps 标记以便弹窗隐藏/显示控制
                else if (type === 'stunt_jumps') {
                    if (!window.stuntJumpsMarkers) window.stuntJumpsMarkers = [];
                    window.stuntJumpsMarkers[index] = marker;
                }
                // 记录 ppl 标记以便弹窗隐藏/显示控制
                else if (type === 'ppl') {
                    if (!window.pplMarkers) window.pplMarkers = [];
                    window.pplMarkers[index] = marker;
                }
                // 记录 ppw 标记以便弹窗隐藏/显示控制
                else if (type === 'ppw') {
                    if (!window.ppwMarkers) window.ppwMarkers = [];
                    window.ppwMarkers[index] = marker;
                }
                // 记录 spray 标记以便弹窗隐藏/显示控制
                else if (type === 'spray') {
                    if (!window.sprayMarkers) window.sprayMarkers = [];
                    window.sprayMarkers[index] = marker;
                }
                // 记录 for_sale_sign 标记以便弹窗隐藏/显示控制
                else if (type === 'for_sale_sign') {
                    if (!window.forSaleSignMarkers) window.forSaleSignMarkers = [];
                    window.forSaleSignMarkers[index] = marker;
                }
                // 记录 the_big_score_gauntlet 标记以便弹窗隐藏/显示控制
                else if (type === 'the_big_score_gauntlet') {
                    if (!window.theBigScoreGauntletMarkers) window.theBigScoreGauntletMarkers = [];
                    window.theBigScoreGauntletMarkers[index] = marker;
                }
                // 记录 hitchhikers 标记以便后续扩展（可见性/计数器）
                else if (type === 'hitchhikers') {
                    if (!window.hitchhikersMarkers) window.hitchhikersMarkers = [];
                    window.hitchhikersMarkers[index] = marker;
                }
                // 记录 ghosts3 标记以便弹窗隐藏/显示控制
                else if (type === 'ghosts3') {
                    if (!window.ghosts3Markers) window.ghosts3Markers = [];
                    window.ghosts3Markers[index] = marker;
                }
                // 记录 ufo 标记以便弹窗隐藏/显示控制
                else if (type === 'ufo') {
                    if (!window.ufoMarkers) window.ufoMarkers = [];
                    window.ufoMarkers[index] = marker;
                }
                // 记录 serial_killer_slasher 标记以便弹窗隐藏/显示控制（已在createLeafletMarker中处理）
                // else if (type === 'serial_killer_slasher') {
                //     if (!window.slasherMarkers) window.slasherMarkers = [];
                //     window.slasherMarkers[index] = marker;
                // }
            } catch (e) {}
            
            // 添加点击事件
            marker.on('click', function(e) {
                // 特殊处理drug_vehicle，使用专门的弹窗函数
                if (type === 'drug_vehicle') {
                    showDrugVehiclePopup(item, index);
                }
                // 特殊处理metal_detector，使用专门的弹窗函数
                else if (type === 'metal_detector') {
                    showMetalDetectorPopup(item, index);
                }
                // 特殊处理gun_van，使用专门的武器信息弹窗
                else if (type === 'gun_van') {
                    showGunVanWeapons();
                }
                // 特殊处理街头毒贩，使用专门的信息弹窗
                else if (type === 'street_dealers') {
                    showStreetDealersPopup(item, index);
                }
                // 特殊处理有机坊产品，显示图片弹窗
                else if (type === 'ld_organics_products') {
                    showOrganicFarmImage(index);
                }
                // 特殊处理信号干扰器，显示图片弹窗
                else if (type === 'signal_jammers') {
                    showSignalJammerImage(index);
                }
                // 特殊处理纸牌，显示图片弹窗
                else if (type === 'playing_cards') {
                    showPlayingCardsImage(index);
                }
                // 特殊处理残缺信件，显示图片弹窗
                else if (type === 'letter_scraps') {
                    showLetterScrapsImage(index);
                }
                // 特殊处理隐藏包裹（线下），显示图片弹窗
                else if (type === 'sp_hidden_packages') {
                    showSpHiddenPackagesImage(index);
                }
                // 特殊处理迷幻仙人掌陆地，显示图片弹窗
                else if (type === 'peyote_sp_land') {
                    showPeyoteSpLandImage(index);
                }
                // 特殊处理迷幻仙人掌鸟类，显示图片弹窗
                else if (type === 'peyote_sp_air') {
                    showPeyoteSpAirImage(index);
                }
                // 特殊处理迷幻仙人掌水下，显示图片弹窗
                else if (type === 'peyote_sp_water') {
                    showPeyoteSpWaterImage(index);
                }
                // 特殊处理迷幻仙人掌金色，显示图片弹窗
                else if (type === 'peyote_sp_special') {
                    showPeyoteSpSpecialImage(index);
                }
                // 特殊处理潜水艇碎片，显示图片弹窗
                else if (type === 'submarine_pieces') {
                    showSubmarinePiecesImage(index);
                }
                // 特殊处理宇宙飞船部件，显示图片弹窗
                else if (type === 'spaceship_parts') {
                    showSpaceshipPartsImage(index);
                }
                // 特殊处理核废料，显示图片弹窗
                else if (type === 'nuclear_waste') {
                    showNuclearWasteImage(index);
                }
                // 特殊处理洛圣都的人类，显示图片弹窗
                else if (type === 'humans_of_ls') {
                    showHumansOfLsImage(index);
                }
                // 特殊处理猴子马赛克，显示图片弹窗
                else if (type === 'monkey_mosaics') {
                    showMonkeyMosaicsImage(index);
                }
                // 特殊处理谋杀之谜信息，显示图片弹窗
                else if (type === 'murder_mystery_message') {
                    showMurderMysteryMessageImage(index);
                }
                // 特殊处理吞云吐雾馆产品，显示图片弹窗
                else if (type === 'smoke_on_the_water_product') {
                    showSmokeProductPopup(item, index);
                }
                // 特殊处理手办，显示图片弹窗
                else if (type === 'action_figures') {
                    showActionFiguresImage(index);
                }
                // 特殊处理元宝，显示图片弹窗
                else if (type === 'yuanbao') {
                    showYuanbaoImage(index);
                }
                // 特殊处理沉船，显示图片弹窗
                else if (type === 'shipwrecked') {
                    showShipwreckedPopup(item, index);
                }
                // 特殊处理电话暗杀，显示图片弹窗
                else if (type === 'payphone_hits') {
                    showPayphoneHitsImage(index);
                }
                // 特殊处理高尔夫球洞，显示图片弹窗
                else if (type === 'golf_holes') {
                    showGolfHolesImage(index);
                }
                // 特殊处理雪人，显示图片弹窗
                else if (type === 'snowmen') {
                    showSnowmenImage(index);
                }
                // 特殊处理杰拉德包裹，显示增强版弹窗
                else if (type === 'dead_drop') {
                    showDeadDropPopup(item, index);
                }
                // 特殊处理特技跳跃点，显示图片弹窗
                else if (type === 'stunt_jumps') {
                    showStuntJumpsImage(index);
                }
                // 特殊处理喷罐，显示图片弹窗
                else if (type === 'spray') {
                    showSprayImage(index);
                }
                // 特殊处理帮派攻击，显示弹窗
                else if (type === 'gang_attacks') {
                    showGangAttackPopup(item, index);
                }
                // 特殊处理幽灵曝光，显示弹窗
                else if (type === 'ghosts3') {
                    showGhosts3Popup(item, index);
                }
                // 特殊处理威泽尔大楼枪战，显示弹窗
                else if (type === 'wea') {
                    showWeaPopup(item, index);
                }
                // 特殊处理陆地迷幻仙人掌，显示弹窗
                else if (type === 'ppl') {
                    showPplPopup(item, index);
                }
                // 特殊处理水下迷幻仙人掌，显示弹窗
                else if (type === 'ppw') {
                    showPpwPopup(item, index);
                }
                // 特殊处理南瓜灯，显示图片弹窗
                else if (type === 'jack_o_lanterns') {
                    showJackOLanternImage(index);
                }
                // 特殊处理RC时间挑战赛，显示图片弹窗
                else if (type === 'rc_time_trial') {
                    showRCTimeTrialImage(index);
                }
                // 特殊处理自行车时间挑战赛，显示图片弹窗
                else if (type === 'bike_time_trial') {
                    showBikeTimeTrialImage(index);
                }
                // 特殊处理跳伞，显示图片弹窗
                else if (type === 'skydives') {
                    showSkydivesImage(index);
                }
                // 特殊处理隐藏包裹，显示图片弹窗
                else if (type === 'hidden_caches') {
                    showHiddenCachesPopup(item, index);
                }
                // 特殊处理LS涂鸦，显示图片弹窗（传入对象以使用 sequenceNumber）
                else if (type === 'ls_tags') {
                    showLSTagsPopup(item, index);
                }
                // 新增：特殊处理待售标志，显示弹窗
                else if (type === 'for_sale_sign') {
                    showForSaleSignPopup(item, index);
                }
                // 新增：特殊处理大干一票（巧妙）铁腕
                else if (type === 'the_big_score_gauntlet') {
                    showTheBigScoreGauntletPopup(item, index);
                }
                // 新增：特殊处理搭便车（潜在的利他邪教受害者）
                else if (type === 'hitchhikers') {
                    showHitchhikersPopup(item, index);
                }
                // 特殊处理车行标记，使用专门的车辆展示函数
                else if (['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'].includes(type)) {
                    showDealershipVehicles(type, item.name);
                }
                // 特殊处理treasure_hunt_dba_revolver（按随机/固定展示）
                else if (type === 'treasure_hunt_dba_revolver') {
                    const th = itemData.treasure_hunt_dba_revolver || { random_clue: [], static_clues: [] };
                    const rc = th.random_clue || [];
                    const sc = th.static_clues || [];
                    const fixedCount = sc.length;
                    // 尝试根据就近集合判断子类型（不严格，但足够展示）
                    if (index < rc.length) {
                        showTreasureHuntPopup(item, index, 'random');
                    } else {
                        showTreasureHuntPopup(item, index - rc.length, 'static');
                    }
                }
                // 特殊处理serial_killer_slasher（按first/last展示）
                else if (type === 'serial_killer_slasher') {
                    const first = itemData.serial_killer_slasher?.first?.length || 0;
                    if (index < first) {
                        showSlasherPopup(item, index, 'first');
                    } else {
                        showSlasherPopup(item, index - first, 'last');
                    }
                }
                // 电影道具弹窗
                else if (type === 'movie_props') {
                    // 优先使用数据里的子类型
                    let subtype = item && item.type ? item.type : undefined;
                    if (!subtype) {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        const fixedCount = mp.fixed_position?.length || 0;
                        const ponyCount = mp.vehicles?.pony?.length || 0;
                        const rebelCount = mp.vehicles?.rebel?.length || 0;
                        if (index < fixedCount) subtype = 'fixed_position';
                        else if (index < fixedCount + ponyCount) subtype = 'pony';
                        else if (index < fixedCount + ponyCount + rebelCount) subtype = 'rebel';
                        else subtype = 'rumpo';
                    }
                    showMoviePropsPopup(item, index, subtype);
                }
                // 新增：特殊处理犯罪现场，显示弹窗
                else if (type === 'crime_scenes') {
                    console.log('点击犯罪现场标记:', item, index);
                    showCrimeScenesPopup(item, index);
                }
                // 新增：特殊处理藏匿屋，显示弹窗
                else if (type === 'stash_houses') {
                    showStashHousesPopup(item, index);
                }
                // 新增：特殊处理玛德拉索雇凶，显示弹窗
                else if (type === 'madrazo_hits') {
                    showMadrazoHitsPopup(item, index);
                }
                // 新增：特殊处理帕特里克救援，显示弹窗
                else if (type === 'police_rescue_patrick_mcreary') {
                    console.log('点击帕特里克救援标记:', item, index, item.subtype);
                    showPatrickRescuePopup(item, index, item.subtype || 'spawn');
                }
                // 新增：特殊处理随机任务，显示弹窗
                else if (type === 'random_missions') {
                    console.log('点击随机任务标记:', item, index, item.timeSlot, item.missionIndex);
                    showRandomMissionPopup([item.x, item.y], item.timeSlot, item.missionIndex);
                }
                // 新增：特殊处理沉睡的保安，显示弹窗
                else if (type === 'drunk_guard') {
                    showDrunkGuardPopup(item, index);
                }
                // 新增：特殊处理社区边界，显示弹窗
                else if (type === 'community_outreach') {
                    showCommunityOutreachPopup(item, index);
                }
                // 新增：特殊处理商店抢劫，显示弹窗
                else if (type === 'store_robbery') {
                    showStoreRobberyPopup(item, index);
                }
                // 新增：特殊处理装甲运钞车，显示弹窗
                else if (type === 'armored_truck') {
                    showArmoredTruckPopup(item, index);
                }
                // 新增：特殊处理媒体记忆棒，显示弹窗
                else if (type === 'media_sticks') {
                    showMediaStickPopup(item, index);
                }
                // 新增：特殊处理望远镜，使用通用弹窗
                else if (type === 'v_telescopes') {
                    showNewItemPopup(type, item, index);
                }
                // 新增：特殊处理UFO观光，显示弹窗
                else if (type === 'ufo') {
                    showUfoPopup(item, index);
                }
                // 新增：特殊处理万圣节地狱犬事件，显示弹窗
                else if (type === 'cerberus') {
                    console.log('点击万圣节地狱犬事件标记:', item, index);
                    showCerberusPopup(item, index);
                }
                // 新增：特殊处理地点与服务类型，使用通用弹窗
                else if (['metro', 'police', 'fire_stations', 'hospitals', 'clothing', 'tattoos', 'barbers', 'ammunation', 'mod_shop', 'car_wash', 'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'].includes(type)) {
                    showNewItemPopup(type, item, index);
                }
                else {
                    showItemInfo(item, type, index);
                }
            });
            
            return marker;
        }

        // 清除所有Leaflet标记
        function clearLeafletMarkers() {
            leafletMarkers.forEach(marker => {
                // 处理复合标记的特殊情况（包含circle和icon）
                // 适用于：halloween_slashers, possessed_animals, yeti, gang_attacks, cerberus等
                if (marker.circle && marker.icon) {
                    map.removeLayer(marker.circle);
                    map.removeLayer(marker.icon);
                } else if (marker.circle && !marker.icon) {
                    // 处理只有圆圈的标记（如yeti的area类型）
                    map.removeLayer(marker.circle);
                } else if (marker.removeFrom && typeof marker.removeFrom === 'function') {
                    // 处理有自定义removeFrom方法的标记
                    marker.removeFrom(map);
                } else {
                    // 处理普通标记
                    map.removeLayer(marker);
                }
            });
            leafletMarkers = [];
            
            // 清空特殊标记存储数组（但不清除有计数器的标记）
            // 有计数器的标记需要保持状态，不清除：
            // - streetDealersMarkers (街头毒贩)
            // - playingCardsMarkers (纸牌)
            // - letterScrapsMarkers (残缺信件)
            // - yuanbaoMarkers (元宝)
            // - pplMarkers (陆地迷幻仙人掌)
            // - ppwMarkers (水下迷幻仙人掌)
            // - assumingTheTruthMarkers (埃普西隆质疑真理-载具)
            // - chasingTheTruthMarkers (埃普斯隆追求真理-神器)
            
            if (window.gunVanMarkers) {
                window.gunVanMarkers = [];
            }
            if (window.shipwreckedMarkers) {
                window.shipwreckedMarkers = [];
            }
            if (window.rcTimeTrialMarkers) {
                window.rcTimeTrialMarkers = [];
            }
            if (window.bikeTimeTrialMarkers) {
                window.bikeTimeTrialMarkers = [];
            }
            if (window.actionFiguresMarkers) {
                window.actionFiguresMarkers = [];
            }
            if (window.signalJammersMarkers) {
                window.signalJammersMarkers = [];
            }
            if (window.organicFarmMarkers) {
                window.organicFarmMarkers = [];
            }
            if (window.forSaleSignMarkers) {
                window.forSaleSignMarkers = [];
            }
            if (window.theBigScoreGauntletMarkers) {
                window.theBigScoreGauntletMarkers = [];
            }
            if (window.hitchhikersMarkers) {
                window.hitchhikersMarkers = [];
            }
            // 不清除特技跳跃点标记，保持其状态
            // if (window.stuntJumpsMarkers) {
            //     window.stuntJumpsMarkers = [];
            // }
        }
        
        // 更新Leaflet标记的半径（响应地图缩放）
        function updateLeafletMarkersRadius() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const gameWidth = GAME_RIGHT - GAME_LEFT;
            
            leafletMarkers.forEach(marker => {
                if (marker.circle && marker.item) {
                    let newRadius;
                    
                    // 根据标记类型计算新半径
                    if (marker.type === 'gang_attacks') {
                        // 帮派攻击：固定100游戏单位
                        newRadius = (100 / gameWidth) * totalWidth;
                    } else if (marker.item.radius) {
                        // 其他有radius属性的标记（如possessed_animals, yeti等）
                        newRadius = (marker.item.radius / gameWidth) * totalWidth;
                    }
                    
                    if (newRadius !== undefined) {
                        marker.circle.setRadius(newRadius);
                    }
                }
            });
        }
        
        // 获取杀人狂颜色配置
        function getSlasherColor(slasherType) {
            switch(slasherType) {
                case 'clown':
                    return {
                        border: '#FF9800', // 橙色
                        fill: '#FFE0B2'
                    };
                case 'psycho':
                    return {
                        border: '#F44336', // 红色
                        fill: '#FFCDD2'
                    };
                case 'driver':
                    return {
                        border: '#9C27B0', // 紫色
                        fill: '#E1BEE7'
                    };
                case 'sackslasher':
                    return {
                        border: '#607D8B', // 蓝灰色
                        fill: '#CFD8DC'
                    };
                default:
                    return {
                        border: '#795548', // 棕色
                        fill: '#D7CCC8'
                    };
            }
        }
        
        // 获取鬼上身动物颜色配置
        function getPossessedAnimalColor(animalType) {
            switch(animalType) {
                case 'boar':
                    return {
                        border: '#8D6E63', // 棕色
                        fill: '#D7CCC8'
                    };
                case 'cougar':
                    return {
                        border: '#FF5722', // 橙红色
                        fill: '#FFCCBC'
                    };
                case 'coyote':
                    return {
                        border: '#795548', // 深棕色
                        fill: '#D7CCC8'
                    };
                case 'deer':
                    return {
                        border: '#4CAF50', // 绿色
                        fill: '#C8E6C9'
                    };
                case 'pug':
                    return {
                        border: '#9C27B0', // 紫色
                        fill: '#E1BEE7'
                    };
                default:
                    return {
                        border: '#607D8B', // 蓝灰色
                        fill: '#CFD8DC'
                    };
            }
        }
        

        // DOM 标记创建函数已废弃

        // 更新物品标记位置
        function updateItemMarkers() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // 仅清除现有 Leaflet 标记（DOM 标记已废弃）
            clearLeafletMarkers();

            // 处理试点标记类型（使用Leaflet原生标记）
            activeItemTypes.forEach(type => {
                if (pilotMarkerTypes.has(type)) {
                    // 特殊处理media_sticks
                    if (type === 'media_sticks') {
                        const mediaSticks = itemData.media_sticks || [];
                        mediaSticks.forEach((stick, index) => {
                            if (typeof stick.x === 'undefined' || typeof stick.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(stick, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理police_rescue_patrick_mcreary
                    else if (type === 'police_rescue_patrick_mcreary') {
                        const patrickData = itemData.police_rescue_patrick_mcreary;
                        
                        // 处理spawn点
                        if (patrickData && patrickData.spawn) {
                            patrickData.spawn.forEach((spawn, index) => {
                                if (typeof spawn.x === 'undefined' || typeof spawn.y === 'undefined') return;
                                
                                const spawnItem = { ...spawn, subtype: 'spawn' };
                                const marker = createLeafletMarker(spawnItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                        
                        // 处理dropoff点
                        if (patrickData && patrickData.dropoff) {
                            patrickData.dropoff.forEach((dropoff, index) => {
                                if (typeof dropoff.x === 'undefined' || typeof dropoff.y === 'undefined') return;
                                
                                const dropoffItem = { ...dropoff, subtype: 'dropoff' };
                                const marker = createLeafletMarker(dropoffItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // 特殊处理convoy - 车队标记
                    else if (type === 'convoy') {
                        const convoyData = itemData.convoy || [];
                        convoyData.forEach((group, index) => {
                            const tp = group.triggerpoint;
                            if (Array.isArray(tp) && tp.length >= 2) {
                                const convoyItem = {
                                    x: tp[0],
                                    y: tp[1],
                                    ...group
                                };
                                const marker = createLeafletMarker(convoyItem, index, type);
                                leafletMarkers.push(marker);
                                
                                // 创建车队路线（使用Leaflet的Polyline）
                                if (group.routes && Array.isArray(group.routes)) {
                                    group.routes.forEach((route, routeIndex) => {
                                        if (Array.isArray(route) && route.length > 1) {
                                            const routePoints = route.map(point => {
                                                if (Array.isArray(point) && point.length === 2) {
                                                    const pixel = gameToPixel(point[0], point[1], map.getZoom());
                                                    return map.unproject(L.point(pixel.x, pixel.y), map.getZoom());
                                                }
                                                return null;
                                            }).filter(point => point !== null);
                                            
                                            if (routePoints.length > 1) {
                                                const polyline = L.polyline(routePoints, {
                                                    color: 'red',
                                                    weight: 3,
                                                    opacity: 0.8,
                                                    zIndexOffset: 650
                                                }).addTo(map);
                                                leafletMarkers.push(polyline);
                                            }
                                        }
                                    });
                                }
                            }
                        });
                        
                        // 同时显示车队终点
                        const convoyFinalData = itemData.convoy_final || [];
                        convoyFinalData.forEach((finalPoint, index) => {
                            if (typeof finalPoint.x !== 'undefined' && typeof finalPoint.y !== 'undefined') {
                                const marker = createLeafletMarker(finalPoint, index, 'convoy_final');
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // 特殊处理convoy_final - 车队终点标记（单独选择时）
                    else if (type === 'convoy_final') {
                        const convoyFinalData = itemData.convoy_final || [];
                        convoyFinalData.forEach((finalPoint, index) => {
                            if (typeof finalPoint.x !== 'undefined' && typeof finalPoint.y !== 'undefined') {
                                const marker = createLeafletMarker(finalPoint, index, type);
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // 特殊处理random_missions - 随机任务
                    else if (type === 'random_missions') {
                        console.log('处理随机任务标记，数据:', itemData.random_missions);
                        const randomMissions = itemData.random_missions || {};
                        let globalIndex = 0;
                        
                        Object.keys(randomMissions).forEach(timeSlot => {
                            const missions = randomMissions[timeSlot] || [];
                            console.log(`时间段 ${timeSlot} 有 ${missions.length} 个任务`);
                            missions.forEach((mission, index) => {
                                // 处理不同的数据格式
                                let missionItem;
                                if (Array.isArray(mission) && mission.length >= 2) {
                                    // [x, y] 数组格式
                                    missionItem = { 
                                        x: mission[0], 
                                        y: mission[1],
                                        timeSlot: timeSlot,
                                        missionIndex: index
                                    };
                                } else if (typeof mission === 'object' && mission.x !== undefined && mission.y !== undefined) {
                                    // {x, y} 对象格式
                                    missionItem = { 
                                        ...mission,
                                        timeSlot: timeSlot,
                                        missionIndex: index
                                    };
                                } else {
                                    console.log('跳过无效的随机任务数据:', mission);
                                    return;
                                }
                                
                                console.log(`创建随机任务标记 ${globalIndex}:`, missionItem);
                                const marker = createLeafletMarker(missionItem, globalIndex, type);
                                leafletMarkers.push(marker);
                                globalIndex++;
                            });
                        });
                        console.log(`总共创建了 ${globalIndex} 个随机任务标记`);
                    }
                    // 特殊处理走私标记（有复杂的路线和连接线）
                    else if (type === 'smuggler_plane' || type === 'smuggler_trail') {
                        createSmugglerLeafletMarkers(type);
                    }
                    // 特殊处理车行标记（casino, car_meet, premium_deluxe_motorsport, luxury_autos）
                    else if (['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'].includes(type)) {
                        const dealership = dealershipData[type];
                        if (dealership && dealership.coordinates) {
                            dealership.coordinates.forEach((coord, index) => {
                                const item = {
                                    x: coord[0],
                                    y: coord[1],
                                    name: dealership.name,
                                    icon: dealership.icon
                                };
                                
                                const marker = createLeafletMarker(item, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // 特殊处理exotic_exports1 - 外贸出口载具1
                    else if (type === 'exotic_exports1') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理exotic_exports2 - 外贸出口载具2
                    else if (type === 'exotic_exports2') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理happy_holidays_hauler - 节日快乐卡车（triggerpoint + routes）
                    else if (type === 'happy_holidays_hauler') {
                        const groups = itemData.happy_holidays_hauler || [];
                        groups.forEach((group, index) => {
                            const tp = group.triggerpoint; // [x, y]
                            const routes = Array.isArray(group.routes) ? group.routes : [];
                            
                            if (Array.isArray(tp) && tp.length >= 2) {
                                // 创建triggerpoint标记
                                const item = {
                                    x: tp[0],
                                    y: tp[1],
                                    ...group
                                };
                                
                                const marker = createLeafletMarker(item, index, type);
                                leafletMarkers.push(marker);
                                
                                // 创建路线连接线（使用Leaflet的Polyline）
                                routes.forEach((route, routeIndex) => {
                                    if (Array.isArray(route) && route.length > 0) {
                                        // 创建路线点数组，从triggerpoint开始
                                        const z = map.getZoom();
                                        const routeLatLngs = [];
                                        
                                        // 添加triggerpoint
                                        const tpPixel = gameToPixel(tp[0], tp[1], z);
                                        const tpLatLng = map.unproject(L.point(tpPixel.x, tpPixel.y), z);
                                        routeLatLngs.push(tpLatLng);
                                        
                                        // 添加路线点
                                        route.forEach(point => {
                                            if (Array.isArray(point) && point.length >= 2) {
                                                const pointPixel = gameToPixel(point[0], point[1], z);
                                                const pointLatLng = map.unproject(L.point(pointPixel.x, pointPixel.y), z);
                                                routeLatLngs.push(pointLatLng);
                                            }
                                        });
                                        
                                        // 创建Leaflet Polyline
                                        if (routeLatLngs.length > 1) {
                                            const polyline = L.polyline(routeLatLngs, {
                                                color: '#2196F3',
                                                weight: 3,
                                                opacity: 0.8
                                            }).addTo(map);
                                            
                                            leafletMarkers.push(polyline);
                                        }
                                    }
                                });
                            }
                        });
                    }
                    // 特殊处理wea - 威泽尔大楼枪战
                    else if (type === 'wea') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理halloween_slashers - 万圣节杀人狂圆形区域
                    else if (type === 'halloween_slashers') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined' || typeof item.radius === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理gang_attacks - 帮派攻击圆形区域
                    else if (type === 'gang_attacks') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            if (marker) { // 只有在时间范围内才会返回marker
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // 特殊处理ghosts3 - 幽灵曝光
                    else if (type === 'ghosts3') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理cerberus - 地狱犬（只显示图标）
                    else if (type === 'cerberus') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理possessed_animals - 鬼上身动物圆形区域
                    else if (type === 'possessed_animals') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined' || typeof item.radius === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊处理yeti - 雪怪（圆形区域和线索点）
                    else if (type === 'yeti') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            if (marker) { // yeti可能返回null（如果类型不匹配）
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // 特殊处理maude_bounty_targets - 茉德悬赏目标
                    else if (type === 'maude_bounty_targets') {
                        const maudeData = itemData.maude_bounty_targets;
                        
                        // 处理悬赏区域
                        if (maudeData && maudeData.areas) {
                            maudeData.areas.forEach((area, index) => {
                                if (typeof area.x === 'undefined' || typeof area.y === 'undefined') return;
                                
                                const areaItem = { ...area, subtype: 'area' };
                                const marker = createLeafletMarker(areaItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                        
                        // 处理悬赏终点
                        if (maudeData && maudeData.endpoints) {
                            maudeData.endpoints.forEach((endpoint, index) => {
                                if (typeof endpoint.x === 'undefined' || typeof endpoint.y === 'undefined') return;
                                
                                const endpointItem = { ...endpoint, subtype: 'endpoint' };
                                const marker = createLeafletMarker(endpointItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // 特殊：左轮寻宝两个子类型分别渲染（Leaflet）
                    else if (type === 'treasure_hunt_dba_revolver') {
                        const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
                        const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
                        
                        // 初始化标记存储
                        if (!window.treasureHuntTh1Markers) window.treasureHuntTh1Markers = [];
                        if (!window.treasureHuntTh2Markers) window.treasureHuntTh2Markers = [];
                        
                        rc.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'random' }, i, 'treasure_hunt_dba_revolver');
                            leafletMarkers.push(marker);
                            // 存储th1标记
                            window.treasureHuntTh1Markers[i] = marker;
                        });
                        sc.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'static' }, i, 'treasure_hunt_dba_revolver');
                            leafletMarkers.push(marker);
                            // 存储th2标记
                            window.treasureHuntTh2Markers[i] = marker;
                        });
                    }
                    // 特殊：洛圣都杀人狂（first/last 合并为一个选项）
                    else if (type === 'serial_killer_slasher') {
                        const first = itemData.serial_killer_slasher?.first || [];
                        const last = itemData.serial_killer_slasher?.last || [];
                        first.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'first' }, i, 'serial_killer_slasher');
                            leafletMarkers.push(marker);
                        });
                        last.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const globalIndex = first.length + i; // 使用全局索引
                            const marker = createLeafletMarker({ ...p, subtype: 'last' }, globalIndex, 'serial_killer_slasher');
                            leafletMarkers.push(marker);
                        });
                    }
                    // 特殊：电影道具（多个子组）
                    else if (type === 'movie_props') {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        let globalIndex = 0;
                        
                        (mp.fixed_position || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.pony || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.rebel || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.rumpo || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                    }
                    // 其他简单数组类型统一处理
                    else if (['crime_scenes', 'ufo', 'community_outreach', 'store_robbery', 'ppl', 'ppw'].includes(type)) {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    } else {
                        // 普通标记处理
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                }
            });

            // DOM 标记渲染已废弃，所有类型均由 Leaflet 标记系统处理

            // 重新应用隐藏可见性缓存，确保被隐藏的标记在切换显示后仍保持状态
            try { applySmugglerPlaneVisibilityCache(); } catch (e) {}
            try { applyStreetDealersVisibilityCache(); } catch (e) {}
            try { applySubmarinePiecesVisibilityCache(); } catch (e) {}
            try { applyNuclearWasteVisibilityCache(); } catch (e) {}
            try { applySlasherVisibilityCache(); } catch (e) {}
            try { applyTreasureHuntVisibilityCache(); } catch (e) {}
            try { applyUfoVisibilityCache(); } catch (e) {}
            try { applyGhosts3VisibilityCache(); } catch (e) {}
            try { applySnowmenVisibilityCache(); } catch (e) {}
            try { applyMediaStickVisibilityCache(); } catch (e) {}
            try { applyMoviePropsVisibilityCache(); } catch (e) {}
            try { applySprayVisibilityCache(); } catch (e) {}
            try { applyPplVisibilityCache(); } catch (e) {}
            try { applyPpwVisibilityCache(); } catch (e) {}
            // 补充应用可见性缓存：洛圣都的人类 与 猴子马赛克
            // 解决问题：取消选中后再次勾选，这两类标记先前的隐藏状态会丢失，导致重新显示且计数器不同步
            try { applyHumansOfLsVisibilityCache(); } catch (e) {}
            try { applyMonkeyMosaicsVisibilityCache(); } catch (e) {}
            try { applyStuntJumpsVisibilityCache(); } catch (e) {}
            try { applyYuanbaoVisibilityCache(); } catch (e) {}
            try { applySignalJammersVisibilityCache(); } catch (e) {}
            try { applyActionFiguresVisibilityCache(); } catch (e) {}
            try { applyPlayingCardsVisibilityCache(); } catch (e) {}
            try { applyLetterScrapsVisibilityCache(); } catch (e) {}
            try { applySpaceshipPartsVisibilityCache(); } catch (e) {}
            try { applyOrganicFarmVisibilityCache(); } catch (e) {}
            try { applySkydivesVisibilityCache(); } catch (e) {}
            try { applyJackOLanternsVisibilityCache(); } catch (e) {}
            try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
            try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
            try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
            try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
            try { applyHitchhikersVisibilityCache(); } catch (e) {}
            try { applyRCTimeTrialVisibilityCache(); } catch (e) {}
            try { applyBikeTimeTrialVisibilityCache(); } catch (e) {}
            try { applyMadrazoHitsVisibilityCache(); } catch (e) {}
            try { applyStashHousesVisibilityCache(); } catch (e) {}
            try { applyLSTagsVisibilityCache(); } catch (e) {}
            try { applyShipwreckedVisibilityCache(); } catch (e) {}
            try { applyHiddenCachesVisibilityCache(); } catch (e) {}
            try { applySmokeProductVisibilityCache(); } catch (e) {}
            try { applyDeadDropVisibilityCache(); } catch (e) {}
            try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
            try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
            try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
            try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
            try { applyForSaleSignVisibilityCache(); } catch (e) {}
            try { applyTheBigScoreGauntletVisibilityCache(); } catch (e) {}

            // 特殊：左轮寻宝两个子类型分别渲染（DOM版保留兼容，若Leaflet已处理则跳过）
            if (false && activeItemTypes.has('treasure_hunt_dba_revolver') && !pilotMarkerTypes.has('treasure_hunt_dba_revolver')) {
                const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
                const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
                const renderList = [
                    ...rc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_random', __index: i })),
                    ...sc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_static', __index: i }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM 标记层已移除
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 特殊：洛圣都杀人狂两个子类型一起渲染（DOM兼容，Leaflet已处理则跳过）
            if (false && activeItemTypes.has('serial_killer_slasher') && !pilotMarkerTypes.has('serial_killer_slasher')) {
                const first = (itemData.serial_killer_slasher.first || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_first', __index:i }));
                const last = (itemData.serial_killer_slasher.last || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_last', __index:i }));
                const renderList = [...first, ...last];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM 标记层已移除
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 注意：万圣节杀人狂现在使用Leaflet标记系统渲染，不再需要DOM渲染

            // 注意：鬼上身动物现在使用Leaflet标记系统渲染，不再需要DOM渲染

            // 注意：地狱犬现在使用Leaflet标记系统渲染，不再需要DOM渲染

            // 注意：雪怪现在使用Leaflet标记系统渲染，不再需要DOM渲染


            // 特殊：电影道具多个子类型分别渲染（DOM兼容，Leaflet已处理则跳过）
            if (false && activeItemTypes.has('movie_props') && !pilotMarkerTypes.has('movie_props')) {
                const mp = itemData.movie_props;
                const renderList = [
                    ...(mp.fixed_position || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i })),
                    ...(mp.vehicles?.pony || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) })),
                    ...(mp.vehicles?.rebel || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) })),
                    ...(mp.vehicles?.rumpo || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) + (mp.vehicles?.rebel?.length || 0) }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM 标记层已移除
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 注意：茉德悬赏目标现在使用Leaflet标记系统渲染，不再需要DOM渲染


            // 特殊：走私贩飞机渲染（已迁移到Leaflet系统）
            if (false && activeItemTypes.has('smuggler_plane') && !pilotMarkerTypes.has('smuggler_plane')) {
                const groups = itemData.smuggler_plane || [];
                groups.forEach((group, gIndex) => {
                    const tp = group.triggerpoint; // [x, y]
                    const routes = Array.isArray(group.routes) ? group.routes : [];
                    if (Array.isArray(tp) && tp.length === 2) {
                        const percentX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        const marker = document.createElement('div');
                        marker.className = 'item-marker smuggler-triggerpoint-marker';
                        marker.dataset.type = 'smuggler_plane';
                        marker.dataset.index = String(gIndex);
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        const img = document.createElement('img');
                        img.src = '../src/assets/smuggler_plane.svg';
                        img.style.width = '28px';
                        img.style.height = '28px';
                        marker.appendChild(img);
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSmugglerPlanePopup(group, gIndex);
                        });
                        // DOM 标记层已移除
                        itemMarkers.push({ type: 'smuggler_plane', index: gIndex, el: marker });
                    }
                    // routes: array of arrays of [x,y]; draw marker at each and a red line from triggerpoint
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const percentX = (rx - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const percentY = (GAME_TOP - ry) / (GAME_TOP - GAME_BOTTOM);
                            const itemX = percentX * totalWidth;
                            const itemY = percentY * totalHeight;
                            const marker = document.createElement('div');
                            marker.className = 'item-marker smuggler-route-marker';
                            marker.dataset.type = 'smuggler_plane_route';
                            marker.dataset.index = String(gIndex);
                            marker.dataset.routeIndex = String(rIndex);
                            marker.style.position = 'absolute';
                            marker.style.left = `${itemX}px`;
                            marker.style.top = `${itemY}px`;
                            marker.style.transform = 'translate(-50%, -50%)';
                            marker.style.cursor = 'pointer';
                            marker.style.zIndex = '670';
                            const img = document.createElement('img');
                            img.src = '../src/assets/smuggler_plane2.svg';
                            img.style.width = '28px';
                            img.style.height = '28px';
                            marker.appendChild(img);
                            marker.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSmugglerPlanePopup(group, gIndex);
                            });
                            // DOM 标记层已移除
                            itemMarkers.push({ type: 'smuggler_plane_route', index: gIndex, el: marker });

                            // 红线：用 div 绘制一条连接 tp 与 route 点的线
                            if (Array.isArray(tp) && tp.length === 2) {
                                const tpPX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const tpPY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                const dx = itemX - tpPX;
                                const dy = itemY - tpPY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                const line = document.createElement('div');
                                line.className = 'smuggler-connector-line';
                                line.dataset.type = 'smuggler_plane_line';
                                line.dataset.index = String(gIndex);
                                line.dataset.routeIndex = String(rIndex);
                                line.style.position = 'absolute';
                                line.style.left = `${tpPX}px`;
                                line.style.top = `${tpPY}px`;
                                line.style.width = `${length}px`;
                                line.style.height = '2px';
                                line.style.background = 'red';
                                line.style.transformOrigin = '0 0';
                                line.style.transform = `rotate(${angle}deg)`;
                                line.style.zIndex = '660';
                                // DOM 标记层已移除
                                itemMarkers.push({ type: 'smuggler_plane_line', index: gIndex, el: line });
                            }
                        }
                    });
                });
            }

            // 特殊：走私贩踪迹渲染（triggerpoint + routes + 蓝线）
            if (false && activeItemTypes.has('smuggler_trail') && !pilotMarkerTypes.has('smuggler_trail')) {
                const groups = itemData.smuggler_trail || [];
                groups.forEach((group, gIndex) => {
                    const tp = group.triggerpoint; // [x, y]
                    const routes = Array.isArray(group.routes) ? group.routes : [];
                    if (Array.isArray(tp) && tp.length === 2) {
                        const percentX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        const marker = document.createElement('div');
                        marker.className = 'item-marker smuggler-trail-triggerpoint-marker';
                        marker.dataset.type = 'smuggler_trail';
                        marker.dataset.index = String(gIndex);
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        const img = document.createElement('img');
                        img.src = '../src/assets/smuggler_trail.svg';
                        img.style.width = '28px';
                        img.style.height = '28px';
                        marker.appendChild(img);
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSmugglerTrailPopup(group, gIndex);
                        });
                        // DOM 标记层已移除
                        itemMarkers.push({ type: 'smuggler_trail', index: gIndex, el: marker });
                    }
                    // routes: array of arrays of [x,y]; draw numbered markers and blue lines connecting them in sequence
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const percentX = (rx - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const percentY = (GAME_TOP - ry) / (GAME_TOP - GAME_BOTTOM);
                            const itemX = percentX * totalWidth;
                            const itemY = percentY * totalHeight;
                            
                            // 创建数字标记
                            const marker = document.createElement('div');
                            marker.className = 'item-marker smuggler-trail-route-marker';
                            marker.dataset.type = 'smuggler_trail_route';
                            marker.dataset.index = String(gIndex);
                            marker.dataset.routeIndex = String(rIndex);
                            marker.style.position = 'absolute';
                            marker.style.left = `${itemX}px`;
                            marker.style.top = `${itemY}px`;
                            marker.style.transform = 'translate(-50%, -50%)';
                            marker.style.cursor = 'pointer';
                            marker.style.zIndex = '670';
                            marker.style.width = '24px';
                            marker.style.height = '24px';
                            marker.style.borderRadius = '50%';
                            marker.style.backgroundColor = '#2196F3';
                            marker.style.border = '2px solid #fff';
                            marker.style.display = 'flex';
                            marker.style.alignItems = 'center';
                            marker.style.justifyContent = 'center';
                            marker.style.fontSize = '12px';
                            marker.style.fontWeight = 'bold';
                            marker.style.color = '#fff';
                            marker.textContent = String(rIndex + 1);
                            
                            marker.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSmugglerTrailPopup(group, gIndex);
                            });
                            // DOM 标记层已移除
                            itemMarkers.push({ type: 'smuggler_trail_route', index: gIndex, el: marker });

                            // 蓝线：连接triggerpoint到第一个route点，然后按顺序连接route点
                            if (Array.isArray(tp) && tp.length === 2) {
                                const tpPX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const tpPY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                let startX, startY;
                                
                                if (rIndex === 0) {
                                    // 第一个route点：从triggerpoint连接
                                    startX = tpPX;
                                    startY = tpPY;
                                } else {
                                    // 后续route点：从前一个route点连接
                                    const prevRoute = routes[rIndex - 1];
                                    if (Array.isArray(prevRoute) && prevRoute[0] && prevRoute[0].length === 2) {
                                        const prevX = prevRoute[0][0];
                                        const prevY = prevRoute[0][1];
                                        const prevPercentX = (prevX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                                        const prevPercentY = (GAME_TOP - prevY) / (GAME_TOP - GAME_BOTTOM);
                                        startX = prevPercentX * totalWidth;
                                        startY = prevPercentY * totalHeight;
                                    } else {
                                        return; // 如果前一个route无效，跳过
                                    }
                                }
                                
                                const dx = itemX - startX;
                                const dy = itemY - startY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                const line = document.createElement('div');
                                line.className = 'smuggler-trail-connector-line';
                                line.dataset.type = 'smuggler_trail_line';
                                line.dataset.index = String(gIndex);
                                line.dataset.routeIndex = String(rIndex);
                                line.style.position = 'absolute';
                                line.style.left = `${startX}px`;
                                line.style.top = `${startY}px`;
                                line.style.width = `${length}px`;
                                line.style.height = '2px';
                                line.style.background = 'blue';
                                line.style.transformOrigin = '0 0';
                                line.style.transform = `rotate(${angle}deg)`;
                                line.style.zIndex = '660';
                                // DOM 标记层已移除
                                itemMarkers.push({ type: 'smuggler_trail_line', index: gIndex, el: line });
                            }
                        }
                    });
                });
            }






            // 特殊：毒品载具渲染（已迁移到Leaflet系统）
            // if (activeItemTypes.has('drug_vehicle')) {
            //     const drugVehicles = itemData.drug_vehicle || [];
            //     drugVehicles.forEach((vehicle, index) => {
            //         if (typeof vehicle.x === 'undefined' || typeof vehicle.y === 'undefined') return;
            //         const percentX = (vehicle.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
            //         const percentY = (GAME_TOP - vehicle.y) / (GAME_TOP - GAME_BOTTOM);
            //         const itemX = percentX * totalWidth;
            //         const itemY = percentY * totalHeight;
                    
            //         // 创建毒品载具标记
            //         const marker = document.createElement('div');
            //         marker.className = 'item-marker drug-vehicle-marker';
            //         marker.dataset.type = 'drug_vehicle';
            //         marker.dataset.index = index;
            //         marker.style.position = 'absolute';
            //         marker.style.left = `${itemX}px`;
            //         marker.style.top = `${itemY}px`;
            //         marker.style.transform = 'translate(-50%, -50%)';
            //         marker.style.cursor = 'pointer';
            //         marker.style.zIndex = '670';
                    
            //         // 创建图标
            //         const img = document.createElement('img');
            //         img.src = '../src/assets/drug_vehicle.svg';
            //         img.style.width = '32px';
            //         img.style.height = '32px';
            //         marker.appendChild(img);
                    
            //         // 添加点击事件
            //         marker.addEventListener('click', (e) => {
            //             e.stopPropagation();
            //             showDrugVehiclePopup(vehicle, index);
            //         });
                    
            //         // DOM 标记层已移除
            //         itemMarkers.push({ type: 'drug_vehicle', index: index, el: marker });
            //     });
            // }
            
            // 特殊：随机任务渲染（需要特殊处理嵌套结构）- 若已迁移到Leaflet则跳过DOM渲染
            if (false && activeItemTypes.has('random_missions') && !pilotMarkerTypes.has('random_missions')) {
                console.log('处理随机任务DOM标记，数据:', itemData.random_missions);
                console.log('pilotMarkerTypes.has(random_missions):', pilotMarkerTypes.has('random_missions'));
                const randomMissions = itemData.random_missions || {};
                let globalIndex = 0;
                
                Object.keys(randomMissions).forEach(timeSlot => {
                    const missions = randomMissions[timeSlot] || [];
                    console.log(`时间段 ${timeSlot} 有 ${missions.length} 个任务`);
                    missions.forEach((mission, index) => {
                        // 检查数据格式：可能是[x, y]数组格式
                        let x, y;
                        if (Array.isArray(mission) && mission.length >= 2) {
                            x = mission[0];
                            y = mission[1];
                        } else if (typeof mission === 'object' && mission.x !== undefined && mission.y !== undefined) {
                            x = mission.x;
                            y = mission.y;
                        } else {
                            console.log('跳过无效的随机任务数据:', mission);
                            return;
                        }
                        
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建随机任务标记
                        const marker = document.createElement('div');
                        marker.className = 'item-marker';
                        marker.dataset.index = globalIndex;
                        marker.dataset.type = 'random_missions';
                        marker.dataset.timeSlot = timeSlot;
                        marker.dataset.missionIndex = index;
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        
                        const img = document.createElement('img');
                        img.src = '../src/assets/random.svg';
                        img.style.width = '32px';
                        img.style.height = '32px';
                        marker.appendChild(img);
                        
                        // 添加点击事件
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const missionData = Array.isArray(mission) ? { x, y } : mission;
                            showRandomMissionPopup(missionData, timeSlot, index);
                        });
                        
                        // DOM 标记层已移除
                        itemMarkers.push({ type: 'random_missions', index: globalIndex, el: marker });
                        globalIndex++;
                    });
                });
                console.log(`总共创建了 ${globalIndex} 个随机任务DOM标记`);
            }
        }

        // DOM 标记已移除，无需更新位置
        function updateItemMarkersPosition() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // 更新现有标记位置
            itemMarkers.forEach(({ type, index, el }) => {
                // 跳过试点标记类型（Leaflet标记会自动跟随地图）
                if (pilotMarkerTypes.has(type)) return;
                let item;
                if (type === 'treasure_hunt_dba_revolver_random') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.random_clue && itemData.treasure_hunt_dba_revolver.random_clue[index];
                } else if (type === 'treasure_hunt_dba_revolver_static') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.static_clues && itemData.treasure_hunt_dba_revolver.static_clues[index];
                } else if (type === 'movie_props') {
                    // 电影道具需要根据索引找到对应的项目
                    const mp = itemData.movie_props;
                    const fixedCount = mp.fixed_position?.length || 0;
                    const ponyCount = mp.vehicles?.pony?.length || 0;
                    const rebelCount = mp.vehicles?.rebel?.length || 0;
                    
                    if (index < fixedCount) {
                        item = mp.fixed_position[index];
                    } else if (index < fixedCount + ponyCount) {
                        item = mp.vehicles.pony[index - fixedCount];
                    } else if (index < fixedCount + ponyCount + rebelCount) {
                        item = mp.vehicles.rebel[index - fixedCount - ponyCount];
                    } else {
                        item = mp.vehicles.rumpo[index - fixedCount - ponyCount - rebelCount];
                    }
                } else if (type === 'serial_killer_slasher_first') {
                    // 杀人狂前四条线索
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.first && itemData.serial_killer_slasher.first[index];
                } else if (type === 'serial_killer_slasher_last') {
                    // 杀人狂最后一条线索
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.last && itemData.serial_killer_slasher.last[index];
                } else if (type === 'maude_bounty_area') {
                    // 茉德悬赏区域
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.areas && itemData.maude_bounty_targets.areas[index];
                } else if (type === 'maude_bounty_endpoint') {
                    // 茉德悬赏终点
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.endpoints && itemData.maude_bounty_targets.endpoints[index];
                } else if (type === 'police_rescue_patrick_mcreary_spawn') {
                    // 帕特里克救援生成点
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.spawn && itemData.police_rescue_patrick_mcreary.spawn[index];
                } else if (type === 'police_rescue_patrick_mcreary_dropoff') {
                    // 帕特里克救援送达点
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.dropoff && itemData.police_rescue_patrick_mcreary.dropoff[index];
                } else if (type === 'random_missions') {
                    // 随机任务需要特殊处理，因为数据结构是嵌套的
                    const randomMissions = itemData.random_missions || {};
                    let currentIndex = 0;
                    
                    // 遍历所有时间段找到对应的任务
                    for (const timeSlot of Object.keys(randomMissions)) {
                        const missions = randomMissions[timeSlot] || [];
                        for (let i = 0; i < missions.length; i++) {
                            if (currentIndex === index) {
                                const mission = missions[i];
                                if (Array.isArray(mission) && mission.length >= 2) {
                                    item = { x: mission[0], y: mission[1] };
                                }
                                break;
                            }
                            currentIndex++;
                        }
                        if (item) break;
                    }
                } else if (type === 'smuggler_plane') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_route') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && group.routes[routeIndex][0] && group.routes[routeIndex][0].length === 2) {
                        const x = group.routes[routeIndex][0][0];
                        const y = group.routes[routeIndex][0][1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_line') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && group.routes && group.routes[routeIndex] && group.routes[routeIndex][0]) {
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const rtX = group.routes[routeIndex][0][0];
                        const rtY = group.routes[routeIndex][0][1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const rPX = (rtX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const rPY = (GAME_TOP - rtY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const dx = rPX - tpPX;
                        const dy = rPY - tpPY;
                        const length = Math.sqrt(dx*dx + dy*dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        el.style.left = `${tpPX}px`;
                        el.style.top = `${tpPY}px`;
                        el.style.width = `${length}px`;
                        el.style.transform = `rotate(${angle}deg)`;
                    }
                    return;
                } else if (type === 'smuggler_trail') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_trail_route') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && group.routes[routeIndex][0] && group.routes[routeIndex][0].length === 2) {
                        const x = group.routes[routeIndex][0][0];
                        const y = group.routes[routeIndex][0][1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                        // 确保数字标记的样式正确
                        el.style.width = '24px';
                        el.style.height = '24px';
                        el.style.borderRadius = '50%';
                        el.style.backgroundColor = '#2196F3';
                        el.style.border = '2px solid #fff';
                        el.style.display = 'flex';
                        el.style.alignItems = 'center';
                        el.style.justifyContent = 'center';
                        el.style.fontSize = '12px';
                        el.style.fontWeight = 'bold';
                        el.style.color = '#fff';
                        el.textContent = String(routeIndex + 1);
                    }
                    return;
                } else if (type === 'smuggler_trail_line') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && group.routes && group.routes[routeIndex] && group.routes[routeIndex][0]) {
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const rtX = group.routes[routeIndex][0][0];
                        const rtY = group.routes[routeIndex][0][1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const rPX = (rtX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const rPY = (GAME_TOP - rtY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        
                        let startX, startY;
                        
                        if (routeIndex === 0) {
                            // 第一个route点：从triggerpoint连接
                            startX = tpPX;
                            startY = tpPY;
                        } else {
                            // 后续route点：从前一个route点连接
                            const prevRoute = group.routes[routeIndex - 1];
                            if (Array.isArray(prevRoute) && prevRoute[0] && prevRoute[0].length === 2) {
                                const prevX = prevRoute[0][0];
                                const prevY = prevRoute[0][1];
                                const prevPercentX = (prevX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                                const prevPercentY = (GAME_TOP - prevY) / (GAME_TOP - GAME_BOTTOM);
                                startX = prevPercentX * totalWidth;
                                startY = prevPercentY * totalHeight;
                            } else {
                                return; // 如果前一个route无效，跳过
                            }
                        }
                        
                        const dx = rPX - startX;
                        const dy = rPY - startY;
                        const length = Math.sqrt(dx*dx + dy*dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        el.style.left = `${startX}px`;
                        el.style.top = `${startY}px`;
                        el.style.width = `${length}px`;
                        el.style.transform = `rotate(${angle}deg)`;
                    }
                    return;
                } else if (type === 'convoy') {
                    const group = itemData.convoy && itemData.convoy[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length >= 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'convoy_final') {
                    const final = itemData.convoy_final && itemData.convoy_final[index];
                    if (final && typeof final.x !== 'undefined' && typeof final.y !== 'undefined') {
                        const percentX = (final.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - final.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'convoy_line') {
                    const group = itemData.convoy && itemData.convoy[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    const segmentIndex = el.dataset && el.dataset.segmentIndex ? parseInt(el.dataset.segmentIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && Array.isArray(group.routes[routeIndex]) && group.routes[routeIndex].length > segmentIndex + 1) {
                        const route = group.routes[routeIndex];
                        const startPoint = route[segmentIndex];
                        const endPoint = route[segmentIndex + 1];
                        if (Array.isArray(startPoint) && startPoint.length === 2 && Array.isArray(endPoint) && endPoint.length === 2) {
                            const startPercentX = (startPoint[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const startPercentY = (GAME_TOP - startPoint[1]) / (GAME_TOP - GAME_BOTTOM);
                            const startX = startPercentX * totalWidth;
                            const startY = startPercentY * totalHeight;
                            
                            const endPercentX = (endPoint[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const endPercentY = (GAME_TOP - endPoint[1]) / (GAME_TOP - GAME_BOTTOM);
                            const endX = endPercentX * totalWidth;
                            const endY = endPercentY * totalHeight;
                            
                            const dx = endX - startX;
                            const dy = endY - startY;
                            const length = Math.sqrt(dx*dx + dy*dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            el.style.left = `${startX}px`;
                            el.style.top = `${startY}px`;
                            el.style.width = `${length}px`;
                            el.style.height = '3px';
                            el.style.background = 'red';
                            el.style.transformOrigin = '0 0';
                            el.style.transform = `rotate(${angle}deg)`;
                        }
                    }
                    return;
                } else if (type === 'armored_truck') {
                    const armoredTruck = itemData.armored_truck && itemData.armored_truck[index];
                    if (armoredTruck && typeof armoredTruck.x !== 'undefined' && typeof armoredTruck.y !== 'undefined') {
                        const percentX = (armoredTruck.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - armoredTruck.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'happy_holidays_hauler') {
                    const group = itemData.happy_holidays_hauler && itemData.happy_holidays_hauler[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'happy_holidays_hauler_line') {
                    const group = itemData.happy_holidays_hauler && itemData.happy_holidays_hauler[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    const routeSegment = el.dataset && el.dataset.routeSegment ? parseInt(el.dataset.routeSegment, 10) : -1;
                    
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && 
                        group.routes && group.routes[routeIndex] && Array.isArray(group.routes[routeIndex])) {
                        
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        
                        if (routeSegment === -1) {
                            // 连接triggerpoint到第一个route点
                            const route = group.routes[routeIndex];
                            if (route[0] && Array.isArray(route[0]) && route[0].length === 2) {
                                const routeX = route[0][0];
                                const routeY = route[0][1];
                                const routePX = (routeX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const routePY = (GAME_TOP - routeY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                const dx = routePX - tpPX;
                                const dy = routePY - tpPY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                el.style.left = `${tpPX}px`;
                                el.style.top = `${tpPY}px`;
                                el.style.width = `${length}px`;
                                el.style.transform = `rotate(${angle}deg)`;
                            }
                        } else {
                            // 连接route点之间的线条
                            const route = group.routes[routeIndex];
                            if (route[routeSegment] && route[routeSegment + 1] && 
                                Array.isArray(route[routeSegment]) && Array.isArray(route[routeSegment + 1]) && 
                                route[routeSegment].length === 2 && route[routeSegment + 1].length === 2) {
                                
                                const x1 = route[routeSegment][0];
                                const y1 = route[routeSegment][1];
                                const x2 = route[routeSegment + 1][0];
                                const y2 = route[routeSegment + 1][1];
                                
                                const px1 = (x1 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const py1 = (GAME_TOP - y1) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                const px2 = (x2 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const py2 = (GAME_TOP - y2) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                const dx = px2 - px1;
                                const dy = py2 - py1;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                el.style.left = `${px1}px`;
                                el.style.top = `${py1}px`;
                                el.style.width = `${length}px`;
                                el.style.transform = `rotate(${angle}deg)`;
                            }
                        }
                    }
                    return;
                } else {
                    item = itemData[type] && itemData[type][index];
                }
                if (!item || typeof item.x === 'undefined' || typeof item.y === 'undefined') return;

                const percentX = (item.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                const percentY = (GAME_TOP - item.y) / (GAME_TOP - GAME_BOTTOM);

                const itemX = percentX * totalWidth;
                const itemY = percentY * totalHeight;

                el.style.left = `${itemX}px`;
                el.style.top = `${itemY}px`;
                
                // 特殊处理帮派攻击圆圈大小更新
                if (type === 'gang_attacks') {
                    // 计算游戏坐标100单位对应的像素大小
                    const gameRadius = 100; // 游戏坐标半径
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // 直径
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
                
                // 特殊处理茉德悬赏目标圆圈大小更新
                if (type === 'maude_bounty_area') {
                    // 计算游戏坐标185单位对应的像素大小
                    const gameRadius = 185; // 游戏坐标半径
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // 直径
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
            });
        }

        // === 车行标记功能 ===
        
        // 初始化车行标记
        function initDealershipMarkers() {
            createDealershipMarkers();
            console.log('车行标记初始化完成');
        }
        
        // 创建车行标记
        function createDealershipMarkers() {
            // 已迁移到Leaflet的车行类型，跳过DOM标记创建
            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
            
            Object.keys(dealershipData).forEach(dealershipType => {
                // 跳过已迁移的车行类型
                if (migratedDealerships.includes(dealershipType)) {
                    return;
                }
                
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord, index) => {
                    const marker = createDealershipMarker(coord[0], coord[1], dealership, dealershipType);
                    dealershipMarkers.push(marker);
                    // DOM 标记层已移除
                    // 设置初始可见性，防止创建后需缩放才显示
                    try {
                        marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                    } catch (e) {
                        marker.style.display = 'block';
                    }
                });
            });
            updateDealershipMarkers();
        }
        
        // 创建单个车行标记
        function createDealershipMarker(x, y, dealership, dealershipType) {
            const marker = document.createElement('div');
            marker.className = 'dealership-marker';
            marker.dataset.dealershipType = dealershipType;
            marker.style.cssText = `
                position: absolute;
                transform: translate(-50%, -50%);
                z-index: 680;
                cursor: pointer;
                transition: transform 0.2s ease;
            `;
            
            const img = document.createElement('img');
            img.src = itemIcons[dealership.icon];
            img.style.cssText = `
                width: 40px;
                height: 40px;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                
            `;
            
            marker.appendChild(img);
            
            // 添加悬停效果
            marker.addEventListener('mouseenter', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1.2)';
            });
            
            marker.addEventListener('mouseleave', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            
            // 添加点击事件
            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('dealership marker clicked:', dealershipType, dealership.name);
                showDealershipVehicles(dealershipType, dealership.name);
            });
            
            return marker;
        }
        
        // 更新车行标记位置
        function updateDealershipMarkers() {
            const z = map.getZoom();
            let level = getLevelByZoom(z);
            // 如果没有精确匹配的缩放级别，选取最近的一个，避免在小数缩放时无法更新标记位置
            if (!level) {
                if (typeof zoomLevels !== 'undefined' && Array.isArray(zoomLevels) && zoomLevels.length > 0) {
                    level = zoomLevels.reduce((best, cur) => Math.abs(cur.zoom - z) < Math.abs(best.zoom - z) ? cur : best, zoomLevels[0]);
                } else {
                    return;
                }
            }
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            let markerIndex = 0;
            // 已迁移到Leaflet的车行类型，跳过DOM标记更新
            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
            
            Object.keys(dealershipData).forEach(dealershipType => {
                // 跳过已迁移的车行类型
                if (migratedDealerships.includes(dealershipType)) {
                    return;
                }
                
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord) => {
                    if (markerIndex < dealershipMarkers.length) {
                        const marker = dealershipMarkers[markerIndex];
                        
                        const percentX = (coord[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - coord[1]) / (GAME_TOP - GAME_BOTTOM);
                        
                        const markerX = percentX * totalWidth;
                        const markerY = percentY * totalHeight;
                        
                        marker.style.left = `${markerX}px`;
                        marker.style.top = `${markerY}px`;
                        // 根据侧边栏选择显示或隐藏车行标记
                        try {
                            marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                        } catch (e) {
                            // 如果 activeItemTypes 未定义，默认显示
                            marker.style.display = 'block';
                        }

                        markerIndex++;
                    }
                });
            });
        }
        
        // 显示车行车辆信息
        async function showDealershipVehicles(dealershipType, dealershipName) {
            try {
                let apiEndpoint = '';
                let vehicleTypes = [];
                
                // 根据车行类型确定 API 端点和车辆类型
                switch(dealershipType) {
                    case 'casino':
                        apiEndpoint = 'https://api-gta.antwen.com/api/dealerships/casino-prize';
                        vehicleTypes = ['赌场奖品载具'];
                        break;
                    case 'car_meet':
                        // 车友会包含多种车辆类型
                        await showCarMeetVehicles(dealershipName);
                        return;
                    case 'premium_deluxe_motorsport':
                        // 西米恩使用多车辆API
                        await showSimeonVehicles(dealershipName);
                        return;
                    case 'luxury_autos':
                        // 豪华车行使用多车辆API
                        await showLuxuryVehicles(dealershipName);
                        return;
                    default:
                        console.error('未知的车行类型:', dealershipType);
                        return;
                }
                
                // 获取单个车行的车辆信息（仅赌场）
                const response = await fetch(apiEndpoint);
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicle) {
                    showVehiclePopup([result.data.vehicle], dealershipName, vehicleTypes[0]);
                } else {
                    console.error('获取车辆信息失败:', result.error);
                    alert('获取车辆信息失败，请稍后重试');
                }
            } catch (error) {
                console.error('API请求错误:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示车友会车辆（包含多种类型）
        async function showCarMeetVehicles(dealershipName) {
            try {
                const endpoints = [
                    { url: 'https://api-gta.antwen.com/api/dealerships/car-meet-prize', name: '车友会奖品载具' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/promo-test', name: '测试载具' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/hsw-test', name: 'HSW载具' }
                ];
                
                const vehicles = [];
                const vehicleTypes = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url);
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            if (result.data.vehicle) {
                                // 单个车辆
                                vehicles.push(result.data.vehicle);
                                vehicleTypes.push(endpoint.name);
                            } else if (result.data.vehicles && Array.isArray(result.data.vehicles)) {
                                // 多个车辆
                                result.data.vehicles.forEach(vehicle => {
                                    vehicles.push(vehicle);
                                    vehicleTypes.push(endpoint.name);
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`获取${endpoint.name}失败:`, error);
                    }
                }
                
                if (vehicles.length > 0) {
                    showVehiclePopup(vehicles, dealershipName, vehicleTypes);
                } else {
                    alert('没有获取到任何车辆信息');
                }
            } catch (error) {
                console.error('获取车友会车辆信息失败:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示西米恩车辆
        async function showSimeonVehicles(dealershipName) {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/simeon-test');
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicles) {
                    showVehiclePopup(result.data.vehicles, dealershipName, '西米恩测试载具');
                } else {
                    console.error('获取西米恩车辆信息失败:', result.error);
                    alert('获取车辆信息失败，请稍后重试');
                }
            } catch (error) {
                console.error('获取西米恩车辆信息失败:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示豪华车辆
        async function showLuxuryVehicles(dealershipName) {
            console.log('调用showLuxuryVehicles，车行名称:', dealershipName);
            try {
                console.log('正在请求豪华车辆API...');
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/luxury-showcase');
                console.log('API响应状态:', response.status);
                const result = await response.json();
                console.log('API响应数据:', result);
                
                if (result.success && result.data && result.data.vehicles) {
                    console.log('车辆数据:', result.data.vehicles);
                    showVehiclePopup(result.data.vehicles, dealershipName, '豪华车展厅');
                } else {
                    console.error('获取豪华车辆信息失败:', result.error || result);
                    alert(`获取车辆信息失败: ${result.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('获取豪华车辆信息失败:', error);
                alert(`网络请求失败: ${error.message}`);
            }
        }
        
        // 显示车辆弹窗
        function showVehiclePopup(vehicles, dealershipName, vehicleTypes) {
            console.log('showVehiclePopup调用参数:', {vehicles, dealershipName, vehicleTypes});
            console.log('vehicles数组长度:', vehicles ? vehicles.length : 'vehicles为空');
            
            const popup = document.createElement('div');
            popup.className = 'vehicle-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FFD700;
                border-radius: 15px;
                padding: 25px;
                z-index: 10000;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;
            
            let popupContent = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #333; border-bottom: 2px solid #FFD700; padding-bottom: 10px;">
                    🏦 ${dealershipName}车行
                </div>
            `;
            
            vehicles.forEach((vehicle, index) => {
                const vehicleType = Array.isArray(vehicleTypes) ? vehicleTypes[index] : vehicleTypes;
                const imageUrl = vehicle.img ? `https://gta-images.antwen.com/${vehicle.img.replace(/^\/+/, '')}` : '';
                const detailUrl = vehicle.modelHash ? `/vehicles#/vehicle/${vehicle.modelHash.toLowerCase()}` : '';
                
                // 处理涂装价格显示
                let liveryPriceDisplay = '';
                if (vehicle.liveryPrice === 'free') {
                    liveryPriceDisplay = '<span style="color: #e91e63; font-weight: bold;">✨ 隐藏涂装</span>';
                } else if (vehicle.liveryPrice) {
                    liveryPriceDisplay = `<span style="color: #4caf50; font-weight: bold;">涂装价格: ${vehicle.liveryPrice}</span>`;
                }
                
                popupContent += `
                    <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #FFD700;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 18px;">
                            🚗 ${vehicleType}
                        </div>
                        <div style="color: #333; font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                            ${vehicle.name || '未知车辆'}
                        </div>
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 alt="${vehicle.name}" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        ` : ''}
                        <div style="margin: 10px 0; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>车类:</strong> ${vehicle.class || '未知'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>价格:</strong> ${vehicle.price || '未知'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>状态:</strong> ${vehicle.isPurchaseable ? '可购买' : '不可购买'}
                            </div>
                        </div>
                        ${vehicle.liveryName ? `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>涂装:</strong> ${vehicle.liveryName}<br>
                                ${liveryPriceDisplay}
                            </div>
                        ` : ''}
                        ${detailUrl ? `
                            <a href="${detailUrl}" target="_blank" 
                               style="display: inline-block; margin-top: 10px; padding: 10px 20px; 
                                      background: #2196F3; color: white; text-decoration: none; 
                                      border-radius: 6px; font-weight: bold; transition: background 0.3s;"
                               onmouseover="this.style.background='#1976D2'" 
                               onmouseout="this.style.background='#2196F3'">
                                🔍 车辆详细信息
                            </a>
                        ` : ''}
                    </div>
                `;
            });
            
            popupContent += `
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-vehicle-popup" 
                            style="padding: 12px 24px; 
                                   background: #f44336; color: white; 
                                   border: none; border-radius: 6px; 
                                   cursor: pointer; font-size: 16px;
                                   font-weight: bold; transition: background 0.3s;">
                        关闭
                    </button>
                </div>
            `;
            
            popup.innerHTML = popupContent;
            
            // 添加关闭按钮事件监听
            popup.querySelector('#close-vehicle-popup').addEventListener('click', () => {
                popup.remove();
            });
            
            // 添加到页面
            document.body.appendChild(popup);
            
            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 检查特技跳跃点点击事件（用于标记元素直接点击）
        function checkStuntJumpsClick(e) {
            // 获取标记元素
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // 获取索引
            const index = parseInt(marker.dataset.index);
            
            // 显示物品信息
            if (itemData.stunt_jumps && itemData.stunt_jumps[index]) {
                showItemInfo(itemData.stunt_jumps[index], 'stunt_jumps', index);
                
                // 显示特技跳跃点图片弹窗
                showStuntJumpsImage(index);
            }
        }

        // 显示物品信息
        function showItemInfo(item, type, index) {
            const titleMap = {
                stunt_jumps: '特技跳跃点',
                hidden_caches: '隐藏包裹',
                shipwrecked: '沉船',
                gun_van: '武器厢型车',
                ls_tags: 'LS涂鸦',
                spray: '喷罐位置',
                street_dealers: '街头毒贩',
                playing_cards: '纸牌',
                smoke_on_the_water_product: '吞云吐雾馆产品',
                action_figures: '手办',
                yuanbao: '元宝',
                ld_organics_products: '有机坊产品',
                signal_jammers: '信号干扰器',
                jack_o_lanterns: '南瓜灯',
                payphone_hits: '电话暗杀',
                golf_holes: '高尔夫球洞',
                snowmen: '雪人',
                rc_time_trial: 'RC时间挑战赛',
                bike_time_trial: '自行车时间挑战赛',
                skydives: '跳伞',
                gang_attacks: '帮派攻击',
                ghosts3: '幽灵曝光2025',
                treasure_hunt_dba_revolver: '左轮寻宝',
                treasure_hunt_dba_revolver_random: '左轮寻宝 - 随机线索',
                treasure_hunt_dba_revolver_static: '左轮寻宝 - 固定线索',
                wea: '威泽尔大楼枪战',
                ppl: '陆地迷幻仙人掌',
                ppw: '水下迷幻仙人掌',
                metro: '地铁站',
                police: '警察局',
                v_telescopes: '望远镜',
                fire_stations: '消防局',
                hospitals: '医院',
                clothing: '服装店',
                tattoos: '纹身店',
                barbers: '理发店',
                ammunation: '武装国度',
                mod_shop: '洛圣都改车王',
                car_wash: '洗车店',
                shops_to_rob: '可抢劫的商店',
                gas_stations: '加油站',
                atms: 'ATM机',
                vend_sprunk: '霜碧售卖机',
                vend_ecola: '易可乐售卖机',
                // 新增缺失的标记类型标题
                crime_scenes: '犯罪现场',
                stash_houses: '藏匿屋',
                madrazo_hits: '玛德拉索雇凶',
                police_rescue_patrick_mcreary: '帕特里克救援',
                random_missions: '随机任务',
                drunk_guard: '沉睡的保安',
                community_outreach: '社区边界',
                store_robbery: '商店抢劫',
                armored_truck: '装甲运钞车',
                media_sticks: '媒体记忆棒',
                ufo: 'UFO观光',
                cerberus: '万圣节地狱犬事件'
            };


            // 如果没有有效 item，则不显示小信息面板
            if (!item) {
                itemInfo.style.display = 'none';
                return;
            }

            // 填充小面板文本内容
            const title = titleMap[type] || type;
            const coords = (typeof item.x !== 'undefined' && typeof item.y !== 'undefined') ? `${item.x}, ${item.y}` : (item.coords ? String(item.coords) : '未知');
            const location = item.name || (typeof index !== 'undefined' ? `#${index}` : '未知');
            const details = item.info || item.details || item.description || '无';

            const titleEl = document.getElementById('item-title');
            const coordsEl = document.getElementById('item-coords');
            const locationEl = document.getElementById('item-location');
            const detailsEl = document.getElementById('item-details');

            if (titleEl) titleEl.textContent = title;
            if (coordsEl) coordsEl.textContent = `坐标: ${coords}`;
            if (locationEl) locationEl.textContent = `位置: ${location}`;
            if (detailsEl) detailsEl.textContent = `详细信息: ${details}`;

            // 对于会显示大弹窗/图片的类型，不显示小文本面板，避免重复
            const imageTypes = new Set([
                'ld_organics_products',
                'signal_jammers',
                'playing_cards',
                'smoke_on_the_water_product',
                'action_figures',
                'yuanbao',
                'shipwrecked',
                'payphone_hits',
                'golf_holes',
                'snowmen',
                'dead_drop',
                'stunt_jumps',
                'spray',
                'gang_attacks',
                'ghosts3',
                'treasure_hunt_dba_revolver',
                'treasure_hunt_dba_revolver_random',
                'treasure_hunt_dba_revolver_static',
                'wea',
                'ppl',
                'ppw'
            ]);

            if (!imageTypes.has(type)) {
                itemInfo.style.display = 'block';
            } else {
                // 确保隐藏小面板（大弹窗会同时显示）
                itemInfo.style.display = 'none';
            }

            // 如果是有机坊产品，显示图片弹窗
            if (type === 'ld_organics_products') {
                showOrganicFarmImage(index);
            }
            
            // 如果是信号干扰器，显示图片弹窗
            if (type === 'signal_jammers') {
                showSignalJammerImage(index);
            }
            
            // 如果是纸牌，显示图片弹窗
            if (type === 'playing_cards') {
                showPlayingCardsImage(index);
            }
            
            // 如果是吞云吐雾馆产品，显示图片弹窗
            if (type === 'smoke_on_the_water_product') {
                showSmokeProductPopup(item, index);
            }
            
            // 如果是手办，显示图片弹窗
            if (type === 'action_figures') {
                showActionFiguresImage(index);
            }
            
            // 如果是元宝，显示图片弹窗
            if (type === 'yuanbao') {
                showYuanbaoImage(index);
            }
            
            // 如果是沉船，显示图片弹窗
            if (type === 'shipwrecked') {
                showShipwreckedPopup(item, index);
            }
            
            // 如果是电话暗杀，显示图片弹窗
            if (type === 'payphone_hits') {
                showPayphoneHitsImage(index);
            }
            
            // 如果是高尔夫球洞，显示图片弹窗
            if (type === 'golf_holes') {
                showGolfHolesImage(index);
            }
            
            // 如果是雪人，显示图片弹窗
            if (type === 'snowmen') {
                showSnowmenImage(index);
            }
            
            // 如果是杰拉德包裹，显示增强版弹窗
            if (type === 'dead_drop') {
                showDeadDropPopup(item, index);
            }
            
            // 如果是帮派攻击，显示弹窗
            if (type === 'gang_attacks') {
                showGangAttackPopup(item, index);
            }

            // 如果是幽灵曝光，显示弹窗
            if (type === 'ghosts3') {
                showGhosts3Popup(item, index);
            }

            // 如果是左轮寻宝线索，显示弹窗
            if (type === 'treasure_hunt_dba_revolver_random') {
                showTreasureHuntPopup(item, index, 'random');
            }
            if (type === 'treasure_hunt_dba_revolver_static') {
                showTreasureHuntPopup(item, index, 'static');
            }
            
            // 如果是威泽尔大楼枪战，显示弹窗
            if (type === 'wea') {
                showWeaPopup(item, index);
            }
            
            // 如果是陆地迷幻仙人掌，显示弹窗
            if (type === 'ppl') {
                showPplPopup(item, index);
            }
            
            // 如果是水下迷幻仙人掌，显示弹窗
            if (type === 'ppw') {
                showPpwPopup(item, index);
            }
            
            // 如果是洛圣都杀人狂线索，显示弹窗
            if (type === 'serial_killer_slasher_first') {
                showSlasherPopup(item, index, 'first');
            }
            if (type === 'serial_killer_slasher_last') {
                showSlasherPopup(item, index, 'last');
            }
            
            // 如果是电影道具，显示弹窗
            if (type === 'movie_props') {
                // 电影道具需要根据索引找到对应的项目
                const mp = itemData.movie_props;
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                
                let subtype;
                if (index < fixedCount) {
                    subtype = 'fixed_position';
                } else if (index < fixedCount + ponyCount) {
                    subtype = 'pony';
                } else if (index < fixedCount + ponyCount + rebelCount) {
                    subtype = 'rebel';
                } else {
                    subtype = 'rumpo';
                }
                
                showMoviePropsPopup(item, index, subtype);
            }
        }

        function hideItemInfo() {
            itemInfo.style.display = 'none';
        }

        // RC时间挑战赛弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showRCTimeTrialPopup(item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.rc-time-trial-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];
            const totalCount = 1; // 固定为1个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🏁 RC时间挑战赛 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'rc-time-trial-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FF5722;">
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                    
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">⏱️ 时间要求</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #fff3e0; padding: 8px; border-radius: 4px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #fff3e0; border-radius: 6px; color: #e65100; font-size: 14px; line-height: 1.4;">
                    🏆 挑战提示：使用RC车在限定时间内完成赛道！
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-rc-time-trial-btn');
            const hideBtn = popup.querySelector('#hide-rc-time-trial-btn');
            const showBtn = popup.querySelector('#show-rc-time-trial-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('rc_time_trial', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🏁 RC时间挑战赛 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateRCTimeTrialSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🏁 RC时间挑战赛 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateRCTimeTrialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 兼容：旧调用别名（修复 ReferenceError）
        function showRCTimeTrialImage(index) {
            const item = (itemData.rc_time_trial && itemData.rc_time_trial[index]) || null;
            if (!item) return;
            showRCTimeTrialPopup(item, index);
        }

        // 自行车时间挑战赛弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showBikeTimeTrialPopup(item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.bike-time-trial-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];
            const totalCount = 1; // 固定为1个

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🚴 自行车时间挑战赛 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'bike-time-trial-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                    
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">⏱️ 时间要求</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #e8f5e8; padding: 8px; border-radius: 4px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #e8f5e8; border-radius: 6px; color: #2e7d32; font-size: 14px; line-height: 1.4;">
                    🏆 挑战提示：使用自行车在限定时间内完成赛道！
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-bike-time-trial-btn');
            const hideBtn = popup.querySelector('#hide-bike-time-trial-btn');
            const showBtn = popup.querySelector('#show-bike-time-trial-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('bike_time_trial', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🚴 自行车时间挑战赛 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateBikeTimeTrialSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🚴 自行车时间挑战赛 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateBikeTimeTrialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 兼容：旧调用别名（修复 ReferenceError）
        function showBikeTimeTrialImage(index) {
            const item = (itemData.bike_time_trial && itemData.bike_time_trial[index]) || null;
            if (!item) return;
            showBikeTimeTrialPopup(item, index);
        }

        // 信号干扰器弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSignalJammerImage(index) {
            // 序号从1开始
             const sequenceNumber = index + 1;
             // 1-9使用单个数字，10+使用两位数
             const paddedNumber = sequenceNumber < 10 ? sequenceNumber.toString() : sequenceNumber.toString().padStart(2, '0');
             const imageUrl = `https://gta-maps.antwen.com/collectibles_images/signal_jammers/signal_jammers_${paddedNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.signal-jammer-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `📡 信号干扰器 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'signal-jammer-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="信号干扰器图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: var(--gta-primary); margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: var(--gta-text); font-size: 14px; line-height: 1.4;">
                        消灭全部的50个干扰器可解锁赌场豪劫隐藏黑客：阿维·施瓦兹曼
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-signal-jammer-btn');
            const hideBtn = popup.querySelector('#hide-signal-jammer-btn');
            const showBtn = popup.querySelector('#show-signal-jammer-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'signal-jammer-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('signal_jammers', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `📡 信号干扰器 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSignalJammersSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `📡 信号干扰器 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSignalJammersSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到信号干扰器标记
        function applySignalJammersVisibilityCache() {
            const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('signal_jammers');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用信号干扰器可见性缓存');
                return true;
            }
            return false;
        }

        // 显示南瓜灯图片弹窗（改为纸牌样式，保留原内容）
        function showJackOLanternImage(index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/lantern/lantern_${sequenceNumber.toString().padStart(2, '0')}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.jack-o-lantern-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数（总数为物品总数）
            const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
            // 优先使用数据总数
            const totalCount = Array.isArray(window.itemData?.jack_o_lanterns)
                ? window.itemData.jack_o_lanterns.length
                : (Array.isArray(markers) ? markers.length : 0);

            let hiddenCount = 0;
            if (Array.isArray(markers) && markers.length > 0) {
                markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') hiddenCount++;
                    }
                });
            } else {
                // 从缓存读取隐藏计数作为回退
                const cachedCounter = CounterCache.getCounter('jack_o_lanterns');
                hiddenCount = cachedCounter.hidden || 0;
            }

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            } else {
                // 从可见性缓存读取当前标记状态
                const visibilityMap = VisibilityCache.loadVisibility('jack_o_lanterns');
                isCurrentHidden = visibilityMap[index] === true;
            }

            const title = `🎃 南瓜灯 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗（采用纸牌样式）
            const popup = document.createElement('div');
            popup.className = 'jack-o-lantern-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="南瓜灯 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(242, 111, 23, 0.12); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(242, 111, 23, 0.12); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #f26f17; margin-bottom: 5px;">🎯 收集奖励</div>
                    收集全部南瓜灯可获得特殊万圣节奖励！
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-jack-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-jack-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-jack-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-jack-btn');
            const hideBtn = popup.querySelector('#hide-jack-btn');
            const showBtn = popup.querySelector('#show-jack-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'jack-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('jack_o_lanterns', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🎃 南瓜灯 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                });
            }

            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🎃 南瓜灯 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到南瓜灯标记
        function applyJackOLanternsVisibilityCache() {
            const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('jack_o_lanterns');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用南瓜灯可见性缓存');
                return true;
            }
            return false;
        }

        // 纸牌弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showPlayingCardsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/playing_cards/playing_cards_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.playing-cards-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🃏 纸牌 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'playing-cards-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="纸牌 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">🎯 收集奖励</div>
                        收集所有54张纸牌可获得：特殊服装奖励赌场豪赌客套装
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-playing-cards-btn');
            const hideBtn = popup.querySelector('#hide-playing-cards-btn');
            const showBtn = popup.querySelector('#show-playing-cards-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'playing-cards-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('playing_cards', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🃏 纸牌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePlayingCardsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🃏 纸牌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePlayingCardsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 增强版残缺信件模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 letter_scraps 增加一个计数器占位
        function attachLetterScrapsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.letter-scraps-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'letter-scraps-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateLetterScrapsSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateLetterScrapsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-letter_scraps + label .letter-scraps-counter');
                if (!counterEl) return;

                const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
                const total = Array.isArray(window.itemData?.letter_scraps) ? window.itemData.letter_scraps.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                if (!hasRenderedMarker) {
                    const cachedCounter = CounterCache.getCounter('letter_scraps');
                    hidden = cachedCounter.hidden || 0;
                }

                CounterCache.updateCounter('letter_scraps', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新残缺信件计数器失败:', e);
            }
        }

        // 残缺信件弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showLetterScrapsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/letter_scraps/letter_scraps_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.letter-scraps-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `📜 残缺信件 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'letter-scraps-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="残缺信件 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">🎯 收集奖励</div>
                    游戏中总共有 50 个残缺信件。要收集这些信件，您必须完成主线任务有借有还。<br>
                    每个角色都可以拾取残片。小查还可以帮助富兰克林找到它附近的残片。收集所有 50 个残缺信件是 100% 完成度的要求之一。<br><br>
                    集齐残缺信件，揭示女演员里奥诺拉·约翰逊谋杀案的真相。您将解锁陌生人与怪咖任务好麦坞明日之星（富兰克林）。完成后，您将获得一个成就。完成此任务是 100% 完成度的要求之一。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-letter-scraps-btn');
            const hideBtn = popup.querySelector('#hide-letter-scraps-btn');
            const showBtn = popup.querySelector('#show-letter-scraps-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'letter-scraps-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    overlay.addEventListener('click', () => overlay.remove());
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('letter_scraps', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `📜 残缺信件 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateLetterScrapsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `📜 残缺信件 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateLetterScrapsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到残缺信件标记
        function applyLetterScrapsVisibilityCache() {
            const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('letter_scraps');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用残缺信件可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 增强版隐藏包裹（线下）模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 sp_hidden_packages 增加一个计数器占位
        function attachSpHiddenPackagesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.sp-hidden-packages-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'sp-hidden-packages-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSpHiddenPackagesSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSpHiddenPackagesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-sp_hidden_packages + label .sp-hidden-packages-counter');
                if (!counterEl) return;

                // 获取隐藏包裹标记
                const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
                const total = Array.isArray(window.itemData?.sp_hidden_packages) ? window.itemData.sp_hidden_packages.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('sp_hidden_packages');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('sp_hidden_packages', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新隐藏包裹（线下）计数器失败:', e);
            }
        }

        // 隐藏包裹（线下）弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSpHiddenPackagesImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/sp_hidden_packages/sp_hidden_packages_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.sp-hidden-packages-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // 获取当前包裹的描述信息
            const item = window.itemData?.sp_hidden_packages?.[index];
            const description = item?.description || '';
            let contentText = description;
            
            // 如果描述包含trevor，添加特殊说明
            if (description.toLowerCase().includes('trevor')) {
                contentText += '\n\n在崔佛带过 4 名搭车人（不是带人 4 次。一次带来 2 人，进度加 2）到利他营地后，与邪教徒发生枪战后解锁。';
            }

            const title = `📦 隐藏包裹（线下） #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'sp-hidden-packages-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;" id="sp-hidden-packages-title">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="隐藏包裹（线下） #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"/>
                <div style="display: none; padding: 40px; color: var(--gta-text-secondary); font-style: italic; text-align: center;">
                    图片加载失败
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">📍 位置信息</div>
                    ${contentText || '可在上图位置找到！'}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="sp-hidden-packages-hide-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="sp-hidden-packages-show-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="sp-hidden-packages-close-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#sp-hidden-packages-close-btn');
            const hideBtn = popup.querySelector('#sp-hidden-packages-hide-btn');
            const showBtn = popup.querySelector('#sp-hidden-packages-show-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('#sp-hidden-packages-title');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'sp-hidden-packages-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('sp_hidden_packages', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `📦 隐藏包裹（线下） #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `📦 隐藏包裹（线下） #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到隐藏包裹（线下）标记
        function applySpHiddenPackagesVisibilityCache() {
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('sp_hidden_packages');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用隐藏包裹（线下）可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 迷幻仙人掌陆地弹窗模板 ====================
        function showPeyoteSpLandImage(index) {
            // 序号从1开始，1-9前面不要出现0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/land_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.peyote-sp-land-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.peyoteSpLandMarkers && window.peyoteSpLandMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🌵 迷幻仙人掌陆地 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-land-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="迷幻仙人掌陆地 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    故事模式中一共有 27 个迷幻仙人掌（21 个在陆地上，6 个在水下）。当您靠近它时，手柄会振动，迷幻仙人掌会发出类似动物叫声的声音。吃下（按下互动键）迷幻仙人掌后，您会变成随机动物中的其中一种。您会一直维持动物形态，除非您：死亡、入水/上岸、按住互动键。您食用所有迷幻仙人掌之后，吃过的迷幻仙人掌将重新启用。食用过所有陆地上的迷幻仙人掌之后，您将可在导演模式选用所有动物。选用其中一个作为演员，您将解锁两个成就。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-peyote-sp-land-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-land-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-land-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-land-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('peyote_sp_land', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🌵 迷幻仙人掌陆地 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePeyoteSpLandSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🌵 迷幻仙人掌陆地 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePeyoteSpLandSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 迷幻仙人掌鸟类弹窗模板 ====================
        function showPeyoteSpAirImage(index) {
            // 序号从1开始，1-9前面不要出现0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/air_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.peyote-sp-air-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.peyoteSpAirMarkers && window.peyoteSpAirMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🦅 迷幻仙人掌鸟类 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-air-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="迷幻仙人掌鸟类 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    故事模式中一共有 27 个迷幻仙人掌（21 个在陆地上，6 个在水下）。当您靠近它时，手柄会振动，迷幻仙人掌会发出类似动物叫声的声音。吃下（按下互动键）迷幻仙人掌后，您会变成随机动物中的其中一种。您会一直维持动物形态，除非您：死亡、入水/上岸、按住互动键。您食用所有迷幻仙人掌之后，吃过的迷幻仙人掌将重新启用。食用过所有陆地上的迷幻仙人掌之后，您将可在导演模式选用所有动物。选用其中一个作为演员，您将解锁两个成就。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-peyote-sp-air-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-air-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-air-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-air-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('peyote_sp_air', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🦅 迷幻仙人掌鸟类 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePeyoteSpAirSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🦅 迷幻仙人掌鸟类 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePeyoteSpAirSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 迷幻仙人掌水下弹窗模板 ====================
        function showPeyoteSpWaterImage(index) {
            // 序号从1开始，1-9前面不要出现0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/water_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.peyote-sp-water-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.peyoteSpWaterMarkers && window.peyoteSpWaterMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🌊 迷幻仙人掌水下 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-water-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="迷幻仙人掌水下 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    故事模式中一共有 27 个迷幻仙人掌（21 个在陆地上，6 个在水下）。当您靠近它时，手柄会振动，迷幻仙人掌会发出类似动物叫声的声音。吃下（按下互动键）迷幻仙人掌后，您会变成随机动物中的其中一种。您会一直维持动物形态，除非您：死亡、入水/上岸、按住互动键。您食用所有迷幻仙人掌之后，吃过的迷幻仙人掌将重新启用。食用过所有陆地上的迷幻仙人掌之后，您将可在导演模式选用所有动物。选用其中一个作为演员，您将解锁两个成就。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-peyote-sp-water-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-water-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-water-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-water-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('peyote_sp_water', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🌊 迷幻仙人掌水下 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePeyoteSpWaterSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🌊 迷幻仙人掌水下 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePeyoteSpWaterSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 迷幻仙人掌金色弹窗模板 ====================
        function showPeyoteSpSpecialImage(index) {
            // 序号从1开始，1-9前面不要出现0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/special_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.peyote-sp-special-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.peyoteSpSpecialMarkers && window.peyoteSpSpecialMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // 星期几的映射（按横坐标递增）
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const currentWeekDay = weekDays[index] || '未知';

            const title = `✨ 迷幻仙人掌金色 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-special-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="迷幻仙人掌金色 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #FFC107; margin-bottom: 5px;">📅 出现时间：星期${currentWeekDay}</div>
                    金色仙人掌在达成 100% 完成度、完成陌生人与怪咖任务末代巨兽（富兰克林），并吃完所有普通仙人掌后解锁。金色仙人掌将根据游戏中的星期几生成在地图上的不同位置，且仅在大雾天气的早上 530 到 800 期间出现。食用它们会让您变成大脚怪。您同时还会在导演模式中解锁大脚怪。依次从周日到下周六吃下金色仙人掌，您将在变身后看到一具动物或人的尸体。吃下最后一个仙人掌后，您将发现任务末代巨兽中的猎人的尸体。此时，您应该继续使用潜行模式（Ctrl）倾听并继续追踪。您将会找到更多的尸体。最终，您将在汤姆森废车场进行大脚怪大战野兽事件。如果您赢得这场战斗，您将在导演模式中解锁野兽。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-peyote-sp-special-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-special-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-special-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-special-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('peyote_sp_special', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `✨ 迷幻仙人掌金色 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePeyoteSpSpecialSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `✨ 迷幻仙人掌金色 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePeyoteSpSpecialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 迷幻仙人掌计数器函数 ====================
        
        // 迷幻仙人掌陆地计数器
        function updatePeyoteSpLandSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_land + label .peyote-sp-land-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpLandMarkers && window.peyoteSpLandMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_land) ? window.itemData.peyote_sp_land.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('peyote_sp_land');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_land', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新迷幻仙人掌陆地计数器失败:', e);
            }
        }

        // 迷幻仙人掌鸟类计数器
        function updatePeyoteSpAirSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_air + label .peyote-sp-air-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpAirMarkers && window.peyoteSpAirMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_air) ? window.itemData.peyote_sp_air.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('peyote_sp_air');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_air', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新迷幻仙人掌鸟类计数器失败:', e);
            }
        }

        // 迷幻仙人掌水下计数器
        function updatePeyoteSpWaterSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_water + label .peyote-sp-water-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpWaterMarkers && window.peyoteSpWaterMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_water) ? window.itemData.peyote_sp_water.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('peyote_sp_water');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_water', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新迷幻仙人掌水下计数器失败:', e);
            }
        }

        // 迷幻仙人掌金色计数器
        function updatePeyoteSpSpecialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_special + label .peyote-sp-special-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpSpecialMarkers && window.peyoteSpSpecialMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_special) ? window.itemData.peyote_sp_special.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('peyote_sp_special');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_special', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新迷幻仙人掌金色计数器失败:', e);
            }
        }

        // ==================== 增强版宇宙飞船部件模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 spaceship_parts 增加一个计数器占位
        function attachSpaceshipPartsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.spaceship-parts-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'spaceship-parts-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSpaceshipPartsSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSpaceshipPartsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spaceship_parts + label .spaceship-parts-counter');
                if (!counterEl) return;

                // 获取宇宙飞船部件标记
                const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
                const total = Array.isArray(window.itemData?.spaceship_parts) ? window.itemData.spaceship_parts.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('spaceship_parts');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('spaceship_parts', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新宇宙飞船部件计数器失败:', e);
            }
        }

        // 宇宙飞船部件弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSpaceshipPartsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/spaceship_parts/spaceship_parts_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.spaceship-parts-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🛸 宇宙飞船部件 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'spaceship-parts-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="宇宙飞船部件 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">🎯 收集奖励</div>
                    游戏中总共有 50 个宇宙飞船部件，要收集这些部件，您必须完成陌生人与怪咖任务有朋自远方来（富兰克林）。<br>
                    每个角色都可以拾取部件。小查还可以帮助富兰克林找到它附近的部件。收集所有 50 个宇宙飞船部件是 100% 完成度的要求之一。<br><br>
                    收集所有宇宙飞船碎片，您将解锁陌生人与怪咖任务冲向外太空（富兰克林）。完成此任务将解锁一个成就，以及载具太空码头工。此载具会在任意角色车库中的特殊载具菜单中解锁。完成此任务是 100% 完成度的要求之一。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-spaceship-parts-btn');
            const hideBtn = popup.querySelector('#hide-spaceship-parts-btn');
            const showBtn = popup.querySelector('#show-spaceship-parts-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'spaceship-parts-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('spaceship_parts', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🛸 宇宙飞船部件 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSpaceshipPartsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🛸 宇宙飞船部件 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSpaceshipPartsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到宇宙飞船部件标记
        function applySpaceshipPartsVisibilityCache() {
            const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('spaceship_parts');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用宇宙飞船部件可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到纸牌标记
        function applyPlayingCardsVisibilityCache() {
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('playing_cards');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用纸牌可见性缓存');
                return true;
            }
            return false;
        }

        // 应用缓存的可见性状态到元宝标记
        function applyYuanbaoVisibilityCache() {
            const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('yuanbao');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用元宝可见性缓存');
                return true;
            }
            return false;
        }

        // 手办弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showActionFiguresImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/action_figures/action_figures_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.action-figures-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🎭 手办 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'action-figures-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="手办 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(233, 30, 99, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(233, 30, 99, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #E91E63; margin-bottom: 5px;">🎯 收集奖励</div>
                        收集所有手办可获得：特殊载具奖励、游戏币奖励、解锁隐藏成就
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-action-figures-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-action-figures-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-action-figures-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-action-figures-btn');
            const hideBtn = popup.querySelector('#hide-action-figures-btn');
            const showBtn = popup.querySelector('#show-action-figures-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'action-figures-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('action_figures', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🎭 手办 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateActionFiguresSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🎭 手办 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateActionFiguresSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到手办标记
        function applyActionFiguresVisibilityCache() {
            const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('action_figures');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用手办可见性缓存');
                return true;
            }
            return false;
        }

        // 元宝弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showYuanbaoImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/yuanbao/yuanbao_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.yuanbao-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🪙 元宝 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'yuanbao-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="元宝 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #B8860B; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有元宝可获得：<br>
                        • 高额游戏币奖励<br>
                        • 特殊服装奖励<br>
                        • 解锁隐藏成就
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-yuanbao-btn');
            const hideBtn = popup.querySelector('#hide-yuanbao-btn');
            const showBtn = popup.querySelector('#show-yuanbao-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（PC/移动端）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'yuanbao-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('yuanbao', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🪙 元宝 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateYuanbaoSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🪙 元宝 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateYuanbaoSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }


        // 显示电话暗杀图片弹窗
        function showPayphoneHitsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'payphone-hits-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #E91E63;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #C2185B;">
                    📞 电话暗杀 #${sequenceNumber}
                </div>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #E91E63;">
                    <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">🎯 任务说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        需要购买事务所完成一个安保合约解锁
                    </div>
                </div>
                <button id="hide-payphone-hits-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #E91E63; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-payphone-hits-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-payphone-hits-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('payphone_hits') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-payphone-hits-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-payphone-hits-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示高尔夫球洞图片弹窗
        function showGolfHolesImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/golf_holes/golf_holes_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'golf-holes-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #2E7D32;">
                    ⛳ 高尔夫球洞 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="高尔夫球洞 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #2E7D32; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        完成所有高尔夫球洞挑战可获得特殊奖励
                    </div>
                </div>
                <button id="hide-golf-holes-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-golf-holes-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-golf-holes-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('golf_holes') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-golf-holes-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-golf-holes-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 喷罐位置弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSprayImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/spray/spray_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.spray-popup');
            if (existingPopup) existingPopup.remove();

            // 计数器固定为1，隐藏一个标记后隐藏全部图标
            const totalCount = 1;
            
            // 检查当前隐藏状态（从缓存获取）
            const cachedCounter = CounterCache.getCounter('spray');
            const hiddenCount = cachedCounter.hidden || 0;
            const isCurrentHidden = hiddenCount > 0;

            const title = `🎨 喷罐位置 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'spray-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="喷罐位置 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">🎯 收集说明</div>
                    找到喷罐位置，收集喷罐道具！
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-spray-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-spray-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-spray-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-spray-btn');
            const hideBtn = popup.querySelector('#hide-spray-btn');
            const showBtn = popup.querySelector('#show-spray-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'spray-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示所有喷罐标记
            function setAllSprayVisibility(opacity) {
                const markers = (window.sprayMarkers && window.sprayMarkers) || [];
                markers.forEach((marker) => {
                    if (marker && typeof marker.setOpacity === 'function') {
                        marker.setOpacity(opacity);
                    } else if (marker && typeof marker.setStyle === 'function') {
                        marker.setStyle({ opacity });
                    }
                });
                
                // 更新缓存状态 - 固定计数器为1
                const newHiddenCount = opacity === 0.3 ? 1 : 0;
                CounterCache.updateCounter('spray', newHiddenCount, 1);
                VisibilityCache.updateItemVisibility('spray', 0, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setAllSprayVisibility(0.3);
                    titleElement.textContent = `🎨 喷罐位置 #${sequenceNumber} (1/1)`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateSpraySidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setAllSprayVisibility(1);
                    titleElement.textContent = `🎨 喷罐位置 #${sequenceNumber} (0/1)`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateSpraySidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 特技跳跃点弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showStuntJumpsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/stunt_jumps/stunt_jumps_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.stunt-jumps-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🚀 特技跳跃点 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'stunt-jumps-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="特技跳跃点 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(56, 142, 60, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(56, 142, 60, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">🎯 挑战说明</div>
                        驾驶车辆完成特技跳跃，获得高分和奖励！
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-stunt-jumps-btn');
            const hideBtn = popup.querySelector('#hide-stunt-jumps-btn');
            const showBtn = popup.querySelector('#show-stunt-jumps-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'stunt-jumps-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('stunt_jumps', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🚀 特技跳跃点 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateStuntJumpsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🚀 特技跳跃点 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateStuntJumpsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 雪人弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSnowmenImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/snowmen/snowmen_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.snowmen-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `⛄ 雪人 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'snowmen-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="雪人 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(3, 169, 244, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(3, 169, 244, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #0288D1; margin-bottom: 5px;">🎯 收集奖励</div>
                        收集所有雪人可获得冬季主题奖励
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-snowmen-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-snowmen-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-snowmen-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-snowmen-btn');
            const hideBtn = popup.querySelector('#hide-snowmen-btn');
            const showBtn = popup.querySelector('#show-snowmen-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'snowmen-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('snowmen', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `⛄ 雪人 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSnowmenSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `⛄ 雪人 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSnowmenSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 跳伞弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSkydivesPopup(item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.skydives-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
            const totalCount = 10; // 固定10个跳伞位置

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🪂 跳伞挑战 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'skydives-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    🎆 <strong>每日跳伞挑战</strong><br>
                    • 每天共有10个跳伞位置<br>
                    • 完成可获得<strong>经验值</strong>和<strong>游戏币奖励</strong><br>
                    • 从高空跳下，体验极限刺激！
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-skydives-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-skydives-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-skydives-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-skydives-btn');
            const hideBtn = popup.querySelector('#hide-skydives-btn');
            const showBtn = popup.querySelector('#show-skydives-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('skydives', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🪂 跳伞挑战 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSkydivesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🪂 跳伞挑战 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSkydivesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到跳伞标记
        function applySkydivesVisibilityCache() {
            const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('skydives');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用跳伞可见性缓存');
                return true;
            }
            return false;
        }

        // 兼容：旧调用别名（修复 ReferenceError）
        function showSkydivesImage(index) {
            const item = (itemData.skydives && itemData.skydives[index]) || null;
            if (!item) return;
            showSkydivesPopup(item, index);
        }


        // 显示杰拉德包裹图片弹窗
        function showDeadDropImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/dead_drop/dead_drop_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'dead-drop-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #9C6EAF;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #9C6EAF;">
                    📦 杰拉德包裹 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="杰拉德包裹 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9C6EAF;">
                    <div style="font-weight: bold; color: #9C6EAF; margin-bottom: 5px;">🎯 任务说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        杰拉德提供的秘密包裹投递点，完成可获得丰厚奖励
                    </div>
                </div>
                <button id="hide-dead-drop-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #9C6EAF; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-dead-drop-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
                
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-dead-drop-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('dead_drop') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-dead-drop-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-dead-drop-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 有机坊产品弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showOrganicFarmImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            // 修复图片链接逻辑，第1-9个不要带0
            const imageUrl = sequenceNumber <= 9 
                ? `https://gta-maps.antwen.com/collectibles_images/ld_organics/ld_organics_${sequenceNumber}.webp`
                : `https://gta-maps.antwen.com/collectibles_images/ld_organics/ld_organics_${sequenceNumber.toString().padStart(2, '0')}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.organic-farm-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🌿 有机坊产品 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'organic-farm-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="有机坊产品 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 5px;">🎯 收集奖励</div>
                        收集全部有机坊产品可获得特殊衣服和帽子奖励！
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-organic-farm-btn');
            const hideBtn = popup.querySelector('#hide-organic-farm-btn');
            const showBtn = popup.querySelector('#show-organic-farm-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'organic-farm-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ld_organics_products', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🌿 有机坊产品 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateOrganicFarmSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🌿 有机坊产品 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateOrganicFarmSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

    // 顶部 old select 已移除；侧边栏复选框与 reset 按钮管理 activeItemTypes

        // 地图事件
        map.on('move', updateTilePanePosition); // 改为move事件实现实时跟随
        map.on('moveend', updateTilePanePosition);
        map.on('zoom', updateTilePanePosition); // 添加 zoom 事件监听，在缩放过程中实时更新标记位置
        map.on('zoomend', () => {
            const z = map.getZoom();
            const centerPixel = map.project(map.getCenter(), z);
            resetViewForZoom(z, { x: centerPixel.x, y: centerPixel.y });
            updateTilePanePosition();
            probeTilesForStyleAndZoom(currentStyle, z);

        });

        // 地图点击事件 - 检测坐标值
        const mapContainer = document.getElementById('map-container');
        mapContainer.addEventListener('click', (e) => {
            // 获取点击位置相对于地图容器的坐标
            const rect = mapContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            // DOM 标记层已移除，无需读取 transform 偏移
            const translateX = 0;
            const translateY = 0;
            
            // 计算点击位置在瓦片容器中的像素坐标
            const tileX = clickX - translateX;
            const tileY = clickY - translateY;
            
            // 将像素坐标转换为游戏坐标
            const percentX = tileX / totalWidth;
            const percentY = tileY / totalHeight;
            
            const gameX = GAME_LEFT + percentX * (GAME_RIGHT - GAME_LEFT);
            const gameY = GAME_TOP - percentY * (GAME_TOP - GAME_BOTTOM);
            
            console.log('点击坐标:', {
                container: { x: clickX, y: clickY },
                tile: { x: tileX, y: tileY },
                game: { x: gameX.toFixed(2), y: gameY.toFixed(2) }
            });

        });

        // 检测武器厢型车点击
        function checkGunVanClick(clickX, clickY) {
            const GUN_VAN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示武器厢型车（支持多选）
            if (activeItemTypes.has('gun_van') && itemData.gun_van) {
                // 检查点击位置是否在任意武器厢型车附近
                const nearbyVan = itemData.gun_van.find(van => {
                    const distance = Math.sqrt(Math.pow(van.x - clickX, 2) + Math.pow(van.y - clickY, 2));
                    return distance <= GUN_VAN_RADIUS;
                });

                if (nearbyVan) {
                    console.log('点击了武器厢型车附近:', nearbyVan.name);
                    showGunVanWeapons();
                }
            }
        }

        // 检测街头毒贩点击
        function checkStreetDealersClick(clickX, clickY) {
            const STREET_DEALER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示街头毒贩（支持多选）
            if (activeItemTypes.has('street_dealers') && itemData.street_dealers) {
                // 检查点击位置是否在任意街头毒贩附近
                const nearbyDealer = itemData.street_dealers.find(dealer => {
                    const distance = Math.sqrt(Math.pow(dealer.x - clickX, 2) + Math.pow(dealer.y - clickY, 2));
                    return distance <= STREET_DEALER_RADIUS;
                });

                if (nearbyDealer) {
                    const index = itemData.street_dealers.findIndex(dealer => 
                        dealer.x === nearbyDealer.x && dealer.y === nearbyDealer.y
                    );
                    console.log('点击了街头毒贩附近:', nearbyDealer.name);
                    showStreetDealersPopup(nearbyDealer, index);
                }
            }
        }

        // 检测有机坊产品点击
        function checkOrganicFarmClick(clickX, clickY) {
            const ORGANIC_FARM_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示有机坊产品（支持多选）
            if (activeItemTypes.has('ld_organics_products') && itemData.ld_organics_products) {
                // 检查点击位置是否在任意有机坊产品附近
                const nearbyProduct = itemData.ld_organics_products.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= ORGANIC_FARM_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('点击了有机坊产品附近:', nearbyProduct.name);
                    // 找到对应的索引
                    const productIndex = itemData.ld_organics_products.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showOrganicFarmImage(productIndex);
                }
            }
        }

        // 检测信号干扰器点击
        function checkSignalJammerClick(clickX, clickY) {
            const SIGNAL_JAMMER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示信号干扰器（支持多选）
            if (activeItemTypes.has('signal_jammers') && itemData.signal_jammers) {
                // 检查点击位置是否在任意信号干扰器附近
                const nearbyJammer = itemData.signal_jammers.find((jammer, index) => {
                    const distance = Math.sqrt(Math.pow(jammer.x - clickX, 2) + Math.pow(jammer.y - clickY, 2));
                    return distance <= SIGNAL_JAMMER_RADIUS;
                });

                if (nearbyJammer) {
                    console.log('点击了信号干扰器附近:', nearbyJammer.name);
                    // 找到对应的索引
                    const jammerIndex = itemData.signal_jammers.findIndex(jammer => 
                        jammer.x === nearbyJammer.x && jammer.y === nearbyJammer.y
                    );
                    showSignalJammerImage(jammerIndex);
                }
            }
        }

        // 检测南瓜灯点击
        function checkJackOLanternClick(clickX, clickY) {
            const JACK_O_LANTERN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示南瓜灯（支持多选）
            if (activeItemTypes.has('jack_o_lanterns') && itemData.jack_o_lanterns) {
                // 检查点击位置是否在任意南瓜灯附近
                const nearbyLantern = itemData.jack_o_lanterns.find((lantern, index) => {
                    const distance = Math.sqrt(Math.pow(lantern.x - clickX, 2) + Math.pow(lantern.y - clickY, 2));
                    return distance <= JACK_O_LANTERN_RADIUS;
                });

                if (nearbyLantern) {
                    console.log('点击了南瓜灯附近:', nearbyLantern.name);
                    // 找到对应的索引
                    const lanternIndex = itemData.jack_o_lanterns.findIndex(lantern => 
                        lantern.x === nearbyLantern.x && lantern.y === nearbyLantern.y
                    );
                    showJackOLanternImage(lanternIndex);
                }
            }
        }
        
        // 检测LS涂鸦点击
        function checkLSTagsClick(clickX, clickY) {
            const LS_TAGS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示LS涂鸦（支持多选）
            if (activeItemTypes.has('ls_tags') && itemData.ls_tags) {
                // 检查点击位置是否在任意LS涂鸦附近
                const nearbyTag = itemData.ls_tags.find((tag, index) => {
                    const distance = Math.sqrt(Math.pow(tag.x - clickX, 2) + Math.pow(tag.y - clickY, 2));
                    return distance <= LS_TAGS_RADIUS;
                });

                if (nearbyTag) {
                    const index = itemData.ls_tags.findIndex(tag => 
                        tag.x === nearbyTag.x && tag.y === nearbyTag.y
                    );
                    console.log('点击了LS涂鸦附近:', nearbyTag.name || `LS涂鸦 #${nearbyTag.sequenceNumber}`);
                    showLSTagsPopup(nearbyTag, index);
                }
            }
        }
        
        
        // 检测纸牌点击
        function checkPlayingCardsClick(clickX, clickY) {
            const PLAYING_CARDS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示纸牌（支持多选）
            if (activeItemTypes.has('playing_cards') && itemData.playing_cards) {
                // 检查点击位置是否在任意纸牌附近
                const nearbyCard = itemData.playing_cards.find((card, index) => {
                    const distance = Math.sqrt(Math.pow(card.x - clickX, 2) + Math.pow(card.y - clickY, 2));
                    return distance <= PLAYING_CARDS_RADIUS;
                });

                if (nearbyCard) {
                    console.log('点击了纸牌附近:', nearbyCard.name);
                    // 找到对应的索引
                    const cardIndex = itemData.playing_cards.findIndex(card => 
                        card.x === nearbyCard.x && card.y === nearbyCard.y
                    );
                    showPlayingCardsImage(cardIndex);
                }
            }
        }
        
        // 检测吞云吐雾馆产品点击
        function checkSmokeProductClick(clickX, clickY) {
            const SMOKE_PRODUCT_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示吞云吐雾馆产品（支持多选）
            if (activeItemTypes.has('smoke_on_the_water_product') && itemData.smoke_on_the_water_product) {
                // 检查点击位置是否在任意吞云吐雾馆产品附近
                const nearbyProduct = itemData.smoke_on_the_water_product.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= SMOKE_PRODUCT_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('点击了吞云吐雾馆产品附近:', nearbyProduct.name);
                    // 找到对应的索引
                    const productIndex = itemData.smoke_on_the_water_product.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showSmokeProductPopup(nearbyProduct, productIndex);
                }
            }
        }
        
        // 检测手办点击
        function checkActionFiguresClick(clickX, clickY) {
            const ACTION_FIGURES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示手办（支持多选）
            if (activeItemTypes.has('action_figures') && itemData.action_figures) {
                // 检查点击位置是否在任意手办附近
                const nearbyFigure = itemData.action_figures.find((figure, index) => {
                    const distance = Math.sqrt(Math.pow(figure.x - clickX, 2) + Math.pow(figure.y - clickY, 2));
                    return distance <= ACTION_FIGURES_RADIUS;
                });

                if (nearbyFigure) {
                    console.log('点击了手办附近:', nearbyFigure.name);
                    // 找到对应的索引
                    const figureIndex = itemData.action_figures.findIndex(figure => 
                        figure.x === nearbyFigure.x && figure.y === nearbyFigure.y
                    );
                    showActionFiguresImage(figureIndex);
                }
            }
        }
        
        // 检测元宝点击
        function checkYuanbaoClick(clickX, clickY) {
            const YUANBAO_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示元宝（支持多选）
            if (activeItemTypes.has('yuanbao') && itemData.yuanbao) {
                // 检查点击位置是否在任意元宝附近
                const nearbyYuanbao = itemData.yuanbao.find((yuanbao, index) => {
                    const distance = Math.sqrt(Math.pow(yuanbao.x - clickX, 2) + Math.pow(yuanbao.y - clickY, 2));
                    return distance <= YUANBAO_RADIUS;
                });

                if (nearbyYuanbao) {
                    console.log('点击了元宝附近:', nearbyYuanbao.name);
                    // 找到对应的索引
                    const yuanbaoIndex = itemData.yuanbao.findIndex(yuanbao => 
                        yuanbao.x === nearbyYuanbao.x && yuanbao.y === nearbyYuanbao.y
                    );
                    showYuanbaoImage(yuanbaoIndex);
                }
            }
        }
        
        // 检测沉船点击
        function checkShipwrecksClick(clickX, clickY) {
            const SHIPWRECKS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示沉船（支持多选）
            if (activeItemTypes.has('shipwrecked') && itemData.shipwrecked) {
                // 检查点击位置是否在任意沉船附近
                const nearbyShipwreck = itemData.shipwrecked.find((shipwreck, index) => {
                    const distance = Math.sqrt(Math.pow(shipwreck.x - clickX, 2) + Math.pow(shipwreck.y - clickY, 2));
                    return distance <= SHIPWRECKS_RADIUS;
                });

                if (nearbyShipwreck) {
                    const index = itemData.shipwrecked.findIndex(shipwreck => 
                        shipwreck.x === nearbyShipwreck.x && shipwreck.y === nearbyShipwreck.y
                    );
                    console.log('点击了沉船附近:', nearbyShipwreck.name);
                    showShipwreckedPopup(nearbyShipwreck, index);
                }
            }
        }
        
        // 检测电话暗杀点击
        function checkPayphoneHitsClick(clickX, clickY) {
            const PAYPHONE_HITS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示电话暗杀（支持多选）
            if (activeItemTypes.has('payphone_hits') && itemData.payphone_hits) {
                // 检查点击位置是否在任意电话暗杀附近
                const nearbyPayphoneHit = itemData.payphone_hits.find((payphoneHit, index) => {
                    const distance = Math.sqrt(Math.pow(payphoneHit.x - clickX, 2) + Math.pow(payphoneHit.y - clickY, 2));
                    return distance <= PAYPHONE_HITS_RADIUS;
                });

                if (nearbyPayphoneHit) {
                    console.log('点击了电话暗杀附近:', nearbyPayphoneHit.name);
                    // 找到对应的索引
                    const payphoneHitIndex = itemData.payphone_hits.findIndex(payphoneHit => 
                        payphoneHit.x === nearbyPayphoneHit.x && payphoneHit.y === nearbyPayphoneHit.y
                    );
                    showPayphoneHitsImage(payphoneHitIndex);
                }
            }
        }
        
        // 检测高尔夫球洞点击
        function checkGolfHolesClick(clickX, clickY) {
            const GOLF_HOLES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示高尔夫球洞（支持多选）
            if (activeItemTypes.has('golf_holes') && itemData.golf_holes) {
                // 检查点击位置是否在任意高尔夫球洞附近
                const nearbyGolfHole = itemData.golf_holes.find((golfHole, index) => {
                    const distance = Math.sqrt(Math.pow(golfHole.x - clickX, 2) + Math.pow(golfHole.y - clickY, 2));
                    return distance <= GOLF_HOLES_RADIUS;
                });

                if (nearbyGolfHole) {
                    console.log('点击了高尔夫球洞附近:', nearbyGolfHole.name);
                    // 找到对应的索引
                    const golfHoleIndex = itemData.golf_holes.findIndex(golfHole => 
                        golfHole.x === nearbyGolfHole.x && golfHole.y === nearbyGolfHole.y
                    );
                    showGolfHolesImage(golfHoleIndex);
                }
            }
        }
        
        // 检测雪人点击
        function checkSnowmenClick(clickX, clickY) {
            const SNOWMEN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示雪人（支持多选）
            if (activeItemTypes.has('snowmen') && itemData.snowmen) {
                // 检查点击位置是否在任意雪人附近
                const nearbySnowman = itemData.snowmen.find((snowman, index) => {
                    const distance = Math.sqrt(Math.pow(snowman.x - clickX, 2) + Math.pow(snowman.y - clickY, 2));
                    return distance <= SNOWMEN_RADIUS;
                });

                if (nearbySnowman) {
                    console.log('点击了雪人附近:', nearbySnowman.name);
                    // 找到对应的索引
                    const snowmanIndex = itemData.snowmen.findIndex(snowman => 
                        snowman.x === nearbySnowman.x && snowman.y === nearbySnowman.y
                    );
                    showSnowmenImage(snowmanIndex);
                }
            }
        }
        
        // 检测杰拉德包裹点击
        function checkDeadDropClick(clickX, clickY) {
            const DEAD_DROP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示杰拉德包裹（支持多选）
            if (activeItemTypes.has('dead_drop') && itemData.dead_drop) {
                // 检查点击位置是否在任意杰拉德包裹附近
                const nearbyDeadDrop = itemData.dead_drop.find((deadDrop, index) => {
                    const distance = Math.sqrt(Math.pow(deadDrop.x - clickX, 2) + Math.pow(deadDrop.y - clickY, 2));
                    return distance <= DEAD_DROP_RADIUS;
                });

                if (nearbyDeadDrop) {
                    console.log('点击了杰拉德包裹附近:', nearbyDeadDrop.name);
                    // 找到对应的索引
                    const deadDropIndex = itemData.dead_drop.findIndex(deadDrop => 
                        deadDrop.x === nearbyDeadDrop.x && deadDrop.y === nearbyDeadDrop.y
                    );
                    showDeadDropPopup(nearbyDeadDrop, deadDropIndex);
                }
            }
        }
        
        // 检测喷罐位置点击
        function checkSprayClick(e) {
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // 获取索引
            const index = parseInt(marker.dataset.index);
            
            // 显示物品信息
            if (itemData.spray && itemData.spray[index]) {
                showItemInfo(itemData.spray[index], 'spray', index);
                
                // 显示喷罐位置图片弹窗
                showSprayImage(index);
            }
        }

        // 检测特技跳跃点点击（用于地图坐标检测）
        function checkStuntJumpsClickNew(clickX, clickY) {
            const STUNT_JUMP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示特技跳跃点（支持多选）
            if (activeItemTypes.has('stunt_jumps') && itemData.stunt_jumps) {
                // 检查点击位置是否在任意特技跳跃点附近
                const nearbyJump = itemData.stunt_jumps.find(jump => {
                    const distance = Math.sqrt(Math.pow(jump.x - clickX, 2) + Math.pow(jump.y - clickY, 2));
                    return distance <= STUNT_JUMP_RADIUS;
                });

                if (nearbyJump) {
                    console.log('点击了特技跳跃点附近:', nearbyJump.name);
                    // 找到对应的索引
                    const jumpIndex = itemData.stunt_jumps.findIndex(jump => 
                        jump.x === nearbyJump.x && jump.y === nearbyJump.y
                    );
                    
                    showItemInfo(nearbyJump, 'stunt_jumps', jumpIndex);
                    
                    // 显示特技跳跃点图片弹窗
                    if (typeof showStuntJumpsImage === 'function') {
                        showStuntJumpsImage(jumpIndex);
                    }
                }
            }
        }
        
        // 检测喷罐点击（用于地图坐标检测）
        function checkSprayClickNew(clickX, clickY) {
            const SPRAY_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示喷罐位置（支持多选）
            if (activeItemTypes.has('spray') && itemData.spray) {
                // 检查点击位置是否在任意喷罐附近
                const nearbySpray = itemData.spray.find(spray => {
                    const distance = Math.sqrt(Math.pow(spray.x - clickX, 2) + Math.pow(spray.y - clickY, 2));
                    return distance <= SPRAY_RADIUS;
                });

                if (nearbySpray) {
                    console.log('点击了喷罐附近:', nearbySpray.name);
                    // 找到对应的索引
                    const sprayIndex = itemData.spray.findIndex(spray => 
                        spray.x === nearbySpray.x && spray.y === nearbySpray.y
                    );

                    // 显示物品信息
                    if (itemData.spray && itemData.spray[sprayIndex]) {
                        showItemInfo(itemData.spray[sprayIndex], 'spray', sprayIndex);
                        
                        // 显示喷罐位置图片弹窗
                        showSprayImage(sprayIndex);
                    }
                }
            }
        }

        // 检测RC时间挑战赛点击（坐标检测）
        function checkRCTimeTrialClickNew(clickX, clickY) {
            const RC_TIME_TRIAL_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示RC时间挑战赛（支持多选）
            if (activeItemTypes.has('rc_time_trial') && itemData.rc_time_trial) {
                // 检查点击位置是否在任意RC时间挑战赛附近
                const nearbyTrial = itemData.rc_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= RC_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('点击了RC时间挑战赛附近:', nearbyTrial.name);
                    // 找到对应的索引
                    const trialIndex = itemData.rc_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showRCTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // 检测自行车时间挑战赛点击（坐标检测）
        function checkBikeTimeTrialClickNew(clickX, clickY) {
            const BIKE_TIME_TRIAL_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示自行车时间挑战赛（支持多选）
            if (activeItemTypes.has('bike_time_trial') && itemData.bike_time_trial) {
                // 检查点击位置是否在任意自行车时间挑战赛附近
                const nearbyTrial = itemData.bike_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= BIKE_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('点击了自行车时间挑战赛附近:', nearbyTrial.name);
                    // 找到对应的索引
                    const trialIndex = itemData.bike_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showBikeTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // 检测跳伞点击（坐标检测）
        function checkSkydivesClickNew(clickX, clickY) {
            const SKYDIVES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示跳伞（支持多选）
            if (activeItemTypes.has('skydives') && itemData.skydives) {
                // 检查点击位置是否在任意跳伞附近
                const nearbySkydive = itemData.skydives.find(skydive => {
                    const distance = Math.sqrt(Math.pow(skydive.x - clickX, 2) + Math.pow(skydive.y - clickY, 2));
                    return distance <= SKYDIVES_RADIUS;
                });

                if (nearbySkydive) {
                    console.log('点击了跳伞附近:', nearbySkydive.name);
                    // 找到对应的索引
                    const skydiveIndex = itemData.skydives.findIndex(skydive => 
                        skydive.x === nearbySkydive.x && skydive.y === nearbySkydive.y
                    );
                    showSkydivesPopup(nearbySkydive, skydiveIndex);
                }
            }
        }

        // 检测车行点击（坐标检测）
        function checkDealershipClick(clickX, clickY) {
            const DEALERSHIP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示车行（支持多选）
            if (activeItemTypes.has('dealerships')) {
                // 已迁移到Leaflet的车行类型，跳过DOM点击检测（由Leaflet处理）
                const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                
                // 遍历所有车行坐标进行检测
                Object.keys(dealershipData).forEach(dealershipType => {
                    // 跳过已迁移的车行类型
                    if (migratedDealerships.includes(dealershipType)) {
                        return;
                    }
                    
                    const dealership = dealershipData[dealershipType];
                    dealership.coordinates.forEach(coord => {
                        const distance = Math.sqrt(Math.pow(coord[0] - clickX, 2) + Math.pow(coord[1] - clickY, 2));
                        if (distance <= DEALERSHIP_RADIUS) {
                            console.log(`点击了${dealership.name}附近区域`);
                            showDealershipVehicles(dealershipType, dealership.name);
                        }
                    });
                });
            }
        }

        // 检测左轮寻宝点击（坐标检测）
        function checkTreasureHuntClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('treasure_hunt_dba_revolver')) return;
            const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
            const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
            const foundRandom = rc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundRandom) {
                const idx = rc.findIndex(p => p.x === foundRandom.x && p.y === foundRandom.y);
                showTreasureHuntPopup(foundRandom, idx, 'random');
                return;
            }
            const foundStatic = sc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundStatic) {
                const idx = sc.findIndex(p => p.x === foundStatic.x && p.y === foundStatic.y);
                showTreasureHuntPopup(foundStatic, idx, 'static');
            }
        }

        // 检测电影道具点击（坐标检测）
        function checkMoviePropsClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('movie_props')) return;
            
            const mp = itemData.movie_props;
            const allItems = [
                ...(mp.fixed_position || []).map((item, i) => ({ ...item, __index: i, __type: 'fixed_position' })),
                ...(mp.vehicles?.pony || []).map((item, i) => ({ ...item, __index: i, __type: 'pony' })),
                ...(mp.vehicles?.rebel || []).map((item, i) => ({ ...item, __index: i, __type: 'rebel' })),
                ...(mp.vehicles?.rumpo || []).map((item, i) => ({ ...item, __index: i, __type: 'rumpo' }))
            ];
            
            const foundItem = allItems.find(item => Math.hypot(item.x - clickX, item.y - clickY) <= RADIUS);
            if (foundItem) {
                showMoviePropsPopup(foundItem, foundItem.__index, foundItem.__type);
            }
        }

        // 检测杀人狂点击（坐标检测）
        function checkSlasherClick(clickX, clickY) {
            const SLASHER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示杀人狂（支持多选）
            if (activeItemTypes.has('serial_killer_slasher') && itemData.serial_killer_slasher) {
                // 检查前四条线索
                if (itemData.serial_killer_slasher.first) {
                    const nearbyFirst = itemData.serial_killer_slasher.first.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyFirst) {
                        const index = itemData.serial_killer_slasher.first.findIndex(item => 
                            item.x === nearbyFirst.x && item.y === nearbyFirst.y
                        );
                        console.log('点击了杀人狂前四条线索附近:', nearbyFirst.name);
                        showSlasherPopup(nearbyFirst, index, 'first');
                        return;
                    }
                }
                
                // 检查最后一条线索
                if (itemData.serial_killer_slasher.last) {
                    const nearbyLast = itemData.serial_killer_slasher.last.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyLast) {
                        const index = itemData.serial_killer_slasher.last.findIndex(item => 
                            item.x === nearbyLast.x && item.y === nearbyLast.y
                        );
                        console.log('点击了杀人狂最后一条线索附近:', nearbyLast.name);
                        showSlasherPopup(nearbyLast, index, 'last');
                        return;
                    }
                }
            }
        }

        // 注意：茉德悬赏目标现在使用Leaflet标记系统，不再需要DOM点击检测

        // 茉德悬赏目标弹窗
        function showMaudeBountyPopup(item, index, subtype) {
            const isArea = subtype === 'area';
            const title = isArea ? `🎯 茉德悬赏区域 #${index + 1}` : `🎯 茉德悬赏终点 #${index + 1}`;
            
            const popup = document.createElement('div');
            popup.className = 'maude-bounty-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FFD700; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #FFD700; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #fffbf0; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    前往茉德处接受悬赏目标任务。等待数分钟后，她将通过电子邮件告知悬赏目标的相关信息。悬赏目标将随机出现在 20 个区域之一，其当前活动的区域会在游戏内的地图上标记出来。每个区域都有 20 个可供生成目标的位置。若您成功抓住目标，并转交给茉德，您可赚取 10.000 GTA$；若您直接杀死目标，您将获得 5.000 GTA$。完成一个悬赏目标任务后，您必须再等几分钟才会收到下一个悬赏目标的相关信息。该系列任务共有 5 个悬赏目标需要抓捕。全部完成之后，茉德会发短信，告诉您石斧的藏匿位置，该位置会在游戏内地图上标记出来。使用该武器完成 25 次击杀，您将得到 250.000 GTA$ 与 2.000 RP，并可在 Red Dead Redemption 2 中找到这款武器。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-maude-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-maude-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-maude-btn" style="padding: 10px 18px; background: #FFD700; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-maude-btn');
            const showBtn = popup.querySelector('#show-maude-btn');
            const closeBtn = popup.querySelector('#close-maude-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                let el;
                if (subtype === 'area') {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_area"][data-index="${index}"]`);
                } else {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_endpoint"][data-index="${index}"]`);
                }
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 检测媒体记忆棒点击（坐标检测）
        function checkMediaStickClick(clickX, clickY) {
            const MEDIA_STICK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示媒体记忆棒
            if (activeItemTypes.has('media_sticks') && itemData.media_sticks) {
                const nearbyStick = itemData.media_sticks.find((stick, index) => {
                    const distance = Math.sqrt(Math.pow(stick.x - clickX, 2) + Math.pow(stick.y - clickY, 2));
                    return distance <= MEDIA_STICK_RADIUS;
                });
                
                if (nearbyStick) {
                    const index = itemData.media_sticks.findIndex(stick => 
                        stick.x === nearbyStick.x && stick.y === nearbyStick.y
                    );
                    console.log('点击了媒体记忆棒附近:', nearbyStick.name);
                    showMediaStickPopup(nearbyStick, index);
                    return;
                }
            }
        }

         // 媒体记忆棒弹窗模板（参考纸牌实现，含隐藏/显示功能）
        function showMediaStickPopup(item, index) {
            const rawLabel = item && (item.label || item.name) || '';
            const label = String(rawLabel);
            const labelLower = label.toLowerCase();
            
            // 根据标签匹配不同的弹窗内容（统一小写匹配，兼容多种别名）
            let title, content, imageUrl;
            
            if (labelLower.includes('circoloco_green_ep')) {
                title = '🎵 CircoLoco Records - Green EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Green EP - 在游戏厅的吧台上 - 您的游戏厅的位置可能与本标记不同。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_green_ep.webp';
            } else if (labelLower.includes('circoloco_violet_ep')) {
                title = '🎵 CircoLoco Records - Violet EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Violet EP - 在夜总会的桌子上 - 您的夜总会的位置可能与本地图的标记不同。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_violet_ep.webp';
            } else if (labelLower.includes('circoloco_blue_ep')) {
                title = '🎵 CircoLoco Records - Blue EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Blue EP - 在名钻假日赌场的露台，其中的一张桌子上。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_blue_ep.webp';
            } else if (labelLower.includes('circoloco_black_ep')) {
                title = '🎵 CircoLoco Records - Black EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Black EP - 在洛圣都车友会内，在改装工坊旁边的一个工具台上。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_black_ep.webp';
            } else if (labelLower.includes('dam_funk') || labelLower.includes('damfunk')) {
                title = '🎵 DâM-FunK – Even the Score';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>呼叫 6115550110 后会在 5 个可能位置之一出现。游戏内地图上会标出大致位置。本地图显示的是确切位置。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/dam_funk.webp';
            } else if (labelLower.includes('dr_dre') || labelLower.includes('dre')) {
                title = '🎵 Dr. Dre - 在事务所里';
                content = `它将奖励您 马拉松连帽上衣 与 1.000 RP，并在媒体播放器上解锁新的曲目<br><br>Dr. Dre - 在事务所里 - 您的事务所的位置可能与本地图的标记不同。该媒体记忆棒将在以主持人身份完成全部德瑞博士的故事后可用。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/dr_dre.webp';
            } else if (labelLower.includes('moodymann')) {
                title = '🎵 Moodymann - Kenny\'s Backyard Boogie';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>Moodymann - Kenny's Backyard Boogie -在穆迪曼的车的后备箱上 - 这辆车在 洛圣都车友会 随机生成。`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/moodymann.webp';
            } else if (labelLower.includes('nez_ft_schoolboyq') || labelLower.includes('nez')) {
                title = '🎵 NEZ - You Wanna?';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>NEZ - You Wanna?`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/nez.webp';
            } else {
                // 默认内容
                title = `🎵 媒体记忆棒 #${index + 1}`;
                content = `媒体记忆棒位置信息。<br><br>标签: ${label}`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/default.webp';
            }
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.media-stick-popup');
            if (existingPopup) existingPopup.remove();

            // 获取当前标记状态
            const markers = (window.mediaStickMarkers && window.mediaStickMarkers) || [];
            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'media-stick-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="媒体记忆棒图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-media-stick-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-media-stick-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-media-stick-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-media-stick-btn');
            const hideBtn = popup.querySelector('#hide-media-stick-btn');
            const showBtn = popup.querySelector('#show-media-stick-btn');
            const popupClose = popup.querySelector('.popup-close');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大功能
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'media-stick-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('media_sticks', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到媒体记忆棒标记
        function applyMediaStickVisibilityCache() {
            const markers = (window.mediaStickMarkers && window.mediaStickMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('media_sticks');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用媒体记忆棒可见性缓存');
                return true;
            }
            return false;
        }

        // 检测藏匿屋点击（坐标检测）
        function checkStashHouseClick(clickX, clickY) {
            const STASH_HOUSE_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示藏匿屋
            if (activeItemTypes.has('stash_houses') && itemData.stash_houses) {
                const nearbyStash = itemData.stash_houses.find((stash, index) => {
                    const distance = Math.sqrt(Math.pow(stash.x - clickX, 2) + Math.pow(stash.y - clickY, 2));
                    return distance <= STASH_HOUSE_RADIUS;
                });
                
                if (nearbyStash) {
                    const index = itemData.stash_houses.findIndex(stash => 
                        stash.x === nearbyStash.x && stash.y === nearbyStash.y
                    );
                    console.log('点击了藏匿屋附近:', nearbyStash.name);
                    showStashHousesPopup(nearbyStash, index);
                    return;
                }
            }
        }


        // 检测玛德拉索雇凶点击（坐标检测）
        function checkMadrazoHitsClick(clickX, clickY) {
            const MADRAZO_HITS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示玛德拉索雇凶
            if (activeItemTypes.has('madrazo_hits') && itemData.madrazo_hits) {
                const nearbyHit = itemData.madrazo_hits.find((hit, index) => {
                    const distance = Math.sqrt(Math.pow(hit.x - clickX, 2) + Math.pow(hit.y - clickY, 2));
                    return distance <= MADRAZO_HITS_RADIUS;
                });
                
                if (nearbyHit) {
                    const index = itemData.madrazo_hits.findIndex(hit => 
                        hit.x === nearbyHit.x && hit.y === nearbyHit.y
                    );
                    console.log('点击了玛德拉索雇凶附近:', nearbyHit.name);
                    showMadrazoHitsPopup(nearbyHit, index);
                    return;
                }
            }
        }

        // 检测帕特里克救援点击（坐标检测）
        function checkPatrickRescueClick(clickX, clickY) {
            const PATRICK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示帕特里克救援
            if (activeItemTypes.has('police_rescue_patrick_mcreary') && itemData.police_rescue_patrick_mcreary) {
                const patrickData = itemData.police_rescue_patrick_mcreary;
                
                // 检查spawn点
                if (patrickData.spawn) {
                    const nearbySpawn = patrickData.spawn.find((spawn, index) => {
                        const distance = Math.sqrt(Math.pow(spawn.x - clickX, 2) + Math.pow(spawn.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbySpawn) {
                        const index = patrickData.spawn.findIndex(spawn => 
                            spawn.x === nearbySpawn.x && spawn.y === nearbySpawn.y
                        );
                        console.log('点击了帕特里克救援生成点附近:', nearbySpawn);
                        showPatrickRescuePopup(nearbySpawn, index, 'spawn');
                        return;
                    }
                }
                
                // 检查dropoff点
                if (patrickData.dropoff) {
                    const nearbyDropoff = patrickData.dropoff.find((dropoff, index) => {
                        const distance = Math.sqrt(Math.pow(dropoff.x - clickX, 2) + Math.pow(dropoff.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbyDropoff) {
                        const index = patrickData.dropoff.findIndex(dropoff => 
                            dropoff.x === nearbyDropoff.x && dropoff.y === nearbyDropoff.y
                        );
                        console.log('点击了帕特里克救援送达点附近:', nearbyDropoff);
                        showPatrickRescuePopup(nearbyDropoff, index, 'dropoff');
                        return;
                    }
                }
            }
        }

        // 检测随机任务点击（坐标检测）
        function checkRandomMissionClick(clickX, clickY) {
            const RANDOM_MISSION_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示随机任务
            if (activeItemTypes.has('random_missions') && itemData.random_missions) {
                const randomMissions = itemData.random_missions;
                let globalIndex = 0;
                
                // 遍历所有时间段
                for (const timeSlot of Object.keys(randomMissions)) {
                    const missions = randomMissions[timeSlot] || [];
                    
                    for (let i = 0; i < missions.length; i++) {
                        const mission = missions[i];
                        if (!Array.isArray(mission) || mission.length < 2) continue;
                        
                        const x = mission[0];
                        const y = mission[1];
                        const distance = Math.sqrt(Math.pow(x - clickX, 2) + Math.pow(y - clickY, 2));
                        
                        if (distance <= RANDOM_MISSION_RADIUS) {
                            console.log('点击了随机任务附近:', mission);
                            showRandomMissionPopup(mission, timeSlot, i);
                            return;
                        }
                        globalIndex++;
                    }
                }
            }
        }

        // 检测毒品载具点击（坐标检测）
        function checkDrugVehicleClick(clickX, clickY) {
            const DRUG_VEHICLE_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示毒品载具
            if (activeItemTypes.has('drug_vehicle') && Array.isArray(itemData.drug_vehicle)) {
                const nearbyVehicle = itemData.drug_vehicle.find((vehicle) => {
                    const dx = vehicle.x - clickX;
                    const dy = vehicle.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUG_VEHICLE_RADIUS;
                });
                
                if (nearbyVehicle) {
                    const index = itemData.drug_vehicle.findIndex(v => v.x === nearbyVehicle.x && v.y === nearbyVehicle.y);
                    console.log('点击了毒品载具附近:', nearbyVehicle);
                    showDrugVehiclePopup(nearbyVehicle, index);
                    return;
                }
            }
        }

        // 检测沉睡的保安点击（坐标检测）
        function checkDrunkGuardClick(clickX, clickY) {
            const DRUNK_GUARD_RADIUS = 100; // 检测半径100单位
            
            if (activeItemTypes.has('drunk_guard') && Array.isArray(itemData.drunk_guard)) {
                const nearby = itemData.drunk_guard.find((g) => {
                    const dx = g.x - clickX;
                    const dy = g.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUNK_GUARD_RADIUS;
                });
                
                if (nearby) {
                    const index = itemData.drunk_guard.findIndex(g => g.x === nearby.x && g.y === nearby.y);
                    console.log('点击了沉睡的保安附近:', nearby);
                    showDrunkGuardPopup(nearby, index);
                    return;
                }
            }
        }

        // 注意：金属探测器点击检测已删除，现在使用Leaflet标记系统处理点击事件

        // 检测走私贩飞机点击（坐标检测）
        function checkSmugglerPlaneClick(clickX, clickY) {
            const RADIUS = 120; // 检测半径（游戏坐标）
            if (!activeItemTypes.has('smuggler_plane') || !Array.isArray(itemData.smuggler_plane)) return;
            const groups = itemData.smuggler_plane;

            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                // 检查 triggerpoint
                if (Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                    const dx = group.triggerpoint[0] - clickX;
                    const dy = group.triggerpoint[1] - clickY;
                    if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                        showSmugglerPlanePopup(group, i);
                        return;
                    }
                }
                // 检查 routes 的首点
                if (Array.isArray(group.routes)) {
                    for (let r = 0; r < group.routes.length; r++) {
                        const route = group.routes[r];
                        if (Array.isArray(route) && route[0] && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const dx = rx - clickX;
                            const dy = ry - clickY;
                            if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                                showSmugglerPlanePopup(group, i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        // 检测走私贩踪迹点击（坐标检测）
        function checkSmugglerTrailClick(clickX, clickY) {
            const RADIUS = 120; // 检测半径（游戏坐标）
            if (!activeItemTypes.has('smuggler_trail') || !Array.isArray(itemData.smuggler_trail)) return;
            const groups = itemData.smuggler_trail;

            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                // 检查 triggerpoint
                if (Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                    const dx = group.triggerpoint[0] - clickX;
                    const dy = group.triggerpoint[1] - clickY;
                    if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                        showSmugglerTrailPopup(group, i);
                        return;
                    }
                }
                // 检查 routes 的首点
                if (Array.isArray(group.routes)) {
                    for (let r = 0; r < group.routes.length; r++) {
                        const route = group.routes[r];
                        if (Array.isArray(route) && route[0] && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const dx = rx - clickX;
                            const dy = ry - clickY;
                            if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                                showSmugglerTrailPopup(group, i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        // 检测犯罪现场点击（坐标检测）
        function checkCrimeScenesClick(clickX, clickY) {
            const CRIME_SCENES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示犯罪现场（支持多选）
            if (activeItemTypes.has('crime_scenes') && itemData.crime_scenes) {
                // 检查点击位置是否在任意犯罪现场附近
                const nearbyCrimeScene = itemData.crime_scenes.find(crimeScene => {
                    const distance = Math.sqrt(Math.pow(crimeScene.x - clickX, 2) + Math.pow(crimeScene.y - clickY, 2));
                    return distance <= CRIME_SCENES_RADIUS;
                });

                if (nearbyCrimeScene) {
                    console.log('点击了犯罪现场附近:', nearbyCrimeScene.name);
                    // 找到对应的索引
                    const crimeSceneIndex = itemData.crime_scenes.findIndex(crimeScene => 
                        crimeScene.x === nearbyCrimeScene.x && crimeScene.y === nearbyCrimeScene.y
                    );
                    showCrimeScenesPopup(nearbyCrimeScene, crimeSceneIndex);
                    return; // 找到犯罪现场，停止后续检测
                }
            }
            
            // 检查当前是否显示UFO观光（支持多选）
            if (activeItemTypes.has('ufo') && itemData.ufo) {
                // 检查点击位置是否在任意UFO观光附近
                const nearbyUfo = itemData.ufo.find(ufo => {
                    const distance = Math.sqrt(Math.pow(ufo.x - clickX, 2) + Math.pow(ufo.y - clickY, 2));
                    return distance <= CRIME_SCENES_RADIUS; // 使用相同的检测半径
                });
                
                if (nearbyUfo) {
                    console.log('点击了UFO观光附近:', nearbyUfo.name);
                    // 找到对应的索引
                    const ufoIndex = itemData.ufo.findIndex(ufo => 
                        ufo.x === nearbyUfo.x && ufo.y === nearbyUfo.y
                    );
                    showUfoPopup(nearbyUfo, ufoIndex);
                    return; // 找到UFO观光，停止后续检测
                }
            }
            
            // 注意：halloween_slashers 现在使用Leaflet标记系统，点击事件由Leaflet自动处理
            
            // 检查当前是否显示鬼上身的动物（支持多选）
            if (activeItemTypes.has('possessed_animals') && itemData.possessed_animals) {
                // 检查点击位置是否在任意鬼上身动物圆形区域内
                const nearbyAnimal = itemData.possessed_animals.find(animal => {
                    const distance = Math.sqrt(Math.pow(animal.x - clickX, 2) + Math.pow(animal.y - clickY, 2));
                    return distance <= animal.radius; // 使用每个动物自己的半径
                });
                
                if (nearbyAnimal) {
                    console.log('点击了鬼上身动物区域:', nearbyAnimal.name);
                    // 找到对应的索引
                    const animalIndex = itemData.possessed_animals.findIndex(animal => 
                        animal.x === nearbyAnimal.x && animal.y === nearbyAnimal.y && 
                        animal.type === nearbyAnimal.type && animal.animalType === nearbyAnimal.animalType
                    );
                    showPossessedAnimalPopup(nearbyAnimal, animalIndex);
                    return; // 找到鬼上身动物，停止后续检测
                }
            }
            
            // 检查当前是否显示地狱犬（支持多选）
            if (activeItemTypes.has('cerberus') && itemData.cerberus) {
                // 检查点击位置是否在任意地狱犬附近
                const nearbyCerberus = itemData.cerberus.find(cerberus => {
                    const distance = Math.sqrt(Math.pow(cerberus.x - clickX, 2) + Math.pow(cerberus.y - clickY, 2));
                    return distance <= 100; // 检测半径100单位
                });
                
                if (nearbyCerberus) {
                    console.log('点击了地狱犬:', nearbyCerberus.name);
                    // 找到对应的索引
                    const cerberusIndex = itemData.cerberus.findIndex(cerberus => 
                        cerberus.x === nearbyCerberus.x && cerberus.y === nearbyCerberus.y
                    );
                    showCerberusPopup(nearbyCerberus, cerberusIndex);
                    return; // 找到地狱犬，停止后续检测
                }
            }
        }

        // 检测雪怪和节日快乐卡车点击
        function checkYetiAndHaulerClick(clickX, clickY) {
            // 检查当前是否显示雪怪（支持多选）
            if (activeItemTypes.has('yeti') && itemData.yeti) {
                // 检查点击位置是否在任意雪怪线索附近
                const nearbyYeti = itemData.yeti.find(yeti => {
                    if (yeti.type === 'clue') {
                        const distance = Math.sqrt(Math.pow(yeti.x - clickX, 2) + Math.pow(yeti.y - clickY, 2));
                        return distance <= 100; // 检测半径100单位
                    }
                    return false; // 只检测线索点击，不检测区域点击
                });
                
                if (nearbyYeti) {
                    console.log('点击了雪怪线索:', nearbyYeti.name);
                    // 找到对应的索引
                    const yetiIndex = itemData.yeti.findIndex(yeti => 
                        yeti.x === nearbyYeti.x && yeti.y === nearbyYeti.y && yeti.type === nearbyYeti.type
                    );
                    showYetiPopup(nearbyYeti, yetiIndex);
                    return; // 找到雪怪线索，停止后续检测
                }
            }
            
            // 检查当前是否显示节日快乐卡车（支持多选）
            if (activeItemTypes.has('happy_holidays_hauler') && itemData.happy_holidays_hauler) {
                // 检查点击位置是否在任意节日快乐卡车triggerpoint附近
                const nearbyHauler = itemData.happy_holidays_hauler.find(hauler => {
                    if (hauler.triggerpoint && Array.isArray(hauler.triggerpoint) && hauler.triggerpoint.length === 2) {
                        const distance = Math.sqrt(Math.pow(hauler.triggerpoint[0] - clickX, 2) + Math.pow(hauler.triggerpoint[1] - clickY, 2));
                        return distance <= 100; // 检测半径100单位
                    }
                    return false;
                });
                
                if (nearbyHauler) {
                    console.log('点击了节日快乐卡车:', nearbyHauler);
                    // 找到对应的索引
                    const haulerIndex = itemData.happy_holidays_hauler.findIndex(hauler => 
                        hauler.triggerpoint && Array.isArray(hauler.triggerpoint) && 
                        hauler.triggerpoint[0] === nearbyHauler.triggerpoint[0] && 
                        hauler.triggerpoint[1] === nearbyHauler.triggerpoint[1]
                    );
                    showHappyHolidaysHaulerPopup(nearbyHauler, haulerIndex);
                    return; // 找到节日快乐卡车，停止后续检测
                }
            }
        }

        // 检测威泽尔大楼枪战点击
        function checkWeaClick(clickX, clickY) {
            const WEA_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示威泽尔大楼枪战（支持多选）
            if (activeItemTypes.has('wea') && itemData.wea) {
                // 检查点击位置是否在任意威泽尔大楼枪战附近
                const nearbyWea = itemData.wea.find(wea => {
                    const distance = Math.sqrt(Math.pow(wea.x - clickX, 2) + Math.pow(wea.y - clickY, 2));
                    return distance <= WEA_RADIUS;
                });
                
                if (nearbyWea) {
                    console.log('点击了威泽尔大楼枪战:', nearbyWea);
                    // 找到对应的索引
                    const weaIndex = itemData.wea.findIndex(wea => 
                        wea.x === nearbyWea.x && wea.y === nearbyWea.y
                    );
                    showWeaPopup(nearbyWea, weaIndex);
                    return; // 找到威泽尔大楼枪战，停止后续检测
                }
            }
        }

        // 检测陆地迷幻仙人掌点击
        function checkPplClick(clickX, clickY) {
            const PPL_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示陆地迷幻仙人掌（支持多选）
            if (activeItemTypes.has('ppl') && itemData.ppl) {
                // 检查点击位置是否在任意陆地迷幻仙人掌附近
                const nearbyPpl = itemData.ppl.find(ppl => {
                    const distance = Math.sqrt(Math.pow(ppl.x - clickX, 2) + Math.pow(ppl.y - clickY, 2));
                    return distance <= PPL_RADIUS;
                });
                
                if (nearbyPpl) {
                    console.log('点击了陆地迷幻仙人掌:', nearbyPpl);
                    // 找到对应的索引
                    const pplIndex = itemData.ppl.findIndex(ppl => 
                        ppl.x === nearbyPpl.x && ppl.y === nearbyPpl.y
                    );
                    showPplPopup(nearbyPpl, pplIndex);
                    return; // 找到陆地迷幻仙人掌，停止后续检测
                }
            }
        }

        // 检测水下迷幻仙人掌点击
        function checkPpwClick(clickX, clickY) {
            const PPW_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示水下迷幻仙人掌（支持多选）
            if (activeItemTypes.has('ppw') && itemData.ppw) {
                // 检查点击位置是否在任意水下迷幻仙人掌附近
                const nearbyPpw = itemData.ppw.find(ppw => {
                    const distance = Math.sqrt(Math.pow(ppw.x - clickX, 2) + Math.pow(ppw.y - clickY, 2));
                    return distance <= PPW_RADIUS;
                });
                
                if (nearbyPpw) {
                    console.log('点击了水下迷幻仙人掌:', nearbyPpw);
                    // 找到对应的索引
                    const ppwIndex = itemData.ppw.findIndex(ppw => 
                        ppw.x === nearbyPpw.x && ppw.y === nearbyPpw.y
                    );
                    showPpwPopup(nearbyPpw, ppwIndex);
                    return; // 找到水下迷幻仙人掌，停止后续检测
                }
            }
        }

        // 检测新物品点击（地铁站、警察局、望远镜、消防局、医院、各种商店）
        function checkNewItemClick(clickX, clickY) {
            const NEW_ITEM_RADIUS = 100; // 检测半径100单位
            const newItemTypes = [
                'metro', 'police', 'v_telescopes', 'fire_stations', 'hospitals',
                'clothing', 'tattoos', 'barbers', 'ammunation', 'mod_shop', 'car_wash',
                'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'
            ];
            
            newItemTypes.forEach(type => {
                // 检查当前是否显示该物品类型
                if (activeItemTypes.has(type) && itemData[type]) {
                    // 检查点击位置是否在该物品附近
                    const nearbyItem = itemData[type].find(item => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= NEW_ITEM_RADIUS;
                    });
                    
                    if (nearbyItem) {
                        console.log(`点击了${type}:`, nearbyItem);
                        // 找到对应的索引
                        const itemIndex = itemData[type].findIndex(item => 
                            item.x === nearbyItem.x && item.y === nearbyItem.y
                        );
                        showNewItemPopup(type, nearbyItem, itemIndex);
                        return; // 找到物品，停止后续检测
                    }
                }
            });
        }

        // 检测社区边界点击（坐标检测）
        function checkCommunityOutreachClick(clickX, clickY) {
            const COMMUNITY_OUTREACH_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示社区边界（支持多选）
            if (activeItemTypes.has('community_outreach') && itemData.community_outreach) {
                // 检查点击位置是否在任意社区边界附近
                const nearbyCommunityOutreach = itemData.community_outreach.find(communityOutreach => {
                    const distance = Math.sqrt(Math.pow(communityOutreach.x - clickX, 2) + Math.pow(communityOutreach.y - clickY, 2));
                    return distance <= COMMUNITY_OUTREACH_RADIUS;
                });

                if (nearbyCommunityOutreach) {
                    console.log('点击了社区边界附近:', nearbyCommunityOutreach.name);
                    // 找到对应的索引
                    const communityOutreachIndex = itemData.community_outreach.findIndex(communityOutreach => 
                        communityOutreach.x === nearbyCommunityOutreach.x && communityOutreach.y === nearbyCommunityOutreach.y
                    );
                    showCommunityOutreachPopup(nearbyCommunityOutreach, communityOutreachIndex);
                }
            }
        }

        // 检测外贸出口载具点击（坐标检测）
        function checkExoticExportsClick(clickX, clickY) {
            const EXOTIC_EXPORTS_RADIUS = 100; // 检测半径100单位
            
            // 检查exotic_exports1
            if (activeItemTypes.has('exotic_exports1') && itemData.exotic_exports1) {
                const nearbyExoticExport = itemData.exotic_exports1.find(exoticExport => {
                    const distance = Math.sqrt(Math.pow(exoticExport.x - clickX, 2) + Math.pow(exoticExport.y - clickY, 2));
                    return distance <= EXOTIC_EXPORTS_RADIUS;
                });

                if (nearbyExoticExport) {
                    console.log('点击了外贸出口载具1附近:', nearbyExoticExport.name);
                    const exoticExportIndex = itemData.exotic_exports1.findIndex(exoticExport => 
                        exoticExport.x === nearbyExoticExport.x && exoticExport.y === nearbyExoticExport.y
                    );
                    showExoticExportsPopup(nearbyExoticExport, exoticExportIndex, 'exotic_exports1');
                    return;
                }
            }
            
            // 检查exotic_exports2
            if (activeItemTypes.has('exotic_exports2') && itemData.exotic_exports2) {
                const nearbyExoticExport = itemData.exotic_exports2.find(exoticExport => {
                    const distance = Math.sqrt(Math.pow(exoticExport.x - clickX, 2) + Math.pow(exoticExport.y - clickY, 2));
                    return distance <= EXOTIC_EXPORTS_RADIUS;
                });

                if (nearbyExoticExport) {
                    console.log('点击了外贸出口载具2附近:', nearbyExoticExport.name);
                    const exoticExportIndex = itemData.exotic_exports2.findIndex(exoticExport => 
                        exoticExport.x === nearbyExoticExport.x && exoticExport.y === nearbyExoticExport.y
                    );
                    showExoticExportsPopup(nearbyExoticExport, exoticExportIndex, 'exotic_exports2');
                    return;
                }
            }
        }

        // 检测商店抢劫点击（坐标检测）
        function checkStoreRobberyClick(clickX, clickY) {
            const STORE_ROBBERY_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示商店抢劫（支持多选）
            if (activeItemTypes.has('store_robbery') && itemData.store_robbery) {
                // 检查点击位置是否在任意商店抢劫附近
                const nearbyStoreRobbery = itemData.store_robbery.find(storeRobbery => {
                    const distance = Math.sqrt(Math.pow(storeRobbery.x - clickX, 2) + Math.pow(storeRobbery.y - clickY, 2));
                    return distance <= STORE_ROBBERY_RADIUS;
                });

                if (nearbyStoreRobbery) {
                    console.log('点击了商店抢劫附近:', nearbyStoreRobbery.name);
                    // 找到对应的索引
                    const storeRobberyIndex = itemData.store_robbery.findIndex(storeRobbery => 
                        storeRobbery.x === nearbyStoreRobbery.x && storeRobbery.y === nearbyStoreRobbery.y
                    );
                    showStoreRobberyPopup(nearbyStoreRobbery, storeRobberyIndex);
                }
            }
        }

        // 检测车队点击（坐标检测）
        function checkConvoyClick(clickX, clickY) {
            const CONVOY_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示车队（支持多选）
            if (activeItemTypes.has('convoy') && itemData.convoy) {
                // 检查点击位置是否在任意车队附近
                const nearbyConvoy = itemData.convoy.find((convoy, index) => {
                    const tp = convoy.triggerpoint;
                    if (Array.isArray(tp) && tp.length >= 2) {
                        const distance = Math.sqrt(Math.pow(tp[0] - clickX, 2) + Math.pow(tp[1] - clickY, 2));
                        return distance <= CONVOY_RADIUS;
                    }
                    return false;
                });

                if (nearbyConvoy) {
                    console.log('点击了车队附近:', nearbyConvoy.name);
                    // 找到对应的索引
                    const convoyIndex = itemData.convoy.findIndex(convoy => 
                        convoy.triggerpoint === nearbyConvoy.triggerpoint
                    );
                    showConvoyPopup(nearbyConvoy, convoyIndex);
                    return;
                }
            }

            // 同时检查车队终点
            if (activeItemTypes.has('convoy') && itemData.convoy_final) {
                // 检查点击位置是否在任意车队终点附近
                const nearbyConvoyFinal = itemData.convoy_final.find(convoyFinal => {
                    const distance = Math.sqrt(Math.pow(convoyFinal.x - clickX, 2) + Math.pow(convoyFinal.y - clickY, 2));
                    return distance <= CONVOY_RADIUS;
                });

                if (nearbyConvoyFinal) {
                    console.log('点击了车队终点附近:', nearbyConvoyFinal.name);
                    // 找到对应的索引
                    const convoyFinalIndex = itemData.convoy_final.findIndex(convoyFinal => 
                        convoyFinal.x === nearbyConvoyFinal.x && convoyFinal.y === nearbyConvoyFinal.y
                    );
                    showConvoyFinalPopup(nearbyConvoyFinal, convoyFinalIndex);
                }
            }
        }

        // 检测装甲运钞车点击（坐标检测）
        function checkArmoredTruckClick(clickX, clickY) {
            const ARMORED_TRUCK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示装甲运钞车（支持多选）
            if (activeItemTypes.has('armored_truck') && itemData.armored_truck) {
                // 检查点击位置是否在任意装甲运钞车附近
                const nearbyArmoredTruck = itemData.armored_truck.find(armoredTruck => {
                    const distance = Math.sqrt(Math.pow(armoredTruck.x - clickX, 2) + Math.pow(armoredTruck.y - clickY, 2));
                    return distance <= ARMORED_TRUCK_RADIUS;
                });

                if (nearbyArmoredTruck) {
                    console.log('点击了装甲运钞车附近:', nearbyArmoredTruck.name);
                    // 找到对应的索引
                    const armoredTruckIndex = itemData.armored_truck.findIndex(armoredTruck => 
                        armoredTruck.x === nearbyArmoredTruck.x && armoredTruck.y === nearbyArmoredTruck.y
                    );
                    showArmoredTruckPopup(nearbyArmoredTruck, armoredTruckIndex);
                }
            }
        }

        // 毒品载具弹窗
        function showDrugVehiclePopup(item, index) {
            const title = `🚗 毒品载具 #${index + 1}`;
            const content = `毒品载具会在此位置附近刷新。靠近时会在游戏中以蓝点标记。`;
            
            const popup = document.createElement('div');
            popup.className = 'drug-vehicle-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #2E7D32; text-align:center;">${title}</div>
                <img src="https://gta-maps.antwen.com/collectibles_images/drug_vehicle/drug_vehicle.webp" alt="毒品载具图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #1b5e20; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drug-vehicle-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-drug-vehicle-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-drug-vehicle-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 按钮
            const hideBtn = popup.querySelector('#hide-drug-vehicle-btn');
            const showBtn = popup.querySelector('#show-drug-vehicle-btn');
            const closeBtn = popup.querySelector('#close-drug-vehicle-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drug_vehicle"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 沉睡的保安弹窗
        function showDrunkGuardPopup(item, index) {
            const title = `🛌 沉睡的保安 #${index + 1}`;
            const content = `搜刮他（键盘上的E ）以获得 7.007 GTA$ 和佩里科岛金发老大办公室的抽屉钥匙。抽屉里面有一把 佩里科手枪。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/drunk_guard/drunk_guard.webp';
            
            const popup = document.createElement('div');
            popup.className = 'drunk-guard-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #795548; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #5D4037; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="沉睡的保安图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #efebe9; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drunk-guard-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-drunk-guard-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-drunk-guard-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-drunk-guard-btn');
            const showBtn = popup.querySelector('#show-drunk-guard-btn');
            const closeBtn = popup.querySelector('#close-drunk-guard-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drunk_guard"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 金属探测器弹窗（适配Leaflet标记系统）
        function showMetalDetectorPopup(item, index) {
            const title = `🧭 金属探测器 #${index + 1}`;
            const content = `您可以使用金属探测器在 佩里科岛 上定位 地下藏匿品 - 。<br/>搜索骷髅可获得 5.000 至 10.000 GTA$ 不等的现金奖励。`;
            const imgUrl = `https://gta-maps.antwen.com/collectibles_images/metal_detector/metal_detector_${index + 1}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'metal-detector-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #607D8B; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #455A64; text-align:center;">${title}</div>
                <img src="${imgUrl}" alt="金属探测器图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #ECEFF1; border-radius: 8px; color: #263238; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-metal-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-metal-btn');

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 辅助函数：通过DOM元素查找对应的Leaflet标记对象
        function findLeafletMarkerByElement(element) {
            console.log('查找Leaflet标记，leafletMarkers.length:', leafletMarkers.length);
            for (let i = 0; i < leafletMarkers.length; i++) {
                const marker = leafletMarkers[i];
                if (marker && marker.getElement) {
                    const markerElement = marker.getElement();
                    console.log(`标记${i}:`, marker, '元素:', markerElement);
                    if (markerElement === element) {
                        console.log('找到匹配的标记!');
                        return marker;
                    }
                }
            }
            console.log('没有找到匹配的标记');
            return null;
        }

        // 更新侧边栏 smuggler_plane 计数
        function updateSmugglerPlaneSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smuggler_plane + label .smuggler-counter');
                if (!counterEl) return;
                const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
                let total = 0;
                let hidden = 0;
                if (Array.isArray(groups) && groups.length > 0) {
                    total = groups.length;
                    groups.forEach((groupMarkers) => {
                        if (groupMarkers && groupMarkers.length > 0) {
                            const first = groupMarkers[0];
                            if (first && first.getElement) {
                                const el = first.getElement();
                                if (el && el.style.opacity === '0.3') hidden++;
                            }
                        }
                    });
                } else {
                    total = Array.isArray(itemData.smuggler_plane) ? itemData.smuggler_plane.length : 0;
                    hidden = 0;
                }
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {}
        }

        // gun_van 侧边计数器已移除（占位空函数，避免旧调用报错）
        function updateGunVanSidebarCount() {}


        // 走私贩踪迹弹窗
        function showSmugglerTrailPopup(item, index) {
            const title = `🛤️ 走私贩踪迹 #${index + 1}`;
            const content = `沿着由几个烟雾信号标记的轨迹，您将找到一个装有25.000 GTA$和2.000 RP的箱子。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/smuggler_trail/smuggler_trail.webp';
            
            const popup = document.createElement('div');
            popup.className = 'smuggler-trail-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="走私贩踪迹图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-smuggler-trail-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-smuggler-trail-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-smuggler-trail-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-smuggler-trail-btn');
            const showBtn = popup.querySelector('#show-smuggler-trail-btn');
            const closeBtn = popup.querySelector('#close-smuggler-trail-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="smuggler_trail"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 犯罪现场弹窗
        function showCrimeScenesPopup(item, index) {
            const title = `🔍 犯罪现场 #${index + 1}`;
            const content = `前 5 次完成该随机事件时，每次您都将获得 5.000 GTA$、2.000 RP 与 1 个卡宾枪部件。集齐 5 个部件后，您将获得 50.000 GTA$ 与 制式卡宾步枪。此后，完成一次该随机事件可获得 25.000 GTA$ 与 2.000 RP 奖励。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/crime_scenes/crime_scenes.webp';
            
            const popup = document.createElement('div');
            popup.className = 'crime-scenes-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF5722; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #D84315; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="犯罪现场图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #FFF3E0; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-crime-scenes-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-crime-scenes-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-crime-scenes-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-crime-scenes-btn');
            const showBtn = popup.querySelector('#show-crime-scenes-btn');
            const closeBtn = popup.querySelector('#close-crime-scenes-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="crime_scenes"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // UFO观光弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showUfoPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ufo/ufo_${sequenceNumber}.webp`;
            const content = `可于 晚上 1000至次日早上 400 （万圣节天气期间为 晚上 730至次日早上 630 ）期间找到。
奖励:
拍摄 UFO 并将其发送给欧米加，即可获得 15.000 GTA$ 和 1.000 RP 奖励。
拍摄所有 26 张照片以赚取额外 100.000 GTA$ 奖励，并解锁 UFO 主题帽子。
拍摄 潜行 UFO ，以赚取额外 50.000 GTA$ 与 1.000 RP 奖励。
可被 UFO 捕获时，本网站的游戏时钟组件下会有  标识。被 UFO 捕获即可获得 UFO 主题平角裤与。若您在被捕获时未注册为老大（保镖事务所、摩托帮）或担任副手，您将有 50% 的概率进入桑库多堡垒军事基地的秘密地下实验室。实验室中有一个箱子。首次开启时可获得武器电击棒与灰色太空入侵者；此后再次开启时可获得 25.000 GTA$（若您曾在前 60 分钟内于此处获得过此奖励，则只能获得 2.000 GTA$）与 1.000 RP 奖励。要逃离实验室，您必须按正确顺序拉下 4 根控制杆。每根控制杆都有各自对应的独特图案。拉控制杆的顺序则以这些图案出现在实验室内的次数而决定。成功逃离实验室，您将获得 ??? T 恤、25.000 GTA$ 与 1.000 RP 奖励。若您未能在 10 分钟内逃离，或拉下错误的控制杆达到 3 次，实验室将释放毒气将您迷晕，您将无法获得成功逃离的奖励。
总计收益（不包括实验室内的奖励）：540.000 GTA$、27.000 RP`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.ufo-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.ufoMarkers && window.ufoMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🛸 UFO观光 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'ufo-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="UFO观光 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ufo-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ufo-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ufo-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-ufo-btn');
            const hideBtn = popup.querySelector('#hide-ufo-btn');
            const showBtn = popup.querySelector('#show-ufo-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ufo-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ufo', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🛸 UFO观光 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateUfoSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🛸 UFO观光 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateUfoSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到UFO观光标记
        function applyUfoVisibilityCache() {
            const markers = (window.ufoMarkers && window.ufoMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ufo');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用UFO观光可见性缓存');
                return true;
            }
            return false;
        }

        // 万圣节杀人狂弹窗
        function showHalloweenSlasherPopup(item, index) {
            const title = `🎃 ${item.type}`;
            const content = `杀人狂可能会在 早上 100至早上 600 之间出现在对应区域。每次出现都有 50% 的概率被克隆杀人狂替代。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/halloween_slashers/halloween_slashers.webp';
            
            // 为不同种类的杀人狂设置不同的颜色
            let borderColor, titleColor, bgColor;
            switch(item.type) {
                case 'clown':
                    borderColor = '#FF9800'; // 橙色
                    titleColor = '#E65100';
                    bgColor = '#FFF3E0';
                    break;
                case 'psycho':
                    borderColor = '#F44336'; // 红色
                    titleColor = '#C62828';
                    bgColor = '#FFEBEE';
                    break;
                case 'driver':
                    borderColor = '#9C27B0'; // 紫色
                    titleColor = '#7B1FA2';
                    bgColor = '#F3E5F5';
                    break;
                case 'sackslasher':
                    borderColor = '#607D8B'; // 蓝灰色
                    titleColor = '#37474F';
                    bgColor = '#ECEFF1';
                    break;
                default:
                    borderColor = '#795548'; // 棕色
                    titleColor = '#5D4037';
                    bgColor = '#EFEBE9';
            }
            
            const popup = document.createElement('div');
            popup.className = 'halloween-slasher-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${borderColor}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: ${titleColor}; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="万圣节杀人狂图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: ${bgColor}; border-radius: 8px; color: ${titleColor}; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-halloween-slasher-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-halloween-slasher-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-halloween-slasher-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-halloween-slasher-btn');
            const showBtn = popup.querySelector('#show-halloween-slasher-btn');
            const closeBtn = popup.querySelector('#close-halloween-slasher-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="halloween_slashers"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 鬼上身动物弹窗
        function showPossessedAnimalPopup(item, index) {
            const animalName = item.animalType === 'boar' ? '野猪' : 
                              item.animalType === 'cougar' ? '美洲狮' : 
                              item.animalType === 'coyote' ? '郊狼' : 
                              item.animalType === 'deer' ? '鹿' : 
                              item.animalType === 'pug' ? '哈巴狗' : 
                              item.animalType;
            const title = `🐺 ${animalName}`;
            const content = `鬼上身的动物在晚上 800至次日早上 100之间活跃。`;
            
            // 根据动物类型选择图片
            let imageUrl;
            if (item.animalType === 'boar') {
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_boar.webp';
            } else if (item.animalType === 'cougar') {
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_cougar.webp';
            } else {
                // 默认使用野猪图片
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_boar.webp';
            }
            
            // 为不同种类的动物设置不同的颜色
            let borderColor, titleColor, bgColor;
            switch(item.animalType) {
                case 'boar':
                    borderColor = '#8D6E63'; // 棕色
                    titleColor = '#5D4037';
                    bgColor = '#EFEBE9';
                    break;
                case 'cougar':
                    borderColor = '#FF5722'; // 橙红色
                    titleColor = '#D84315';
                    bgColor = '#FFF3E0';
                    break;
                case 'coyote':
                    borderColor = '#795548'; // 深棕色
                    titleColor = '#4E342E';
                    bgColor = '#F3E5F5';
                    break;
                case 'deer':
                    borderColor = '#4CAF50'; // 绿色
                    titleColor = '#2E7D32';
                    bgColor = '#E8F5E8';
                    break;
                case 'pug':
                    borderColor = '#9C27B0'; // 紫色
                    titleColor = '#6A1B9A';
                    bgColor = '#F3E5F5';
                    break;
                default:
                    borderColor = '#607D8B'; // 蓝灰色
                    titleColor = '#37474F';
                    bgColor = '#ECEFF1';
            }
            
            const popup = document.createElement('div');
            popup.className = 'possessed-animal-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${borderColor}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: ${titleColor}; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="鬼上身动物图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: ${bgColor}; border-radius: 8px; color: ${titleColor}; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-possessed-animal-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-possessed-animal-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-possessed-animal-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-possessed-animal-btn');
            const showBtn = popup.querySelector('#show-possessed-animal-btn');
            const closeBtn = popup.querySelector('#close-possessed-animal-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="possessed_animals"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 地狱犬弹窗
        function showCerberusPopup(item, index) {
            const title = `地狱犬 #${index + 1}`;
            const content = `偷窃外贸出口载具的同时，请务必小心紧追您的地狱犬。`;
            
            const popup = document.createElement('div');
            popup.className = 'cerberus-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF5722; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #D84315; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #FFF3E0; border-radius: 8px; color: #D84315; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-cerberus-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-cerberus-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-cerberus-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-cerberus-btn');
            const showBtn = popup.querySelector('#show-cerberus-btn');
            const closeBtn = popup.querySelector('#close-cerberus-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="cerberus"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 雪怪弹窗
        function showYetiPopup(item, index) {
            const title = `❄️ 雪怪线索 #${item.clueIndex}`;
            const content = `一共有五条线索，且可由任意顺序收集。线索会发出声音以帮助您寻找，找到后，您需按E进行调查。每条线索都将奖励您10.000 GTA$与1.000 RP。集齐所有线索后，雪怪将于晚上 900至次日早上 600期间持续追杀您，直到您将其击杀。击杀时，您将获得50.000 GTA$与<span id="yeti-award-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">雪怪套装</span>奖励。`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/yeti/yeti_${item.clueIndex}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'yeti-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="雪怪线索图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #1976D2; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-yeti-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-yeti-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-yeti-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-yeti-btn');
            const showBtn = popup.querySelector('#show-yeti-btn');
            const closeBtn = popup.querySelector('#close-yeti-btn');
            const awardLink = popup.querySelector('#yeti-award-link');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="yeti"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            
            // 雪怪套装点击事件
            awardLink.addEventListener('click', () => {
                showYetiAwardPopup();
            });
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 雪怪套装奖励弹窗
        function showYetiAwardPopup() {
            const popup = document.createElement('div');
            popup.className = 'yeti-award-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF9800; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 400px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 18px; font-weight: bold; color: #F57C00;">🏆 雪怪套装奖励</div>
                <img src="https://gta-maps.antwen.com/collectibles_images/yeti/yeti_award.webp" alt="雪怪套装奖励" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin-top: 15px;">
                    <button id="close-yeti-award-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-yeti-award-btn');
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 节日快乐卡车弹窗
        function showHappyHolidaysHaulerPopup(group, index) {
            console.log('显示节日快乐卡车弹窗:', group, index);
            const title = `🎄 节日快乐卡车 #${index + 1}`;
            const content = `节日欢乐货运车已开始在洛圣都四处行驶，每 85-95 秒投放一次节日礼物。<br><br>可能的礼物清单：<br>– <span id="coca-cola-sweater-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">易可乐节庆毛衣</span><br>– <span id="sprite-sweater-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">霜碧节庆毛衣</span><br>– 9.000-11.000 GTA$，1.000 RP和零食<br>– 9.000-11.000 GTA$，1.000 RP和弹药`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/yeti_award.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'happy-holidays-hauler-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="${imageUrl}" alt="节日快乐卡车" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="text-align: center;">
                    <button id="close-hauler-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-hauler-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // 添加毛衣链接点击事件
            const cocaColaLink = popup.querySelector('#coca-cola-sweater-link');
            const spriteLink = popup.querySelector('#sprite-sweater-link');
            
            cocaColaLink.addEventListener('click', (e) => {
                e.stopPropagation();
                showCocaColaSweaterPopup();
            });
            
            spriteLink.addEventListener('click', (e) => {
                e.stopPropagation();
                showSpriteSweaterPopup();
            });
            
            // 点击外部关闭
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 威泽尔大楼枪战弹窗
        function showWeaPopup(wea, index) {
            console.log('显示威泽尔大楼枪战弹窗:', wea, index);
            const title = `🏢 威泽尔大楼枪战`;
            const content = `该事件可以在晚上 800至次日早上 600之间触发。首次完成该活动，您将获得 1.000 RP，WM 29 手枪和 Mk 2 手枪的节日快乐涂装。再次完成该活动，您将获得25.000 GTA$和1.000 RP。`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/wea/wea.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'wea-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #e03232; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #e03232; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="${imageUrl}" alt="威泽尔大楼枪战" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="text-align: center;">
                    <button id="close-wea-btn" style="padding: 10px 18px; background: #e03232; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-wea-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // 点击外部关闭
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 陆地迷幻仙人掌弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showPplPopup(ppl, index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ppl/ppl_${sequenceNumber}.webp`;
            const content = `游戏中共有 76 个迷幻仙人掌（52 个在陆地上 （包含 2 个特殊的迷幻仙人掌 ），另有 24 个在水下 ）。迷幻仙人掌并不立即出现，有时您须稍等片刻。当您靠近它时，游戏手柄会振动，它还会发出类似动物叫声的声音。吃下（按键：E）迷幻仙人掌后，您将变成 随机动物 中的其中一种，并获得 5.000 RP。您会一直维持动物形态，除非您：死亡、入水/上岸，或按住 E。以上情况都会令您在最近的医院重生。吃过的迷幻仙人掌将在 48 分钟后刷新。切换战局或重启游戏不会重置冷却时间。`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.ppl-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🌵 陆地迷幻仙人掌 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'ppl-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;
            
            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="陆地迷幻仙人掌 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ppl-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ppl-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ppl-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;
            
            // 绑定元素
            const closeBtn = popup.querySelector('#close-ppl-btn');
            const hideBtn = popup.querySelector('#hide-ppl-btn');
            const showBtn = popup.querySelector('#show-ppl-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ppl-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ppl', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🌵 陆地迷幻仙人掌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePplSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🌵 陆地迷幻仙人掌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePplSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到陆地迷幻仙人掌标记
        function applyPplVisibilityCache() {
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppl');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用陆地迷幻仙人掌可见性缓存');
                return true;
            }
            return false;
        }

        // 水下迷幻仙人掌弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showPpwPopup(ppw, index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ppw/ppw_${sequenceNumber}.webp`;
            const content = `游戏中共有 76 个迷幻仙人掌（52 个在陆地上 （包含 2 个特殊的迷幻仙人掌 ），另有 24 个在水下 ）。迷幻仙人掌并不立即出现，有时您须稍等片刻。当您靠近它时，游戏手柄会振动，它还会发出类似动物叫声的声音。吃下（按键：E）迷幻仙人掌后，您将变成 随机动物 中的其中一种，并获得 5.000 RP。您会一直维持动物形态，除非您：死亡、入水/上岸，或按住 E。以上情况都会令您在最近的医院重生。吃过的迷幻仙人掌将在 48 分钟后刷新。切换战局或重启游戏不会重置冷却时间。`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.ppw-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🌊 水下迷幻仙人掌 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'ppw-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;
            
            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="水下迷幻仙人掌 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ppw-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ppw-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ppw-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;
            
            // 绑定元素
            const closeBtn = popup.querySelector('#close-ppw-btn');
            const hideBtn = popup.querySelector('#hide-ppw-btn');
            const showBtn = popup.querySelector('#show-ppw-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ppw-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ppw', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🌊 水下迷幻仙人掌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updatePpwSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🌊 水下迷幻仙人掌 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updatePpwSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到水下迷幻仙人掌标记
        function applyPpwVisibilityCache() {
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppw');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用水下迷幻仙人掌可见性缓存');
                return true;
            }
            return false;
        }

        // 新物品弹窗（地铁站、警察局、望远镜、消防局、医院）
        function showNewItemPopup(type, item, index) {
            console.log(`显示${type}弹窗:`, item, index);
            
            const typeNames = {
                metro: { name: '地铁站', emoji: '🚇', color: '#2196F3' },
                police: { name: '警察局', emoji: '🚔', color: '#2196F3' },
                v_telescopes: { name: '望远镜', emoji: '🔭', color: '#9C27B0' },
                fire_stations: { name: '消防局', emoji: '🚒', color: '#f44336' },
                hospitals: { name: '医院', emoji: '🏥', color: '#4CAF50' },
                clothing: { name: '服装店', emoji: '👕', color: '#FF9800' },
                tattoos: { name: '纹身店', emoji: '🎨', color: '#E91E63' },
                barbers: { name: '理发店', emoji: '💇', color: '#795548' },
                ammunation: { name: '武装国度', emoji: '🔫', color: '#FF5722' },
                mod_shop: { name: '洛圣都改车王', emoji: '🔧', color: '#607D8B' },
                car_wash: { name: '洗车店', emoji: '🧽', color: '#00BCD4' },
                shops_to_rob: { name: '可抢劫的商店', emoji: '🏪', color: '#F44336' },
                gas_stations: { name: '加油站', emoji: '⛽', color: '#FFC107' },
                atms: { name: 'ATM机', emoji: '💰', color: '#4CAF50' },
                vend_sprunk: { name: '霜碧售卖机', emoji: '🥤', color: '#8BC34A' },
                vend_ecola: { name: '易可乐售卖机', emoji: '🥤', color: '#CDDC39' }
            };
            
            const typeInfo = typeNames[type];
            const title = `${typeInfo.emoji} ${typeInfo.name} #${index + 1}`;
            const content = getNewItemContent(type, item);
            
            const popup = document.createElement('div');
            popup.className = `${type}-popup`;
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${typeInfo.color}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: ${typeInfo.color}; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-${type}-btn" style="padding: 10px 18px; background: ${typeInfo.color}; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-${type}-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-${type}-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;
            
            const hideBtn = popup.querySelector(`#hide-${type}-btn`);
            const showBtn = popup.querySelector(`#show-${type}-btn`);
            const closeBtn = popup.querySelector(`#close-${type}-btn`);

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 点击外部关闭
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 获取新物品的内容信息
        function getNewItemContent(type, item) {
            const baseInfo = `坐标: ${item.x}, ${item.y}`;
            const labelInfo = item.label ? `<br><br>标签: ${item.label}` : '';
            
            switch(type) {
                case 'metro':
                    return `地铁站位置信息。<br><br>${baseInfo}${labelInfo}<br><br>地铁站是洛圣都公共交通系统的重要组成部分，连接城市各个区域。`;
                case 'police':
                    return `警察局位置信息。<br><br>${baseInfo}${labelInfo}<br><br>警察局是执法部门的重要设施，提供各种执法服务。`;
                case 'v_telescopes':
                    return `望远镜位置信息。<br><br>${baseInfo}<br><br>望远镜是观察和探索洛圣都美景的理想工具。`;
                case 'fire_stations':
                    return `消防局位置信息。<br><br>${baseInfo}${labelInfo}<br><br>消防局负责处理火灾和其他紧急情况，保护市民安全。`;
                case 'hospitals':
                    return `医院位置信息。<br><br>${baseInfo}${labelInfo}<br><br>医院提供医疗服务，是市民健康的重要保障。`;
                case 'clothing':
                    return `服装店位置信息。<br><br>${baseInfo}${labelInfo}<br><br>服装店提供各种服装和配饰，让您打造独特的个人风格。`;
                case 'tattoos':
                    return `纹身店位置信息。<br><br>${baseInfo}${labelInfo}<br><br>纹身店提供专业的纹身服务，让您展现个性。`;
                case 'barbers':
                    return `理发店位置信息。<br><br>${baseInfo}${labelInfo}<br><br>理发店提供理发和造型服务，让您保持最佳形象。`;
                case 'ammunation':
                    return `武装国度位置信息。<br><br>${baseInfo}${labelInfo}<br><br>武装国度是购买武器和弹药的专业商店。`;
                case 'mod_shop':
                    return `洛圣都改车王位置信息。<br><br>${baseInfo}${labelInfo}<br><br>洛圣都改车王提供专业的车辆改装服务，包括LSC、班尼改装坊和洛圣都车友会等不同类型的改装服务。`;
                case 'car_wash':
                    return `洗车店位置信息。<br><br>${baseInfo}${labelInfo}<br><br>洗车店提供专业的车辆清洁服务。`;
                case 'shops_to_rob':
                    return `可抢劫的商店位置信息。<br><br>${baseInfo}${labelInfo}<br><br>这些商店可以进行抢劫活动，但请注意风险。`;
                case 'gas_stations':
                    return `加油站位置信息。<br><br>${baseInfo}${labelInfo}<br><br>加油站为您的车辆提供燃料补给服务。`;
                case 'atms':
                    return `ATM机位置信息。<br><br>${baseInfo}${labelInfo}<br><br>ATM机提供便捷的现金存取服务。`;
                case 'vend_sprunk':
                    return `霜碧售卖机位置信息。<br><br>${baseInfo}${labelInfo}<br><br>霜碧售卖机提供清爽的霜碧饮料。`;
                case 'vend_ecola':
                    return `易可乐售卖机位置信息。<br><br>${baseInfo}${labelInfo}<br><br>易可乐售卖机提供经典的易可乐饮料。`;
                default:
                    return `${type}位置信息。<br><br>${baseInfo}${labelInfo}`;
            }
        }

        // 易可乐节庆毛衣弹窗
        function showCocaColaSweaterPopup() {
            const popup = document.createElement('div');
            popup.className = 'coca-cola-sweater-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">🥤 易可乐节庆毛衣</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/happy_holidays_hauler_sweater_0.webp" alt="易可乐节庆毛衣" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="text-align: center;">
                    <button id="close-coca-cola-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-coca-cola-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // 点击外部关闭
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 霜碧节庆毛衣弹窗
        function showSpriteSweaterPopup() {
            const popup = document.createElement('div');
            popup.className = 'sprite-sweater-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">🥤 霜碧节庆毛衣</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/happy_holidays_hauler_sweater_1.webp" alt="霜碧节庆毛衣" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="text-align: center;">
                    <button id="close-sprite-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-sprite-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // 点击外部关闭
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 社区边界弹窗
        function showCommunityOutreachPopup(item, index) {
            const title = `🏘️ 社区边界 #${index + 1}`;
            const content = `该事件既没有任务目标，也没有完成奖励。不过，您可以藉此免费试驾非凡 艳妇 D10 追逐和威拉德 边界宗派。`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/community_outreach/community_outreach_${index + 1}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'community-outreach-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #2E7D32; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="社区边界图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E8F5E8; border-radius: 8px; color: #2E7D32; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-community-outreach-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-community-outreach-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-community-outreach-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-community-outreach-btn');
            const showBtn = popup.querySelector('#show-community-outreach-btn');
            const closeBtn = popup.querySelector('#close-community-outreach-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="community_outreach"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 外贸出口载具弹窗
        function showExoticExportsPopup(item, index, type) {
            const title = `🚗 外贸出口载具${type === 'exotic_exports1' ? '1' : '2'} #${index + 1}`;
            
            // 构建车辆列表内容
            let vehicleListContent = '';
            if (item.vehicleList && item.vehicleList.length > 0) {
                vehicleListContent = item.vehicleList.map(vehicle => `• ${vehicle.trim()}`).join('<br>');
            } else {
                vehicleListContent = '暂无车辆数据';
            }
            
            const content = `
                <div style="margin-bottom: 10px;">
                    <strong>今日外贸出口载具列表：</strong><br>
                    ${vehicleListContent}
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    该活动将在完成一个改车铺合约后解锁。您每天可以找到并交付 10 辆外贸载具，这 10 辆外贸载具以特定顺序生成。每送达一辆外贸载具，您将获得 20.000 GTA$、1.000 RP 与 50 REP 奖励。若在一天内交付全部 10 辆外贸载具，还可获得额外 100.000 GTA$ 的奖励。
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'exotic-exports-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #1565C0; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-exotic-exports-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-exotic-exports-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-exotic-exports-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-exotic-exports-btn');
            const showBtn = popup.querySelector('#show-exotic-exports-btn');
            const closeBtn = popup.querySelector('#close-exotic-exports-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 商店抢劫弹窗
        function showStoreRobberyPopup(item, index) {
            const title = `🏪 商店抢劫 #${index + 1}`;
            const content = `在 2 分钟内将被盗的现金还给商店，即可获得 20.000 GTA$ 与 2.500 RP 奖励。或者，您也可以选择将其据为己有：25.000 GTA$ 和 2 个通缉等级。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/store_robbery/store_robbery.webp';
            
            const popup = document.createElement('div');
            popup.className = 'store-robbery-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF9800; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #E65100; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="商店抢劫图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #FFF8E1; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-store-robbery-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-store-robbery-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-store-robbery-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-store-robbery-btn');
            const showBtn = popup.querySelector('#show-store-robbery-btn');
            const closeBtn = popup.querySelector('#close-store-robbery-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="store_robbery"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 车队弹窗
        function showConvoyPopup(item, index) {
            const title = `🚛 车队 #${index + 1}`;
            const content = `车队从起始点出发，沿着红色路线行驶。车队走完路线后，将随机选择一个终点位置继续行驶，并在抵达该位置后消失。<br><br>偷取车队载具并将其送至您的产业，您将获得原材料补给和 1.000 RP。<br><br>每个地点分别对应不同的载具与产业。<br><br>如果您没有对应的产业，可以把目标载具送至指定投放点，您将获得 25.000 GTA$ 与 1.000 RP。`;
            
            const popup = document.createElement('div');
            popup.className = 'convoy-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #F44336; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #C62828; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #FFEBEE; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-convoy-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-convoy-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-convoy-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-convoy-btn');
            const showBtn = popup.querySelector('#show-convoy-btn');
            const closeBtn = popup.querySelector('#close-convoy-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="convoy"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
                // 同时隐藏对应的路线
                const lines = document.querySelectorAll(`.convoy-route-line[data-index="${index}"]`);
                lines.forEach(line => line.style.opacity = '0.25');
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
                // 同时显示对应的路线
                const lines = document.querySelectorAll(`.convoy-route-line[data-index="${index}"]`);
                lines.forEach(line => line.style.opacity = '1');
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 车队终点弹窗
        function showConvoyFinalPopup(item, index) {
            const title = `🏁 车队终点 #${index + 1}`;
            const content = `这是车队可能到达的终点位置之一。车队走完路线后，将随机选择一个终点位置继续行驶，并在抵达该位置后消失。<br><br>您可以在车队路线上拦截车队，或者在终点等候车队到达。`;
            
            const popup = document.createElement('div');
            popup.className = 'convoy-final-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #388E3C; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #E8F5E8; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-convoy-final-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-convoy-final-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-convoy-final-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-convoy-final-btn');
            const showBtn = popup.querySelector('#show-convoy-final-btn');
            const closeBtn = popup.querySelector('#close-convoy-final-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="convoy_final"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 装甲运钞车弹窗
        function showArmoredTruckPopup(item, index) {
            const title = `💰 装甲运钞车 #${index + 1}`;
            const content = `使用黏弹炸开运钞车的后门以获取里面的现金——25.000 GTA$和1.000 RP。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/armored_truck/armored_truck.webp';
            
            const popup = document.createElement('div');
            popup.className = 'armored-truck-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="装甲运钞车图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #F3E5F5; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-armored-truck-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-armored-truck-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-armored-truck-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-armored-truck-btn');
            const showBtn = popup.querySelector('#show-armored-truck-btn');
            const closeBtn = popup.querySelector('#close-armored-truck-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="armored_truck"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 玛德拉索雇凶弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showMadrazoHitsPopup(item, index) {
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.madrazo-hits-popup');
            if (existingPopup) existingPopup.remove();

            // 玛德拉索雇凶特殊：固定为1个，虽然会显示多个图标
            const totalCount = 1;
            let hiddenCount = 0;

            // 检查是否有缓存的隐藏状态
            const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
            if (visibilityMap[0] === true) {
                hiddenCount = 1;
            }

            const title = `🎯 玛德拉索雇凶 #${index + 1} (${hiddenCount}/${totalCount})`;
            const content = `您需要拥有保金办公室  才能进行玛德拉索雇凶。<br><br>您每天都可接下马丁·玛德拉索的雇凶暗杀。干掉目标即可获得 500 RP 与 20.000 GTA$ 奖励，使用玛德拉索指定的武器完成暗杀还可额外获得 10.000 GTA$。目标的位置常驻于游戏内地图上，您可参考本地图的图标在游戏中查找。`;
            
            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'madrazo-hits-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${hiddenCount > 0 ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${hiddenCount > 0 ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-madrazo-hits-btn');
            const hideBtn = popup.querySelector('#hide-madrazo-hits-btn');
            const showBtn = popup.querySelector('#show-madrazo-hits-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 工具：隐藏/显示所有玛德拉索雇凶标记
            function setAllMadrazoHitsVisibility(opacity) {
                // 隐藏/显示所有玛德拉索雇凶标记
                const markers = (window.madrazoHitsMarkers && window.madrazoHitsMarkers) || [];
                markers.forEach((marker) => {
                    if (marker && typeof marker.setOpacity === 'function') {
                        marker.setOpacity(opacity);
                    } else if (marker && typeof marker.setStyle === 'function') {
                        marker.setStyle({ opacity });
                    }
                });
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('madrazo_hits', 0, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setAllMadrazoHitsVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `🎯 玛德拉索雇凶 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateMadrazoHitsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
            showBtn.addEventListener('click', () => {
                    setAllMadrazoHitsVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `🎯 玛德拉索雇凶 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // 刷新侧边栏计数
                    updateMadrazoHitsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 帕特里克救援弹窗
        function showPatrickRescuePopup(item, index, type) {
            const typeNames = {
                'spawn': '生成点',
                'dropoff': '送达点'
            };
            
            const title = `🚔 帕特里克救援 - ${typeNames[type]} #${index + 1}`;
            const content = `寻找正在鸣笛巡逻的警用运输车。这辆车以蓝点标记在地图上。拦截囚车，救出囚犯。囚车会生成在 ，您需要将其送至 。运气好的话，您也有可能在送达点发现事件。<br><br>奖励：10.000 GTA$、2.000 RP，解锁名钻赌场豪劫的枪手帕特里克·麦克瑞利（8% 分红）。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/patrick/patrick.webp';
            
            const popup = document.createElement('div');
            popup.className = 'patrick-rescue-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2;">${title}</div>
                <img src="${imageUrl}" alt="帕特里克救援图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 8px; color: #4e342e; font-size: 13px; text-align: left; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-patrick-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-patrick-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-patrick-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-patrick-btn');
            const showBtn = popup.querySelector('#show-patrick-btn');
            const closeBtn = popup.querySelector('#close-patrick-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="police_rescue_patrick_mcreary_${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 随机任务弹窗
        function showRandomMissionPopup(mission, timeSlot, index) {
            if (!Array.isArray(mission) || mission.length < 4) return;
            
            const taskName = Array.isArray(mission[2]) ? mission[2][0] : mission[2];
            const details = mission[3];
            
            if (!Array.isArray(details) || details.length < 3) return;
            
            const level = details[0];
            const players = details[1];
            const timeRange = details[2];
            
            const title = `🎲 随机任务 - ${taskName}`;
            const content = `
                <div style="margin-bottom: 10px;">
                    <strong>任务名:</strong> ${taskName}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>开放等级:</strong> ${level}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>人数:</strong> ${players}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>开放时间:</strong> ${timeRange}
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'random-mission-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px; color: #4e342e; font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-random-mission-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-random-mission-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-random-mission-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-random-mission-btn');
            const showBtn = popup.querySelector('#show-random-mission-btn');
            const closeBtn = popup.querySelector('#close-random-mission-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="random_missions"][data-time-slot="${timeSlot}"][data-mission-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 电影道具弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showMoviePropsPopup(item, globalIndex, subtype) {
            const typeNames = {
                'fixed_position': '固定位置',
                'pony': 'Pony载具',
                'rebel': 'Rebel载具',
                'rumpo': 'Rumpo载具'
            };
            
            const imageUrls = {
                'fixed_position': 'ls_c_mp_static',
                'pony': 'ls_c_mp_pony',
                'rebel': 'ls_c_mp_rebel',
                'rumpo': 'ls_c_mp_rumpo'
            };
            
            // 计算子类型索引
            const mp = itemData.movie_props;
            const fixedCount = mp.fixed_position?.length || 0;
            const ponyCount = mp.vehicles?.pony?.length || 0;
            const rebelCount = mp.vehicles?.rebel?.length || 0;
            
            let subtypeIndex = globalIndex;
            if (subtype === 'pony') subtypeIndex = globalIndex - fixedCount;
            else if (subtype === 'rebel') subtypeIndex = globalIndex - fixedCount - ponyCount;
            else if (subtype === 'rumpo') subtypeIndex = globalIndex - fixedCount - ponyCount - rebelCount;
            
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${imageUrls[subtype]}/${imageUrls[subtype]}_${(subtypeIndex + 1)}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.movie-props-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数（固定点逐个计数，三类载具按组计数）
            const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
            const totalCount = 10; // 固定为10个（7固定 + 3 载具组）

            // 可见性来源：优先缓存
            let visibilityMap;
            try { visibilityMap = VisibilityCache.loadVisibility('movie_props') || []; } catch (_) { visibilityMap = []; }

            const getHiddenByIndex = (i) => {
                if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                const m = markers[i];
                if (!m) return false;
                if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                return false;
            };

            // 固定点逐一统计
            let hiddenFixed = 0;
            for (let i = 0; i < fixedCount; i++) if (getHiddenByIndex(i)) hiddenFixed++;

            // 组范围
            const ponyStart = fixedCount;
            const ponyEnd = ponyStart + ponyCount;
            const rebelStart = ponyEnd;
            const rebelEnd = rebelStart + rebelCount;
            const rumpoStart = rebelEnd;
            const rumpoEnd = rumpoStart + (mp.vehicles?.rumpo?.length || 0);

            const rangeAllHidden = (start, end) => {
                if (start >= end) return false;
                for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                return true;
            };

            let ponyHidden = rangeAllHidden(ponyStart, ponyEnd);
            let rebelHidden = rangeAllHidden(rebelStart, rebelEnd);
            let rumpoHidden = rangeAllHidden(rumpoStart, rumpoEnd);

            const hiddenCount = hiddenFixed + (ponyHidden ? 1 : 0) + (rebelHidden ? 1 : 0) + (rumpoHidden ? 1 : 0);

            // 当前标记引用（用于固定点直接设置透明度）
            const currentMarker = markers[globalIndex];

            // 当前是否隐藏（固定点看自身；载具看所在组）
            let isCurrentHidden = false;
            if (subtype === 'fixed_position') {
                isCurrentHidden = getHiddenByIndex(globalIndex);
            } else if (subtype === 'pony') {
                isCurrentHidden = ponyHidden;
            } else if (subtype === 'rebel') {
                isCurrentHidden = rebelHidden;
            } else if (subtype === 'rumpo') {
                isCurrentHidden = rumpoHidden;
            }

            const title = `🎬 电影道具 - ${typeNames[subtype]} #${subtypeIndex + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'movie-props-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="电影道具 #${subtypeIndex + 1}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    前往  接取电影道具搜寻任务。电影道具共有 10 个，其中 7 个位置固定，另外 3 个在载具里。每辆载具都有 3 个可能的生成点，其中 1 个会生成移动的载具。当您离生成点足够接近时，载具会以蓝点标记在地图上。如这些生成点都没有生成载具，您可以更换战局继续寻找。<br><br>
                    奖励：每个道具 10.000 GTA$。载具 2.000 RP，其他固定道具 5.000 RP。前往  交付道具以领取奖励。您没必要每收集一个就交付一个，多个道具同时交付时奖励会累加计算。此外，集齐全套收藏品还将获得 50.000 GTA$ 并解锁 太空入侵者 套装（前往 ，从盒子  里领取）。<br><br>
                    总收益：150.000 GTA$、41.000 RP 和套装。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-movie-props-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-movie-props-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-movie-props-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-movie-props-btn');
            const hideBtn = popup.querySelector('#hide-movie-props-btn');
            const showBtn = popup.querySelector('#show-movie-props-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'movie-props-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记（实现特殊隐藏逻辑）
            function setCurrentMarkerVisibility(opacity) {
                if (subtype === 'fixed_position') {
                    // 固定位置：单独隐藏
                    if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                    // 更新缓存
                    VisibilityCache.updateItemVisibility('movie_props', globalIndex, opacity === 0.3);
                } else {
                    // 载具类型：隐藏同类的所有图标
                    let startIndex, endIndex;
                    if (subtype === 'pony') {
                        startIndex = fixedCount;
                        endIndex = fixedCount + ponyCount;
                    } else if (subtype === 'rebel') {
                        startIndex = fixedCount + ponyCount;
                        endIndex = fixedCount + ponyCount + rebelCount;
                    } else if (subtype === 'rumpo') {
                        startIndex = fixedCount + ponyCount + rebelCount;
                        endIndex = startIndex + (mp.vehicles?.rumpo?.length || 0);
                    }
                    
                    // 隐藏同类型的所有标记
                    for (let idx = startIndex; idx < endIndex; idx++) {
                        const marker = markers[idx];
                        if (marker && typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (marker && typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        }
                        // 更新缓存
                        VisibilityCache.updateItemVisibility('movie_props', idx, opacity === 0.3);
                    }
                }
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    let newHiddenCount;
                    if (subtype === 'fixed_position') {
                        newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    } else if (subtype === 'pony') {
                        newHiddenCount = hiddenCount + (ponyHidden ? 0 : 1);
                        ponyHidden = true;
                    } else if (subtype === 'rebel') {
                        newHiddenCount = hiddenCount + (rebelHidden ? 0 : 1);
                        rebelHidden = true;
                    } else {
                        newHiddenCount = hiddenCount + (rumpoHidden ? 0 : 1);
                        rumpoHidden = true;
                    }
                    titleElement.textContent = `🎬 电影道具 - ${typeNames[subtype]} #${subtypeIndex + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateMoviePropsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    let newHiddenCount;
                    if (subtype === 'fixed_position') {
                        newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    } else if (subtype === 'pony') {
                        newHiddenCount = hiddenCount - (ponyHidden ? 1 : 0);
                        ponyHidden = false;
                    } else if (subtype === 'rebel') {
                        newHiddenCount = hiddenCount - (rebelHidden ? 1 : 0);
                        rebelHidden = false;
                    } else {
                        newHiddenCount = hiddenCount - (rumpoHidden ? 1 : 0);
                        rumpoHidden = false;
                    }
                    titleElement.textContent = `🎬 电影道具 - ${typeNames[subtype]} #${subtypeIndex + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateMoviePropsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 洛圣都杀人狂弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSlasherPopup(item, index, subtype) {
            const isFirst = subtype === 'first';
            const base = isFirst ? 'ls_slasher' : 'ls_slasher_final';
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index - 3 )}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.slasher-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.slasherMarkers && window.slasherMarkers) || [];
            const totalCount = 4; // 固定为4个（3个slasher1.svg + 1个slasher2.svg组）

            // 读取子类型数量（从数据源）
            const slasherData = (window.itemData && window.itemData.serial_killer_slasher) || { first: [], last: [] };
            const firstCount = slasherData.first?.length || 0;
            const lastCount = slasherData.last?.length || 0;

            // 可见性来源：优先缓存
            let visibilityMap;
            try { visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher') || []; } catch (_) { visibilityMap = []; }

            const getHiddenByIndex = (i) => {
                if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                const m = markers[i];
                if (!m) return false;
                if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                return false;
            };

            // slasher1.svg 逐一统计（前3个）
            let hiddenFirst = 0;
            for (let i = 0; i < firstCount; i++) if (getHiddenByIndex(i)) hiddenFirst++;

            // slasher2.svg 组范围（最后1个组，包含所有last标记）
            const lastStart = firstCount;
            const lastEnd = firstCount + lastCount;

            const rangeAllHidden = (start, end) => {
                if (start >= end) return false;
                for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                return true;
            };

            const lastHidden = rangeAllHidden(lastStart, lastEnd);
            const hiddenCount = hiddenFirst + (lastHidden ? 1 : 0);

            // 计算当前标记的全局索引
            let globalIndex = index;
            if (subtype === 'last') {
                globalIndex = firstCount + index;
            }

            const currentMarker = markers[globalIndex];
            let isCurrentHidden = false;
            if (subtype === 'first') {
                isCurrentHidden = getHiddenByIndex(globalIndex);
            } else {
                isCurrentHidden = lastHidden;
            }

            const title = isFirst ? `🩸 杀人狂线索 #${index + 1} (${hiddenCount}/${totalCount})` : `🩸 最后一条线索 #${index - 3} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'slasher-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="杀人狂线索" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(183, 28, 28, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    一共有 5 条线索。前四条线索 总是在相同的位置。集齐前 4 条后，最后一条线索 将在 5 个可能位置中的随机 1 处生成。<br><br>
                    线索会发出令人毛骨悚然的声音以帮助您定位它，您须按 E 来调查它。<br><br>
                    奖励：每条线索都会给您 5.000 GTA$ 和 2.000 RP。找到所有线索后，杀人狂会一直试图埋伏并杀死您，直到您消灭他。他只会在晚上 700 和早上 500 之间出现在布莱恩郡 。杀死他您将获得 50.000 GTA$ 和海军左轮手枪。用海军左轮手枪完成 50 次击杀，即可赚取 200.000 GTA$，并在 Red Dead 在线模式中解锁一款独家武器。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-slasher-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-slasher-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-slasher-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-slasher-btn');
            const hideBtn = popup.querySelector('#hide-slasher-btn');
            const showBtn = popup.querySelector('#show-slasher-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'slasher-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记（实现特殊隐藏逻辑）
            function setCurrentMarkerVisibility(opacity) {
                if (subtype === 'first') {
                    // slasher1.svg：单独隐藏
                    if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                    // 更新缓存
                    VisibilityCache.updateItemVisibility('serial_killer_slasher', globalIndex, opacity === 0.3);
                } else {
                    // slasher2.svg：隐藏同类的所有图标
                    const lastStart = firstCount;
                    const lastEnd = firstCount + lastCount;
                    
                    // 隐藏同类型的所有标记
                    for (let idx = lastStart; idx < lastEnd; idx++) {
                        const marker = markers[idx];
                        if (marker && typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (marker && typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        }
                        // 更新缓存
                        VisibilityCache.updateItemVisibility('serial_killer_slasher', idx, opacity === 0.3);
                    }
                }
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    let newHiddenCount;
                    if (subtype === 'first') {
                        newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    } else {
                        newHiddenCount = hiddenCount + (lastHidden ? 0 : 1);
                    }
                    titleElement.textContent = isFirst ? `🩸 杀人狂线索 #${index + 1} (${newHiddenCount}/${totalCount})` : `🩸 最后一条线索 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSlasherSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    let newHiddenCount;
                    if (subtype === 'first') {
                        newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    } else {
                        newHiddenCount = hiddenCount - (lastHidden ? 1 : 0);
                    }
                    titleElement.textContent = isFirst ? `🩸 杀人狂线索 #${index + 1} (${newHiddenCount}/${totalCount})` : `🩸 最后一条线索 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSlasherSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 左轮寻宝弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showTreasureHuntPopup(item, index, subtype) {
            const isRandom = subtype === 'random';
            const base = isRandom ? 'ls_th_dba_fc' : 'ls_th_dba_ltc';
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index + 1)}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.treasure-hunt-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
            const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
            const totalCount = 4; // 总数为4

            let hiddenCount = 0;
            // 检查th1标记（任意一个隐藏则全部隐藏，但计数器只+1）
            let th1Hidden = false;
            th1Markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') {
                        th1Hidden = true;
                    }
                }
            });
            if (th1Hidden) {
                hiddenCount += 1; // th1隐藏时计数器只+1
            }

            // 检查th2标记（单独计算）
            th2Markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') {
                        hiddenCount++;
                    }
                }
            });

            const currentMarker = isRandom ? th1Markers[index] : th2Markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = isRandom ? `🔎 左轮寻宝 - 随机线索 #${index + 1} (${hiddenCount}/${totalCount})` : `🔎 左轮寻宝 - 固定线索 #${index + 1} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'treasure-hunt-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(121, 85, 72, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    收到 vanderlinde@eyefind.com 的邮件后，第一条寻宝线索将随机出现在 20 个可能的位置（此处对应 <strong>th1.svg</strong>）之一。您可通过邮件中的黑白照片推断此线索的位置。游戏也会将线索所在的区域标记在地图上。本地图展示的是此线索的准确位置。线索会发出声音以帮助您找到它，您需按 E 对其进行调查。<br><br>
                    找到首条线索后，您还需要寻找剩余三处线索（此处对应 <strong>th2.svg</strong>）。每位玩家都将在相同的位置找到这些线索。所有寻宝线索的任务机制是一致的，您可参照上文的方式寻找这三条线索。<br><br>
                    <strong>奖励：</strong> 集齐所有线索后，游戏中将出现藏有双动式左轮手枪的宝箱。宝箱的准确位置将被标注在游戏内的地图上。使用该武器完成 50 次爆头即可获得 250,000 GTA$、2,000 RP，并于 Red Dead Redemption 2 中解锁此武器的独家变体。
                </div>
                <img src="${imageUrl}" alt="线索图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-treasure-hunt-btn');
            const hideBtn = popup.querySelector('#hide-treasure-hunt-btn');
            const showBtn = popup.querySelector('#show-treasure-hunt-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'treasure-hunt-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                const cacheKey = isRandom ? 'treasure_hunt_th1' : 'treasure_hunt_th2';
                VisibilityCache.updateItemVisibility(cacheKey, index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    
                    // 如果是th1，隐藏所有th1标记
                    if (isRandom) {
                        th1Markers.forEach((marker) => {
                            if (marker && typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (marker && typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        });
                        // 更新所有th1的缓存
                        th1Markers.forEach((_, i) => {
                            VisibilityCache.updateItemVisibility('treasure_hunt_th1', i, true);
                        });
                    }
                    
                    const newHiddenCount = isRandom ? 
                        1 + th2Markers.filter(m => m && m.getElement && m.getElement().style.opacity === '0.3').length :
                        hiddenCount + (isCurrentHidden ? 0 : 1);
                    
                    titleElement.textContent = isRandom ? 
                        `🔎 左轮寻宝 - 随机线索 #${index + 1} (${newHiddenCount}/${totalCount})` :
                        `🔎 左轮寻宝 - 固定线索 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateTreasureHuntSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    
                    // 如果是th1，显示所有th1标记
                    if (isRandom) {
                        th1Markers.forEach((marker) => {
                            if (marker && typeof marker.setOpacity === 'function') {
                                marker.setOpacity(1);
                            } else if (marker && typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 1 });
                            }
                        });
                        // 更新所有th1的缓存
                        th1Markers.forEach((_, i) => {
                            VisibilityCache.updateItemVisibility('treasure_hunt_th1', i, false);
                        });
                    }
                    
                    const newHiddenCount = isRandom ? 
                        th2Markers.filter(m => m && m.getElement && m.getElement().style.opacity === '0.3').length :
                        hiddenCount - (isCurrentHidden ? 1 : 0);
                    
                    titleElement.textContent = isRandom ? 
                        `🔎 左轮寻宝 - 随机线索 #${index + 1} (${newHiddenCount}/${totalCount})` :
                        `🔎 左轮寻宝 - 固定线索 #${index + 1} (${newHiddenCount}/${totalCount})`;
                    
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateTreasureHuntSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到左轮寻宝标记
        function applyTreasureHuntVisibilityCache() {
            const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
            const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
            
            if (th1Markers.length > 0 || th2Markers.length > 0) {
                // 应用th1缓存
                const th1VisibilityMap = VisibilityCache.loadVisibility('treasure_hunt_th1');
                th1Markers.forEach((marker, index) => {
                    const isHidden = th1VisibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                
                // 应用th2缓存
                const th2VisibilityMap = VisibilityCache.loadVisibility('treasure_hunt_th2');
                th2Markers.forEach((marker, index) => {
                    const isHidden = th2VisibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                
                console.log('已应用左轮寻宝可见性缓存');
                return true;
            }
            return false;
        }

        // 检测幽灵曝光点击（坐标检测）
        function checkGhosts3Click(clickX, clickY) {
            const GHOSTS3_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示幽灵曝光（支持多选）
            if (activeItemTypes.has('ghosts3') && itemData.ghosts3) {
                // 检查点击位置是否在任意幽灵曝光附近
                const nearbyGhost = itemData.ghosts3.find(ghost => {
                    const distance = Math.sqrt(Math.pow(ghost.x - clickX, 2) + Math.pow(ghost.y - clickY, 2));
                    return distance <= GHOSTS3_RADIUS;
                });

                if (nearbyGhost) {
                    // 找到对应的索引
                    const ghostIndex = itemData.ghosts3.findIndex(ghost => 
                        ghost.x === nearbyGhost.x && ghost.y === nearbyGhost.y
                    );
                    showGhosts3Popup(nearbyGhost, ghostIndex);
                }
            }
        }

        // 幽灵曝光2025弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showGhosts3Popup(item, index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = "https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png";
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.ghosts3-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el) {
                        const opacity = el.style.opacity;
                        if (opacity === '0.3' || opacity === 0.3 || opacity === '0.30') {
                            hiddenCount++;
                        }
                    }
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                if (el) {
                    const opacity = el.style.opacity;
                    isCurrentHidden = opacity === '0.3' || opacity === 0.3 || opacity === '0.30';
                }
            }

            const title = `👻 幽灵曝光2025 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'ghosts3-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <div style="margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: bold; color: #9c27b0; margin-bottom: 6px; font-size: 14px;">⏰ 出现时间</div>
                    <div style="color: #333; font-size: 16px;">${item.time || '未知时间'}</div>
                </div>
                <div style="margin: 14px 0; padding: 10px; background: #f3e5f5; border-radius: 6px; color: #7b1fa2; font-size: 13px; line-height: 1.6;">
                    • 在指定时间前往该区域寻找幽灵线索<br>
                    • 拍摄照片或观察异常现象（占位说明）
                </div>
                <div style="margin: 12px 0; padding: 8px; background: #fff; border-radius: 6px;">
                    <img src="${imageUrl}" alt="幽灵曝光2025 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 4px; cursor: zoom-in;"/>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-ghosts3-btn');
            const hideBtn = popup.querySelector('#hide-ghosts3-btn');
            const showBtn = popup.querySelector('#show-ghosts3-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ghosts3-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker) {
                    // 对于divIcon，需要特殊处理
                    if (typeof currentMarker.getElement === 'function') {
                        const el = currentMarker.getElement();
                        if (el) {
                            // 直接设置divIcon元素的透明度
                            el.style.opacity = opacity;
                        }
                    } else if (typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('ghosts3', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `👻 幽灵曝光2025 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateGhosts3SidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `👻 幽灵曝光2025 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateGhosts3SidebarCount();
                });
            }

            document.body.appendChild(popup);
        }
        // 检测帮派攻击点击（坐标检测）
        function checkGangAttackClick(clickX, clickY) {
            const GANG_ATTACK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示帮派攻击（支持多选）
            if (activeItemTypes.has('gang_attacks') && itemData.gang_attacks) {
                // 检查点击位置是否在任意帮派攻击附近
                const nearbyAttack = itemData.gang_attacks.find((attack, index) => {
                    // 首先检查时间是否匹配
                    if (!isGangAttackActive(attack.time)) {
                        return false;
                    }
                    
                    const distance = Math.sqrt(Math.pow(attack.x - clickX, 2) + Math.pow(attack.y - clickY, 2));
                    return distance <= GANG_ATTACK_RADIUS;
                });

                if (nearbyAttack) {
                    console.log('点击了帮派攻击附近:', nearbyAttack);
                    // 找到对应的索引
                    const attackIndex = itemData.gang_attacks.findIndex(attack => 
                        attack.x === nearbyAttack.x && attack.y === nearbyAttack.y
                    );
                    showGangAttackPopup(nearbyAttack, attackIndex);
                }
            }
        }

        // 显示帮派攻击弹窗
        function showGangAttackPopup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'gang-attack-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #ff0000;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #ff0000;">
                    ⚔️ 帮派攻击
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff0000;">
                    <div style="font-weight: bold; color: #ff0000; margin-bottom: 8px; font-size: 16px;">⏰ 时间限制</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #ffebee; border-radius: 6px; color: #c62828; font-size: 14px; line-height: 1.6;">
                    🎯 <strong>帮派攻击事件</strong><br>
                    • 在指定时间内前往该区域<br>
                    • 与敌对帮派成员战斗<br>
                    • 完成可获得<strong>经验值</strong>和<strong>游戏币奖励</strong><br>
                    • 注意安全，准备充足的武器和弹药！
                </div>
                
                <button id="close-gang-attack-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #ff0000; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加关闭按钮事件
            const closeBtn = popup.querySelector('#close-gang-attack-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);

            // 添加到页面
            document.body.appendChild(popup);
        }

        // 显示武器厢型车武器信息
        function showGunVanWeapons() {
            // 加载labels.json数据
            let labelsData = {};
            fetch('../src/data/labels.json')
                .then(response => response.json())
                .then(labels => {
                    labelsData = labels;
                    // 从API动态获取武器信息
                    return fetch('https://api-gta.antwen.com/api/items/gun-van');
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayGunVanWeapons(data.data.message, labelsData);
                    } else {
                        console.error('获取武器厢型车信息失败:', data.error);
                        alert('获取武器信息失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    alert('网络请求失败，请检查网络连接');
                });

            function displayGunVanWeapons(message, labels) {
                // 解析API返回的消息来提取武器信息
                const lines = message.split('\n');
                const weapons = [];
                const throwables = [];
                let currentSection = '';

                lines.forEach(line => {
                    if (line.includes('武器:')) {
                        currentSection = 'weapons';
                    } else if (line.includes('投掷物:')) {
                        currentSection = 'throwables';
                    } else if (line.trim() && line.includes('-')) {
                        const match = line.match(/- (.+?) \((\d+)折\)/);
                        if (match) {
                            // 尝试从labels中查找武器的中文名称
                            let weaponName = match[1];
                            if (labels.hasOwnProperty(weaponName)) {
                                weaponName = labels[weaponName];
                            }
                            
                            const discountText = match[2] + '折';
                            
                            const weaponEntry = {
                                name: weaponName,
                                discountText: discountText
                            };

                            if (currentSection === 'weapons') {
                                weapons.push(weaponEntry);
                            } else if (currentSection === 'throwables') {
                                throwables.push(weaponEntry);
                            }
                        }
                    }
                });

                // 创建弹窗
                const popup = document.createElement('div');
                popup.className = 'gun-van-popup';
                popup.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: var(--gta-bg-medium);
                    border: 1px solid var(--gta-border);
                    border-radius: 8px;
                    box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                    padding: 15px;
                    z-index: 10000;
                    width: min(92vw, 520px);
                    max-height: 80vh;
                    color: var(--gta-text);
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    overflow-y: auto;
                `;

                // 弹窗内容
                const gunVanImageUrl = 'https://gtaweb.eu/_sources/maps_gtao/tips/gun_van.webp';
                popup.innerHTML = `
                    <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                        <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">🚐 武器厢型车商品信息</h3>
                        <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                    </div>
                    <img src="${gunVanImageUrl}" alt="武器厢型车图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                    <div style="margin-bottom: 10px; font-weight: bold; color: #555;">主武器:</div>
                    ${weapons.map(weapon => `<div style=\"margin: 5px 0; color: #666;\">${weapon.name} - <span style=\"color: #e74c3c;\">${weapon.discountText}</span></div>`).join('')}
                        <div style="margin: 10px 0; font-weight: bold; color: #555;">投掷武器:</div>
                    ${throwables.map(throwable => `<div style=\"margin: 5px 0; color: #666;\">${throwable.name} - <span style=\"color: #e74c3c;\">${throwable.discountText}</span></div>`).join('')}
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <button id="close-popup-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                        </div>
                `;

                // 添加关闭按钮事件监听
                const closeBtn = popup.querySelector('#close-popup-btn');
                const popupClose = popup.querySelector('.popup-close');
                const removePopup = () => popup.remove();
                closeBtn.addEventListener('click', removePopup);
                if (popupClose) popupClose.addEventListener('click', removePopup);

                // 图片点击放大（PC/移动端）
                const popupImage = popup.querySelector('img');
                if (popupImage) {
                    popupImage.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const overlay = document.createElement('div');
                        overlay.className = 'gun-van-image-overlay';
                        overlay.style.cssText = `
                            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                            display: flex; align-items: center; justify-content: center;
                            z-index: 10002; cursor: zoom-out;
                        `;
                        const bigImg = document.createElement('img');
                        bigImg.src = popupImage.src;
                        bigImg.alt = popupImage.alt || '';
                        bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                        overlay.appendChild(bigImg);

                        const removeOverlay = () => {
                            document.removeEventListener('keydown', onKey);
                            overlay.remove();
                        };
                        const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                        overlay.addEventListener('click', removeOverlay);
                        document.addEventListener('keydown', onKey);
                        document.body.appendChild(overlay);
                    });
                }

                // 移除隐藏/显示功能，保留仅关闭

                // 添加到页面
                document.body.appendChild(popup);

                // 点击弹窗外部关闭
                popup.addEventListener('click', (e) => e.stopPropagation());
                
                // 使用setTimeout延迟添加document点击事件，避免立即触发
                setTimeout(() => {
                    const closePopupHandler = (e) => {
                        if (!popup.contains(e.target)) {
                            removePopup();
                            document.removeEventListener('click', closePopupHandler);
                        }
                    };
                    document.addEventListener('click', closePopupHandler);
                }, 100);
            }
        }


        // 初始加载
        map.whenReady(() => {
            updateTilePanePosition();
            updateOriginMarker();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            // 恢复阶段：先隐藏 Leaflet 面板，避免“全量坐标”闪烁
            hideLeafletPanesForRestore();
            loadItemData().then(() => {
                console.log('物品数据加载完成');
                // 通过"显示逻辑"恢复缓存（避免一次性加载全部坐标）
                setTimeout(() => {
                    try { restoreCachedDisplayState(); } finally { showLeafletPanesForRestore(); }
                }, 0);
                
                // 数据加载完成后，延迟更新街头毒贩计数器
                setTimeout(() => {
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                }, 500);
            }).catch(() => {
                // 失败时也要确保恢复显示
                showLeafletPanesForRestore();
            });
            
            // 初始化车行标记
            initDealershipMarkers();
            
            // 初始化游戏时间和天气显示
            initGameTimeWeatherDisplay();
            
            // 添加缓存管理按钮
            addCacheManagementButton();
        });

        window.addEventListener('resize', () => {
            resetViewForZoom(map.getZoom());
            updateTilePanePosition();
        });

        // 瓦片文件检测（保持原逻辑）
        async function probeTilesForStyleAndZoom(style, zoom) {
            // ... 原有代码保持不变
        }

        // 根据地图样式设置背景色
        function setBackgroundColorByStyle(style) {
            const backgroundColorMap = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            document.body.style.backgroundColor = backgroundColorMap[style] || '#1a1a1a';
        }
        
        // 更新鬼上身动物圆圈大小以响应缩放变化
        function updatePossessedAnimalsCircleSizes(zoom) {
            if (!activeItemTypes.has('possessed_animals') || !itemData.possessed_animals) return;
            
            const level = getLevelOrNearest(zoom);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            // 更新所有鬼上身动物圆圈的大小
            document.querySelectorAll('.possessed-animal-circle').forEach(marker => {
                const index = parseInt(marker.dataset.index);
                const animal = itemData.possessed_animals[index];
                if (!animal) return;
                
                // 重新计算圆圈大小
                const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                const pixelRadius = (animal.radius / gameWidth) * totalWidth;
                const circleSize = pixelRadius * 2; // 直径
                
                // 更新圆圈大小
                marker.style.width = `${circleSize}px`;
                marker.style.height = `${circleSize}px`;
            });
        }
        
        // 注意：雪怪现在使用Leaflet标记系统，不再需要DOM圆圈大小更新函数
        
        // 样式选择事件
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            tileLayer.redraw();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            setBackgroundColorByStyle(currentStyle);
        });
        
        // 初始化背景色
        setBackgroundColorByStyle(currentStyle);

            // 初始化物品信息弹窗样式（覆盖默认样式）
            function initItemInfoTextStyles() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.display = 'none'; // 确保初始状态是隐藏的
            }

            // 显示物品信息（文本版）
            function showItemInfoText(title, coords, location, details) {
                const itemInfo = document.getElementById('item-info');
                document.getElementById('item-title').textContent = title;
                document.getElementById('item-coords').textContent = `坐标: ${coords}`;
                document.getElementById('item-location').textContent = `位置: ${location}`;
                document.getElementById('item-details').textContent = `详细信息: ${details}`;
                
                // 添加显示动画
                itemInfo.style.display = 'block';
                itemInfo.style.opacity = '0';
                itemInfo.style.transition = 'opacity 0.3s ease';
                
                // 使用setTimeout触发重排和过渡动画
                setTimeout(() => {
                    itemInfo.style.opacity = '1';
                }, 10);
            }

            // 隐藏物品信息（文本版）
            function hideItemInfoText() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.opacity = '0';
                
                // 等待淡出动画完成后隐藏元素
                setTimeout(() => {
                    itemInfo.style.display = 'none';
                }, 300);
            };

            // 初始化物品信息弹窗样式（文本版）
            initItemInfoTextStyles();

        // 初始探测
        setTimeout(() => {
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
        }, 300);

        // 移动端菜单交互（“更多”按钮）
        (function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            if (!mobileMenuToggle || !mobileMenu) return;

            mobileMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('show');
            });

            // 点击其他地方关闭菜单
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && e.target !== mobileMenuToggle) {
                    mobileMenu.classList.remove('show');
                }
            });
        })();

        // 检查帮派攻击时间是否匹配
        function isGangAttackActive(timeRange) {
            try {
                // 获取当前游戏时间
                const timestamp = Math.floor(Date.now() / 1000);
                const currentHour = Math.floor(timestamp / 120) % 24;
                const currentMinute = Math.floor(timestamp / 2) % 60;
                const currentTime = currentHour * 60 + currentMinute; // 转换为分钟
                
                // 解析时间范围 "04:00 - 12:00"
                const [startTime, endTime] = timeRange.split(' - ');
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                const startTimeMinutes = startHour * 60 + startMinute;
                const endTimeMinutes = endHour * 60 + endMinute;
                
                // 检查当前时间是否在范围内
                if (startTimeMinutes <= endTimeMinutes) {
                    // 正常范围，如 04:00 - 12:00
                    return currentTime >= startTimeMinutes && currentTime <= endTimeMinutes;
                } else {
                    // 跨天范围，如 22:00 - 06:00
                    return currentTime >= startTimeMinutes || currentTime <= endTimeMinutes;
                }
            } catch (error) {
                console.error('检查帮派攻击时间失败:', error);
                return false;
            }
        }

        // 游戏时间和天气显示功能
        function initGameTimeWeatherDisplay() {
            // 简化样式创建，因为我们已经在头部定义了样式

            // 创建显示元素
            const displayElement = document.createElement('div');
            displayElement.id = 'game-time-weather';
            displayElement.className = 'nav-weather';
            displayElement.innerHTML = '<span style="color: white;">🕐 加载中...</span>';
            // 默认放在地图容器的右上角（会在初始化时移动到合适位置）
            document.getElementById('map-container').appendChild(displayElement);

            // 如果是移动端（宽度 <= 768px），把时间天气移动到移动菜单里，避免底部空白
            function placeGameTimeWeatherForMobile() {
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile) {
                    // 在移动端，把时间/天气放在标题右边（h1.gta-title 之后），并强制可见样式
                    const navLeft = document.querySelector('.gta-nav .nav-left');
                    if (navLeft) {
                        const titleEl = navLeft.querySelector('h1.gta-title');
                        if (titleEl) {
                            // 无论之前在哪，都把元素移到标题后面
                            if (displayElement.parentElement) displayElement.parentElement.removeChild(displayElement);
                            titleEl.insertAdjacentElement('afterend', displayElement);
                            // 强制样式以确保可见
                            displayElement.style.display = 'inline-flex';
                            displayElement.style.alignItems = 'center';
                            displayElement.style.marginLeft = '8px';
                            displayElement.style.color = 'white';
                            displayElement.style.fontSize = '13px';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0 6px';
                        }
                    }
                } else {
                    // 桌面端：放在 nav-links 中的“在线文件”之后（如果存在）
                    const navLinks = document.querySelector('.gta-nav .nav-left .nav-links');
                    if (navLinks) {
                        // 找到第二个链接（在线文件）并在其后插入显示元素
                        const anchors = navLinks.querySelectorAll('a');
                        const target = anchors[1] || navLinks.lastElementChild;
                        if (target && !navLinks.contains(displayElement)) {
                            // 恢复样式为内联菜单项
                            displayElement.style.position = '';
                            displayElement.style.bottom = '';
                            displayElement.style.right = '';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0';
                            displayElement.style.border = 'none';
                            displayElement.style.boxShadow = 'none';
                            displayElement.style.minWidth = '0';
                            displayElement.style.textAlign = 'left';
                            target.insertAdjacentElement('afterend', displayElement);
                        }
                    } else {
                        // 回退：放回 map-container
                        const container = document.getElementById('map-container');
                        if (!container.contains(displayElement)) container.appendChild(displayElement);
                    }
                }
            }

            // 获取并显示游戏时间和天气
            function updateGameTimeWeather() {
                try {
                    // 定义天气映射表和星期表
                    const WEATHERS = {
                      0: '☁️多云', 4: '🌫️薄雾', 7: '⛅大部多云', 11: '☀️晴朗', 14: '🌫️薄雾', 16: '☀️晴朗',
                      28: '🌫️薄雾', 31: '☀️晴朗', 41: '🌁阴霾', 45: '☁️多云', 52: '🌫️薄雾', 55: '☁️多云',
                      62: '🌁雾天', 66: '☁️多云', 72: '☁️多云', 78: '🌁雾天', 82: '☁️多云', 92: '🌤️大部晴朗',
                      104: '☁️多云', 105: '🌦️毛毛雨', 108: '☁️多云', 125: '🌫️薄雾', 128: '☁️多云',
                      131: '🌧️下雨', 134: '🌦️毛毛雨', 137: '☁️多云', 148: '🌫️薄雾', 151: '⛅大部多云',
                      155: '🌁雾天', 159: '☀️晴朗', 176: '🌤️大部晴朗', 196: '🌁雾天', 201: '☁️多云',
                      220: '🌫️薄雾', 222: '🌤️大部晴朗', 244: '🌫️薄雾', 246: '🌤️大部晴朗', 247: '🌧️下雨',
                      250: '🌦️毛毛雨', 252: '☁️多云', 268: '🌫️薄雾', 270: '☁️多云', 272: '☁️多云',
                      277: '☁️多云', 292: '🌫️薄雾', 295: '☁️多云', 300: '⛅大部多云',
                      306: '☁️多云', 318: '⛅大部多云', 330: '☁️多云', 337: '☀️晴朗',
                      367: '☁️多云', 369: '🌧️下雨', 376: '🌦️毛毛雨', 377: '☁️多云'
                    };
                    
                    const WEEKDAYS = {
                      0: '星期日', 1: '星期一', 2: '星期二', 3: '星期三', 4: '星期四', 5: '星期五', 6: '星期六'
                    };
                    
                    // 获取星期几
                    function getWeekday() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weekday_correction = Math.floor(timestamp / (365 * 2880)) % 7;
                      const weekdayIdx = Math.floor(timestamp / 2880 + 2 - weekday_correction) % 7;
                      return WEEKDAYS[weekdayIdx];
                    }
                    
                    // 获取小时和分钟
                    function getHourAndMinute() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const hour = Math.floor(timestamp / 120) % 24;
                      const minute = Math.floor(timestamp / 2) % 60;
                      const formatted_hour = hour < 10 ? '0' + hour : hour.toString();
                      const formatted_minute = minute < 10 ? '0' + minute : minute.toString();
                      return `${formatted_hour}:${formatted_minute}`;
                    }
                    
                    // 获取天气详情
                    function getWeatherDetail() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weather_period = timestamp / 120 % 384;
                      const periods = Object.keys(WEATHERS).map(Number).sort((a, b) => a - b);

                      // 当前天气
                      let currIdx = 0;
                      for (let i = periods.length - 1; i >= 0; i--) {
                        if (periods[i] <= weather_period) {
                          currIdx = i;
                          break;
                        }
                      }
                      const currPeriod = periods[currIdx];
                      const currWeather = WEATHERS[currPeriod];

                      return currWeather;
                    }
                    
                    // 本地计算游戏时间和天气
                    const weekday = getWeekday();
                    const time = getHourAndMinute();
                    const weatherDetail = getWeatherDetail();
                    
                    // 根据天气设置emoji
                    let weatherEmoji = '🌤️';
                    const weather = weatherDetail.toLowerCase();
                    if (weather.includes('雨') || weather.includes('毛毛雨')) {
                        weatherEmoji = '🌧️';
                    } else if (weather.includes('雷') || weather.includes('thunder')) {
                        weatherEmoji = '⛈️';
                    } else if (weather.includes('雾') || weather.includes('霾')) {
                        weatherEmoji = '🌫️';
                    } else if (weather.includes('阴') || weather.includes('cloud') || weather.includes('多云')) {
                        weatherEmoji = '☁️';
                    } else if (weather.includes('晴') || weather.includes('clear') || weather.includes('sun') || weather.includes('晴朗')) {
                        weatherEmoji = '☀️';
                    }

                    // 平滑更新文本：避免改变背景透明度以防止闪烁
                    const newText = `${weekday} ${time} ${weatherEmoji}`;
                    const safeHtml = `<span style="color:white">${newText}</span>`;
                    if (displayElement.innerHTML !== safeHtml) {
                        // 使用 innerHTML 且带样式，确保在导航上的可见性
                        displayElement.innerHTML = safeHtml;
                    }
                } catch (error) {
                    displayElement.textContent = '❌ 计算失败';
                    console.error('计算游戏时间和天气信息失败:', error);
                }
            }

            // 初始加载
            updateGameTimeWeather();
            // 放置到合适的位置（基于当前屏幕宽度）
            placeGameTimeWeatherForMobile();
            // 强制刷新文本和可见性以防止第一次未显示
            try { updateGameTimeWeather(); if (displayElement) { displayElement.style.display = 'inline-flex'; displayElement.style.color='white'; } } catch(e) {}
            // 在窗口大小变化时调整位置
            window.addEventListener('resize', placeGameTimeWeatherForMobile);
            // 现实5秒等于游戏内1分钟，每5秒更新一次
            setInterval(updateGameTimeWeather, 1000);
            
            // 每30秒更新一次帮派攻击显示状态
            setInterval(() => {
                if (activeItemTypes.has('gang_attacks')) {
                    updateItemMarkers(); // 帮派攻击需要重新创建标记
                }
            }, 30000);
        }

        // 佩里科岛样式：侧边栏折叠/缩放按钮与多选样式/重置行为
        (function initCayoStyleControls() {
            const panelToggle = document.getElementById('panel-toggle');
            const sidePanel = document.getElementById('side-panel');
            if (panelToggle && sidePanel) {
                panelToggle.addEventListener('click', () => {
                    sidePanel.classList.toggle('collapsed');
                    const icon = panelToggle.querySelector('i');
                    if (sidePanel.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-left');
                    }
                });
                // 额外监听，覆盖可能的事件冒泡/阻止问题
                panelToggle.addEventListener('touchstart', (ev) => {
                    ev.preventDefault();
                    panelToggle.click();
                });
                // 防止侧边栏内的交互触发地图行为（滚动/拖拽/点击等）
                try {
                    if (typeof L !== 'undefined' && L.DomEvent) {
                        L.DomEvent.disableClickPropagation(sidePanel);
                        L.DomEvent.disableScrollPropagation(sidePanel);
                    }
                } catch (e) {}
                const stopEvents = ['wheel','mousewheel','DOMMouseScroll','touchstart','touchmove','touchend','pointerdown','pointermove','pointerup','mousedown','mousemove','mouseup','click','dblclick','contextmenu'];
                stopEvents.forEach(evtName => {
                    sidePanel.addEventListener(evtName, (ev) => {
                        ev.stopPropagation();
                    }, { passive: false });
                });
            }

            // 缩放按钮绑定
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => map.zoomIn());
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => map.zoomOut());

            // 分组渲染 + 搜索过滤
            const sidebarContainer = document.getElementById('sidebar-item-selectors');
            const searchInput = document.getElementById('sidebar-item-search');
            if (sidebarContainer) {
                const groupMap = {
                    '车行配置': [
                        'dealerships'
                    ],
                    '每日活动': [
                        'gun_van',
                        'dead_drop',
                        'street_dealers',
                        'smoke_on_the_water_product'
                    ],
                    '任务与活动': [
                        'yuanbao',
                        'stunt_jumps',
                        'payphone_hits',
                        'rc_time_trial',
                        'bike_time_trial',
                        'skydives',
                        'gang_attacks',
                        'treasure_hunt_dba_revolver',
                        'serial_killer_slasher',
                        'maude_bounty_targets',
                        'stash_houses',
                        'madrazo_hits',
                        'police_rescue_patrick_mcreary',
                        'random_missions',
                        'drug_vehicle',
                        'drunk_guard',
                        'metal_detector',
                        'smuggler_plane',
                        'smuggler_trail',
                        'crime_scenes',
                        'wea',
                        'community_outreach',
                        'store_robbery',
                        'convoy',
                        'armored_truck',
                        'exotic_exports1',
                        'exotic_exports2'
                    ],
                    '收藏品': [
                        'hidden_caches',
                        'shipwrecked',
                        'ls_tags',
                        'playing_cards',
                        'action_figures',
                        'spray',
                        'ld_organics_products',
                        'signal_jammers',
                        'movie_props',
                        'media_sticks',
                        'v_telescopes',
                        'ppl',
                        'ppw'
                    ],
                    '线下收集品': [
                        'letter_scraps',
                        'sp_hidden_packages',
                        'peyote_sp_land',
                        'peyote_sp_air',
                        'peyote_sp_water',
                        'peyote_sp_special',
                        'submarine_pieces',
                        'spaceship_parts',
                        'nuclear_waste',
                        'humans_of_ls',
                        'monkey_mosaics',
                        'murder_mystery_message'
                    ],
                    '线下支线任务': [
                        'assuming_the_truth',
                        'chasing_the_truth',
                        'epsilon_tracts',
                        'for_sale_sign',
                        'the_big_score_gauntlet'
                    ],
                    '线下随机任务':[
                        'hitchhikers'
                    ],
                    '地点与服务': [
                        'golf_holes',
                        'metro',
                        'police',
                        'fire_stations',
                        'hospitals',
                        'clothing',
                        'tattoos',
                        'barbers',
                        'ammunation',
                        'mod_shop',
                        'car_wash',
                        'shops_to_rob',
                        'gas_stations',
                        'atms',
                        'vend_sprunk',
                        'vend_ecola'
                    ],
                    '季节性/特殊事件': [
                        'jack_o_lanterns',
                        'snowmen',
                        'ghosts3',
                        'ufo',
                        'halloween_slashers',
                        'possessed_animals',
                        'cerberus',
                        'yeti',
                        'happy_holidays_hauler'
                    ]
                };

                const typeToOption = Object.fromEntries(sidebarItemOptions.map(o => [o.value, o]));

                function createCheckboxRow(opt) {
                    const type = opt.value;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'item-checkbox-wrapper';

                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.className = 'item-checkbox';
                    chk.dataset.itemType = type;
                    chk.id = `sidebar-item-${type}`;
                    chk.checked = activeItemTypes && activeItemTypes.has && activeItemTypes.has(type);

                    const label = document.createElement('label');
                    label.setAttribute('for', chk.id);
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';

                    if (type !== 'dealerships' && type !== 'gang_attacks') {
                        let iconSrc = null;
                        if (opt.icon) {
                            iconSrc = opt.icon;
                        } else if (typeof itemIcons !== 'undefined' && itemIcons[type]) {
                            iconSrc = itemIcons[type];
                        }
                        if (iconSrc) {
                        const ico = document.createElement('img');
                            ico.src = iconSrc;
                        ico.alt = '';
                        ico.className = 'item-icon';
                            ico.style.width = '16px';
                            ico.style.height = '16px';
                        label.appendChild(ico);
                        }
                    }

                    const span = document.createElement('span');
                    span.textContent = opt.text;
                    label.appendChild(span);

                    // 右侧计数器（smuggler_plane、street_dealers 和 ghosts3 使用）
                    if (type === 'smuggler_plane') {
                        const counter = document.createElement('span');
                        counter.className = 'smuggler-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                    }
                    // 街头毒贩计数器
                    else if (type === 'street_dealers') {
                        const counter = document.createElement('span');
                        counter.className = 'street-dealers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateStreetDealersSidebarCount(); } catch(e) {}
                    }
                    // 洛圣都杀人狂计数器
                    else if (type === 'serial_killer_slasher') {
                        const counter = document.createElement('span');
                        counter.className = 'slasher-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSlasherSidebarCount(); } catch(e) {}
                    }
                    // 左轮寻宝计数器
                    else if (type === 'treasure_hunt_dba_revolver') {
                        const counter = document.createElement('span');
                        counter.className = 'treasure-hunt-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateTreasureHuntSidebarCount(); } catch(e) {}
                    }
                    // UFO观光计数器
                    else if (type === 'ufo') {
                        const counter = document.createElement('span');
                        counter.className = 'ufo-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateUfoSidebarCount(); } catch(e) {}
                    }
                    // 幽灵曝光2025计数器
                    else if (type === 'ghosts3') {
                        const counter = document.createElement('span');
                        counter.className = 'ghosts3-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateGhosts3SidebarCount(); } catch(e) {}
                    }
                    // 雪人计数器
                    else if (type === 'snowmen') {
                        const counter = document.createElement('span');
                        counter.className = 'snowmen-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSnowmenSidebarCount(); } catch(e) {}
                    }
                    // 南瓜灯计数器
                    else if (type === 'jack_o_lanterns') {
                        const counter = document.createElement('span');
                        counter.className = 'jack-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateJackOLanternsSidebarCount(); } catch(e) {}
                    }
                    // 电影道具计数器
                    else if (type === 'movie_props') {
                        const counter = document.createElement('span');
                        counter.className = 'movie-props-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateMoviePropsSidebarCount(); } catch(e) {}
                    }
                    // 喷罐位置计数器
                    else if (type === 'spray') {
                        const counter = document.createElement('span');
                        counter.className = 'spray-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSpraySidebarCount(); } catch(e) {}
                    }
                    // 陆地迷幻仙人掌计数器
                    else if (type === 'ppl') {
                        const counter = document.createElement('span');
                        counter.className = 'ppl-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updatePplSidebarCount(); } catch(e) {}
                    }
                    // 水下迷幻仙人掌计数器
                    else if (type === 'ppw') {
                        const counter = document.createElement('span');
                        counter.className = 'ppw-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updatePpwSidebarCount(); } catch(e) {}
                    }
                    // 特技跳跃点计数器
                    else if (type === 'stunt_jumps') {
                        const counter = document.createElement('span');
                        counter.className = 'stunt-jumps-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateStuntJumpsSidebarCount(); } catch(e) {}
                    }
                    // 元宝计数器
                    else if (type === 'yuanbao') {
                        const counter = document.createElement('span');
                        counter.className = 'yuanbao-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateYuanbaoSidebarCount(); } catch(e) {}
                    }
                    // 信号干扰器计数器
                    else if (type === 'signal_jammers') {
                        const counter = document.createElement('span');
                        counter.className = 'signal-jammers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSignalJammersSidebarCount(); } catch(e) {}
                    }
                    // 手办计数器
                    else if (type === 'action_figures') {
                        const counter = document.createElement('span');
                        counter.className = 'action-figures-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateActionFiguresSidebarCount(); } catch(e) {}
                    }
                    // 纸牌计数器
                    else if (type === 'playing_cards') {
                        const counter = document.createElement('span');
                        counter.className = 'playing-cards-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updatePlayingCardsSidebarCount(); } catch(e) {}
                    }
                    // 残缺信件计数器
                    else if (type === 'letter_scraps') {
                        const counter = document.createElement('span');
                        counter.className = 'letter-scraps-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateLetterScrapsSidebarCount(); } catch(e) {}
                    }
                     // 隐藏包裹（线下）计数器
                     else if (type === 'sp_hidden_packages') {
                         const counter = document.createElement('span');
                         counter.className = 'sp-hidden-packages-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // 初始渲染一次
                         try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                     }
                     // 迷幻仙人掌陆地计数器
                     else if (type === 'peyote_sp_land') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-land-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // 初始渲染一次
                         try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                     }
                     // 迷幻仙人掌鸟类计数器
                     else if (type === 'peyote_sp_air') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-air-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // 初始渲染一次
                         try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                     }
                     // 迷幻仙人掌水下计数器
                     else if (type === 'peyote_sp_water') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-water-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // 初始渲染一次
                         try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                     }
                     // 迷幻仙人掌金色计数器
                     else if (type === 'peyote_sp_special') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-special-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // 初始渲染一次
                         try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                     }
                    // 潜水艇碎片计数器
                    else if (type === 'submarine_pieces') {
                        const counter = document.createElement('span');
                        counter.className = 'submarine-pieces-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                    }
                    // assuming_the_truth 计数器
                    else if (type === 'assuming_the_truth') {
                    const counter = document.createElement('span');
                    counter.className = 'assuming-the-truth-counter';
                    counter.style.marginLeft = '6px';
                    counter.style.color = 'var(--gta-text-secondary)';
                    counter.textContent = '';
                    label.appendChild(counter);
                    // 初始渲染一次
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    }
                    // 宇宙飞船部件计数器
                    else if (type === 'spaceship_parts') {
                        const counter = document.createElement('span');
                        counter.className = 'spaceship-parts-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                    }
                    // assuming_the_truth 计数器
                    else if (type === 'assuming_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'assuming-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，防止首次构建时数据/缓存尚未到位
                        setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 核废料计数器
                    else if (type === 'nuclear_waste') {
                        const counter = document.createElement('span');
                        counter.className = 'nuclear-waste-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateNuclearWasteSidebarCount(); } catch(e) {}
                    }
                    // 洛圣都的人类计数器
                    else if (type === 'humans_of_ls') {
                        const counter = document.createElement('span');
                        counter.className = 'humans-of-ls-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateHumansOfLsSidebarCount(); } catch(e) {}
                    }
                    // 猴子马赛克计数器
                    else if (type === 'monkey_mosaics') {
                        const counter = document.createElement('span');
                        counter.className = 'monkey-mosaics-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateMonkeyMosaicsSidebarCount(); } catch(e) {}
                    }
                    // 谋杀之谜信息计数器
                    else if (type === 'murder_mystery_message') {
                        const counter = document.createElement('span');
                        counter.className = 'murder-mystery-message-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，防止首次构建时数据/缓存尚未到位
                        setTimeout(() => { try { updateMurderMysteryMessageSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 埃普西隆质疑真理-载具计数器
                    else if (type === 'assuming_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'assuming-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，防止首次构建时数据/缓存尚未到位
                        setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 埃普斯隆追求真理-神器计数器
                    else if (type === 'chasing_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'chasing-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateChasingTheTruthSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，防止首次构建时数据/缓存尚未到位
                        setTimeout(() => { try { updateChasingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 埃普西隆传单计数器
                    else if (type === 'epsilon_tracts') {
                        const counter = document.createElement('span');
                        counter.className = 'epsilon-tracts-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateEpsilonTractsSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，确保数据/缓存就绪
                        setTimeout(() => { try { updateEpsilonTractsSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 待售标志计数器
                    else if (type === 'for_sale_sign') {
                        const counter = document.createElement('span');
                        counter.className = 'for-sale-sign-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateForSaleSignSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，确保数据/缓存就绪
                        setTimeout(() => { try { updateForSaleSignSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 大干一票（巧妙）- 铁腕 计数器
                    else if (type === 'the_big_score_gauntlet') {
                        const counter = document.createElement('span');
                        counter.className = 'the-big-score-gauntlet-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {}
                        // 延迟再次渲染，确保数据/缓存就绪
                        setTimeout(() => { try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {} }, 200);
                    }
                    // 搭便车计数器
                    else if (type === 'hitchhikers') {
                        const counter = document.createElement('span');
                        counter.className = 'hitchhikers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染
                        try { updateHitchhikersSidebarCount(); } catch (e) {}
                        // 延迟一次，确保数据/缓存就绪
                        setTimeout(() => { try { updateHitchhikersSidebarCount(); } catch (e) {} }, 200);
                    }
                    // 喷灌位置计数器
                    else if (type === 'spray') {
                        const counter = document.createElement('span');
                        counter.className = 'spray-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSpraySidebarCount(); } catch(e) {}
                    }
                    // 陆地迷幻仙人掌计数器
                    else if (type === 'ppl') {
                        const counter = document.createElement('span');
                        counter.className = 'ppl-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updatePplSidebarCount(); } catch(e) {}
                    }
                    // 水下迷幻仙人掌计数器
                    else if (type === 'ppw') {
                        const counter = document.createElement('span');
                        counter.className = 'ppw-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updatePpwSidebarCount(); } catch(e) {}
                    }
                    // 有机坊产品计数器
                    else if (type === 'ld_organics_products') {
                        const counter = document.createElement('span');
                        counter.className = 'organic-farm-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateOrganicFarmSidebarCount(); } catch(e) {}
                    }
                    // 跳伞计数器
                    else if (type === 'skydives') {
                        const counter = document.createElement('span');
                        counter.className = 'skydives-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSkydivesSidebarCount(); } catch(e) {}
                    }
                    // RC时间挑战赛计数器
                    else if (type === 'rc_time_trial') {
                        const counter = document.createElement('span');
                        counter.className = 'rc-time-trial-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                    }
                    // 自行车时间挑战赛计数器
                    else if (type === 'bike_time_trial') {
                        const counter = document.createElement('span');
                        counter.className = 'bike-time-trial-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                    }
                    // 玛德拉索雇凶计数器
                    else if (type === 'madrazo_hits') {
                        const counter = document.createElement('span');
                        counter.className = 'madrazo-hits-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                    }
                    // 藏匿屋计数器
                    else if (type === 'stash_houses') {
                        const counter = document.createElement('span');
                        counter.className = 'stash-houses-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateStashHousesSidebarCount(); } catch(e) {}
                    }
                    // LS涂鸦计数器
                    else if (type === 'ls_tags') {
                        const counter = document.createElement('span');
                        counter.className = 'ls-tags-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateLSTagsSidebarCount(); } catch(e) {}
                    }
                    // 沉船计数器
                    else if (type === 'shipwrecked') {
                        const counter = document.createElement('span');
                        counter.className = 'shipwrecked-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateShipwreckedSidebarCount(); } catch(e) {}
                    }
                    // 隐藏包裹计数器
                    else if (type === 'hidden_caches') {
                        const counter = document.createElement('span');
                        counter.className = 'hidden-caches-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateHiddenCachesSidebarCount(); } catch(e) {}
                    }
                    // 吞云吐雾馆产品计数器
                    else if (type === 'smoke_on_the_water_product') {
                        const counter = document.createElement('span');
                        counter.className = 'smoke-product-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateSmokeProductSidebarCount(); } catch(e) {}
                    }
                    // 右侧计数器（gun_van）已移除
                    // 右侧计数器（dead_drop）
                    if (type === 'dead_drop') {
                        const counter = document.createElement('span');
                        counter.className = 'dead-drop-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // 初始渲染一次
                        try { updateDeadDropSidebarCount(); } catch(e) {}
                    }

                    wrapper.appendChild(chk);
                    wrapper.appendChild(label);

                    chk.addEventListener('change', (e) => {
                        const t = e.target.dataset.itemType;
                        if (t === 'dealerships') {
                            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                            if (e.target.checked) {
                                activeItemTypes.add(t);
                                migratedDealerships.forEach(dealershipType => activeItemTypes.add(dealershipType));
                            } else {
                                activeItemTypes.delete(t);
                                migratedDealerships.forEach(dealershipType => activeItemTypes.delete(dealershipType));
                            }
                        } else {
                            if (e.target.checked) { activeItemTypes.add(t); } else { activeItemTypes.delete(t); }
                        }

                        if (activeItemTypes.size > 0) {
                            updateItemMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        } else {
                            clearAllItemMarkers();
                            if (typeof clearLeafletMarkers === 'function') clearLeafletMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        }

                        // 勾选状态变化后尝试刷新计数器
                        if (t === 'smuggler_plane') {
                            try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                        }
                        // 街头毒贩计数器
                        if (t === 'street_dealers') {
                            try { updateStreetDealersSidebarCount(); } catch(e) {}
                        }
                        // 潜水艇碎片计数器
                        if (t === 'submarine_pieces') {
                            try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                        }
                        // assuming_the_truth 计数器
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 核废料计数器
                        if (t === 'nuclear_waste') {
                            try { updateNuclearWasteSidebarCount(); } catch(e) {}
                        }
                        // 洛圣都的人类计数器
                        if (t === 'humans_of_ls') {
                            try { updateHumansOfLsSidebarCount(); } catch(e) {}
                        }
                        // 猴子马赛克计数器
                        if (t === 'monkey_mosaics') {
                            try { updateMonkeyMosaicsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateMonkeyMosaicsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 谋杀之谜信息计数器
                        if (t === 'murder_mystery_message') {
                            try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateMurderMysteryMessageSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 埃普西隆质疑真理-载具计数器
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 埃普斯隆追求真理-神器计数器
                        if (t === 'chasing_the_truth') {
                            try { updateChasingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateChasingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        if (t === 'epsilon_tracts') {
                            try { updateEpsilonTractsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateEpsilonTractsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 洛圣都杀人狂计数器
                        if (t === 'serial_killer_slasher') {
                            try { updateSlasherSidebarCount(); } catch(e) {}
                        }
                        if (t === 'for_sale_sign') {
                            try { updateForSaleSignSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateForSaleSignSidebarCount(); } catch(e) {} }, 200);
                        }
                        if (t === 'the_big_score_gauntlet') {
                            try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 左轮寻宝计数器
                        if (t === 'treasure_hunt_dba_revolver') {
                            try { updateTreasureHuntSidebarCount(); } catch(e) {}
                        }
                        // UFO观光计数器
                        if (t === 'ufo') {
                            try { updateUfoSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateUfoSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 幽灵曝光2025计数器
                        if (t === 'ghosts3') {
                            try { updateGhosts3SidebarCount(); } catch(e) {}
                        }
                        // 雪人计数器
                        if (t === 'snowmen') {
                            try { updateSnowmenSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateSnowmenSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 电影道具计数器
                        if (t === 'movie_props') {
                            try { updateMoviePropsSidebarCount(); } catch(e) {}
                        }
                        // 喷罐位置计数器
                        if (t === 'spray') {
                            try { updateSpraySidebarCount(); } catch(e) {}
                        }
                        // 陆地迷幻仙人掌计数器
                        if (t === 'ppl') {
                            try { updatePplSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePplSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 水下迷幻仙人掌计数器
                        if (t === 'ppw') {
                            try { updatePpwSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePpwSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 特技跳跃点计数器
                        if (t === 'stunt_jumps') {
                            try { updateStuntJumpsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateStuntJumpsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 元宝计数器
                        if (t === 'yuanbao') {
                            try { updateYuanbaoSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateYuanbaoSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 信号干扰器计数器
                        if (t === 'signal_jammers') {
                            try { updateSignalJammersSidebarCount(); } catch(e) {}
                        }
                        // 手办计数器
                        if (t === 'action_figures') {
                            try { updateActionFiguresSidebarCount(); } catch(e) {}
                        }
                        // 纸牌计数器
                        if (t === 'playing_cards') {
                            try { updatePlayingCardsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePlayingCardsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 残缺信件计数器
                        if (t === 'letter_scraps') {
                            try { updateLetterScrapsSidebarCount(); } catch(e) {}
                        }
                         // 隐藏包裹（线下）计数器
                         if (t === 'sp_hidden_packages') {
                             try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                             setTimeout(() => { try { updateSpHiddenPackagesSidebarCount(); } catch(e) {} }, 200);
                         }
                         // 迷幻仙人掌陆地计数器
                         if (t === 'peyote_sp_land') {
                             try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                         }
                         // 迷幻仙人掌鸟类计数器
                         if (t === 'peyote_sp_air') {
                             try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                         }
                         // 迷幻仙人掌水下计数器
                         if (t === 'peyote_sp_water') {
                             try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                         }
                         // 迷幻仙人掌金色计数器
                         if (t === 'peyote_sp_special') {
                             try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                         }
                        // 宇宙飞船部件计数器
                        if (t === 'spaceship_parts') {
                            try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                        }
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                            }
                        // 南瓜灯计数器
                        if (t === 'jack_o_lanterns') {
                            try { updateJackOLanternsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateJackOLanternsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // humans_of_ls 延迟刷新
                        if (t === 'humans_of_ls') {
                            try { updateHumansOfLsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateHumansOfLsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 喷灌位置计数器
                        if (t === 'spray') {
                            try { updateSpraySidebarCount(); } catch(e) {}
                        }
                        // 陆地迷幻仙人掌计数器
                        if (t === 'ppl') {
                            try { updatePplSidebarCount(); } catch(e) {}
                        }
                        // 水下迷幻仙人掌计数器
                        if (t === 'ppw') {
                            try { updatePpwSidebarCount(); } catch(e) {}
                        }
                        // 有机坊产品计数器
                        if (t === 'ld_organics_products') {
                            try { updateOrganicFarmSidebarCount(); } catch(e) {}
                        }
                        // 跳伞计数器
                        if (t === 'skydives') {
                            try { updateSkydivesSidebarCount(); } catch(e) {}
                        }
                        // RC时间挑战赛计数器
                        if (t === 'rc_time_trial') {
                            try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                        }
                        // 自行车时间挑战赛计数器
                        if (t === 'bike_time_trial') {
                            try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                        }
                        // 玛德拉索雇凶计数器
                        if (t === 'madrazo_hits') {
                            try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                        }
                        // 藏匿屋计数器
                        if (t === 'stash_houses') {
                            try { updateStashHousesSidebarCount(); } catch(e) {}
                        }
                        // LS涂鸦计数器
                        if (t === 'ls_tags') {
                            try { updateLSTagsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateLSTagsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // 沉船计数器
                        if (t === 'shipwrecked') {
                            try { updateShipwreckedSidebarCount(); } catch(e) {}
                        }
                        // 隐藏包裹计数器
                        if (t === 'hidden_caches') {
                            try { updateHiddenCachesSidebarCount(); } catch(e) {}
                        }
                        // 吞云吐雾馆产品计数器
                        if (t === 'smoke_on_the_water_product') {
                            try { updateSmokeProductSidebarCount(); } catch(e) {}
                        }
                        // gun_van 不再有侧边计数器
                        if (t === 'dead_drop') {
                            try { updateDeadDropSidebarCount(); } catch(e) {}
                        }
                    });

                    return wrapper;
                }

                function renderSidebar(filterText = '') {
                    sidebarContainer.innerHTML = '';
                    const normalized = (filterText || '').trim().toLowerCase();
                    Object.keys(groupMap).forEach(groupName => {
                        const types = groupMap[groupName];
                        const visibleOpts = types
                            .map(t => typeToOption[t])
                            .filter(Boolean)
                            .filter(opt => {
                                if (!normalized) return true;
                                const text = (opt.text || '').toLowerCase();
                                const value = (opt.value || '').toLowerCase();
                                return text.includes(normalized) || value.includes(normalized);
                            });
                        if (visibleOpts.length === 0) return;

                        const header = document.createElement('div');
                        header.className = 'item-group-header';
                        const titleSpan = document.createElement('span');
                        titleSpan.textContent = groupName;
                        const chevron = document.createElement('i');
                        chevron.className = 'fas fa-chevron-down chevron';
                        header.appendChild(titleSpan);
                        header.appendChild(chevron);

                        const content = document.createElement('div');
                        content.className = 'item-group-content';

                        visibleOpts.forEach(opt => {
                            const row = createCheckboxRow(opt);
                            content.appendChild(row);
                        });

                        header.addEventListener('click', () => {
                            const isCollapsed = content.classList.toggle('collapsed');
                            chevron.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
                        });

                        sidebarContainer.appendChild(header);
                        sidebarContainer.appendChild(content);
                    });

                    // 渲染完成后，刷新一次计数器
                    try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                    try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                    try { updateNuclearWasteSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    try { updateSlasherSidebarCount(); } catch(e) {}
                    try { updateTreasureHuntSidebarCount(); } catch(e) {}
                    try { updateUfoSidebarCount(); } catch(e) {}
                    try { updateGhosts3SidebarCount(); } catch(e) {}
                    try { updateSnowmenSidebarCount(); } catch(e) {}
                    try { updateMoviePropsSidebarCount(); } catch(e) {}
                    try { updateSpraySidebarCount(); } catch(e) {}
                    try { updatePplSidebarCount(); } catch(e) {}
                    try { updatePpwSidebarCount(); } catch(e) {}
                    try { updateStuntJumpsSidebarCount(); } catch(e) {}
                    try { updateYuanbaoSidebarCount(); } catch(e) {}
                    try { updateSignalJammersSidebarCount(); } catch(e) {}
                    try { updateActionFiguresSidebarCount(); } catch(e) {}
                    try { updatePlayingCardsSidebarCount(); } catch(e) {}
                    try { updateLetterScrapsSidebarCount(); } catch(e) {}
                    try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                     try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                     try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                    try { updateSpraySidebarCount(); } catch(e) {}
                    try { updateOrganicFarmSidebarCount(); } catch(e) {}
                    try { updateSkydivesSidebarCount(); } catch(e) {}
                    try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                    try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                    try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                    try { updateStashHousesSidebarCount(); } catch(e) {}
                    try { updateLSTagsSidebarCount(); } catch(e) {}
                    try { updateShipwreckedSidebarCount(); } catch(e) {}
                    try { updateHiddenCachesSidebarCount(); } catch(e) {}
                    try { updateSmokeProductSidebarCount(); } catch(e) {}
                    try { updateDeadDropSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    
                    // 延迟更新计数器，确保数据已加载
                    setTimeout(() => {
                        try { updateStreetDealersSidebarCount(); } catch(e) {}
                    }, 100);
                }

                // 应用缓存的侧边栏状态
                const hasCachedState = SidebarCache.applyState(activeItemTypes);
                if (hasCachedState) {
                    console.log('已恢复侧边栏缓存状态');
                }

                renderSidebar('');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => renderSidebar(e.target.value));
                }

                // 如果有缓存状态，需要重新渲染标记
                if (hasCachedState) {
                    setTimeout(() => {
                        try {
                            updateItemMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                            console.log('已根据缓存状态重新渲染标记');
                        } catch (e) {
                            console.warn('重新渲染标记时出错:', e);
                        }
                    }, 100);
                }

                // 保存侧边栏状态到缓存（在状态变化时）
                const originalAdd = activeItemTypes.add.bind(activeItemTypes);
                const originalDelete = activeItemTypes.delete.bind(activeItemTypes);
                const originalClear = activeItemTypes.clear.bind(activeItemTypes);
                
                activeItemTypes.add = function(value) {
                    const result = originalAdd(value);
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
                
                activeItemTypes.delete = function(value) {
                    const result = originalDelete(value);
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
                
                activeItemTypes.clear = function() {
                    const result = originalClear();
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
            }

            // 显示全部/隐藏全部按钮
            const showAllBtn = document.getElementById('show-all-items');
            const hideAllBtn = document.getElementById('hide-all-items');
            // 简易通用确认弹窗函数
            function openConfirmModal(message, onOk, onCancel) {
                const modal = document.getElementById('confirm-modal');
                const msgEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                const overlay = modal.querySelector('.confirm-modal-overlay');
                if (!modal || !msgEl || !okBtn || !cancelBtn) return onOk && onOk();

                msgEl.textContent = message;
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');

                const cleanup = () => {
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    okBtn.removeEventListener('click', okHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    if (overlay) overlay.removeEventListener('click', cancelHandler);
                };

                const okHandler = () => { cleanup(); if (onOk) onOk(); };
                const cancelHandler = () => { cleanup(); if (onCancel) onCancel(); };

                okBtn.addEventListener('click', okHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                if (overlay) overlay.addEventListener('click', cancelHandler);
            }

            if (showAllBtn) {
                showAllBtn.addEventListener('click', () => {
                    openConfirmModal('物品信息较多，显示全部可能造成卡顿，是否继续显示？', () => {
                    // 全选复选框
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = true);
                    // 重建 activeItemTypes
                    try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                    const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                    sidebarItemOptions.forEach(opt => {
                        activeItemTypes.add(opt.value);
                        if (opt.value === 'dealerships') {
                            migratedDealerships.forEach(t => activeItemTypes.add(t));
                        }
                    });
                    // 刷新标记
                    updateItemMarkers();
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                    }, () => {
                        // 取消无操作
                    });
                });
            }
            if (hideAllBtn) {
                hideAllBtn.addEventListener('click', () => {
                    openConfirmModal('是否要隐藏全部内容？', () => {
                        // 取消全选
                        document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = false);
                        // 清除标记与激活集合
                        clearAllItemMarkers();
                        // 同步清理Leaflet标记
                        if (typeof clearLeafletMarkers === 'function') clearLeafletMarkers();
                        try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                        if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                        if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                    }, () => {
                        // 取消无操作
                    });
                });
            }

            // 重置按钮
            const resetBtn = document.getElementById('reset-checkboxes');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = false);
                    // 清空所有 item markers
                    clearAllItemMarkers();
                    // 清空 activeItemTypes，确保重置后不会在后续操作中重新显示已取消的类型
                    try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                    // 同步更新车行标记（全部隐藏）并刷新 tilePane 位置
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                });
            }
        })();

        // 额外保障：全局监听，用于点击侧边栏外部时自动收起侧边栏（避免与按钮的双重触发冲突）
        document.addEventListener('click', (e) => {
            const sidePanel = document.getElementById('side-panel');
            if (!sidePanel) return;
            // 如果点击了折叠按钮本身，交由按钮的事件处理器处理，避免双重切换
            if (e.target.closest && e.target.closest('.side-panel-toggle')) return;
            // 如果当前未折叠，且点击目标位于侧边栏外部，则折叠侧边栏
            if (!sidePanel.classList.contains('collapsed') && !sidePanel.contains(e.target)) {
                sidePanel.classList.add('collapsed');
                // 更新按钮图标（如果存在）
                const toggleBtn = document.querySelector('.side-panel-toggle');
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    }
                }
            }
        });

        // 辅助：清除特定类型的 item markers（支持 itemMarkers 为 {type,index,el} 结构）
        function clearItemMarkersOfType(type) {
            if (!itemMarkers || itemMarkers.length === 0) return;
            // 过滤并移除对应类型的 DOM 元素
            const remaining = [];
            itemMarkers.forEach(m => {
                if (m && ((m.type && m.type === type) || (!m.type && m.dataset && m.dataset.type === type))) {
                    // m 可能是对象 {type,index,el} 或老式 DOM 元素
                    const el = m.el ? m.el : m;
                    if (el && el.remove) el.remove();
                } else {
                    remaining.push(m);
                }
            });
            itemMarkers = remaining;
            // 不再重置 currentItemType，这样在 multi-select 场景下不会意外清空单选状态
        }

        // 清除所有 item markers
        function clearAllItemMarkers() {
            if (!itemMarkers || itemMarkers.length === 0) return;
            itemMarkers.forEach(m => {
                const el = m && m.el ? m.el : m;
                if (el && el.remove) el.remove();
            });
            itemMarkers = [];
            
            // 清除Leaflet标记
            clearLeafletMarkers();
            
            // 保持 currentItemType 不变，这里只清理可视标记
        }



        // 保证侧边栏内容在移动端可滚动且滚动时不触发地图拖动
        document.addEventListener('DOMContentLoaded', function() {
            const sidePanelContent = document.querySelector('.side-panel-content');
            if (sidePanelContent) {
                // 优化 CSS：启用原生平滑滚动（iOS）
                sidePanelContent.style.webkitOverflowScrolling = 'touch';
                sidePanelContent.style.touchAction = 'pan-y';

                // 鼠标滚轮（桌面）滚动时阻止事件冒泡到地图
                sidePanelContent.addEventListener('wheel', function(e) {
                    const atTop = sidePanelContent.scrollTop === 0;
                    const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                    if ((e.deltaY < 0 && !atTop) || (e.deltaY > 0 && !atBottom)) {
                        e.stopPropagation();
                    }
                }, { passive: false });

                // 移动端触摸处理：检测垂直滑动并阻止冒泡，从而避免地图响应
                let startY = 0;
                let startX = 0;
                let isScrolling = undefined;

                sidePanelContent.addEventListener('touchstart', function(e) {
                    if (e.touches && e.touches.length === 1) {
                        startY = e.touches[0].clientY;
                        startX = e.touches[0].clientX;
                        isScrolling = undefined; // 未确定方向
                    }
                }, { passive: true });

                sidePanelContent.addEventListener('touchmove', function(e) {
                    if (!(e.touches && e.touches.length === 1)) return;
                    const curY = e.touches[0].clientY;
                    const curX = e.touches[0].clientX;
                    const dy = Math.abs(curY - startY);
                    const dx = Math.abs(curX - startX);

                    if (typeof isScrolling === 'undefined') {
                        isScrolling = dy > dx; // 如果垂直位移大于水平位移，判定为滚动
                    }

                    if (isScrolling) {
                        // 当面板可以继续滚动时，阻止事件冒泡到地图
                        const atTop = sidePanelContent.scrollTop === 0;
                        const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                        const movingUp = (curY - startY) > 0;
                        const movingDown = !movingUp;

                        // 如果尚未到达边界，则阻止冒泡（允许容器内部滚动）
                        if ((movingUp && !atTop) || (movingDown && !atBottom)) {
                            e.stopPropagation();
                            // 不调用 preventDefault：允许滚动发生，同时阻止地图捕获
                        }
                    }
                }, { passive: false });

                // 清理状态
                sidePanelContent.addEventListener('touchend', function() {
                    isScrolling = undefined;
                });
            }
        });
    </script>

    <script>
        // 强制在支持的浏览器上阻止手势缩放（iOS 的 gesture events）
        (function preventPinchZoom() {
            // Prevent iOS gesture events
            function stopEvent(e) { e.preventDefault(); }
            try {
                document.addEventListener('gesturestart', stopEvent, { passive: false });
                document.addEventListener('gesturechange', stopEvent, { passive: false });
                document.addEventListener('gestureend', stopEvent, { passive: false });
            } catch (err) {
                // 某些浏览器不支持 gesture* 事件，忽略错误
            }

            // Prevent pinch-zoom via two-finger touchmove
            document.addEventListener('touchstart', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent double-tap zoom (by blocking very quick successive touchend)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            // Prevent zooming with Ctrl + wheel (desktop/tablet)
            window.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
        })();

        // ==================== 埃普西隆质疑真理-载具模板（集成缓存） ====================
        
        // 埃普西隆质疑真理-载具 弹窗（样式与核废料一致：底部按钮，移除右上角×）
        function showAssumingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/assuming_the_truth/assuming_the_truth_${sequenceNumber}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.assuming-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            const totalCount = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const name = item?.name || `载具 #${sequenceNumber}`;
            const title = `☸️ 埃普西隆质疑真理 - ${name} (${hiddenCount}/${totalCount})`;

            // 构建弹窗（无右上角 ×，保留底部按钮）
            const popup = document.createElement('div');
            popup.className = 'assuming-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="assuming_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>这是需要运送给埃普西隆计划的载具，是陌生人与怪咖任务质疑真理（麦克）的一部分。<br/>载具总是在图示的确切位置生成。</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-att-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-att-btn');
            const hideBtn = popup.querySelector('#hide-att-btn');
            const showBtn = popup.querySelector('#show-att-btn');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 隐藏/显示逻辑 + 缓存 + 计数器
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('assuming_the_truth', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `☸️ 埃普西隆质疑真理 - ${name} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `☸️ 埃普西隆质疑真理 - ${name} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // 应用埃普西隆质疑真理-载具可见性缓存
        function applyAssumingTheTruthVisibilityCache() {
            try {
                const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const visibilityMap = VisibilityCache.loadVisibility('assuming_the_truth') || {};
                markers.forEach((marker, i) => {
                    if (!marker) return;
                    const isHidden = !!visibilityMap[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                });
                // 应用缓存后尝试刷新计数器
                try { updateAssumingTheTruthSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('应用埃普西隆质疑真理-载具可见性缓存失败:', e);
            }
        }

        // 统计隐藏/总数，并更新 assuming_the_truth 侧边栏计数器
        function updateAssumingTheTruthSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-assuming_the_truth + label .assuming-the-truth-counter');
                if (!counterEl) return;

                const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
                const total = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('assuming_the_truth');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('assuming_the_truth', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新 assuming_the_truth 计数器失败:', e);
            }
        }

        // 统计隐藏/总数，并更新 chasing_the_truth 侧边栏计数器
        function updateChasingTheTruthSidebarCount() {
            try {
                let counterEl = document.querySelector('#sidebar-item-chasing_the_truth + label .chasing-the-truth-counter');
                // 兜底：通过 nextElementSibling 精确定位 label 再找 counter
                if (!counterEl) {
                    const inputEl = document.getElementById('sidebar-item-chasing_the_truth');
                    const labelEl = inputEl && inputEl.nextElementSibling;
                    if (labelEl) counterEl = labelEl.querySelector('.chasing-the-truth-counter');
                }
                if (!counterEl) return;
                // 仅基于 VisibilityCache 计算（Leaflet 模式下不依赖 DOM）
                const total = Array.isArray(window.itemData?.chasing_the_truth) ? window.itemData.chasing_the_truth.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) {
                    if (visibilityMap[i] === true) hidden++;
                }

                CounterCache.updateCounter('chasing_the_truth', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新 chasing_the_truth 计数器失败:', e);
            }
        }

        // ==================== 埃普斯隆追求真理-神器模板（集成缓存） ====================
        
        // 埃普斯隆追求真理-神器 弹窗（样式与核废料一致：底部按钮，移除右上角×）
        function showChasingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            // 直接使用序号，不加前导0
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/chasing_the_truth/chasing_the_truth_${sequenceNumber}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.chasing-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数（基于 VisibilityCache）
            const arr = Array.isArray(window.itemData?.chasing_the_truth) ? window.itemData.chasing_the_truth : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) {
                if (visibilityMap[i] === true) hiddenCount++;
            }
            let isCurrentHidden = visibilityMap[index] === true;

            const name = item?.name || `神器 #${sequenceNumber}`;
            const title = `☯️ 埃普斯隆追求真理 - ${name} (${hiddenCount}/${totalCount})`;

            // 构建弹窗（无右上角 ×，保留底部按钮）
            const popup = document.createElement('div');
            popup.className = 'chasing-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="chasing_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>这是需要收集的埃普斯隆神器，是陷生人与怪咕任务追求真理（麦克）的一部分。<br/>神器总是在图示的确切位置生成。</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ctt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-ctt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-ctt-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-ctt-btn');
            const hideBtn = popup.querySelector('#hide-ctt-btn');
            const showBtn = popup.querySelector('#show-ctt-btn');
            const titleElement = popup.querySelector('h3');

            // 当前 marker 以及设置透明度的函数
            const cttMarkers = (window.chasingTheTruthMarkers && window.chasingTheTruthMarkers) || [];
            const currentCttMarker = cttMarkers[index];
            function setCurrentCttMarkerVisibility(opacity) {
                if (currentCttMarker && typeof currentCttMarker.setOpacity === 'function') currentCttMarker.setOpacity(opacity);
                else if (currentCttMarker && typeof currentCttMarker.setStyle === 'function') currentCttMarker.setStyle({ opacity });
                else if (currentCttMarker && typeof currentCttMarker.getElement === 'function') {
                    const el = currentCttMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
                const map = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                if (opacity === 0.3) map[index] = true; else delete map[index];
                VisibilityCache.saveVisibility('chasing_the_truth', map);
            }

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（覆盖层，不打开新标签）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 隐藏/显示按钮事件（同时修改透明度）
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentCttMarkerVisibility(0.3);
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    hiddenCount = newHiddenCount;
                    isCurrentHidden = true;
                    titleElement.textContent = `☯️ 埃普斯隆追求真理 - ${name} (${newHiddenCount}/${totalCount})`;
                    try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                });
            }
            
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentCttMarkerVisibility(1);
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    hiddenCount = newHiddenCount;
                    isCurrentHidden = false;
                    titleElement.textContent = `☯️ 埃普斯隆追求真理 - ${name} (${newHiddenCount}/${totalCount})`;
                    try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        

        // 应用埃普斯隆追求真理-神器可见性缓存（设置透明度+刷新计数器）
        function applyChasingTheTruthVisibilityCache() {
            try {
                const markers = (window.chasingTheTruthMarkers && window.chasingTheTruthMarkers) || [];
                const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!visibilityMap[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                        else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                        else if (typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) el.style.opacity = String(opacity);
                        }
                    });
                }
                try { updateChasingTheTruthSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('应用埃普斯隆追求真理-神器可见性缓存失败:', e);
            }
        }

        // ==================== 埃普西隆传单（epsilon_tracts） ====================

        // 侧边栏计数器：基于 VisibilityCache 统计隐藏/总数
        function updateEpsilonTractsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-epsilon_tracts + label .epsilon-tracts-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.epsilon_tracts) ? window.itemData.epsilon_tracts.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('epsilon_tracts', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新 epsilon_tracts 计数器失败:', e);
            }
        }

        // 应用可见性缓存：根据缓存恢复标记透明度，并刷新计数器（计数基于缓存，不依赖DOM）
        function applyEpsilonTractsVisibilityCache() {
            try {
                const markers = (window.epsilonTractsMarkers && window.epsilonTractsMarkers) || [];
                const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!visibilityMap[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        } else if (typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) el.style.opacity = String(opacity);
                        }
                    });
                }
                try { updateEpsilonTractsSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('应用 epsilon_tracts 可见性缓存失败:', e);
            }
        }

        // 弹窗（样式同神器）：底部按钮 + 图片 + 文案
        function showEpsilonTractsPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/epsilon_tracts/epsilon_tracts_${sequenceNumber}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.epsilon-tracts-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数（基于 VisibilityCache）
            const arr = Array.isArray(window.itemData?.epsilon_tracts) ? window.itemData.epsilon_tracts : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) if (visibilityMap[i] === true) hiddenCount++;
            let isCurrentHidden = visibilityMap[index] === true;

            const name = item?.name || `传单 #${sequenceNumber}`;
            const title = `☯️ 埃普西隆传单 - ${name} (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'epsilon-tracts-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="epsilon_tracts #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>游戏中共有 10 张传单，玩家需要按特定的顺序收集。<br/>此收藏品在完成陌生人和怪胎任务模糊真理（麦克）后解锁。马尔尼会向玩家发送一条短信，告知此收藏品的相关信息。<br/>传单可以由任意角色收集。每收集一张传单，马尔尼会向麦克发送短信，提示下一张传单的位置。<br/>集齐该收藏品，您将解锁第九典范的埃普西隆传单，157 年。</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-et-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-et-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-et-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-et-btn');
            const hideBtn = popup.querySelector('#hide-et-btn');
            const showBtn = popup.querySelector('#show-et-btn');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗（点击外部）
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（覆盖层，不打开新标签）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 当前 marker（若存在）及设置函数
            const markers = (window.epsilonTractsMarkers && window.epsilonTractsMarkers) || [];
            const currentMarker = markers[index];
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (currentMarker && typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (currentMarker && typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
                VisibilityCache.updateItemVisibility('epsilon_tracts', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    if (!isCurrentHidden) hiddenCount = hiddenCount + 1;
                    setCurrentMarkerVisibility(0.3);
                    titleElement.textContent = `☯️ 埃普西隆传单 - ${name} (${hiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    if (isCurrentHidden) hiddenCount = hiddenCount - 1;
                    setCurrentMarkerVisibility(1);
                    titleElement.textContent = `☯️ 埃普西隆传单 - ${name} (${hiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== 增强版核废料模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 nuclear_waste 增加一个计数器占位
        function attachNuclearWasteCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.nuclear-waste-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'nuclear-waste-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateNuclearWasteSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateNuclearWasteSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-nuclear_waste + label .nuclear-waste-counter');
                if (!counterEl) return;

                // 获取核废料标记
                const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
                const total = Array.isArray(window.itemData?.nuclear_waste) ? window.itemData.nuclear_waste.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('nuclear_waste');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('nuclear_waste', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新核废料计数器失败:', e);
            }
        }

        // ==================== 增强版隐藏包裹（线下）模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 sp_hidden_packages 增加一个计数器占位
        function attachSpHiddenPackagesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.sp-hidden-packages-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'sp-hidden-packages-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSpHiddenPackagesSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSpHiddenPackagesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-sp_hidden_packages + label .sp-hidden-packages-counter');
                if (!counterEl) return;

                // 获取隐藏包裹标记
                const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
                const total = Array.isArray(window.itemData?.sp_hidden_packages) ? window.itemData.sp_hidden_packages.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('sp_hidden_packages');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('sp_hidden_packages', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新隐藏包裹（线下）计数器失败:', e);
            }
        }
            // 埃普西隆质疑真理-载具 弹窗（样式与核废料一致：底部按钮，移除右上角×）
            function showAssumingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/assuming_the_truth/assuming_the_truth_${sequenceNumber}.webp`;

            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.assuming-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            const totalCount = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                const el = marker.getElement();
                if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const name = item?.name || `载具 #${sequenceNumber}`;
            const title = `☸️ 埃普西隆质疑真理 - ${name} (${hiddenCount}/${totalCount})`;

            // 构建弹窗（无右上角 ×，保留底部按钮）
            const popup = document.createElement('div');
            popup.className = 'assuming-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                <!-- 移除右上角 × -->
                </div>
                <img src="${imageUrl}" alt="assuming_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                <div>这是需要运送给埃普西隆计划的载具，是陌生人与怪咖任务质疑真理（麦克）的一部分。<br/>载具总是在图示的确切位置生成。</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="hide-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                <button id="show-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                <button id="close-att-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-att-btn');
            const hideBtn = popup.querySelector('#hide-att-btn');
            const showBtn = popup.querySelector('#show-att-btn');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                if (!popup.contains(e.target)) {
                    removePopup();
                    document.removeEventListener('click', closePopupHandler);
                }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大（同核废料/线下包裹）
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                e.stopPropagation();
                const overlay = document.createElement('div');
                overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                const bigImg = document.createElement('img');
                bigImg.src = popupImage.src;
                bigImg.alt = popupImage.alt || '';
                bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                overlay.appendChild(bigImg);
                const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                overlay.addEventListener('click', removeOverlay);
                document.addEventListener('keydown', onKey);
                document.body.appendChild(overlay);
                });
            }

            // 隐藏/显示逻辑 + 缓存 + 计数器
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('assuming_the_truth', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                setCurrentMarkerVisibility(0.3);
                const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                titleElement.textContent = `☸️ 埃普西隆质疑真理 - ${name} (${newHiddenCount}/${totalCount})`;
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isCurrentHidden = true;
                try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                setCurrentMarkerVisibility(1);
                const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                titleElement.textContent = `☸️ 埃普西隆质疑真理 - ${name} (${newHiddenCount}/${totalCount})`;
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isCurrentHidden = false;
                try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }

            document.body.appendChild(popup);
            }
        // 隐藏包裹（线下）弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSpHiddenPackagesImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/sp_hidden_packages/sp_hidden_packages_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.sp-hidden-packages-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // 获取描述信息
            const item = window.itemData?.sp_hidden_packages?.[index];
            const description = item?.description || '';
            let displayDescription = description;
            
            // 如果描述包含trevor，添加额外信息
            if (description.toLowerCase().includes('trevor')) {
                displayDescription += ' 在崔佛带过 4 名搭车人 （不是带人 4 次。一次带来 2 人，进度加 2）到利他营地后，与邪教徒发生枪战  后解锁。';
            }

            const title = `📦 隐藏包裹（线下） #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'sp-hidden-packages-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="隐藏包裹（线下） #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${displayDescription || '可在上图位置找到！'}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-sp-hidden-packages-btn');
            const hideBtn = popup.querySelector('#hide-sp-hidden-packages-btn');
            const showBtn = popup.querySelector('#show-sp-hidden-packages-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'sp-hidden-packages-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('sp_hidden_packages', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `📦 隐藏包裹（线下） #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `📦 隐藏包裹（线下） #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到隐藏包裹（线下）标记
        function applySpHiddenPackagesVisibilityCache() {
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('sp_hidden_packages');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用隐藏包裹（线下）可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 增强版潜水艇碎片模板（集成缓存） ====================
        
        // 创建侧边栏条目时，为 submarine_pieces 增加一个计数器占位
        function attachSubmarinePiecesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.submarine-pieces-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'submarine-pieces-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // 初次渲染计数
            updateSubmarinePiecesSidebarCount();
        }

        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateSubmarinePiecesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-submarine_pieces + label .submarine-pieces-counter');
                if (!counterEl) return;

                // 获取潜水艇碎片标记
                const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
                const total = Array.isArray(window.itemData?.submarine_pieces) ? window.itemData.submarine_pieces.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('submarine_pieces');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('submarine_pieces', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新潜水艇碎片计数器失败:', e);
            }
        }

        // 潜水艇碎片弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showSubmarinePiecesImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/submarine_pieces/submarine_pieces_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.submarine-pieces-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `🚢 潜水艇碎片 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'submarine-pieces-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="潜水艇碎片 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">🎯 收集奖励</div>
                    游戏中总共有 30 个潜水艇碎片。要收集这些碎片，您必须在完成主线任务抢劫梅利威瑟与闪电突袭后，使用任意角色购买声呐打捞码头（250.000 GTA$），以此接取陌生人和怪胎任务深海意外（麦克）。<br><br>
                    每个角色都可以拾取碎片，但只有麦克可以交付它们。您最好使用购买码头附赠的小艇。驾驶该载具时，游戏会显示碎片所在的区域，并以绿色区域标识在地图上。碎片会发出声波，您可以在小地图上看到。<br><br>
                    一旦集齐所有碎片，您将解锁陌生人和怪胎任务真相浮现（麦克）。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-submarine-pieces-btn');
            const hideBtn = popup.querySelector('#hide-submarine-pieces-btn');
            const showBtn = popup.querySelector('#show-submarine-pieces-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'submarine-pieces-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('submarine_pieces', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `🚢 潜水艇碎片 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateSubmarinePiecesSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `🚢 潜水艇碎片 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateSubmarinePiecesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到潜水艇碎片标记
        function applySubmarinePiecesVisibilityCache() {
            const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('submarine_pieces');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用潜水艇碎片可见性缓存');
                return true;
            }
            return false;
        }

        // 核废料弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showNuclearWasteImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/nuclear_waste/nuclear_waste_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.nuclear-waste-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `☢️ 核废料 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗
            const popup = document.createElement('div');
            popup.className = 'nuclear-waste-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="核废料 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    可在上图位置找到！
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">🎯 收集奖励</div>
                    总共有 30 个核废料桶，要想收集这些核废料，您必须完成主线任务 抢劫梅利威瑟，并用任意角色购买 声呐打捞码头 (250.000 GTA$)。<br>
                    每个角色都可以拾取核废料桶，但只有拥有码头的角色才可以获得现金奖励。您可以使用购买码头附赠的 潜水艇/海怪。驾驶该载具时，您可以使用 Trackify APP，它可以指示核废料的位置。此外，有些核废料桶的位置确实很深。<br><br>
                    每个核废料的奖励是 23.000 GTA$ ，完成该收集将获得 250.000 GTA$ 和一个成就。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-nuclear-waste-btn');
            const hideBtn = popup.querySelector('#hide-nuclear-waste-btn');
            const showBtn = popup.querySelector('#show-nuclear-waste-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'nuclear-waste-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('nuclear_waste', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `☢️ 核废料 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateNuclearWasteSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `☢️ 核废料 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateNuclearWasteSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到核废料标记
        function applyNuclearWasteVisibilityCache() {
            const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('nuclear_waste');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用核废料可见性缓存');
                return true;
            }
            return false;
        }

        // ==================== 增强版洛圣都的人类模板（集成缓存） ====================
        
        // 统计隐藏/总数，并更新侧边栏计数器文本（集成缓存）
        function updateHumansOfLsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-humans_of_ls + label .humans-of-ls-counter');
                if (!counterEl) return;

                // 获取 humans_of_ls 标记
                const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
                const total = Array.isArray(window.itemData?.humans_of_ls) ? window.itemData.humans_of_ls.length : 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                }

                // 与缓存合并，防止重新显示后隐藏计数被清零
                const cachedCounter = CounterCache.getCounter('humans_of_ls');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // 更新缓存
                CounterCache.updateCounter('humans_of_ls', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('更新洛圣都的人类计数器失败:', e);
            }
        }

        // 洛圣都的人类弹窗模板（含隐藏/显示联动与计数器、缓存集成）
        function showHumansOfLsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/humans_of_ls/humans_of_ls_${sequenceNumber}.webp`;
            
            // 关闭已存在的弹窗
            const existingPopup = document.querySelector('.humans-of-ls-popup');
            if (existingPopup) existingPopup.remove();

            // 统计隐藏/总数
            const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // 描述内容：使用 zones.json 中的 ID + 固定说明
            const item = window.itemData?.humans_of_ls?.[index];
            const idText = item?.id || `humans_of_ls_${sequenceNumber}`;
            const displayDescription = `${idText}：与您遇到的角色交谈，即可在导演模式中解锁他们。一旦您解锁了所有角色，并使用其中一个，您将获得一个成就。`;

            const title = `👤 洛圣都的人类 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // 构建弹窗（样式与核废料一致）
            const popup = document.createElement('div');
            popup.className = 'humans-of-ls-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">×</span>
                </div>
                <img src="${imageUrl}" alt="洛圣都的人类 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${displayDescription}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">隐藏</button>
                    <button id="show-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">显示</button>
                    <button id="close-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">关闭</button>
                </div>
            `;

            // 绑定元素
            const closeBtn = popup.querySelector('#close-humans-of-ls-btn');
            const hideBtn = popup.querySelector('#hide-humans-of-ls-btn');
            const showBtn = popup.querySelector('#show-humans-of-ls-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // 关闭弹窗
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // 图片点击放大
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'humans-of-ls-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // 工具：隐藏/显示当前标记
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // 更新缓存
                VisibilityCache.updateItemVisibility('humans_of_ls', index, opacity === 0.3);
            }

            // 隐藏按钮
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `👤 洛圣都的人类 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // 刷新侧边栏计数
                    updateHumansOfLsSidebarCount();
                });
            }

            // 显示按钮
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `👤 洛圣都的人类 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // 刷新侧边栏计数
                    updateHumansOfLsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // 应用缓存的可见性状态到 humans_of_ls 标记
        function applyHumansOfLsVisibilityCache() {
            const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('humans_of_ls');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('已应用洛圣都的人类可见性缓存');
                return true;
            }
            return false;
        }
    </script>

</body>
</html>

