<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GTA地图 - 洛圣都</title>
        <!-- FontAwesome 6 Free for custom checkbox icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />

    <style>
        /* CSS变量系统 - 定义GTA风格的蓝色主题 */
        :root {
            --gta-bg-dark: #0a1929;
            --gta-bg-medium: rgba(15, 25, 35, 0.95);
            --gta-bg-light: rgba(25, 40, 55, 0.7);
            --gta-primary: #1976d2;
            --gta-primary-glow: rgba(25, 118, 210, 0.7);
            --gta-secondary: #2196f3;
            --gta-border: #2e5c8a;
            --gta-border-light: #4a90e2;
            --gta-text: #ffffff;
            --gta-text-secondary: #b3d9ff;
            --gta-accent: #42a5f5;
            /* 兼容变量映射，供佩里科样式复用（蓝色主题） */
            --bg-darker: var(--gta-bg-medium);
            --primary-color: var(--gta-primary);
            --primary-dark: #145a9e;
            --accent-color: var(--gta-accent);
            --border-color: var(--gta-border);
            --text-secondary: var(--gta-text-secondary);
            --transition: all 0.15s ease;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--gta-bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* 禁止移动端缩放（捏合/双击） */
            touch-action: manipulation; /* 限制手势为基本交互，阻止双指缩放 */
            -ms-touch-action: manipulation;
            -webkit-text-size-adjust: 100%; /* 防止 iOS 双击放大文本 */
        }

        /* 隐藏整体页面的滚动条（右侧和底部），但不影响内部可滚动面板样式 */
        html, body {
            overflow: hidden; /* 隐藏全局滚动 */
        }

        /* WebKit 浏览器隐藏滚动条轨道，但保留滚动功能（用于内部滚动容器） */
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* Firefox 隐藏滚动条（仍可滚动） */
        html, body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }

        /* 主容器 */
        #map-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
            overflow: visible !important;
        }
        #map-container:active { cursor: grabbing; }

        #tile-pane {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 650;
        }

        /* 隐藏地图上的游戏原点显示（若存在） */
        #origin-marker {
            display: none !important;
        }

        /* 加载动画 */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gta-text);
            background: var(--gta-bg-medium);
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 800;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
            pointer-events: none;
            border: 1px solid var(--gta-border);
        }
        .loader.visible { opacity: 1; pointer-events: auto; }

        /* 文件识别状态 */
        #file-status {
            position: absolute;
            left: 15px;
            top: 15px;
            background: rgba(0,0,0,0.7);
            color: var(--gta-text);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
            z-index: 750;
            font-size: 13px;
            pointer-events: none;
            min-width: 180px;
        }
        #file-status.ok { background: rgba(21,128,61,0.9); }
        #file-status.warn { background: rgba(170,85,0,0.9); }
        #file-status.err { background: rgba(128,20,20,0.9); }

        /* 物品标记样式 */
        .item-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 670;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .item-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        .item-marker img {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        /* 佩里科岛风格：物品选择器（蓝色主题） */
        .item-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .item-checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            width: 100%;
        }

        .item-checkbox {
            display: none;
        }

        /* 隐藏原生复选，使用紧凑的 label 做替代 */
        .item-checkbox + label {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
            width: 100%;
            color: var(--gta-text);
            gap: 4px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            /* 放在标题后面显示，不再需要额外左边距 */
            margin-left: 0;
            align-items: center;
        }

        .nav-links a {
            color: white; /* 链接字体改为白色 */
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        /* 当时间/天气位于导航链接旁时的微调样式 */
        .gta-nav .nav-left #game-time-weather {
            margin-left: 8px;
            font-size: 13px;
            opacity: 0.95;
            color: rgba(255,255,255,0.95);
            pointer-events: none;
        }

        .gta-nav .nav-left .nav-weather {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            color: white !important;
            font-size: 13px;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .gta-nav .nav-left #game-time-weather {
                margin-left: 10px;
                display: inline-flex !important;
                align-items: center;
                color: white !important;
            }
        }

        /* 强覆盖，保证移动端/导航内始终可见 */
        .gta-nav .nav-left #game-time-weather {
            display: inline-flex !important;
            align-items: center !important;
            color: white !important;
        }

        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        /* 移动端强制覆盖：确保标题左对齐，不被后续全局规则影响 */
        @media (max-width: 768px) {
            .gta-nav .nav-left {
                flex: 0 0 auto !important;
                flex-grow: 0 !important;
                justify-content: flex-start !important;
            }
            .gta-nav .nav-right {
                margin-left: auto !important;
            }
            .gta-title { text-align: left !important; }
        }

        .nav-buttons-desktop {
            display: flex;
            gap: 15px;
        }

        /* 移动端样式 */
        .nav-buttons-mobile {
            display: none;
        }

        /* 移动端导航：仅显示标题与“更多”按钮，其余链接放入下拉菜单 */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .nav-buttons-desktop { display: none; }
            .nav-buttons-mobile { display: block; }
            .gta-nav { padding: 8px 12px; }
            .gta-title { font-size: 18px; padding: 6px 10px; }

            /* 保持导航栏在一行 */
            .gta-nav { flex-wrap: nowrap; align-items: center; }
            .gta-title { white-space: nowrap; }
            /* 左侧标题固定宽度，不占满剩余空间 */
            .nav-left { flex: 0 0 auto; display: flex; align-items: center; gap: 8px; }
            /* 右侧靠右显示，保持为内联横向布局 */
            .nav-right { flex: 0 0 auto; margin-left: auto; display: flex; align-items: center; }
            .nav-buttons-mobile { display: flex; align-items: center; }
            .menu-toggle { white-space: nowrap; }

            .mobile-menu {
                display: none;
                position: absolute;
                top: 56px;
                right: 12px;
                /* Use same visual style as the title bar for consistency */
                background: linear-gradient(90deg, rgba(10, 25, 41, 0.95) 0%, rgba(25, 118, 210, 0.95) 100%);
                border: 1px solid #42a5f5;
                padding: 10px;
                border-radius: 8px;
                z-index: 1100;
                box-shadow: 0 8px 22px rgba(20,30,50,0.5);
                flex-direction: column;
                gap: 8px;
                min-width: 160px;
                backdrop-filter: blur(6px);
            }

            .mobile-menu.show { display: flex; }

            .mobile-menu .nav-button,
            .mobile-menu .nav-link {
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(255,255,255,0.06);
                color: white;
                padding: 8px 10px;
                border-radius: 8px;
                text-decoration: none;
                border: none;
                cursor: pointer;
            }

            .menu-toggle {
                background: rgba(255,255,255,0.06);
                color: white;
                border: 1px solid rgba(255,255,255,0.08);
                padding: 8px 12px;
                border-radius: 14px;
                cursor: pointer;
                font-size: 14px;
            }
        }

        .item-checkbox + label:before {
            /* 使用 FontAwesome 的方框图标作为占位（回退） */
            content: "\f0c8";
            font-family: "Font Awesome 6 Free";
            margin-right: 4px;
            color: var(--text-secondary);
            transition: var(--transition);
            font-weight: 900;
            font-size: 16px;
            display: inline-block;
            width: 16px;
            text-align: center;
        }

        .item-checkbox:checked + label {
            background: var(--primary-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--gta-primary-glow);
        }

        .item-checkbox:checked + label:before {
            content: "\f14a"; /* FontAwesome checked */
            color: var(--accent-color);
        }

        .item-checkbox + label:hover {
            border-color: var(--primary-color);
            background: rgba(25,118,210,0.12);
        }

        .item-icon {
            width: 16px;
            height: 16px;
            margin-right: 0;
            display: inline-block;
            object-fit: contain;
        }

        /* GTA风格导航栏 - 佩里科岛风格蓝色主题 */
        .gta-nav {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(10, 25, 41, 0.7) 0%, rgba(25, 118, 210, 0.7) 100%);
            border-bottom: 2px solid #42a5f5;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .gta-nav .nav-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-grow: 1;
        }

        .gta-title {
            font-family: 'Impact', sans-serif;
            color: white;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin: 0;
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .gta-title i {
            margin-right: 8px;
            color: var(--gta-primary);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        .nav-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:hover {
            background: var(--gta-primary);
            color: var(--gta-bg-dark);
            box-shadow: 0 0 15px var(--gta-primary-glow);
            transform: translateY(-1px);
        }

        .nav-button.back-button {
            background: var(--gta-secondary);
            border-color: var(--gta-secondary);
        }

        /* 侧边栏（佩里科岛样式） */
        .side-panel {
            position: absolute;
            top: 80px;
            left: 10px;
            width: 320px;
            max-height: calc(100% - 120px);
            background: linear-gradient(180deg, rgba(10,20,30,0.85), rgba(15,25,35,0.9));
            border: 1px solid var(--gta-border);
            border-radius: 10px;
            color: var(--gta-text);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
        }

        .side-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .side-panel-title {
            font-weight: bold;
            color: var(--gta-text);
            font-size: 14px;
            text-transform: uppercase;
        }

        .side-panel-content {
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            scrollbar-width: thin;
        }

        /* 蓝色自定义滚动条（webkit） */
        .side-panel-content::-webkit-scrollbar {
            width: 8px;
            background: rgba(25, 118, 210, 0.08);
        }
        .side-panel-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #42a5f5 0%, #1976d2 100%);
            border-radius: 6px;
        }
        .side-panel-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1976d2 0%, #42a5f5 100%);
        }
        /* Firefox */
        .side-panel-content {
            scrollbar-color: #42a5f5 rgba(25, 118, 210, 0.08);
            scrollbar-width: thin;
        }

        .side-panel-section { margin-bottom: 14px; }
        .side-panel-section-title { font-size: 13px; color: var(--gta-accent); margin-bottom: 8px; }

        /* item selector */
        .item-selector-container { display:flex; flex-direction:column; gap:6px; }
        .item-checkbox + label { display:flex; align-items:center; gap:8px; padding:8px; background: rgba(255,255,255,0.02); border-radius:6px; cursor:pointer; }

        /* 隐藏默认 leaflet 缩放控件 */
        .leaflet-control-zoom { display: none; }

        /* 底部缩放控制 */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 7px; /* 放大 1/3（5px -> 7px） */
            background: rgba(10,20,30,0.85);
            padding: 5px; /* 4px -> 5px */
            border-radius: 13px; /* 10px -> 13px */
            border: 1px solid var(--gta-border);
            box-shadow: 0 6px 14px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* 折叠状态样式：当面板添加 .collapsed 时收起内容并缩窄宽度 */
        .side-panel.collapsed {
            width: 56px;
            overflow: hidden;
            transition: width 0.25s ease;
        }

        .side-panel.collapsed .side-panel-content {
            display: none;
        }

        .side-panel.collapsed .side-panel-title {
            display: none;
        }

        .side-panel.collapsed .side-panel-header {
            justify-content: center;
        }

        .zoom-button {
            width: 30px; /* 22px * 4/3 ≈ 29.3 -> 30px */
            height: 30px; /* 30px */
            background: linear-gradient(160deg, #145a9e 60%, #1976d2 100%);
            color: #fff;
            border: 1.5px solid #1565c0; /* 略增边框以适配尺寸 */
            border-radius: 50%;
            font-size: 0.9rem; /* 从0.65rem放大1/3 -> ~0.87rem，取0.9rem */
            box-shadow: 0 0 0 1.3px rgba(25, 118, 210, 0.13), 0 3px 10px rgba(20, 90, 158, 0.22);
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            user-select: none;
        }
        .zoom-button:active {
            background: linear-gradient(160deg, #0d305a 60%, #145a9e 100%);
            box-shadow: 0 0 0 1.3px #145a9e, 0 1px 5px rgba(20,90,158,0.18);
            transform: scale(0.98);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(160deg, #1976d2 0%, #145a9e 100%);
            box-shadow: 0 0 0 2px #1976d2, 0 5px 16px rgba(20,90,158,0.32);
            transform: scale(1.05);
        }
        .zoom-button i {
            font-size: 16px; /* 适配 30px 按钮 */
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }

        /* 右上角地图控制菜单按钮美化 */
        .side-panel-toggle {
            width: 40px;
            height: 40px;
            background: transparent !important;
            color: #fff;
            border: none !important;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: none !important;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            padding: 0;
            user-select: none;
        }
        .side-panel-toggle:active {
            background: rgba(25, 118, 210, 0.10);
            box-shadow: none;
            transform: scale(0.96);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: rgba(25, 118, 210, 0.13);
            box-shadow: 0 0 0 2px #1976d233, 0 2px 8px #1976d211;
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            font-size: 1.2em;
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }
        /* 右上角地图控制菜单按钮美化 */
        .side-panel-toggle {
            width: 38px;
            height: 38px;
            background: linear-gradient(145deg, var(--gta-accent) 0%, var(--gta-primary) 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18), 0 1px 0 #fff inset;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        .side-panel-toggle:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 1px 4px rgba(25, 118, 210, 0.12);
            transform: scale(0.97);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.22);
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            pointer-events: none;
        }
        .zoom-button:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18);
            transform: scale(0.97);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 6px 24px rgba(25, 118, 210, 0.32);
            transform: scale(1.10);
        }
        .zoom-button i {
            pointer-events: none;
        }

        /* 蓝色滚动条（GTA 风格） */
        .side-panel-content::-webkit-scrollbar { width: 10px; }
        .side-panel-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 6px; }
        .side-panel-content::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--gta-primary),var(--gta-accent)); border-radius: 6px; box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }

        .nav-button.back-button:hover {
            background: var(--gta-accent);
            border-color: var(--gta-accent);
        }

        .nav-section select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-section select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        .nav-section select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* 物品类型选择器 */
        /* 地图样式选择器：放在侧边栏内，不使用绝对定位以避免遮挡地图 */
        .map-style-selector {
            position: static;
            margin-bottom: 12px;
            background: transparent;
            border-radius: 6px;
            border: none;
            box-shadow: none;
            padding: 0;
            z-index: auto;
            width: 100%;
        }

        .map-style-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--gta-text);
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-style-selector select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .map-style-selector select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        .map-style-selector select:focus {
            outline: none;
            border-color: var(--gta-accent);
            box-shadow: 0 0 12px rgba(30, 144, 255, 0.4);
        }

        .item-selector-wrapper {
            position: absolute;
            top: 150px;
            right: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            width: 200px;
        }

        .item-selector-label {
            color: var(--gta-text);
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #item-type-select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #item-type-select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        #item-type-select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* 物品信息弹窗 */
        #item-info {
            position: absolute;
            bottom: 120px;
            left: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            max-width: 300px;
            display: none;
        }

        #item-info .close {
            position: absolute;
            top: 5px;
            right: 10px;
            color: var(--gta-text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #item-info .close:hover {
            color: var(--gta-secondary);
        }

        #item-title {
            color: var(--gta-primary);
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #item-coords, #item-location, #item-details {
            color: var(--gta-text);
            font-size: 14px;
            margin: 5px 0;
            line-height: 1.4;
        }

        /* 右下角缩放按钮 - 缩小为 50% */
        .zoom-controls {
            position: absolute;
            right: 32px;
            bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px; /* 50% */
            z-index: 1200;
            user-select: none;
        }

        #vertical-links a {
            color: var(--gta-primary);
            text-decoration: none;
            padding: 6px 12px;
            margin: 2px 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        #vertical-links a:hover {
            color: white;
            background: rgba(25, 118, 210, 0.2);
        }

        /* 游戏时间/天气 - 默认作为导航下的内联项，去掉底部蓝色框 */
        #game-time-weather {
            font-size: 14px;
            color: #fff;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 1300;
            pointer-events: none;
            letter-spacing: 0.6px;
            min-width: 0;
            text-align: left;
            user-select: none;
            display: inline-block;
            opacity: 0.95;
        }

        /* 保持静止，无动画 */

        /* 响应式设计 */
        @media (max-width: 768px) {
            .gta-nav {
                padding: 8px 15px;
                /* 在移动端也保持一行：标题左，更多按钮右 */
                flex-direction: row;
                justify-content: space-between;
                gap: 8px;
                align-items: center;
            }

            .gta-title {
                font-size: 18px;
            }

            .nav-button {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* 移动端只显示：标题、时间/天气、更多（隐藏其它左侧/右侧项） */
            .gta-nav .nav-left > *:not(.gta-title):not(#game-time-weather) {
                display: none !important;
            }

            .gta-nav .nav-right > *:not(.nav-buttons-mobile) {
                display: none !important;
            }

            .nav-buttons-desktop { display: none !important; }
            .nav-buttons-mobile { display: flex !important; }

            .map-style-selector {
                top: 120px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            .item-selector-wrapper {
                top: 190px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            #item-info {
                bottom: 100px;
                left: 10px;
                max-width: 250px;
                padding: 10px;
            }

            /* Keep game time/weather inline on mobile so JS can place it next to the title.
               Previously it was forced to bottom-right with !important which conflicted
               with the runtime placement logic. */
            #game-time-weather {
                display: inline-flex !important;
                align-items: center !important;
                color: white !important;
                font-size: 14px !important;
                margin-left: 8px !important;
                background: transparent !important;
                padding: 0 6px !important;
                pointer-events: none !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>

    <!-- 地图容器 -->
    <div id="map-container">
        <!-- 左侧控制面板（佩里科岛样式） -->
        <div class="side-panel" id="side-panel">
            <div class="side-panel-header">
                <div class="side-panel-title">地图控制</div>
                <button class="side-panel-toggle" id="panel-toggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="side-panel-content">
                <div class="side-panel-section">
                    <div class="side-panel-section-title">地图样式</div>
                    <div class="map-style-selector">

                        <select id="map-style-select" style="width:100%; margin-top:6px;">
                            <option value="https://eo-gta-maps.antwen.com/maps/gta_map/gta_map_game">游戏 (Game)</option>
                            <option value="https://eo-gta-maps.antwen.com/maps/gta_map/gta_map_render">渲染 (Render)</option>
                            <option value="https://eo-gta-maps.antwen.com/maps/gta_map/gta_map_print">印刷 (Print)</option>
                        </select>
                    </div>
                </div>

                <div class="side-panel-section">
                    <div class="side-panel-section-title">显示物品</div>
                    <div class="item-selector-container" id="sidebar-item-selectors">
                        <!-- 复用现有 item 选择（稍后通过 JS 填充） -->
                    </div>
                </div>

                <div class="side-panel-section">
                    <button id="reset-checkboxes" class="nav-button" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-undo"></i> 重置选择
                    </button>
                </div>
            </div>
        </div>
        <div id="tile-pane"></div>
    </div>

    <!-- GTA风格导航栏 -->
    <div class="gta-nav">
        <div class="nav-left">
            <h1 class="gta-title">🏙️ 洛圣都地图</h1>
            <div class="nav-links">
                <a href="https://www.antwen.com" target="_blank">安稳</a>
                <a href="https://s.antwen.com" target="_blank">在线文件</a>
            </div>
        </div>
        <div class="nav-right">
            <!-- PC端显示 -->
            <div class="nav-buttons-desktop">
                <a href="index.html" class="nav-button">🏠 首页</a>
                <a href="cayo-perico-map.html" class="nav-button">🏝️ 佩里科岛</a>
                <a href="vehicles.html" class="nav-button">🚗 车辆数据库</a>
            </div>
            <!-- 移动端显示 -->
            <div class="nav-buttons-mobile">
                <button class="menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i> 更多
                </button>
                <div class="mobile-menu" id="mobile-menu">
                    <a href="index.html" class="nav-button">🏠 首页</a>
                    <a href="cayo-perico-map.html" class="nav-button">🏝️ 佩里科岛</a>
                    <a href="vehicles.html" class="nav-button">🚗 车辆数据库</a>
                    <a href="https://www.antwen.com" target="_blank" class="nav-link">🔗 安稳</a>
                    <a href="https://s.antwen.com" target="_blank" class="nav-link">☁️ 在线文件</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图样式选择器 已移入侧边栏 -->

    <!-- 物品类型复选项已移入侧边栏 -->

    <!-- 物品信息弹窗 -->
    <div id="item-info">
        <span class="close" onclick="hideItemInfoText()">×</span>
        <h3 id="item-title">物品信息</h3>
        <p id="item-coords">坐标: </p>
        <p id="item-location">位置: </p>
        <p id="item-details">详细信息: </p>
    </div>

    <!-- 加载动画 -->
    <div class="loader" id="loader">地图加载中...</div>

        <!-- 底部缩放控制 -->
        <div class="zoom-controls">
            <button class="zoom-button" id="zoom-in">
                <i class="fas fa-plus"></i>
            </button>
            <button class="zoom-button" id="zoom-out">
                <i class="fas fa-minus"></i>
            </button>
        </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // --- 配置/常量 ---
        const TILE_SIZE = 256;
        const GAME_LEFT = -4140;
        const GAME_RIGHT = 4860;
        const GAME_BOTTOM = -5100;
        const GAME_TOP = 8400;

        const zoomLevels = [
            { zoom: 3, cols: 4, rows: 6 },   // 最小缩放级别
            { zoom: 4, cols: 8, rows: 12 },
            { zoom: 5, cols: 16, rows: 24 },
            { zoom: 6, cols: 32, rows: 48 } ,
            { zoom: 7, cols: 64, rows: 96 }  // 最大缩放级别
        ];

        // 物品图标路径映射
        const itemIcons = {
            hidden_caches: './src/assets/cache.png',
            shipwrecked: './src/assets/shipwrecked.png',
            gun_van: './src/assets/van.png',
            dead_drop: './src/assets/dead_drop.svg',
            stunt_jumps: './src/assets/stunt_jumps.svg',
            spray: './src/assets/spray.svg',
            ls_tags: './src/assets/ls_tags.svg',
            street_dealers: './src/assets/dealer.png',
            playing_cards: './src/assets/playing_cards.svg',
            smoke_on_the_water_product: './src/assets/smoke_product.svg',
            action_figures: './src/assets/action_figures.svg',
            yuanbao: './src/assets/yuanbao.svg',
            ld_organics_products: './src/assets/organic_farm.svg',
            signal_jammers: './src/assets/signal_jammer.svg',
            jack_o_lanterns: './src/assets/jack.svg',
            payphone_hits: './src/assets/payphone.svg',
            golf_holes: './src/assets/golf.svg',
            snowmen: './src/assets/snowmen.svg',
            rc_time_trial: './src/assets/rctt.png',
            bike_time_trial: './src/assets/btt.png',
            skydives: './src/assets/skydive.png',
            gang_attacks: './src/assets/gang_attack.svg',
            ghosts3: './src/assets/ge251.svg',
            treasure_hunt_dba_revolver: './src/assets/th1.svg',
            // 洛圣都杀人狂（选择器用 slasher.svg）
            serial_killer_slasher: './src/assets/slasher.svg',
            // 茉德悬赏目标图标
            maude_bounty_targets: './src/assets/mp_static.svg', // 临时使用，后续需要创建专用图标
            // 媒体记忆棒图标
            media_sticks: './src/assets/media.svg',
            // 藏匿屋图标
            stash_houses: './src/assets/stash.svg',
            // 玛德拉索雇凶图标
            madrazo_hits: './src/assets/hits.svg',
            // 帕特里克救援图标
            police_rescue_patrick_mcreary: './src/assets/patrick.svg',
            // 随机任务图标
            random_missions: './src/assets/random.svg',
            // 毒品载具图标
            drug_vehicle: './src/assets/drug_vehicle.svg',
            // 电影道具图标
            movie_props: './src/assets/mp_static.svg',
            // 车行图标
            casino: './src/assets/casino.svg',
            car_meet: './src/assets/lscm.svg',
            premium_deluxe_motorsport: './src/assets/sem.svg',
            luxury_autos: './src/assets/lux.svg',
            // 沉睡的保安
            drunk_guard: './src/assets/drunk_guard.svg',
            // 金属探测器
            metal_detector: './src/assets/metal.svg',
            // 走私贩飞机
            smuggler_plane: './src/assets/smuggler_plane.svg'
        };

        // 物品数据（从JSON文件加载）
        const itemData = {
            hidden_caches: [],
            shipwrecked: [],
            gun_van: [],
            dead_drop: [],
            ls_tags: [],
            street_dealers: [],
            playing_cards: [],
            smoke_on_the_water_product: [],
            action_figures: [],
            yuanbao: [],
            ld_organics_products: [],
            signal_jammers: [],
            jack_o_lanterns: [],
            payphone_hits: [],
            golf_holes: [],
            snowmen: [],
            stunt_jumps: [],
            spray: [],
            rc_time_trial: [],
            bike_time_trial: [],
            skydives: [],
            gang_attacks: [],
            ghosts3: [],
            treasure_hunt_dba_revolver: { random_clue: [], static_clues: [] },
            movie_props: { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } },
            serial_killer_slasher: { first: [], last: [] },
            maude_bounty_targets: { areas: [], endpoints: [] },
            media_sticks: [],
            stash_houses: [],
            madrazo_hits: [],
            police_rescue_patrick_mcreary: { spawn: [], dropoff: [] },
            random_missions: {},
            drug_vehicle: [],
            drunk_guard: [],
            metal_detector: [],
            smuggler_plane: []
        };

        // 车行位置数据
        const dealershipData = {
            casino: {
                coordinates: [[939.1505, 26.4848]],
                name: '赌场',
                icon: 'casino'
            },
            car_meet: {
                coordinates: [[781.25, -1868.553]],
                name: '车友会',
                icon: 'car_meet'
            },
            premium_deluxe_motorsport: {
                coordinates: [[-42.6786, -1097.2642]],
                name: '西米恩',
                icon: 'premium_deluxe_motorsport'
            },
            luxury_autos: {
                coordinates: [[-788.722, -239.5369]],
                name: '豪华',
                icon: 'luxury_autos'
            }
        };

        // 车行标记数组
        let dealershipMarkers = [];

        // 武器厢型车位置缓存（每天变化）
        let gunVanLocation = null;
        let gunVanLastUpdate = 0;
        
        // LS涂鸦位置缓存（每天变化）
        let lsTagsLastUpdate = 0;
        
        // 隐藏包裹位置缓存（每天变化）
        let hiddenCachesLastUpdate = 0;
        
        // 沉船位置缓存（每天变化）
        let shipwreckedLastUpdate = 0;

        // DOM元素
        const styleSelect = document.getElementById('map-style-select');
        // 右上角的 item-type-select 已移除，侧边栏使用静态选项数组生成复选框
        const sidebarItemOptions = [
            { value: 'dealerships', text: '🏦 车行位置' },
            { value: 'hidden_caches', text: '隐藏包裹' },
            { value: 'shipwrecked', text: '沉船' },
            { value: 'gun_van', text: '武器厢型车' },
            { value: 'dead_drop', text: '杰拉德包裹' },
            { value: 'ls_tags', text: 'LS涂鸦' },
            { value: 'street_dealers', text: '街头毒贩' },
            { value: 'playing_cards', text: '纸牌' },
            { value: 'smoke_on_the_water_product', text: '吞云吐雾馆产品' },
            { value: 'action_figures', text: '手办' },
            { value: 'yuanbao', text: '元宝' },
            { value: 'stunt_jumps', text: '特技跳跃点' },
            { value: 'spray', text: '喷罐位置' },
            { value: 'ld_organics_products', text: '有机坊产品' },
            { value: 'signal_jammers', text: '信号干扰器' },
            { value: 'jack_o_lanterns', text: '南瓜灯' },
            { value: 'payphone_hits', text: '电话暗杀' },
            { value: 'golf_holes', text: '高尔夫球洞' },
            { value: 'snowmen', text: '雪人' },
            { value: 'rc_time_trial', text: 'RC时间挑战赛' },
            { value: 'bike_time_trial', text: '自行车时间挑战赛' },
            { value: 'skydives', text: '跳伞' },
            { value: 'gang_attacks', text: '⚔️ 帮派攻击' },
            { value: 'ghosts3', text: '幽灵曝光2025' },
            { value: 'treasure_hunt_dba_revolver', text: '左轮寻宝' },
            { value: 'movie_props', text: '电影道具' },
            { value: 'serial_killer_slasher', text: '洛圣都杀人狂' },
            { value: 'maude_bounty_targets', text: '茉德悬赏目标' },
            { value: 'media_sticks', text: '媒体记忆棒' },
            { value: 'stash_houses', text: '藏匿屋' },
            { value: 'madrazo_hits', text: '玛德拉索雇凶' },
            { value: 'police_rescue_patrick_mcreary', text: '帕特里克救援', icon: './src/assets/patrick.svg' },
            { value: 'random_missions', text: '🎲 随机任务', icon: './src/assets/random.svg' },
            { value: 'drug_vehicle', text: '🚗 毒品载具', icon: './src/assets/drug_vehicle.svg' },
            { value: 'drunk_guard', text: '🛌 沉睡的保安', icon: './src/assets/drunk_guard.svg' },
            { value: 'metal_detector', text: '🧭 金属探测器', icon: './src/assets/metal.svg' },
            { value: 'smuggler_plane', text: '✈️ 走私贩飞机', icon: './src/assets/smuggler_plane.svg' }
        ];
        const loader = document.getElementById('loader');
        const tilePaneDom = document.getElementById('tile-pane');
        const fileStatus = document.getElementById('file-status');
        const itemInfo = document.getElementById('item-info');

        let currentStyle = styleSelect.value;
    let currentItemType = '';
    // 支持同时显示多个物品类型
    let activeItemTypes = new Set();
    // 存储每个标记对象：{type, index, el}
    let itemMarkers = [];

        // --- 地图初始化 ---
        function getLevelByZoom(z) {
            return zoomLevels.find(l => l.zoom === z);
        }
        function totalSizeForZoom(z) {
            const level = getLevelByZoom(z);
            if (!level) return { width: 0, height: 0 };
            return { width: level.cols * TILE_SIZE, height: level.rows * TILE_SIZE };
        }

        const errorTileSVG = encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}">` +
            `<rect width="100%" height="100%" fill="#1a1a1a"/></svg>`
        );
        const errorTileDataUrl = `data:image/svg+xml;charset=UTF-8,${errorTileSVG}`;

        const initialZoom = zoomLevels[0].zoom;
        const initialSize = totalSizeForZoom(initialZoom);
        const initialCenterPoint = L.point(initialSize.width / 2, initialSize.height / 2);

        const map = L.map('map-container', {
            crs: L.CRS.Simple,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true
        });

        function resetViewForZoom(z, centerPixel) {
            const size = totalSizeForZoom(z);
            if (size.width === 0) return;

            // 对于小缩放级别3和4，强制使用地图中心
            let centerPoint;
            if (z === 3 || z === 4) {
                centerPoint = L.point(size.width / 2, size.height / 2);
            } else {
                centerPoint = centerPixel ? L.point(centerPixel.x, centerPixel.y) : L.point(size.width / 2, size.height / 2);
            }
            
            const centerLatLng = map.unproject(centerPoint, z);

            const southWest = map.unproject(L.point(0, size.height), z);
            const northEast = map.unproject(L.point(size.width, 0), z);
            const bounds = new L.LatLngBounds(southWest, northEast);

            map.setMaxBounds(bounds);
            
            // 对于小缩放级别3和4，确保地图完全居中
            if (z === 3 || z === 4) {
                map.setView(centerLatLng, z, { animate: false });
                // 强制重新定位到中心
                setTimeout(() => {
                    map.panTo(centerLatLng, { animate: false });
                }, 50);
            } else {
                map.setView(centerLatLng, z, { animate: false });
            }

            tilePaneDom.style.width = size.width + 'px';
            tilePaneDom.style.height = size.height + 'px';
        }

        resetViewForZoom(initialZoom);

        // 根据当前样式获取错误瓦片的纯色背景
        function getErrorTileUrl(style) {
            // 提取样式名称（从URL中获取最后一部分）
            let styleName = 'game'; // 默认样式
            if (style.includes('game')) {
                styleName = 'game';
            } else if (style.includes('render')) {
                styleName = 'render';
            } else if (style.includes('print')) {
                styleName = 'print';
            }
            
            // 不同地图样式对应的RGB颜色值
            const colors = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            // 获取当前样式对应的颜色，如果没有则使用默认颜色
            const color = colors[styleName] || '#1a1a1a';
            
            // 返回纯色背景的SVG数据URL
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">' +
                '<rect width="100%" height="100%" fill="' + color + '"/>' +
                '</svg>'
            );
        }

        const CustomTileLayer = L.TileLayer.extend({
            getTileUrl: function(coords) {
                return `${currentStyle}/${coords.z}/${coords.x}_${coords.y}.jpg`;
            }
        });

        const tileLayer = new CustomTileLayer('', {
            tileSize: TILE_SIZE,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            noWrap: true,
            subdomains: [],
            errorTileUrl: getErrorTileUrl(currentStyle)
        });

        tileLayer.on('loading', () => loader.classList.add('visible'));
        tileLayer.on('load', () => loader.classList.remove('visible'));
        tileLayer.on('tileerror', (err) => {
            loader.classList.remove('visible');
        });

        tileLayer.addTo(map);

        // 样式选择事件
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            // 更新错误瓦片URL以匹配新样式
            tileLayer.options.errorTileUrl = getErrorTileUrl(currentStyle);
            tileLayer.redraw();
        });

        // --- 物品标记功能 ---
        function updateTilePanePosition() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;

            const bounds = map.getBounds();
            const topLeftLatLng = bounds.getNorthWest();
            const topLeftPoint = map.project(topLeftLatLng, z);
            
            const size = totalSizeForZoom(z);
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            
            // 计算基础偏移量
            let translateX = -topLeftPoint.x;
            let translateY = -topLeftPoint.y;
            // 移除额外的居中偏移，避免在地图尺寸小于容器时重复居中导致偏差

            tilePaneDom.style.transform = `translate(${Math.round(translateX)}px, ${Math.round(translateY)}px)`;
            updateOriginMarker();
            updateItemMarkersPosition(); // 更新标记位置而不是重新创建
            updateDealershipMarkers(); // 更新车行标记位置
        }

        function updateOriginMarker() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            const percentX = (0 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
            const percentY = (GAME_TOP - 0) / (GAME_TOP - GAME_BOTTOM);

            const originX = percentX * totalWidth;
            const originY = percentY * totalHeight;
            // Origin marker display removed by design. If needed later,
            // position can be computed here without creating DOM elements.
        }

        // 加载物品数据
        async function loadItemData() {
            try {
                const response = await fetch('./src/data/zones.json');
                const data = await response.json();
                
                // 将数据复制到itemData对象
                Object.keys(itemData).forEach(key => {
                    if (data[key]) {
                        if (key === 'ghosts3') {
                            try {
                                // ghosts3 为嵌套数组结构： [ [ [x,y,[label],[time,day,idx]], ... ], [ ... ] ...]
                                // 将其拍平成统一结构：{x, y, time}
                                itemData[key] = [];
                                data[key].forEach(group => {
                                    if (Array.isArray(group)) {
                                        group.forEach(item => {
                                            if (Array.isArray(item) && item.length >= 4) {
                                                const x = item[0];
                                                const y = item[1];
                                                const timeInfo = item[3];
                                                const time = Array.isArray(timeInfo) && timeInfo.length > 0 ? String(timeInfo[0]) : '';
                                                itemData[key].push({ x, y, time });
                                            }
                                        });
                                    }
                                });
                            } catch (err) {
                                console.error('解析ghosts3数据失败:', err);
                                itemData[key] = [];
                            }
                        } else {
                            itemData[key] = data[key];
                        }
                    }
                });

                // 显式覆盖：metal_detector 来自 data（一次）
                try {
                    if (Array.isArray(data.metal_detector)) {
                        itemData.metal_detector = data.metal_detector.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `金属探测器 ${index + 1}`
                        }));
                    }
                } catch (e) {}

                // 单独处理 treasure_hunt_dba_revolver 结构
                if (data.treasure_hunt_dba_revolver) {
                    try {
                        const th = data.treasure_hunt_dba_revolver;
                        const rc = Array.isArray(th.random_clue) ? th.random_clue : [];
                        const sc = Array.isArray(th.static_clues) ? th.static_clues : [];
                        itemData.treasure_hunt_dba_revolver = {
                            random_clue: rc.map(p => ({ x: p[0], y: p[1] })),
                            static_clues: sc.map(p => ({ x: p[0], y: p[1] }))
                        };
                    } catch (e) {
                        console.error('解析treasure_hunt_dba_revolver失败', e);
                        itemData.treasure_hunt_dba_revolver = { random_clue: [], static_clues: [] };
                    }
                }
                
                // 加载所有物品数据（从zones.json）
                try {
                    const cardsResponse = await fetch('./src/data/zones.json');
                    const cardsData = await cardsResponse.json();
                    
                    // 加载playing_cards数据
                    if (cardsData.playing_cards) {
                        itemData.playing_cards = cardsData.playing_cards.map(card => ({
                            x: card[0],
                            y: card[1],
                            name: card[2] || '纸牌位置'
                        }));
                        console.log('纸牌位置数据加载成功，共', itemData.playing_cards.length, '个位置');
                    }
                    
                    // 加载其他物品数据
                    const itemTypes = [
                        'smoke_on_the_water_product',
                        'action_figures', 
                        'yuanbao',
                        'ld_organics_products',
                        'signal_jammers',
                        'jack_o_lanterns',
                        'payphone_hits',
                        'golf_holes',
                        'snowmen',
                        'spray',
                        // 杀人狂单独加载，不走通用分支
                    ];
                    
                    itemTypes.forEach(type => {
                        try {
                            // 特殊：杀人狂（从嵌套对象加载）
                            if (type === 'serial_killer_slasher_first' || type === 'serial_killer_slasher_last') {
                                // 跳过（我们不再把这两个伪类型放在通用数组里）
                            } else if (cardsData[type]) {
                                // 处理action_figures的特殊嵌套结构
                                if (type === 'action_figures' && cardsData[type].regular) {
                                    // 合并regular和last_two数组
                                    const regularItems = cardsData[type].regular || [];
                                    const lastTwoItems = cardsData[type].last_two || [];
                                    itemData[type] = [...regularItems, ...lastTwoItems].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else if (Array.isArray(cardsData[type])) {
                                    // 只对数组类型调用map方法
                                    itemData[type] = cardsData[type].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else {
                                    itemData[type] = [];
                                }
                                console.log(`${type}数据加载成功，共${itemData[type].length}个位置`);
                            }
                        } catch (error) {
                            console.error(`加载${type}数据失败`);
                            itemData[type] = []; // 提供默认值，避免后续错误
                        }
                    });

                    // 单独加载：洛圣都杀人狂（from zones.json.serial_killer_slasher）
                    try {
                        if (cardsData.serial_killer_slasher) {
                            const f = cardsData.serial_killer_slasher.first || [];
                            const l = cardsData.serial_killer_slasher.last || [];
                            itemData.serial_killer_slasher.first = f.map((p, i) => ({ x: p[0], y: p[1], name: `杀人狂线索 ${i+1}` }));
                            itemData.serial_killer_slasher.last = l.map((p, i) => ({ x: p[0], y: p[1], name: `杀人狂最终 ${i+1}` }));
                            console.log('serial_killer_slasher 数据加载成功：', itemData.serial_killer_slasher.first.length, itemData.serial_killer_slasher.last.length);
                        }
                    } catch (e) {
                        console.error('加载 serial_killer_slasher 失败', e);
                        itemData.serial_killer_slasher.first = [];
                        itemData.serial_killer_slasher.last = [];
                    }
                    
                    // 单独加载：茉德悬赏目标（from zones.json.maude_bounty_targets）
                    try {
                        if (cardsData.maude_bounty_targets) {
                            const areas = cardsData.maude_bounty_targets.areas || [];
                            const endpoints = cardsData.maude_bounty_targets.endpoints || [];
                            itemData.maude_bounty_targets.areas = areas.map((p, i) => ({ x: p[0], y: p[1], name: `悬赏区域 ${i+1}` }));
                            itemData.maude_bounty_targets.endpoints = endpoints.map((p, i) => ({ x: p[0], y: p[1], name: `悬赏终点 ${i+1}` }));
                            console.log('maude_bounty_targets 数据加载成功：', itemData.maude_bounty_targets.areas.length, '个区域，', itemData.maude_bounty_targets.endpoints.length, '个终点');
                        }
                    } catch (e) {
                        console.error('加载 maude_bounty_targets 失败', e);
                        itemData.maude_bounty_targets.areas = [];
                        itemData.maude_bounty_targets.endpoints = [];
                    }
                    
                    // 单独加载：媒体记忆棒（from zones.json.media_sticks）
                    try {
                        if (cardsData.media_sticks) {
                            itemData.media_sticks = cardsData.media_sticks.map((item, i) => ({
                                x: item[0],
                                y: item[1],
                                name: item[2] || `媒体记忆棒 ${i+1}`,
                                label: item[2] || `media_stick_${i+1}` // 保存标签信息用于弹窗匹配
                            }));
                            console.log('media_sticks 数据加载成功：', itemData.media_sticks.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 media_sticks 失败', e);
                        itemData.media_sticks = [];
                    }
                    
                    // 单独加载：藏匿屋（from zones.json.stash_houses）
                    try {
                        if (cardsData.stash_houses) {
                            itemData.stash_houses = cardsData.stash_houses.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `藏匿屋 ${i+1}`
                            }));
                            console.log('stash_houses 数据加载成功：', itemData.stash_houses.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 stash_houses 失败', e);
                        itemData.stash_houses = [];
                    }
                    
                    // 单独加载：玛德拉索雇凶（from zones.json.madrazo_hits）
                    try {
                        if (cardsData.madrazo_hits) {
                            itemData.madrazo_hits = cardsData.madrazo_hits.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `玛德拉索雇凶 ${i+1}`
                            }));
                            console.log('madrazo_hits 数据加载成功：', itemData.madrazo_hits.length, '个位置');
                        }
                    } catch (e) {
                        console.error('加载 madrazo_hits 失败', e);
                        itemData.madrazo_hits = [];
                    }
                    
                    // 确保stunt_jumps数据被加载
                    try {
                        if (cardsData && cardsData.stunt_jumps) {
                            // 转换为需要的格式
                            itemData.stunt_jumps = cardsData.stunt_jumps.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `特技跳跃点 ${index + 1}`
                            }));
                            console.log(`stunt_jumps数据加载成功，共${itemData.stunt_jumps.length}个位置`);
                        } else {
                            console.error('加载stunt_jumps数据失败：未找到数据');
                            itemData.stunt_jumps = [];
                        }
                    } catch (error) {
                        console.error('加载stunt_jumps数据失败');
                        itemData.stunt_jumps = [];
                    }
                     
                    // 确保spray数据被加载
                    try {
                        if (cardsData && cardsData.spray_can) {
                            // 转换为需要的格式
                            itemData.spray = cardsData.spray_can.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `喷罐位置 ${index + 1}`
                            }));
                            console.log(`spray数据加载成功，共${itemData.spray.length}个位置`);
                        } else {
                            console.error('加载spray数据失败：未找到数据');
                            itemData.spray = [];
                        }
                    } catch (error) {
                        console.error('加载spray数据失败');
                        itemData.spray = [];
                    }
                    
                    // 额外加载：沉睡的保安（drunk_guard）
                    try {
                        if (cardsData && Array.isArray(cardsData.drunk_guard)) {
                            itemData.drunk_guard = cardsData.drunk_guard.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `沉睡的保安 ${index + 1}`
                            }));
                            console.log(`drunk_guard 数据加载成功，共${itemData.drunk_guard.length}个位置`);
                        }
                    } catch (error) {
                        console.error('加载drunk_guard数据失败');
                        itemData.drunk_guard = [];
                    }
                    
                    // 额外加载：金属探测器（metal_detector）
                    try {
                        if (cardsData && Array.isArray(cardsData.metal_detector)) {
                            itemData.metal_detector = cardsData.metal_detector.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `金属探测器 ${index + 1}`
                            }));
                            console.log(`metal_detector 数据加载成功（二次加载覆盖）：${itemData.metal_detector.length} 个位置`);
                        }
                    } catch (error) {
                        console.error('加载metal_detector数据失败');
                        itemData.metal_detector = [];
                    }

                    // 额外加载：走私贩飞机（smuggler_plane）
                    try {
                        if (cardsData && Array.isArray(cardsData.smuggler_plane)) {
                            itemData.smuggler_plane = cardsData.smuggler_plane.map((group, index) => ({
                                triggerpoint: group.triggerpoint,
                                routes: group.routes
                            }));
                            console.log(`smuggler_plane 数据加载成功：${itemData.smuggler_plane.length} 组`);
                        }
                    } catch (error) {
                        console.error('加载smuggler_plane数据失败');
                        itemData.smuggler_plane = [];
                    }
                    
                    // 单独加载dead_drop数据（从zones.json）
                    try {
                        // 检查data是否存在且包含dead_drop数据
                        if (data && Array.isArray(data.dead_drop)) {
                            // 转换为需要的格式
                            itemData.dead_drop = data.dead_drop.map(item => ({
                                x: item.x,
                                y: item.y,
                                name: item.name || 'Dead Drop'
                            }));
                            console.log(`dead_drop数据加载成功，共${itemData.dead_drop.length}个位置`);
                        } else {
                            console.error('加载dead_drop数据失败：未找到数据');
                            itemData.dead_drop = [];
                        }
                    } catch (error) {
                        console.error('加载dead_drop数据失败');
                        itemData.dead_drop = [];
                    }
                    
                    // 加载电影道具数据
                    try {
                        if (cardsData.movie_props) {
                            const mp = cardsData.movie_props;
                            
                            // 加载固定位置
                            if (mp.fixed_position && Array.isArray(mp.fixed_position)) {
                                itemData.movie_props.fixed_position = mp.fixed_position.map(item => ({
                                    x: item[0],
                                    y: item[1],
                                    name: item[2] || '固定位置',
                                    type: 'fixed_position'
                                }));
                            }
                            
                            // 加载载具位置
                            if (mp.vehicles) {
                                if (mp.vehicles.pony && Array.isArray(mp.vehicles.pony)) {
                                    itemData.movie_props.vehicles.pony = mp.vehicles.pony.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Pony载具',
                                        type: 'pony'
                                    }));
                                }
                                if (mp.vehicles.rebel && Array.isArray(mp.vehicles.rebel)) {
                                    itemData.movie_props.vehicles.rebel = mp.vehicles.rebel.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rebel载具',
                                        type: 'rebel'
                                    }));
                                }
                                if (mp.vehicles.rumpo && Array.isArray(mp.vehicles.rumpo)) {
                                    itemData.movie_props.vehicles.rumpo = mp.vehicles.rumpo.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rumpo载具',
                                        type: 'rumpo'
                                    }));
                                }
                            }
                            
                            console.log('电影道具数据加载成功');
                            console.log('固定位置:', itemData.movie_props.fixed_position.length);
                            console.log('Pony载具:', itemData.movie_props.vehicles.pony.length);
                            console.log('Rebel载具:', itemData.movie_props.vehicles.rebel.length);
                            console.log('Rumpo载具:', itemData.movie_props.vehicles.rumpo.length);
                        } else {
                            console.error('加载电影道具数据失败：未找到数据');
                        }
                    } catch (error) {
                        console.error('加载电影道具数据失败:', error);
                    }
                    
                } catch (cardsError) {
                    console.warn('加载物品位置数据失败:', cardsError);
                    console.log('尝试加载的URL:', './src/data/zones.json');
                }
                
                // 动态计算武器厢型车位置
                await updateGunVanLocation();
                
                // 动态获取街头毒贩位置
                await updateStreetDealersLocation();
                
                // 动态获取LS涂鸦位置
                await updateLSTagsLocation();
                
                // 动态获取隐藏包裹位置
                await updateHiddenCachesLocation();
                
                // 动态获取沉船位置
                await updateShipwreckedLocation();
                
                // 动态获取时间挑战赛位置
                await updateTimeTrialsLocation();
                
                // 动态获取跳伞位置
                await updateSkydivesLocation();
                
                console.log('物品数据加载成功');
            } catch (error) {
                console.error('加载物品数据失败:', error);
            }
        }

        // 动态获取街头毒贩位置
        async function updateStreetDealersLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/street-dealers');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的街头毒贩坐标数据
                    itemData.street_dealers = result.data.coordinate;
                    console.log('街头毒贩位置获取成功');
                } else {
                    console.warn('街头毒贩API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取街头毒贩位置失败，使用静态数据:', error);
            }
        }

        // 动态获取LS涂鸦位置（通过API获取当天位置）
        async function updateLSTagsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/ls-tags');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的LS涂鸦坐标数据
                    itemData.ls_tags = result.data.coordinate;
                    
                    // 从message字段中提取涂鸦编号并添加到每个tag对象中
                    if (result.data.message) {
                        const message = result.data.message;
                        const tagInfoRegex = /#(\d+)\s+(\S+)/g;
                        const tagInfoMap = new Map();
                        let match;
                        
                        // 提取所有涂鸦编号和名称的匹配
                        while ((match = tagInfoRegex.exec(message)) !== null) {
                            const sequenceNumber = parseInt(match[1]);
                            const locationName = match[2];
                            tagInfoMap.set(locationName, sequenceNumber);
                        }
                        
                        // 将编号添加到每个tag对象中
                        itemData.ls_tags.forEach(tag => {
                            // 尝试匹配tag的name中的最后一个词作为位置名称
                            if (tag.name) {
                                const tagNameWords = tag.name.split(' ');
                                const lastWord = tagNameWords[tagNameWords.length - 1];
                                
                                // 查找匹配的编号
                                for (const [locationName, sequenceNumber] of tagInfoMap.entries()) {
                                    if (tag.name.includes(locationName) || locationName.includes(lastWord)) {
                                        tag.sequenceNumber = sequenceNumber;
                                        break;
                                    }
                                }
                            }
                        });
                        
                        console.log('LS涂鸦编号信息提取成功', itemData.ls_tags);
                    }
                    
                    console.log('LS涂鸦位置获取成功');
                } else {
                    console.warn('LS涂鸦API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取LS涂鸦位置失败，使用静态数据:', error);
            }
        }

        // 动态获取隐藏包裹位置（通过API获取当天位置）
        async function updateHiddenCachesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/hidden-caches');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的隐藏包裹坐标数据
                    itemData.hidden_caches = result.data.coordinate;
                    console.log('隐藏包裹位置获取成功');
                } else {
                    console.warn('隐藏包裹API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取隐藏包裹位置失败，使用静态数据:', error);
            }
        }

        // 动态获取沉船位置（通过API获取当天位置）
        async function updateShipwreckedLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/shipwrecked');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的沉船坐标数据
                    itemData.shipwrecked = result.data.coordinate;
                    // 保存API返回的消息用于提取沉船编号
                    itemData.shipwreckedMessage = result.data.message;
                    console.log('沉船位置获取成功');
                } else {
                    console.warn('沉船API返回数据格式异常，使用静态数据');
                }
            } catch (error) {
                console.warn('获取沉船位置失败，使用静态数据:', error);
            }
        }

        // 动态获取时间挑战赛位置（通过API获取当天位置）
        async function updateTimeTrialsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/time-trials');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的时间挑战赛坐标数据
                    const { rc_time_trial, bike_time_trial } = result.data.coordinate;
                    
                    // 设置RC时间挑战赛数据（仅一个位置）
                    if (rc_time_trial) {
                        itemData.rc_time_trial = [{
                            x: rc_time_trial.x,
                            y: rc_time_trial.y,
                            name: rc_time_trial.name,
                            time: rc_time_trial.time
                        }];
                        console.log('RC时间挑战赛位置获取成功');
                    } else {
                        itemData.rc_time_trial = [];
                    }
                    
                    // 设置自行车时间挑战赛数据（仅一个位置）
                    if (bike_time_trial) {
                        itemData.bike_time_trial = [{
                            x: bike_time_trial.x,
                            y: bike_time_trial.y,
                            name: bike_time_trial.name,
                            time: bike_time_trial.time
                        }];
                        console.log('自行车时间挑战赛位置获取成功');
                    } else {
                        itemData.bike_time_trial = [];
                    }
                    
                    // 保存API返回的消息用于显示
                    itemData.timeTrialsMessage = result.data.message;
                    
                } else {
                    console.warn('时间挑战赛API返回数据格式异常，使用静态数据');
                    itemData.rc_time_trial = [];
                    itemData.bike_time_trial = [];
                }
            } catch (error) {
                console.warn('获取时间挑战赛位置失败，使用静态数据:', error);
                itemData.rc_time_trial = [];
                itemData.bike_time_trial = [];
            }
        }

        // 动态获取跳伞位置（通过API获取当天位置）
        async function updateSkydivesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/skydives');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // 使用API返回的跳伞坐标数据
                    itemData.skydives = result.data.coordinate;
                    console.log('跳伞位置获取成功');
                } else {
                    console.warn('跳伞API返回数据格式异常，使用静态数据');
                    // 使用zones.json中的静态数据作为备用
                    const zonesResponse = await fetch('./src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                }
            } catch (error) {
                console.warn('获取跳伞位置失败，使用静态数据:', error);
                try {
                    // 使用zones.json中的静态数据作为备用
                    const zonesResponse = await fetch('./src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                } catch (fallbackError) {
                    console.error('加载静态跳伞数据也失败:', fallbackError);
                    itemData.skydives = [];
                }
            }
        }



        // 动态计算武器厢型车位置
        async function updateGunVanLocation() {
            const currentDay = Math.floor(Date.now() / 86400000); // 每天变化
            
            if (gunVanLastUpdate !== currentDay) {
                gunVanLastUpdate = currentDay;
                
                // 模拟游戏中的随机数生成逻辑
                const seed = getSeedValue();
                const location = getRandomGunVanLocation(seed);
                
                // 只保留当天的位置
                if (itemData.gun_van && itemData.gun_van.length > 0) {
                    itemData.gun_van = [itemData.gun_van[location]];
                }
                
                console.log(`武器厢型车今日位置: ${location + 1}`);
            }
        }

        // 模拟游戏中的种子值计算
        function getSeedValue() {
            const cloudTime = BigInt(Math.floor(Date.now() / 1000));
            return (cloudTime - 21600n) / 86400n;
        }

        // 模拟游戏中的随机位置选择（使用正确的RNG算法）
        function getRandomGunVanLocation(seed) {
            const DISABLED_LOCATION = 4;
            
            // 使用游戏中的随机数生成算法
            class GameRNG {
                constructor(seed) {
                    this.mask = (2n ** 32n - 1n);
                    this.magicNumber = 1557985959n;
                    const rolval = ((seed << 16n) & this.mask) | ((seed >> 16n) & this.mask);
                    this.seed0 = seed || 1n;
                    this.seed1 = seed ^ rolval;
                }
                
                nextSeed() {
                    const next_seed = this.magicNumber * this.seed0 + this.seed1;
                    this.seed0 = next_seed & BigInt(0xFFFFFFFF);
                    this.seed1 = next_seed >> 32n;
                    return next_seed;
                }
                
                getRandomInt(min, max) {
                    if (min === max) return Number(min);
                    if (min >= max) return 0;
                    const next_seed = this.nextSeed();
                    return Number(min + (next_seed & BigInt(0x7FFFFFFF)) % (max - min + 1n));
                }
            }
            
            const rng = new GameRNG(seed);
            let location = rng.getRandomInt(0n, 29n);
            
            // 跳过禁用位置
            while (location === DISABLED_LOCATION) {
                location = rng.getRandomInt(0n, 29n);
            }
            
            return location;
        }

        // 创建物品标记
        function createItemMarker(item, index, type) {
            // 创建标记元素
            const marker = document.createElement('div');
            marker.className = 'item-marker';
            marker.dataset.index = index;
            marker.dataset.type = type;
            
            // 特殊处理帮派攻击 - 创建红色圆圈
            if (type === 'gang_attacks') {
                // 检查时间是否匹配
                if (!isGangAttackActive(item.time)) {
                    return null; // 不在时间范围内，不显示
                }
                
                // 获取当前缩放等级来计算圆圈大小
                const z = map.getZoom();
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const totalHeight = level.rows * TILE_SIZE;
                
                // 计算游戏坐标100单位对应的像素大小
                const gameRadius = 100; // 游戏坐标半径
                const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                const circleSize = pixelRadius * 2; // 直径
                
                console.log('帮派攻击圆圈大小计算:', {
                    gameRadius,
                    gameWidth,
                    totalWidth,
                    pixelRadius,
                    circleSize
                });
                
                // 创建红色圆圈
                marker.style.width = `${circleSize}px`;
                marker.style.height = `${circleSize}px`;
                marker.style.borderRadius = '50%';
                marker.style.border = '3px solid #ff0000';
                marker.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
                marker.style.position = 'absolute';
                marker.style.transform = 'translate(-50%, -50%)';
                marker.style.cursor = 'pointer';
                marker.style.pointerEvents = 'all';
                
                // 添加中心图标
                const img = document.createElement('img');
                img.src = itemIcons[type];
                img.style.width = '32px';
                img.style.height = '32px';
                img.style.position = 'absolute';
                img.style.top = '50%';
                img.style.left = '50%';
                img.style.transform = 'translate(-50%, -50%)';
                marker.appendChild(img);
            } else if (type === 'ghosts3') {
                // 幽灵曝光：最后一个用 ge252.svg，其余 ge251.svg
                const isLast = index === (itemData[type]?.length ?? 0) - 1;
                const img = document.createElement('img');
                img.src = isLast ? './src/assets/ge252.svg' : './src/assets/ge251.svg';
                img.style.width = '32px';
                img.style.height = '32px';
                marker.appendChild(img);

                // 在下方添加时间标签
                const timeLabel = document.createElement('div');
                timeLabel.style.position = 'absolute';
                timeLabel.style.bottom = '-20px';
                timeLabel.style.left = '50%';
                timeLabel.style.transform = 'translateX(-50%)';
                timeLabel.style.background = 'rgba(0, 0, 0, 0.8)';
                timeLabel.style.color = 'white';
                timeLabel.style.padding = '2px 6px';
                timeLabel.style.borderRadius = '4px';
                timeLabel.style.fontSize = '10px';
                timeLabel.style.whiteSpace = 'nowrap';
                timeLabel.style.pointerEvents = 'none';
                timeLabel.textContent = item.time || '未知时间';
                marker.appendChild(timeLabel);
            } else if (type === 'treasure_hunt_dba_revolver_random') {
                // 寻宝-随机线索: th1.svg
                const img = document.createElement('img');
                img.src = './src/assets/th1.svg';
                img.style.width = '28px';
                img.style.height = '28px';
                marker.appendChild(img);
            } else if (type === 'treasure_hunt_dba_revolver_static') {
                // 寻宝-固定线索: th2.svg
                const img = document.createElement('img');
                img.src = './src/assets/th2.svg';
                img.style.width = '28px';
                img.style.height = '28px';
                marker.appendChild(img);
            } else if (type === 'serial_killer_slasher_first') {
                // 杀人狂前四条线索：slasher.svg
                const img = document.createElement('img');
                img.src = './src/assets/slasher.svg';
                img.style.width = '32px';
                img.style.height = '32px';
                marker.appendChild(img);
            } else if (type === 'serial_killer_slasher_last') {
                // 杀人狂最后一条线索：slasher2.svg
                const img = document.createElement('img');
                img.src = './src/assets/slasher2.svg';
                img.style.width = '32px';
                img.style.height = '32px';
                marker.appendChild(img);
            } else if (type === 'movie_props') {
                // 电影道具：根据子类型选择不同图标
                const img = document.createElement('img');
                let iconSrc = './src/assets/mp_static.svg'; // 默认图标
                
                if (item.type === 'fixed_position') {
                    iconSrc = './src/assets/mp_static.svg';
                } else if (item.type === 'pony') {
                    iconSrc = './src/assets/mp_pony.svg';
                } else if (item.type === 'rebel') {
                    iconSrc = './src/assets/mp_rebel.svg';
                } else if (item.type === 'rumpo') {
                    iconSrc = './src/assets/mp_rumpo.svg';
                }
                
                img.src = iconSrc;
                img.style.width = '32px';
                img.style.height = '32px';
                marker.appendChild(img);
            } else {
                // 普通标记处理
                const img = document.createElement('img');
                img.src = itemIcons[type];
                img.style.width = '32px';
                img.style.height = '32px';
                marker.appendChild(img);
            }
            
            // 添加点击事件：使用标记自身的 type/index
            L.DomEvent.on(marker, 'click', function(e) {
                const t = marker.dataset.type;
                const idx = parseInt(marker.dataset.index, 10);
                let it;
                
                // 特殊处理杀人狂标记的数据获取
                if (t === 'serial_killer_slasher_first') {
                    it = itemData.serial_killer_slasher && itemData.serial_killer_slasher.first && itemData.serial_killer_slasher.first[idx];
                } else if (t === 'serial_killer_slasher_last') {
                    it = itemData.serial_killer_slasher && itemData.serial_killer_slasher.last && itemData.serial_killer_slasher.last[idx];
                } else {
                    it = (itemData[t] && itemData[t][idx]) ? itemData[t][idx] : item;
                }
                
                if (!it) return;
                // 委托给 showItemInfo 处理图片/大弹窗逻辑
                showItemInfo(it, t, idx);
            });
            
            return marker;
        }

        // 更新物品标记位置
        function updateItemMarkers() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // 清除现有 DOM 标记
            itemMarkers.forEach(m => m.el.remove());
            itemMarkers = [];

            // 为每个激活的类型创建标记
            activeItemTypes.forEach(type => {
                // 跳过有特殊渲染逻辑的类型
                if (type === 'media_sticks' || type === 'maude_bounty_targets' || type === 'serial_killer_slasher' || type === 'movie_props' || type === 'treasure_hunt_dba_revolver' || type === 'stash_houses' || type === 'madrazo_hits' || type === 'police_rescue_patrick_mcreary' || type === 'random_missions' || type === 'drug_vehicle' || type === 'smuggler_plane') return;
                
                if (!itemData[type] || !Array.isArray(itemData[type])) return;
                itemData[type].forEach((item, index) => {
                    if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;

                    const percentX = (item.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - item.y) / (GAME_TOP - GAME_BOTTOM);

                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;

                    const markerEl = createItemMarker(item, index, type);
                    if (markerEl) { // 检查是否创建成功（帮派攻击可能返回null）
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        tilePaneDom.appendChild(markerEl);
                        itemMarkers.push({ type, index, el: markerEl });
                    }
                });
            });

            // 特殊：左轮寻宝两个子类型分别渲染
            if (activeItemTypes.has('treasure_hunt_dba_revolver')) {
                const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
                const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
                const renderList = [
                    ...rc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_random', __index: i })),
                    ...sc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_static', __index: i }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        tilePaneDom.appendChild(markerEl);
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 特殊：洛圣都杀人狂两个子类型一起渲染（合并为一个选项）
            if (activeItemTypes.has('serial_killer_slasher')) {
                const first = (itemData.serial_killer_slasher.first || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_first', __index:i }));
                const last = (itemData.serial_killer_slasher.last || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_last', __index:i }));
                const renderList = [...first, ...last];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        tilePaneDom.appendChild(markerEl);
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 特殊：电影道具多个子类型分别渲染
            if (activeItemTypes.has('movie_props')) {
                const mp = itemData.movie_props;
                const renderList = [
                    ...(mp.fixed_position || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i })),
                    ...(mp.vehicles?.pony || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) })),
                    ...(mp.vehicles?.rebel || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) })),
                    ...(mp.vehicles?.rumpo || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) + (mp.vehicles?.rebel?.length || 0) }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        tilePaneDom.appendChild(markerEl);
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // 特殊：茉德悬赏目标渲染（黄色圆圈和黄色小叉号）
            if (activeItemTypes.has('maude_bounty_targets')) {
                const mb = itemData.maude_bounty_targets;
                
                // 渲染悬赏区域（黄色圆圈，半径185）
                if (mb.areas) {
                    mb.areas.forEach((area, index) => {
                        if (typeof area.x === 'undefined' || typeof area.y === 'undefined') return;
                        const percentX = (area.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - area.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建黄色圆圈
                        const circle = document.createElement('div');
                        circle.className = 'item-marker maude-area-circle';
                        circle.dataset.type = 'maude_bounty_area';
                        circle.dataset.index = index;
                        circle.style.position = 'absolute';
                        circle.style.left = `${itemX}px`;
                        circle.style.top = `${itemY}px`;
                        
                        // 计算游戏坐标185对应的像素大小
                        const gameRadius = 185; // 游戏坐标半径
                        const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                        const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                        const circleSize = pixelRadius * 2; // 直径
                        
                        circle.style.width = `${circleSize}px`;
                        circle.style.height = `${circleSize}px`;
                        circle.style.border = '3px solid #FFD700';
                        circle.style.borderRadius = '50%';
                        circle.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
                        circle.style.transform = 'translate(-50%, -50%)';
                        circle.style.cursor = 'pointer';
                        circle.style.zIndex = '650';
                        
                        // 添加点击事件
                        circle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showMaudeBountyPopup(area, index, 'area');
                        });
                        
                        tilePaneDom.appendChild(circle);
                        itemMarkers.push({ type: 'maude_bounty_area', index: index, el: circle });
                    });
                }
                
                // 渲染悬赏终点（黄色小叉号）
                if (mb.endpoints) {
                    mb.endpoints.forEach((endpoint, index) => {
                        if (typeof endpoint.x === 'undefined' || typeof endpoint.y === 'undefined') return;
                        const percentX = (endpoint.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - endpoint.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建黄色小叉号
                        const cross = document.createElement('div');
                        cross.className = 'item-marker maude-endpoint-cross';
                        cross.dataset.type = 'maude_bounty_endpoint';
                        cross.dataset.index = index;
                        cross.style.position = 'absolute';
                        cross.style.left = `${itemX}px`;
                        cross.style.top = `${itemY}px`;
                        cross.style.width = '20px';
                        cross.style.height = '20px';
                        cross.style.transform = 'translate(-50%, -50%)';
                        cross.style.cursor = 'pointer';
                        cross.style.zIndex = '660';
                        
                        // 创建叉号样式
                        cross.innerHTML = `
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: #FFD700; transform: translateY(-50%) rotate(45deg);"></div>
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: #FFD700; transform: translateY(-50%) rotate(-45deg);"></div>
                        `;
                        
                        // 添加点击事件
                        cross.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showMaudeBountyPopup(endpoint, index, 'endpoint');
                        });
                        
                        tilePaneDom.appendChild(cross);
                        itemMarkers.push({ type: 'maude_bounty_endpoint', index: index, el: cross });
                    });
                }
            }

            // 特殊：媒体记忆棒渲染（图标+文字标签）
            if (activeItemTypes.has('media_sticks')) {
                const mediaSticks = itemData.media_sticks || [];
                mediaSticks.forEach((stick, index) => {
                    if (typeof stick.x === 'undefined' || typeof stick.y === 'undefined') return;
                    const percentX = (stick.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - stick.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    
                    // 创建媒体记忆棒标记
                    const marker = document.createElement('div');
                    marker.className = 'item-marker media-stick-marker';
                    marker.dataset.type = 'media_sticks';
                    marker.dataset.index = index;
                    marker.style.position = 'absolute';
                    marker.style.left = `${itemX}px`;
                    marker.style.top = `${itemY}px`;
                    marker.style.transform = 'translate(-50%, -50%)';
                    marker.style.cursor = 'pointer';
                    marker.style.zIndex = '670';
                    marker.style.display = 'flex';
                    marker.style.flexDirection = 'column';
                    marker.style.alignItems = 'center';
                    marker.style.gap = '2px';
                    
                    // 创建图标
                    const img = document.createElement('img');
                    img.src = './src/assets/media.svg';
                    img.style.width = '32px';
                    img.style.height = '32px';
                    marker.appendChild(img);
                    
                    // 创建文字标签
                    const label = document.createElement('div');
                    label.textContent = stick.label || stick.name;
                    label.style.fontSize = '10px';
                    label.style.color = '#fff';
                    label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    label.style.padding = '2px 4px';
                    label.style.borderRadius = '3px';
                    label.style.whiteSpace = 'nowrap';
                    label.style.textAlign = 'center';
                    label.style.fontWeight = 'bold';
                    label.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                    marker.appendChild(label);
                    
                    // 添加点击事件
                    marker.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showMediaStickPopup(stick, index);
                    });
                    
                    tilePaneDom.appendChild(marker);
                    itemMarkers.push({ type: 'media_sticks', index: index, el: marker });
                });
            }

            // 特殊：走私贩飞机渲染（triggerpoint + routes + 红线）
            if (activeItemTypes.has('smuggler_plane')) {
                const groups = itemData.smuggler_plane || [];
                groups.forEach((group, gIndex) => {
                    const tp = group.triggerpoint; // [x, y]
                    const routes = Array.isArray(group.routes) ? group.routes : [];
                    if (Array.isArray(tp) && tp.length === 2) {
                        const percentX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        const marker = document.createElement('div');
                        marker.className = 'item-marker smuggler-triggerpoint-marker';
                        marker.dataset.type = 'smuggler_plane';
                        marker.dataset.index = String(gIndex);
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        const img = document.createElement('img');
                        img.src = './src/assets/smuggler_plane.svg';
                        img.style.width = '28px';
                        img.style.height = '28px';
                        marker.appendChild(img);
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSmugglerPlanePopup(group, gIndex);
                        });
                        tilePaneDom.appendChild(marker);
                        itemMarkers.push({ type: 'smuggler_plane', index: gIndex, el: marker });
                    }
                    // routes: array of arrays of [x,y]; draw marker at each and a red line from triggerpoint
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const percentX = (rx - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const percentY = (GAME_TOP - ry) / (GAME_TOP - GAME_BOTTOM);
                            const itemX = percentX * totalWidth;
                            const itemY = percentY * totalHeight;
                            const marker = document.createElement('div');
                            marker.className = 'item-marker smuggler-route-marker';
                            marker.dataset.type = 'smuggler_plane_route';
                            marker.dataset.index = String(gIndex);
                            marker.dataset.routeIndex = String(rIndex);
                            marker.style.position = 'absolute';
                            marker.style.left = `${itemX}px`;
                            marker.style.top = `${itemY}px`;
                            marker.style.transform = 'translate(-50%, -50%)';
                            marker.style.cursor = 'pointer';
                            marker.style.zIndex = '670';
                            const img = document.createElement('img');
                            img.src = './src/assets/smuggler_plane2.svg';
                            img.style.width = '28px';
                            img.style.height = '28px';
                            marker.appendChild(img);
                            marker.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSmugglerPlanePopup(group, gIndex);
                            });
                            tilePaneDom.appendChild(marker);
                            itemMarkers.push({ type: 'smuggler_plane_route', index: gIndex, el: marker });

                            // 红线：用 div 绘制一条连接 tp 与 route 点的线
                            if (Array.isArray(tp) && tp.length === 2) {
                                const tpPX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const tpPY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                const dx = itemX - tpPX;
                                const dy = itemY - tpPY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                const line = document.createElement('div');
                                line.className = 'smuggler-connector-line';
                                line.dataset.type = 'smuggler_plane_line';
                                line.dataset.index = String(gIndex);
                                line.dataset.routeIndex = String(rIndex);
                                line.style.position = 'absolute';
                                line.style.left = `${tpPX}px`;
                                line.style.top = `${tpPY}px`;
                                line.style.width = `${length}px`;
                                line.style.height = '2px';
                                line.style.background = 'red';
                                line.style.transformOrigin = '0 0';
                                line.style.transform = `rotate(${angle}deg)`;
                                line.style.zIndex = '660';
                                tilePaneDom.appendChild(line);
                                itemMarkers.push({ type: 'smuggler_plane_line', index: gIndex, el: line });
                            }
                        }
                    });
                });
            }

            // 特殊：藏匿屋渲染
            if (activeItemTypes.has('stash_houses')) {
                const stashHouses = itemData.stash_houses || [];
                stashHouses.forEach((stash, index) => {
                    if (typeof stash.x === 'undefined' || typeof stash.y === 'undefined') return;
                    const percentX = (stash.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - stash.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    
                    // 创建藏匿屋标记
                    const marker = document.createElement('div');
                    marker.className = 'item-marker stash-house-marker';
                    marker.dataset.type = 'stash_houses';
                    marker.dataset.index = index;
                    marker.style.position = 'absolute';
                    marker.style.left = `${itemX}px`;
                    marker.style.top = `${itemY}px`;
                    marker.style.transform = 'translate(-50%, -50%)';
                    marker.style.cursor = 'pointer';
                    marker.style.zIndex = '670';
                    
                    // 创建图标
                    const img = document.createElement('img');
                    img.src = './src/assets/stash.svg';
                    img.style.width = '32px';
                    img.style.height = '32px';
                    marker.appendChild(img);
                    
                    // 添加点击事件
                    marker.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showStashHousePopup(stash, index);
                    });
                    
                    tilePaneDom.appendChild(marker);
                    itemMarkers.push({ type: 'stash_houses', index: index, el: marker });
                });
            }

            // 特殊：玛德拉索雇凶渲染
            if (activeItemTypes.has('madrazo_hits')) {
                const madrazoHits = itemData.madrazo_hits || [];
                madrazoHits.forEach((hit, index) => {
                    if (typeof hit.x === 'undefined' || typeof hit.y === 'undefined') return;
                    const percentX = (hit.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - hit.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    
                    // 创建玛德拉索雇凶标记
                    const marker = document.createElement('div');
                    marker.className = 'item-marker madrazo-hits-marker';
                    marker.dataset.type = 'madrazo_hits';
                    marker.dataset.index = index;
                    marker.style.position = 'absolute';
                    marker.style.left = `${itemX}px`;
                    marker.style.top = `${itemY}px`;
                    marker.style.transform = 'translate(-50%, -50%)';
                    marker.style.cursor = 'pointer';
                    marker.style.zIndex = '670';
                    
                    // 创建图标
                    const img = document.createElement('img');
                    img.src = './src/assets/hits.svg';
                    img.style.width = '32px';
                    img.style.height = '32px';
                    marker.appendChild(img);
                    
                    // 添加点击事件
                    marker.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showMadrazoHitsPopup(hit, index);
                    });
                    
                    tilePaneDom.appendChild(marker);
                    itemMarkers.push({ type: 'madrazo_hits', index: index, el: marker });
                });
            }

            // 特殊：帕特里克救援渲染
            if (activeItemTypes.has('police_rescue_patrick_mcreary')) {
                const patrickData = itemData.police_rescue_patrick_mcreary;
                
                // 渲染spawn点（普通patrick.svg）
                if (patrickData && patrickData.spawn) {
                    patrickData.spawn.forEach((spawn, index) => {
                        if (typeof spawn.x === 'undefined' || typeof spawn.y === 'undefined') return;
                        const percentX = (spawn.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - spawn.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建spawn标记
                        const marker = document.createElement('div');
                        marker.className = 'item-marker patrick-spawn-marker';
                        marker.dataset.type = 'police_rescue_patrick_mcreary_spawn';
                        marker.dataset.index = index;
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        
                        // 创建图标
                        const img = document.createElement('img');
                        img.src = './src/assets/patrick.svg';
                        img.style.width = '32px';
                        img.style.height = '32px';
                        marker.appendChild(img);
                        
                        // 添加点击事件
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showPatrickRescuePopup(spawn, index, 'spawn');
                        });
                        
                        tilePaneDom.appendChild(marker);
                        itemMarkers.push({ type: 'police_rescue_patrick_mcreary_spawn', index: index, el: marker });
                    });
                }
                
                // 渲染dropoff点（黄色patrick_drop.svg）
                if (patrickData && patrickData.dropoff) {
                    patrickData.dropoff.forEach((dropoff, index) => {
                        if (typeof dropoff.x === 'undefined' || typeof dropoff.y === 'undefined') return;
                        const percentX = (dropoff.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - dropoff.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建dropoff标记
                        const marker = document.createElement('div');
                        marker.className = 'item-marker patrick-dropoff-marker';
                        marker.dataset.type = 'police_rescue_patrick_mcreary_dropoff';
                        marker.dataset.index = index;
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        
                        // 创建黄色图标
                        const img = document.createElement('img');
                        img.src = './src/assets/patrick_drop.svg';
                        img.style.width = '32px';
                        img.style.height = '32px';
                        marker.appendChild(img);
                        
                        // 添加点击事件
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showPatrickRescuePopup(dropoff, index, 'dropoff');
                        });
                        
                        tilePaneDom.appendChild(marker);
                        itemMarkers.push({ type: 'police_rescue_patrick_mcreary_dropoff', index: index, el: marker });
                    });
                }
            }

            // 特殊：随机任务渲染
            if (activeItemTypes.has('random_missions')) {
                const randomMissions = itemData.random_missions || {};
                let globalIndex = 0;
                
                // 遍历所有时间段
                Object.keys(randomMissions).forEach(timeSlot => {
                    const missions = randomMissions[timeSlot] || [];
                    
                    missions.forEach((mission, index) => {
                        if (!Array.isArray(mission) || mission.length < 4) return;
                        
                        const x = mission[0];
                        const y = mission[1];
                        const taskName = Array.isArray(mission[2]) ? mission[2][0] : mission[2];
                        const details = mission[3];
                        
                        if (typeof x === 'undefined' || typeof y === 'undefined') return;
                        
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // 创建随机任务标记
                        const marker = document.createElement('div');
                        marker.className = 'item-marker random-mission-marker';
                        marker.dataset.type = 'random_missions';
                        marker.dataset.index = globalIndex;
                        marker.dataset.timeSlot = timeSlot;
                        marker.dataset.missionIndex = index;
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        
                        // 创建图标
                        const img = document.createElement('img');
                        img.src = './src/assets/random.svg';
                        img.style.width = '32px';
                        img.style.height = '32px';
                        marker.appendChild(img);
                        
                        // 添加点击事件
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showRandomMissionPopup(mission, timeSlot, index);
                        });
                        
                        tilePaneDom.appendChild(marker);
                        itemMarkers.push({ type: 'random_missions', index: globalIndex, el: marker });
                        globalIndex++;
                    });
                });
            }

            // 特殊：毒品载具渲染
            if (activeItemTypes.has('drug_vehicle')) {
                const drugVehicles = itemData.drug_vehicle || [];
                drugVehicles.forEach((vehicle, index) => {
                    if (typeof vehicle.x === 'undefined' || typeof vehicle.y === 'undefined') return;
                    const percentX = (vehicle.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - vehicle.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    
                    // 创建毒品载具标记
                    const marker = document.createElement('div');
                    marker.className = 'item-marker drug-vehicle-marker';
                    marker.dataset.type = 'drug_vehicle';
                    marker.dataset.index = index;
                    marker.style.position = 'absolute';
                    marker.style.left = `${itemX}px`;
                    marker.style.top = `${itemY}px`;
                    marker.style.transform = 'translate(-50%, -50%)';
                    marker.style.cursor = 'pointer';
                    marker.style.zIndex = '670';
                    
                    // 创建图标
                    const img = document.createElement('img');
                    img.src = './src/assets/drug_vehicle.svg';
                    img.style.width = '32px';
                    img.style.height = '32px';
                    marker.appendChild(img);
                    
                    // 添加点击事件
                    marker.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showDrugVehiclePopup(vehicle, index);
                    });
                    
                    tilePaneDom.appendChild(marker);
                    itemMarkers.push({ type: 'drug_vehicle', index: index, el: marker });
                });
            }
        }

        // 更新物品标记位置（不重新创建）
        function updateItemMarkersPosition() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // 更新现有标记位置
            itemMarkers.forEach(({ type, index, el }) => {
                let item;
                if (type === 'treasure_hunt_dba_revolver_random') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.random_clue && itemData.treasure_hunt_dba_revolver.random_clue[index];
                } else if (type === 'treasure_hunt_dba_revolver_static') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.static_clues && itemData.treasure_hunt_dba_revolver.static_clues[index];
                } else if (type === 'movie_props') {
                    // 电影道具需要根据索引找到对应的项目
                    const mp = itemData.movie_props;
                    const fixedCount = mp.fixed_position?.length || 0;
                    const ponyCount = mp.vehicles?.pony?.length || 0;
                    const rebelCount = mp.vehicles?.rebel?.length || 0;
                    
                    if (index < fixedCount) {
                        item = mp.fixed_position[index];
                    } else if (index < fixedCount + ponyCount) {
                        item = mp.vehicles.pony[index - fixedCount];
                    } else if (index < fixedCount + ponyCount + rebelCount) {
                        item = mp.vehicles.rebel[index - fixedCount - ponyCount];
                    } else {
                        item = mp.vehicles.rumpo[index - fixedCount - ponyCount - rebelCount];
                    }
                } else if (type === 'serial_killer_slasher_first') {
                    // 杀人狂前四条线索
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.first && itemData.serial_killer_slasher.first[index];
                } else if (type === 'serial_killer_slasher_last') {
                    // 杀人狂最后一条线索
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.last && itemData.serial_killer_slasher.last[index];
                } else if (type === 'maude_bounty_area') {
                    // 茉德悬赏区域
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.areas && itemData.maude_bounty_targets.areas[index];
                } else if (type === 'maude_bounty_endpoint') {
                    // 茉德悬赏终点
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.endpoints && itemData.maude_bounty_targets.endpoints[index];
                } else if (type === 'police_rescue_patrick_mcreary_spawn') {
                    // 帕特里克救援生成点
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.spawn && itemData.police_rescue_patrick_mcreary.spawn[index];
                } else if (type === 'police_rescue_patrick_mcreary_dropoff') {
                    // 帕特里克救援送达点
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.dropoff && itemData.police_rescue_patrick_mcreary.dropoff[index];
                } else if (type === 'random_missions') {
                    // 随机任务需要特殊处理，因为数据结构是嵌套的
                    const randomMissions = itemData.random_missions || {};
                    let currentIndex = 0;
                    
                    // 遍历所有时间段找到对应的任务
                    for (const timeSlot of Object.keys(randomMissions)) {
                        const missions = randomMissions[timeSlot] || [];
                        for (let i = 0; i < missions.length; i++) {
                            if (currentIndex === index) {
                                const mission = missions[i];
                                if (Array.isArray(mission) && mission.length >= 2) {
                                    item = { x: mission[0], y: mission[1] };
                                }
                                break;
                            }
                            currentIndex++;
                        }
                        if (item) break;
                    }
                } else if (type === 'smuggler_plane') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_route') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && group.routes[routeIndex][0] && group.routes[routeIndex][0].length === 2) {
                        const x = group.routes[routeIndex][0][0];
                        const y = group.routes[routeIndex][0][1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_line') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && group.routes && group.routes[routeIndex] && group.routes[routeIndex][0]) {
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const rtX = group.routes[routeIndex][0][0];
                        const rtY = group.routes[routeIndex][0][1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const rPX = (rtX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const rPY = (GAME_TOP - rtY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const dx = rPX - tpPX;
                        const dy = rPY - tpPY;
                        const length = Math.sqrt(dx*dx + dy*dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        el.style.left = `${tpPX}px`;
                        el.style.top = `${tpPY}px`;
                        el.style.width = `${length}px`;
                        el.style.transform = `rotate(${angle}deg)`;
                    }
                    return;
                } else {
                    item = itemData[type] && itemData[type][index];
                }
                if (!item || typeof item.x === 'undefined' || typeof item.y === 'undefined') return;

                const percentX = (item.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                const percentY = (GAME_TOP - item.y) / (GAME_TOP - GAME_BOTTOM);

                const itemX = percentX * totalWidth;
                const itemY = percentY * totalHeight;

                el.style.left = `${itemX}px`;
                el.style.top = `${itemY}px`;
                
                // 特殊处理帮派攻击圆圈大小更新
                if (type === 'gang_attacks') {
                    // 计算游戏坐标100单位对应的像素大小
                    const gameRadius = 100; // 游戏坐标半径
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // 直径
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
                
                // 特殊处理茉德悬赏目标圆圈大小更新
                if (type === 'maude_bounty_area') {
                    // 计算游戏坐标185单位对应的像素大小
                    const gameRadius = 185; // 游戏坐标半径
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // 直径
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
            });
        }

        // === 车行标记功能 ===
        
        // 初始化车行标记
        function initDealershipMarkers() {
            createDealershipMarkers();
            console.log('车行标记初始化完成');
        }
        
        // 创建车行标记
        function createDealershipMarkers() {
            Object.keys(dealershipData).forEach(dealershipType => {
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord, index) => {
                    const marker = createDealershipMarker(coord[0], coord[1], dealership, dealershipType);
                    dealershipMarkers.push(marker);
                    tilePaneDom.appendChild(marker);
                    // 设置初始可见性，防止创建后需缩放才显示
                    try {
                        marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                    } catch (e) {
                        marker.style.display = 'block';
                    }
                });
            });
            updateDealershipMarkers();
        }
        
        // 创建单个车行标记
        function createDealershipMarker(x, y, dealership, dealershipType) {
            const marker = document.createElement('div');
            marker.className = 'dealership-marker';
            marker.dataset.dealershipType = dealershipType;
            marker.style.cssText = `
                position: absolute;
                transform: translate(-50%, -50%);
                z-index: 680;
                cursor: pointer;
                transition: transform 0.2s ease;
            `;
            
            const img = document.createElement('img');
            img.src = itemIcons[dealership.icon];
            img.style.cssText = `
                width: 40px;
                height: 40px;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                
            `;
            
            marker.appendChild(img);
            
            // 添加悬停效果
            marker.addEventListener('mouseenter', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1.2)';
            });
            
            marker.addEventListener('mouseleave', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            
            // 添加点击事件
            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('dealership marker clicked:', dealershipType, dealership.name);
                showDealershipVehicles(dealershipType, dealership.name);
            });
            
            return marker;
        }
        
        // 更新车行标记位置
        function updateDealershipMarkers() {
            const z = map.getZoom();
            let level = getLevelByZoom(z);
            // 如果没有精确匹配的缩放级别，选取最近的一个，避免在小数缩放时无法更新标记位置
            if (!level) {
                if (typeof zoomLevels !== 'undefined' && Array.isArray(zoomLevels) && zoomLevels.length > 0) {
                    level = zoomLevels.reduce((best, cur) => Math.abs(cur.zoom - z) < Math.abs(best.zoom - z) ? cur : best, zoomLevels[0]);
                } else {
                    return;
                }
            }
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            let markerIndex = 0;
            Object.keys(dealershipData).forEach(dealershipType => {
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord) => {
                    if (markerIndex < dealershipMarkers.length) {
                        const marker = dealershipMarkers[markerIndex];
                        
                        const percentX = (coord[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - coord[1]) / (GAME_TOP - GAME_BOTTOM);
                        
                        const markerX = percentX * totalWidth;
                        const markerY = percentY * totalHeight;
                        
                        marker.style.left = `${markerX}px`;
                        marker.style.top = `${markerY}px`;
                        // 根据侧边栏选择显示或隐藏车行标记
                        try {
                            marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                        } catch (e) {
                            // 如果 activeItemTypes 未定义，默认显示
                            marker.style.display = 'block';
                        }

                        markerIndex++;
                    }
                });
            });
        }
        
        // 显示车行车辆信息
        async function showDealershipVehicles(dealershipType, dealershipName) {
            try {
                let apiEndpoint = '';
                let vehicleTypes = [];
                
                // 根据车行类型确定 API 端点和车辆类型
                switch(dealershipType) {
                    case 'casino':
                        apiEndpoint = 'https://api-gta.antwen.com/api/dealerships/casino-prize';
                        vehicleTypes = ['赌场奖品载具'];
                        break;
                    case 'car_meet':
                        // 车友会包含多种车辆类型
                        await showCarMeetVehicles(dealershipName);
                        return;
                    case 'premium_deluxe_motorsport':
                        // 西米恩使用多车辆API
                        await showSimeonVehicles(dealershipName);
                        return;
                    case 'luxury_autos':
                        // 豪华车行使用多车辆API
                        await showLuxuryVehicles(dealershipName);
                        return;
                    default:
                        console.error('未知的车行类型:', dealershipType);
                        return;
                }
                
                // 获取单个车行的车辆信息（仅赌场）
                const response = await fetch(apiEndpoint);
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicle) {
                    showVehiclePopup([result.data.vehicle], dealershipName, vehicleTypes[0]);
                } else {
                    console.error('获取车辆信息失败:', result.error);
                    alert('获取车辆信息失败，请稍后重试');
                }
            } catch (error) {
                console.error('API请求错误:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示车友会车辆（包含多种类型）
        async function showCarMeetVehicles(dealershipName) {
            try {
                const endpoints = [
                    { url: 'https://api-gta.antwen.com/api/dealerships/car-meet-prize', name: '车友会奖品载具' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/promo-test', name: '测试载具' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/hsw-test', name: 'HSW载具' }
                ];
                
                const vehicles = [];
                const vehicleTypes = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url);
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            if (result.data.vehicle) {
                                // 单个车辆
                                vehicles.push(result.data.vehicle);
                                vehicleTypes.push(endpoint.name);
                            } else if (result.data.vehicles && Array.isArray(result.data.vehicles)) {
                                // 多个车辆
                                result.data.vehicles.forEach(vehicle => {
                                    vehicles.push(vehicle);
                                    vehicleTypes.push(endpoint.name);
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`获取${endpoint.name}失败:`, error);
                    }
                }
                
                if (vehicles.length > 0) {
                    showVehiclePopup(vehicles, dealershipName, vehicleTypes);
                } else {
                    alert('没有获取到任何车辆信息');
                }
            } catch (error) {
                console.error('获取车友会车辆信息失败:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示西米恩车辆
        async function showSimeonVehicles(dealershipName) {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/simeon-test');
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicles) {
                    showVehiclePopup(result.data.vehicles, dealershipName, '西米恩测试载具');
                } else {
                    console.error('获取西米恩车辆信息失败:', result.error);
                    alert('获取车辆信息失败，请稍后重试');
                }
            } catch (error) {
                console.error('获取西米恩车辆信息失败:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示豪华车辆
        async function showLuxuryVehicles(dealershipName) {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/luxury-showcase');
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicles) {
                    showVehiclePopup(result.data.vehicles, dealershipName, '豪华车展厅');
                } else {
                    console.error('获取豪华车辆信息失败:', result.error);
                    alert('获取车辆信息失败，请稍后重试');
                }
            } catch (error) {
                console.error('获取豪华车辆信息失败:', error);
                alert('网络请求失败，请检查网络连接');
            }
        }
        
        // 显示车辆弹窗
        function showVehiclePopup(vehicles, dealershipName, vehicleTypes) {
            const popup = document.createElement('div');
            popup.className = 'vehicle-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FFD700;
                border-radius: 15px;
                padding: 25px;
                z-index: 10000;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;
            
            let popupContent = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #333; border-bottom: 2px solid #FFD700; padding-bottom: 10px;">
                    🏦 ${dealershipName}车行
                </div>
            `;
            
            vehicles.forEach((vehicle, index) => {
                const vehicleType = Array.isArray(vehicleTypes) ? vehicleTypes[index] : vehicleTypes;
                const imageUrl = vehicle.img ? `https://eo-gta-images.antwen.com/${vehicle.img.replace(/^\/+/, '')}` : '';
                const detailUrl = vehicle.modelHash ? `/vehicles#/vehicle/${vehicle.modelHash.toLowerCase()}` : '';
                
                // 处理涂装价格显示
                let liveryPriceDisplay = '';
                if (vehicle.liveryPrice === 'free') {
                    liveryPriceDisplay = '<span style="color: #e91e63; font-weight: bold;">✨ 隐藏涂装</span>';
                } else if (vehicle.liveryPrice) {
                    liveryPriceDisplay = `<span style="color: #4caf50; font-weight: bold;">涂装价格: ${vehicle.liveryPrice}</span>`;
                }
                
                popupContent += `
                    <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #FFD700;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 18px;">
                            🚗 ${vehicleType}
                        </div>
                        <div style="color: #333; font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                            ${vehicle.name || '未知车辆'}
                        </div>
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 alt="${vehicle.name}" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        ` : ''}
                        <div style="margin: 10px 0; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>车类:</strong> ${vehicle.class || '未知'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>价格:</strong> ${vehicle.price || '未知'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>状态:</strong> ${vehicle.isPurchaseable ? '可购买' : '不可购买'}
                            </div>
                        </div>
                        ${vehicle.liveryName ? `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>涂装:</strong> ${vehicle.liveryName}<br>
                                ${liveryPriceDisplay}
                            </div>
                        ` : ''}
                        ${detailUrl ? `
                            <a href="${detailUrl}" target="_blank" 
                               style="display: inline-block; margin-top: 10px; padding: 10px 20px; 
                                      background: #2196F3; color: white; text-decoration: none; 
                                      border-radius: 6px; font-weight: bold; transition: background 0.3s;"
                               onmouseover="this.style.background='#1976D2'" 
                               onmouseout="this.style.background='#2196F3'">
                                🔍 车辆详细信息
                            </a>
                        ` : ''}
                    </div>
                `;
            });
            
            popupContent += `
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-vehicle-popup" 
                            style="padding: 12px 24px; 
                                   background: #f44336; color: white; 
                                   border: none; border-radius: 6px; 
                                   cursor: pointer; font-size: 16px;
                                   font-weight: bold; transition: background 0.3s;">
                        关闭
                    </button>
                </div>
            `;
            
            popup.innerHTML = popupContent;
            
            // 添加关闭按钮事件监听
            popup.querySelector('#close-vehicle-popup').addEventListener('click', () => {
                popup.remove();
            });
            
            // 添加到页面
            document.body.appendChild(popup);
            
            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 检查特技跳跃点点击事件（用于标记元素直接点击）
        function checkStuntJumpsClick(e) {
            // 获取标记元素
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // 获取索引
            const index = parseInt(marker.dataset.index);
            
            // 显示物品信息
            if (itemData.stunt_jumps && itemData.stunt_jumps[index]) {
                showItemInfo(itemData.stunt_jumps[index], 'stunt_jumps', index);
                
                // 显示特技跳跃点图片弹窗
                showStuntJumpsImage(index);
            }
        }

        // 显示物品信息
        function showItemInfo(item, type, index) {
            const titleMap = {
                stunt_jumps: '特技跳跃点',
                hidden_caches: '隐藏包裹',
                shipwrecked: '沉船',
                gun_van: '武器厢型车',
                ls_tags: 'LS涂鸦',
                spray: '喷罐位置',
                street_dealers: '街头毒贩',
                playing_cards: '纸牌',
                smoke_on_the_water_product: '吞云吐雾馆产品',
                action_figures: '手办',
                yuanbao: '元宝',
                ld_organics_products: '有机坊产品',
                signal_jammers: '信号干扰器',
                jack_o_lanterns: '南瓜灯',
                payphone_hits: '电话暗杀',
                golf_holes: '高尔夫球洞',
                snowmen: '雪人',
                rc_time_trial: 'RC时间挑战赛',
                bike_time_trial: '自行车时间挑战赛',
                skydives: '跳伞',
                gang_attacks: '帮派攻击',
                ghosts3: '幽灵曝光2025',
                treasure_hunt_dba_revolver: '左轮寻宝',
                treasure_hunt_dba_revolver_random: '左轮寻宝 - 随机线索',
                treasure_hunt_dba_revolver_static: '左轮寻宝 - 固定线索'
            };


            // 如果没有有效 item，则不显示小信息面板
            if (!item) {
                itemInfo.style.display = 'none';
                return;
            }

            // 填充小面板文本内容
            const title = titleMap[type] || type;
            const coords = (typeof item.x !== 'undefined' && typeof item.y !== 'undefined') ? `${item.x}, ${item.y}` : (item.coords ? String(item.coords) : '未知');
            const location = item.name || (typeof index !== 'undefined' ? `#${index}` : '未知');
            const details = item.info || item.details || item.description || '无';

            const titleEl = document.getElementById('item-title');
            const coordsEl = document.getElementById('item-coords');
            const locationEl = document.getElementById('item-location');
            const detailsEl = document.getElementById('item-details');

            if (titleEl) titleEl.textContent = title;
            if (coordsEl) coordsEl.textContent = `坐标: ${coords}`;
            if (locationEl) locationEl.textContent = `位置: ${location}`;
            if (detailsEl) detailsEl.textContent = `详细信息: ${details}`;

            // 对于会显示大弹窗/图片的类型，不显示小文本面板，避免重复
            const imageTypes = new Set([
                'ld_organics_products',
                'signal_jammers',
                'playing_cards',
                'smoke_on_the_water_product',
                'action_figures',
                'yuanbao',
                'shipwrecked',
                'payphone_hits',
                'golf_holes',
                'snowmen',
                'dead_drop',
                'stunt_jumps',
                'spray',
                'gang_attacks',
                'ghosts3',
                'treasure_hunt_dba_revolver',
                'treasure_hunt_dba_revolver_random',
                'treasure_hunt_dba_revolver_static'
            ]);

            if (!imageTypes.has(type)) {
                itemInfo.style.display = 'block';
            } else {
                // 确保隐藏小面板（大弹窗会同时显示）
                itemInfo.style.display = 'none';
            }

            // 如果是有机坊产品，显示图片弹窗
            if (type === 'ld_organics_products') {
                showOrganicFarmImage(index);
            }
            
            // 如果是信号干扰器，显示图片弹窗
            if (type === 'signal_jammers') {
                showSignalJammerImage(index);
            }
            
            // 如果是纸牌，显示图片弹窗
            if (type === 'playing_cards') {
                showPlayingCardsImage(index);
            }
            
            // 如果是吞云吐雾馆产品，显示图片弹窗
            if (type === 'smoke_on_the_water_product') {
                showSmokeProductImage(index);
            }
            
            // 如果是手办，显示图片弹窗
            if (type === 'action_figures') {
                showActionFiguresImage(index);
            }
            
            // 如果是元宝，显示图片弹窗
            if (type === 'yuanbao') {
                showYuanbaoImage(index);
            }
            
            // 如果是沉船，显示图片弹窗
            if (type === 'shipwrecked') {
                showShipwrecksImage(index);
            }
            
            // 如果是电话暗杀，显示图片弹窗
            if (type === 'payphone_hits') {
                showPayphoneHitsImage(index);
            }
            
            // 如果是高尔夫球洞，显示图片弹窗
            if (type === 'golf_holes') {
                showGolfHolesImage(index);
            }
            
            // 如果是雪人，显示图片弹窗
            if (type === 'snowmen') {
                showSnowmenImage(index);
            }
            
            // 如果是杰拉德包裹，显示图片弹窗
            if (type === 'dead_drop') {
                showDeadDropImage(index);
            }
            
            // 如果是帮派攻击，显示弹窗
            if (type === 'gang_attacks') {
                showGangAttackPopup(item, index);
            }

            // 如果是幽灵曝光，显示弹窗
            if (type === 'ghosts3') {
                showGhosts3Popup(item, index);
            }

            // 如果是左轮寻宝线索，显示弹窗
            if (type === 'treasure_hunt_dba_revolver_random') {
                showTreasureHuntPopup(item, index, 'random');
            }
            if (type === 'treasure_hunt_dba_revolver_static') {
                showTreasureHuntPopup(item, index, 'static');
            }
            
            // 如果是洛圣都杀人狂线索，显示弹窗
            if (type === 'serial_killer_slasher_first') {
                showSlasherPopup(item, index, 'first');
            }
            if (type === 'serial_killer_slasher_last') {
                showSlasherPopup(item, index, 'last');
            }
            
            // 如果是电影道具，显示弹窗
            if (type === 'movie_props') {
                // 电影道具需要根据索引找到对应的项目
                const mp = itemData.movie_props;
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                
                let subtype;
                if (index < fixedCount) {
                    subtype = 'fixed_position';
                } else if (index < fixedCount + ponyCount) {
                    subtype = 'pony';
                } else if (index < fixedCount + ponyCount + rebelCount) {
                    subtype = 'rebel';
                } else {
                    subtype = 'rumpo';
                }
                
                showMoviePropsPopup(item, index, subtype);
            }
        }

        function hideItemInfo() {
            itemInfo.style.display = 'none';
        }

        // 显示RC时间挑战赛弹窗
        function showRCTimeTrialPopup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'rc-time-trial-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FF5722;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #FF5722;">
                    🏁 RC时间挑战赛
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FF5722;">
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                    
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">⏱️ 时间要求</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #fff3e0; padding: 8px; border-radius: 4px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #fff3e0; border-radius: 6px; color: #e65100; font-size: 14px; line-height: 1.4;">
                    🏆 挑战提示：使用RC车在限定时间内完成赛道！
                </div>
                
                <button id="close-rc-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #FF5722; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;
                               margin-right: 10px;">
                    关闭
                </button>
                <button id="hide-rc-marker-btn" 
                        style="padding: 12px 24px; 
                               background: #666; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
            `;

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-rc-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-rc-marker-btn');
            hideBtn.addEventListener('click', () => {
                // 找到对应的RC标记并设置透明度为25%
                const rcMarkers = document.querySelectorAll('.item-marker');
                rcMarkers.forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('rctt.png') && marker.dataset.index == index) {
                        marker.style.opacity = '0.25';
                        popup.remove();
                    }
                });
            });

            // 添加到页面
            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示自行车时间挑战赛弹窗
        function showBikeTimeTrialPopup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'bike-time-trial-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #4CAF50;">
                    🚴 自行车时间挑战赛
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                    
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">⏱️ 时间要求</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #e8f5e8; padding: 8px; border-radius: 4px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #e8f5e8; border-radius: 6px; color: #2e7d32; font-size: 14px; line-height: 1.4;">
                    🏆 挑战提示：使用自行车在限定时间内完成赛道！
                </div>
                
                <button id="close-bike-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;
                               margin-right: 10px;">
                    关闭
                </button>
                <button id="hide-bike-marker-btn" 
                        style="padding: 12px 24px; 
                               background: #666; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
            `;

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-bike-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-bike-marker-btn');
            hideBtn.addEventListener('click', () => {
                // 找到对应的自行车标记并设置透明度为25%
                const bikeMarkers = document.querySelectorAll('.item-marker');
                bikeMarkers.forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('btt.png') && marker.dataset.index == index) {
                        marker.style.opacity = '0.25';
                        popup.remove();
                    }
                });
            });

            // 添加到页面
            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示信号干扰器图片弹窗
        function showSignalJammerImage(index) {
            // 序号从1开始
             const sequenceNumber = index + 1;
             // 1-9使用单个数字，10+使用两位数
             const paddedNumber = sequenceNumber < 10 ? sequenceNumber.toString() : sequenceNumber.toString().padStart(2, '0');
             const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/signal_jammers/signal_jammers_${paddedNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'signal-jammer-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #2196F3;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #1976D2;">
                    📡 信号干扰器 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="信号干扰器 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #2196F3;">
                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        消灭全部的50个干扰器可解锁赌场豪劫隐藏黑客：阿维·施瓦兹曼
                    </div>
                </div>
                <button id="close-signal-popup-btn" 
                         style="padding: 10px 20px; 
                                background: #2196F3; color: white; 
                                border: none; border-radius: 6px; 
                                cursor: pointer; font-size: 16px;
                                transition: background-color 0.3s;
                                margin-right: 10px;">
                     关闭
                 </button>
                 <button id="hide-signal-jammer-btn" 
                         style="padding: 10px 20px; 
                                background: #666; color: white; 
                                border: none; border-radius: 6px; 
                                cursor: pointer; font-size: 16px;
                                transition: background-color 0.3s;">
                     隐藏
                 </button>
            `;

            // 添加关闭按钮事件监听
             const closeBtn = popup.querySelector('#close-signal-popup-btn');
             closeBtn.addEventListener('click', () => {
                 popup.remove();
             });

             // 添加隐藏按钮事件监听
             const hideBtn = popup.querySelector('#hide-signal-jammer-btn');
             hideBtn.addEventListener('click', () => {
                 // 找到对应的信号干扰器标记并设置透明度为25%
                 const jammerMarkers = document.querySelectorAll('.item-marker');
                 jammerMarkers.forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('signal_jammer') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#4CAF50';
                         hideBtn.id = 'show-signal-jammer-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加到页面
            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示南瓜灯图片弹窗
        function showJackOLanternImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/lantern/lantern_${sequenceNumber.toString().padStart(2, '0')}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'jack-o-lantern-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #f26f17;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #f26f17;">
                    🎃 南瓜灯 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="南瓜灯 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #f26f17;">
                    <div style="font-weight: bold; color: #f26f17; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集全部南瓜灯可获得特殊万圣节奖励！
                    </div>
                </div>
                <button id="hide-jack-o-lantern-btn" 
                        style="padding: 10px 20px; 
                               background: #f26f17; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;">
                    隐藏标记
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 隐藏按钮点击事件
            const hideBtn = document.getElementById('hide-jack-o-lantern-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('data:image/svg+xml') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#4CAF50';
                         hideBtn.id = 'show-jack-o-lantern-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示纸牌图片弹窗
        function showPlayingCardsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/playing_cards/playing_cards_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'playing-cards-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #9C27B0;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #7B1FA2;">
                    🃏 纸牌 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="纸牌 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9C27B0;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有54张纸牌可获得：特殊服装奖励赌场豪赌客套装
                    </div>
                </div>
                <button id="hide-playing-cards-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-playing-cards-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-playing-cards-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('playing_cards') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-playing-cards-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-playing-cards-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示吞云吐雾馆产品图片弹窗
        function showSmokeProductImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/smoke_on_the_water_product/smoke_on_the_water_product_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'smoke-product-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FF9800;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #F57C00;">
                    💨 吞云吐雾馆产品 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="吞云吐雾馆产品 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #FF9800;">
                    <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有吞云吐雾馆产品可获得：<br>
                        • 特殊载具奖励<br>
                        • 游戏币奖励<br>
                        • 解锁隐藏成就
                    </div>
                </div>
                <button id="hide-smoke-product-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-smoke-product-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-smoke-product-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('smoke_on_the_water_product') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-smoke-product-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-smoke-product-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示手办图片弹窗
        function showActionFiguresImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/action_figures/action_figures_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'action-figures-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #E91E63;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #C2185B;">
                    🎭 手办 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="手办 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #E91E63;">
                    <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有手办可获得：<br>
                        • 特殊载具奖励<br>
                        • 游戏币奖励<br>
                        • 解锁隐藏成就
                    </div>
                </div>
                <button id="hide-action-figures-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-action-figures-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-action-figures-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('action_figures') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-action-figures-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-action-figures-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示元宝图片弹窗
        function showYuanbaoImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/yuanbao/yuanbao_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'yuanbao-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FFD700;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #B8860B;">
                    🪙 元宝 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="元宝 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #FFD700;">
                    <div style="font-weight: bold; color: #B8860B; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有元宝可获得：<br>
                        • 高额游戏币奖励<br>
                        • 特殊服装奖励<br>
                        • 解锁隐藏成就
                    </div>
                </div>
                <button id="hide-yuanbao-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-yuanbao-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-yuanbao-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('yuanbao') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-yuanbao-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-yuanbao-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示沉船图片弹窗
        function showShipwrecksImage(index) {
            // 从API消息中提取沉船编号
            let sequenceNumber = index + 1; // 默认使用index+1
            
            // 如果有API消息，尝试从中提取正确的编号
            if (itemData.shipwreckedMessage) {
                const match = itemData.shipwreckedMessage.match(/#(\d+)/);
                if (match && match[1]) {
                    sequenceNumber = parseInt(match[1]);
                    console.log('从API消息中提取的沉船编号:', sequenceNumber);
                }
            }
            
            console.log('沉船sequenceNumber:', sequenceNumber);
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/shipwrecks/shipwrecks_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'shipwrecks-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #795548;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #5D4037;">
                    ⚓ 沉船 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="沉船 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #795548;">
                    <div style="font-weight: bold; color: #5D4037; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有沉船可获得：边境套装
                    </div>
                </div>
                <button id="hide-shipwrecks-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-shipwrecks-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-shipwrecks-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('shipwrecked') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-shipwrecks-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-shipwrecks-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示电话暗杀图片弹窗
        function showPayphoneHitsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'payphone-hits-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #E91E63;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #C2185B;">
                    📞 电话暗杀 #${sequenceNumber}
                </div>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #E91E63;">
                    <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">🎯 任务说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        需要购买事务所完成一个安保合约解锁
                    </div>
                </div>
                <button id="hide-payphone-hits-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #E91E63; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-payphone-hits-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-payphone-hits-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('payphone_hits') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-payphone-hits-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-payphone-hits-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示高尔夫球洞图片弹窗
        function showGolfHolesImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/golf_holes/golf_holes_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'golf-holes-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #2E7D32;">
                    ⛳ 高尔夫球洞 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="高尔夫球洞 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #2E7D32; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        完成所有高尔夫球洞挑战可获得特殊奖励
                    </div>
                </div>
                <button id="hide-golf-holes-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-golf-holes-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-golf-holes-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('golf_holes') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-golf-holes-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-golf-holes-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示喷罐位置弹窗
        function showSprayImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/spray/spray_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'spray-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #2196F3;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #2196F3;">
                    🎨 喷罐位置 #${sequenceNumber}
                </div>
                <img src="${imageUrl}"
                     alt="喷罐位置 #${sequenceNumber}"
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #2196F3;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">🎯 收集说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        找到喷罐位置，收集喷罐道具！
                    </div>
                </div>
                <button id="hide-spray-btn"
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #2196F3; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-spray-btn"
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-spray-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('spray') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#4CAF50';
                         hideBtn.id = 'show-spray-btn';
                           
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-spray-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示特技跳跃点弹窗
        function showStuntJumpsImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/stunt_jumps/stunt_jumps_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'stunt-jumps-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #388E3C;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #388E3C;">
                    🚀 特技跳跃点 #${sequenceNumber}
                </div>
                <img src="${imageUrl}"
                     alt="特技跳跃点 #${sequenceNumber}"
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #388E3C;">
                    <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">🎯 挑战说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        驾驶车辆完成特技跳跃，获得高分和奖励！
                    </div>
                </div>
                <button id="hide-stunt-jumps-btn"
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #388E3C; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-stunt-jumps-btn"
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-stunt-jumps-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('stunt_jumps') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-stunt-jumps-btn';
                          
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-stunt-jumps-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        function showSnowmenImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/snowmen/snowmen_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'snowmen-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #03A9F4;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #0288D1;">
                    ⛄ 雪人 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="雪人 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #03A9F4;">
                    <div style="font-weight: bold; color: #0288D1; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集所有雪人可获得冬季主题奖励
                    </div>
                </div>
                <button id="hide-snowmen-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #03A9F4; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-snowmen-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-snowmen-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('snowmen') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-snowmen-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-snowmen-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示跳伞弹窗
        function showSkydivesPopup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'skydives-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #2196F3;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #2196F3;">
                    🪂 跳伞挑战
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 8px; font-size: 16px;">🗺️ 地点</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || '未知地点'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 6px; color: #1565c0; font-size: 14px; line-height: 1.6;">
                    🎆 <strong>每日跳伞挑战</strong><br>
                    • 每天共有10个跳伞位置<br>
                    • 完成可获得<strong>经验值</strong>和<strong>游戏币奖励</strong><br>
                    • 从高空跳下，体验极限刺激！
                </div>
                
                <button id="close-skydive-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #2196F3; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;
                               margin-right: 10px;">
                    关闭
                </button>
                <button id="hide-skydive-marker-btn" 
                        style="padding: 12px 24px; 
                               background: #666; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
            `;

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-skydive-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-skydive-marker-btn');
            hideBtn.addEventListener('click', () => {
                // 找到对应的跳伞标记并设置透明度为25%
                const skydiveMarkers = document.querySelectorAll('.item-marker');
                skydiveMarkers.forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('skydive.png') && marker.dataset.index == index) {
                        marker.style.opacity = '0.25';
                        popup.remove();
                    }
                });
            });

            // 添加到页面
            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示杰拉德包裹图片弹窗
        function showDeadDropImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/dead_drop/dead_drop_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'dead-drop-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #9C6EAF;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #9C6EAF;">
                    📦 杰拉德包裹 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="杰拉德包裹 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9C6EAF;">
                    <div style="font-weight: bold; color: #9C6EAF; margin-bottom: 5px;">🎯 任务说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        杰拉德提供的秘密包裹投递点，完成可获得丰厚奖励
                    </div>
                </div>
                <button id="hide-dead-drop-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #9C6EAF; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-dead-drop-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
                
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-dead-drop-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('dead_drop') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-dead-drop-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-dead-drop-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // 显示有机坊产品图片弹窗
        function showOrganicFarmImage(index) {
            // 序号从1开始
            const sequenceNumber = index + 1;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/ld_organics/ld_organics_${sequenceNumber.toString().padStart(2, '0')}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'organic-farm-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #2E7D32;">
                    🌿 有机坊产品 #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="有机坊产品 #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #2E7D32; margin-bottom: 5px;">🎯 收集奖励</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        收集全部有机坊产品可获得特殊衣服和帽子奖励！
                    </div>
                </div>
                <button id="hide-organic-popup-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-organic-popup-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-organic-popup-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('organic_farm') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-organic-popup-btn';
                         
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-organic-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 添加到页面
            document.body.appendChild(popup);

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

    // 顶部 old select 已移除；侧边栏复选框与 reset 按钮管理 activeItemTypes

        // 地图事件
        map.on('move', updateTilePanePosition); // 改为move事件实现实时跟随
        map.on('moveend', updateTilePanePosition);
        map.on('zoomend', () => {
            const z = map.getZoom();
            const centerPixel = map.project(map.getCenter(), z);
            resetViewForZoom(z, { x: centerPixel.x, y: centerPixel.y });
            updateTilePanePosition();
            probeTilesForStyleAndZoom(currentStyle, z);
        });

        // 地图点击事件 - 检测坐标值
        const mapContainer = document.getElementById('map-container');
        mapContainer.addEventListener('click', (e) => {
            // 获取点击位置相对于地图容器的坐标
            const rect = mapContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            // 获取地图容器的变换信息
            const transform = tilePaneDom.style.transform;
            const translateX = parseInt(transform.match(/translate\(([-\d.]+)px/)[1]) || 0;
            const translateY = parseInt(transform.match(/translate\([-\d.]+px,\s*([-\d.]+)px/)[1]) || 0;
            
            // 计算点击位置在瓦片容器中的像素坐标
            const tileX = clickX - translateX;
            const tileY = clickY - translateY;
            
            // 将像素坐标转换为游戏坐标
            const percentX = tileX / totalWidth;
            const percentY = tileY / totalHeight;
            
            const gameX = GAME_LEFT + percentX * (GAME_RIGHT - GAME_LEFT);
            const gameY = GAME_TOP - percentY * (GAME_TOP - GAME_BOTTOM);
            
            console.log('点击坐标:', {
                container: { x: clickX, y: clickY },
                tile: { x: tileX, y: tileY },
                game: { x: gameX.toFixed(2), y: gameY.toFixed(2) }
            });

            // 检测是否点击在武器厢型车附近
            checkGunVanClick(gameX, gameY);
            
            // 检测是否点击在街头毒贩附近
            checkStreetDealersClick(gameX, gameY);
            
            // 检测是否点击在有机坊产品附近
            checkOrganicFarmClick(gameX, gameY);
            
            // 检测是否点击在信号干扰器附近
            checkSignalJammerClick(gameX, gameY);
            
            // 检测是否点击在南瓜灯附近
            checkJackOLanternClick(gameX, gameY);
            
            // 检测是否点击在纸牌附近
            checkPlayingCardsClick(gameX, gameY);
            
            // 检测是否点击在吞云吐雾馆产品附近
            checkSmokeProductClick(gameX, gameY);
            
            // 检测是否点击在手办附近
            checkActionFiguresClick(gameX, gameY);
            
            // 检测是否点击在元宝附近
            checkYuanbaoClick(gameX, gameY);
            
            // 检测是否点击在沉船附近
            checkShipwrecksClick(gameX, gameY);
            
            // 检测是否点击在电话暗杀附近
            checkPayphoneHitsClick(gameX, gameY);
            
            // 检测是否点击在高尔夫球洞附近
            checkGolfHolesClick(gameX, gameY);
            
            // 检测是否点击在雪人附近
            checkSnowmenClick(gameX, gameY);
            
            // 检测是否点击在特技跳跃点附近
            checkStuntJumpsClickNew(gameX, gameY);
            
            // 检测是否点击在杰拉德包裹附近
            checkDeadDropClick(gameX, gameY);
            
            // 检测是否点击在LS涂鸦附近
            checkLSTagsClick(gameX, gameY);
            
            // 检测是否点击在喷罐附近
            checkSprayClickNew(gameX, gameY);
            
            // 检测是否点击在RC时间挑战赛附近
            checkRCTimeTrialClickNew(gameX, gameY);
            
            // 检测是否点击在自行车时间挑战赛附近
            checkBikeTimeTrialClickNew(gameX, gameY);
            
            // 检测是否点击在跳伞附近
            checkSkydivesClickNew(gameX, gameY);
            
            // 检测是否点击在车行附近
            checkDealershipClick(gameX, gameY);
            
            // 检测是否点击在帮派攻击附近
            checkGangAttackClick(gameX, gameY);

            // 检测是否点击在幽灵曝光附近
            checkGhosts3Click(gameX, gameY);

            // 检测是否点击在左轮寻宝点附近
            checkTreasureHuntClick(gameX, gameY);
            
            // 检测是否点击在电影道具附近
            checkMoviePropsClick(gameX, gameY);
            
            // 检测是否点击在杀人狂附近
            checkSlasherClick(gameX, gameY);
            
            // 检测是否点击在茉德悬赏目标附近
            checkMaudeBountyClick(gameX, gameY);
            
            // 检测是否点击在媒体记忆棒附近
            checkMediaStickClick(gameX, gameY);
            
            // 检测是否点击在藏匿屋附近
            checkStashHouseClick(gameX, gameY);
            
            // 检测是否点击在玛德拉索雇凶附近
            checkMadrazoHitsClick(gameX, gameY);
            
            // 检测是否点击在帕特里克救援附近
            checkPatrickRescueClick(gameX, gameY);
            
            // 检测是否点击在随机任务附近
            checkRandomMissionClick(gameX, gameY);
            
            // 检测是否点击在毒品载具附近
            checkDrugVehicleClick(gameX, gameY);

            // 检测是否点击在沉睡的保安附近
            checkDrunkGuardClick(gameX, gameY);

            // 检测是否点击在金属探测器附近
            checkMetalDetectorClick(gameX, gameY);

            // 检测是否点击在走私贩飞机附近
            checkSmugglerPlaneClick(gameX, gameY);
        });

        // 检测武器厢型车点击
        function checkGunVanClick(clickX, clickY) {
            const GUN_VAN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示武器厢型车（支持多选）
            if (activeItemTypes.has('gun_van') && itemData.gun_van) {
                // 检查点击位置是否在任意武器厢型车附近
                const nearbyVan = itemData.gun_van.find(van => {
                    const distance = Math.sqrt(Math.pow(van.x - clickX, 2) + Math.pow(van.y - clickY, 2));
                    return distance <= GUN_VAN_RADIUS;
                });

                if (nearbyVan) {
                    console.log('点击了武器厢型车附近:', nearbyVan.name);
                    showGunVanWeapons();
                }
            }
        }

        // 检测街头毒贩点击
        function checkStreetDealersClick(clickX, clickY) {
            const STREET_DEALER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示街头毒贩（支持多选）
            if (activeItemTypes.has('street_dealers') && itemData.street_dealers) {
                // 检查点击位置是否在任意街头毒贩附近
                const nearbyDealer = itemData.street_dealers.find(dealer => {
                    const distance = Math.sqrt(Math.pow(dealer.x - clickX, 2) + Math.pow(dealer.y - clickY, 2));
                    return distance <= STREET_DEALER_RADIUS;
                });

                if (nearbyDealer) {
                    console.log('点击了街头毒贩附近:', nearbyDealer.name);
                    showStreetDealersInfo();
                }
            }
        }

        // 检测有机坊产品点击
        function checkOrganicFarmClick(clickX, clickY) {
            const ORGANIC_FARM_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示有机坊产品（支持多选）
            if (activeItemTypes.has('ld_organics_products') && itemData.ld_organics_products) {
                // 检查点击位置是否在任意有机坊产品附近
                const nearbyProduct = itemData.ld_organics_products.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= ORGANIC_FARM_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('点击了有机坊产品附近:', nearbyProduct.name);
                    // 找到对应的索引
                    const productIndex = itemData.ld_organics_products.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showOrganicFarmImage(productIndex);
                }
            }
        }

        // 检测信号干扰器点击
        function checkSignalJammerClick(clickX, clickY) {
            const SIGNAL_JAMMER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示信号干扰器（支持多选）
            if (activeItemTypes.has('signal_jammers') && itemData.signal_jammers) {
                // 检查点击位置是否在任意信号干扰器附近
                const nearbyJammer = itemData.signal_jammers.find((jammer, index) => {
                    const distance = Math.sqrt(Math.pow(jammer.x - clickX, 2) + Math.pow(jammer.y - clickY, 2));
                    return distance <= SIGNAL_JAMMER_RADIUS;
                });

                if (nearbyJammer) {
                    console.log('点击了信号干扰器附近:', nearbyJammer.name);
                    // 找到对应的索引
                    const jammerIndex = itemData.signal_jammers.findIndex(jammer => 
                        jammer.x === nearbyJammer.x && jammer.y === nearbyJammer.y
                    );
                    showSignalJammerImage(jammerIndex);
                }
            }
        }

        // 检测南瓜灯点击
        function checkJackOLanternClick(clickX, clickY) {
            const JACK_O_LANTERN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示南瓜灯（支持多选）
            if (activeItemTypes.has('jack_o_lanterns') && itemData.jack_o_lanterns) {
                // 检查点击位置是否在任意南瓜灯附近
                const nearbyLantern = itemData.jack_o_lanterns.find((lantern, index) => {
                    const distance = Math.sqrt(Math.pow(lantern.x - clickX, 2) + Math.pow(lantern.y - clickY, 2));
                    return distance <= JACK_O_LANTERN_RADIUS;
                });

                if (nearbyLantern) {
                    console.log('点击了南瓜灯附近:', nearbyLantern.name);
                    // 找到对应的索引
                    const lanternIndex = itemData.jack_o_lanterns.findIndex(lantern => 
                        lantern.x === nearbyLantern.x && lantern.y === nearbyLantern.y
                    );
                    showJackOLanternImage(lanternIndex);
                }
            }
        }
        
        // 检测LS涂鸦点击
        function checkLSTagsClick(clickX, clickY) {
            const LS_TAGS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示LS涂鸦（支持多选）
            if (activeItemTypes.has('ls_tags') && itemData.ls_tags) {
                // 检查点击位置是否在任意LS涂鸦附近
                const nearbyTag = itemData.ls_tags.find((tag, index) => {
                    const distance = Math.sqrt(Math.pow(tag.x - clickX, 2) + Math.pow(tag.y - clickY, 2));
                    return distance <= LS_TAGS_RADIUS;
                });

                if (nearbyTag) {
                    console.log('点击了LS涂鸦附近:', nearbyTag.name || `LS涂鸦 #${nearbyTag.sequenceNumber}`);
                    showLSTagsImage(nearbyTag);
                }
            }
        }
        
        // 显示LS涂鸦弹窗
        function showLSTagsImage(tag) {
            // 使用API返回的编号数字
            const sequenceNumber = tag.sequenceNumber;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/ls_tags/ls_tags_${sequenceNumber}.webp`;
            
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'ls-tags-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FF5722;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #E64A19;">
                    🎨 LS涂鸦 #${sequenceNumber}
                </div>
                <img src="${imageUrl}"
                     alt="LS涂鸦 #${sequenceNumber}"
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    可在上图位置找到！
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #FF5722;">
                    <div style="font-weight: bold; color: #E64A19; margin-bottom: 5px;">🎯 收集说明</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        找到并收集所有LS涂鸦，解锁独特奖励！
                    </div>
                </div>
                <button id="hide-ls-tags-btn"
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #FF5722; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    隐藏标记
                </button>
                <button id="close-ls-tags-btn"
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加到页面
            document.body.appendChild(popup);

            // 添加隐藏按钮事件监听
            const hideBtn = popup.querySelector('#hide-ls-tags-btn');
            hideBtn.addEventListener('click', () => {
                 // 找到对应的标记并设置透明度为25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     const markerIndex = parseInt(marker.dataset.index);
                     const itemTag = itemData.ls_tags[markerIndex];
                     if (img && img.src && img.src.includes('ls_tags') && itemTag && itemTag.sequenceNumber === tag.sequenceNumber) {
                         marker.style.opacity = '0.25';
                         // 将隐藏按钮改为显示按钮
                         hideBtn.textContent = '显示';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-ls-tags-btn';
                            
                         // 移除旧的点击事件，添加新的显示事件
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // 恢复透明度为100%
                             document.querySelectorAll('.item-marker').forEach(m => {
                                 const mImg = m.querySelector('img');
                                 const mIndex = parseInt(m.dataset.index);
                                 const mTag = itemData.ls_tags[mIndex];
                                 if (mImg && mImg.src && mImg.src.includes('ls_tags') && mTag && mTag.sequenceNumber === tag.sequenceNumber) {
                                     m.style.opacity = '1';
                                 }
                             });
                             popup.remove();
                         });
                     }
                 });
             });

            // 添加关闭按钮事件监听
            const closeBtn = popup.querySelector('#close-ls-tags-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }
        
        // 检测纸牌点击
        function checkPlayingCardsClick(clickX, clickY) {
            const PLAYING_CARDS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示纸牌（支持多选）
            if (activeItemTypes.has('playing_cards') && itemData.playing_cards) {
                // 检查点击位置是否在任意纸牌附近
                const nearbyCard = itemData.playing_cards.find((card, index) => {
                    const distance = Math.sqrt(Math.pow(card.x - clickX, 2) + Math.pow(card.y - clickY, 2));
                    return distance <= PLAYING_CARDS_RADIUS;
                });

                if (nearbyCard) {
                    console.log('点击了纸牌附近:', nearbyCard.name);
                    // 找到对应的索引
                    const cardIndex = itemData.playing_cards.findIndex(card => 
                        card.x === nearbyCard.x && card.y === nearbyCard.y
                    );
                    showPlayingCardsImage(cardIndex);
                }
            }
        }
        
        // 检测吞云吐雾馆产品点击
        function checkSmokeProductClick(clickX, clickY) {
            const SMOKE_PRODUCT_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示吞云吐雾馆产品（支持多选）
            if (activeItemTypes.has('smoke_on_the_water_product') && itemData.smoke_on_the_water_product) {
                // 检查点击位置是否在任意吞云吐雾馆产品附近
                const nearbyProduct = itemData.smoke_on_the_water_product.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= SMOKE_PRODUCT_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('点击了吞云吐雾馆产品附近:', nearbyProduct.name);
                    // 找到对应的索引
                    const productIndex = itemData.smoke_on_the_water_product.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showSmokeProductImage(productIndex);
                }
            }
        }
        
        // 检测手办点击
        function checkActionFiguresClick(clickX, clickY) {
            const ACTION_FIGURES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示手办（支持多选）
            if (activeItemTypes.has('action_figures') && itemData.action_figures) {
                // 检查点击位置是否在任意手办附近
                const nearbyFigure = itemData.action_figures.find((figure, index) => {
                    const distance = Math.sqrt(Math.pow(figure.x - clickX, 2) + Math.pow(figure.y - clickY, 2));
                    return distance <= ACTION_FIGURES_RADIUS;
                });

                if (nearbyFigure) {
                    console.log('点击了手办附近:', nearbyFigure.name);
                    // 找到对应的索引
                    const figureIndex = itemData.action_figures.findIndex(figure => 
                        figure.x === nearbyFigure.x && figure.y === nearbyFigure.y
                    );
                    showActionFiguresImage(figureIndex);
                }
            }
        }
        
        // 检测元宝点击
        function checkYuanbaoClick(clickX, clickY) {
            const YUANBAO_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示元宝（支持多选）
            if (activeItemTypes.has('yuanbao') && itemData.yuanbao) {
                // 检查点击位置是否在任意元宝附近
                const nearbyYuanbao = itemData.yuanbao.find((yuanbao, index) => {
                    const distance = Math.sqrt(Math.pow(yuanbao.x - clickX, 2) + Math.pow(yuanbao.y - clickY, 2));
                    return distance <= YUANBAO_RADIUS;
                });

                if (nearbyYuanbao) {
                    console.log('点击了元宝附近:', nearbyYuanbao.name);
                    // 找到对应的索引
                    const yuanbaoIndex = itemData.yuanbao.findIndex(yuanbao => 
                        yuanbao.x === nearbyYuanbao.x && yuanbao.y === nearbyYuanbao.y
                    );
                    showYuanbaoImage(yuanbaoIndex);
                }
            }
        }
        
        // 检测沉船点击
        function checkShipwrecksClick(clickX, clickY) {
            const SHIPWRECKS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示沉船（支持多选）
            if (activeItemTypes.has('shipwrecked') && itemData.shipwrecked) {
                // 检查点击位置是否在任意沉船附近
                const nearbyShipwreck = itemData.shipwrecked.find((shipwreck, index) => {
                    const distance = Math.sqrt(Math.pow(shipwreck.x - clickX, 2) + Math.pow(shipwreck.y - clickY, 2));
                    return distance <= SHIPWRECKS_RADIUS;
                });

                if (nearbyShipwreck) {
                    console.log('点击了沉船附近:', nearbyShipwreck.name);
                    // 找到对应的索引
                    const shipwreckIndex = itemData.shipwrecked.findIndex(shipwreck => 
                        shipwreck.x === nearbyShipwreck.x && shipwreck.y === nearbyShipwreck.y
                    );
                    showShipwrecksImage(shipwreckIndex);
                }
            }
        }
        
        // 检测电话暗杀点击
        function checkPayphoneHitsClick(clickX, clickY) {
            const PAYPHONE_HITS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示电话暗杀（支持多选）
            if (activeItemTypes.has('payphone_hits') && itemData.payphone_hits) {
                // 检查点击位置是否在任意电话暗杀附近
                const nearbyPayphoneHit = itemData.payphone_hits.find((payphoneHit, index) => {
                    const distance = Math.sqrt(Math.pow(payphoneHit.x - clickX, 2) + Math.pow(payphoneHit.y - clickY, 2));
                    return distance <= PAYPHONE_HITS_RADIUS;
                });

                if (nearbyPayphoneHit) {
                    console.log('点击了电话暗杀附近:', nearbyPayphoneHit.name);
                    // 找到对应的索引
                    const payphoneHitIndex = itemData.payphone_hits.findIndex(payphoneHit => 
                        payphoneHit.x === nearbyPayphoneHit.x && payphoneHit.y === nearbyPayphoneHit.y
                    );
                    showPayphoneHitsImage(payphoneHitIndex);
                }
            }
        }
        
        // 检测高尔夫球洞点击
        function checkGolfHolesClick(clickX, clickY) {
            const GOLF_HOLES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示高尔夫球洞（支持多选）
            if (activeItemTypes.has('golf_holes') && itemData.golf_holes) {
                // 检查点击位置是否在任意高尔夫球洞附近
                const nearbyGolfHole = itemData.golf_holes.find((golfHole, index) => {
                    const distance = Math.sqrt(Math.pow(golfHole.x - clickX, 2) + Math.pow(golfHole.y - clickY, 2));
                    return distance <= GOLF_HOLES_RADIUS;
                });

                if (nearbyGolfHole) {
                    console.log('点击了高尔夫球洞附近:', nearbyGolfHole.name);
                    // 找到对应的索引
                    const golfHoleIndex = itemData.golf_holes.findIndex(golfHole => 
                        golfHole.x === nearbyGolfHole.x && golfHole.y === nearbyGolfHole.y
                    );
                    showGolfHolesImage(golfHoleIndex);
                }
            }
        }
        
        // 检测雪人点击
        function checkSnowmenClick(clickX, clickY) {
            const SNOWMEN_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示雪人（支持多选）
            if (activeItemTypes.has('snowmen') && itemData.snowmen) {
                // 检查点击位置是否在任意雪人附近
                const nearbySnowman = itemData.snowmen.find((snowman, index) => {
                    const distance = Math.sqrt(Math.pow(snowman.x - clickX, 2) + Math.pow(snowman.y - clickY, 2));
                    return distance <= SNOWMEN_RADIUS;
                });

                if (nearbySnowman) {
                    console.log('点击了雪人附近:', nearbySnowman.name);
                    // 找到对应的索引
                    const snowmanIndex = itemData.snowmen.findIndex(snowman => 
                        snowman.x === nearbySnowman.x && snowman.y === nearbySnowman.y
                    );
                    showSnowmenImage(snowmanIndex);
                }
            }
        }
        
        // 检测杰拉德包裹点击
        function checkDeadDropClick(clickX, clickY) {
            const DEAD_DROP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示杰拉德包裹（支持多选）
            if (activeItemTypes.has('dead_drop') && itemData.dead_drop) {
                // 检查点击位置是否在任意杰拉德包裹附近
                const nearbyDeadDrop = itemData.dead_drop.find((deadDrop, index) => {
                    const distance = Math.sqrt(Math.pow(deadDrop.x - clickX, 2) + Math.pow(deadDrop.y - clickY, 2));
                    return distance <= DEAD_DROP_RADIUS;
                });

                if (nearbyDeadDrop) {
                    console.log('点击了杰拉德包裹附近:', nearbyDeadDrop.name);
                    // 找到对应的索引
                    const deadDropIndex = itemData.dead_drop.findIndex(deadDrop => 
                        deadDrop.x === nearbyDeadDrop.x && deadDrop.y === nearbyDeadDrop.y
                    );
                    showDeadDropImage(deadDropIndex);
                }
            }
        }
        
        // 检测喷罐位置点击
        function checkSprayClick(e) {
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // 获取索引
            const index = parseInt(marker.dataset.index);
            
            // 显示物品信息
            if (itemData.spray && itemData.spray[index]) {
                showItemInfo(itemData.spray[index], 'spray', index);
                
                // 显示喷罐位置图片弹窗
                showSprayImage(index);
            }
        }

        // 检测特技跳跃点点击（用于地图坐标检测）
        function checkStuntJumpsClickNew(clickX, clickY) {
            const STUNT_JUMP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示特技跳跃点（支持多选）
            if (activeItemTypes.has('stunt_jumps') && itemData.stunt_jumps) {
                // 检查点击位置是否在任意特技跳跃点附近
                const nearbyJump = itemData.stunt_jumps.find(jump => {
                    const distance = Math.sqrt(Math.pow(jump.x - clickX, 2) + Math.pow(jump.y - clickY, 2));
                    return distance <= STUNT_JUMP_RADIUS;
                });

                if (nearbyJump) {
                    console.log('点击了特技跳跃点附近:', nearbyJump.name);
                    // 找到对应的索引
                    const jumpIndex = itemData.stunt_jumps.findIndex(jump => 
                        jump.x === nearbyJump.x && jump.y === nearbyJump.y
                    );
                    
                    showItemInfo(nearbyJump, 'stunt_jumps', jumpIndex);
                    
                    // 显示特技跳跃点图片弹窗
                    if (typeof showStuntJumpsImage === 'function') {
                        showStuntJumpsImage(jumpIndex);
                    }
                }
            }
        }
        
        // 检测喷罐点击（用于地图坐标检测）
        function checkSprayClickNew(clickX, clickY) {
            const SPRAY_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示喷罐位置（支持多选）
            if (activeItemTypes.has('spray') && itemData.spray) {
                // 检查点击位置是否在任意喷罐附近
                const nearbySpray = itemData.spray.find(spray => {
                    const distance = Math.sqrt(Math.pow(spray.x - clickX, 2) + Math.pow(spray.y - clickY, 2));
                    return distance <= SPRAY_RADIUS;
                });

                if (nearbySpray) {
                    console.log('点击了喷罐附近:', nearbySpray.name);
                    // 找到对应的索引
                    const sprayIndex = itemData.spray.findIndex(spray => 
                        spray.x === nearbySpray.x && spray.y === nearbySpray.y
                    );

                    // 显示物品信息
                    if (itemData.spray && itemData.spray[sprayIndex]) {
                        showItemInfo(itemData.spray[sprayIndex], 'spray', sprayIndex);
                        
                        // 显示喷罐位置图片弹窗
                        showSprayImage(sprayIndex);
                    }
                }
            }
        }

        // 检测RC时间挑战赛点击（坐标检测）
        function checkRCTimeTrialClickNew(clickX, clickY) {
            const RC_TIME_TRIAL_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示RC时间挑战赛（支持多选）
            if (activeItemTypes.has('rc_time_trial') && itemData.rc_time_trial) {
                // 检查点击位置是否在任意RC时间挑战赛附近
                const nearbyTrial = itemData.rc_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= RC_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('点击了RC时间挑战赛附近:', nearbyTrial.name);
                    // 找到对应的索引
                    const trialIndex = itemData.rc_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showRCTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // 检测自行车时间挑战赛点击（坐标检测）
        function checkBikeTimeTrialClickNew(clickX, clickY) {
            const BIKE_TIME_TRIAL_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示自行车时间挑战赛（支持多选）
            if (activeItemTypes.has('bike_time_trial') && itemData.bike_time_trial) {
                // 检查点击位置是否在任意自行车时间挑战赛附近
                const nearbyTrial = itemData.bike_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= BIKE_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('点击了自行车时间挑战赛附近:', nearbyTrial.name);
                    // 找到对应的索引
                    const trialIndex = itemData.bike_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showBikeTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // 检测跳伞点击（坐标检测）
        function checkSkydivesClickNew(clickX, clickY) {
            const SKYDIVES_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示跳伞（支持多选）
            if (activeItemTypes.has('skydives') && itemData.skydives) {
                // 检查点击位置是否在任意跳伞附近
                const nearbySkydive = itemData.skydives.find(skydive => {
                    const distance = Math.sqrt(Math.pow(skydive.x - clickX, 2) + Math.pow(skydive.y - clickY, 2));
                    return distance <= SKYDIVES_RADIUS;
                });

                if (nearbySkydive) {
                    console.log('点击了跳伞附近:', nearbySkydive.name);
                    // 找到对应的索引
                    const skydiveIndex = itemData.skydives.findIndex(skydive => 
                        skydive.x === nearbySkydive.x && skydive.y === nearbySkydive.y
                    );
                    showSkydivesPopup(nearbySkydive, skydiveIndex);
                }
            }
        }

        // 检测车行点击（坐标检测）
        function checkDealershipClick(clickX, clickY) {
            const DEALERSHIP_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示车行（支持多选）
            if (activeItemTypes.has('dealerships')) {
                // 遍历所有车行坐标进行检测
                Object.keys(dealershipData).forEach(dealershipType => {
                    const dealership = dealershipData[dealershipType];
                    dealership.coordinates.forEach(coord => {
                        const distance = Math.sqrt(Math.pow(coord[0] - clickX, 2) + Math.pow(coord[1] - clickY, 2));
                        if (distance <= DEALERSHIP_RADIUS) {
                            console.log(`点击了${dealership.name}附近区域`);
                            showDealershipVehicles(dealershipType, dealership.name);
                        }
                    });
                });
            }
        }

        // 检测左轮寻宝点击（坐标检测）
        function checkTreasureHuntClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('treasure_hunt_dba_revolver')) return;
            const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
            const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
            const foundRandom = rc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundRandom) {
                const idx = rc.findIndex(p => p.x === foundRandom.x && p.y === foundRandom.y);
                showTreasureHuntPopup(foundRandom, idx, 'random');
                return;
            }
            const foundStatic = sc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundStatic) {
                const idx = sc.findIndex(p => p.x === foundStatic.x && p.y === foundStatic.y);
                showTreasureHuntPopup(foundStatic, idx, 'static');
            }
        }

        // 检测电影道具点击（坐标检测）
        function checkMoviePropsClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('movie_props')) return;
            
            const mp = itemData.movie_props;
            const allItems = [
                ...(mp.fixed_position || []).map((item, i) => ({ ...item, __index: i, __type: 'fixed_position' })),
                ...(mp.vehicles?.pony || []).map((item, i) => ({ ...item, __index: i, __type: 'pony' })),
                ...(mp.vehicles?.rebel || []).map((item, i) => ({ ...item, __index: i, __type: 'rebel' })),
                ...(mp.vehicles?.rumpo || []).map((item, i) => ({ ...item, __index: i, __type: 'rumpo' }))
            ];
            
            const foundItem = allItems.find(item => Math.hypot(item.x - clickX, item.y - clickY) <= RADIUS);
            if (foundItem) {
                showMoviePropsPopup(foundItem, foundItem.__index, foundItem.__type);
            }
        }

        // 检测杀人狂点击（坐标检测）
        function checkSlasherClick(clickX, clickY) {
            const SLASHER_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示杀人狂（支持多选）
            if (activeItemTypes.has('serial_killer_slasher') && itemData.serial_killer_slasher) {
                // 检查前四条线索
                if (itemData.serial_killer_slasher.first) {
                    const nearbyFirst = itemData.serial_killer_slasher.first.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyFirst) {
                        const index = itemData.serial_killer_slasher.first.findIndex(item => 
                            item.x === nearbyFirst.x && item.y === nearbyFirst.y
                        );
                        console.log('点击了杀人狂前四条线索附近:', nearbyFirst.name);
                        showSlasherPopup(nearbyFirst, index, 'first');
                        return;
                    }
                }
                
                // 检查最后一条线索
                if (itemData.serial_killer_slasher.last) {
                    const nearbyLast = itemData.serial_killer_slasher.last.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyLast) {
                        const index = itemData.serial_killer_slasher.last.findIndex(item => 
                            item.x === nearbyLast.x && item.y === nearbyLast.y
                        );
                        console.log('点击了杀人狂最后一条线索附近:', nearbyLast.name);
                        showSlasherPopup(nearbyLast, index, 'last');
                        return;
                    }
                }
            }
        }

        // 检测茉德悬赏目标点击（坐标检测）
        function checkMaudeBountyClick(clickX, clickY) {
            const MAUDE_BOUNTY_RADIUS = 185; // 检测半径185单位（与圆圈半径一致）
            
            // 检查当前是否显示茉德悬赏目标
            if (activeItemTypes.has('maude_bounty_targets') && itemData.maude_bounty_targets) {
                // 检查悬赏区域
                if (itemData.maude_bounty_targets.areas) {
                    const nearbyArea = itemData.maude_bounty_targets.areas.find((area, index) => {
                        const distance = Math.sqrt(Math.pow(area.x - clickX, 2) + Math.pow(area.y - clickY, 2));
                        return distance <= MAUDE_BOUNTY_RADIUS;
                    });
                    
                    if (nearbyArea) {
                        const index = itemData.maude_bounty_targets.areas.findIndex(area => 
                            area.x === nearbyArea.x && area.y === nearbyArea.y
                        );
                        console.log('点击了茉德悬赏区域附近:', nearbyArea.name);
                        showMaudeBountyPopup(nearbyArea, index, 'area');
                        return;
                    }
                }
                
                // 检查悬赏终点
                if (itemData.maude_bounty_targets.endpoints) {
                    const nearbyEndpoint = itemData.maude_bounty_targets.endpoints.find((endpoint, index) => {
                        const distance = Math.sqrt(Math.pow(endpoint.x - clickX, 2) + Math.pow(endpoint.y - clickY, 2));
                        return distance <= 50; // 终点检测半径较小
                    });
                    
                    if (nearbyEndpoint) {
                        const index = itemData.maude_bounty_targets.endpoints.findIndex(endpoint => 
                            endpoint.x === nearbyEndpoint.x && endpoint.y === nearbyEndpoint.y
                        );
                        console.log('点击了茉德悬赏终点附近:', nearbyEndpoint.name);
                        showMaudeBountyPopup(nearbyEndpoint, index, 'endpoint');
                        return;
                    }
                }
            }
        }

        // 茉德悬赏目标弹窗
        function showMaudeBountyPopup(item, index, subtype) {
            const isArea = subtype === 'area';
            const title = isArea ? `🎯 茉德悬赏区域 #${index + 1}` : `🎯 茉德悬赏终点 #${index + 1}`;
            
            const popup = document.createElement('div');
            popup.className = 'maude-bounty-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FFD700; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #FFD700; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #fffbf0; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    前往茉德处接受悬赏目标任务。等待数分钟后，她将通过电子邮件告知悬赏目标的相关信息。悬赏目标将随机出现在 20 个区域之一，其当前活动的区域会在游戏内的地图上标记出来。每个区域都有 20 个可供生成目标的位置。若您成功抓住目标，并转交给茉德，您可赚取 10.000 GTA$；若您直接杀死目标，您将获得 5.000 GTA$。完成一个悬赏目标任务后，您必须再等几分钟才会收到下一个悬赏目标的相关信息。该系列任务共有 5 个悬赏目标需要抓捕。全部完成之后，茉德会发短信，告诉您石斧的藏匿位置，该位置会在游戏内地图上标记出来。使用该武器完成 25 次击杀，您将得到 250.000 GTA$ 与 2.000 RP，并可在 Red Dead Redemption 2 中找到这款武器。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-maude-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-maude-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-maude-btn" style="padding: 10px 18px; background: #FFD700; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-maude-btn');
            const showBtn = popup.querySelector('#show-maude-btn');
            const closeBtn = popup.querySelector('#close-maude-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                let el;
                if (subtype === 'area') {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_area"][data-index="${index}"]`);
                } else {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_endpoint"][data-index="${index}"]`);
                }
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 检测媒体记忆棒点击（坐标检测）
        function checkMediaStickClick(clickX, clickY) {
            const MEDIA_STICK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示媒体记忆棒
            if (activeItemTypes.has('media_sticks') && itemData.media_sticks) {
                const nearbyStick = itemData.media_sticks.find((stick, index) => {
                    const distance = Math.sqrt(Math.pow(stick.x - clickX, 2) + Math.pow(stick.y - clickY, 2));
                    return distance <= MEDIA_STICK_RADIUS;
                });
                
                if (nearbyStick) {
                    const index = itemData.media_sticks.findIndex(stick => 
                        stick.x === nearbyStick.x && stick.y === nearbyStick.y
                    );
                    console.log('点击了媒体记忆棒附近:', nearbyStick.name);
                    showMediaStickPopup(nearbyStick, index);
                    return;
                }
            }
        }

        // 媒体记忆棒弹窗
        function showMediaStickPopup(item, index) {
            const label = item.label || item.name;
            
            // 根据标签匹配不同的弹窗内容
            let title, content, imageUrl;
            
            if (label.includes('circoloco_green_ep')) {
                title = '🎵 CircoLoco Records - Green EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Green EP - 在游戏厅的吧台上 - 您的游戏厅的位置可能与本标记不同。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_green_ep.webp';
            } else if (label.includes('circoloco_violet_ep')) {
                title = '🎵 CircoLoco Records - Violet EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Violet EP - 在夜总会的桌子上 - 您的夜总会的位置可能与本地图的标记不同。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_violet_ep.webp';
            } else if (label.includes('circoloco_blue_ep')) {
                title = '🎵 CircoLoco Records - Blue EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Blue EP - 在名钻假日赌场的露台，其中的一张桌子上。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_blue_ep.webp';
            } else if (label.includes('circoloco_black_ep')) {
                title = '🎵 CircoLoco Records - Black EP';
                content = `游戏中共有 4 个包含音乐的 CircoLoco Records 媒体记忆棒。收集一个媒体记忆棒可获得 1.000 RP，同时在媒体播放器上解锁相应曲目。完成全部收集还可解锁额外的曲目：CLR Launch Party (Seth Troxler)，并解锁CircoLoco T 恤。<br><br>Black EP - 在洛圣都车友会内，在改装工坊旁边的一个工具台上。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_black_ep.webp';
            } else if (label.includes('dam_funk')) {
                title = '🎵 DâM-FunK – Even the Score';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>呼叫 6115550110 后会在 5 个可能位置之一出现。游戏内地图上会标出大致位置。本地图显示的是确切位置。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/dam_funk.webp';
            } else if (label.includes('dr_dre')) {
                title = '🎵 Dr. Dre - 在事务所里';
                content = `它将奖励您 马拉松连帽上衣 与 1.000 RP，并在媒体播放器上解锁新的曲目<br><br>Dr. Dre - 在事务所里 - 您的事务所的位置可能与本地图的标记不同。该媒体记忆棒将在以主持人身份完成全部德瑞博士的故事后可用。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/dr_dre.webp';
            } else if (label.includes('moodymann')) {
                title = '🎵 Moodymann - Kenny\'s Backyard Boogie';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>Moodymann - Kenny's Backyard Boogie -在穆迪曼的车的后备箱上 - 这辆车在 洛圣都车友会 随机生成。`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/moodymann.webp';
            } else if (label.includes('nez')) {
                title = '🎵 NEZ - You Wanna?';
                content = `它将提供 1.000 RP 奖励，并在媒体播放器上解锁新的曲目<br><br>NEZ - You Wanna?`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/nez.webp';
            } else {
                // 默认内容
                title = `🎵 媒体记忆棒 #${index + 1}`;
                content = `媒体记忆棒位置信息。<br><br>标签: ${label}`;
                imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/media_sticks/default.webp';
            }
            
            const popup = document.createElement('div');
            popup.className = 'media-stick-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #9C27B0; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="媒体记忆棒图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-media-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-media-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-media-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-media-btn');
            const showBtn = popup.querySelector('#show-media-btn');
            const closeBtn = popup.querySelector('#close-media-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="media_sticks"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 检测藏匿屋点击（坐标检测）
        function checkStashHouseClick(clickX, clickY) {
            const STASH_HOUSE_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示藏匿屋
            if (activeItemTypes.has('stash_houses') && itemData.stash_houses) {
                const nearbyStash = itemData.stash_houses.find((stash, index) => {
                    const distance = Math.sqrt(Math.pow(stash.x - clickX, 2) + Math.pow(stash.y - clickY, 2));
                    return distance <= STASH_HOUSE_RADIUS;
                });
                
                if (nearbyStash) {
                    const index = itemData.stash_houses.findIndex(stash => 
                        stash.x === nearbyStash.x && stash.y === nearbyStash.y
                    );
                    console.log('点击了藏匿屋附近:', nearbyStash.name);
                    showStashHousePopup(nearbyStash, index);
                    return;
                }
            }
        }

        // 藏匿屋弹窗
        function showStashHousePopup(item, index) {
            const title = `🏠 藏匿屋 #${index + 1}`;
            const imageUrl = 'https://eo-gta-maps.antwen.com/collectibles_images/stash_house/stash_house.webp';
            const content = `藏匿屋随机生成在 25 个可能位置之一，其位置会直接标记在游戏内地图上。<br><br>袭击藏匿屋即可获得 1.000 RP 与 30.000 GTA$ 奖励，或为您正在运营的产业之一补充原材料。`;
            
            const popup = document.createElement('div');
            popup.className = 'stash-house-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF9800; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #FF9800; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="藏匿屋图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #fff3e0; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-stash-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-stash-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-stash-btn" style="padding: 10px 18px; background: #FF9800; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-stash-btn');
            const showBtn = popup.querySelector('#show-stash-btn');
            const closeBtn = popup.querySelector('#close-stash-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="stash_houses"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 检测玛德拉索雇凶点击（坐标检测）
        function checkMadrazoHitsClick(clickX, clickY) {
            const MADRAZO_HITS_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示玛德拉索雇凶
            if (activeItemTypes.has('madrazo_hits') && itemData.madrazo_hits) {
                const nearbyHit = itemData.madrazo_hits.find((hit, index) => {
                    const distance = Math.sqrt(Math.pow(hit.x - clickX, 2) + Math.pow(hit.y - clickY, 2));
                    return distance <= MADRAZO_HITS_RADIUS;
                });
                
                if (nearbyHit) {
                    const index = itemData.madrazo_hits.findIndex(hit => 
                        hit.x === nearbyHit.x && hit.y === nearbyHit.y
                    );
                    console.log('点击了玛德拉索雇凶附近:', nearbyHit.name);
                    showMadrazoHitsPopup(nearbyHit, index);
                    return;
                }
            }
        }

        // 检测帕特里克救援点击（坐标检测）
        function checkPatrickRescueClick(clickX, clickY) {
            const PATRICK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示帕特里克救援
            if (activeItemTypes.has('police_rescue_patrick_mcreary') && itemData.police_rescue_patrick_mcreary) {
                const patrickData = itemData.police_rescue_patrick_mcreary;
                
                // 检查spawn点
                if (patrickData.spawn) {
                    const nearbySpawn = patrickData.spawn.find((spawn, index) => {
                        const distance = Math.sqrt(Math.pow(spawn.x - clickX, 2) + Math.pow(spawn.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbySpawn) {
                        const index = patrickData.spawn.findIndex(spawn => 
                            spawn.x === nearbySpawn.x && spawn.y === nearbySpawn.y
                        );
                        console.log('点击了帕特里克救援生成点附近:', nearbySpawn);
                        showPatrickRescuePopup(nearbySpawn, index, 'spawn');
                        return;
                    }
                }
                
                // 检查dropoff点
                if (patrickData.dropoff) {
                    const nearbyDropoff = patrickData.dropoff.find((dropoff, index) => {
                        const distance = Math.sqrt(Math.pow(dropoff.x - clickX, 2) + Math.pow(dropoff.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbyDropoff) {
                        const index = patrickData.dropoff.findIndex(dropoff => 
                            dropoff.x === nearbyDropoff.x && dropoff.y === nearbyDropoff.y
                        );
                        console.log('点击了帕特里克救援送达点附近:', nearbyDropoff);
                        showPatrickRescuePopup(nearbyDropoff, index, 'dropoff');
                        return;
                    }
                }
            }
        }

        // 检测随机任务点击（坐标检测）
        function checkRandomMissionClick(clickX, clickY) {
            const RANDOM_MISSION_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示随机任务
            if (activeItemTypes.has('random_missions') && itemData.random_missions) {
                const randomMissions = itemData.random_missions;
                let globalIndex = 0;
                
                // 遍历所有时间段
                for (const timeSlot of Object.keys(randomMissions)) {
                    const missions = randomMissions[timeSlot] || [];
                    
                    for (let i = 0; i < missions.length; i++) {
                        const mission = missions[i];
                        if (!Array.isArray(mission) || mission.length < 2) continue;
                        
                        const x = mission[0];
                        const y = mission[1];
                        const distance = Math.sqrt(Math.pow(x - clickX, 2) + Math.pow(y - clickY, 2));
                        
                        if (distance <= RANDOM_MISSION_RADIUS) {
                            console.log('点击了随机任务附近:', mission);
                            showRandomMissionPopup(mission, timeSlot, i);
                            return;
                        }
                        globalIndex++;
                    }
                }
            }
        }

        // 检测毒品载具点击（坐标检测）
        function checkDrugVehicleClick(clickX, clickY) {
            const DRUG_VEHICLE_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示毒品载具
            if (activeItemTypes.has('drug_vehicle') && Array.isArray(itemData.drug_vehicle)) {
                const nearbyVehicle = itemData.drug_vehicle.find((vehicle) => {
                    const dx = vehicle.x - clickX;
                    const dy = vehicle.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUG_VEHICLE_RADIUS;
                });
                
                if (nearbyVehicle) {
                    const index = itemData.drug_vehicle.findIndex(v => v.x === nearbyVehicle.x && v.y === nearbyVehicle.y);
                    console.log('点击了毒品载具附近:', nearbyVehicle);
                    showDrugVehiclePopup(nearbyVehicle, index);
                    return;
                }
            }
        }

        // 检测沉睡的保安点击（坐标检测）
        function checkDrunkGuardClick(clickX, clickY) {
            const DRUNK_GUARD_RADIUS = 100; // 检测半径100单位
            
            if (activeItemTypes.has('drunk_guard') && Array.isArray(itemData.drunk_guard)) {
                const nearby = itemData.drunk_guard.find((g) => {
                    const dx = g.x - clickX;
                    const dy = g.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUNK_GUARD_RADIUS;
                });
                
                if (nearby) {
                    const index = itemData.drunk_guard.findIndex(g => g.x === nearby.x && g.y === nearby.y);
                    console.log('点击了沉睡的保安附近:', nearby);
                    showDrunkGuardPopup(nearby, index);
                    return;
                }
            }
        }

        // 检测金属探测器点击（坐标检测）
        function checkMetalDetectorClick(clickX, clickY) {
            const METAL_DETECTOR_RADIUS = 100; // 检测半径100单位
            
            if (activeItemTypes.has('metal_detector') && Array.isArray(itemData.metal_detector)) {
                const nearby = itemData.metal_detector.find((m) => {
                    const dx = m.x - clickX;
                    const dy = m.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= METAL_DETECTOR_RADIUS;
                });
                
                if (nearby) {
                    const index = itemData.metal_detector.findIndex(m => m.x === nearby.x && m.y === nearby.y);
                    console.log('点击了金属探测器附近:', nearby);
                    showMetalDetectorPopup(nearby, index);
                    return;
                }
            }
        }

        // 检测走私贩飞机点击（坐标检测）
        function checkSmugglerPlaneClick(clickX, clickY) {
            const RADIUS = 120; // 检测半径（游戏坐标）
            if (!activeItemTypes.has('smuggler_plane') || !Array.isArray(itemData.smuggler_plane)) return;
            const groups = itemData.smuggler_plane;

            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                // 检查 triggerpoint
                if (Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                    const dx = group.triggerpoint[0] - clickX;
                    const dy = group.triggerpoint[1] - clickY;
                    if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                        showSmugglerPlanePopup(group, i);
                        return;
                    }
                }
                // 检查 routes 的首点
                if (Array.isArray(group.routes)) {
                    for (let r = 0; r < group.routes.length; r++) {
                        const route = group.routes[r];
                        if (Array.isArray(route) && route[0] && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const dx = rx - clickX;
                            const dy = ry - clickY;
                            if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                                showSmugglerPlanePopup(group, i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        // 毒品载具弹窗
        function showDrugVehiclePopup(item, index) {
            const title = `🚗 毒品载具 #${index + 1}`;
            const content = `毒品载具会在此位置附近刷新。靠近时会在游戏中以蓝点标记。`;
            
            const popup = document.createElement('div');
            popup.className = 'drug-vehicle-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #2E7D32; text-align:center;">${title}</div>
                <img src="https://gta-maps.antwen.com/collectibles_images/drug_vehicle/drug_vehicle.webp" alt="毒品载具图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #1b5e20; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drug-vehicle-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-drug-vehicle-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-drug-vehicle-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 按钮
            const hideBtn = popup.querySelector('#hide-drug-vehicle-btn');
            const showBtn = popup.querySelector('#show-drug-vehicle-btn');
            const closeBtn = popup.querySelector('#close-drug-vehicle-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drug_vehicle"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 沉睡的保安弹窗
        function showDrunkGuardPopup(item, index) {
            const title = `🛌 沉睡的保安 #${index + 1}`;
            const content = `搜刮他（键盘上的E ）以获得 7.007 GTA$ 和佩里科岛金发老大办公室的抽屉钥匙。抽屉里面有一把 佩里科手枪。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/drunk_guard/drunk_guard.webp';
            
            const popup = document.createElement('div');
            popup.className = 'drunk-guard-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #795548; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #5D4037; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="沉睡的保安图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #efebe9; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drunk-guard-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-drunk-guard-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-drunk-guard-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-drunk-guard-btn');
            const showBtn = popup.querySelector('#show-drunk-guard-btn');
            const closeBtn = popup.querySelector('#close-drunk-guard-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drunk_guard"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 金属探测器弹窗（带编号图片）
        function showMetalDetectorPopup(item, index) {
            const title = `🧭 金属探测器 #${index + 1}`;
            const content = `您可以使用金属探测器在 佩里科岛 上定位 地下藏匿品 - 。<br/>搜索骷髅可获得 5.000 至 10.000 GTA$ 不等的现金奖励。`;
            const imgUrl = `https://gta-maps.antwen.com/collectibles_images/metal_detector/metal_detector_${index + 1}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'metal-detector-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #607D8B; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #455A64; text-align:center;">${title}</div>
                <img src="${imgUrl}" alt="金属探测器图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #ECEFF1; border-radius: 8px; color: #263238; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-metal-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-metal-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-metal-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-metal-btn');
            const showBtn = popup.querySelector('#show-metal-btn');
            const closeBtn = popup.querySelector('#close-metal-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="metal_detector"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 走私贩飞机弹窗
        function showSmugglerPlanePopup(item, index) {
            const title = `✈️ 走私贩飞机 #${index + 1}`;
            const content = `在飞机坠毁处收集装有 25.000 GTA$ 和 2.000 RP 的公文包。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/smuggler_plane/smuggler_plane.webp';
            
            const popup = document.createElement('div');
            popup.className = 'smuggler-plane-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF5252; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #D32F2F; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="走私贩飞机图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #FFEBEE; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-smuggler-plane-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-smuggler-plane-btn');
            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 玛德拉索雇凶弹窗
        function showMadrazoHitsPopup(item, index) {
            const title = `🎯 玛德拉索雇凶 #${index + 1}`;
            const content = `您需要拥有保金办公室  才能进行玛德拉索雇凶。<br><br>您每天都可接下马丁·玛德拉索的雇凶暗杀。干掉目标即可获得 500 RP 与 20.000 GTA$ 奖励，使用玛德拉索指定的武器完成暗杀还可额外获得 10.000 GTA$。目标的位置常驻于游戏内地图上，您可参考本地图的图标在游戏中查找。`;
            
            const popup = document.createElement('div');
            popup.className = 'madrazo-hits-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #E91E63; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #E91E63; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #fce4ec; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-madrazo-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-madrazo-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-madrazo-btn" style="padding: 10px 18px; background: #E91E63; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-madrazo-btn');
            const showBtn = popup.querySelector('#show-madrazo-btn');
            const closeBtn = popup.querySelector('#close-madrazo-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="madrazo_hits"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 帕特里克救援弹窗
        function showPatrickRescuePopup(item, index, type) {
            const typeNames = {
                'spawn': '生成点',
                'dropoff': '送达点'
            };
            
            const title = `🚔 帕特里克救援 - ${typeNames[type]} #${index + 1}`;
            const content = `寻找正在鸣笛巡逻的警用运输车。这辆车以蓝点标记在地图上。拦截囚车，救出囚犯。囚车会生成在 ，您需要将其送至 。运气好的话，您也有可能在送达点发现事件。<br><br>奖励：10.000 GTA$、2.000 RP，解锁名钻赌场豪劫的枪手帕特里克·麦克瑞利（8% 分红）。`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/patrick/patrick.webp';
            
            const popup = document.createElement('div');
            popup.className = 'patrick-rescue-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2;">${title}</div>
                <img src="${imageUrl}" alt="帕特里克救援图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 8px; color: #4e342e; font-size: 13px; text-align: left; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-patrick-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-patrick-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-patrick-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-patrick-btn');
            const showBtn = popup.querySelector('#show-patrick-btn');
            const closeBtn = popup.querySelector('#close-patrick-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="police_rescue_patrick_mcreary_${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 随机任务弹窗
        function showRandomMissionPopup(mission, timeSlot, index) {
            if (!Array.isArray(mission) || mission.length < 4) return;
            
            const taskName = Array.isArray(mission[2]) ? mission[2][0] : mission[2];
            const details = mission[3];
            
            if (!Array.isArray(details) || details.length < 3) return;
            
            const level = details[0];
            const players = details[1];
            const timeRange = details[2];
            
            const title = `🎲 随机任务 - ${taskName}`;
            const content = `
                <div style="margin-bottom: 10px;">
                    <strong>任务名:</strong> ${taskName}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>开放等级:</strong> ${level}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>人数:</strong> ${players}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>开放时间:</strong> ${timeRange}
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'random-mission-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px; color: #4e342e; font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-random-mission-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-random-mission-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-random-mission-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-random-mission-btn');
            const showBtn = popup.querySelector('#show-random-mission-btn');
            const closeBtn = popup.querySelector('#close-random-mission-btn');

            // 解析目标标记和索引
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="random_missions"][data-time-slot="${timeSlot}"][data-mission-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 电影道具弹窗
        function showMoviePropsPopup(item, index, subtype) {
            const typeNames = {
                'fixed_position': '固定位置',
                'pony': 'Pony载具',
                'rebel': 'Rebel载具',
                'rumpo': 'Rumpo载具'
            };
            
            const imageUrls = {
                'fixed_position': 'ls_c_mp_static',
                'pony': 'ls_c_mp_pony',
                'rebel': 'ls_c_mp_rebel',
                'rumpo': 'ls_c_mp_rumpo'
            };
            
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/${imageUrls[subtype]}/${imageUrls[subtype]}_${(index + 1)}.webp`;
            const title = `🎬 电影道具 - ${typeNames[subtype]} #${index + 1}`;

            const popup = document.createElement('div');
            popup.className = 'movie-props-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 500px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2;">${title}</div>
                <img src="${imageUrl}" alt="电影道具图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px; color: #4e342e; font-size: 13px; text-align: left; line-height: 1.6;">
                    前往  接取电影道具搜寻任务。电影道具共有 10 个，其中 7 个位置固定，另外 3 个在载具里。每辆载具都有 3 个可能的生成点，其中 1 个会生成移动的载具。当您离生成点足够接近时，载具会以蓝点标记在地图上。如这些生成点都没有生成载具，您可以更换战局继续寻找。<br><br>
                    奖励：每个道具 10.000 GTA$。载具 2.000 RP，其他固定道具 5.000 RP。前往  交付道具以领取奖励。您没必要每收集一个就交付一个，多个道具同时交付时奖励会累加计算。此外，集齐全套收藏品还将获得 50.000 GTA$ 并解锁 太空入侵者 套装（前往 ，从盒子  里领取）。<br><br>
                    总收益：150.000 GTA$、41.000 RP 和套装。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-movie-props-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-movie-props-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-movie-props-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-movie-props-btn');
            const showBtn = popup.querySelector('#show-movie-props-btn');
            const closeBtn = popup.querySelector('#close-movie-props-btn');

            // 解析全局索引（兼容标记点击与坐标点击）
            function resolveTargetAndIndex() {
                const mp = itemData.movie_props;
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                // 先尝试直接使用 index（标记点击时为全局索引）
                let globalIndex = index;
                let el = document.querySelector(`.item-marker[data-type="movie_props"][data-index="${globalIndex}"]`);
                if (!el) {
                    // 若找不到，则根据 subtype 折算（坐标点击时 index 是子类型内索引）
                    if (subtype === 'fixed_position') globalIndex = index;
                    else if (subtype === 'pony') globalIndex = fixedCount + index;
                    else if (subtype === 'rebel') globalIndex = fixedCount + ponyCount + index;
                    else if (subtype === 'rumpo') globalIndex = fixedCount + ponyCount + rebelCount + index;
                    el = document.querySelector(`.item-marker[data-type="movie_props"][data-index="${globalIndex}"]`);
                }
                return { el, globalIndex };
            }

            // 按钮同时显示：隐藏=25%透明，显示=100%透明

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
                const img = el.querySelector('img');
                if (img) img.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
                const img = el.querySelector('img');
                if (img) img.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 洛圣都杀人狂弹窗
        function showSlasherPopup(item, index, subtype) {
            const isFirst = subtype === 'first';
            const base = isFirst ? 'ls_slasher' : 'ls_slasher_final';
            const title = isFirst ? `🩸 杀人狂线索 #${index + 1}` : `🩸 最后一条线索 #${index + 1}`;
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index + 1)}.webp`;

            const popup = document.createElement('div');
            popup.className = 'slasher-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #b71c1c; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #b71c1c; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="杀人狂线索" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #ffebee; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    一共有 5 条线索。前四条线索 总是在相同的位置。集齐前 4 条后，最后一条线索 将在 5 个可能位置中的随机 1 处生成。<br><br>
                    线索会发出令人毛骨悚然的声音以帮助您定位它，您须按 E 来调查它。<br><br>
                    奖励：每条线索都会给您 5.000 GTA$ 和 2.000 RP。找到所有线索后，杀人狂会一直试图埋伏并杀死您，直到您消灭他。他只会在晚上 700 和早上 500 之间出现在布莱恩郡 。杀死他您将获得 50.000 GTA$ 和海军左轮手枪。用海军左轮手枪完成 50 次击杀，即可赚取 200.000 GTA$，并在 Red Dead 在线模式中解锁一款独家武器。
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-slasher-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">隐藏</button>
                    <button id="show-slasher-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">显示</button>
                    <button id="close-slasher-btn" style="padding: 10px 18px; background: #b71c1c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
                </div>
            `;

            // 隐藏/显示/关闭按钮
            const hideBtn = popup.querySelector('#hide-slasher-btn');
            const showBtn = popup.querySelector('#show-slasher-btn');
            const closeBtn = popup.querySelector('#close-slasher-btn');

            // 解析目标标记和索引（兼容标记点击与坐标点击）
            function resolveTargetAndIndex() {
                const slasherData = itemData.serial_killer_slasher;
                let globalIndex = index;
                let el;
                
                if (subtype === 'first') {
                    // 前四条线索
                    el = document.querySelector(`.item-marker[data-type="serial_killer_slasher_first"][data-index="${index}"]`);
                } else {
                    // 最后一条线索
                    el = document.querySelector(`.item-marker[data-type="serial_killer_slasher_last"][data-index="${index}"]`);
                }
                
                return { el, globalIndex };
            }

            // 隐藏按钮：设置标记透明度为25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
                const img = el.querySelector('img');
                if (img) img.style.opacity = '0.25';
            });

            // 显示按钮：恢复标记透明度为100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
                const img = el.querySelector('img');
                if (img) img.style.opacity = '1';
            });

            // 关闭按钮
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // 左轮寻宝弹窗
        function showTreasureHuntPopup(item, index, subtype) {
            const isRandom = subtype === 'random';
            const title = isRandom ? '🔎 左轮寻宝 - 随机线索' : '🔎 左轮寻宝 - 固定线索';
            const base = isRandom ? 'ls_th_dba_fc' : 'ls_th_dba_ltc';
            const imageUrl = `https://eo-gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index + 1)}.webp`;

            const popup = document.createElement('div');
            popup.className = 'treasure-hunt-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #795548; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 420px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #5D4037;">${title} #${index + 1}</div>
                <div style="margin: 10px 0; padding: 10px; background: #efebe9; border-radius: 8px; color: #4e342e; font-size: 13px; text-align: left; line-height: 1.6;">
                    收到 vanderlinde@eyefind.com 的邮件后，第一条寻宝线索将随机出现在 20 个可能的位置（此处对应 <strong>th1.svg</strong>）之一。您可通过邮件中的黑白照片推断此线索的位置。游戏也会将线索所在的区域标记在地图上。本地图展示的是此线索的准确位置。线索会发出声音以帮助您找到它，您需按 E 对其进行调查。<br><br>
                    找到首条线索后，您还需要寻找剩余三处线索（此处对应 <strong>th2.svg</strong>）。每位玩家都将在相同的位置找到这些线索。所有寻宝线索的任务机制是一致的，您可参照上文的方式寻找这三条线索。<br><br>
                    <strong>奖励：</strong> 集齐所有线索后，游戏中将出现藏有双动式左轮手枪的宝箱。宝箱的准确位置将被标注在游戏内的地图上。使用该武器完成 50 次爆头即可获得 250,000 GTA$、2,000 RP，并于 Red Dead Redemption 2 中解锁此武器的独家变体。
                </div>
                <img src="${imageUrl}" alt="线索图片" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <button id="close-th-btn" style="padding: 10px 18px; background: #795548; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">关闭</button>
            `;

            popup.querySelector('#close-th-btn').addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }
        // 检测幽灵曝光点击（坐标检测）
        function checkGhosts3Click(clickX, clickY) {
            const GHOSTS3_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示幽灵曝光（支持多选）
            if (activeItemTypes.has('ghosts3') && itemData.ghosts3) {
                // 检查点击位置是否在任意幽灵曝光附近
                const nearbyGhost = itemData.ghosts3.find(ghost => {
                    const distance = Math.sqrt(Math.pow(ghost.x - clickX, 2) + Math.pow(ghost.y - clickY, 2));
                    return distance <= GHOSTS3_RADIUS;
                });

                if (nearbyGhost) {
                    // 找到对应的索引
                    const ghostIndex = itemData.ghosts3.findIndex(ghost => 
                        ghost.x === nearbyGhost.x && ghost.y === nearbyGhost.y
                    );
                    showGhosts3Popup(nearbyGhost, ghostIndex);
                }
            }
        }

        // 显示幽灵曝光弹窗
        function showGhosts3Popup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'ghosts3-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #9c27b0;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 420px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 16px; font-size: 22px; font-weight: bold; color: #9c27b0;">👻 幽灵曝光2025 #${index + 1}</div>
                <div style="margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: bold; color: #9c27b0; margin-bottom: 6px; font-size: 14px;">⏰ 出现时间</div>
                    <div style="color: #333; font-size: 16px;">${item.time || '未知时间'}</div>
                </div>
                <div style="margin: 14px 0; padding: 10px; background: #f3e5f5; border-radius: 6px; color: #7b1fa2; font-size: 13px; line-height: 1.6;">
                    • 在指定时间前往该区域寻找幽灵线索<br>
                    • 拍摄照片或观察异常现象（占位说明）
                </div>
                <div style="margin: 12px 0; padding: 8px; background: #fff; border-radius: 6px;">
                    <img src="https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png" alt="占位图片" style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
                <button id="close-ghosts3-popup-btn" style="padding: 10px 20px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">关闭</button>
            `;

            // 关闭按钮
            popup.querySelector('#close-ghosts3-popup-btn').addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);

            document.body.appendChild(popup);
        }
        // 检测帮派攻击点击（坐标检测）
        function checkGangAttackClick(clickX, clickY) {
            const GANG_ATTACK_RADIUS = 100; // 检测半径100单位
            
            // 检查当前是否显示帮派攻击（支持多选）
            if (activeItemTypes.has('gang_attacks') && itemData.gang_attacks) {
                // 检查点击位置是否在任意帮派攻击附近
                const nearbyAttack = itemData.gang_attacks.find((attack, index) => {
                    // 首先检查时间是否匹配
                    if (!isGangAttackActive(attack.time)) {
                        return false;
                    }
                    
                    const distance = Math.sqrt(Math.pow(attack.x - clickX, 2) + Math.pow(attack.y - clickY, 2));
                    return distance <= GANG_ATTACK_RADIUS;
                });

                if (nearbyAttack) {
                    console.log('点击了帮派攻击附近:', nearbyAttack);
                    // 找到对应的索引
                    const attackIndex = itemData.gang_attacks.findIndex(attack => 
                        attack.x === nearbyAttack.x && attack.y === nearbyAttack.y
                    );
                    showGangAttackPopup(nearbyAttack, attackIndex);
                }
            }
        }

        // 显示帮派攻击弹窗
        function showGangAttackPopup(item, index) {
            // 创建弹窗
            const popup = document.createElement('div');
            popup.className = 'gang-attack-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #ff0000;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // 弹窗内容
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #ff0000;">
                    ⚔️ 帮派攻击
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff0000;">
                    <div style="font-weight: bold; color: #ff0000; margin-bottom: 8px; font-size: 16px;">⏰ 时间限制</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.time || '未知时间'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #ffebee; border-radius: 6px; color: #c62828; font-size: 14px; line-height: 1.6;">
                    🎯 <strong>帮派攻击事件</strong><br>
                    • 在指定时间内前往该区域<br>
                    • 与敌对帮派成员战斗<br>
                    • 完成可获得<strong>经验值</strong>和<strong>游戏币奖励</strong><br>
                    • 注意安全，准备充足的武器和弹药！
                </div>
                
                <button id="close-gang-attack-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #ff0000; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;">
                    关闭
                </button>
            `;

            // 添加关闭按钮事件
            const closeBtn = popup.querySelector('#close-gang-attack-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // 点击弹窗外部关闭
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // 使用setTimeout延迟添加document点击事件，避免立即触发
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);

            // 添加到页面
            document.body.appendChild(popup);
        }

        // 显示武器厢型车武器信息
        function showGunVanWeapons() {
            // 加载labels.json数据
            let labelsData = {};
            fetch('./src/data/labels.json')
                .then(response => response.json())
                .then(labels => {
                    labelsData = labels;
                    // 从API动态获取武器信息
                    return fetch('https://api-gta.antwen.com/api/items/gun-van');
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayGunVanWeapons(data.data.message, labelsData);
                    } else {
                        console.error('获取武器厢型车信息失败:', data.error);
                        alert('获取武器信息失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    alert('网络请求失败，请检查网络连接');
                });

            function displayGunVanWeapons(message, labels) {
                // 解析API返回的消息来提取武器信息
                const lines = message.split('\n');
                const weapons = [];
                const throwables = [];
                let currentSection = '';

                lines.forEach(line => {
                    if (line.includes('武器:')) {
                        currentSection = 'weapons';
                    } else if (line.includes('投掷物:')) {
                        currentSection = 'throwables';
                    } else if (line.trim() && line.includes('-')) {
                        const match = line.match(/- (.+?) \((\d+)折\)/);
                        if (match) {
                            // 尝试从labels中查找武器的中文名称
                            let weaponName = match[1];
                            if (labels.hasOwnProperty(weaponName)) {
                                weaponName = labels[weaponName];
                            }
                            
                            const discountText = match[2] + '折';
                            
                            const weaponEntry = {
                                name: weaponName,
                                discountText: discountText
                            };

                            if (currentSection === 'weapons') {
                                weapons.push(weaponEntry);
                            } else if (currentSection === 'throwables') {
                                throwables.push(weaponEntry);
                            }
                        }
                    }
                });

                // 创建弹窗
                const popup = document.createElement('div');
                popup.className = 'gun-van-popup';
                popup.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border: 2px solid #333;
                    border-radius: 8px;
                    padding: 20px;
                    z-index: 1000;
                    max-width: 400px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    font-family: Arial, sans-serif;
                `;

                // 弹窗内容
                popup.innerHTML = `
                    <div style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #333;">
                        🚐 武器厢型车商品信息
                    </div>
                    <div style="margin-bottom: 10px; font-weight: bold; color: #555;">主武器:</div>
                    ${weapons.map(weapon => 
                            `<div style="margin: 5px 0; color: #666;">
                                ${weapon.name} - <span style="color: #e74c3c;">${weapon.discountText}</span>
                            </div>`
                        ).join('')}
                        <div style="margin: 10px 0; font-weight: bold; color: #555;">投掷武器:</div>
                        ${throwables.map(throwable => 
                            `<div style="margin: 5px 0; color: #666;">
                                ${throwable.name} - <span style="color: #e74c3c;">${throwable.discountText}</span>
                            </div>`
                        ).join('')}
                        <div style="margin-top: 15px; color: #666;">
                            防弹衣: <span style="color: #e74c3c;">9折</span>
                        </div>
                    <button id="close-popup-btn" 
                            style="margin-top: 15px; padding: 8px 16px; 
                                   background: #e74c3c; color: white; 
                                   border: none; border-radius: 4px; 
                                   cursor: pointer;">
                        关闭
                    </button>
                `;

                // 添加关闭按钮事件监听
                const closeBtn = popup.querySelector('#close-popup-btn');
                closeBtn.addEventListener('click', () => {
                    popup.remove();
                });

                // 添加到页面
                document.body.appendChild(popup);

                // 点击弹窗外部关闭
                popup.addEventListener('click', (e) => e.stopPropagation());
                
                // 使用setTimeout延迟添加document点击事件，避免立即触发
                setTimeout(() => {
                    const closePopupHandler = (e) => {
                        if (!popup.contains(e.target)) {
                            popup.remove();
                            document.removeEventListener('click', closePopupHandler);
                        }
                    };
                    document.addEventListener('click', closePopupHandler);
                }, 100);
            }
        }

        // 显示街头毒贩信息
        function showStreetDealersInfo() {
            // 从API动态获取街头毒贩信息
            fetch('https://api-gta.antwen.com/api/items/street-dealers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStreetDealersInfo(data.data.message);
                    } else {
                        console.error('获取街头毒贩信息失败:', data.error);
                        alert('获取街头毒贩信息失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    alert('网络请求失败，请检查网络连接');
                });

            function displayStreetDealersInfo(message) {
                // 创建弹窗
                const popup = document.createElement('div');
                popup.className = 'street-dealers-popup';
                popup.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border: 2px solid #333;
                    border-radius: 8px;
                    padding: 20px;
                    z-index: 1000;
                    max-width: 500px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    font-family: Arial, sans-serif;
                    max-height: 80vh;
                    overflow-y: auto;
                `;

                // 弹窗内容
                popup.innerHTML = `
                    <div style="margin-bottom: 15px; font-size: 18px; font-weight: bold; color: #333;">
                        💊 街头毒贩商品信息
                    </div>
                    <div style="white-space: pre-line; line-height: 1.5; color: #666;">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    <button id="close-popup-btn" 
                            style="margin-top: 15px; padding: 8px 16px; 
                                   background: #e74c3c; color: white; 
                                   border: none; border-radius: 4px; 
                                   cursor: pointer;">
                        关闭
                    </button>
                `;

                // 添加关闭按钮事件监听
                const closeBtn = popup.querySelector('#close-popup-btn');
                closeBtn.addEventListener('click', () => {
                    popup.remove();
                });

                // 添加到页面
                document.body.appendChild(popup);

                // 点击弹窗外部关闭
                popup.addEventListener('click', (e) => e.stopPropagation());
                
                // 使用setTimeout延迟添加document点击事件，避免立即触发
                setTimeout(() => {
                    const closePopupHandler = (e) => {
                        if (!popup.contains(e.target)) {
                            popup.remove();
                            document.removeEventListener('click', closePopupHandler);
                        }
                    };
                    document.addEventListener('click', closePopupHandler);
                }, 100);
            }
        }

        // 初始加载
        map.whenReady(() => {
            updateTilePanePosition();
            updateOriginMarker();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            loadItemData().then(() => {
                console.log('物品数据加载完成');
            });
            
            // 初始化车行标记
            initDealershipMarkers();
            
            // 初始化游戏时间和天气显示
            initGameTimeWeatherDisplay();
        });

        window.addEventListener('resize', () => {
            resetViewForZoom(map.getZoom());
            updateTilePanePosition();
        });

        // 瓦片文件检测（保持原逻辑）
        async function probeTilesForStyleAndZoom(style, zoom) {
            // ... 原有代码保持不变
        }

        // 根据地图样式设置背景色
        function setBackgroundColorByStyle(style) {
            const backgroundColorMap = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            document.body.style.backgroundColor = backgroundColorMap[style] || '#1a1a1a';
        }
        
        // 样式选择事件
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            tileLayer.redraw();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            setBackgroundColorByStyle(currentStyle);
        });
        
        // 初始化背景色
        setBackgroundColorByStyle(currentStyle);

            // 初始化物品信息弹窗样式（覆盖默认样式）
            function initItemInfoTextStyles() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.display = 'none'; // 确保初始状态是隐藏的
            }

            // 显示物品信息（文本版）
            function showItemInfoText(title, coords, location, details) {
                const itemInfo = document.getElementById('item-info');
                document.getElementById('item-title').textContent = title;
                document.getElementById('item-coords').textContent = `坐标: ${coords}`;
                document.getElementById('item-location').textContent = `位置: ${location}`;
                document.getElementById('item-details').textContent = `详细信息: ${details}`;
                
                // 添加显示动画
                itemInfo.style.display = 'block';
                itemInfo.style.opacity = '0';
                itemInfo.style.transition = 'opacity 0.3s ease';
                
                // 使用setTimeout触发重排和过渡动画
                setTimeout(() => {
                    itemInfo.style.opacity = '1';
                }, 10);
            }

            // 隐藏物品信息（文本版）
            function hideItemInfoText() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.opacity = '0';
                
                // 等待淡出动画完成后隐藏元素
                setTimeout(() => {
                    itemInfo.style.display = 'none';
                }, 300);
            };

            // 初始化物品信息弹窗样式（文本版）
            initItemInfoTextStyles();

        // 初始探测
        setTimeout(() => {
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
        }, 300);

        // 移动端菜单交互（“更多”按钮）
        (function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            if (!mobileMenuToggle || !mobileMenu) return;

            mobileMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('show');
            });

            // 点击其他地方关闭菜单
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && e.target !== mobileMenuToggle) {
                    mobileMenu.classList.remove('show');
                }
            });
        })();

        // 检查帮派攻击时间是否匹配
        function isGangAttackActive(timeRange) {
            try {
                // 获取当前游戏时间
                const timestamp = Math.floor(Date.now() / 1000);
                const currentHour = Math.floor(timestamp / 120) % 24;
                const currentMinute = Math.floor(timestamp / 2) % 60;
                const currentTime = currentHour * 60 + currentMinute; // 转换为分钟
                
                // 解析时间范围 "04:00 - 12:00"
                const [startTime, endTime] = timeRange.split(' - ');
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                const startTimeMinutes = startHour * 60 + startMinute;
                const endTimeMinutes = endHour * 60 + endMinute;
                
                // 检查当前时间是否在范围内
                if (startTimeMinutes <= endTimeMinutes) {
                    // 正常范围，如 04:00 - 12:00
                    return currentTime >= startTimeMinutes && currentTime <= endTimeMinutes;
                } else {
                    // 跨天范围，如 22:00 - 06:00
                    return currentTime >= startTimeMinutes || currentTime <= endTimeMinutes;
                }
            } catch (error) {
                console.error('检查帮派攻击时间失败:', error);
                return false;
            }
        }

        // 游戏时间和天气显示功能
        function initGameTimeWeatherDisplay() {
            // 简化样式创建，因为我们已经在头部定义了样式

            // 创建显示元素
            const displayElement = document.createElement('div');
            displayElement.id = 'game-time-weather';
            displayElement.className = 'nav-weather';
            displayElement.innerHTML = '<span style="color: white;">🕐 加载中...</span>';
            // 默认放在地图容器的右上角（会在初始化时移动到合适位置）
            document.getElementById('map-container').appendChild(displayElement);

            // 如果是移动端（宽度 <= 768px），把时间天气移动到移动菜单里，避免底部空白
            function placeGameTimeWeatherForMobile() {
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile) {
                    // 在移动端，把时间/天气放在标题右边（h1.gta-title 之后），并强制可见样式
                    const navLeft = document.querySelector('.gta-nav .nav-left');
                    if (navLeft) {
                        const titleEl = navLeft.querySelector('h1.gta-title');
                        if (titleEl) {
                            // 无论之前在哪，都把元素移到标题后面
                            if (displayElement.parentElement) displayElement.parentElement.removeChild(displayElement);
                            titleEl.insertAdjacentElement('afterend', displayElement);
                            // 强制样式以确保可见
                            displayElement.style.display = 'inline-flex';
                            displayElement.style.alignItems = 'center';
                            displayElement.style.marginLeft = '8px';
                            displayElement.style.color = 'white';
                            displayElement.style.fontSize = '13px';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0 6px';
                        }
                    }
                } else {
                    // 桌面端：放在 nav-links 中的“在线文件”之后（如果存在）
                    const navLinks = document.querySelector('.gta-nav .nav-left .nav-links');
                    if (navLinks) {
                        // 找到第二个链接（在线文件）并在其后插入显示元素
                        const anchors = navLinks.querySelectorAll('a');
                        const target = anchors[1] || navLinks.lastElementChild;
                        if (target && !navLinks.contains(displayElement)) {
                            // 恢复样式为内联菜单项
                            displayElement.style.position = '';
                            displayElement.style.bottom = '';
                            displayElement.style.right = '';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0';
                            displayElement.style.border = 'none';
                            displayElement.style.boxShadow = 'none';
                            displayElement.style.minWidth = '0';
                            displayElement.style.textAlign = 'left';
                            target.insertAdjacentElement('afterend', displayElement);
                        }
                    } else {
                        // 回退：放回 map-container
                        const container = document.getElementById('map-container');
                        if (!container.contains(displayElement)) container.appendChild(displayElement);
                    }
                }
            }

            // 获取并显示游戏时间和天气
            function updateGameTimeWeather() {
                try {
                    // 定义天气映射表和星期表
                    const WEATHERS = {
                      0: '☁️多云', 4: '🌫️薄雾', 7: '⛅大部多云', 11: '☀️晴朗', 14: '🌫️薄雾', 16: '☀️晴朗',
                      28: '🌫️薄雾', 31: '☀️晴朗', 41: '🌁阴霾', 45: '☁️多云', 52: '🌫️薄雾', 55: '☁️多云',
                      62: '🌁雾天', 66: '☁️多云', 72: '☁️多云', 78: '🌁雾天', 82: '☁️多云', 92: '🌤️大部晴朗',
                      104: '☁️多云', 105: '🌦️毛毛雨', 108: '☁️多云', 125: '🌫️薄雾', 128: '☁️多云',
                      131: '🌧️下雨', 134: '🌦️毛毛雨', 137: '☁️多云', 148: '🌫️薄雾', 151: '⛅大部多云',
                      155: '🌁雾天', 159: '☀️晴朗', 176: '🌤️大部晴朗', 196: '🌁雾天', 201: '☁️多云',
                      220: '🌫️薄雾', 222: '🌤️大部晴朗', 244: '🌫️薄雾', 246: '🌤️大部晴朗', 247: '🌧️下雨',
                      250: '🌦️毛毛雨', 252: '☁️多云', 268: '🌫️薄雾', 270: '☁️多云', 272: '☁️多云',
                      277: '☁️多云', 292: '🌫️薄雾', 295: '☁️多云', 300: '⛅大部多云',
                      306: '☁️多云', 318: '⛅大部多云', 330: '☁️多云', 337: '☀️晴朗',
                      367: '☁️多云', 369: '🌧️下雨', 376: '🌦️毛毛雨', 377: '☁️多云'
                    };
                    
                    const WEEKDAYS = {
                      0: '星期日', 1: '星期一', 2: '星期二', 3: '星期三', 4: '星期四', 5: '星期五', 6: '星期六'
                    };
                    
                    // 获取星期几
                    function getWeekday() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weekday_correction = Math.floor(timestamp / (365 * 2880)) % 7;
                      const weekdayIdx = Math.floor(timestamp / 2880 + 2 - weekday_correction) % 7;
                      return WEEKDAYS[weekdayIdx];
                    }
                    
                    // 获取小时和分钟
                    function getHourAndMinute() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const hour = Math.floor(timestamp / 120) % 24;
                      const minute = Math.floor(timestamp / 2) % 60;
                      const formatted_hour = hour < 10 ? '0' + hour : hour.toString();
                      const formatted_minute = minute < 10 ? '0' + minute : minute.toString();
                      return `${formatted_hour}:${formatted_minute}`;
                    }
                    
                    // 获取天气详情
                    function getWeatherDetail() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weather_period = timestamp / 120 % 384;
                      const periods = Object.keys(WEATHERS).map(Number).sort((a, b) => a - b);

                      // 当前天气
                      let currIdx = 0;
                      for (let i = periods.length - 1; i >= 0; i--) {
                        if (periods[i] <= weather_period) {
                          currIdx = i;
                          break;
                        }
                      }
                      const currPeriod = periods[currIdx];
                      const currWeather = WEATHERS[currPeriod];

                      return currWeather;
                    }
                    
                    // 本地计算游戏时间和天气
                    const weekday = getWeekday();
                    const time = getHourAndMinute();
                    const weatherDetail = getWeatherDetail();
                    
                    // 根据天气设置emoji
                    let weatherEmoji = '🌤️';
                    const weather = weatherDetail.toLowerCase();
                    if (weather.includes('雨') || weather.includes('毛毛雨')) {
                        weatherEmoji = '🌧️';
                    } else if (weather.includes('雷') || weather.includes('thunder')) {
                        weatherEmoji = '⛈️';
                    } else if (weather.includes('雾') || weather.includes('霾')) {
                        weatherEmoji = '🌫️';
                    } else if (weather.includes('阴') || weather.includes('cloud') || weather.includes('多云')) {
                        weatherEmoji = '☁️';
                    } else if (weather.includes('晴') || weather.includes('clear') || weather.includes('sun') || weather.includes('晴朗')) {
                        weatherEmoji = '☀️';
                    }

                    // 平滑更新文本：避免改变背景透明度以防止闪烁
                    const newText = `${weekday} ${time} ${weatherEmoji}`;
                    const safeHtml = `<span style="color:white">${newText}</span>`;
                    if (displayElement.innerHTML !== safeHtml) {
                        // 使用 innerHTML 且带样式，确保在导航上的可见性
                        displayElement.innerHTML = safeHtml;
                    }
                } catch (error) {
                    displayElement.textContent = '❌ 计算失败';
                    console.error('计算游戏时间和天气信息失败:', error);
                }
            }

            // 初始加载
            updateGameTimeWeather();
            // 放置到合适的位置（基于当前屏幕宽度）
            placeGameTimeWeatherForMobile();
            // 强制刷新文本和可见性以防止第一次未显示
            try { updateGameTimeWeather(); if (displayElement) { displayElement.style.display = 'inline-flex'; displayElement.style.color='white'; } } catch(e) {}
            // 在窗口大小变化时调整位置
            window.addEventListener('resize', placeGameTimeWeatherForMobile);
            // 现实5秒等于游戏内1分钟，每5秒更新一次
            setInterval(updateGameTimeWeather, 1000);
            
            // 每30秒更新一次帮派攻击显示状态
            setInterval(() => {
                if (activeItemTypes.has('gang_attacks')) {
                    updateItemMarkers(); // 帮派攻击需要重新创建标记
                }
            }, 30000);
        }

        // 佩里科岛样式：侧边栏折叠/缩放按钮与多选样式/重置行为
        (function initCayoStyleControls() {
            const panelToggle = document.getElementById('panel-toggle');
            const sidePanel = document.getElementById('side-panel');
            if (panelToggle && sidePanel) {
                panelToggle.addEventListener('click', () => {
                    sidePanel.classList.toggle('collapsed');
                    const icon = panelToggle.querySelector('i');
                    if (sidePanel.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-left');
                    }
                });
                // 额外监听，覆盖可能的事件冒泡/阻止问题
                panelToggle.addEventListener('touchstart', (ev) => {
                    ev.preventDefault();
                    panelToggle.click();
                });
            }

            // 缩放按钮绑定
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => map.zoomIn());
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => map.zoomOut());

            // 使用静态选项数组生成侧边栏多选项
            const sidebarContainer = document.getElementById('sidebar-item-selectors');
            if (sidebarContainer) {
                sidebarItemOptions.forEach(opt => {
                    const type = opt.value;
                    // 包裹一层，便于样式控制
                    const wrapper = document.createElement('div');
                    wrapper.className = 'item-checkbox-wrapper';

                    // 复选框
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.className = 'item-checkbox';
                    chk.dataset.itemType = type;
                    chk.id = `sidebar-item-${type}`;

                    // label
                    const label = document.createElement('label');
                    label.setAttribute('for', chk.id);
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';

                    // 图标
                    if (type !== 'dealerships' && type !== 'gang_attacks') {
                        let iconSrc = null;
                        // 优先使用菜单配置中的icon属性
                        if (opt.icon) {
                            iconSrc = opt.icon;
                        } else if (typeof itemIcons !== 'undefined' && itemIcons[type]) {
                            iconSrc = itemIcons[type];
                        }
                        
                        if (iconSrc) {
                        const ico = document.createElement('img');
                            ico.src = iconSrc;
                        ico.alt = '';
                        ico.className = 'item-icon';
                            ico.style.width = '16px';
                            ico.style.height = '16px';
                        label.appendChild(ico);
                        }
                    }

                    // 文本
                    const span = document.createElement('span');
                    span.textContent = opt.text;
                    label.appendChild(span);

                    wrapper.appendChild(chk);
                    wrapper.appendChild(label);
                    sidebarContainer.appendChild(wrapper);

                    // 变更时更新显示的 markers
                    chk.addEventListener('change', (e) => {
                        const t = e.target.dataset.itemType;
                        if (e.target.checked) {
                            activeItemTypes.add(t);
                        } else {
                            activeItemTypes.delete(t);
                        }

                        if (activeItemTypes.size > 0) {
                            updateItemMarkers(); // 物品选择变化时需要重新创建标记
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        } else {
                            clearAllItemMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        }
                    });
                });
            }

            // 重置按钮
            const resetBtn = document.getElementById('reset-checkboxes');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = false);
                    // 清空所有 item markers
                    clearAllItemMarkers();
                    // 清空 activeItemTypes，确保重置后不会在后续操作中重新显示已取消的类型
                    try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                    // 同步更新车行标记（全部隐藏）并刷新 tilePane 位置
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                });
            }
        })();

        // 额外保障：全局监听，用于点击侧边栏外部时自动收起侧边栏（避免与按钮的双重触发冲突）
        document.addEventListener('click', (e) => {
            const sidePanel = document.getElementById('side-panel');
            if (!sidePanel) return;
            // 如果点击了折叠按钮本身，交由按钮的事件处理器处理，避免双重切换
            if (e.target.closest && e.target.closest('.side-panel-toggle')) return;
            // 如果当前未折叠，且点击目标位于侧边栏外部，则折叠侧边栏
            if (!sidePanel.classList.contains('collapsed') && !sidePanel.contains(e.target)) {
                sidePanel.classList.add('collapsed');
                // 更新按钮图标（如果存在）
                const toggleBtn = document.querySelector('.side-panel-toggle');
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    }
                }
            }
        });

        // 辅助：清除特定类型的 item markers（支持 itemMarkers 为 {type,index,el} 结构）
        function clearItemMarkersOfType(type) {
            if (!itemMarkers || itemMarkers.length === 0) return;
            // 过滤并移除对应类型的 DOM 元素
            const remaining = [];
            itemMarkers.forEach(m => {
                if (m && ((m.type && m.type === type) || (!m.type && m.dataset && m.dataset.type === type))) {
                    // m 可能是对象 {type,index,el} 或老式 DOM 元素
                    const el = m.el ? m.el : m;
                    if (el && el.remove) el.remove();
                } else {
                    remaining.push(m);
                }
            });
            itemMarkers = remaining;
            // 不再重置 currentItemType，这样在 multi-select 场景下不会意外清空单选状态
        }

        // 清除所有 item markers
        function clearAllItemMarkers() {
            if (!itemMarkers || itemMarkers.length === 0) return;
            itemMarkers.forEach(m => {
                const el = m && m.el ? m.el : m;
                if (el && el.remove) el.remove();
            });
            itemMarkers = [];
            // 保持 currentItemType 不变，这里只清理可视标记
        }



        // 保证侧边栏内容在移动端可滚动且滚动时不触发地图拖动
        document.addEventListener('DOMContentLoaded', function() {
            const sidePanelContent = document.querySelector('.side-panel-content');
            if (sidePanelContent) {
                // 优化 CSS：启用原生平滑滚动（iOS）
                sidePanelContent.style.webkitOverflowScrolling = 'touch';
                sidePanelContent.style.touchAction = 'pan-y';

                // 鼠标滚轮（桌面）滚动时阻止事件冒泡到地图
                sidePanelContent.addEventListener('wheel', function(e) {
                    const atTop = sidePanelContent.scrollTop === 0;
                    const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                    if ((e.deltaY < 0 && !atTop) || (e.deltaY > 0 && !atBottom)) {
                        e.stopPropagation();
                    }
                }, { passive: false });

                // 移动端触摸处理：检测垂直滑动并阻止冒泡，从而避免地图响应
                let startY = 0;
                let startX = 0;
                let isScrolling = undefined;

                sidePanelContent.addEventListener('touchstart', function(e) {
                    if (e.touches && e.touches.length === 1) {
                        startY = e.touches[0].clientY;
                        startX = e.touches[0].clientX;
                        isScrolling = undefined; // 未确定方向
                    }
                }, { passive: true });

                sidePanelContent.addEventListener('touchmove', function(e) {
                    if (!(e.touches && e.touches.length === 1)) return;
                    const curY = e.touches[0].clientY;
                    const curX = e.touches[0].clientX;
                    const dy = Math.abs(curY - startY);
                    const dx = Math.abs(curX - startX);

                    if (typeof isScrolling === 'undefined') {
                        isScrolling = dy > dx; // 如果垂直位移大于水平位移，判定为滚动
                    }

                    if (isScrolling) {
                        // 当面板可以继续滚动时，阻止事件冒泡到地图
                        const atTop = sidePanelContent.scrollTop === 0;
                        const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                        const movingUp = (curY - startY) > 0;
                        const movingDown = !movingUp;

                        // 如果尚未到达边界，则阻止冒泡（允许容器内部滚动）
                        if ((movingUp && !atTop) || (movingDown && !atBottom)) {
                            e.stopPropagation();
                            // 不调用 preventDefault：允许滚动发生，同时阻止地图捕获
                        }
                    }
                }, { passive: false });

                // 清理状态
                sidePanelContent.addEventListener('touchend', function() {
                    isScrolling = undefined;
                });
            }
        });
    </script>

    <script>
        // 强制在支持的浏览器上阻止手势缩放（iOS 的 gesture events）
        (function preventPinchZoom() {
            // Prevent iOS gesture events
            function stopEvent(e) { e.preventDefault(); }
            try {
                document.addEventListener('gesturestart', stopEvent, { passive: false });
                document.addEventListener('gesturechange', stopEvent, { passive: false });
                document.addEventListener('gestureend', stopEvent, { passive: false });
            } catch (err) {
                // 某些浏览器不支持 gesture* 事件，忽略错误
            }

            // Prevent pinch-zoom via two-finger touchmove
            document.addEventListener('touchstart', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent double-tap zoom (by blocking very quick successive touchend)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            // Prevent zooming with Ctrl + wheel (desktop/tablet)
            window.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
        })();
    </script>

</body>
</html>
