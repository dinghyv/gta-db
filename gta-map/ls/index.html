
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GTAåœ°å›¾ - æ´›åœ£éƒ½</title>
    
    <!-- Base URL for relative paths -->
    <base href="/">
        <!-- FontAwesome 6 Free for custom checkbox icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />

    <style>
        /* CSSå˜é‡ç³»ç»Ÿ - å®šä¹‰GTAé£æ ¼çš„è“è‰²ä¸»é¢˜ */
        :root {
            --gta-bg-dark: #0a1929;
            --gta-bg-medium: rgba(15, 25, 35, 0.95);
            --gta-bg-light: rgba(25, 40, 55, 0.7);
            --gta-primary: #1976d2;
            --gta-primary-glow: rgba(25, 118, 210, 0.7);
            --gta-secondary: #2196f3;
            --gta-border: #2e5c8a;
            --gta-border-light: #4a90e2;
            --gta-text: #ffffff;
            --gta-text-secondary: #b3d9ff;
            --gta-accent: #42a5f5;
            /* å…¼å®¹å˜é‡æ˜ å°„ï¼Œä¾›ä½©é‡Œç§‘æ ·å¼å¤ç”¨ï¼ˆè“è‰²ä¸»é¢˜ï¼‰ */
            --bg-darker: var(--gta-bg-medium);
            --primary-color: var(--gta-primary);
            --primary-dark: #145a9e;
            --accent-color: var(--gta-accent);
            --border-color: var(--gta-border);
            --text-secondary: var(--gta-text-secondary);
            --transition: all 0.15s ease;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--gta-bg-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* ç¦æ­¢ç§»åŠ¨ç«¯ç¼©æ”¾ï¼ˆæåˆ/åŒå‡»ï¼‰ */
            touch-action: manipulation; /* é™åˆ¶æ‰‹åŠ¿ä¸ºåŸºæœ¬äº¤äº’ï¼Œé˜»æ­¢åŒæŒ‡ç¼©æ”¾ */
            -ms-touch-action: manipulation;
            -webkit-text-size-adjust: 100%; /* é˜²æ­¢ iOS åŒå‡»æ”¾å¤§æ–‡æœ¬ */
        }

        /* éšè—æ•´ä½“é¡µé¢çš„æ»šåŠ¨æ¡ï¼ˆå³ä¾§å’Œåº•éƒ¨ï¼‰ï¼Œä½†ä¸å½±å“å†…éƒ¨å¯æ»šåŠ¨é¢æ¿æ ·å¼ */
        html, body {
            overflow: hidden; /* éšè—å…¨å±€æ»šåŠ¨ */
        }

        /* WebKit æµè§ˆå™¨éšè—æ»šåŠ¨æ¡è½¨é“ï¼Œä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ï¼ˆç”¨äºå†…éƒ¨æ»šåŠ¨å®¹å™¨ï¼‰ */
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* Firefox éšè—æ»šåŠ¨æ¡ï¼ˆä»å¯æ»šåŠ¨ï¼‰ */
        html, body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }

        /* ä¸»å®¹å™¨ */
        #map-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
            overflow: visible !important;
        }
        #map-container:active { cursor: grabbing; }

        /* #tile-pane å·²åºŸå¼ƒï¼ˆDOM æ ‡è®°å±‚å·²ç§»é™¤ï¼‰ */

        /* éšè—åœ°å›¾ä¸Šçš„æ¸¸æˆåŸç‚¹æ˜¾ç¤ºï¼ˆè‹¥å­˜åœ¨ï¼‰ */
        #origin-marker {
            display: none !important;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gta-text);
            background: var(--gta-bg-medium);
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 800;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
            pointer-events: none;
            border: 1px solid var(--gta-border);
        }
        .loader.visible { opacity: 1; pointer-events: auto; }

        /* æ–‡ä»¶è¯†åˆ«çŠ¶æ€ */
        #file-status {
            position: absolute;
            left: 15px;
            top: 15px;
            background: rgba(0,0,0,0.7);
            color: var(--gta-text);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
            z-index: 750;
            font-size: 13px;
            pointer-events: none;
            min-width: 180px;
        }
        #file-status.ok { background: rgba(21,128,61,0.9); }
        #file-status.warn { background: rgba(170,85,0,0.9); }
        #file-status.err { background: rgba(128,20,20,0.9); }

        /* ç‰©å“æ ‡è®°æ ·å¼ï¼ˆå·²åºŸå¼ƒï¼ŒDOM æ ‡è®°å·²ç§»é™¤ï¼‰ */

        /* ä½©é‡Œç§‘å²›é£æ ¼ï¼šç‰©å“é€‰æ‹©å™¨ï¼ˆè“è‰²ä¸»é¢˜ï¼‰ */
        .item-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .item-checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            width: 100%;
        }

        .item-checkbox {
            display: none;
        }

        /* éšè—åŸç”Ÿå¤é€‰ï¼Œä½¿ç”¨ç´§å‡‘çš„ label åšæ›¿ä»£ */
        .item-checkbox + label {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
            width: 100%;
            color: var(--gta-text);
            gap: 4px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            /* æ”¾åœ¨æ ‡é¢˜åé¢æ˜¾ç¤ºï¼Œä¸å†éœ€è¦é¢å¤–å·¦è¾¹è· */
            margin-left: 0;
            align-items: center;
        }

        .nav-links a {
            color: white; /* é“¾æ¥å­—ä½“æ”¹ä¸ºç™½è‰² */
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        /* å½“æ—¶é—´/å¤©æ°”ä½äºå¯¼èˆªé“¾æ¥æ—æ—¶çš„å¾®è°ƒæ ·å¼ */
        .gta-nav .nav-left #game-time-weather {
            margin-left: 8px;
            font-size: 13px;
            opacity: 0.95;
            color: rgba(255,255,255,0.95);
            pointer-events: none;
        }

        .gta-nav .nav-left .nav-weather {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            color: white !important;
            font-size: 13px;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .gta-nav .nav-left #game-time-weather {
                margin-left: 10px;
                display: inline-flex !important;
                align-items: center;
                color: white !important;
            }
        }

        /* å¼ºè¦†ç›–ï¼Œä¿è¯ç§»åŠ¨ç«¯/å¯¼èˆªå†…å§‹ç»ˆå¯è§ */
        .gta-nav .nav-left #game-time-weather {
            display: inline-flex !important;
            align-items: center !important;
            color: white !important;
        }

        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        /* ç§»åŠ¨ç«¯å¼ºåˆ¶è¦†ç›–ï¼šç¡®ä¿æ ‡é¢˜å·¦å¯¹é½ï¼Œä¸è¢«åç»­å…¨å±€è§„åˆ™å½±å“ */
        @media (max-width: 768px) {
            .gta-nav .nav-left {
                flex: 0 0 auto !important;
                flex-grow: 0 !important;
                justify-content: flex-start !important;
            }
            .gta-nav .nav-right {
                margin-left: auto !important;
            }
            .gta-title { text-align: left !important; }
        }

        .nav-buttons-desktop {
            display: flex;
            gap: 15px;
        }

        /* ç§»åŠ¨ç«¯æ ·å¼ */
        .nav-buttons-mobile {
            display: none;
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆªï¼šä»…æ˜¾ç¤ºæ ‡é¢˜ä¸â€œæ›´å¤šâ€æŒ‰é’®ï¼Œå…¶ä½™é“¾æ¥æ”¾å…¥ä¸‹æ‹‰èœå• */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .nav-buttons-desktop { display: none; }
            .nav-buttons-mobile { display: block; }
            .gta-nav { padding: 8px 12px; }
            .gta-title { font-size: 18px; padding: 6px 10px; }

            /* ä¿æŒå¯¼èˆªæ åœ¨ä¸€è¡Œ */
            .gta-nav { flex-wrap: nowrap; align-items: center; }
            .gta-title { white-space: nowrap; }
            /* å·¦ä¾§æ ‡é¢˜å›ºå®šå®½åº¦ï¼Œä¸å æ»¡å‰©ä½™ç©ºé—´ */
            .nav-left { flex: 0 0 auto; display: flex; align-items: center; gap: 8px; }
            /* å³ä¾§é å³æ˜¾ç¤ºï¼Œä¿æŒä¸ºå†…è”æ¨ªå‘å¸ƒå±€ */
            .nav-right { flex: 0 0 auto; margin-left: auto; display: flex; align-items: center; }
            .nav-buttons-mobile { display: flex; align-items: center; }
            .menu-toggle { white-space: nowrap; }

            .mobile-menu {
                display: none;
                position: absolute;
                top: 56px;
                right: 12px;
                /* Use same visual style as the title bar for consistency */
                background: linear-gradient(90deg, rgba(10, 25, 41, 0.95) 0%, rgba(25, 118, 210, 0.95) 100%);
                border: 1px solid #42a5f5;
                padding: 10px;
                border-radius: 8px;
                z-index: 1100;
                box-shadow: 0 8px 22px rgba(20,30,50,0.5);
                flex-direction: column;
                gap: 8px;
                min-width: 160px;
                backdrop-filter: blur(6px);
            }

            .mobile-menu.show { display: flex; }

            .mobile-menu .nav-button,
            .mobile-menu .nav-link {
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(255,255,255,0.06);
                color: white;
                padding: 8px 10px;
                border-radius: 8px;
                text-decoration: none;
                border: none;
                cursor: pointer;
            }

            .menu-toggle {
                background: rgba(255,255,255,0.06);
                color: white;
                border: 1px solid rgba(255,255,255,0.08);
                padding: 8px 12px;
                border-radius: 14px;
                cursor: pointer;
                font-size: 14px;
            }
        }

        .item-checkbox + label:before {
            /* ä½¿ç”¨ FontAwesome çš„æ–¹æ¡†å›¾æ ‡ä½œä¸ºå ä½ï¼ˆå›é€€ï¼‰ */
            content: "\f0c8";
            font-family: "Font Awesome 6 Free";
            margin-right: 4px;
            color: var(--text-secondary);
            transition: var(--transition);
            font-weight: 900;
            font-size: 16px;
            display: inline-block;
            width: 16px;
            text-align: center;
        }

        .item-checkbox:checked + label {
            background: var(--primary-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--gta-primary-glow);
        }

        .item-checkbox:checked + label:before {
            content: "\f14a"; /* FontAwesome checked */
            color: var(--accent-color);
        }

        .item-checkbox + label:hover {
            border-color: var(--primary-color);
            background: rgba(25,118,210,0.12);
        }

        .item-icon {
            width: 16px;
            height: 16px;
            margin-right: 0;
            display: inline-block;
            object-fit: contain;
        }

        /* æœç´¢æ¡†æ ·å¼ï¼ˆåŒ¹é…ä¾§è¾¹æ é£æ ¼ï¼‰ */
        .item-search-wrapper input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            display: block;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: var(--transition);
        }
        .item-search-wrapper input[type="text"]:focus {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        /* åˆ†ç»„æ ‡é¢˜æ ·å¼ */
        .item-group-title {
            margin: 8px 0 6px 0;
            font-size: 12px;
            color: var(--gta-accent);
            text-transform: uppercase;
            opacity: 0.9;
        }

        /* å¯æŠ˜å åˆ†ç»„å¤´éƒ¨ä¸å†…å®¹ */
        .item-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 6px 0;
            font-size: 12px;
            color: var(--gta-accent);
            text-transform: uppercase;
            opacity: 0.95;
            cursor: pointer;
            user-select: none;
        }
        .item-group-header .chevron {
            color: var(--gta-text-secondary);
            transition: transform 0.15s ease;
        }
        .item-group-content.collapsed { display: none; }

        /* GTAé£æ ¼å¯¼èˆªæ  - ä½©é‡Œç§‘å²›é£æ ¼è“è‰²ä¸»é¢˜ */
        .gta-nav {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(10, 25, 41, 0.7) 0%, rgba(25, 118, 210, 0.7) 100%);
            border-bottom: 2px solid #42a5f5;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .gta-nav .nav-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-grow: 1;
        }

        .gta-title {
            font-family: 'Impact', sans-serif;
            color: white;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin: 0;
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .gta-title i {
            margin-right: 8px;
            color: var(--gta-primary);
        }

        .gta-nav .nav-right {
            display: flex;
            gap: 15px;
        }

        .nav-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:hover {
            background: var(--gta-primary);
            color: var(--gta-bg-dark);
            box-shadow: 0 0 15px var(--gta-primary-glow);
            transform: translateY(-1px);
        }

        .nav-button.back-button {
            background: var(--gta-secondary);
            border-color: var(--gta-secondary);
        }

        /* ä¾§è¾¹æ ï¼ˆä½©é‡Œç§‘å²›æ ·å¼ï¼‰ */
        .side-panel {
            position: absolute;
            top: 80px;
            left: 10px;
            width: 320px;
            max-height: calc(100% - 120px);
            background: linear-gradient(180deg, rgba(10,20,30,0.85), rgba(15,25,35,0.9));
            border: 1px solid var(--gta-border);
            border-radius: 10px;
            color: var(--gta-text);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
        }

        .side-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .side-panel-title {
            font-weight: bold;
            color: var(--gta-text);
            font-size: 14px;
            text-transform: uppercase;
        }

        .side-panel-content {
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
            scrollbar-width: thin;
        }

        /* è“è‰²è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼ˆwebkitï¼‰ */
        .side-panel-content::-webkit-scrollbar {
            width: 8px;
            background: rgba(25, 118, 210, 0.08);
        }
        .side-panel-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #42a5f5 0%, #1976d2 100%);
            border-radius: 6px;
        }
        .side-panel-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1976d2 0%, #42a5f5 100%);
        }
        /* Firefox */
        .side-panel-content {
            scrollbar-color: #42a5f5 rgba(25, 118, 210, 0.08);
            scrollbar-width: thin;
        }

        .side-panel-section { margin-bottom: 14px; }
        .side-panel-section-title { font-size: 13px; color: var(--gta-accent); margin-bottom: 8px; }

        /* item selector */
        .item-selector-container { display:flex; flex-direction:column; gap:6px; }
        .item-checkbox + label { display:flex; align-items:center; gap:8px; padding:8px; background: rgba(255,255,255,0.02); border-radius:6px; cursor:pointer; }

        /* éšè—é»˜è®¤ leaflet ç¼©æ”¾æ§ä»¶ */
        .leaflet-control-zoom { display: none; }

        /* åº•éƒ¨ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 7px; /* æ”¾å¤§ 1/3ï¼ˆ5px -> 7pxï¼‰ */
            background: rgba(10,20,30,0.85);
            padding: 5px; /* 4px -> 5px */
            border-radius: 13px; /* 10px -> 13px */
            border: 1px solid var(--gta-border);
            box-shadow: 0 6px 14px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* æŠ˜å çŠ¶æ€æ ·å¼ï¼šå½“é¢æ¿æ·»åŠ  .collapsed æ—¶æ”¶èµ·å†…å®¹å¹¶ç¼©çª„å®½åº¦ */
        .side-panel.collapsed {
            width: 56px;
            overflow: hidden;
            transition: width 0.25s ease;
        }

        .side-panel.collapsed .side-panel-content {
            display: none;
        }

        .side-panel.collapsed .side-panel-title {
            display: none;
        }

        .side-panel.collapsed .side-panel-header {
            justify-content: center;
        }

        .zoom-button {
            width: 30px; /* 22px * 4/3 â‰ˆ 29.3 -> 30px */
            height: 30px; /* 30px */
            background: linear-gradient(160deg, #145a9e 60%, #1976d2 100%);
            color: #fff;
            border: 1.5px solid #1565c0; /* ç•¥å¢è¾¹æ¡†ä»¥é€‚é…å°ºå¯¸ */
            border-radius: 50%;
            font-size: 0.9rem; /* ä»0.65remæ”¾å¤§1/3 -> ~0.87remï¼Œå–0.9rem */
            box-shadow: 0 0 0 1.3px rgba(25, 118, 210, 0.13), 0 3px 10px rgba(20, 90, 158, 0.22);
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            user-select: none;
        }
        .zoom-button:active {
            background: linear-gradient(160deg, #0d305a 60%, #145a9e 100%);
            box-shadow: 0 0 0 1.3px #145a9e, 0 1px 5px rgba(20,90,158,0.18);
            transform: scale(0.98);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(160deg, #1976d2 0%, #145a9e 100%);
            box-shadow: 0 0 0 2px #1976d2, 0 5px 16px rgba(20,90,158,0.32);
            transform: scale(1.05);
        }
        .zoom-button i {
            font-size: 16px; /* é€‚é… 30px æŒ‰é’® */
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }

        /* å³ä¸Šè§’åœ°å›¾æ§åˆ¶èœå•æŒ‰é’®ç¾åŒ– */
        .side-panel-toggle {
            width: 40px;
            height: 40px;
            background: transparent !important;
            color: #fff;
            border: none !important;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: none !important;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            padding: 0;
            user-select: none;
        }
        .side-panel-toggle:active {
            background: rgba(25, 118, 210, 0.10);
            box-shadow: none;
            transform: scale(0.96);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: rgba(25, 118, 210, 0.13);
            box-shadow: 0 0 0 2px #1976d233, 0 2px 8px #1976d211;
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            font-size: 1.2em;
            line-height: 1;
            margin: 0;
            pointer-events: none;
        }
        /* å³ä¸Šè§’åœ°å›¾æ§åˆ¶èœå•æŒ‰é’®ç¾åŒ– */
        .side-panel-toggle {
            width: 38px;
            height: 38px;
            background: linear-gradient(145deg, var(--gta-accent) 0%, var(--gta-primary) 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18), 0 1px 0 #fff inset;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        .side-panel-toggle:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 1px 4px rgba(25, 118, 210, 0.12);
            transform: scale(0.97);
        }
        .side-panel-toggle:hover, .side-panel-toggle:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.22);
            transform: scale(1.08);
        }
        .side-panel-toggle i {
            pointer-events: none;
        }
        .zoom-button:active {
            background: linear-gradient(145deg, var(--gta-primary) 0%, var(--gta-accent) 100%);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.18);
            transform: scale(0.97);
        }
        .zoom-button:hover, .zoom-button:focus {
            background: linear-gradient(145deg, #42a5f5 0%, #1976d2 100%);
            box-shadow: 0 6px 24px rgba(25, 118, 210, 0.32);
            transform: scale(1.10);
        }
        .zoom-button i {
            pointer-events: none;
        }

        /* è“è‰²æ»šåŠ¨æ¡ï¼ˆGTA é£æ ¼ï¼‰ */
        .side-panel-content::-webkit-scrollbar { width: 10px; }
        .side-panel-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 6px; }
        .side-panel-content::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--gta-primary),var(--gta-accent)); border-radius: 6px; box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }

        .nav-button.back-button:hover {
            background: var(--gta-accent);
            border-color: var(--gta-accent);
        }

        .nav-section select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-section select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        .nav-section select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* ç‰©å“ç±»å‹é€‰æ‹©å™¨ */
        /* åœ°å›¾æ ·å¼é€‰æ‹©å™¨ï¼šæ”¾åœ¨ä¾§è¾¹æ å†…ï¼Œä¸ä½¿ç”¨ç»å¯¹å®šä½ä»¥é¿å…é®æŒ¡åœ°å›¾ */
        .map-style-selector {
            position: static;
            margin-bottom: 12px;
            background: transparent;
            border-radius: 6px;
            border: none;
            box-shadow: none;
            padding: 0;
            z-index: auto;
            width: 100%;
        }

        .map-style-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--gta-text);
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-style-selector select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .map-style-selector select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        .map-style-selector select:focus {
            outline: none;
            border-color: var(--gta-accent);
            box-shadow: 0 0 12px rgba(30, 144, 255, 0.4);
        }

        .item-selector-wrapper {
            position: absolute;
            top: 150px;
            right: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            width: 200px;
        }

        .item-selector-label {
            color: var(--gta-text);
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #item-type-select {
            width: 100%;
            background: var(--gta-bg-dark);
            color: var(--gta-text);
            border: 1px solid var(--gta-border-light);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #item-type-select:hover {
            border-color: var(--gta-primary);
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
        }

        #item-type-select:focus {
            outline: none;
            border-color: var(--gta-primary);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.4);
        }

        /* ç‰©å“ä¿¡æ¯å¼¹çª— */
        #item-info {
            position: absolute;
            bottom: 120px;
            left: 15px;
            background: var(--gta-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--gta-border);
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
            padding: 15px;
            z-index: 700;
            max-width: 300px;
            display: none;
        }

        #item-info .close {
            position: absolute;
            top: 5px;
            right: 10px;
            color: var(--gta-text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        #item-info .close:hover {
            color: var(--gta-secondary);
        }

        #item-title {
            color: var(--gta-primary);
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #item-coords, #item-location, #item-details {
            color: var(--gta-text);
            font-size: 14px;
            margin: 5px 0;
            line-height: 1.4;
        }

        /* é€šç”¨ç¡®è®¤å¼¹çª— */
        #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1400;
        }
        #confirm-modal.show { display: flex; }
        #confirm-modal .confirm-modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,20,30,0.6);
            backdrop-filter: blur(2px);
        }
        #confirm-modal .confirm-modal-content {
            position: relative;
            background: var(--gta-bg-medium);
            border: 1px solid var(--gta-border);
            border-radius: 10px;
            padding: 16px;
            width: 380px;
            max-width: calc(100% - 40px);
            color: var(--gta-text);
            box-shadow: 0 8px 22px rgba(0,0,0,0.5);
        }
        #confirm-modal .confirm-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--gta-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #confirm-modal .confirm-modal-message {
            font-size: 14px;
            color: var(--gta-text);
            opacity: 0.95;
            line-height: 1.6;
            margin-bottom: 14px;
        }
        #confirm-modal .confirm-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* å³ä¸‹è§’ç¼©æ”¾æŒ‰é’® - ç¼©å°ä¸º 50% */
        .zoom-controls {
            position: absolute;
            right: 32px;
            bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px; /* 50% */
            z-index: 1200;
            user-select: none;
        }

        #vertical-links a {
            color: var(--gta-primary);
            text-decoration: none;
            padding: 6px 12px;
            margin: 2px 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        #vertical-links a:hover {
            color: white;
            background: rgba(25, 118, 210, 0.2);
        }

        /* æ¸¸æˆæ—¶é—´/å¤©æ°” - é»˜è®¤ä½œä¸ºå¯¼èˆªä¸‹çš„å†…è”é¡¹ï¼Œå»æ‰åº•éƒ¨è“è‰²æ¡† */
        #game-time-weather {
            font-size: 14px;
            color: #fff;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 1300;
            pointer-events: none;
            letter-spacing: 0.6px;
            min-width: 0;
            text-align: left;
            user-select: none;
            display: inline-block;
            opacity: 0.95;
        }

        /* ä¿æŒé™æ­¢ï¼Œæ— åŠ¨ç”» */

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .gta-nav {
                padding: 8px 15px;
                /* åœ¨ç§»åŠ¨ç«¯ä¹Ÿä¿æŒä¸€è¡Œï¼šæ ‡é¢˜å·¦ï¼Œæ›´å¤šæŒ‰é’®å³ */
                flex-direction: row;
                justify-content: space-between;
                gap: 8px;
                align-items: center;
            }

            .gta-title {
                font-size: 18px;
            }

            .nav-button {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* ç§»åŠ¨ç«¯åªæ˜¾ç¤ºï¼šæ ‡é¢˜ã€æ—¶é—´/å¤©æ°”ã€æ›´å¤šï¼ˆéšè—å…¶å®ƒå·¦ä¾§/å³ä¾§é¡¹ï¼‰ */
            .gta-nav .nav-left > *:not(.gta-title):not(#game-time-weather) {
                display: none !important;
            }

            .gta-nav .nav-right > *:not(.nav-buttons-mobile) {
                display: none !important;
            }

            .nav-buttons-desktop { display: none !important; }
            .nav-buttons-mobile { display: flex !important; }

            .map-style-selector {
                top: 120px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            .item-selector-wrapper {
                top: 190px;
                right: 10px;
                width: 160px;
                padding: 10px;
            }

            #item-info {
                bottom: 100px;
                left: 10px;
                max-width: 250px;
                padding: 10px;
            }

            /* Keep game time/weather inline on mobile so JS can place it next to the title.
               Previously it was forced to bottom-right with !important which conflicted
               with the runtime placement logic. */
            #game-time-weather {
                display: inline-flex !important;
                align-items: center !important;
                color: white !important;
                font-size: 14px !important;
                margin-left: 8px !important;
                background: transparent !important;
                padding: 0 6px !important;
                pointer-events: none !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map-container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ï¼ˆä½©é‡Œç§‘å²›æ ·å¼ï¼‰ -->
        <div class="side-panel" id="side-panel">
            <div class="side-panel-header">
                <div class="side-panel-title">åœ°å›¾æ§åˆ¶</div>
                <button class="side-panel-toggle" id="panel-toggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="side-panel-content">
                <div class="side-panel-section">
                    <div class="side-panel-section-title">åœ°å›¾æ ·å¼</div>
                    <div class="map-style-selector">

                        <select id="map-style-select" style="width:100%; margin-top:6px;">
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_game">æ¸¸æˆ (Game)</option>
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_render">æ¸²æŸ“ (Render)</option>
                            <option value="https://gta-maps.antwen.com/maps/gta_map/gta_map_print">å°åˆ· (Print)</option>
                        </select>
                    </div>
                </div>

                <div class="side-panel-section">
                    <div style="display:flex; gap:8px; margin: 6px 0 10px 0;">
                        <button id="show-all-items" class="nav-button" style="flex:1;">
                            <i class="fas fa-eye"></i> æ˜¾ç¤ºå…¨éƒ¨
                        </button>
                        <button id="hide-all-items" class="nav-button" style="flex:1;">
                            <i class="fas fa-eye-slash"></i> éšè—å…¨éƒ¨
                        </button>
                    </div>
                    <div class="item-search-wrapper" style="margin-bottom: 10px;">
                        <input id="sidebar-item-search" type="text" placeholder="æœç´¢ç‰©å“..." aria-label="æœç´¢ç‰©å“" />
                    </div>
                    <div class="item-selector-container" id="sidebar-item-selectors">
                        <!-- å¤ç”¨ç°æœ‰ item é€‰æ‹©ï¼ˆç¨åé€šè¿‡ JS å¡«å……ï¼‰ -->
                    </div>
                </div>

                <div class="side-panel-section">
                    <button id="reset-checkboxes" class="nav-button" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-undo"></i> é‡ç½®é€‰æ‹©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GTAé£æ ¼å¯¼èˆªæ  -->
    <div class="gta-nav">
        <div class="nav-left">
            <h1 class="gta-title">ğŸ™ï¸ æ´›åœ£éƒ½åœ°å›¾</h1>
            <div class="nav-links">
                <a href="https://www.antwen.com" target="_blank">å®‰ç¨³</a>
                <a href="https://share.antwen.com" target="_blank">åœ¨çº¿æ–‡ä»¶</a>
            </div>
        </div>
        <div class="nav-right">
            <!-- PCç«¯æ˜¾ç¤º -->
            <div class="nav-buttons-desktop">
                <a href="../" class="nav-button">ğŸ  é¦–é¡µ</a>
                <a href="gta-map/cp" class="nav-button">ğŸï¸ ä½©é‡Œç§‘å²›</a>
                <a href="../vehicles" class="nav-button">ğŸš— è½¦è¾†æ•°æ®åº“</a>
            </div>
            <!-- ç§»åŠ¨ç«¯æ˜¾ç¤º -->
            <div class="nav-buttons-mobile">
                <button class="menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i> æ›´å¤š
                </button>
                <div class="mobile-menu" id="mobile-menu">
                    <a href="../" class="nav-button">ğŸ  é¦–é¡µ</a>
                    <a href="gta-map/cp" class="nav-button">ğŸï¸ ä½©é‡Œç§‘å²›</a>
                    <a href="../vehicles" class="nav-button">ğŸš— è½¦è¾†æ•°æ®åº“</a>
                    <a href="https://www.antwen.com" target="_blank" class="nav-link">ğŸ”— å®‰ç¨³</a>
                    <a href="https://share.antwen.com" target="_blank" class="nav-link">â˜ï¸ åœ¨çº¿æ–‡ä»¶</a>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ°å›¾æ ·å¼é€‰æ‹©å™¨ å·²ç§»å…¥ä¾§è¾¹æ  -->

    <!-- ç‰©å“ç±»å‹å¤é€‰é¡¹å·²ç§»å…¥ä¾§è¾¹æ  -->

    <!-- ç‰©å“ä¿¡æ¯å¼¹çª— -->
    <div id="item-info">
        <span class="close" onclick="hideItemInfoText()">Ã—</span>
        <h3 id="item-title">ç‰©å“ä¿¡æ¯</h3>
        <p id="item-coords">åæ ‡: </p>
        <p id="item-location">ä½ç½®: </p>
        <p id="item-details">è¯¦ç»†ä¿¡æ¯: </p>
    </div>

    <!-- é€šç”¨ç¡®è®¤å¼¹çª—ï¼ˆç½‘é¡µå†…æ ·å¼ï¼‰ -->
    <div id="confirm-modal" aria-hidden="true">
        <div class="confirm-modal-overlay"></div>
        <div class="confirm-modal-content" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
            <div class="confirm-modal-title" id="confirm-title">
                <i class="fas fa-triangle-exclamation"></i>
                æ€§èƒ½æç¤º
            </div>
            <div class="confirm-modal-message" id="confirm-message">ç‰©å“ä¿¡æ¯è¾ƒå¤šï¼Œæ˜¾ç¤ºå…¨éƒ¨å¯èƒ½é€ æˆå¡é¡¿ï¼Œæ˜¯å¦ç»§ç»­æ˜¾ç¤ºï¼Ÿ</div>
            <div class="confirm-modal-actions">
                <button class="nav-button" id="confirm-cancel">å–æ¶ˆ</button>
                <button class="nav-button" id="confirm-ok">ç»§ç»­æ˜¾ç¤º</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loader" id="loader">åœ°å›¾åŠ è½½ä¸­...</div>

        <!-- åº•éƒ¨ç¼©æ”¾æ§åˆ¶ -->
        <div class="zoom-controls">
            <button class="zoom-button" id="zoom-in">
                <i class="fas fa-plus"></i>
            </button>
            <button class="zoom-button" id="zoom-out">
                <i class="fas fa-minus"></i>
            </button>
        </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // --- é…ç½®/å¸¸é‡ ---
        const TILE_SIZE = 256;
        const GAME_LEFT = -4140;
        const GAME_RIGHT = 4860;
        const GAME_BOTTOM = -5100;
        const GAME_TOP = 8400;

        const zoomLevels = [
            { zoom: 3, cols: 4, rows: 6 },   // æœ€å°ç¼©æ”¾çº§åˆ«
            { zoom: 4, cols: 8, rows: 12 },
            { zoom: 5, cols: 16, rows: 24 },
            { zoom: 6, cols: 32, rows: 48 } ,
            { zoom: 7, cols: 64, rows: 96 }  // æœ€å¤§ç¼©æ”¾çº§åˆ«
        ];

        // è¯•ç‚¹æ ‡è®°ç±»å‹ï¼ˆä½¿ç”¨LeafletåŸç”Ÿæ ‡è®°ï¼‰
        const pilotMarkerTypes = new Set([
            // ç¬¬0ç»„ï¼šè¯•ç‚¹ç»„
            'hidden_caches',
            'dead_drop', 
            'stunt_jumps',
            'spray',
            
            // ç¬¬1ç»„ï¼šåŸºç¡€æ”¶é›†å“
            'shipwrecked',
            'gun_van',
            'ls_tags',
            'street_dealers',
            
            // ç¬¬2ç»„ï¼šå¨±ä¹æ´»åŠ¨
            'playing_cards',
            'smoke_on_the_water_product',
            'action_figures',
            'yuanbao',
            'letter_scraps',
            'sp_hidden_packages',
            'peyote_sp_land',
            'peyote_sp_air',
            'peyote_sp_water',
            'peyote_sp_special',
            'submarine_pieces',
            'spaceship_parts',
            'nuclear_waste',
            'humans_of_ls',
            'monkey_mosaics',
            'murder_mystery_message',
            'assuming_the_truth',
            'epsilon_tracts',
            'for_sale_sign',
            'the_big_score_gauntlet',
            'hitchhikers',
            'chasing_the_truth',
            
            // ç¬¬3ç»„ï¼šè®¾æ–½æœåŠ¡
            'ld_organics_products',
            'signal_jammers',
            'jack_o_lanterns',
            'payphone_hits',
            
            // ç¬¬4ç»„ï¼šè¿åŠ¨æŒ‘æˆ˜
            'golf_holes',
            'snowmen',
            'rc_time_trial',
            'bike_time_trial',
            
            // ç¬¬5ç»„ï¼šè½½å…·ç›¸å…³ï¼ˆéƒ¨åˆ†ï¼‰
            'skydives',
            'drug_vehicle',
            'smuggler_plane',
            'smuggler_trail',
            'metal_detector',
            
            // ç‰¹æ®Šæ ‡è®°ï¼šæœ‰ç‰¹æ®Šå¤„ç†é€»è¾‘çš„æ ‡è®°
            'media_sticks',
            'police_rescue_patrick_mcreary',
            
            // ç¬¬6ç»„ï¼šä»»åŠ¡ç³»ç»Ÿ
            'stash_houses',
            'madrazo_hits',
            'random_missions',
            'convoy',
            'convoy_final',
            'armored_truck',
            
            // ç¬¬13ç»„ï¼šåŸºç¡€è®¾æ–½
            'metro',
            'police',
            'v_telescopes',
            'fire_stations',
            
            // ç¬¬14ç»„ï¼šå•†ä¸šè®¾æ–½
            'hospitals',
            'clothing',
            'tattoos',
            'barbers',
            
            // ç¬¬15ç»„ï¼šè½¦è¡Œè®¾æ–½
            'casino',
            'car_meet', 
            'premium_deluxe_motorsport',
            'luxury_autos',
            
            // ç¬¬16ç»„ï¼šæœåŠ¡è®¾æ–½
            'ammunation',
            'mod_shop',
            'car_wash',
            'shops_to_rob',
            'drunk_guard',
            
            // ç¬¬17ç»„ï¼šä¾¿æ°‘è®¾æ–½
            'gas_stations',
            'atms',
            
            // ç¬¬18ç»„ï¼šå”®å–æœº
            'vend_sprunk',
            'vend_ecola',
            
            // ç¬¬8ç»„ï¼šå‡ºå£è´¸æ˜“ï¼ˆæ–°å¢ï¼‰
            'exotic_exports1',
            'exotic_exports2',
            'happy_holidays_hauler',
            'wea',
            
            // ç¬¬9ç»„ï¼šç‰¹æ®Šç”Ÿç‰©
            'halloween_slashers',
            'gang_attacks',
            'ghosts3',
            'cerberus',
            'possessed_animals',
            'yeti',
            
            // ç¬¬10ç»„ï¼šæ‚¬èµç³»ç»Ÿ
            'maude_bounty_targets',

            // æ–°å¢è¿ç§»ç±»å‹
            'serial_killer_slasher',
            'treasure_hunt_dba_revolver',
            'movie_props',
            'crime_scenes',
            'ufo',
            'community_outreach',
            'store_robbery',
            'ppl',
            'ppw'
        ]);

        // Leafletæ ‡è®°å­˜å‚¨
        let leafletMarkers = [];

        // æ¸¸æˆåæ ‡è½¬åƒç´ åæ ‡å‡½æ•°ï¼ˆå‚è€ƒCPåœ°å›¾å®ç°ï¼‰
        function gameToPixel(gx, gy, z) {
            const level = getLevelByZoom(z);
            if (!level) return { x: 0, y: 0 };
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            const gameWidth = GAME_RIGHT - GAME_LEFT;
            const gameHeight = GAME_TOP - GAME_BOTTOM;
            const percentX = (gx - GAME_LEFT) / gameWidth;
            const percentY = (GAME_TOP - gy) / gameHeight;
            
            return { 
                x: percentX * totalWidth, 
                y: percentY * totalHeight 
            };
        }

        // åº”ç”¨ assuming_the_truth å¯è§æ€§ç¼“å­˜
        function applyAssumingTheTruthVisibilityCache() {
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('assuming_the_truth') || {};
                markers.forEach((marker, index) => {
                    const hidden = !!visibilityMap[index];
                    if (!marker) return;
                    if (marker.setOpacity) {
                        marker.setOpacity(hidden ? 0.3 : 1);
                    } else if (marker.getElement) {
                        const el = marker.getElement();
                        if (el) el.style.opacity = hidden ? '0.3' : '1';
                    }
                });
            }
        }

        // ç‰©å“å›¾æ ‡è·¯å¾„æ˜ å°„
        const itemIcons = {
            hidden_caches: '../src/assets/cache.png',
            shipwrecked: '../src/assets/shipwrecked.png',
            gun_van: '../src/assets/van.png',
            dead_drop: '../src/assets/dead_drop.svg',
            stunt_jumps: '../src/assets/stunt_jumps.svg',
            spray: '../src/assets/spray.svg',
            ls_tags: '../src/assets/ls_tags.svg',
            street_dealers: '../src/assets/dealer.png',
            playing_cards: '../src/assets/playing_cards.svg',
            smoke_on_the_water_product: '../src/assets/smoke_product.svg',
            action_figures: '../src/assets/action_figures.svg',
            yuanbao: '../src/assets/yuanbao.svg',
            ld_organics_products: '../src/assets/organic_farm.svg',
            signal_jammers: '../src/assets/signal_jammer.svg',
            jack_o_lanterns: '../src/assets/jack.svg',
            payphone_hits: '../src/assets/payphone.svg',
            golf_holes: '../src/assets/golf.svg',
            snowmen: '../src/assets/snowmen.svg',
            letter_scraps: '../src/assets/letter.svg',
            sp_hidden_packages: '../src/assets/sp_hidden_packages.svg',
            peyote_sp_land: '../src/assets/peyote_sp_land.svg',
            peyote_sp_air: '../src/assets/peyote_sp_air.svg',
            peyote_sp_water: '../src/assets/peyote_sp_water.svg',
            peyote_sp_special: '../src/assets/peyote_sp_special.svg',
            submarine_pieces: '../src/assets/submarine_pieces.svg',
            spaceship_parts: '../src/assets/spaceship_parts.svg',
            nuclear_waste: '../src/assets/nuclear_waste.svg',
            humans_of_ls: '../src/assets/humans_of_ls.svg',
            monkey_mosaics: '../src/assets/monkey_mosaics.svg',
            murder_mystery_message: '../src/assets/murder_mystery_message.svg',
            assuming_the_truth: '../src/assets/assuming_the_truth_car.svg',
            chasing_the_truth: '../src/assets/chasing_the_truth.svg',
            epsilon_tracts: '../src/assets/epsilon_tracts.svg',
            the_big_score_gauntlet: '../src/assets/the_big_score_gauntlet.svg',
            for_sale_sign: '../src/assets/for_sale_sign.svg',
            hitchhikers: '../src/assets/hitchhikers.svg',
            rc_time_trial: '../src/assets/rctt.png',
            bike_time_trial: '../src/assets/btt.png',
            skydives: '../src/assets/skydive.png',
            gang_attacks: '../src/assets/gang_attack.svg',
            ghosts3: '../src/assets/ge251.svg',
            treasure_hunt_dba_revolver: '../src/assets/th1.svg',
            // æ´›åœ£éƒ½æ€äººç‹‚ï¼ˆfirst ç”¨ slasher.svgï¼Œlast ç”¨ slasher2.svgï¼›Leafletå…¥å£æŒ‰ç±»å‹åˆ†æ”¯ï¼‰
            serial_killer_slasher: '../src/assets/slasher.svg',
            // èŒ‰å¾·æ‚¬èµç›®æ ‡å›¾æ ‡
            maude_bounty_targets: '../src/assets/mp_static.svg', // ä¸´æ—¶ä½¿ç”¨ï¼Œåç»­éœ€è¦åˆ›å»ºä¸“ç”¨å›¾æ ‡
            // åª’ä½“è®°å¿†æ£’å›¾æ ‡
            media_sticks: '../src/assets/media.svg',
            // è—åŒ¿å±‹å›¾æ ‡
            stash_houses: '../src/assets/stash.svg',
            // ç›å¾·æ‹‰ç´¢é›‡å‡¶å›¾æ ‡
            madrazo_hits: '../src/assets/hits.svg',
            // å¸•ç‰¹é‡Œå…‹æ•‘æ´å›¾æ ‡
            police_rescue_patrick_mcreary: '../src/assets/patrick.svg',
            // éšæœºä»»åŠ¡å›¾æ ‡
            random_missions: '../src/assets/random.svg',
            // æ¯’å“è½½å…·å›¾æ ‡
            drug_vehicle: '../src/assets/drug_vehicle.svg',
            // ç”µå½±é“å…·å›¾æ ‡
            movie_props: '../src/assets/mp_static.svg',
            // è½¦è¡Œå›¾æ ‡
            casino: '../src/assets/casino.svg',
            car_meet: '../src/assets/lscm.svg',
            premium_deluxe_motorsport: '../src/assets/sem.svg',
            luxury_autos: '../src/assets/lux.svg',
            // æ²‰ç¡çš„ä¿å®‰
            drunk_guard: '../src/assets/drunk_guard.svg',
            // é‡‘å±æ¢æµ‹å™¨
            metal_detector: '../src/assets/metal.svg',
            // èµ°ç§è´©é£æœº
            smuggler_plane: '../src/assets/smuggler_plane.svg',
            // èµ°ç§è´©è¸ªè¿¹
            smuggler_trail: '../src/assets/smuggler_trail.svg',
            // çŠ¯ç½ªç°åœº
            crime_scenes: '../src/assets/crime_scenes.svg',
            // UFOè§‚å…‰
            ufo: '../src/assets/ufo.svg',
            // ä¸‡åœ£èŠ‚æ€äººç‹‚
            halloween_slashers: '../src/assets/slasher.svg',
            // é¬¼ä¸Šèº«çš„åŠ¨ç‰©
            possessed_animals: '../src/assets/blank.svg',
            // åœ°ç‹±çŠ¬
            cerberus: '../src/assets/cerberus.svg',
            // é›ªæ€ª
            yeti: '../src/assets/what.svg',
            // ç¤¾åŒºè¾¹ç•Œ
            community_outreach: '../src/assets/community_outreach.svg',
            // å•†åº—æŠ¢åŠ«
            store_robbery: '../src/assets/store_robbery.svg',
            // è½¦é˜Ÿ
            convoy: '../src/assets/convoy.svg',
            // è½¦é˜Ÿç»ˆç‚¹
            convoy_final: '../src/assets/convoy_final.svg',
            // è£…ç”²è¿é’è½¦
            armored_truck: '../src/assets/armored_truck.svg',
            // å¤–è´¸å‡ºå£è½½å…·1
            exotic_exports1: '../src/assets/exotic_exports1.svg',
            // å¤–è´¸å‡ºå£è½½å…·2
            exotic_exports2: '../src/assets/exotic_exports2.svg',
            // èŠ‚æ—¥å¿«ä¹å¡è½¦
            happy_holidays_hauler: '../src/assets/happy.svg',
            // å¨æ³½å°”å¤§æ¥¼æªæˆ˜
            wea: '../src/assets/wea.svg',
            // é™†åœ°è¿·å¹»ä»™äººæŒ
            ppl: '../src/assets/ppl.svg',
            // æ°´ä¸‹è¿·å¹»ä»™äººæŒ
            ppw: '../src/assets/ppw.svg',
            // åœ°é“ç«™
            metro: '../src/assets/metro.svg',
            // è­¦å¯Ÿå±€
            police: '../src/assets/police.svg',
            // æœ›è¿œé•œ
            v_telescopes: '../src/assets/telescopes.svg',
            // æ¶ˆé˜²å±€
            fire_stations: '../src/assets/fire.svg',
            // åŒ»é™¢
            hospitals: '../src/assets/hospitals.svg',
            // æœè£…åº—
            clothing: '../src/assets/clothing.svg',
            // çº¹èº«åº—
            tattoos: '../src/assets/tattoos.svg',
            // ç†å‘åº—
            barbers: '../src/assets/barbers.svg',
            // æ­¦è£…å›½åº¦
            ammunation: '../src/assets/ammunation.svg',
            // æ´›åœ£éƒ½æ”¹è½¦ç‹
            mod_shop: '../src/assets/mod_shop.svg',
            // æ´—è½¦åº—
            car_wash: '../src/assets/car_wash.svg',
            // å¯æŠ¢åŠ«çš„å•†åº—
            shops_to_rob: '../src/assets/shops_to_rob.svg',
            // åŠ æ²¹ç«™
            gas_stations: '../src/assets/gas_stations.svg',
            // ATMæœº
            atms: '../src/assets/atms.svg',
            // éœœç¢§å”®å–æœº
            vend_sprunk: '../src/assets/vend_sprunk.svg',
            // æ˜“å¯ä¹å”®å–æœº
            vend_ecola: '../src/assets/vend_ecola.svg'
        };

        // ç‰©å“æ•°æ®ï¼ˆä»JSONæ–‡ä»¶åŠ è½½ï¼‰
        const itemData = {
            hidden_caches: [],
            shipwrecked: [],
            gun_van: [],
            dead_drop: [],
            ls_tags: [],
            street_dealers: [],
            playing_cards: [],
            smoke_on_the_water_product: [],
            action_figures: [],
            yuanbao: [],
            letter_scraps: [],
            sp_hidden_packages: [],
            peyote_sp_land: [],
            peyote_sp_air: [],
            peyote_sp_water: [],
            peyote_sp_special: [],
            submarine_pieces: [],
            spaceship_parts: [],
            nuclear_waste: [],
            humans_of_ls: [],
            monkey_mosaics: [],
            murder_mystery_message: [],
            assuming_the_truth: [],
            chasing_the_truth: [],
            epsilon_tracts: [],
            the_big_score_gauntlet: [],
            for_sale_sign: [],
            hitchhikers: [],
            ld_organics_products: [],
            signal_jammers: [],
            jack_o_lanterns: [],
            payphone_hits: [],
            golf_holes: [],
            snowmen: [],
            stunt_jumps: [],
            spray: [],
            rc_time_trial: [],
            bike_time_trial: [],
            skydives: [],
            gang_attacks: [],
            ghosts3: [],
            treasure_hunt_dba_revolver: { random_clue: [], static_clues: [] },
            movie_props: { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } },
            serial_killer_slasher: { first: [], last: [] },
            maude_bounty_targets: { areas: [], endpoints: [] },
            media_sticks: [],
            stash_houses: [],
            madrazo_hits: [],
            police_rescue_patrick_mcreary: { spawn: [], dropoff: [] },
            random_missions: {
                // æµ‹è¯•æ•°æ® - ä¸€äº›ç¤ºä¾‹éšæœºä»»åŠ¡ä½ç½®
                "morning": [
                    [100, 200],
                    [300, 400]
                ],
                "afternoon": [
                    [500, 600],
                    [700, 800]
                ]
            },
            drug_vehicle: [],
            drunk_guard: [],
            metal_detector: [],
            smuggler_plane: [],
            smuggler_trail: [],
            crime_scenes: [],
            ufo: [],
            halloween_slashers: [],
            possessed_animals: [],
            cerberus: [],
            yeti: [],
            happy_holidays_hauler: [],
            // å¨æ³½å°”å¤§æ¥¼æªæˆ˜
            wea: [],
            // é™†åœ°è¿·å¹»ä»™äººæŒ
            ppl: [],
            // æ°´ä¸‹è¿·å¹»ä»™äººæŒ
            ppw: [],
            // åœ°é“ç«™
            metro: [],
            // è­¦å¯Ÿå±€
            police: [],
            // æœ›è¿œé•œ
            v_telescopes: [],
            // æ¶ˆé˜²å±€
            fire_stations: [],
            // åŒ»é™¢
            hospitals: [],
            // æœè£…åº—
            clothing: {},
            // çº¹èº«åº—
            tattoos: [],
            // ç†å‘åº—
            barbers: [],
            // æ­¦è£…å›½åº¦
            ammunation: {},
            // æ´›åœ£éƒ½æ”¹è½¦ç‹
            mod_shop: {},
            // æ´—è½¦åº—
            car_wash: [],
            // å¯æŠ¢åŠ«çš„å•†åº—
            shops_to_rob: [],
            // åŠ æ²¹ç«™
            gas_stations: [],
            // ATMæœº
            atms: [],
            // éœœç¢§å”®å–æœº
            vend_sprunk: [],
            // æ˜“å¯ä¹å”®å–æœº
            vend_ecola: [],
            community_outreach: [],
            store_robbery: [],
            convoy: [],
            convoy_final: [],
            armored_truck: [],
            exotic_exports1: [],
            exotic_exports2: []
        };

        // è½¦è¡Œä½ç½®æ•°æ®
        const dealershipData = {
            casino: {
                coordinates: [[939.1505, 26.4848]],
                name: 'èµŒåœº',
                icon: 'casino'
            },
            car_meet: {
                coordinates: [[781.25, -1868.553]],
                name: 'è½¦å‹ä¼š',
                icon: 'car_meet'
            },
            premium_deluxe_motorsport: {
                coordinates: [[-42.6786, -1097.2642]],
                name: 'è¥¿ç±³æ©',
                icon: 'premium_deluxe_motorsport'
            },
            luxury_autos: {
                coordinates: [[-788.722, -239.5369]],
                name: 'è±ªå',
                icon: 'luxury_autos'
            }
        };

        // è½¦è¡Œæ ‡è®°æ•°ç»„
        let dealershipMarkers = [];

        // æ­¦å™¨å¢å‹è½¦ä½ç½®ç¼“å­˜ï¼ˆæ¯å¤©å˜åŒ–ï¼‰
        let gunVanLocation = null;
        let gunVanLastUpdate = 0;
        
        // LSæ¶‚é¸¦ä½ç½®ç¼“å­˜ï¼ˆæ¯å¤©å˜åŒ–ï¼‰
        let lsTagsLastUpdate = 0;
        
        // éšè—åŒ…è£¹ä½ç½®ç¼“å­˜ï¼ˆæ¯å¤©å˜åŒ–ï¼‰
        let hiddenCachesLastUpdate = 0;
        
        // æ²‰èˆ¹ä½ç½®ç¼“å­˜ï¼ˆæ¯å¤©å˜åŒ–ï¼‰
        let shipwreckedLastUpdate = 0;

        // ==================== ç¼“å­˜ç®¡ç†ç³»ç»Ÿ ====================
        // ç¼“å­˜é”®åå¸¸é‡
        const CACHE_KEYS = {
            SIDEBAR_STATE: 'gta_map_sidebar_state',
            ITEM_VISIBILITY: 'gta_map_item_visibility',
            COUNTERS: 'gta_map_counters',
            USER_PREFERENCES: 'gta_map_preferences'
        };

        // ç¼“å­˜ç®¡ç†å™¨
        const CacheManager = {
            // ä¿å­˜æ•°æ®åˆ°localStorage
            save(key, data) {
                try {
                    const serialized = JSON.stringify({
                        data: data,
                        timestamp: Date.now(),
                        version: '1.0'
                    });
                    localStorage.setItem(key, serialized);
                    console.log(`ç¼“å­˜å·²ä¿å­˜: ${key}`, data);
                } catch (error) {
                    console.warn(`ä¿å­˜ç¼“å­˜å¤±è´¥: ${key}`, error);
                }
            },

            // ä»localStorageåŠ è½½æ•°æ®
            load(key, defaultValue = null) {
                try {
                    const stored = localStorage.getItem(key);
                    if (!stored) return defaultValue;
                    
                    const parsed = JSON.parse(stored);
                    // æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§ï¼ˆå¯é€‰ï¼‰
                    if (parsed.version && parsed.version !== '1.0') {
                        console.warn(`ç¼“å­˜ç‰ˆæœ¬ä¸åŒ¹é…: ${key}, æœŸæœ› 1.0, å®é™… ${parsed.version}`);
                    }
                    
                    console.log(`ç¼“å­˜å·²åŠ è½½: ${key}`, parsed.data);
                    return parsed.data;
                } catch (error) {
                    console.warn(`åŠ è½½ç¼“å­˜å¤±è´¥: ${key}`, error);
                    return defaultValue;
                }
            },

            // åˆ é™¤ç¼“å­˜
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    console.log(`ç¼“å­˜å·²åˆ é™¤: ${key}`);
                } catch (error) {
                    console.warn(`åˆ é™¤ç¼“å­˜å¤±è´¥: ${key}`, error);
                }
            },

            // æ¸…ç©ºæ‰€æœ‰GTAåœ°å›¾ç›¸å…³ç¼“å­˜
            clearAll() {
                Object.values(CACHE_KEYS).forEach(key => {
                    this.remove(key);
                });
                console.log('æ‰€æœ‰GTAåœ°å›¾ç¼“å­˜å·²æ¸…ç©º');
            },

            // è·å–ç¼“å­˜ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            getCacheInfo() {
                const info = {};
                Object.entries(CACHE_KEYS).forEach(([name, key]) => {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            info[name] = {
                                size: stored.length,
                                timestamp: parsed.timestamp,
                                version: parsed.version
                            };
                        } catch (e) {
                            info[name] = { error: 'è§£æå¤±è´¥' };
                        }
                    } else {
                        info[name] = null;
                    }
                });
                return info;
            }
        };

        // ä¾§è¾¹æ çŠ¶æ€ç¼“å­˜
        const SidebarCache = {
            // ä¿å­˜ä¾§è¾¹æ é€‰æ‹©çŠ¶æ€
            saveState(activeTypes) {
                const state = Array.from(activeTypes);
                console.log('ä¿å­˜ä¾§è¾¹æ çŠ¶æ€:', state);
                const result = CacheManager.save(CACHE_KEYS.SIDEBAR_STATE, state);
                console.log('ä¿å­˜ç»“æœ:', result);
                return result;
            },

            // åŠ è½½ä¾§è¾¹æ é€‰æ‹©çŠ¶æ€
            loadState() {
                return CacheManager.load(CACHE_KEYS.SIDEBAR_STATE, []);
            },

            // åº”ç”¨ç¼“å­˜çš„ä¾§è¾¹æ çŠ¶æ€
            applyState(activeTypes) {
                const cachedState = this.loadState();
                console.log('å°è¯•æ¢å¤ä¾§è¾¹æ çŠ¶æ€ï¼Œç¼“å­˜æ•°æ®:', cachedState);
                if (cachedState.length > 0) {
                    console.log('æ¢å¤ä¾§è¾¹æ çŠ¶æ€:', cachedState);
                    // æ¸…ç©ºå½“å‰çŠ¶æ€
                    activeTypes.clear();
                    // æ¢å¤ç¼“å­˜çŠ¶æ€
                    cachedState.forEach(type => {
                        if (typeof type === 'string') {
                            activeTypes.add(type);
                        }
                    });
                    console.log('æ¢å¤åçš„activeItemTypes:', Array.from(activeTypes));
                    return true;
                }
                console.log('æ— ç¼“å­˜çŠ¶æ€å¯æ¢å¤');
                return false;
            }
        };

        // ç‰©å“å¯è§æ€§ç¼“å­˜
        const VisibilityCache = {
            // ä¿å­˜ç‰©å“å¯è§æ€§çŠ¶æ€
            saveVisibility(itemType, visibilityMap) {
                const allVisibility = CacheManager.load(CACHE_KEYS.ITEM_VISIBILITY, {});
                allVisibility[itemType] = visibilityMap;
                CacheManager.save(CACHE_KEYS.ITEM_VISIBILITY, allVisibility);
            },

            // åŠ è½½ç‰©å“å¯è§æ€§çŠ¶æ€
            loadVisibility(itemType) {
                const allVisibility = CacheManager.load(CACHE_KEYS.ITEM_VISIBILITY, {});
                return allVisibility[itemType] || {};
            },

            // åº”ç”¨å¯è§æ€§çŠ¶æ€åˆ°æ ‡è®°
            applyVisibility(itemType, markers) {
                const visibilityMap = this.loadVisibility(itemType);
                if (Object.keys(visibilityMap).length > 0) {
                    console.log(`æ¢å¤ ${itemType} å¯è§æ€§çŠ¶æ€:`, visibilityMap);
                    markers.forEach((marker, index) => {
                        const isHidden = visibilityMap[index];
                        if (isHidden && marker.setOpacity) {
                            marker.setOpacity(0.3);
                        }
                    });
                    return true;
                }
                return false;
            },

            // æ›´æ–°å•ä¸ªç‰©å“çš„å¯è§æ€§çŠ¶æ€
            updateItemVisibility(itemType, index, isHidden) {
                const visibilityMap = this.loadVisibility(itemType);
                visibilityMap[index] = isHidden;
                this.saveVisibility(itemType, visibilityMap);
            }
        };

        // è®¡æ•°å™¨ç¼“å­˜
        const CounterCache = {
            // ä¿å­˜è®¡æ•°å™¨çŠ¶æ€
            saveCounters(counters) {
                CacheManager.save(CACHE_KEYS.COUNTERS, counters);
            },

            // åŠ è½½è®¡æ•°å™¨çŠ¶æ€
            loadCounters() {
                return CacheManager.load(CACHE_KEYS.COUNTERS, {});
            },

            // æ›´æ–°ç‰¹å®šç‰©å“ç±»å‹çš„è®¡æ•°å™¨
            updateCounter(itemType, hiddenCount, totalCount) {
                const counters = this.loadCounters();
                counters[itemType] = { hidden: hiddenCount, total: totalCount };
                this.saveCounters(counters);
            },

            // è·å–ç‰¹å®šç‰©å“ç±»å‹çš„è®¡æ•°å™¨
            getCounter(itemType) {
                const counters = this.loadCounters();
                return counters[itemType] || { hidden: 0, total: 0 };
            }
        };

        // ==================== å¢å¼ºç‰ˆèµ°ç§è´©é£æœºæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º smuggler_plane å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSmugglerPlaneCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.smuggler-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'smuggler-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSmugglerPlaneSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆè¡—å¤´æ¯’è´©æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º street_dealers å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachStreetDealersCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.street-dealers-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'street-dealers-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateStreetDealersSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆå¹½çµæ›å…‰2025æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ghosts3 å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachGhosts3CounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ghosts3-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ghosts3-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateGhosts3SidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆé›ªäººæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º snowmen å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSnowmenCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.snowmen-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'snowmen-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSnowmenSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆå–·ç½ä½ç½®æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º spray å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSprayCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.spray-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'spray-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSpraySidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆç‰¹æŠ€è·³è·ƒç‚¹æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º stunt_jumps å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachStuntJumpsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.stunt-jumps-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'stunt-jumps-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateStuntJumpsSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆæ‰‹åŠæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º action_figures å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachActionFiguresCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.action-figures-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'action-figures-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateActionFiguresSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆçº¸ç‰Œæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º playing_cards å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachPlayingCardsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.playing-cards-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'playing-cards-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updatePlayingCardsSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆé™†åœ°è¿·å¹»ä»™äººæŒæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ppl å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachPplCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppl-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppl-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updatePplSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆæ°´ä¸‹è¿·å¹»ä»™äººæŒæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ppw å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachPpwCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppw-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppw-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updatePpwSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆæœ‰æœºåŠäº§å“æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ld_organics_products å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachOrganicFarmCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.organic-farm-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'organic-farm-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateOrganicFarmSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateOrganicFarmSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ld_organics_products + label .organic-farm-counter');
                if (!counterEl) return;

                // è·å–æœ‰æœºåŠäº§å“æ ‡è®°
                const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶
                    total = Array.isArray(window.itemData?.ld_organics_products) ? window.itemData.ld_organics_products.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('ld_organics_products');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ld_organics_products', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æœ‰æœºåŠäº§å“è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆè·³ä¼æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º skydives å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSkydivesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.skydives-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'skydives-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSkydivesSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSkydivesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-skydives + label .skydives-counter');
                if (!counterEl) return;

                // è·å–è·³ä¼æ ‡è®°
                const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
                let total = 10; // å›ºå®š10ä¸ªè·³ä¼ä½ç½®
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶ï¼Œä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('skydives');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('skydives', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è·³ä¼è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆRCæ—¶é—´æŒ‘æˆ˜èµ›æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º rc_time_trial å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachRCTimeTrialCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.rc-time-trial-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'rc-time-trial-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateRCTimeTrialSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆè‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º bike_time_trial å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachBikeTimeTrialCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.bike-time-trial-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'bike-time-trial-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateBikeTimeTrialSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆç›å¾·æ‹‰ç´¢é›‡å‡¶æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º madrazo_hits å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachMadrazoHitsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.madrazo-hits-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'madrazo-hits-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateMadrazoHitsSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆè—åŒ¿å±‹æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º stash_houses å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachStashHousesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.stash-houses-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'stash-houses-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateStashHousesSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆLSæ¶‚é¸¦æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ls_tags å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachLSTagsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ls-tags-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ls-tags-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateLSTagsSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆæ²‰èˆ¹æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º shipwrecked å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachShipwreckedCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.shipwrecked-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'shipwrecked-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateShipwreckedSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆéšè—åŒ…è£¹æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º hidden_caches å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachHiddenCachesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.hidden-caches-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'hidden-caches-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateHiddenCachesSidebarCount();
        }

        // ==================== å¢å¼ºç‰ˆåäº‘åé›¾é¦†äº§å“æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º smoke_on_the_water_product å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSmokeProductCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.smoke-product-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'smoke-product-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSmokeProductSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSmugglerPlaneSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smuggler_plane + label .smuggler-counter');
                if (!counterEl) return;

                // groups: window.smugglerGroupMarkers['smuggler_plane'] ç»“æ„ï¼šæ¯ç»„ä¸ºæ•°ç»„ï¼Œå« marker ä¸ polyline
                const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(groups) && groups.length > 0) {
                    total = groups.length;
                    groups.forEach((groupMarkers, index) => {
                        if (groupMarkers && groupMarkers.length > 0) {
                            const first = groupMarkers[0];
                            if (first && first.getElement) {
                                const el = first.getElement();
                                if (el && el.style.opacity === '0.3') {
                                    hidden++;
                                }
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶
                    total = Array.isArray(window.itemData?.smuggler_plane) ? window.itemData.smuggler_plane.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('smuggler_plane');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('smuggler_plane', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°èµ°ç§è´©é£æœºè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSpraySidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spray + label .spray-counter');
                if (!counterEl) return;

                // è®¡æ•°å™¨å›ºå®šä¸º1ï¼Œéšè—çŠ¶æ€é€šè¿‡å…¨å±€å˜é‡æ§åˆ¶
                const totalCount = 1;
                const hiddenCount = window.sprayHidden ? 1 : 0;

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('spray', hiddenCount, totalCount);
                counterEl.textContent = totalCount > 0 ? ` (${hiddenCount}/${totalCount})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å–·ç½ä½ç½®è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateMoviePropsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-movie_props + label .movie-props-counter');
                if (!counterEl) return;

                const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
                const total = 10; // å›ºå®šä¸º10ä¸ªï¼ˆ7å›ºå®š + 3è½½å…·æŒ‰ç»„è®¡æ•°ï¼‰

                // è¯»å–å­ç±»å‹æ•°é‡ï¼ˆä»æ•°æ®æºï¼‰
                const mp = (window.itemData && window.itemData.movie_props) || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                const rumpoCount = mp.vehicles?.rumpo?.length || 0;

                // å¯è§æ€§æ¥æºï¼šä¼˜å…ˆç¼“å­˜
                let visibilityMap;
                try { visibilityMap = VisibilityCache.loadVisibility('movie_props') || []; } catch (_) { visibilityMap = []; }

                const getHiddenByIndex = (i) => {
                    if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                    if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                    const m = markers[i];
                    if (!m) return false;
                    if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                    if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                    if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                    return false;
                };

                // å›ºå®šç‚¹é€ä¸€ç»Ÿè®¡
                let hiddenFixed = 0;
                for (let i = 0; i < fixedCount; i++) if (getHiddenByIndex(i)) hiddenFixed++;

                // ç»„èŒƒå›´
                const ponyStart = fixedCount;
                const ponyEnd = ponyStart + ponyCount;
                const rebelStart = ponyEnd;
                const rebelEnd = rebelStart + rebelCount;
                const rumpoStart = rebelEnd;
                const rumpoEnd = rumpoStart + rumpoCount;

                const rangeAllHidden = (start, end) => {
                    if (start >= end) return false;
                    for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                    return true;
                };

                const ponyHidden = rangeAllHidden(ponyStart, ponyEnd);
                const rebelHidden = rangeAllHidden(rebelStart, rebelEnd);
                const rumpoHidden = rangeAllHidden(rumpoStart, rumpoEnd);

                const hidden = hiddenFixed + (ponyHidden ? 1 : 0) + (rebelHidden ? 1 : 0) + (rumpoHidden ? 1 : 0);

                CounterCache.updateCounter('movie_props', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°ç”µå½±é“å…·è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateStreetDealersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-street_dealers + label .street-dealers-counter');
                if (!counterEl) {
                    console.log('è¡—å¤´æ¯’è´©è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è¡—å¤´æ¯’è´©æ€»æ•°å›ºå®šä¸º3
                const total = 3;
                let hidden = 0;

                // è·å–è¡—å¤´æ¯’è´©æ ‡è®°
                const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡è®¡ç®—éšè—æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('street_dealers');
                    hidden = cachedCounter.hidden || 0;
                }

                console.log('è¡—å¤´æ¯’è´©è®¡æ•°å™¨æ›´æ–°:', { 
                    total, 
                    hidden, 
                    markers: markers.length, 
                    data: window.itemData?.street_dealers?.length,
                    itemDataExists: !!window.itemData,
                    streetDealersExists: !!window.itemData?.street_dealers,
                    streetDealersType: typeof window.itemData?.street_dealers,
                    streetDealersIsArray: Array.isArray(window.itemData?.street_dealers)
                });

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('street_dealers', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('æ›´æ–°è¡—å¤´æ¯’è´©è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSlasherSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-serial_killer_slasher + label .slasher-counter');
                if (!counterEl) return;

                const markers = (window.slasherMarkers && window.slasherMarkers) || [];
                const total = 4; // å›ºå®šä¸º4ä¸ªï¼ˆ3ä¸ªslasher1.svg + 1ä¸ªslasher2.svgç»„ï¼‰

                // è¯»å–å­ç±»å‹æ•°é‡ï¼ˆä»æ•°æ®æºï¼‰
                const slasherData = (window.itemData && window.itemData.serial_killer_slasher) || { first: [], last: [] };
                const firstCount = slasherData.first?.length || 0;
                const lastCount = slasherData.last?.length || 0;

                // å¯è§æ€§æ¥æºï¼šä¼˜å…ˆç¼“å­˜
                let visibilityMap;
                try { visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher') || []; } catch (_) { visibilityMap = []; }

                const getHiddenByIndex = (i) => {
                    if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                    if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                    const m = markers[i];
                    if (!m) return false;
                    if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                    if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                    if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                    return false;
                };

                // slasher1.svg é€ä¸€ç»Ÿè®¡ï¼ˆå‰3ä¸ªï¼‰
                let hiddenFirst = 0;
                for (let i = 0; i < firstCount; i++) if (getHiddenByIndex(i)) hiddenFirst++;

                // slasher2.svg ç»„èŒƒå›´ï¼ˆæœ€å1ä¸ªç»„ï¼ŒåŒ…å«æ‰€æœ‰lastæ ‡è®°ï¼‰
                const lastStart = firstCount;
                const lastEnd = firstCount + lastCount;

                const rangeAllHidden = (start, end) => {
                    if (start >= end) return false;
                    for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                    return true;
                };

                const lastHidden = rangeAllHidden(lastStart, lastEnd);

                const hidden = hiddenFirst + (lastHidden ? 1 : 0);

                CounterCache.updateCounter('serial_killer_slasher', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ´›åœ£éƒ½æ€äººç‹‚è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateTreasureHuntSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-treasure_hunt_dba_revolver + label .treasure-hunt-counter');
                if (!counterEl) {
                    console.log('å·¦è½®å¯»å®è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è·å–å·¦è½®å¯»å®æ ‡è®°
                const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
                const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
                
                let total = 4; // æ€»æ•°ä¸º4
                let hidden = 0;

                // æ£€æŸ¥th1æ ‡è®°ï¼ˆä»»æ„ä¸€ä¸ªéšè—åˆ™å…¨éƒ¨éšè—ï¼Œä½†è®¡æ•°å™¨åª+1ï¼‰
                let th1Hidden = false;
                th1Markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') {
                            th1Hidden = true;
                        }
                    }
                });
                if (th1Hidden) {
                    hidden += 1; // th1éšè—æ—¶è®¡æ•°å™¨åª+1
                }

                // æ£€æŸ¥th2æ ‡è®°ï¼ˆå•ç‹¬è®¡ç®—ï¼‰
                th2Markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') {
                            hidden++;
                        }
                    }
                });

                console.log('å·¦è½®å¯»å®è®¡æ•°å™¨æ›´æ–°:', { 
                    total, 
                    hidden, 
                    th1Markers: th1Markers.length, 
                    th2Markers: th2Markers.length,
                    th1Hidden
                });

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('treasure_hunt_dba_revolver', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('æ›´æ–°å·¦è½®å¯»å®è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateUfoSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ufo + label .ufo-counter');
                if (!counterEl) {
                    console.log('UFOè§‚å…‰è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è·å–UFOè§‚å…‰æ ‡è®°
                const markers = (window.ufoMarkers && window.ufoMarkers) || [];
                const total = Array.isArray(window.itemData?.ufo) ? window.itemData.ufo.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜ï¼Œé¿å…é‡æ–°æ˜¾ç¤ºåè®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('ufo');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ufo', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°UFOè§‚å…‰è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSignalJammersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-signal_jammers + label .signal-jammers-counter');
                if (!counterEl) {
                    console.log('ä¿¡å·å¹²æ‰°å™¨è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è·å–ä¿¡å·å¹²æ‰°å™¨æ ‡è®°
                const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡ï¼ˆå½“å¤©å®é™…æ˜¾ç¤ºçš„æ•°é‡ï¼‰
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶ï¼Œä½¿ç”¨å®é™…æ•°æ®é•¿åº¦
                    total = Array.isArray(window.itemData?.signal_jammers) ? window.itemData.signal_jammers.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('signal_jammers');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('signal_jammers', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°ä¿¡å·å¹²æ‰°å™¨è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateRCTimeTrialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-rc_time_trial + label .rc-time-trial-counter');
                if (!counterEl) {
                    console.log('RCæ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // RCæ—¶é—´æŒ‘æˆ˜èµ›æ€»æ•°å›ºå®šä¸º1
                const total = 1;
                let hidden = 0;

                // è·å–RCæ—¶é—´æŒ‘æˆ˜èµ›æ ‡è®°
                const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡è®¡ç®—éšè—æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('rc_time_trial');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('rc_time_trial', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('æ›´æ–°RCæ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateBikeTimeTrialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-bike_time_trial + label .bike-time-trial-counter');
                if (!counterEl) {
                    console.log('è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›æ€»æ•°å›ºå®šä¸º1
                const total = 1;
                let hidden = 0;

                // è·å–è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›æ ‡è®°
                const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡è®¡ç®—éšè—æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('bike_time_trial');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('bike_time_trial', hidden, total);
                counterEl.textContent = ` (${hidden}/${total})`;
            } catch (e) {
                console.warn('æ›´æ–°è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSmokeProductSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smoke_on_the_water_product + label .smoke-product-counter');
                if (!counterEl) return;

                // è·å–åäº‘åé›¾é¦†äº§å“æ ‡è®°
                const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
                let total = 5; // å›ºå®šæ˜¾ç¤º5ä¸ª
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡ï¼ˆæœ€å¤š5ä¸ªï¼‰
                    total = Math.min(markers.length, 5);
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶ï¼Œä½¿ç”¨å›ºå®šæ•°é‡5
                    total = 5;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('smoke_on_the_water_product');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('smoke_on_the_water_product', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°åäº‘åé›¾é¦†äº§å“è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateHiddenCachesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-hidden_caches + label .hidden-caches-counter');
                if (!counterEl) return;

                // è·å–éšè—åŒ…è£¹æ ‡è®°
                const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
                let total = 10; // å›ºå®šä¸º10ä¸ª
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶ï¼Œä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('hidden_caches');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('hidden_caches', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°éšè—åŒ…è£¹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateShipwreckedSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-shipwrecked + label .shipwrecked-counter');
                if (!counterEl) return;

                // è·å–æ²‰èˆ¹æ ‡è®°
                const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
                let total = 1; // æ²‰èˆ¹å›ºå®šä¸º1ä¸ª
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    // ä½¿ç”¨å®é™…æ¸²æŸ“çš„æ ‡è®°æ•°é‡
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶ï¼Œä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('shipwrecked');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('shipwrecked', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ²‰èˆ¹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateLSTagsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ls_tags + label .ls-tags-counter');
                if (!counterEl) return;

                // è·å–LSæ¶‚é¸¦æ ‡è®°
                const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
                const total = 5; // å›ºå®š5ä¸ª
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜ï¼Œé¿å…é‡æ–°æ˜¾ç¤ºåè®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('ls_tags');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ls_tags', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°LSæ¶‚é¸¦è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆè—åŒ¿å±‹ç‰¹æ®Šï¼šå›ºå®šä¸º1ä¸ªï¼‰
        function updateStashHousesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-stash_houses + label .stash-houses-counter');
                if (!counterEl) return;

                // è—åŒ¿å±‹ç‰¹æ®Šï¼šå›ºå®šä¸º1ä¸ªï¼Œè™½ç„¶ä¼šæ˜¾ç¤ºå¤šä¸ªå›¾æ ‡
                const total = 1;
                let hidden = 0;

                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„éšè—çŠ¶æ€
                const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('stash_houses', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è—åŒ¿å±‹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateActionFiguresSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-action_figures + label .action-figures-counter');
                if (!counterEl) return;

                // è·å–æ‰‹åŠæ ‡è®°
                const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶
                    total = Array.isArray(window.itemData?.action_figures) ? window.itemData.action_figures.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('action_figures');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('action_figures', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ‰‹åŠè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updatePlayingCardsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-playing_cards + label .playing-cards-counter');
                if (!counterEl) return;

                // è·å–çº¸ç‰Œæ ‡è®°
                const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
                const total = Array.isArray(window.itemData?.playing_cards) ? window.itemData.playing_cards.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜
                const cachedCounter = CounterCache.getCounter('playing_cards');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('playing_cards', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°çº¸ç‰Œè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆå—ç“œç¯ï¼Œé›†æˆç¼“å­˜ï¼‰
        function updateJackOLanternsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-jack_o_lanterns + label .jack-counter');
                if (!counterEl) return;

                const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
                const total = Array.isArray(window.itemData?.jack_o_lanterns) ? window.itemData.jack_o_lanterns.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜ï¼Œé¿å…é‡æ–°æ˜¾ç¤ºåè®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('jack_o_lanterns');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('jack_o_lanterns', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å—ç“œç¯è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSpraySidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spray + label .spray-counter');
                if (!counterEl) return;

                // å–·çŒä½ç½®è®¡æ•°å™¨å›ºå®šä¸º1ï¼Œéšè—ä¸€ä¸ªæ ‡è®°åéšè—å…¨éƒ¨å›¾æ ‡
                const totalCount = 1;
                let hiddenCount = 0;

                // æ£€æŸ¥æ˜¯å¦éšè—ï¼ˆä»ç¼“å­˜è·å–ï¼‰
                const cachedCounter = CounterCache.getCounter('spray');
                hiddenCount = cachedCounter.hidden || 0;

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('spray', hiddenCount, totalCount);
                counterEl.textContent = totalCount > 0 ? ` (${hiddenCount}/${totalCount})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å–·çŒä½ç½®è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆé™†åœ°è¿·å¹»ä»™äººæŒæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ppl å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachPplCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppl-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppl-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updatePplSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updatePplSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ppl + label .ppl-counter');
                if (!counterEl) return;

                // è·å–é™†åœ°è¿·å¹»ä»™äººæŒæ ‡è®°
                const markers = (window.pplMarkers && window.pplMarkers) || [];
                const total = Array.isArray(window.itemData?.ppl) ? window.itemData.ppl.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜
                const cachedCounter = CounterCache.getCounter('ppl');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ppl', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°é™†åœ°è¿·å¹»ä»™äººæŒè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆæ°´ä¸‹è¿·å¹»ä»™äººæŒæ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º ppw å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachPpwCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.ppw-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'ppw-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updatePpwSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updatePpwSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ppw + label .ppw-counter');
                if (!counterEl) return;

                // è·å–æ°´ä¸‹è¿·å¹»ä»™äººæŒæ ‡è®°
                const markers = (window.ppwMarkers && window.ppwMarkers) || [];
                const total = Array.isArray(window.itemData?.ppw) ? window.itemData.ppw.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜
                const cachedCounter = CounterCache.getCounter('ppw');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ppw', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ°´ä¸‹è¿·å¹»ä»™äººæŒè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateYuanbaoSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-yuanbao + label .yuanbao-counter');
                if (!counterEl) return;

                // è·å–å…ƒå®æ ‡è®°
                const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
                const total = Array.isArray(window.itemData?.yuanbao) ? window.itemData.yuanbao.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜
                const cachedCounter = CounterCache.getCounter('yuanbao');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('yuanbao', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å…ƒå®è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateStuntJumpsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-stunt_jumps + label .stunt-jumps-counter');
                if (!counterEl) return;

                // è·å–ç‰¹æŠ€è·³è·ƒç‚¹æ ‡è®°
                const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') {
                                hidden++;
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶
                    total = Array.isArray(window.itemData?.stunt_jumps) ? window.itemData.stunt_jumps.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('stunt_jumps');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('stunt_jumps', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°ç‰¹æŠ€è·³è·ƒç‚¹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSnowmenSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-snowmen + label .snowmen-counter');
                if (!counterEl) return;

                // è·å–é›ªäººæ ‡è®°
                const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
                const total = Array.isArray(window.itemData?.snowmen) ? window.itemData.snowmen.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // åˆå¹¶ç¼“å­˜ï¼Œé¿å…é‡æ–°æ˜¾ç¤ºåè®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('snowmen');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('snowmen', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°é›ªäººè®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateGhosts3SidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-ghosts3 + label .ghosts3-counter');
                if (!counterEl) return;

                // è·å–å¹½çµæ›å…‰2025æ ‡è®°
                const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    markers.forEach((marker) => {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                const opacity = el.style.opacity;
                                if (opacity === '0.3' || opacity === 0.3 || opacity === '0.30') {
                                    hidden++;
                                }
                            }
                        }
                    });
                } else {
                    // å›é€€ï¼šä»…æœ‰æ•°æ®å°šæœªæ¸²æŸ“ Leaflet æ ‡è®°æ—¶
                    total = Array.isArray(window.itemData?.ghosts3) ? window.itemData.ghosts3.length : 0;
                    // ä»ç¼“å­˜ä¸­è·å–éšè—æ•°é‡
                    const cachedCounter = CounterCache.getCounter('ghosts3');
                    hidden = cachedCounter.hidden || 0;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('ghosts3', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å¹½çµæ›å…‰2025è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨çº¢çº¿ä¸è®¡æ•°å™¨ã€å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ã€ç¼“å­˜é›†æˆï¼‰
        function showSmugglerPlanePopup(item, index) {
            const content = `åœ¨é£æœºå æ¯å¤„æ”¶é›†è£…æœ‰ 25.000 GTA$ å’Œ 2.000 RP çš„å…¬æ–‡åŒ…ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/smuggler_plane/smuggler_plane.webp';

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.smuggler-plane-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const smugglerGroups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
            const totalCount = smugglerGroups.length;

            let hiddenCount = 0;
            smugglerGroups.forEach((groupMarkers) => {
                const first = groupMarkers && groupMarkers[0];
                if (first && first.getElement) {
                    const el = first.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentGroupMarkers = smugglerGroups[index] || [];
            let isCurrentHidden = false;
            if (currentGroupMarkers && currentGroupMarkers.length > 0) {
                const first = currentGroupMarkers[0];
                if (first && first.getElement) {
                    const el = first.getElement();
                    isCurrentHidden = el && el.style.opacity === '0.3';
                }
            }

            const title = `âœˆï¸ èµ°ç§è´©é£æœº #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'smuggler-plane-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="èµ°ç§è´©é£æœºå›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-smuggler-plane-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-smuggler-plane-btn');
            const hideBtn = popup.querySelector('#hide-smuggler-plane-btn');
            const showBtn = popup.querySelector('#show-smuggler-plane-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'smuggler-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰ç»„ï¼ˆåŒ…å« marker ä¸ polylineï¼›å…¼å®¹æ—§ DOM çº¢çº¿ï¼‰
            function setCurrentGroupVisibility(opacity) {
                if (currentGroupMarkers && currentGroupMarkers.length > 0) {
                    currentGroupMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                // åŒæ­¥æ—§ç‰ˆ DOM çº¢çº¿
                document.querySelectorAll(`.smuggler-connector-line[data-type="smuggler_plane_line"][data-index="${index}"]`).forEach((el) => {
                    el.style.opacity = String(opacity);
                });
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('smuggler_plane', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentGroupVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `âœˆï¸ èµ°ç§è´©é£æœº #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSmugglerPlaneSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentGroupVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `âœˆï¸ èµ°ç§è´©é£æœº #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSmugglerPlaneSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // å¾…å”®æ ‡å¿—å¼¹çª—ï¼ˆå«éšè—/æ˜¾ç¤ºä¸å¯è§æ€§ç¼“å­˜ï¼‰
        function showForSaleSignPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/for_sale_sign/for_sale_sign_${sequenceNumber}.webp`;

            const existing = document.querySelector('.for-sale-sign-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'for-sale-sign-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px; z-index: 10000; width: min(92vw, 520px); max-height: 80vh;
                color: var(--gta-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto;`;

            const title = `ğŸª§ å¾…å”®æ ‡å¿— #${sequenceNumber}`;
            const content = `åœ¨é™Œç”Ÿäººå’Œæ€ªèƒä»»åŠ¡é¢å¤–ä½£é‡‘ï¼ˆå´”ä½›ï¼‰ä¸­ï¼Œæ‚¨éœ€è¦æ‘§æ¯è¿™äº›â€œå¾…å”®â€æ ‡å¿—ä»¥æ¨è¿›ä»»åŠ¡ã€‚`;

            // å½“å‰æ ‡è®°å¥æŸ„
            const markers = (window.forSaleSignMarkers && window.forSaleSignMarkers) || [];
            const currentMarker = markers[index];

            // æ˜¯å¦éšè—ï¼ˆæ¥è‡ªç¼“å­˜ï¼‰
            const vm = VisibilityCache.loadVisibility('for_sale_sign') || {};
            let isHidden = vm[index] === true;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="for_sale_sign #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-fss-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-fss-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-fss-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">å…³é—­</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-fss-btn');
            const hideBtn = popup.querySelector('#hide-fss-btn');
            const showBtn = popup.querySelector('#show-fss-btn');

            const setOpacity = (opacity) => {
                if (!currentMarker) return;
                if (typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
            };

            if (hideBtn) hideBtn.addEventListener('click', () => {
                setOpacity(0.3);
                VisibilityCache.updateItemVisibility('for_sale_sign', index, true);
                if (hideBtn) hideBtn.style.display = 'none';
                if (showBtn) showBtn.style.display = 'inline-block';
                isHidden = true;
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                setOpacity(1);
                VisibilityCache.updateItemVisibility('for_sale_sign', index, false);
                if (showBtn) showBtn.style.display = 'none';
                if (hideBtn) hideBtn.style.display = 'inline-block';
                isHidden = false;
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            });

            // å…³é—­å¼¹çª—ä¸å¤–éƒ¨ç‚¹å‡»å…³é—­
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆè¦†ç›–å±‚ï¼Œä¸æ‰“å¼€æ–°æ ‡ç­¾ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            document.body.appendChild(popup);
        }

        // ä¾§è¾¹æ è®¡æ•°å™¨ï¼šfor_sale_signï¼ˆåŸºäº VisibilityCache ç»Ÿè®¡éšè—/æ€»æ•°ï¼‰
        function updateForSaleSignSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-for_sale_sign + label .for-sale-sign-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.for_sale_sign) ? window.itemData.for_sale_sign.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('for_sale_sign') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('for_sale_sign', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–° for_sale_sign è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // åº”ç”¨ for_sale_sign å¯è§æ€§ç¼“å­˜ï¼ˆè®¾ç½®é€æ˜åº¦ï¼‰
        function applyForSaleSignVisibilityCache() {
            try {
                const markers = (window.forSaleSignMarkers && window.forSaleSignMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const vm = VisibilityCache.loadVisibility('for_sale_sign') || {};
                markers.forEach((marker, i) => {
                    const isHidden = !!vm[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (!marker) return;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                    else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                });
                try { updateForSaleSignSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('åº”ç”¨ for_sale_sign å¯è§æ€§ç¼“å­˜å¤±è´¥:', e); }
        }

        // å¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰- é“è…• å¼¹çª—ï¼ˆå«éšè—/æ˜¾ç¤ºä¸å¯è§æ€§ç¼“å­˜ã€è®¡æ•°å™¨ï¼‰
        function showTheBigScoreGauntletPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/the_big_score_gauntlet/the_big_score_gauntlet_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„åŒç±»å¼¹çª—
            const existing = document.querySelector('.the-big-score-gauntlet-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'the-big-score-gauntlet-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px; z-index: 10000; width: min(92vw, 520px); max-height: 80vh;
                color: var(--gta-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto;`;

            const title = `ğŸš— å¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰- é“è…• #${sequenceNumber}`;
            const content = `ä¸»çº¿ä»»åŠ¡â€œå¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰â€çš„å‰ç½®ä»»åŠ¡ä¸­æ‰€éœ€å·å–å¹¶æ”¹è£…çš„é“è…•ã€‚è±æ–¯ç‰¹ä¼šç»™æ¯ä¸ªè§’è‰²å‘é€æœ‰å…³é“è…•ä½ç½®çš„ç”µå­é‚®ä»¶ï¼Œä½†å®ƒä»¬çš„ä½ç½®ä¸ä¼šæ ‡è®°åœ¨æ¸¸æˆå†…åœ°å›¾ä¸Šã€‚å½“ç„¶ï¼Œæ‚¨å¯ä»¥åœ¨è¡—ä¸Šå·å–åˆ«çš„é“è…•ï¼Œæˆ–è€…å¹²è„†è‡ªå·±ä¹°ä¸€å°ï¼›ä¸è¿‡è¿™ä¹ˆåšä¸èƒ½è§£é”å‰ç½®ä»»åŠ¡çš„é‡‘ç‰Œã€‚æ‚¨éœ€è¦å·å– 3 å°é“è…•ï¼Œåˆ†åˆ«å¯¹åº” 3 ä¸ªä¸åŒçš„å‰ç½®ä»»åŠ¡ã€‚`;

            // å½“å‰æ ‡è®°å¥æŸ„ä¸éšè—çŠ¶æ€
            const markers = (window.theBigScoreGauntletMarkers && window.theBigScoreGauntletMarkers) || [];
            const currentMarker = markers[index];
            const vm = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
            let isHidden = vm[index] === true;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="the_big_score_gauntlet #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-tbsg-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-tbsg-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-tbsg-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">å…³é—­</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-tbsg-btn');
            const hideBtn = popup.querySelector('#hide-tbsg-btn');
            const showBtn = popup.querySelector('#show-tbsg-btn');

            const setOpacity = (opacity) => {
                if (!currentMarker) return;
                if (typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
            };

            if (hideBtn) hideBtn.addEventListener('click', () => {
                setOpacity(0.3);
                VisibilityCache.updateItemVisibility('the_big_score_gauntlet', index, true);
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isHidden = true;
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                setOpacity(1);
                VisibilityCache.updateItemVisibility('the_big_score_gauntlet', index, false);
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isHidden = false;
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            });

            // å…³é—­å¼¹çª—ä¸å¤–éƒ¨ç‚¹å‡»
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆè¦†ç›–å±‚ï¼Œä¸æ‰“å¼€æ–°æ ‡ç­¾ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            document.body.appendChild(popup);
        }

        // ä¾§è¾¹æ è®¡æ•°å™¨ï¼šthe_big_score_gauntletï¼ˆåŸºäº VisibilityCache ç»Ÿè®¡éšè—/æ€»æ•°ï¼‰
        function updateTheBigScoreGauntletSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-the_big_score_gauntlet + label .the-big-score-gauntlet-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.the_big_score_gauntlet) ? window.itemData.the_big_score_gauntlet.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('the_big_score_gauntlet', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–° the_big_score_gauntlet è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // åº”ç”¨ the_big_score_gauntlet å¯è§æ€§ç¼“å­˜ï¼ˆè®¾ç½®é€æ˜åº¦ï¼‰
        function applyTheBigScoreGauntletVisibilityCache() {
            try {
                const markers = (window.theBigScoreGauntletMarkers && window.theBigScoreGauntletMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const vm = VisibilityCache.loadVisibility('the_big_score_gauntlet') || {};
                markers.forEach((marker, i) => {
                    const isHidden = !!vm[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (!marker) return;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                    else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                });
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('åº”ç”¨ the_big_score_gauntlet å¯è§æ€§ç¼“å­˜å¤±è´¥:', e); }
        }

        // æ­ä¾¿è½¦ï¼ˆæ½œåœ¨çš„åˆ©ä»–é‚ªæ•™å—å®³è€…ï¼‰æ–‡æœ¬å¼¹çª—ï¼ˆæ— å›¾ç‰‡ï¼Œå«éšè—/æ˜¾ç¤º+è®¡æ•°å™¨ï¼‰
        function showHitchhikersPopup(item, index) {
            const sequenceNumber = index + 1;
            const baseTitle = `ğŸš¶ æ­ä¾¿è½¦ #${sequenceNumber}`;
            const extra = `æ‚¨å¯ä»¥ä¸ºéœ€è¦æ­ä¾¿è½¦çš„äººä¼¸å‡ºæ´æ‰‹ï¼Œç‰¹åˆ«åœ°ï¼Œå´”ä½›åˆ™è¿˜å¯ä»¥é€‰æ‹©å°†æ­è½¦äººé€åˆ°åˆ©ä»–ä¸»ä¹‰é‚ªæ•™è¥åœ°å¹¶èµšå– 1.000 GTA$ã€‚åœ¨å´”ä½›å¸¦è¿‡ 4 åæ­è½¦äººï¼ˆä¸æ˜¯å¸¦äºº 4 æ¬¡ã€‚ä¸€æ¬¡å¸¦æ¥ 2 äººï¼Œè¿›åº¦åŠ  2ï¼‰åˆ°åˆ©ä»–è¥åœ°åï¼Œé‚ªæ•™å¾’ä¼šè¯•å›¾è®©ä»–æˆä¸ºä¸‹ä¸€ä¸ªå—å®³è€…ã€‚`;

            const notes = Array.isArray(item?.notes) ? item.notes : [];

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆåŸºäº VisibilityCacheï¼‰
            const arr = Array.isArray(window.itemData?.hitchhikers) ? window.itemData.hitchhikers : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('hitchhikers') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) if (visibilityMap[i] === true) hiddenCount++;
            let isCurrentHidden = visibilityMap[index] === true;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existing = document.querySelector('.hitchhikers-popup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.className = 'hitchhikers-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 16px; z-index: 10000; width: min(92vw, 540px); max-height: 80vh;
                color: var(--gta-text); overflow-y: auto;`;

            const htmlNotes = notes.map(n => `<li style="margin: 6px 0; line-height: 1.6;">${n}</li>`).join('');
            popup.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <h3 id="hitch-title" style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: 700;">${baseTitle} (${hiddenCount}/${totalCount})</h3>
                </div>
                <div style="padding: 8px 10px; background: rgba(33,150,243,0.08); border: 1px solid var(--gta-border); border-radius: 6px;">
                    ${notes.length ? `<ul style=\"padding-left:18px;margin:8px 0;\">${htmlNotes}</ul>` : '<div style="opacity:0.8;">æš‚æ— è¯´æ˜</div>'}
                    <div style="margin-top:8px; line-height:1.7;">${extra}</div>
                </div>
                <div style="margin-top: 14px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-hitch-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-hitch-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-hitch-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">å…³é—­</button>
                </div>
            `;

            // å½“å‰æ ‡è®°ä¸è®¾ç½®å‡½æ•°
            const markers = (window.hitchhikersMarkers && window.hitchhikersMarkers) || [];
            const currentMarker = markers[index];
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (currentMarker && typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (currentMarker && typeof currentMarker.getElement === 'function') { const el = currentMarker.getElement(); if (el) el.style.opacity = String(opacity); }
                VisibilityCache.updateItemVisibility('hitchhikers', index, opacity === 0.3);
            }

            // ç»‘å®šå…ƒç´ 
            const titleElement = popup.querySelector('#hitch-title');
            const closeBtn = popup.querySelector('#close-hitch-btn');
            const hideBtn = popup.querySelector('#hide-hitch-btn');
            const showBtn = popup.querySelector('#show-hitch-btn');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => { if (!popup.contains(e.target)) { removePopup(); document.removeEventListener('click', closePopupHandler); } };
                document.addEventListener('click', closePopupHandler);
            }, 20);

            // éšè—/æ˜¾ç¤ºæŒ‰é’®é€»è¾‘
            if (hideBtn) hideBtn.addEventListener('click', () => {
                if (!isCurrentHidden) hiddenCount = hiddenCount + 1;
                setCurrentMarkerVisibility(0.3);
                titleElement && (titleElement.textContent = `${baseTitle} (${hiddenCount}/${totalCount})`);
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isCurrentHidden = true;
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            });
            if (showBtn) showBtn.addEventListener('click', () => {
                if (isCurrentHidden && hiddenCount > 0) hiddenCount = hiddenCount - 1;
                setCurrentMarkerVisibility(1);
                titleElement && (titleElement.textContent = `${baseTitle} (${hiddenCount}/${totalCount})`);
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isCurrentHidden = false;
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            });

            document.body.appendChild(popup);
        }

        // ä¾§è¾¹æ è®¡æ•°å™¨ï¼šhitchhikersï¼ˆåŸºäº VisibilityCache ç»Ÿè®¡éšè—/æ€»æ•°ï¼‰
        function updateHitchhikersSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-hitchhikers + label .hitchhikers-counter');
                if (!counterEl) return;
                const total = Array.isArray(window.itemData?.hitchhikers) ? window.itemData.hitchhikers.length : 0;
                const vm = VisibilityCache.loadVisibility('hitchhikers') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (vm[i] === true) hidden++;
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) { console.warn('æ›´æ–° hitchhikers è®¡æ•°å™¨å¤±è´¥:', e); }
        }

        // åº”ç”¨ hitchhikers å¯è§æ€§ç¼“å­˜ï¼ˆè®¾ç½®é€æ˜åº¦+åˆ·æ–°è®¡æ•°å™¨ï¼‰
        function applyHitchhikersVisibilityCache() {
            try {
                const markers = (window.hitchhikersMarkers && window.hitchhikersMarkers) || [];
                const vm = VisibilityCache.loadVisibility('hitchhikers') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!vm[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                        else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                        else if (typeof marker.getElement === 'function') { const el = marker.getElement(); if (el) el.style.opacity = String(opacity); }
                    });
                }
                try { updateHitchhikersSidebarCount(); } catch (e) {}
            } catch (e) { console.warn('åº”ç”¨ hitchhikers å¯è§æ€§ç¼“å­˜å¤±è´¥:', e); }
        }

        // è°‹æ€ä¹‹è°œä¿¡æ¯å¼¹çª—ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showMurderMysteryMessageImage(index) {
            const item = (itemData.murder_mystery_message && itemData.murder_mystery_message[index]) || null;
            if (!item) return;

            // å›¾ç‰‡å‘½åæŒ‰åˆå¹¶åçš„è¿ç»­åºå· 1..Nï¼ˆè€Œä¸æ˜¯ æŒ‰ç»„-ç»„å†…åºå·ï¼‰
            const sequenceNumber = index + 1;
            const group = item.group || '?';
            const groupIndex = item.groupIndex || sequenceNumber;
            const titleSeq = `${sequenceNumber}`; // æ ‡é¢˜ä¸»åºå·ä½¿ç”¨åˆå¹¶åºå·
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/murder_mystery_message/murder_mystery_message_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„åŒç±»å¼¹çª—
            const existingPopup = document.querySelector('.murder-mystery-message-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡
            const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
            const totalCount = Array.isArray(itemData.murder_mystery_message) ? itemData.murder_mystery_message.length : markers.length;
            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ•µï¸ è°‹æ€ä¹‹è°œä¿¡æ¯ #${titleSeq}ï¼ˆç»„ ${group} - ${groupIndex}ï¼‰ (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'murder-mystery-message-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è°‹æ€ä¹‹è°œä¿¡æ¯ ${titleSeq}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    è¯¥ç‰¹æ€§ä»…é™æ›¾ç»äº PlayStation 3 æˆ– Xbox 360 ä¸»æœºæ¸¸ç©è¿‡ GTA V çš„ç©å®¶å¯ç”¨ã€‚å—æ¼æ´å½±å“ï¼Œå…¨ä½“ç©å®¶å‡èƒ½äº«å—å›å½’ç©å®¶ç¦åˆ©â€”â€”å³ä½¿æ‚¨å¹¶æœªåœ¨ä¸Šä¸–ä»£ä¸»æœºä¸Šæ¸¸ç©è¿‡ GTA Vï¼Œæ‚¨ä¹Ÿå¯ä»¥äº«å—è¿™äº›ç¦åˆ©ã€‚
                </div>
                <div style="margin: 10px 0; padding: 12px; background: rgba(0,0,0,0.35); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.7;">
                    <div style="font-weight: 700; color: var(--gta-primary); margin-bottom: 6px;">ğŸ•µï¸ è°‹æ€ä¹‹è°œæµç¨‹è¯´æ˜</div>
                    <div style="margin-bottom: 8px;">è°‹æ€ä¹‹è°œä»…èƒ½ç”± <b>éº¦å…‹</b> è§£å¼€ã€‚</div>
                    <ol style="padding-left: 18px; margin: 6px 0;">
                        <li>é¦–å…ˆï¼Œä»–éœ€è¦æ‰¾åˆ°å››æ¡åˆ»åœ¨å¢™ä¸Šçš„ä¿¡æ¯å’Œæ²‰æ²¡çš„å°¸ä½“ã€‚</li>
                        <li>ä¹‹åï¼Œä»–éœ€è¦åœ¨æ‰€ç½—é—¨Â·ç†æŸ¥å…¹çš„åŠå…¬å®¤é˜…è¯»ä¸€å°ä¿¡ä»¶ã€‚è¦è¿›å…¥åŠå…¬å®¤ï¼Œç©å®¶é¡»åœ¨å®Œæˆä¸»çº¿ä»»åŠ¡<b>æ³•å¾‹çº çº·</b>åï¼Œå†äº<b>æ™šä¸Š 9:00 è‡³ æ—©ä¸Š 6:00</b>å‰å¾€ã€‚</li>
                        <li>ä¸ºè§£å¼€è°œé¢˜ï¼Œä»–è¿˜éœ€è¦æ‰¾åˆ°å¦ä¸€å…·å°¸ä½“ã€‚</li>
                    </ol>
                    <div style="margin-top: 8px;"><b>å¥–åŠ±</b>ï¼š2 ä¸ªå¤å¤æ»¤é•œã€‚ä¸è‰¾è¨å…‹çš„å°¸ä½“äº’åŠ¨ï¼Œæˆ–æ‰“ä»–çš„ç”µè¯ï¼ˆæ‰€æœ‰è§’è‰²éƒ½å°†è·å¾—ä»–çš„ç”µè¯ï¼‰ï¼Œå³å¯åœ¨æ¸¸æˆä¸­åº”ç”¨å¤å¤æ»¤é•œã€‚</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-mmm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-mmm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-mmm-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-mmm-btn');
            const hideBtn = popup.querySelector('#hide-mmm-btn');
            const showBtn = popup.querySelector('#show-mmm-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popupClose && popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆè¦†ç›–å±‚ï¼Œä¸æ‰“å¼€æ–°æ ‡ç­¾ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®° + ç¼“å­˜
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('murder_mystery_message', index, opacity === 0.3);
            }

            // éšè—/æ˜¾ç¤ºæŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ•µï¸ è°‹æ€ä¹‹è°œä¿¡æ¯ #${titleSeq}ï¼ˆç»„ ${group} - ${groupIndex}ï¼‰ (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ•µï¸ è°‹æ€ä¹‹è°œä¿¡æ¯ #${titleSeq}ï¼ˆç»„ ${group} - ${groupIndex}ï¼‰ (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨è°‹æ€ä¹‹è°œä¿¡æ¯å¯è§æ€§ç¼“å­˜
        function applyMurderMysteryMessageVisibilityCache() {
            try {
                const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const visibilityMap = VisibilityCache.loadVisibility('murder_mystery_message') || {};
                markers.forEach((marker, i) => {
                    if (!marker) return;
                    const isHidden = !!visibilityMap[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                });
                // åº”ç”¨ç¼“å­˜åå°è¯•åˆ·æ–°è®¡æ•°å™¨
                try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('åº”ç”¨è°‹æ€ä¹‹è°œä¿¡æ¯å¯è§æ€§ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateMurderMysteryMessageSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-murder_mystery_message + label .murder-mystery-message-counter');
                if (!counterEl) return;

                // è·å–å½“å‰æ ‡è®°ä¸æ€»æ•°
                const markers = (window.murderMysteryMessageMarkers && window.murderMysteryMessageMarkers) || [];
                let total = 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    total = markers.length;
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                } else {
                    // å›¾å±‚æœªæ˜¾ç¤ºæ—¶ï¼šä½¿ç”¨æ•°æ®æ€»é‡ + å¯è§æ€§ç¼“å­˜æ¥ç»Ÿè®¡éšè—æ•°é‡ï¼Œé¿å…é‡ç½®ä¸º0
                    const dataArr = Array.isArray(window.itemData?.murder_mystery_message) ? window.itemData.murder_mystery_message : [];
                    total = dataArr.length;
                    const visibilityMap = VisibilityCache.loadVisibility('murder_mystery_message') || {};
                    for (let i = 0; i < total; i++) {
                        if (visibilityMap[i] === true) hidden++;
                    }
                    // å¦‚æœå°šæ— å¯è§æ€§ç¼“å­˜ï¼Œåˆ™å°è¯•ä½¿ç”¨ä¸Šæ¬¡è®¡æ•°å™¨ç¼“å­˜
                    const cached = CounterCache.getCounter('murder_mystery_message');
                    if (hidden === 0 && cached && typeof cached.hidden === 'number') hidden = cached.hidden;
                    // è‹¥æ•°æ®æ•°ç»„ä¸ºç©ºï¼ˆä¾‹å¦‚å›¾å±‚è¢«å–æ¶ˆé€‰ä¸­å¯¼è‡´æœªæ¸²æŸ“ä¸”æœ‰æ—¶é—´è¿‡æ»¤ï¼‰ï¼Œä½¿ç”¨ç¼“å­˜ä¸­çš„æ€»æ•°ï¼Œé¿å…æ˜¾ç¤ºä¸º0
                    if ((total === 0 || !Number.isFinite(total)) && cached && typeof cached.total === 'number') total = cached.total;
                }

                // æ›´æ–°ç¼“å­˜ä¸UI
                CounterCache.updateCounter('murder_mystery_message', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è°‹æ€ä¹‹è°œä¿¡æ¯è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆç›å¾·æ‹‰ç´¢é›‡å‡¶ç‰¹æ®Šï¼šå›ºå®šä¸º1ä¸ªï¼‰
        function updateMadrazoHitsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-madrazo_hits + label .madrazo-hits-counter');
                if (!counterEl) return;

                // ç›å¾·æ‹‰ç´¢é›‡å‡¶ç‰¹æ®Šï¼šå›ºå®šä¸º1ä¸ªï¼Œè™½ç„¶ä¼šæ˜¾ç¤ºå¤šä¸ªå›¾æ ‡
                const total = 1;
                let hidden = 0;

                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„éšè—çŠ¶æ€
                const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('madrazo_hits', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°ç›å¾·æ‹‰ç´¢é›‡å‡¶è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // è¡—å¤´æ¯’è´©å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showStreetDealersPopup(item, index) {
            // ä»APIåŠ¨æ€è·å–è¡—å¤´æ¯’è´©ä¿¡æ¯
            fetch('https://api-gta.antwen.com/api/items/street-dealers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStreetDealersPopup(data.data.message, item, index);
                    } else {
                        console.error('è·å–è¡—å¤´æ¯’è´©ä¿¡æ¯å¤±è´¥:', data.error);
                        alert('è·å–è¡—å¤´æ¯’è´©ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                })
                .catch(error => {
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }

        function displayStreetDealersPopup(message, item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.street-dealers-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆä½¿ç”¨å½“å¤©å®é™…æ˜¾ç¤ºçš„æ•°é‡ï¼‰
            const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ’Š è¡—å¤´æ¯’è´© #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'street-dealers-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${message.replace(/\n/g, '<br>')}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-street-dealers-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-street-dealers-btn');
            const hideBtn = popup.querySelector('#hide-street-dealers-btn');
            const showBtn = popup.querySelector('#show-street-dealers-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('street_dealers', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ’Š è¡—å¤´æ¯’è´© #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStreetDealersSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ’Š è¡—å¤´æ¯’è´© #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStreetDealersSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // LSæ¶‚é¸¦å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showLSTagsPopup(item, index) {
            // ä½¿ç”¨APIè¿”å›çš„ç¼–å·æ•°å­—
            const sequenceNumber = item.sequenceNumber;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ls_tags/ls_tags_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.ls-tags-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
            const totalCount = 5; // å›ºå®š5ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ¨ LSæ¶‚é¸¦ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'ls-tags-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="LSæ¶‚é¸¦ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 87, 34, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼æ‰¾åˆ°å¹¶æ”¶é›†æ‰€æœ‰LSæ¶‚é¸¦ï¼Œè§£é”ç‹¬ç‰¹å¥–åŠ±ï¼
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ls-tags-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ls-tags-btn');
            const hideBtn = popup.querySelector('#hide-ls-tags-btn');
            const showBtn = popup.querySelector('#show-ls-tags-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ls-tags-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ls_tags', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ¨ LSæ¶‚é¸¦ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateLSTagsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ¨ LSæ¶‚é¸¦ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateLSTagsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // éšè—åŒ…è£¹å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showHiddenCachesPopup(item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.hidden-caches-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
            const totalCount = 10; // å›ºå®šä¸º10ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ“¦ éšè—åŒ…è£¹ #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'hidden-caches-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="https://gtaweb.eu/_sources/maps_gtao/tips/ls_dc_hc.webp" alt="éšè—åŒ…è£¹å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    åœ¨æŒ‡å®šä½ç½®å¯»æ‰¾éšè—çš„åŒ…è£¹ï¼Œæ”¶é›†åå¯è·å¾—é‡‘é’±å’ŒRPå¥–åŠ±ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-hidden-caches-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-hidden-caches-btn');
            const hideBtn = popup.querySelector('#hide-hidden-caches-btn');
            const showBtn = popup.querySelector('#show-hidden-caches-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'hidden-caches-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('hidden_caches', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateHiddenCachesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateHiddenCachesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°éšè—åŒ…è£¹æ ‡è®°
        function applyHiddenCachesVisibilityCache() {
            const markers = (window.hiddenCachesMarkers && window.hiddenCachesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('hidden_caches');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨éšè—åŒ…è£¹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== çŒ´å­é©¬èµ›å…‹ï¼šè®¡æ•°å™¨ã€å¼¹çª—ã€ç¼“å­˜ ====================
        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateMonkeyMosaicsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-monkey_mosaics + label .monkey-mosaics-counter');
                if (!counterEl) return;

                const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
                const total = Array.isArray(window.itemData?.monkey_mosaics) ? window.itemData.monkey_mosaics.length : 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶
                const cachedCounter = CounterCache.getCounter('monkey_mosaics');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜ä¸UI
                CounterCache.updateCounter('monkey_mosaics', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°çŒ´å­é©¬èµ›å…‹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // çŒ´å­é©¬èµ›å…‹å¼¹çª—ï¼ˆæ ·å¼ä¸æ ¸åºŸæ–™/æ´›åœ£éƒ½çš„äººç±»ä¸€è‡´ï¼‰ï¼Œå«å¥–åŠ±å›¾ç‰‡å¼¹å‡º
        function showMonkeyMosaicsImage(index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/monkey_mosaics/monkey_mosaics_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„åŒç±»å¼¹çª—
            const existingPopup = document.querySelector('.monkey-mosaics-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡
            const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
            const totalCount = markers.length;
            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ’ çŒ´å­é©¬èµ›å…‹ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'monkey-mosaics-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            const awardsTip = `æ¸¸æˆä¸­å…±æœ‰ 50 ä¸ªé©¬èµ›å…‹å¯ä»¥é€šè¿‡æ“æ§ä»»æ„è§’è‰²è¿›è¡Œæ‹æ‘„ã€‚å®Œæˆæ”¶è—å“ï¼Œæ‚¨å°†è·å¾— <a href="#" class="award-outfit">å´”ä½›çš„ä¸€å¥—è¡£æœ</a>ï¼Œå¹¶è§£é”ä¸çŒ´å­é©¬èµ›å…‹ç›¸å…³çš„äº‹ä»¶ã€‚å®Œæˆæ­¤äº‹ä»¶ï¼Œæ‚¨è¿˜å°†è·å¾—ä¸€è¾† <a href="#" class="award-vehicle">å†²å†²çŒ´æ—…è¡Œå®¶</a>ã€‚`;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="çŒ´å­é©¬èµ›å…‹ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${awardsTip}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-monkey-mosaics-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-monkey-mosaics-btn');
            const hideBtn = popup.querySelector('#hide-monkey-mosaics-btn');
            const showBtn = popup.querySelector('#show-monkey-mosaics-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å¥–åŠ±å›¾ç‰‡å¼¹å‡º
            const outfitLink = popup.querySelector('.award-outfit');
            const vehicleLink = popup.querySelector('.award-vehicle');
            function showAwardOverlay(url) {
                const overlay = document.createElement('div');
                overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                const img = document.createElement('img');
                img.src = url;
                img.style.cssText = 'max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);';
                overlay.appendChild(img);
                const remove = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                const onKey = (ev) => { if (ev.key === 'Escape') remove(); };
                overlay.addEventListener('click', remove);
                document.addEventListener('keydown', onKey);
                document.body.appendChild(overlay);
            }
            if (outfitLink) {
                outfitLink.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    showAwardOverlay('https://gtaweb.eu/_sources/maps_gtao/tips/monkey_mosaics_awards.webp');
                });
            }
            if (vehicleLink) {
                vehicleLink.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    showAwardOverlay('https://gtaweb.eu/_sources/maps_gtao/tips/monkey_mosaics_random_event_award.webp');
                });
            }

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'monkey-mosaics-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®° + ç¼“å­˜
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('monkey_mosaics', index, opacity === 0.3);
            }

            // éšè—/æ˜¾ç¤ºæŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ’ çŒ´å­é©¬èµ›å…‹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    updateMonkeyMosaicsSidebarCount();
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ’ çŒ´å­é©¬èµ›å…‹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    updateMonkeyMosaicsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ° monkey_mosaics æ ‡è®°
        function applyMonkeyMosaicsVisibilityCache() {
            const markers = (window.monkeyMosaicsMarkers && window.monkeyMosaicsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('monkey_mosaics');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨çŒ´å­é©¬èµ›å…‹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ²‰èˆ¹å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showShipwreckedPopup(item, index) {
            // ä»APIæ¶ˆæ¯ä¸­æå–æ²‰èˆ¹ç¼–å·
            let sequenceNumber = index + 1; // é»˜è®¤ä½¿ç”¨index+1
            
            // å¦‚æœæœ‰APIæ¶ˆæ¯ï¼Œå°è¯•ä»ä¸­æå–æ­£ç¡®çš„ç¼–å·
            if (itemData.shipwreckedMessage) {
                const match = itemData.shipwreckedMessage.match(/#(\d+)/);
                if (match && match[1]) {
                    sequenceNumber = parseInt(match[1]);
                    console.log('ä»APIæ¶ˆæ¯ä¸­æå–çš„æ²‰èˆ¹ç¼–å·:', sequenceNumber);
                }
            }
            
            console.log('æ²‰èˆ¹sequenceNumber:', sequenceNumber);
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/shipwrecks/shipwrecks_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.shipwrecked-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
            const totalCount = 1; // æ²‰èˆ¹å›ºå®šä¸º1ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `âš“ æ²‰èˆ¹ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'shipwrecked-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ²‰èˆ¹ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(121, 85, 72, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #5D4037; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ”¶é›†æ‰€æœ‰æ²‰èˆ¹å¯è·å¾—ï¼šè¾¹å¢ƒå¥—è£…
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-shipwrecked-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-shipwrecked-btn');
            const hideBtn = popup.querySelector('#hide-shipwrecked-btn');
            const showBtn = popup.querySelector('#show-shipwrecked-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'shipwrecked-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('shipwrecked', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `âš“ æ²‰èˆ¹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateShipwreckedSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `âš“ æ²‰èˆ¹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateShipwreckedSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ²‰èˆ¹æ ‡è®°
        function applyShipwreckedVisibilityCache() {
            const markers = (window.shipwreckedMarkers && window.shipwreckedMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('shipwrecked');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ²‰èˆ¹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°è—åŒ¿å±‹æ ‡è®°
        function applyStashHousesVisibilityCache() {
            const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
            const isHidden = visibilityMap[0] === true;
            
            if (isHidden) {
                // éšè—æ‰€æœ‰è—åŒ¿å±‹ç›¸å…³çš„æ ‡è®°
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('stash')) {
                        marker.style.opacity = '0.3';
                    }
                });

                // åŒæ—¶å¤„ç†é€šç”¨çš„ Leaflet æ ‡è®°ï¼ˆé€šè¿‡å›¾æ ‡URLè¯†åˆ« stash_housesï¼‰
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('stash')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(0.3);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity: 0.3 });
                                }
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯
                        }
                    });
                }

                // åŒæ—¶å¤„ç†Leafletæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.stashHousesMarkers && Array.isArray(window.stashHousesMarkers)) {
                    window.stashHousesMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(0.3);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity: 0.3 });
                        }
                    });
                }
                
                console.log('å·²åº”ç”¨è—åŒ¿å±‹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°RCæ—¶é—´æŒ‘æˆ˜èµ›æ ‡è®°
        function applyRCTimeTrialVisibilityCache() {
            const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('rc_time_trial');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨RCæ—¶é—´æŒ‘æˆ˜èµ›å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›æ ‡è®°
        function applyBikeTimeTrialVisibilityCache() {
            const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('bike_time_trial');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°ç›å¾·æ‹‰ç´¢é›‡å‡¶æ ‡è®°
        function applyMadrazoHitsVisibilityCache() {
            const markers = (window.madrazoHitsMarkers && window.madrazoHitsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
                const isHidden = visibilityMap[0] === true;
                if (isHidden) {
                    markers.forEach((marker) => {
                        if (marker) {
                            if (typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        }
                    });
                }
                console.log('å·²åº”ç”¨ç›å¾·æ‹‰ç´¢é›‡å‡¶å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æœ‰æœºåŠäº§å“æ ‡è®°
        function applyOrganicFarmVisibilityCache() {
            const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ld_organics_products');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æœ‰æœºåŠäº§å“å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°ç‰¹æŠ€è·³è·ƒç‚¹æ ‡è®°
        function applyStuntJumpsVisibilityCache() {
            const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('stunt_jumps');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨ç‰¹æŠ€è·³è·ƒç‚¹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°ç”µå½±é“å…·æ ‡è®°
        function applyMoviePropsVisibilityCache() {
            const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('movie_props');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨ç”µå½±é“å…·å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°è¡—å¤´æ¯’è´©æ ‡è®°
        function applyStreetDealersVisibilityCache() {
            const markers = (window.streetDealersMarkers && window.streetDealersMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('street_dealers');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨è¡—å¤´æ¯’è´©å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ´›åœ£éƒ½æ€äººç‹‚æ ‡è®°
        function applySlasherVisibilityCache() {
            const markers = (window.slasherMarkers && window.slasherMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ´›åœ£éƒ½æ€äººç‹‚å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å¹½çµæ›å…‰2025æ ‡è®°
        function applyGhosts3VisibilityCache() {
            const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ghosts3');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        } else if (typeof marker.getElement === 'function') {
                            // å¯¹äºdivIconï¼Œç›´æ¥è®¾ç½®å…ƒç´ çš„é€æ˜åº¦
                            const el = marker.getElement();
                            if (el) {
                                el.style.opacity = 0.3;
                            }
                        }
                    }
                });
                console.log('å·²åº”ç”¨å¹½çµæ›å…‰2025å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°é›ªäººæ ‡è®°
        function applySnowmenVisibilityCache() {
            const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('snowmen');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨é›ªäººå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åäº‘åé›¾é¦†äº§å“å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSmokeProductPopup(item, index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/smoke_on_the_water_product/smoke_on_the_water_product_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.smoke-product-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
            const totalCount = 5; // å›ºå®šæ˜¾ç¤º5ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ’¨ åäº‘åé›¾é¦†äº§å“ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'smoke-product-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="åäº‘åé›¾é¦†äº§å“ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼<br>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; border-left: 3px solid #FF9800;">
                        <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                        <div style="color: var(--gta-text); font-size: 13px; line-height: 1.4;">
                            æ”¶é›†æ‰€æœ‰åäº‘åé›¾é¦†äº§å“å¯è·å¾—ï¼š<br>
                            â€¢ ç‰¹æ®Šè½½å…·å¥–åŠ±<br>
                            â€¢ æ¸¸æˆå¸å¥–åŠ±<br>
                            â€¢ è§£é”éšè—æˆå°±
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-smoke-product-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-smoke-product-btn');
            const hideBtn = popup.querySelector('#hide-smoke-product-btn');
            const showBtn = popup.querySelector('#show-smoke-product-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'smoke-product-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('smoke_on_the_water_product', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ’¨ åäº‘åé›¾é¦†äº§å“ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSmokeProductSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ’¨ åäº‘åé›¾é¦†äº§å“ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSmokeProductSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°åäº‘åé›¾é¦†äº§å“æ ‡è®°
        function applySmokeProductVisibilityCache() {
            const markers = (window.smokeProductMarkers && window.smokeProductMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('smoke_on_the_water_product');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨åäº‘åé›¾é¦†äº§å“å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°LSæ¶‚é¸¦æ ‡è®°
        function applyLSTagsVisibilityCache() {
            const markers = (window.lsTagsMarkers && window.lsTagsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ls_tags');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨LSæ¶‚é¸¦å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°çº¸ç‰Œæ ‡è®°
        function applyPlayingCardsVisibilityCache() {
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('playing_cards');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨çº¸ç‰Œå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å–·çŒä½ç½®æ ‡è®°
        function applySprayVisibilityCache() {
            const markers = (window.sprayMarkers && window.sprayMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('spray');
                // å–·çŒä½ç½®ï¼šéšè—ä¸€ä¸ªæ ‡è®°åéšè—å…¨éƒ¨å›¾æ ‡
                const isHidden = visibilityMap[0]; // åªæ£€æŸ¥ç¬¬ä¸€ä¸ªæ ‡è®°çš„çŠ¶æ€
                if (isHidden) {
                    markers.forEach((marker) => {
                        if (marker) {
                            if (typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        }
                    });
                }
                console.log('å·²åº”ç”¨å–·çŒä½ç½®å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°é™†åœ°è¿·å¹»ä»™äººæŒæ ‡è®°
        function applyPplVisibilityCache() {
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppl');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨é™†åœ°è¿·å¹»ä»™äººæŒå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ°´ä¸‹è¿·å¹»ä»™äººæŒæ ‡è®°
        function applyPpwVisibilityCache() {
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppw');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ°´ä¸‹è¿·å¹»ä»™äººæŒå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°èµ°ç§è´©é£æœºæ ‡è®°
        function applySmugglerPlaneVisibilityCache() {
            const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
            if (groups.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('smuggler_plane');
                groups.forEach((groupMarkers, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && groupMarkers && groupMarkers.length > 0) {
                        groupMarkers.forEach((layer) => {
                            if (layer && typeof layer.setOpacity === 'function') {
                                layer.setOpacity(0.3);
                            } else if (layer && typeof layer.setStyle === 'function') {
                                layer.setStyle({ opacity: 0.3 });
                            }
                        });
                    }
                });
                console.log('å·²åº”ç”¨èµ°ç§è´©é£æœºå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ¢å¤ç¼“å­˜åçš„æ˜¾ç¤ºçŠ¶æ€ï¼ˆä¼˜å…ˆè°ƒç”¨æ˜¾ç¤ºé€»è¾‘è€ŒéåŠ è½½åæ ‡ï¼‰
        function restoreCachedDisplayState() {
            try {
                // 1) åº”ç”¨ä¾§è¾¹æ ç¼“å­˜åˆ° activeItemTypes
                const hadState = SidebarCache.applyState(activeItemTypes);

                // 2) åŒæ­¥ä¾§è¾¹æ å¤é€‰æ¡†çš„å‹¾é€‰çŠ¶æ€
                try {
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(chk => {
                        const t = chk && chk.dataset ? chk.dataset.itemType : undefined;
                        if (t) chk.checked = activeItemTypes.has(t);
                    });
                } catch (e) { /* no-op */ }

                // 3) è‹¥æœ‰ç¼“å­˜çŠ¶æ€ï¼Œåˆ™æ¸²æŸ“æ ‡è®°ï¼ˆæ­¤æ—¶ itemData å·²é€šè¿‡æ¯æ—¥é€»è¾‘è¿‡æ»¤ï¼‰
                if (hadState) {
                    updateItemMarkers();
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                }

                // 4) æ¸²æŸ“å®Œæˆåå†åº”ç”¨å¯è§æ€§ç¼“å­˜ï¼ˆéœ€åœ¨æ ‡è®°å­˜åœ¨åï¼‰
                try { applySmugglerPlaneVisibilityCache(); } catch (e) {}
                try { applyStreetDealersVisibilityCache(); } catch (e) {}
                try { applySubmarinePiecesVisibilityCache(); } catch (e) {}
                try { applyNuclearWasteVisibilityCache(); } catch (e) {}
                try { applySlasherVisibilityCache(); } catch (e) {}
                try { applyTreasureHuntVisibilityCache(); } catch (e) {}
                try { applyUfoVisibilityCache(); } catch (e) {}
                try { applyGhosts3VisibilityCache(); } catch (e) {}
                try { applySnowmenVisibilityCache(); } catch (e) {}
                try { applyMediaStickVisibilityCache(); } catch (e) {}
                try { applyMoviePropsVisibilityCache(); } catch (e) {}
                try { applyStuntJumpsVisibilityCache(); } catch (e) {}
                try { applyYuanbaoVisibilityCache(); } catch (e) {}
                try { applySignalJammersVisibilityCache(); } catch (e) {}
                try { applyActionFiguresVisibilityCache(); } catch (e) {}
                try { applyPlayingCardsVisibilityCache(); } catch (e) {}
                try { applyLetterScrapsVisibilityCache(); } catch (e) {}
                try { applySpaceshipPartsVisibilityCache(); } catch (e) {}
                try { applySprayVisibilityCache(); } catch (e) {}
                try { applyPplVisibilityCache(); } catch (e) {}
                try { applyPpwVisibilityCache(); } catch (e) {}
                try { applyHumansOfLsVisibilityCache(); } catch (e) {}
                try { applyMonkeyMosaicsVisibilityCache(); } catch (e) {}
                try { applyOrganicFarmVisibilityCache(); } catch (e) {}
                try { applySkydivesVisibilityCache(); } catch (e) {}
                try { applyRCTimeTrialVisibilityCache(); } catch (e) {}
                try { applyBikeTimeTrialVisibilityCache(); } catch (e) {}
                try { applyMadrazoHitsVisibilityCache(); } catch (e) {}
                try { applyStashHousesVisibilityCache(); } catch (e) {}
                try { applyLSTagsVisibilityCache(); } catch (e) {}
                try { applyShipwreckedVisibilityCache(); } catch (e) {}
                try { applyHiddenCachesVisibilityCache(); } catch (e) {}
                try { applySmokeProductVisibilityCache(); } catch (e) {}
                try { applyDeadDropVisibilityCache(); } catch (e) {}
                try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
                try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
                try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
                try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
                try { applyForSaleSignVisibilityCache(); } catch (e) {}
                try { applyTheBigScoreGauntletVisibilityCache(); } catch (e) {}

                // 5) åˆ·æ–°è®¡æ•°å™¨ï¼ˆå¦‚æœ‰ï¼‰
                try { updateSmugglerPlaneSidebarCount(); } catch (e) {}
                try { updateStreetDealersSidebarCount(); } catch (e) {}
                try { updateSubmarinePiecesSidebarCount(); } catch (e) {}
                try { updateNuclearWasteSidebarCount(); } catch (e) {}
                try { updateAssumingTheTruthSidebarCount(); } catch (e) {}
                try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                try { updateForSaleSignSidebarCount(); } catch (e) {}
                try { updateTheBigScoreGauntletSidebarCount(); } catch (e) {}
                try { updateSlasherSidebarCount(); } catch (e) {}
                try { updateTreasureHuntSidebarCount(); } catch (e) {}
                try { updateUfoSidebarCount(); } catch (e) {}
                try { updateGhosts3SidebarCount(); } catch (e) {}
                try { updateSnowmenSidebarCount(); } catch (e) {}
                try { updateStuntJumpsSidebarCount(); } catch (e) {}
                try { updateYuanbaoSidebarCount(); } catch (e) {}
                try { updateSignalJammersSidebarCount(); } catch (e) {}
                try { updateActionFiguresSidebarCount(); } catch (e) {}
                try { updatePlayingCardsSidebarCount(); } catch (e) {}
                try { updateLetterScrapsSidebarCount(); } catch (e) {}
                try { updateSpaceshipPartsSidebarCount(); } catch (e) {}
                try { updateSpraySidebarCount(); } catch (e) {}
                try { updatePplSidebarCount(); } catch (e) {}
                try { updatePpwSidebarCount(); } catch (e) {}
                try { updateHumansOfLsSidebarCount(); } catch (e) {}
                try { updateMonkeyMosaicsSidebarCount(); } catch (e) {}
                try { updateOrganicFarmSidebarCount(); } catch (e) {}
                try { updateSkydivesSidebarCount(); } catch (e) {}
                try { updateMadrazoHitsSidebarCount(); } catch (e) {}
                try { updateStashHousesSidebarCount(); } catch (e) {}
                try { updateLSTagsSidebarCount(); } catch (e) {}
                try { updateShipwreckedSidebarCount(); } catch (e) {}
                try { updateHiddenCachesSidebarCount(); } catch (e) {}
                try { updateSmokeProductSidebarCount(); } catch (e) {}
                try { updateDeadDropSidebarCount(); } catch (e) {}
                try { updateGunVanSidebarCount(); } catch (e) {}
                try { updateMurderMysteryMessageSidebarCount(); } catch (e) {}

                console.log('å·²æŒ‰ç¼“å­˜æ¢å¤æ˜¾ç¤ºçŠ¶æ€');
            } catch (e) {
                console.warn('æ¢å¤ç¼“å­˜æ˜¾ç¤ºçŠ¶æ€å¤±è´¥:', e);
            }
        }

        // å¯åŠ¨/ç»“æŸæ¢å¤é˜¶æ®µæ—¶éšè—/æ˜¾ç¤º Leaflet å›¾å±‚é¢æ¿ï¼Œé¿å…çŸ­æš‚çš„â€œå…¨é‡åæ ‡â€é—ªçƒ
        function hideLeafletPanesForRestore() {
            try {
                const panes = map && typeof map.getPanes === 'function' ? map.getPanes() : null;
                if (!panes) return;
                if (panes.markerPane) panes.markerPane.style.visibility = 'hidden';
                if (panes.overlayPane) panes.overlayPane.style.visibility = 'hidden';
                if (panes.shadowPane) panes.shadowPane.style.visibility = 'hidden';
                if (panes.tooltipPane) panes.tooltipPane.style.visibility = 'hidden';
                if (panes.popupPane) panes.popupPane.style.visibility = 'hidden';
            } catch (e) { /* no-op */ }
        }
        function showLeafletPanesForRestore() {
            try {
                const panes = map && typeof map.getPanes === 'function' ? map.getPanes() : null;
                if (!panes) return;
                if (panes.markerPane) panes.markerPane.style.visibility = 'visible';
                if (panes.overlayPane) panes.overlayPane.style.visibility = 'visible';
                if (panes.shadowPane) panes.shadowPane.style.visibility = 'visible';
                if (panes.tooltipPane) panes.tooltipPane.style.visibility = 'visible';
                if (panes.popupPane) panes.popupPane.style.visibility = 'visible';
            } catch (e) { /* no-op */ }
        }

        // ==================== æ°æ‹‰å¾·åŒ…è£¹å¢å¼ºç‰ˆå¼¹çª—ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º dead_drop å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachDeadDropCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.dead-drop-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'dead-drop-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateDeadDropSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆæ°æ‹‰å¾·åŒ…è£¹ç‰¹æ®Šï¼š0/1ï¼‰
        function updateDeadDropSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-dead_drop + label .dead-drop-counter');
                if (!counterEl) return;

                // æ°æ‹‰å¾·åŒ…è£¹ç‰¹æ®Šï¼šåªæœ‰ä¸€ä¸ªæ ‡è®°ï¼Œæ‰€ä»¥æ€»æ•°å›ºå®šä¸º1
                const total = 1;
                let hidden = 0;

                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„éšè—çŠ¶æ€
                const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
                if (visibilityMap[0] === true) {
                    hidden = 1;
                }

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('dead_drop', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ°æ‹‰å¾·åŒ…è£¹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }


        // æ°æ‹‰å¾·åŒ…è£¹å¢å¼ºç‰ˆå¼¹çª—ï¼ˆé›†æˆç¼“å­˜ï¼Œç‰¹æ®Šå¤„ç†ï¼šéšè—å…¨éƒ¨æ ‡è®°ï¼‰
        function showDeadDropPopup(item, index) {
            const content = `æ°æ‹‰å¾·æä¾›çš„ç§˜å¯†åŒ…è£¹æŠ•é€’ç‚¹ï¼Œå®Œæˆå¯è·å¾—ä¸°åšå¥–åŠ±ã€‚`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/dead_drop/dead_drop_${index + 1}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.dead-drop-popup');
            if (existingPopup) existingPopup.remove();

            // æ°æ‹‰å¾·åŒ…è£¹ç‰¹æ®Šï¼šåªæœ‰ä¸€ä¸ªæ ‡è®°ï¼Œæ‰€ä»¥æ€»æ•°å›ºå®šä¸º1
            const totalCount = 1;
            let hiddenCount = 0;

            // æ£€æŸ¥å½“å‰éšè—çŠ¶æ€
            const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
            const isCurrentHidden = visibilityMap[0] === true;
            if (isCurrentHidden) {
                hiddenCount = 1;
            }

            const title = `ğŸ“¦ æ°æ‹‰å¾·åŒ…è£¹ #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'dead-drop-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: #9C6EAF; font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ°æ‹‰å¾·åŒ…è£¹å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 110, 175, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-dead-drop-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-dead-drop-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-dead-drop-btn" style="padding: 8px 16px; background: #9C6EAF; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-dead-drop-btn');
            const hideBtn = popup.querySelector('#hide-dead-drop-btn');
            const showBtn = popup.querySelector('#show-dead-drop-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'dead-drop-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºæ°æ‹‰å¾·åŒ…è£¹æ ‡è®°ï¼ˆç‰¹æ®Šï¼šéšè—å…¨éƒ¨æ ‡è®°ï¼‰
            function setDeadDropVisibility(opacity) {
                // éšè—æ‰€æœ‰æ°æ‹‰å¾·åŒ…è£¹ç›¸å…³çš„æ ‡è®°
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('dead_drop')) {
                        marker.style.opacity = String(opacity);
                    }
                });

            // åŒæ—¶å¤„ç†é€šç”¨çš„ Leaflet æ ‡è®°ï¼ˆé€šè¿‡å›¾æ ‡URLè¯†åˆ« dead_dropï¼‰
            if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                leafletMarkers.forEach((layer) => {
                    try {
                        const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                        if (iconUrl && iconUrl.includes('dead_drop')) {
                            if (typeof layer.setOpacity === 'function') {
                                layer.setOpacity(opacity);
                            } else if (typeof layer.setStyle === 'function') {
                                layer.setStyle({ opacity });
                            } else if (layer.getElement && layer.getElement()) {
                                layer.getElement().style.opacity = String(opacity);
                            }
                        }
                    } catch (e) { /* no-op */ }
                });
            }

                // åŒæ—¶å¤„ç†Leafletæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.smugglerGroupMarkers && window.smugglerGroupMarkers['dead_drop']) {
                    window.smugglerGroupMarkers['dead_drop'].forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('dead_drop', 0, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setDeadDropVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `ğŸ“¦ æ°æ‹‰å¾·åŒ…è£¹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateDeadDropSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setDeadDropVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `ğŸ“¦ æ°æ‹‰å¾·åŒ…è£¹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateDeadDropSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // è—åŒ¿å±‹å¢å¼ºç‰ˆå¼¹çª—ï¼ˆé›†æˆç¼“å­˜ï¼Œç‰¹æ®Šå¤„ç†ï¼šéšè—å…¨éƒ¨æ ‡è®°ï¼‰
        function showStashHousesPopup(item, index) {
            const content = `è—åŒ¿å±‹éšæœºç”Ÿæˆåœ¨ 25 ä¸ªå¯èƒ½ä½ç½®ä¹‹ä¸€ï¼Œå…¶ä½ç½®ä¼šç›´æ¥æ ‡è®°åœ¨æ¸¸æˆå†…åœ°å›¾ä¸Šã€‚

è¢­å‡»è—åŒ¿å±‹å³å¯è·å¾— 1.000 RP ä¸ 30.000 GTA$ å¥–åŠ±ï¼Œæˆ–ä¸ºæ‚¨æ­£åœ¨è¿è¥çš„äº§ä¸šä¹‹ä¸€è¡¥å……åŸææ–™ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/stash_house/stash_house.webp';

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.stash-houses-popup');
            if (existingPopup) existingPopup.remove();

            // è—åŒ¿å±‹ç‰¹æ®Šï¼šåªæœ‰ä¸€ä¸ªæ ‡è®°ï¼Œæ‰€ä»¥æ€»æ•°å›ºå®šä¸º1
            const totalCount = 1;
            let hiddenCount = 0;

            // æ£€æŸ¥å½“å‰éšè—çŠ¶æ€
            const visibilityMap = VisibilityCache.loadVisibility('stash_houses');
            const isCurrentHidden = visibilityMap[0] === true;
            if (isCurrentHidden) {
                hiddenCount = 1;
            }

            const title = `ğŸ  è—åŒ¿å±‹ #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'stash-houses-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è—åŒ¿å±‹å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-stash-houses-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-stash-houses-btn');
            const hideBtn = popup.querySelector('#hide-stash-houses-btn');
            const showBtn = popup.querySelector('#show-stash-houses-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'stash-houses-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºè—åŒ¿å±‹æ ‡è®°ï¼ˆç‰¹æ®Šï¼šéšè—å…¨éƒ¨æ ‡è®°ï¼‰
            function setStashHousesVisibility(opacity) {
                // éšè—æ‰€æœ‰è—åŒ¿å±‹ç›¸å…³çš„æ ‡è®°
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('stash')) {
                        marker.style.opacity = String(opacity);
                    }
                });

                // åŒæ—¶å¤„ç†é€šç”¨çš„ Leaflet æ ‡è®°ï¼ˆé€šè¿‡å›¾æ ‡URLè¯†åˆ« stash_housesï¼‰
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('stash')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(opacity);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity });
                                } else if (layer.getElement && layer.getElement()) {
                                    layer.getElement().style.opacity = String(opacity);
                                }
                            }
                        } catch (e) { /* no-op */ }
                    });
                }

                // åŒæ—¶å¤„ç†Leafletæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.stashHousesMarkers && Array.isArray(window.stashHousesMarkers)) {
                    window.stashHousesMarkers.forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(opacity);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity });
                        }
                    });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('stash_houses', 0, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setStashHousesVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `ğŸ  è—åŒ¿å±‹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStashHousesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setStashHousesVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `ğŸ  è—åŒ¿å±‹ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStashHousesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ°æ‹‰å¾·åŒ…è£¹æ ‡è®°
        function applyDeadDropVisibilityCache() {
            const visibilityMap = VisibilityCache.loadVisibility('dead_drop');
            const isHidden = visibilityMap[0] === true;
            
            if (isHidden) {
                // éšè—æ‰€æœ‰æ°æ‹‰å¾·åŒ…è£¹ç›¸å…³çš„æ ‡è®°
                document.querySelectorAll('.item-marker').forEach(marker => {
                    const img = marker.querySelector('img');
                    if (img && img.src && img.src.includes('dead_drop')) {
                        marker.style.opacity = '0.3';
                    }
                });

                // åŒæ—¶å¤„ç†é€šç”¨çš„ Leaflet æ ‡è®°ï¼ˆé€šè¿‡å›¾æ ‡URLè¯†åˆ« dead_dropï¼‰
                if (Array.isArray(leafletMarkers) && leafletMarkers.length > 0) {
                    leafletMarkers.forEach((layer) => {
                        try {
                            const iconUrl = layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.iconUrl;
                            if (iconUrl && iconUrl.includes('dead_drop')) {
                                if (typeof layer.setOpacity === 'function') {
                                    layer.setOpacity(0.3);
                                } else if (typeof layer.setStyle === 'function') {
                                    layer.setStyle({ opacity: 0.3 });
                                } else if (layer.getElement && layer.getElement()) {
                                    layer.getElement().style.opacity = '0.3';
                                }
                            }
                        } catch (e) { /* no-op */ }
                    });
                }

                // åŒæ—¶å¤„ç†Leafletæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.smugglerGroupMarkers && window.smugglerGroupMarkers['dead_drop']) {
                    window.smugglerGroupMarkers['dead_drop'].forEach((layer) => {
                        if (layer && typeof layer.setOpacity === 'function') {
                            layer.setOpacity(0.3);
                        } else if (layer && typeof layer.setStyle === 'function') {
                            layer.setStyle({ opacity: 0.3 });
                        }
                    });
                }
                
                console.log('å·²åº”ç”¨æ°æ‹‰å¾·åŒ…è£¹å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== ç¼“å­˜ç®¡ç†å·¥å…· ====================
        
        // åˆ›å»ºç¼“å­˜ç®¡ç†é¢æ¿
        function createCacheManagementPanel() {
            const panel = document.createElement('div');
            panel.id = 'cache-management-panel';
            panel.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                z-index: 10001; background: var(--gta-bg-medium); border: 1px solid var(--gta-border);
                border-radius: 8px; padding: 15px; min-width: 300px; max-width: 90vw;
                color: var(--gta-text); font-family: 'Segoe UI', sans-serif;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 80vh;
                overflow-y: auto; display: none;
            `;

            const cacheInfo = CacheManager.getCacheInfo();
            let infoHtml = '<h3 style="margin: 0 0 15px 0; color: var(--gta-primary);">ç¼“å­˜ç®¡ç†</h3>';
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            infoHtml += `<div style="margin: 8px 0; padding: 8px; background: rgba(0, 150, 136, 0.1); border-radius: 4px;">
                <strong>å½“å‰çŠ¶æ€:</strong><br>
                ä¾§è¾¹æ é€‰æ‹©: ${Array.from(activeItemTypes).join(', ') || 'æ— '}<br>
                ç¼“å­˜é”®æ•°é‡: ${Object.keys(cacheInfo).length}
            </div>`;
            
            Object.entries(cacheInfo).forEach(([name, info]) => {
                if (info) {
                    const sizeKB = (info.size / 1024).toFixed(2);
                    const date = new Date(info.timestamp).toLocaleString();
                    infoHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(25, 118, 210, 0.1); border-radius: 4px;">
                            <strong>${name}:</strong><br>
                            å¤§å°: ${sizeKB} KB<br>
                            æ—¶é—´: ${date}<br>
                            ç‰ˆæœ¬: ${info.version || 'N/A'}
                        </div>
                    `;
                } else {
                    infoHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">
                            <strong>${name}:</strong> æ— ç¼“å­˜æ•°æ®
                        </div>
                    `;
                }
            });

            infoHtml += `
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="save-cache-btn" style="padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜å½“å‰çŠ¶æ€</button>
                    <button id="clear-cache-btn" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">æ¸…ç©ºç¼“å­˜</button>
                    <button id="refresh-cache-btn" style="padding: 8px 12px; background: var(--gta-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ·æ–°ä¿¡æ¯</button>
                    <button id="close-cache-panel" style="padding: 8px 12px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 4px; cursor: pointer;">å…³é—­</button>
                </div>
            `;

            panel.innerHTML = infoHtml;
            document.body.appendChild(panel);

            // ç»‘å®šäº‹ä»¶
            panel.querySelector('#save-cache-btn').addEventListener('click', () => {
                try {
                    SidebarCache.saveState(activeItemTypes);
                    alert('å½“å‰çŠ¶æ€å·²ä¿å­˜åˆ°ç¼“å­˜');
                    panel.remove();
                    createCacheManagementPanel().style.display = 'block';
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            });

            panel.querySelector('#clear-cache-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰ç”¨æˆ·è®¾ç½®å’Œè¿›åº¦ã€‚')) {
                    CacheManager.clearAll();
                    alert('ç¼“å­˜å·²æ¸…ç©º');
                    panel.remove();
                }
            });

            panel.querySelector('#refresh-cache-btn').addEventListener('click', () => {
                panel.remove();
                createCacheManagementPanel();
            });

            panel.querySelector('#close-cache-panel').addEventListener('click', () => {
                panel.remove();
            });

            return panel;
        }

        // æ·»åŠ ç¼“å­˜ç®¡ç†æŒ‰é’®åˆ°é¡µé¢ï¼ˆæ”¾åœ¨ä¾§è¾¹æ æœ€åº•ä¸‹ï¼‰
        function addCacheManagementButton() {
            // æŸ¥æ‰¾ä¾§è¾¹æ å†…å®¹å®¹å™¨
            const sidePanelContent = document.querySelector('.side-panel-content');
            if (!sidePanelContent) {
                console.warn('æœªæ‰¾åˆ°ä¾§è¾¹æ å†…å®¹å®¹å™¨ï¼Œå°†æŒ‰é’®æ”¾åœ¨é¡µé¢åº•éƒ¨');
                // å¦‚æœæ‰¾ä¸åˆ°ä¾§è¾¹æ å®¹å™¨ï¼Œæ”¾åœ¨é¡µé¢åº•éƒ¨
                const button = document.createElement('button');
                button.id = 'cache-management-btn';
                button.innerHTML = 'ğŸ—„ï¸ ç¼“å­˜';
                button.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px; z-index: 10000;
                    padding: 8px 12px; background: var(--gta-bg-medium);
                    color: var(--gta-text); border: 1px solid var(--gta-border);
                    border-radius: 6px; cursor: pointer; font-size: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;
                `;
                addButtonEvents(button);
                document.body.appendChild(button);
                return;
            }

            // åœ¨ä¾§è¾¹æ å†…å®¹å®¹å™¨å†…åˆ›å»ºæŒ‰é’®
            const button = document.createElement('button');
            button.id = 'cache-management-btn';
            button.innerHTML = 'ğŸ—„ï¸ ç¼“å­˜';
            button.style.cssText = `
                width: 100%; margin-top: 8px; padding: 8px 12px; 
                background: var(--gta-bg-medium); color: var(--gta-text); 
                border: 1px solid var(--gta-border); border-radius: 6px; 
                cursor: pointer; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            `;

            addButtonEvents(button);
            sidePanelContent.appendChild(button);
        }

        // æ·»åŠ æŒ‰é’®äº‹ä»¶å¤„ç†
        function addButtonEvents(button) {
            button.addEventListener('mouseenter', () => {
                button.style.background = 'var(--gta-primary)';
                button.style.color = 'white';
            });

            button.addEventListener('mouseleave', () => {
                button.style.background = 'var(--gta-bg-medium)';
                button.style.color = 'var(--gta-text)';
            });

            button.addEventListener('click', () => {
                const existingPanel = document.getElementById('cache-management-panel');
                if (existingPanel) {
                    existingPanel.remove();
                } else {
                    createCacheManagementPanel().style.display = 'block';
                }
            });
        }

        // DOMå…ƒç´ 
        const styleSelect = document.getElementById('map-style-select');
        // å³ä¸Šè§’çš„ item-type-select å·²ç§»é™¤ï¼Œä¾§è¾¹æ ä½¿ç”¨é™æ€é€‰é¡¹æ•°ç»„ç”Ÿæˆå¤é€‰æ¡†
        const sidebarItemOptions = [
            { value: 'dealerships', text: 'ğŸ¦ è½¦è¡Œä½ç½®' },
            { value: 'hidden_caches', text: 'éšè—åŒ…è£¹' },
            { value: 'shipwrecked', text: 'æ²‰èˆ¹' },
            { value: 'gun_van', text: 'æ­¦å™¨å¢å‹è½¦' },
            { value: 'dead_drop', text: 'æ°æ‹‰å¾·åŒ…è£¹' },
            { value: 'ls_tags', text: 'LSæ¶‚é¸¦' },
            { value: 'street_dealers', text: 'è¡—å¤´æ¯’è´©' },
            { value: 'playing_cards', text: 'çº¸ç‰Œ' },
            { value: 'smoke_on_the_water_product', text: 'åäº‘åé›¾é¦†äº§å“ï¼ˆæµ‹è¯•ï¼‰' },
            { value: 'action_figures', text: 'æ‰‹åŠ' },
            { value: 'yuanbao', text: 'å…ƒå®' },
            { value: 'letter_scraps', text: 'æ®‹ç¼ºä¿¡ä»¶' },
            { value: 'sp_hidden_packages', text: 'éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰' },
            { value: 'peyote_sp_land', text: 'è¿·å¹»ä»™äººæŒé™†åœ°' },
            { value: 'peyote_sp_air', text: 'è¿·å¹»ä»™äººæŒé¸Ÿç±»' },
            { value: 'peyote_sp_water', text: 'è¿·å¹»ä»™äººæŒæ°´ä¸‹' },
            { value: 'peyote_sp_special', text: 'è¿·å¹»ä»™äººæŒé‡‘è‰²' },
            { value: 'submarine_pieces', text: 'æ½œæ°´è‰‡ç¢ç‰‡' },
            { value: 'spaceship_parts', text: 'å®‡å®™é£èˆ¹éƒ¨ä»¶' },
            { value: 'nuclear_waste', text: 'æ ¸åºŸæ–™' },
            { value: 'humans_of_ls', text: 'æ´›åœ£éƒ½çš„äººç±»', icon: '../src/assets/humans_of_ls.svg' },
            { value: 'monkey_mosaics', text: 'çŒ´å­é©¬èµ›å…‹', icon: '../src/assets/monkey_mosaics.svg' },
            { value: 'murder_mystery_message', text: 'è°‹æ€ä¹‹è°œ', icon: '../src/assets/murder_mystery_message.svg' },
            { value: 'assuming_the_truth', text: 'åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·', icon: '../src/assets/assuming_the_truth_car.svg' },
            { value: 'epsilon_tracts', text: 'åŸƒæ™®è¥¿éš†ä¼ å•', icon: '../src/assets/epsilon_tracts.svg' },
            { value: 'for_sale_sign', text: 'å¾…å”®æ ‡å¿—', icon: '../src/assets/for_sale_sign.svg' },
            { value: 'the_big_score_gauntlet', text: 'å¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰- é“è…•', icon: '../src/assets/the_big_score_gauntlet.svg' },
            { value: 'hitchhikers', text: 'æ­ä¾¿è½¦(æ½œåœ¨åˆ©ä»–æ•™å—å®³è€…)', icon: '../src/assets/hitchhikers.svg' },
            { value: 'chasing_the_truth', text: 'åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨', icon: '../src/assets/chasing_the_truth.svg' },
            { value: 'stunt_jumps', text: 'ç‰¹æŠ€è·³è·ƒç‚¹' },
            { value: 'spray', text: 'å–·ç½ä½ç½®' },
            { value: 'ld_organics_products', text: 'æœ‰æœºåŠäº§å“' },
            { value: 'signal_jammers', text: 'ä¿¡å·å¹²æ‰°å™¨' },
            { value: 'jack_o_lanterns', text: 'å—ç“œç¯' },
            { value: 'payphone_hits', text: 'ç”µè¯æš—æ€' },
            { value: 'golf_holes', text: 'é«˜å°”å¤«çƒæ´' },
            { value: 'snowmen', text: 'é›ªäºº' },
            { value: 'rc_time_trial', text: 'RCæ—¶é—´æŒ‘æˆ˜èµ›' },
            { value: 'bike_time_trial', text: 'è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›' },
            { value: 'skydives', text: 'è·³ä¼' },
            { value: 'gang_attacks', text: 'ğŸ† å¸®æ´¾æ”»å‡»' },
            { value: 'ghosts3', text: 'å¹½çµæ›å…‰2025' },
            { value: 'treasure_hunt_dba_revolver', text: 'å·¦è½®å¯»å®' },
            { value: 'movie_props', text: 'ç”µå½±é“å…·' },
            { value: 'serial_killer_slasher', text: 'æ´›åœ£éƒ½æ€äººç‹‚' },
            { value: 'maude_bounty_targets', text: 'èŒ‰å¾·æ‚¬èµç›®æ ‡' },
            { value: 'media_sticks', text: 'åª’ä½“è®°å¿†æ£’' },
            { value: 'stash_houses', text: 'è—åŒ¿å±‹' },
            { value: 'madrazo_hits', text: 'ç›å¾·æ‹‰ç´¢é›‡å‡¶' },
            { value: 'police_rescue_patrick_mcreary', text: 'å¸•ç‰¹é‡Œå…‹æ•‘æ´', icon: '../src/assets/patrick.svg' },
            { value: 'random_missions', text: 'éšæœºä»»åŠ¡', icon: '../src/assets/random.svg' },
            { value: 'drug_vehicle', text: 'æ¯’å“è½½å…·', icon: '../src/assets/drug_vehicle.svg' },
            { value: 'drunk_guard', text: 'æ²‰ç¡çš„ä¿å®‰', icon: '../src/assets/drunk_guard.svg' },
            { value: 'metal_detector', text: 'é‡‘å±æ¢æµ‹å™¨', icon: '../src/assets/metal.svg' },
            { value: 'smuggler_plane', text: 'èµ°ç§è´©é£æœº', icon: '../src/assets/smuggler_plane.svg' },
            { value: 'smuggler_trail', text: 'èµ°ç§è´©è¸ªè¿¹', icon: '../src/assets/smuggler_trail.svg' },
            { value: 'crime_scenes', text: 'çŠ¯ç½ªç°åœº', icon: '../src/assets/crime_scenes.svg' },
            { value: 'ufo', text: 'UFOè§‚å…‰', icon: '../src/assets/ufo.svg' },
            { value: 'halloween_slashers', text: 'ä¸‡åœ£èŠ‚æ€äººç‹‚', icon: '../src/assets/slasher.svg' },
            { value: 'possessed_animals', text: 'é¬¼ä¸Šèº«çš„åŠ¨ç‰©', icon: '../src/assets/cerberus.svg' },
            { value: 'cerberus', text: 'ä¸‡åœ£èŠ‚åœ°ç‹±çŠ¬äº‹ä»¶', icon: '../src/assets/cerberus.svg' },
            { value: 'yeti', text: 'é›ªæ€ª', icon: '../src/assets/what.svg' },
            { value: 'happy_holidays_hauler', text: 'èŠ‚æ—¥å¿«ä¹å¡è½¦', icon: '../src/assets/happy.svg' },
            { value: 'wea', text: 'å¨æ³½å°”å¤§æ¥¼æªæˆ˜', icon: '../src/assets/wea.svg' },
            { value: 'ppl', text: 'é™†åœ°è¿·å¹»ä»™äººæŒ', icon: '../src/assets/ppl.svg' },
            { value: 'ppw', text: 'æ°´ä¸‹è¿·å¹»ä»™äººæŒ', icon: '../src/assets/ppw.svg' },
            { value: 'metro', text: 'åœ°é“ç«™', icon: '../src/assets/metro.svg' },
            { value: 'police', text: 'è­¦å¯Ÿå±€', icon: '../src/assets/police.svg' },
            { value: 'v_telescopes', text: 'æœ›è¿œé•œ', icon: '../src/assets/telescopes.svg' },
            { value: 'fire_stations', text: 'æ¶ˆé˜²å±€', icon: '../src/assets/fire.svg' },
            { value: 'hospitals', text: 'åŒ»é™¢', icon: '../src/assets/hospitals.svg' },
            { value: 'clothing', text: 'æœè£…åº—', icon: '../src/assets/clothing.svg' },
            { value: 'tattoos', text: 'çº¹èº«åº—', icon: '../src/assets/tattoos.svg' },
            { value: 'barbers', text: 'ç†å‘åº—', icon: '../src/assets/barbers.svg' },
            { value: 'ammunation', text: 'æ­¦è£…å›½åº¦', icon: '../src/assets/ammunation.svg' },
            { value: 'mod_shop', text: 'æ´›åœ£éƒ½æ”¹è½¦ç‹', icon: '../src/assets/mod_shop.svg' },
            { value: 'car_wash', text: 'æ´—è½¦åº—', icon: '../src/assets/car_wash.svg' },
            { value: 'shops_to_rob', text: 'å¯æŠ¢åŠ«çš„å•†åº—', icon: '../src/assets/shops_to_rob.svg' },
            { value: 'gas_stations', text: 'åŠ æ²¹ç«™', icon: '../src/assets/gas_stations.svg' },
            { value: 'atms', text: 'ATMæœº', icon: '../src/assets/atms.svg' },
            { value: 'vend_sprunk', text: 'éœœç¢§å”®å–æœº', icon: '../src/assets/vend_sprunk.svg' },
            { value: 'vend_ecola', text: 'æ˜“å¯ä¹å”®å–æœº', icon: '../src/assets/vend_ecola.svg' },
            { value: 'community_outreach', text: 'ç¤¾åŒºè¾¹ç•Œ', icon: '../src/assets/community_outreach.svg' },
            { value: 'store_robbery', text: 'å•†åº—æŠ¢åŠ«', icon: '../src/assets/store_robbery.svg' },
            { value: 'convoy', text: 'è½¦é˜Ÿ', icon: '../src/assets/convoy.svg' },
            { value: 'armored_truck', text: 'è£…ç”²è¿é’è½¦', icon: '../src/assets/armored_truck.svg' },
            { value: 'exotic_exports1', text: 'å¤–è´¸å‡ºå£è½½å…·1', icon: '../src/assets/exotic_exports1.svg' },
            { value: 'exotic_exports2', text: 'å¤–è´¸å‡ºå£è½½å…·2', icon: '../src/assets/exotic_exports2.svg' }
        ];
        const loader = document.getElementById('loader');
        const fileStatus = document.getElementById('file-status');
        const itemInfo = document.getElementById('item-info');

        let currentStyle = styleSelect.value;
    let currentItemType = '';
    // æ”¯æŒåŒæ—¶æ˜¾ç¤ºå¤šä¸ªç‰©å“ç±»å‹
    let activeItemTypes = new Set();
    // å­˜å‚¨æ¯ä¸ªæ ‡è®°å¯¹è±¡ï¼š{type, index, el}
    let itemMarkers = [];

        // --- åœ°å›¾åˆå§‹åŒ– ---
        function getLevelByZoom(z) {
            return zoomLevels.find(l => l.zoom === z);
        }
        // å½“ç¼©æ”¾ä¸ºå°æ•°ï¼ˆç¼©æ”¾åŠ¨ç”»è¿‡ç¨‹ä¸­ï¼‰æ—¶ï¼Œé€‰æ‹©æœ€è¿‘çš„ç¼©æ”¾çº§åˆ«ç”¨äºåƒç´ å°ºå¯¸/åˆ—è¡Œæ•°è®¡ç®—
        function getNearestLevelByZoom(z) {
            if (!Array.isArray(zoomLevels) || zoomLevels.length === 0) return null;
            return zoomLevels.reduce((best, cur) => Math.abs(cur.zoom - z) < Math.abs(best.zoom - z) ? cur : best, zoomLevels[0]);
        }
        function getLevelOrNearest(z) {
            return getLevelByZoom(z) || getNearestLevelByZoom(z);
        }
        function totalSizeForZoom(z) {
            const level = getLevelByZoom(z);
            if (!level) return { width: 0, height: 0 };
            return { width: level.cols * TILE_SIZE, height: level.rows * TILE_SIZE };
        }

        const errorTileSVG = encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="${TILE_SIZE}" height="${TILE_SIZE}">` +
            `<rect width="100%" height="100%" fill="#1a1a1a"/></svg>`
        );
        const errorTileDataUrl = `data:image/svg+xml;charset=UTF-8,${errorTileSVG}`;

        const initialZoom = zoomLevels[0].zoom;
        const initialSize = totalSizeForZoom(initialZoom);
        const initialCenterPoint = L.point(initialSize.width / 2, initialSize.height / 2);

        const map = L.map('map-container', {
            crs: L.CRS.Simple,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true
        });

        function resetViewForZoom(z, centerPixel) {
            const size = totalSizeForZoom(z);
            if (size.width === 0) return;

            // ä½¿ç”¨ä¼ å…¥çš„ä¸­å¿ƒç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åœ°å›¾ä¸­å¿ƒ
            let centerPoint = centerPixel ? L.point(centerPixel.x, centerPixel.y) : L.point(size.width / 2, size.height / 2);
            
            const centerLatLng = map.unproject(centerPoint, z);

            const southWest = map.unproject(L.point(0, size.height), z);
            const northEast = map.unproject(L.point(size.width, 0), z);
            const bounds = new L.LatLngBounds(southWest, northEast);

            map.setMaxBounds(bounds);
            
            // è®¾ç½®è§†å›¾åˆ°æŒ‡å®šä½ç½®ï¼Œä¸å†å¼ºåˆ¶å±…ä¸­
                map.setView(centerLatLng, z, { animate: false });

            // DOM æ ‡è®°å±‚å·²ç§»é™¤
        }

        resetViewForZoom(initialZoom);

        // æ ¹æ®å½“å‰æ ·å¼è·å–é”™è¯¯ç“¦ç‰‡çš„çº¯è‰²èƒŒæ™¯
        function getErrorTileUrl(style) {
            // æå–æ ·å¼åç§°ï¼ˆä»URLä¸­è·å–æœ€åä¸€éƒ¨åˆ†ï¼‰
            let styleName = 'game'; // é»˜è®¤æ ·å¼
            if (style.includes('game')) {
                styleName = 'game';
            } else if (style.includes('render')) {
                styleName = 'render';
            } else if (style.includes('print')) {
                styleName = 'print';
            }
            
            // ä¸åŒåœ°å›¾æ ·å¼å¯¹åº”çš„RGBé¢œè‰²å€¼
            const colors = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            // è·å–å½“å‰æ ·å¼å¯¹åº”çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
            const color = colors[styleName] || '#1a1a1a';
            
            // è¿”å›çº¯è‰²èƒŒæ™¯çš„SVGæ•°æ®URL
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">' +
                '<rect width="100%" height="100%" fill="' + color + '"/>' +
                '</svg>'
            );
        }

        const CustomTileLayer = L.TileLayer.extend({
            getTileUrl: function(coords) {
                return `${currentStyle}/${coords.z}/${coords.x}_${coords.y}.jpg`;
            }
        });

        const tileLayer = new CustomTileLayer('', {
            tileSize: TILE_SIZE,
            minZoom: zoomLevels[0].zoom,
            maxZoom: zoomLevels[zoomLevels.length - 1].zoom,
            noWrap: true,
            subdomains: [],
            errorTileUrl: getErrorTileUrl(currentStyle)
        });

        tileLayer.on('loading', () => loader.classList.add('visible'));
        tileLayer.on('load', () => loader.classList.remove('visible'));
        tileLayer.on('tileerror', (err) => {
            loader.classList.remove('visible');
        });

        tileLayer.addTo(map);

        // æ ·å¼é€‰æ‹©äº‹ä»¶
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            // æ›´æ–°é”™è¯¯ç“¦ç‰‡URLä»¥åŒ¹é…æ–°æ ·å¼
            tileLayer.options.errorTileUrl = getErrorTileUrl(currentStyle);
            tileLayer.redraw();
        });

        // --- ç‰©å“æ ‡è®°åŠŸèƒ½ ---
        function updateTilePanePosition() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;

            const bounds = map.getBounds();
            const topLeftLatLng = bounds.getNorthWest();
            const topLeftPoint = map.project(topLeftLatLng, z);
            
            const size = { width: level.cols * TILE_SIZE, height: level.rows * TILE_SIZE };
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            
            // è®¡ç®—åŸºç¡€åç§»é‡
            let translateX = -topLeftPoint.x;
            let translateY = -topLeftPoint.y;
            // ç§»é™¤é¢å¤–çš„å±…ä¸­åç§»ï¼Œé¿å…åœ¨åœ°å›¾å°ºå¯¸å°äºå®¹å™¨æ—¶é‡å¤å±…ä¸­å¯¼è‡´åå·®

            // DOM æ ‡è®°å±‚å·²ç§»é™¤ï¼Œæ— éœ€åŒæ­¥ transform
            updateOriginMarker();
            updateLeafletMarkersRadius(); // æ›´æ–°Leafletæ ‡è®°åŠå¾„ä»¥å“åº”ç¼©æ”¾
            updateDealershipMarkers(); // æ›´æ–°è½¦è¡Œæ ‡è®°ä½ç½®
        }

        function updateOriginMarker() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            const percentX = (0 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
            const percentY = (GAME_TOP - 0) / (GAME_TOP - GAME_BOTTOM);

            const originX = percentX * totalWidth;
            const originY = percentY * totalHeight;
            // Origin marker display removed by design. If needed later,
            // position can be computed here without creating DOM elements.
        }

        // åŠ è½½ç‰©å“æ•°æ®
        async function loadItemData() {
            try {
                const response = await fetch('../src/data/zones.json');
                const data = await response.json();
                
                // å°†æ•°æ®å¤åˆ¶åˆ°itemDataå¯¹è±¡
                Object.keys(itemData).forEach(key => {
                    if (data[key]) {
                        if (key === 'ghosts3') {
                            try {
                                // ghosts3 ä¸ºåµŒå¥—æ•°ç»„ç»“æ„ï¼š [ [ [x,y,[label],[time,day,idx]], ... ], [ ... ] ...]
                                // å°†å…¶æ‹å¹³æˆç»Ÿä¸€ç»“æ„ï¼š{x, y, time}
                                itemData[key] = [];
                                data[key].forEach(group => {
                                    if (Array.isArray(group)) {
                                        group.forEach(item => {
                                            if (Array.isArray(item) && item.length >= 4) {
                                                const x = item[0];
                                                const y = item[1];
                                                const timeInfo = item[3];
                                                const time = Array.isArray(timeInfo) && timeInfo.length > 0 ? String(timeInfo[0]) : '';
                                                itemData[key].push({ x, y, time });
                                            }
                                        });
                                    }
                                });
                            } catch (err) {
                                console.error('è§£æghosts3æ•°æ®å¤±è´¥:', err);
                                itemData[key] = [];
                            }
                        } else if (['metro', 'police', 'fire_stations', 'hospitals'].includes(key)) {
                            // æ–°ç‰©å“ç±»å‹ï¼šåœ°é“ç«™ã€è­¦å¯Ÿå±€ã€æ¶ˆé˜²å±€ã€åŒ»é™¢
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 2) {
                                            const x = item[0];
                                            const y = item[1];
                                            const labels = item[2] || [];
                                            const label = Array.isArray(labels) && labels.length > 0 ? labels[0] : '';
                                            itemData[key].push({ 
                                                x, 
                                                y, 
                                                name: `${key === 'metro' ? 'åœ°é“ç«™' : key === 'police' ? 'è­¦å¯Ÿå±€' : key === 'fire_stations' ? 'æ¶ˆé˜²å±€' : 'åŒ»é™¢'} ${index + 1}`,
                                                label: label
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData[key].length} ä¸ªä½ç½®`);
                            } catch (err) {
                                console.error(`åŠ è½½${key}æ•°æ®å¤±è´¥:`, err);
                                itemData[key] = [];
                            }
                        } else if (key === 'v_telescopes') {
                            // æœ›è¿œé•œç‰¹æ®Šå¤„ç†ï¼šåµŒå¥—æ•°ç»„ç»“æ„
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((group, groupIndex) => {
                                        if (Array.isArray(group)) {
                                            group.forEach((item, itemIndex) => {
                                                if (Array.isArray(item) && item.length >= 2) {
                                                    const x = item[0];
                                                    const y = item[1];
                                                    itemData[key].push({ 
                                                        x, 
                                                        y, 
                                                        name: `æœ›è¿œé•œ ${groupIndex + 1}-${itemIndex + 1}`,
                                                        groupIndex: groupIndex,
                                                        itemIndex: itemIndex
                                                    });
                                                }
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData[key].length} ä¸ªä½ç½®`);
                            } catch (err) {
                                console.error(`åŠ è½½${key}æ•°æ®å¤±è´¥:`, err);
                                itemData[key] = [];
                            }
                        } else if (['tattoos', 'barbers', 'car_wash', 'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'].includes(key)) {
                            // ç®€å•æ•°ç»„ç»“æ„çš„å•†åº—ç±»å‹
                            try {
                                itemData[key] = [];
                                if (Array.isArray(data[key])) {
                                    data[key].forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 2) {
                                            const x = item[0];
                                            const y = item[1];
                                            const labels = item[2] || [];
                                            const label = Array.isArray(labels) && labels.length > 0 ? labels[0] : '';
                                            
                                            let name = '';
                                            switch(key) {
                                                case 'tattoos': name = `çº¹èº«åº— ${index + 1}`; break;
                                                case 'barbers': name = `ç†å‘åº— ${index + 1}`; break;
                                                case 'car_wash': name = `æ´—è½¦åº— ${index + 1}`; break;
                                                case 'shops_to_rob': name = `å¯æŠ¢åŠ«å•†åº— ${index + 1}`; break;
                                                case 'gas_stations': name = `åŠ æ²¹ç«™ ${index + 1}`; break;
                                                case 'atms': name = `ATMæœº ${index + 1}`; break;
                                                case 'vend_sprunk': name = `éœœç¢§å”®å–æœº ${index + 1}`; break;
                                                case 'vend_ecola': name = `æ˜“å¯ä¹å”®å–æœº ${index + 1}`; break;
                                            }
                                            
                                            itemData[key].push({ 
                                                x, 
                                                y, 
                                                name: name,
                                                label: label
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData[key].length} ä¸ªä½ç½®`);
                            } catch (err) {
                                console.error(`åŠ è½½${key}æ•°æ®å¤±è´¥:`, err);
                                itemData[key] = [];
                            }
                        } else if (['clothing', 'ammunation', 'mod_shop'].includes(key)) {
                            // å¯¹è±¡ç»“æ„çš„å•†åº—ç±»å‹ï¼ˆclothing, ammunationï¼‰
                            try {
                                itemData[key] = [];
                                if (data[key] && typeof data[key] === 'object') {
                                    Object.keys(data[key]).forEach((category, categoryIndex) => {
                                        if (Array.isArray(data[key][category])) {
                                            data[key][category].forEach((item, itemIndex) => {
                                                if (Array.isArray(item) && item.length >= 2) {
                                                    const x = item[0];
                                                    const y = item[1];
                                                    
                                                    let name = '';
                                                    if (key === 'clothing') {
                                                        const categoryNames = { 'cheap': 'ä¾¿å®œæœè£…åº—', 'mid': 'ä¸­ç­‰æœè£…åº—', 'high': 'é«˜æ¡£æœè£…åº—' };
                                                        name = `${categoryNames[category] || category} ${itemIndex + 1}`;
                                                    } else if (key === 'ammunation') {
                                                        name = `æ­¦è£…å›½åº¦ ${category} ${itemIndex + 1}`;
                                                    } else if (key === 'mod_shop') {
                                                        const categoryNames = { 'lsc': 'æ´›åœ£éƒ½æ”¹è½¦ç‹', 'lsc2': 'æ´›åœ£éƒ½æ”¹è½¦ç‹2', 'bennys': 'ç­å°¼æ”¹è£…åŠ', 'tuning_lscm': 'æ´›åœ£éƒ½è½¦å‹ä¼š' };
                                                        name = `${categoryNames[category] || category} ${itemIndex + 1}`;
                                                    }
                                                    
                                                    itemData[key].push({ 
                                                        x, 
                                                        y, 
                                                        name: name,
                                                        category: category,
                                                        categoryIndex: categoryIndex
                                                    });
                                                }
                                            });
                                        }
                                    });
                                }
                                console.log(`${key} æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData[key].length} ä¸ªä½ç½®`);
                            } catch (err) {
                                console.error(`åŠ è½½${key}æ•°æ®å¤±è´¥:`, err);
                                itemData[key] = [];
                            }
                        } else {
                            itemData[key] = data[key];
                        }
                    }
                });

                // æ˜¾å¼è¦†ç›–ï¼šmetal_detector æ¥è‡ª dataï¼ˆä¸€æ¬¡ï¼‰
                try {
                    if (Array.isArray(data.metal_detector)) {
                        itemData.metal_detector = data.metal_detector.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `é‡‘å±æ¢æµ‹å™¨ ${index + 1}`
                        }));
                    }
                } catch (e) {}

                // å•ç‹¬å¤„ç† treasure_hunt_dba_revolver ç»“æ„
                if (data.treasure_hunt_dba_revolver) {
                    try {
                        const th = data.treasure_hunt_dba_revolver;
                        const rc = Array.isArray(th.random_clue) ? th.random_clue : [];
                        const sc = Array.isArray(th.static_clues) ? th.static_clues : [];
                        itemData.treasure_hunt_dba_revolver = {
                            random_clue: rc.map(p => ({ x: p[0], y: p[1] })),
                            static_clues: sc.map(p => ({ x: p[0], y: p[1] }))
                        };
                    } catch (e) {
                        console.error('è§£ætreasure_hunt_dba_revolverå¤±è´¥', e);
                        itemData.treasure_hunt_dba_revolver = { random_clue: [], static_clues: [] };
                    }
                }
                
                // åŠ è½½æ‰€æœ‰ç‰©å“æ•°æ®ï¼ˆä»zones.jsonï¼‰
                try {
                    const cardsResponse = await fetch('../src/data/zones.json');
                    const cardsData = await cardsResponse.json();
                    
                    // åŠ è½½playing_cardsæ•°æ®
                    if (cardsData.playing_cards) {
                        itemData.playing_cards = cardsData.playing_cards.map(card => ({
                            x: card[0],
                            y: card[1],
                            name: card[2] || 'çº¸ç‰Œä½ç½®'
                        }));
                        console.log('çº¸ç‰Œä½ç½®æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.playing_cards.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½letter_scrapsæ•°æ®
                    if (cardsData.letter_scraps) {
                        itemData.letter_scraps = cardsData.letter_scraps.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `ä¿¡ä»¶æ®‹ç‰‡ ${index + 1}`
                        }));
                        console.log('ä¿¡ä»¶æ®‹ç‰‡æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.letter_scraps.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½sp_hidden_packagesæ•°æ®
                    if (cardsData.sp_hidden_packages) {
                        itemData.sp_hidden_packages = cardsData.sp_hidden_packages.map((item, index) => ({
                            x: item[0],
                            y: item[1],
                            description: item[2] || '',
                            name: `éšè—åŒ…è£¹ ${index + 1}`
                        }));
                        console.log('éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.sp_hidden_packages.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½peyote_spæ•°æ®
                    if (cardsData.peyote_sp && Array.isArray(cardsData.peyote_sp) && cardsData.peyote_sp.length > 0) {
                        const peyoteData = cardsData.peyote_sp[0]; // å–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡
                        
                        // é™†åœ°è¿·å¹»ä»™äººæŒ
                        if (peyoteData.land) {
                            itemData.peyote_sp_land = peyoteData.land.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `è¿·å¹»ä»™äººæŒé™†åœ° ${index + 1}`
                            }));
                            console.log('è¿·å¹»ä»™äººæŒé™†åœ°æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.peyote_sp_land.length, 'ä¸ªä½ç½®');
                        }
                        
                        // é¸Ÿç±»è¿·å¹»ä»™äººæŒ
                        if (peyoteData.air) {
                            itemData.peyote_sp_air = peyoteData.air.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `è¿·å¹»ä»™äººæŒé¸Ÿç±» ${index + 1}`
                            }));
                            console.log('è¿·å¹»ä»™äººæŒé¸Ÿç±»æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.peyote_sp_air.length, 'ä¸ªä½ç½®');
                        }
                        
                        // æ°´ä¸‹è¿·å¹»ä»™äººæŒ
                        if (peyoteData.water) {
                            itemData.peyote_sp_water = peyoteData.water.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `è¿·å¹»ä»™äººæŒæ°´ä¸‹ ${index + 1}`
                            }));
                            console.log('è¿·å¹»ä»™äººæŒæ°´ä¸‹æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.peyote_sp_water.length, 'ä¸ªä½ç½®');
                        }
                        
                        // é‡‘è‰²è¿·å¹»ä»™äººæŒ
                        if (peyoteData.special) {
                            itemData.peyote_sp_special = peyoteData.special.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `è¿·å¹»ä»™äººæŒé‡‘è‰² ${index + 1}`
                            }));
                            console.log('è¿·å¹»ä»™äººæŒé‡‘è‰²æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.peyote_sp_special.length, 'ä¸ªä½ç½®');
                        }
                    }
                    
                    // åŠ è½½submarine_piecesæ•°æ®
                    if (cardsData.submarine_pieces) {
                        itemData.submarine_pieces = cardsData.submarine_pieces.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `æ½œæ°´è‰‡ç¢ç‰‡ ${index + 1}`
                        }));
                        console.log('æ½œæ°´è‰‡ç¢ç‰‡æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.submarine_pieces.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½spaceship_partsæ•°æ®
                    if (cardsData.spaceship_parts) {
                        itemData.spaceship_parts = cardsData.spaceship_parts.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `å®‡å®™é£èˆ¹éƒ¨ä»¶ ${index + 1}`
                        }));
                        console.log('å®‡å®™é£èˆ¹éƒ¨ä»¶æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.spaceship_parts.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½nuclear_wasteæ•°æ®
                    if (cardsData.nuclear_waste) {
                        itemData.nuclear_waste = cardsData.nuclear_waste.map((item, index) => ({
                            x: item.x,
                            y: item.y,
                            name: `æ ¸åºŸæ–™ ${index + 1}`
                        }));
                        console.log('æ ¸åºŸæ–™æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.nuclear_waste.length, 'ä¸ªä½ç½®');
                    }
                    
                    // åŠ è½½ humans_of_ls æ•°æ®ï¼ˆæ•°ç»„å½¢å¼ï¼š[x, y, [id]]ï¼‰
                    if (Array.isArray(cardsData.humans_of_ls)) {
                        itemData.humans_of_ls = cardsData.humans_of_ls.map((arr, index) => {
                            const x = arr[0];
                            const y = arr[1];
                            const ids = Array.isArray(arr[2]) ? arr[2] : [];
                            const id = ids[0] || `humans_of_ls_${index + 1}`;
                            return { x, y, id, name: `æ´›åœ£éƒ½çš„äººç±» ${index + 1}` };
                        });
                        console.log('humans_of_ls æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.humans_of_ls.length, 'ä¸ªä½ç½®');
                    } else {
                        itemData.humans_of_ls = [];
                    }
                    
                    // åŠ è½½ monkey_mosaics æ•°æ®ï¼ˆæ•°ç»„å…ƒç´ ä¸ºå¯¹è±¡ï¼š{x:..., y:...}ï¼‰
                    if (Array.isArray(cardsData.monkey_mosaics)) {
                        itemData.monkey_mosaics = cardsData.monkey_mosaics.map((obj, index) => ({
                            x: obj.x,
                            y: obj.y,
                            name: `çŒ´å­é©¬èµ›å…‹ ${index + 1}`
                        }));
                        console.log('monkey_mosaics æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.monkey_mosaics.length, 'ä¸ªä½ç½®');
                    } else {
                        itemData.monkey_mosaics = [];
                    }

                    // åŠ è½½ murder_mystery_message æ•°æ®ï¼ˆzones.json.murder_mystery_messageï¼‰
                    try {
                        const m3 = cardsData.murder_mystery_message || {};
                        const flattened = [];
                        Object.keys(m3).forEach((groupKey) => {
                            const arr = Array.isArray(m3[groupKey]) ? m3[groupKey] : [];
                            arr.forEach((pair, idx) => {
                                if (Array.isArray(pair) && pair.length >= 2) {
                                    flattened.push({ x: pair[0], y: pair[1], group: String(groupKey), groupIndex: idx + 1, name: `è°‹æ€ä¹‹è°œä¿¡æ¯ ${groupKey}-${idx+1}` });
                                }
                            });
                        });
                        itemData.murder_mystery_message = flattened;
                        console.log('murder_mystery_message æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.murder_mystery_message.length, 'ä¸ªç‚¹');
                    } catch (e) {
                        console.warn('åŠ è½½ murder_mystery_message å¤±è´¥:', e);
                        itemData.murder_mystery_message = [];
                    }
                    
                    // åŠ è½½ assuming_the_truth æ•°æ®ï¼ˆzones.json.assuming_the_truthï¼‰
                    try {
                        if (Array.isArray(cardsData.assuming_the_truth)) {
                            itemData.assuming_the_truth = cardsData.assuming_the_truth.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('assuming_the_truth æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.assuming_the_truth.length, 'ä¸ªä½ç½®');
                        } else {
                            itemData.assuming_the_truth = [];
                        }
                    } catch (e) {
                        console.warn('åŠ è½½ assuming_the_truth å¤±è´¥:', e);
                        itemData.assuming_the_truth = [];
                    }
                    
                    // åŠ è½½ chasing_the_truth æ•°æ®ï¼ˆzones.json.chasing_the_truthï¼‰
                    try {
                        if (Array.isArray(cardsData.chasing_the_truth)) {
                            itemData.chasing_the_truth = cardsData.chasing_the_truth.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('chasing_the_truth æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.chasing_the_truth.length, 'ä¸ªä½ç½®');
                        } else {
                            itemData.chasing_the_truth = [];
                        }
                    } catch (e) {
                        console.warn('åŠ è½½ chasing_the_truth å¤±è´¥:', e);
                        itemData.chasing_the_truth = [];
                    }

                    // åŠ è½½ epsilon_tracts æ•°æ®ï¼ˆzones.json.epsilon_tractsï¼‰
                    try {
                        if (Array.isArray(cardsData.epsilon_tracts)) {
                            itemData.epsilon_tracts = cardsData.epsilon_tracts.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const name = Array.isArray(arr[2]) && arr[2][0] ? String(arr[2][0]) : '';
                                return { x, y, name };
                            });
                            console.log('epsilon_tracts æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.epsilon_tracts.length, 'ä¸ªä½ç½®');
                        } else {
                            itemData.epsilon_tracts = [];
                        }
                    } catch (e) {
                        console.warn('åŠ è½½ epsilon_tracts å¤±è´¥:', e);
                        itemData.epsilon_tracts = [];
                    }
                    // åŠ è½½ hitchhikers æ•°æ®ï¼ˆzones.json.hitchhikersï¼‰ï¼ŒåŒ…å«è¯´æ˜æ–‡å­—æ•°ç»„
                    try {
                        if (Array.isArray(cardsData.hitchhikers)) {
                            itemData.hitchhikers = cardsData.hitchhikers.map((arr, index) => {
                                const x = arr[0];
                                const y = arr[1];
                                const notes = Array.isArray(arr[2]) ? arr[2].map(s => String(s)) : [];
                                return { x, y, notes, name: `æ­ä¾¿è½¦ ${index + 1}` };
                            });
                            console.log('hitchhikers æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', itemData.hitchhikers.length, 'ä¸ªä½ç½®');
                        } else {
                            itemData.hitchhikers = [];
                        }
                    } catch (e) {
                        console.warn('åŠ è½½ hitchhikers å¤±è´¥:', e);
                        itemData.hitchhikers = [];
                    }
                    // åŠ è½½å…¶ä»–ç‰©å“æ•°æ®
                    const itemTypes = [
                        'smoke_on_the_water_product',
                        'action_figures', 
                        'yuanbao',
                        'ld_organics_products',
                        'signal_jammers',
                        'jack_o_lanterns',
                        'payphone_hits',
                        'golf_holes',
                        'snowmen',
                        'spray',
                        'for_sale_sign',
                        'the_big_score_gauntlet',
                        // æ€äººç‹‚å•ç‹¬åŠ è½½ï¼Œä¸èµ°é€šç”¨åˆ†æ”¯
                    ];
                    
                    itemTypes.forEach(type => {
                        try {
                            // ç‰¹æ®Šï¼šæ€äººç‹‚ï¼ˆä»åµŒå¥—å¯¹è±¡åŠ è½½ï¼‰
                            if (type === 'serial_killer_slasher_first' || type === 'serial_killer_slasher_last') {
                                // è·³è¿‡ï¼ˆæˆ‘ä»¬ä¸å†æŠŠè¿™ä¸¤ä¸ªä¼ªç±»å‹æ”¾åœ¨é€šç”¨æ•°ç»„é‡Œï¼‰
                            } else if (cardsData[type]) {
                                // å¤„ç†action_figuresçš„ç‰¹æ®ŠåµŒå¥—ç»“æ„
                                if (type === 'action_figures' && cardsData[type].regular) {
                                    // åˆå¹¶regularå’Œlast_twoæ•°ç»„
                                    const regularItems = cardsData[type].regular || [];
                                    const lastTwoItems = cardsData[type].last_two || [];
                                    itemData[type] = [...regularItems, ...lastTwoItems].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else if (Array.isArray(cardsData[type])) {
                                    // åªå¯¹æ•°ç»„ç±»å‹è°ƒç”¨mapæ–¹æ³•
                                    itemData[type] = cardsData[type].map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || type
                                    }));
                                } else {
                                    itemData[type] = [];
                                }
                                console.log(`${type}æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${itemData[type].length}ä¸ªä½ç½®`);
                            }
                        } catch (error) {
                            console.error(`åŠ è½½${type}æ•°æ®å¤±è´¥`);
                            itemData[type] = []; // æä¾›é»˜è®¤å€¼ï¼Œé¿å…åç»­é”™è¯¯
                        }
                    });

                    // å•ç‹¬åŠ è½½ï¼šæ´›åœ£éƒ½æ€äººç‹‚ï¼ˆfrom zones.json.serial_killer_slasherï¼‰
                    try {
                        if (cardsData.serial_killer_slasher) {
                            const f = cardsData.serial_killer_slasher.first || [];
                            const l = cardsData.serial_killer_slasher.last || [];
                            itemData.serial_killer_slasher.first = f.map((p, i) => ({ x: p[0], y: p[1], name: `æ€äººç‹‚çº¿ç´¢ ${i+1}` }));
                            itemData.serial_killer_slasher.last = l.map((p, i) => ({ x: p[0], y: p[1], name: `æ€äººç‹‚æœ€ç»ˆ ${i+1}` }));
                            console.log('serial_killer_slasher æ•°æ®åŠ è½½æˆåŠŸï¼š', itemData.serial_killer_slasher.first.length, itemData.serial_killer_slasher.last.length);
                        }
                    } catch (e) {
                        console.error('åŠ è½½ serial_killer_slasher å¤±è´¥', e);
                        itemData.serial_killer_slasher.first = [];
                        itemData.serial_killer_slasher.last = [];
                    }
                    
                    // å•ç‹¬åŠ è½½ï¼šèŒ‰å¾·æ‚¬èµç›®æ ‡ï¼ˆfrom zones.json.maude_bounty_targetsï¼‰
                    try {
                        if (cardsData.maude_bounty_targets) {
                            const areas = cardsData.maude_bounty_targets.areas || [];
                            const endpoints = cardsData.maude_bounty_targets.endpoints || [];
                            itemData.maude_bounty_targets.areas = areas.map((p, i) => ({ x: p[0], y: p[1], name: `æ‚¬èµåŒºåŸŸ ${i+1}` }));
                            itemData.maude_bounty_targets.endpoints = endpoints.map((p, i) => ({ x: p[0], y: p[1], name: `æ‚¬èµç»ˆç‚¹ ${i+1}` }));
                            console.log('maude_bounty_targets æ•°æ®åŠ è½½æˆåŠŸï¼š', itemData.maude_bounty_targets.areas.length, 'ä¸ªåŒºåŸŸï¼Œ', itemData.maude_bounty_targets.endpoints.length, 'ä¸ªç»ˆç‚¹');
                        }
                    } catch (e) {
                        console.error('åŠ è½½ maude_bounty_targets å¤±è´¥', e);
                        itemData.maude_bounty_targets.areas = [];
                        itemData.maude_bounty_targets.endpoints = [];
                    }
                    
                    // å•ç‹¬åŠ è½½ï¼šåª’ä½“è®°å¿†æ£’ï¼ˆfrom zones.json.media_sticksï¼‰
                    try {
                        if (cardsData.media_sticks) {
                            itemData.media_sticks = cardsData.media_sticks.map((item, i) => ({
                                x: item[0],
                                y: item[1],
                                name: item[2] || `åª’ä½“è®°å¿†æ£’ ${i+1}`,
                                label: item[2] || `media_stick_${i+1}` // ä¿å­˜æ ‡ç­¾ä¿¡æ¯ç”¨äºå¼¹çª—åŒ¹é…
                            }));
                            console.log('media_sticks æ•°æ®åŠ è½½æˆåŠŸï¼š', itemData.media_sticks.length, 'ä¸ªä½ç½®');
                        }
                    } catch (e) {
                        console.error('åŠ è½½ media_sticks å¤±è´¥', e);
                        itemData.media_sticks = [];
                    }
                    
                    // å•ç‹¬åŠ è½½ï¼šè—åŒ¿å±‹ï¼ˆfrom zones.json.stash_housesï¼‰
                    try {
                        if (cardsData.stash_houses) {
                            itemData.stash_houses = cardsData.stash_houses.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `è—åŒ¿å±‹ ${i+1}`
                            }));
                            console.log('stash_houses æ•°æ®åŠ è½½æˆåŠŸï¼š', itemData.stash_houses.length, 'ä¸ªä½ç½®');
                        }
                    } catch (e) {
                        console.error('åŠ è½½ stash_houses å¤±è´¥', e);
                        itemData.stash_houses = [];
                    }
                    
                    // å•ç‹¬åŠ è½½ï¼šç›å¾·æ‹‰ç´¢é›‡å‡¶ï¼ˆfrom zones.json.madrazo_hitsï¼‰
                    try {
                        if (cardsData.madrazo_hits) {
                            itemData.madrazo_hits = cardsData.madrazo_hits.map((item, i) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `ç›å¾·æ‹‰ç´¢é›‡å‡¶ ${i+1}`
                            }));
                            console.log('madrazo_hits æ•°æ®åŠ è½½æˆåŠŸï¼š', itemData.madrazo_hits.length, 'ä¸ªä½ç½®');
                        }
                    } catch (e) {
                        console.error('åŠ è½½ madrazo_hits å¤±è´¥', e);
                        itemData.madrazo_hits = [];
                    }
                    
                    // ç¡®ä¿stunt_jumpsæ•°æ®è¢«åŠ è½½
                    try {
                        if (cardsData && cardsData.stunt_jumps) {
                            // è½¬æ¢ä¸ºéœ€è¦çš„æ ¼å¼
                            itemData.stunt_jumps = cardsData.stunt_jumps.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `ç‰¹æŠ€è·³è·ƒç‚¹ ${index + 1}`
                            }));
                            console.log(`stunt_jumpsæ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${itemData.stunt_jumps.length}ä¸ªä½ç½®`);
                        } else {
                            console.error('åŠ è½½stunt_jumpsæ•°æ®å¤±è´¥ï¼šæœªæ‰¾åˆ°æ•°æ®');
                            itemData.stunt_jumps = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½stunt_jumpsæ•°æ®å¤±è´¥');
                        itemData.stunt_jumps = [];
                    }
                     
                    // ç¡®ä¿sprayæ•°æ®è¢«åŠ è½½
                    try {
                        if (cardsData && cardsData.spray_can) {
                            // è½¬æ¢ä¸ºéœ€è¦çš„æ ¼å¼
                            itemData.spray = cardsData.spray_can.map((item, index) => ({
                                x: item[0],
                                y: item[1],
                                name: `å–·ç½ä½ç½® ${index + 1}`
                            }));
                            console.log(`sprayæ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${itemData.spray.length}ä¸ªä½ç½®`);
                        } else {
                            console.error('åŠ è½½sprayæ•°æ®å¤±è´¥ï¼šæœªæ‰¾åˆ°æ•°æ®');
                            itemData.spray = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½sprayæ•°æ®å¤±è´¥');
                        itemData.spray = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šæ²‰ç¡çš„ä¿å®‰ï¼ˆdrunk_guardï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.drunk_guard)) {
                            itemData.drunk_guard = cardsData.drunk_guard.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `æ²‰ç¡çš„ä¿å®‰ ${index + 1}`
                            }));
                            console.log(`drunk_guard æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${itemData.drunk_guard.length}ä¸ªä½ç½®`);
                        }
                    } catch (error) {
                        console.error('åŠ è½½drunk_guardæ•°æ®å¤±è´¥');
                        itemData.drunk_guard = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šé‡‘å±æ¢æµ‹å™¨ï¼ˆmetal_detectorï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.metal_detector)) {
                            itemData.metal_detector = cardsData.metal_detector.map((item, index) => ({
                                x: item.x || item[0],
                                y: item.y || item[1],
                                name: `é‡‘å±æ¢æµ‹å™¨ ${index + 1}`
                            }));
                            console.log(`metal_detector æ•°æ®åŠ è½½æˆåŠŸï¼ˆäºŒæ¬¡åŠ è½½è¦†ç›–ï¼‰ï¼š${itemData.metal_detector.length} ä¸ªä½ç½®`);
                        }
                    } catch (error) {
                        console.error('åŠ è½½metal_detectoræ•°æ®å¤±è´¥');
                        itemData.metal_detector = [];
                    }

                    // é¢å¤–åŠ è½½ï¼šèµ°ç§è´©é£æœºï¼ˆsmuggler_planeï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.smuggler_plane)) {
                            itemData.smuggler_plane = cardsData.smuggler_plane.map((group, index) => ({
                                triggerpoint: group.triggerpoint,
                                routes: group.routes
                            }));
                            console.log(`smuggler_plane æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.smuggler_plane.length} ç»„`);
                        }
                    } catch (error) {
                        console.error('åŠ è½½smuggler_planeæ•°æ®å¤±è´¥');
                        itemData.smuggler_plane = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šèµ°ç§è´©è¸ªè¿¹ï¼ˆsmuggler_trailï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.smuggler_trail)) {
                            itemData.smuggler_trail = cardsData.smuggler_trail.map((group, index) => ({
                                triggerpoint: group.triggerpoint,
                                routes: group.routes
                            }));
                            console.log(`smuggler_trail æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.smuggler_trail.length} ç»„`);
                        }
                    } catch (error) {
                        console.error('åŠ è½½smuggler_trailæ•°æ®å¤±è´¥');
                        itemData.smuggler_trail = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šçŠ¯ç½ªç°åœºï¼ˆcrime_scenesï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.crime_scenes)) {
                            itemData.crime_scenes = cardsData.crime_scenes.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `çŠ¯ç½ªç°åœº ${index + 1}`
                            }));
                            console.log(`crime_scenes æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.crime_scenes.length} ä¸ªçŠ¯ç½ªç°åœºä½ç½®`);
                            console.log('crime_scenes æ•°æ®ç¤ºä¾‹:', itemData.crime_scenes[0]);
                        } else {
                            console.log('crime_scenes æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½crime_scenesæ•°æ®å¤±è´¥:', error);
                        itemData.crime_scenes = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šUFOè§‚å…‰ï¼ˆufoï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.ufo)) {
                            itemData.ufo = cardsData.ufo.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `UFOè§‚å…‰ ${index + 1}`
                            }));
                            console.log(`ufo æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.ufo.length} ä¸ªUFOè§‚å…‰ä½ç½®`);
                            console.log('ufo æ•°æ®ç¤ºä¾‹:', itemData.ufo[0]);
                        } else {
                            console.log('ufo æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ufoæ•°æ®å¤±è´¥:', error);
                        itemData.ufo = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šä¸‡åœ£èŠ‚æ€äººç‹‚ï¼ˆhalloween_slashersï¼‰
                    try {
                        if (cardsData && cardsData.halloween_slashers && typeof cardsData.halloween_slashers === 'object') {
                            itemData.halloween_slashers = [];
                            Object.keys(cardsData.halloween_slashers).forEach(slasherType => {
                                const slasherData = cardsData.halloween_slashers[slasherType];
                                if (Array.isArray(slasherData)) {
                                    slasherData.forEach((item, index) => {
                                        if (Array.isArray(item) && item.length >= 5) {
                                            itemData.halloween_slashers.push({
                                                x: item[0],
                                                y: item[1],
                                                radius: item[4],
                                                type: slasherType,
                                                name: `${slasherType} ${index + 1}`
                                            });
                                        }
                                    });
                                }
                            });
                            console.log(`halloween_slashers æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.halloween_slashers.length} ä¸ªä¸‡åœ£èŠ‚æ€äººç‹‚ä½ç½®`);
                            console.log('halloween_slashers æ•°æ®ç¤ºä¾‹:', itemData.halloween_slashers[0]);
                        } else {
                            console.log('halloween_slashers æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½halloween_slashersæ•°æ®å¤±è´¥:', error);
                        itemData.halloween_slashers = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šé¬¼ä¸Šèº«çš„åŠ¨ç‰©ï¼ˆpossessed_animalsï¼‰
                    try {
                        if (cardsData && cardsData.possessed_animals && typeof cardsData.possessed_animals === 'object') {
                            itemData.possessed_animals = [];
                            
                            // åŠ è½½areasæ•°æ®ï¼ˆåœ†å½¢åŒºåŸŸï¼‰
                            if (cardsData.possessed_animals.areas && Array.isArray(cardsData.possessed_animals.areas)) {
                                cardsData.possessed_animals.areas.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 5) {
                                        // ä»æ•°æ®ç»“æ„ä¸­æ­£ç¡®æå–åŠ¨ç‰©ç±»å‹
                                        // æ•°æ®ç»“æ„ï¼š[x, y, [["animal_boar"]], [["boar"]], radius]
                                        const animalType = item[3] && item[3][0] ? item[3][0] : 'unknown';
                                        itemData.possessed_animals.push({
                                            x: item[0],
                                            y: item[1],
                                            radius: item[4],
                                            type: 'area',
                                            animalType: animalType,
                                            name: `${animalType} åŒºåŸŸ ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            // åŠ è½½spawnsæ•°æ®ï¼ˆå…·ä½“ä½ç½®ï¼‰
                            if (cardsData.possessed_animals.spawns && typeof cardsData.possessed_animals.spawns === 'object') {
                                Object.keys(cardsData.possessed_animals.spawns).forEach(animalType => {
                                    const spawnData = cardsData.possessed_animals.spawns[animalType];
                                    if (Array.isArray(spawnData)) {
                                        spawnData.forEach((item, index) => {
                                            if (Array.isArray(item) && item.length >= 2) {
                                                // ä»spawnsæ•°æ®ç»“æ„ä¸­æå–åŠ¨ç‰©ç±»å‹
                                                // æ•°æ®ç»“æ„ï¼š[x, y, [["animal_boar"]], [["boar"]]]
                                                const extractedAnimalType = item[3] && item[3][0] ? item[3][0] : animalType;
                                                itemData.possessed_animals.push({
                                                    x: item[0],
                                                    y: item[1],
                                                    radius: 50, // é»˜è®¤å°åŠå¾„ç”¨äºspawns
                                                    type: 'spawn',
                                                    animalType: extractedAnimalType,
                                                    name: `${extractedAnimalType} ç”Ÿæˆç‚¹ ${index + 1}`
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                            
                            console.log(`possessed_animals æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.possessed_animals.length} ä¸ªé¬¼ä¸Šèº«åŠ¨ç‰©ä½ç½®`);
                            console.log('possessed_animals æ•°æ®ç¤ºä¾‹:', itemData.possessed_animals[0]);
                        } else {
                            console.log('possessed_animals æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½possessed_animalsæ•°æ®å¤±è´¥:', error);
                        itemData.possessed_animals = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šåœ°ç‹±çŠ¬ï¼ˆcerberusï¼‰
                    try {
                        if (cardsData && cardsData.cerberus && Array.isArray(cardsData.cerberus)) {
                            itemData.cerberus = cardsData.cerberus.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `åœ°ç‹±çŠ¬ ${index + 1}`
                            }));
                            console.log(`cerberus æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.cerberus.length} ä¸ªåœ°ç‹±çŠ¬ä½ç½®`);
                        } else {
                            console.log('cerberus æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½cerberusæ•°æ®å¤±è´¥:', error);
                        itemData.cerberus = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šé›ªæ€ªï¼ˆyetiï¼‰
                    try {
                        if (cardsData && cardsData.yeti && typeof cardsData.yeti === 'object') {
                            itemData.yeti = [];
                            
                            // åŠ è½½areaæ•°æ®ï¼ˆé›ªæ€ªåŒºåŸŸï¼‰
                            if (cardsData.yeti.area && Array.isArray(cardsData.yeti.area)) {
                                cardsData.yeti.area.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 5) {
                                        itemData.yeti.push({
                                            x: item[0],
                                            y: item[1],
                                            radius: item[4],
                                            type: 'area',
                                            name: `é›ªæ€ªåŒºåŸŸ ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            // åŠ è½½cluesæ•°æ®ï¼ˆçº¿ç´¢ä½ç½®ï¼‰
                            if (cardsData.yeti.clues && Array.isArray(cardsData.yeti.clues)) {
                                cardsData.yeti.clues.forEach((item, index) => {
                                    if (Array.isArray(item) && item.length >= 2) {
                                        itemData.yeti.push({
                                            x: item[0],
                                            y: item[1],
                                            type: 'clue',
                                            clueIndex: index + 1,
                                            name: `çº¿ç´¢ ${index + 1}`
                                        });
                                    }
                                });
                            }
                            
                            console.log(`yeti æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.yeti.length} ä¸ªé›ªæ€ªç›¸å…³ä½ç½®`);
                            console.log('yeti æ•°æ®ç¤ºä¾‹:', itemData.yeti[0]);
                        } else {
                            console.log('yeti æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½yetiæ•°æ®å¤±è´¥:', error);
                        itemData.yeti = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šç¤¾åŒºè¾¹ç•Œï¼ˆcommunity_outreachï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.community_outreach)) {
                            itemData.community_outreach = cardsData.community_outreach.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `ç¤¾åŒºè¾¹ç•Œ ${index + 1}`
                            }));
                            console.log(`community_outreach æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.community_outreach.length} ä¸ªç¤¾åŒºè¾¹ç•Œä½ç½®`);
                            console.log('community_outreach æ•°æ®ç¤ºä¾‹:', itemData.community_outreach[0]);
                        } else {
                            console.log('community_outreach æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½community_outreachæ•°æ®å¤±è´¥:', error);
                        itemData.community_outreach = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šå¤–è´¸å‡ºå£è½½å…·ï¼ˆexotic_exports1å’Œexotic_exports2ï¼‰
                    try {
                        // ä»APIè·å–å¤–è´¸å‡ºå£è½½å…·æ•°æ®
                        const response = await fetch('https://api-gta.antwen.com/api/items/exotic-exports');
                        let vehicleList = [];
                        let apiData = null;
                        
                        if (response.ok) {
                            const apiResponse = await response.json();
                            if (apiResponse.success && apiResponse.data && apiResponse.data.message) {
                                // è§£æè½¦è¾†åˆ—è¡¨
                                vehicleList = apiResponse.data.message.trim().split('\n').filter(vehicle => vehicle.trim());
                                apiData = apiResponse.data;
                                console.log(`exotic_exports APIæ•°æ®åŠ è½½æˆåŠŸï¼š${vehicleList.length} è¾†è½¦è¾†`);
                                console.log('exotic_exports è½¦è¾†åˆ—è¡¨:', vehicleList);
                            } else {
                                console.log('exotic_exports APIæ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                            }
                        } else {
                            console.log('exotic_exports APIè¯·æ±‚å¤±è´¥');
                        }
                        
                        // ä»zones.jsonåŠ è½½exotic_exports1åæ ‡æ•°æ®
                        if (cardsData && Array.isArray(cardsData.exotic_exports1)) {
                            itemData.exotic_exports1 = cardsData.exotic_exports1.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `å¤–è´¸å‡ºå£è½½å…·1 ${index + 1}`,
                                vehicleList: vehicleList,
                                apiData: apiData
                            }));
                            console.log(`exotic_exports1 åæ ‡æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.exotic_exports1.length} ä¸ªä½ç½®`);
                        } else {
                            console.log('exotic_exports1 åæ ‡æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                            itemData.exotic_exports1 = [];
                        }
                        
                        // ä»zones.jsonåŠ è½½exotic_exports2åæ ‡æ•°æ®
                        if (cardsData && Array.isArray(cardsData.exotic_exports2)) {
                            itemData.exotic_exports2 = cardsData.exotic_exports2.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `å¤–è´¸å‡ºå£è½½å…·2 ${index + 1}`,
                                vehicleList: vehicleList,
                                apiData: apiData
                            }));
                            console.log(`exotic_exports2 åæ ‡æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.exotic_exports2.length} ä¸ªä½ç½®`);
                        } else {
                            console.log('exotic_exports2 åæ ‡æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                            itemData.exotic_exports2 = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½exotic_exportsæ•°æ®å¤±è´¥:', error);
                        itemData.exotic_exports1 = [];
                        itemData.exotic_exports2 = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šå•†åº—æŠ¢åŠ«ï¼ˆstore_robberyï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.store_robbery)) {
                            itemData.store_robbery = cardsData.store_robbery.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `å•†åº—æŠ¢åŠ« ${index + 1}`
                            }));
                            console.log(`store_robbery æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.store_robbery.length} ä¸ªå•†åº—æŠ¢åŠ«ä½ç½®`);
                            console.log('store_robbery æ•°æ®ç¤ºä¾‹:', itemData.store_robbery[0]);
                        } else {
                            console.log('store_robbery æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½store_robberyæ•°æ®å¤±è´¥:', error);
                        itemData.store_robbery = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šè½¦é˜Ÿï¼ˆconvoyï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.convoy)) {
                            itemData.convoy = cardsData.convoy.map((convoy, index) => ({
                                triggerpoint: convoy.triggerpoint,
                                routes: convoy.routes,
                                name: `è½¦é˜Ÿ ${index + 1}`
                            }));
                            console.log(`convoy æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.convoy.length} ä¸ªè½¦é˜Ÿä½ç½®`);
                            console.log('convoy æ•°æ®ç¤ºä¾‹:', itemData.convoy[0]);
                        } else {
                            console.log('convoy æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½convoyæ•°æ®å¤±è´¥:', error);
                        itemData.convoy = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šè½¦é˜Ÿç»ˆç‚¹ï¼ˆconvoy_finalï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.convoy_final)) {
                            itemData.convoy_final = cardsData.convoy_final.map((point, index) => ({
                                x: point[0],
                                y: point[1],
                                name: `è½¦é˜Ÿç»ˆç‚¹ ${index + 1}`
                            }));
                            console.log(`convoy_final æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.convoy_final.length} ä¸ªè½¦é˜Ÿç»ˆç‚¹ä½ç½®`);
                            console.log('convoy_final æ•°æ®ç¤ºä¾‹:', itemData.convoy_final[0]);
                        } else {
                            console.log('convoy_final æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½convoy_finalæ•°æ®å¤±è´¥:', error);
                        itemData.convoy_final = [];
                    }
                    
                    // é¢å¤–åŠ è½½ï¼šè£…ç”²è¿é’è½¦ï¼ˆarmored_truckï¼‰
                    try {
                        if (cardsData && Array.isArray(cardsData.armored_truck)) {
                            itemData.armored_truck = cardsData.armored_truck.map((item, index) => ({
                                x: item.x,
                                y: item.y,
                                name: `è£…ç”²è¿é’è½¦ ${index + 1}`
                            }));
                            console.log(`armored_truck æ•°æ®åŠ è½½æˆåŠŸï¼š${itemData.armored_truck.length} ä¸ªè£…ç”²è¿é’è½¦ä½ç½®`);
                            console.log('armored_truck æ•°æ®ç¤ºä¾‹:', itemData.armored_truck[0]);
                        } else {
                            console.log('armored_truck æ•°æ®æœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½armored_truckæ•°æ®å¤±è´¥:', error);
                        itemData.armored_truck = [];
                    }
                    
                    // å•ç‹¬åŠ è½½dead_dropæ•°æ®ï¼ˆä»zones.jsonï¼‰
                    try {
                        // æ£€æŸ¥dataæ˜¯å¦å­˜åœ¨ä¸”åŒ…å«dead_dropæ•°æ®
                        if (data && Array.isArray(data.dead_drop)) {
                            // è½¬æ¢ä¸ºéœ€è¦çš„æ ¼å¼
                            itemData.dead_drop = data.dead_drop.map(item => ({
                                x: item.x,
                                y: item.y,
                                name: item.name || 'Dead Drop'
                            }));
                            console.log(`dead_dropæ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${itemData.dead_drop.length}ä¸ªä½ç½®`);
                        } else {
                            console.error('åŠ è½½dead_dropæ•°æ®å¤±è´¥ï¼šæœªæ‰¾åˆ°æ•°æ®');
                            itemData.dead_drop = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½dead_dropæ•°æ®å¤±è´¥');
                        itemData.dead_drop = [];
                    }
                    
                    // åŠ è½½ç”µå½±é“å…·æ•°æ®
                    try {
                        if (cardsData.movie_props) {
                            const mp = cardsData.movie_props;
                            
                            // åŠ è½½å›ºå®šä½ç½®
                            if (mp.fixed_position && Array.isArray(mp.fixed_position)) {
                                itemData.movie_props.fixed_position = mp.fixed_position.map(item => ({
                                    x: item[0],
                                    y: item[1],
                                    name: item[2] || 'å›ºå®šä½ç½®',
                                    type: 'fixed_position'
                                }));
                            }
                            
                            // åŠ è½½è½½å…·ä½ç½®
                            if (mp.vehicles) {
                                if (mp.vehicles.pony && Array.isArray(mp.vehicles.pony)) {
                                    itemData.movie_props.vehicles.pony = mp.vehicles.pony.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Ponyè½½å…·',
                                        type: 'pony'
                                    }));
                                }
                                if (mp.vehicles.rebel && Array.isArray(mp.vehicles.rebel)) {
                                    itemData.movie_props.vehicles.rebel = mp.vehicles.rebel.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rebelè½½å…·',
                                        type: 'rebel'
                                    }));
                                }
                                if (mp.vehicles.rumpo && Array.isArray(mp.vehicles.rumpo)) {
                                    itemData.movie_props.vehicles.rumpo = mp.vehicles.rumpo.map(item => ({
                                        x: item[0],
                                        y: item[1],
                                        name: item[2] || 'Rumpoè½½å…·',
                                        type: 'rumpo'
                                    }));
                                }
                            }
                            
                            console.log('ç”µå½±é“å…·æ•°æ®åŠ è½½æˆåŠŸ');
                            console.log('å›ºå®šä½ç½®:', itemData.movie_props.fixed_position.length);
                            console.log('Ponyè½½å…·:', itemData.movie_props.vehicles.pony.length);
                            console.log('Rebelè½½å…·:', itemData.movie_props.vehicles.rebel.length);
                            console.log('Rumpoè½½å…·:', itemData.movie_props.vehicles.rumpo.length);
                        } else {
                            console.error('åŠ è½½ç”µå½±é“å…·æ•°æ®å¤±è´¥ï¼šæœªæ‰¾åˆ°æ•°æ®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç”µå½±é“å…·æ•°æ®å¤±è´¥:', error);
                    }
                    
                } catch (cardsError) {
                    console.warn('åŠ è½½ç‰©å“ä½ç½®æ•°æ®å¤±è´¥:', cardsError);
                    console.log('å°è¯•åŠ è½½çš„URL:', '../src/data/zones.json');
                }
                
                // å°†itemDataèµ‹å€¼ç»™window.itemDataï¼Œä¾›è®¡æ•°å™¨å‡½æ•°ä½¿ç”¨
                window.itemData = itemData;
                
                // åŠ¨æ€è®¡ç®—æ­¦å™¨å¢å‹è½¦ä½ç½®
                await updateGunVanLocation();
                
                // åŠ¨æ€è·å–è¡—å¤´æ¯’è´©ä½ç½®
                await updateStreetDealersLocation();
                
                // åŠ¨æ€è·å–LSæ¶‚é¸¦ä½ç½®
                await updateLSTagsLocation();
                
                // åŠ¨æ€è·å–éšè—åŒ…è£¹ä½ç½®
                await updateHiddenCachesLocation();
                
                // åŠ¨æ€è·å–æ²‰èˆ¹ä½ç½®
                await updateShipwreckedLocation();
                
                // åŠ¨æ€è·å–æ—¶é—´æŒ‘æˆ˜èµ›ä½ç½®
                await updateTimeTrialsLocation();
                
                // åŠ¨æ€è·å–è·³ä¼ä½ç½®
                await updateSkydivesLocation();
                
                console.log('ç‰©å“æ•°æ®åŠ è½½æˆåŠŸ');
                
                // æ•°æ®åŠ è½½å®Œæˆåæ›´æ–°æ‰€æœ‰è®¡æ•°å™¨
                try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                try { updateStreetDealersSidebarCount(); } catch(e) {}
                try { updateSnowmenSidebarCount(); } catch(e) {}
                try { updateMoviePropsSidebarCount(); } catch(e) {}
                try { updateSpraySidebarCount(); } catch(e) {}
                try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                try { updateStuntJumpsSidebarCount(); } catch(e) {}
                try { updateYuanbaoSidebarCount(); } catch(e) {}
                try { updateSignalJammersSidebarCount(); } catch(e) {}
                try { updateActionFiguresSidebarCount(); } catch(e) {}
                try { updatePlayingCardsSidebarCount(); } catch(e) {}
                try { updateLetterScrapsSidebarCount(); } catch(e) {}
                try { updateJackOLanternsSidebarCount(); } catch(e) {}
                try { updateSpraySidebarCount(); } catch(e) {}
                try { updateOrganicFarmSidebarCount(); } catch(e) {}
                try { updateSkydivesSidebarCount(); } catch(e) {}
                try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                try { updateStashHousesSidebarCount(); } catch(e) {}
                try { updateLSTagsSidebarCount(); } catch(e) {}
                try { updateShipwreckedSidebarCount(); } catch(e) {}
                try { updateHiddenCachesSidebarCount(); } catch(e) {}
                try { updateSmokeProductSidebarCount(); } catch(e) {}
                try { updateDeadDropSidebarCount(); } catch(e) {}
                try { updateGunVanSidebarCount(); } catch(e) {}
                
                // é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ï¼Œç¡®ä¿è®¡æ•°å™¨æ­£ç¡®æ˜¾ç¤º
                setTimeout(() => {
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                }, 200);
            } catch (error) {
                console.error('åŠ è½½ç‰©å“æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ¨æ€è·å–è¡—å¤´æ¯’è´©ä½ç½®
        async function updateStreetDealersLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/street-dealers');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„è¡—å¤´æ¯’è´©åæ ‡æ•°æ®
                    itemData.street_dealers = result.data.coordinate;
                    // åŒæ­¥æ›´æ–°window.itemData
                    if (window.itemData) {
                        window.itemData.street_dealers = result.data.coordinate;
                    }
                    console.log('è¡—å¤´æ¯’è´©ä½ç½®è·å–æˆåŠŸï¼Œæ•°æ®é•¿åº¦:', result.data.coordinate.length);
                    // æ›´æ–°è®¡æ•°å™¨
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                } else {
                    console.warn('è¡—å¤´æ¯’è´©APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                    // ç¡®ä¿æœ‰é»˜è®¤æ•°æ®
                    if (!itemData.street_dealers || !Array.isArray(itemData.street_dealers)) {
                        itemData.street_dealers = [];
                    }
                    if (window.itemData && (!window.itemData.street_dealers || !Array.isArray(window.itemData.street_dealers))) {
                        window.itemData.street_dealers = [];
                    }
                }
            } catch (error) {
                console.warn('è·å–è¡—å¤´æ¯’è´©ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
                // ç¡®ä¿æœ‰é»˜è®¤æ•°æ®
                if (!itemData.street_dealers || !Array.isArray(itemData.street_dealers)) {
                    itemData.street_dealers = [];
                }
                if (window.itemData && (!window.itemData.street_dealers || !Array.isArray(window.itemData.street_dealers))) {
                    window.itemData.street_dealers = [];
                }
            }
        }

        // åŠ¨æ€è·å–LSæ¶‚é¸¦ä½ç½®ï¼ˆé€šè¿‡APIè·å–å½“å¤©ä½ç½®ï¼‰
        async function updateLSTagsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/ls-tags');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„LSæ¶‚é¸¦åæ ‡æ•°æ®
                    itemData.ls_tags = result.data.coordinate;
                    
                    // ä»messageå­—æ®µä¸­æå–æ¶‚é¸¦ç¼–å·å¹¶æ·»åŠ åˆ°æ¯ä¸ªtagå¯¹è±¡ä¸­ï¼ˆæ”¹è¿›åŒ¹é…ï¼Œé¿å…é‡å¤/è¯¯åŒ¹é…ï¼‰
                    if (result.data.message) {
                        const message = result.data.message;
                        // æ•è·å¤šè¯åç§°ï¼šç›´åˆ°æ¢è¡Œæˆ–ä¸‹ä¸€ä¸ª#
                        const tagInfoRegex = /#(\d+)\s+([^\n#]+)/g;
                        /**
                         * è§„èŒƒåŒ–åç§°ï¼šå°å†™ã€ç§»é™¤æ ‡ç‚¹ã€åˆå¹¶ç©ºç™½
                         */
                        const normalize = (s) => (s || '')
                            .toLowerCase()
                            .replace(/[^a-z0-9\u4e00-\u9fa5\s]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();

                        // è§£ææ¶ˆæ¯ä¸ºåˆ—è¡¨ï¼Œä¿ç•™é¡ºåºï¼Œä¾¿äºä¸€å¯¹ä¸€åˆ†é…
                        const tagInfoList = [];
                        let match;
                        while ((match = tagInfoRegex.exec(message)) !== null) {
                            const sequenceNumber = parseInt(match[1]);
                            const locationNameRaw = (match[2] || '').trim();
                            const locationNameNorm = normalize(locationNameRaw);
                            if (!Number.isNaN(sequenceNumber) && locationNameNorm) {
                                tagInfoList.push({ seq: sequenceNumber, nameRaw: locationNameRaw, nameNorm: locationNameNorm });
                            }
                        }

                        // å·²åˆ†é…çš„ç¼–å·ï¼Œé¿å…é‡å¤
                        const assignedSeq = new Set();
                        const usedIndex = new Set();

                        // ä¸ºæ¯ä¸ª tag åˆ†é…æœ€åˆé€‚çš„ç¼–å·
                        itemData.ls_tags.forEach(tag => {
                            if (!tag || !tag.name) return;
                            const tagNameNorm = normalize(tag.name);
                            const tagWords = tagNameNorm.split(' ');
                            const lastWord = tagWords[tagWords.length - 1] || '';

                            let bestIdx = -1;
                            // 1) ä¼˜å…ˆï¼šå®Œæ•´ç›¸ç­‰åŒ¹é…
                            for (let i = 0; i < tagInfoList.length; i++) {
                                if (usedIndex.has(i)) continue;
                                const info = tagInfoList[i];
                                if (assignedSeq.has(info.seq)) continue;
                                if (tagNameNorm === info.nameNorm) { bestIdx = i; break; }
                            }
                            // 2) æ¬¡ä¼˜ï¼šåŒ…å«ï¼ˆä»¥è¯è¾¹ç•Œè¿‘ä¼¼ï¼‰
                            if (bestIdx === -1) {
                                const paddedTag = ' ' + tagNameNorm + ' ';
                                for (let i = 0; i < tagInfoList.length; i++) {
                                    if (usedIndex.has(i)) continue;
                                    const info = tagInfoList[i];
                                    if (assignedSeq.has(info.seq)) continue;
                                    const paddedInfo = ' ' + info.nameNorm + ' ';
                                    if (paddedTag.includes(paddedInfo) || paddedInfo.includes(paddedTag)) { bestIdx = i; break; }
                                }
                            }
                            // 3) å¤‡é€‰ï¼šæœ«å°¾è¯ç²¾ç¡®åŒ¹é…
                            if (bestIdx === -1 && lastWord) {
                                for (let i = 0; i < tagInfoList.length; i++) {
                                    if (usedIndex.has(i)) continue;
                                    const info = tagInfoList[i];
                                    if (assignedSeq.has(info.seq)) continue;
                                    const infoWords = info.nameNorm.split(' ');
                                    const infoLast = infoWords[infoWords.length - 1] || '';
                                    if (lastWord && infoLast && lastWord === infoLast) { bestIdx = i; break; }
                                }
                            }

                            if (bestIdx !== -1) {
                                const info = tagInfoList[bestIdx];
                                tag.sequenceNumber = info.seq;
                                usedIndex.add(bestIdx);
                                assignedSeq.add(info.seq);
                            } else {
                                // æœªåŒ¹é…çš„ï¼Œä¿æŒä¸èµ‹å€¼ï¼Œé¿å…é”™è¯¯ç¼–å·
                                // å¯é€‰ï¼štag.sequenceNumber = undefined;
                            }
                        });

                        // è°ƒè¯•è¾“å‡ºï¼šæ£€æµ‹æ˜¯å¦ä»æœ‰é‡å¤
                        const seqCount = new Map();
                        (itemData.ls_tags || []).forEach(t => {
                            if (typeof t?.sequenceNumber === 'number') {
                                seqCount.set(t.sequenceNumber, (seqCount.get(t.sequenceNumber) || 0) + 1);
                            }
                        });
                        const duplicates = Array.from(seqCount.entries()).filter(([, c]) => c > 1).map(([k]) => k);
                        if (duplicates.length) {
                            console.warn('LSæ¶‚é¸¦ç¼–å·å­˜åœ¨é‡å¤ï¼š', duplicates);
                        } else {
                            console.log('LSæ¶‚é¸¦ç¼–å·ä¿¡æ¯æå–æˆåŠŸ');
                        }
                    }
                    
                    console.log('LSæ¶‚é¸¦ä½ç½®è·å–æˆåŠŸ');
                } else {
                    console.warn('LSæ¶‚é¸¦APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                }
            } catch (error) {
                console.warn('è·å–LSæ¶‚é¸¦ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
            }
        }

        // åŠ¨æ€è·å–éšè—åŒ…è£¹ä½ç½®ï¼ˆé€šè¿‡APIè·å–å½“å¤©ä½ç½®ï¼‰
        async function updateHiddenCachesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/hidden-caches');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„éšè—åŒ…è£¹åæ ‡æ•°æ®
                    itemData.hidden_caches = result.data.coordinate;
                    console.log('éšè—åŒ…è£¹ä½ç½®è·å–æˆåŠŸ');
                    // æ›´æ–°è®¡æ•°å™¨
                    try { updateHiddenCachesSidebarCount(); } catch(e) {}
                } else {
                    console.warn('éšè—åŒ…è£¹APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                }
            } catch (error) {
                console.warn('è·å–éšè—åŒ…è£¹ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
            }
        }

        // åŠ¨æ€è·å–æ²‰èˆ¹ä½ç½®ï¼ˆé€šè¿‡APIè·å–å½“å¤©ä½ç½®ï¼‰
        async function updateShipwreckedLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/shipwrecked');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„æ²‰èˆ¹åæ ‡æ•°æ®
                    itemData.shipwrecked = result.data.coordinate;
                    // ä¿å­˜APIè¿”å›çš„æ¶ˆæ¯ç”¨äºæå–æ²‰èˆ¹ç¼–å·
                    itemData.shipwreckedMessage = result.data.message;
                    console.log('æ²‰èˆ¹ä½ç½®è·å–æˆåŠŸ');
                    // æ›´æ–°è®¡æ•°å™¨
                    try { updateShipwreckedSidebarCount(); } catch(e) {}
                } else {
                    console.warn('æ²‰èˆ¹APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                }
            } catch (error) {
                console.warn('è·å–æ²‰èˆ¹ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
            }
        }

        // åŠ¨æ€è·å–æ—¶é—´æŒ‘æˆ˜èµ›ä½ç½®ï¼ˆé€šè¿‡APIè·å–å½“å¤©ä½ç½®ï¼‰
        async function updateTimeTrialsLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/time-trials');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„æ—¶é—´æŒ‘æˆ˜èµ›åæ ‡æ•°æ®
                    const { rc_time_trial, bike_time_trial } = result.data.coordinate;
                    
                    // è®¾ç½®RCæ—¶é—´æŒ‘æˆ˜èµ›æ•°æ®ï¼ˆä»…ä¸€ä¸ªä½ç½®ï¼‰
                    if (rc_time_trial) {
                        itemData.rc_time_trial = [{
                            x: rc_time_trial.x,
                            y: rc_time_trial.y,
                            name: rc_time_trial.name,
                            time: rc_time_trial.time
                        }];
                        console.log('RCæ—¶é—´æŒ‘æˆ˜èµ›ä½ç½®è·å–æˆåŠŸ');
                    } else {
                        itemData.rc_time_trial = [];
                    }
                    
                    // è®¾ç½®è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›æ•°æ®ï¼ˆä»…ä¸€ä¸ªä½ç½®ï¼‰
                    if (bike_time_trial) {
                        itemData.bike_time_trial = [{
                            x: bike_time_trial.x,
                            y: bike_time_trial.y,
                            name: bike_time_trial.name,
                            time: bike_time_trial.time
                        }];
                        console.log('è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›ä½ç½®è·å–æˆåŠŸ');
                    } else {
                        itemData.bike_time_trial = [];
                    }
                    
                    // ä¿å­˜APIè¿”å›çš„æ¶ˆæ¯ç”¨äºæ˜¾ç¤º
                    itemData.timeTrialsMessage = result.data.message;
                    
                } else {
                    console.warn('æ—¶é—´æŒ‘æˆ˜èµ›APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                    itemData.rc_time_trial = [];
                    itemData.bike_time_trial = [];
                }
            } catch (error) {
                console.warn('è·å–æ—¶é—´æŒ‘æˆ˜èµ›ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
                itemData.rc_time_trial = [];
                itemData.bike_time_trial = [];
            }
        }

        // åŠ¨æ€è·å–è·³ä¼ä½ç½®ï¼ˆé€šè¿‡APIè·å–å½“å¤©ä½ç½®ï¼‰
        async function updateSkydivesLocation() {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/items/skydives');
                const result = await response.json();
                
                if (result.success && result.data && result.data.coordinate) {
                    // ä½¿ç”¨APIè¿”å›çš„è·³ä¼åæ ‡æ•°æ®
                    itemData.skydives = result.data.coordinate;
                    console.log('è·³ä¼ä½ç½®è·å–æˆåŠŸ');
                } else {
                    console.warn('è·³ä¼APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é™æ€æ•°æ®');
                    // ä½¿ç”¨zones.jsonä¸­çš„é™æ€æ•°æ®ä½œä¸ºå¤‡ç”¨
                    const zonesResponse = await fetch('../src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                }
            } catch (error) {
                console.warn('è·å–è·³ä¼ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error);
                try {
                    // ä½¿ç”¨zones.jsonä¸­çš„é™æ€æ•°æ®ä½œä¸ºå¤‡ç”¨
                    const zonesResponse = await fetch('../src/data/zones.json');
                    const zonesData = await zonesResponse.json();
                    if (zonesData && Array.isArray(zonesData.skydives)) {
                        itemData.skydives = zonesData.skydives;
                    } else {
                        itemData.skydives = [];
                    }
                } catch (fallbackError) {
                    console.error('åŠ è½½é™æ€è·³ä¼æ•°æ®ä¹Ÿå¤±è´¥:', fallbackError);
                    itemData.skydives = [];
                }
            }
        }



        // åŠ¨æ€è®¡ç®—æ­¦å™¨å¢å‹è½¦ä½ç½®
        async function updateGunVanLocation() {
            const currentDay = Math.floor(Date.now() / 86400000); // æ¯å¤©å˜åŒ–
            
            if (gunVanLastUpdate !== currentDay) {
                gunVanLastUpdate = currentDay;
                
                // æ¨¡æ‹Ÿæ¸¸æˆä¸­çš„éšæœºæ•°ç”Ÿæˆé€»è¾‘
                const seed = getSeedValue();
                const location = getRandomGunVanLocation(seed);
                
                // åªä¿ç•™å½“å¤©çš„ä½ç½®
                if (itemData.gun_van && itemData.gun_van.length > 0) {
                    itemData.gun_van = [itemData.gun_van[location]];
                }
                
                console.log(`æ­¦å™¨å¢å‹è½¦ä»Šæ—¥ä½ç½®: ${location + 1}`);
            }
        }

        // æ¨¡æ‹Ÿæ¸¸æˆä¸­çš„ç§å­å€¼è®¡ç®—
        function getSeedValue() {
            const cloudTime = BigInt(Math.floor(Date.now() / 1000));
            return (cloudTime - 21600n) / 86400n;
        }

        // æ¨¡æ‹Ÿæ¸¸æˆä¸­çš„éšæœºä½ç½®é€‰æ‹©ï¼ˆä½¿ç”¨æ­£ç¡®çš„RNGç®—æ³•ï¼‰
        function getRandomGunVanLocation(seed) {
            const DISABLED_LOCATION = 4;
            
            // ä½¿ç”¨æ¸¸æˆä¸­çš„éšæœºæ•°ç”Ÿæˆç®—æ³•
            class GameRNG {
                constructor(seed) {
                    this.mask = (2n ** 32n - 1n);
                    this.magicNumber = 1557985959n;
                    const rolval = ((seed << 16n) & this.mask) | ((seed >> 16n) & this.mask);
                    this.seed0 = seed || 1n;
                    this.seed1 = seed ^ rolval;
                }
                
                nextSeed() {
                    const next_seed = this.magicNumber * this.seed0 + this.seed1;
                    this.seed0 = next_seed & BigInt(0xFFFFFFFF);
                    this.seed1 = next_seed >> 32n;
                    return next_seed;
                }
                
                getRandomInt(min, max) {
                    if (min === max) return Number(min);
                    if (min >= max) return 0;
                    const next_seed = this.nextSeed();
                    return Number(min + (next_seed & BigInt(0x7FFFFFFF)) % (max - min + 1n));
                }
            }
            
            const rng = new GameRNG(seed);
            let location = rng.getRandomInt(0n, 29n);
            
            // è·³è¿‡ç¦ç”¨ä½ç½®
            while (location === DISABLED_LOCATION) {
                location = rng.getRandomInt(0n, 29n);
            }
            
            return location;
        }

        // åˆ›å»ºèµ°ç§æ ‡è®°çš„Leafletç‰ˆæœ¬ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
        function createSmugglerLeafletMarkers(type) {
            const groups = itemData[type] || [];
            const z = map.getZoom();
            
            // åˆå§‹åŒ–ç»„æ ‡è®°å­˜å‚¨
            if (!window.smugglerGroupMarkers) {
                window.smugglerGroupMarkers = {};
            }
            if (!window.smugglerGroupMarkers[type]) {
                window.smugglerGroupMarkers[type] = [];
            }
            
            groups.forEach((group, gIndex) => {
                // ä¸ºæ¯ä¸ªç»„åˆ›å»ºæ ‡è®°æ•°ç»„
                const groupMarkers = [];
                const tp = group.triggerpoint; // [x, y]
                const routes = Array.isArray(group.routes) ? group.routes : [];
                
                if (Array.isArray(tp) && tp.length === 2) {
                    // åˆ›å»ºè§¦å‘ç‚¹æ ‡è®°
                    const pixel = gameToPixel(tp[0], tp[1], z);
                    const latlng = map.unproject(L.point(pixel.x, pixel.y), z);
                    
                    const iconUrl = type === 'smuggler_plane' ? '../src/assets/smuggler_plane.svg' : '../src/assets/smuggler_trail.svg';
                    const customIcon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14],
                        popupAnchor: [0, -14]
                    });
                    
                    const triggerMarker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    // ä¸ºèµ°ç§è´©é£æœºæ ‡è®°æ·»åŠ CSSç±»åï¼Œç”¨äºéšè—/æ˜¾ç¤ºåŠŸèƒ½
                    if (type === 'smuggler_plane') {
                        triggerMarker.getElement().classList.add('smuggler-plane-marker');
                    }
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    triggerMarker.on('click', function(e) {
                        if (type === 'smuggler_plane') {
                            showSmugglerPlanePopup(group, gIndex);
                        } else {
                            showSmugglerTrailPopup(group, gIndex);
                        }
                    });
                    
                    leafletMarkers.push(triggerMarker);
                    groupMarkers.push(triggerMarker); // æ·»åŠ åˆ°ç»„æ ‡è®°æ•°ç»„
                    
                    // åˆ›å»ºè·¯çº¿æ ‡è®°å’Œè¿æ¥çº¿
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            
                            const routePixel = gameToPixel(rx, ry, z);
                            const routeLatlng = map.unproject(L.point(routePixel.x, routePixel.y), z);
                            
                            // åˆ›å»ºè·¯çº¿ç‚¹æ ‡è®°ï¼ˆæ•°å­—æ ‡è®°ï¼‰
                            const routeIcon = L.divIcon({
                                html: `<div style="
                                    width: 24px; 
                                    height: 24px; 
                                    border-radius: 50%; 
                                    background-color: #2196F3; 
                                    border: 2px solid #fff; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    font-weight: bold; 
                                    color: #fff;
                                ">${rIndex + 1}</div>`,
                                className: 'custom-div-icon',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            const routeMarker = L.marker(routeLatlng, {
                                icon: routeIcon,
                                interactive: true,
                                zIndexOffset: 1000
                            }).addTo(map);
                            
                            // ä¸ºèµ°ç§è´©é£æœºè·¯çº¿æ ‡è®°æ·»åŠ CSSç±»åï¼Œç”¨äºéšè—/æ˜¾ç¤ºåŠŸèƒ½
                            if (type === 'smuggler_plane') {
                                routeMarker.getElement().classList.add('smuggler-plane-marker');
                            }
                            
                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            routeMarker.on('click', function(e) {
                                if (type === 'smuggler_plane') {
                                    showSmugglerPlanePopup(group, gIndex);
                                } else {
                                    showSmugglerTrailPopup(group, gIndex);
                                }
                            });
                            
                            leafletMarkers.push(routeMarker);
                            groupMarkers.push(routeMarker); // æ·»åŠ åˆ°ç»„æ ‡è®°æ•°ç»„
                            
                            // åˆ›å»ºè¿æ¥çº¿
                            const line = L.polyline([latlng, routeLatlng], {
                                color: '#ff0000',
                                weight: 2,
                                opacity: 0.8,
                                interactive: false
                            }).addTo(map);
                            
                            leafletMarkers.push(line);
                            groupMarkers.push(line); // æ·»åŠ åˆ°ç»„æ ‡è®°æ•°ç»„
                        }
                    });
                }
                
                // å°†ç»„æ ‡è®°æ•°ç»„å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­
                window.smugglerGroupMarkers[type][gIndex] = groupMarkers;
            });
        }

        // åˆ›å»ºLeafletæ ‡è®°ï¼ˆè¯•ç‚¹å‡½æ•°ï¼‰
        function createLeafletMarker(item, index, type) {
            const z = map.getZoom();
            const pixel = gameToPixel(item.x, item.y, z);
            const latlng = map.unproject(L.point(pixel.x, pixel.y), z);
            
            // ç‰¹æ®Šå¤„ç†serial_killer_slasher - first/last ç”¨ä¸åŒå›¾æ ‡
            if (type === 'serial_killer_slasher') {
                const iconUrl = (item && item.subtype === 'last') ? '../src/assets/slasher2.svg' : '../src/assets/slasher.svg';
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                marker.on('click', function(e) {
                    const firstCount = itemData.serial_killer_slasher?.first?.length || 0;
                    const isFirst = item && item.subtype !== 'last';
                    const displayIndex = index;
                    showSlasherPopup(item, displayIndex, isFirst ? 'first' : 'last');
                });
                
                // å­˜å‚¨æ ‡è®°åˆ°å…¨å±€æ•°ç»„
                if (!window.slasherMarkers) window.slasherMarkers = [];
                window.slasherMarkers[index] = marker;
                
                return marker;
            }

            // ç‰¹æ®Šå¤„ç† epsilon_tracts - ä¼ å•å›¾æ ‡ï¼ˆå¸¦åºå·ï¼‰
            if (type === 'epsilon_tracts') {
                const sequenceNumber = index + 1;

                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                            <img src="../src/assets/epsilon_tracts.svg" style="width: 32px; height: 32px;" />
                            <div style="
                                position: absolute;
                                top: 34px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                padding: 2px 6px;
                                border-radius: 10px;
                                min-width: 16px;
                                text-align: center;
                                border: 1px solid #fff;
                            ">${sequenceNumber}</div>
                        </div>
                    `,
                    className: 'epsilon-tracts-marker',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showEpsilonTractsPopup(item, index);
                });

                // è®°å½• epsilon_tracts æ ‡è®°
                if (!window.epsilonTractsMarkers) window.epsilonTractsMarkers = [];
                window.epsilonTractsMarkers[index] = marker;

                return marker;
            }

            // ç‰¹æ®Šå¤„ç† murder_mystery_message - å›¾æ ‡å åŠ æ•°å­—å¾½ç« ï¼ˆæ˜¾ç¤ºç»„å· 1/2/3ï¼‰
            if (type === 'murder_mystery_message') {
                const badge = (item && item.group) ? String(item.group) : '?';
                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: inline-block;">
                          <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                          <div style="position: absolute; right: -6px; top: -6px; background: #E53935; color: #fff; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.6);">${badge}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', function(e) {
                    showMurderMysteryMessageImage(index);
                });

                // è®°å½•è°‹æ€ä¹‹è°œä¿¡æ¯æ ‡è®°ï¼ˆç”¨äºéšè—/æ˜¾ç¤ºæ§åˆ¶ä¸å¯è§æ€§ç¼“å­˜ï¼‰
                try {
                    if (!window.murderMysteryMessageMarkers) window.murderMysteryMessageMarkers = [];
                    window.murderMysteryMessageMarkers[index] = marker;
                } catch (e) {}

                return marker;
            }

            // ç‰¹æ®Šå¤„ç†media_sticks - å¸¦æ–‡å­—æ ‡ç­¾
            if (type === 'media_sticks') {
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${item.name || `åª’ä½“è®°å¿†æ£’ ${index+1}`}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showMediaStickPopup(item, index);
                });
                
                // è®°å½•åª’ä½“è®°å¿†æ£’æ ‡è®°ï¼ˆç”¨äºéšè—/æ˜¾ç¤ºï¼‰
                try {
                    if (!window.mediaStickMarkers) window.mediaStickMarkers = [];
                    window.mediaStickMarkers[index] = marker;
                } catch (e) {}
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†police_rescue_patrick_mcreary - éœ€è¦å¤„ç†spawnå’Œdropoff
            if (type === 'police_rescue_patrick_mcreary') {
                // è¿™é‡Œéœ€è¦æ ¹æ®itemçš„å­ç±»å‹æ¥å†³å®šå›¾æ ‡
                let iconUrl = itemIcons[type]; // é»˜è®¤å›¾æ ‡
                if (item.subtype === 'dropoff') {
                    iconUrl = '../src/assets/patrick_drop.svg'; // é»„è‰²å›¾æ ‡
                }
                
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('ç‚¹å‡»å¸•ç‰¹é‡Œå…‹æ•‘æ´æ ‡è®°:', item, index, item.subtype);
                    showPatrickRescuePopup(item, index, item.subtype || 'spawn');
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†convoy - è½¦é˜Ÿæ ‡è®°ï¼ˆä¸åŒ…å«è·¯çº¿ï¼Œè·¯çº¿éœ€è¦å•ç‹¬å¤„ç†ï¼‰
            if (type === 'convoy') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showConvoyPopup(item, index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†convoy_final - è½¦é˜Ÿç»ˆç‚¹æ ‡è®°
            if (type === 'convoy_final') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showConvoyFinalPopup(item, index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†random_missions - éšæœºä»»åŠ¡æ ‡è®°ï¼ˆå¸¦æ—¶é—´æ®µæ ‡ç­¾ï¼‰
            if (type === 'random_missions') {
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <img src="${itemIcons[type]}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${item.timeSlot || 'æœªçŸ¥æ—¶é—´'}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('ç‚¹å‡»éšæœºä»»åŠ¡æ ‡è®°:', item, index, item.timeSlot, item.missionIndex);
                    // æ„é€ å®Œæ•´çš„ä»»åŠ¡æ•°æ®æ•°ç»„
                    const missionData = [item.x, item.y, item.taskName || 'æœªçŸ¥ä»»åŠ¡', [item.level || 1, item.players || 1, item.timeRange || 'å…¨å¤©']];
                    showRandomMissionPopup(missionData, item.timeSlot, item.missionIndex);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†treasure_hunt_dba_revolver - åŒºåˆ†éšæœº/å›ºå®šå›¾æ ‡
            if (type === 'treasure_hunt_dba_revolver') {
                const isRandom = item && item.subtype === 'random';
                const iconUrl = isRandom ? '../src/assets/th1.svg' : '../src/assets/th2.svg';
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    const mode = isRandom ? 'random' : 'static';
                    showTreasureHuntPopup(item, index, mode);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†exotic_exports1 - å¤–è´¸å‡ºå£è½½å…·1ï¼ˆæ˜¾ç¤ºè½¦è¾†ä¿¡æ¯ï¼‰
            if (type === 'exotic_exports1') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showExoticExportsPopup(item, 'exotic_exports1', index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†exotic_exports2 - å¤–è´¸å‡ºå£è½½å…·2ï¼ˆæ˜¾ç¤ºè½¦è¾†ä¿¡æ¯ï¼‰
            if (type === 'exotic_exports2') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showExoticExportsPopup(item, 'exotic_exports2', index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†happy_holidays_hauler - èŠ‚æ—¥å¿«ä¹å¡è½¦ï¼ˆtriggerpointæ ‡è®°ï¼‰
            if (type === 'happy_holidays_hauler') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showHappyHolidaysHaulerPopup(item, index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†wea - å¨æ³½å°”å¤§æ¥¼æªæˆ˜
            if (type === 'wea') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showItemInfo(item, type, index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†movie_props - ä¸åŒå­ç±»å‹ä¸åŒå›¾æ ‡
            if (type === 'movie_props') {
                let iconUrl = '../src/assets/mp_static.svg';
                if (item && item.type === 'pony') {
                    iconUrl = '../src/assets/mp_pony.svg';
                } else if (item && item.type === 'rebel') {
                    iconUrl = '../src/assets/mp_rebel.svg';
                } else if (item && item.type === 'rumpo') {
                    iconUrl = '../src/assets/mp_rumpo.svg';
                } else if (item && item.type === 'fixed_position') {
                    iconUrl = '../src/assets/mp_static.svg';
                }
                
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    // ä¼˜å…ˆä½¿ç”¨æ•°æ®é‡Œçš„å­ç±»å‹
                    let subtype = item && item.type ? item.type : undefined;
                    if (!subtype) {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        const fixedCount = mp.fixed_position?.length || 0;
                        const ponyCount = mp.vehicles?.pony?.length || 0;
                        const rebelCount = mp.vehicles?.rebel?.length || 0;
                        if (index < fixedCount) subtype = 'fixed_position';
                        else if (index < fixedCount + ponyCount) subtype = 'pony';
                        else if (index < fixedCount + ponyCount + rebelCount) subtype = 'rebel';
                        else subtype = 'rumpo';
                    }
                    showMoviePropsPopup(item, index, subtype);
                });
                
                // è®°å½• movie_props æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶ä¸å¯è§æ€§ç¼“å­˜
                if (!window.moviePropsMarkers) window.moviePropsMarkers = [];
                window.moviePropsMarkers[index] = marker;
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†halloween_slashers - ä¸‡åœ£èŠ‚æ€äººç‹‚åœ†å½¢åŒºåŸŸ
            if (type === 'halloween_slashers') {
                // è®¡ç®—åœ†å½¢åŠå¾„ï¼ˆä½¿ç”¨åƒç´ åæ ‡ï¼Œä¸åŸDOMå®ç°ä¸€è‡´ï¼‰
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const radiusPixels = (item.radius / gameWidth) * totalWidth;
                
                // ä½¿ç”¨circleMarkerè€Œä¸æ˜¯circleï¼Œä»¥åƒç´ ä¸ºå•ä½
                const circle = L.circleMarker(latlng, {
                    color: getSlasherColor(item.type).border,
                    fillColor: getSlasherColor(item.type).fill,
                    fillOpacity: 0.3,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // åœ¨åœ†å¿ƒæ·»åŠ å›¾æ ‡
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // ä¸ºåœ†å½¢å’Œå›¾æ ‡éƒ½æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const clickHandler = function(e) {
                    showHalloweenSlasherPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // è¿”å›ä¸€ä¸ªåŒ…å«åœ†å½¢å’Œå›¾æ ‡çš„ç»„åˆå¯¹è±¡
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // ä¿å­˜itemæ•°æ®ç”¨äºç¼©æ”¾æ—¶æ›´æ–°åŠå¾„
                    type: type, // ä¿å­˜æ ‡è®°ç±»å‹ç”¨äºåŠå¾„æ›´æ–°
                    // å®ç°ä¸å•ä¸ªmarkerç›¸åŒçš„æ¥å£
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // ç‰¹æ®Šå¤„ç†possessed_animals - é¬¼ä¸Šèº«åŠ¨ç‰©åœ†å½¢åŒºåŸŸ
            if (type === 'possessed_animals') {
                // è®¡ç®—åœ†å½¢åŠå¾„ï¼ˆä½¿ç”¨åƒç´ åæ ‡ï¼Œä¸åŸDOMå®ç°ä¸€è‡´ï¼‰
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const radiusPixels = (item.radius / gameWidth) * totalWidth;
                
                // ä½¿ç”¨circleMarkerè€Œä¸æ˜¯circleï¼Œä»¥åƒç´ ä¸ºå•ä½
                const circle = L.circleMarker(latlng, {
                    color: getPossessedAnimalColor(item.animalType).border,
                    fillColor: getPossessedAnimalColor(item.animalType).fill,
                    fillOpacity: 0.3,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // åœ¨åœ†å¿ƒæ·»åŠ å›¾æ ‡
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // ä¸ºåœ†å½¢å’Œå›¾æ ‡éƒ½æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const clickHandler = function(e) {
                    showPossessedAnimalPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // è¿”å›ä¸€ä¸ªåŒ…å«åœ†å½¢å’Œå›¾æ ‡çš„ç»„åˆå¯¹è±¡
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // ä¿å­˜itemæ•°æ®ç”¨äºç¼©æ”¾æ—¶æ›´æ–°åŠå¾„
                    type: type, // ä¿å­˜æ ‡è®°ç±»å‹ç”¨äºåŠå¾„æ›´æ–°
                    // å®ç°ä¸å•ä¸ªmarkerç›¸åŒçš„æ¥å£
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // ç‰¹æ®Šå¤„ç†yeti - é›ªæ€ªï¼ˆåœ†å½¢åŒºåŸŸå’Œçº¿ç´¢ç‚¹ï¼‰
            if (type === 'yeti') {
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                if (item.type === 'area') {
                    // å¤„ç†é›ªæ€ªåŒºåŸŸï¼ˆç™½è‰²åœ†åœˆï¼‰
                    const totalWidth = level.cols * TILE_SIZE;
                    const gameWidth = GAME_RIGHT - GAME_LEFT;
                    const radiusPixels = (item.radius / gameWidth) * totalWidth;
                    
                    const circle = L.circleMarker(latlng, {
                        color: '#FFFFFF',
                        fillColor: 'rgba(255, 255, 255, 0.1)',
                        fillOpacity: 0.3,
                        weight: 3,
                        radius: radiusPixels,
                        interactive: true
                    }).addTo(map);
                    
                    // é›ªæ€ªåŒºåŸŸåªæ˜¾ç¤ºåœ†åœˆï¼Œä¸æ˜¾ç¤ºå›¾æ ‡
                    const clickHandler = function(e) {
                        showYetiPopup(item, index);
                    };
                    
                    circle.on('click', clickHandler);
                    
                    return {
                        circle: circle,
                        icon: null,
                        item: item,
                        type: type, // ä¿å­˜æ ‡è®°ç±»å‹ç”¨äºåŠå¾„æ›´æ–°
                        addTo: function(map) { return this; },
                        removeFrom: function(map) {
                            map.removeLayer(this.circle);
                            return this;
                        }
                    };
                } else if (item.type === 'clue') {
                    // å¤„ç†çº¿ç´¢ç‚¹ï¼ˆwhat.svgå›¾æ ‡ï¼‰
                    const customIcon = L.icon({
                        iconUrl: '../src/assets/what.svg',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    const marker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    marker.on('click', function(e) {
                        showYetiPopup(item, index);
                    });
                    
                    return marker;
                }
            }
            
            // ç‰¹æ®Šå¤„ç†maude_bounty_targets - èŒ‰å¾·æ‚¬èµç›®æ ‡
            if (type === 'maude_bounty_targets') {
                if (item.subtype === 'area') {
                    // æ‚¬èµåŒºåŸŸï¼šé»„è‰²åœ†åœˆï¼ŒåŠå¾„185æ¸¸æˆå•ä½
                    const level = getLevelByZoom(z);
                    if (!level) return null;
                    
                    const totalWidth = level.cols * TILE_SIZE;
                    const gameWidth = GAME_RIGHT - GAME_LEFT;
                    const bountyRadius = 185; // å›ºå®šåŠå¾„185æ¸¸æˆå•ä½
                    const radiusPixels = (bountyRadius / gameWidth) * totalWidth;
                    
                    // åˆ›å»ºé»„è‰²åœ†åœˆ
                    const circle = L.circleMarker(latlng, {
                        color: '#FFD700', // é‡‘é»„è‰²è¾¹æ¡†
                        fillColor: '#FFD700',
                        fillOpacity: 0.2,
                        weight: 3,
                        radius: radiusPixels,
                        interactive: true
                    }).addTo(map);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    circle.on('click', function(e) {
                        showMaudeBountyPopup(item, index, 'area');
                    });
                    
                    return {
                        circle: circle,
                        icon: null,
                        item: { ...item, radius: bountyRadius }, // æ·»åŠ åŠå¾„ä¿¡æ¯ç”¨äºç¼©æ”¾æ›´æ–°
                        addTo: function(map) { return this; },
                        removeFrom: function(map) {
                            map.removeLayer(this.circle);
                            return this;
                        }
                    };
                } else if (item.subtype === 'endpoint') {
                    // æ‚¬èµç»ˆç‚¹ï¼šé»„è‰²å°å‰å·
                    const customIcon = L.divIcon({
                        html: `
                            <div style="width: 16px; height: 16px; position: relative;">
                                <div style="position: absolute; top: 50%; left: 50%; width: 12px; height: 2px; background: #FFD700; transform: translate(-50%, -50%) rotate(45deg);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; width: 12px; height: 2px; background: #FFD700; transform: translate(-50%, -50%) rotate(-45deg);"></div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -8]
                    });
                    
                    const marker = L.marker(latlng, {
                        icon: customIcon,
                        interactive: true,
                        zIndexOffset: 1001
                    }).addTo(map);
                    
                    marker.on('click', function(e) {
                        showMaudeBountyPopup(item, index, 'endpoint');
                    });
                    
                    return marker;
                }
            }
            
            // ç‰¹æ®Šå¤„ç†gang_attacks - å¸®æ´¾æ”»å‡»åœ†å½¢åŒºåŸŸ
            if (type === 'gang_attacks') {
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦åŒ¹é…
                if (!isGangAttackActive(item.time)) {
                    return null; // ä¸åœ¨æ—¶é—´èŒƒå›´å†…ï¼Œä¸æ˜¾ç¤º
                }
                
                // è®¡ç®—åœ†å½¢åŠå¾„ï¼ˆå›ºå®š100æ¸¸æˆå•ä½ï¼‰
                const level = getLevelByZoom(z);
                if (!level) return null;
                
                const totalWidth = level.cols * TILE_SIZE;
                const gameWidth = GAME_RIGHT - GAME_LEFT;
                const gameRadius = 100; // æ¸¸æˆåæ ‡åŠå¾„
                const radiusPixels = (gameRadius / gameWidth) * totalWidth;
                
                // ä½¿ç”¨circleMarkeråˆ›å»ºå›ºå®šåƒç´ å¤§å°çš„åœ†å½¢
                const circle = L.circleMarker(latlng, {
                    color: '#FF0000',
                    fillColor: '#FF0000',
                    fillOpacity: 0.1,
                    weight: 3,
                    radius: radiusPixels,
                    interactive: true
                }).addTo(map);
                
                // åœ¨åœ†å¿ƒæ·»åŠ å›¾æ ‡
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const iconMarker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1001
                }).addTo(map);
                
                // ä¸ºåœ†å½¢å’Œå›¾æ ‡éƒ½æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const clickHandler = function(e) {
                    showGangAttackPopup(item, index);
                };
                
                circle.on('click', clickHandler);
                iconMarker.on('click', clickHandler);
                
                // è¿”å›ä¸€ä¸ªåŒ…å«åœ†å½¢å’Œå›¾æ ‡çš„ç»„åˆå¯¹è±¡
                return {
                    circle: circle,
                    icon: iconMarker,
                    item: item, // ä¿å­˜itemæ•°æ®ç”¨äºç¼©æ”¾æ—¶æ›´æ–°åŠå¾„
                    type: type, // ä¿å­˜æ ‡è®°ç±»å‹ç”¨äºåŠå¾„æ›´æ–°
                    // å®ç°ä¸å•ä¸ªmarkerç›¸åŒçš„æ¥å£
                    addTo: function(map) { return this; },
                    removeFrom: function(map) {
                        map.removeLayer(this.circle);
                        map.removeLayer(this.icon);
                        return this;
                    }
                };
            }
            
            // ç‰¹æ®Šå¤„ç†ghosts3 - å¹½çµæ›å…‰ï¼ˆæœ€åä¸€ä¸ªç”¨ä¸åŒå›¾æ ‡ + æ—¶é—´æ ‡ç­¾ï¼‰
            if (type === 'ghosts3') {
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªæ ‡è®°
                const isLast = index === (itemData[type]?.length ?? 0) - 1;
                const iconUrl = isLast ? '../src/assets/ge252.svg' : '../src/assets/ge251.svg';
                
                // ä½¿ç”¨divIconåˆ›å»ºåŒ…å«æ—¶é—´æ ‡ç­¾çš„å¤åˆæ ‡è®°
                const customIcon = L.divIcon({
                    html: `
                        <div style="display: flex; flex-direction: column; align-items: center; position: relative;">
                            <img src="${iconUrl}" style="width: 32px; height: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                            <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 2px; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); pointer-events: none;">${item.time || 'æœªçŸ¥æ—¶é—´'}</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [32, 50],
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    showGhosts3Popup(item, index);
                });
                
                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç† assuming_the_truth - è½¦/æ‘©æ‰˜åŠ¨æ€å›¾æ ‡ï¼ˆåŒT ç”¨æ‘©æ‰˜ï¼‰
            if (type === 'assuming_the_truth') {
                const isBike = (item && item.name === 'åŒT');
                const iconUrl = isBike
                    ? '../src/assets/assuming_the_truth_bike.svg'
                    : '../src/assets/assuming_the_truth_car.svg';

                const customIcon = L.icon({
                    iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showAssumingTheTruthPopup(item, index);
                });

                // è®°å½• assuming_the_truth æ ‡è®°
                if (!window.assumingTheTruthMarkers) window.assumingTheTruthMarkers = [];
                window.assumingTheTruthMarkers[index] = marker;

                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç† chasing_the_truth - ç¥å™¨å›¾æ ‡ï¼ˆå¸¦åºå·ï¼‰
            if (type === 'chasing_the_truth') {
                const sequenceNumber = index + 1;
                
                // ä½¿ç”¨ divIcon æ¥åŒæ—¶æ˜¾ç¤ºå›¾æ ‡å’Œåºå·
                const customIcon = L.divIcon({
                    html: `
                        <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                            <img src="../src/assets/chasing_the_truth.svg" style="width: 32px; height: 32px;" />
                            <div style="
                                position: absolute;
                                top: 34px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                padding: 2px 6px;
                                border-radius: 10px;
                                min-width: 16px;
                                text-align: center;
                                border: 1px solid #fff;
                            ">${sequenceNumber}</div>
                        </div>
                    `,
                    className: 'chasing-the-truth-marker',
                    iconSize: [32, 50], // å¢åŠ é«˜åº¦ä»¥å®¹çº³åºå·
                    iconAnchor: [16, 25],
                    popupAnchor: [0, -25]
                });

                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);

                marker.on('click', () => {
                    showChasingTheTruthPopup(item, index);
                });

                // è®°å½• chasing_the_truth æ ‡è®°
                if (!window.chasingTheTruthMarkers) window.chasingTheTruthMarkers = [];
                window.chasingTheTruthMarkers[index] = marker;

                return marker;
            }
            
            // ç‰¹æ®Šå¤„ç†cerberus - åœ°ç‹±çŠ¬ï¼ˆåªæ˜¾ç¤ºå›¾æ ‡ï¼Œæ— åœ†åœˆï¼‰
            if (type === 'cerberus') {
                const customIcon = L.icon({
                    iconUrl: itemIcons[type],
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                const marker = L.marker(latlng, {
                    icon: customIcon,
                    interactive: true,
                    zIndexOffset: 1000
                }).addTo(map);
                
                marker.on('click', function(e) {
                    console.log('ç‚¹å‡»ä¸‡åœ£èŠ‚åœ°ç‹±çŠ¬äº‹ä»¶æ ‡è®°:', item, index);
                    showCerberusPopup(item, index);
                });
                
                return marker;
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
            const customIcon = L.icon({
                iconUrl: itemIcons[type],
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
            
            // åˆ›å»ºLeafletæ ‡è®°
            const marker = L.marker(latlng, {
                icon: customIcon,
                interactive: true,
                zIndexOffset: 1000
            }).addTo(map);
            
            // è®°å½• gun_van æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
            try {
                if (type === 'gun_van') {
                    if (!window.gunVanMarkers) window.gunVanMarkers = [];
                    window.gunVanMarkers[index] = marker;
                }
                // è®°å½• street_dealers æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'street_dealers') {
                    if (!window.streetDealersMarkers) window.streetDealersMarkers = [];
                    window.streetDealersMarkers[index] = marker;
                }
                // è®°å½• media_sticks æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'media_sticks') {
                    if (!window.mediaStickMarkers) window.mediaStickMarkers = [];
                    window.mediaStickMarkers[index] = marker;
                }
                // è®°å½• movie_props æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'movie_props') {
                    if (!window.moviePropsMarkers) window.moviePropsMarkers = [];
                    window.moviePropsMarkers[index] = marker;
                }
                // è®°å½• ld_organics_products æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ld_organics_products') {
                    if (!window.organicFarmMarkers) window.organicFarmMarkers = [];
                    window.organicFarmMarkers[index] = marker;
                }
                // è®°å½• action_figures æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'action_figures') {
                    if (!window.actionFiguresMarkers) window.actionFiguresMarkers = [];
                    window.actionFiguresMarkers[index] = marker;
                }
                // è®°å½• playing_cards æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'playing_cards') {
                    if (!window.playingCardsMarkers) window.playingCardsMarkers = [];
                    window.playingCardsMarkers[index] = marker;
                }
                // è®°å½• letter_scraps æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'letter_scraps') {
                    if (!window.letterScrapsMarkers) window.letterScrapsMarkers = [];
                    window.letterScrapsMarkers[index] = marker;
                }
                // è®°å½• sp_hidden_packages æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'sp_hidden_packages') {
                    if (!window.spHiddenPackagesMarkers) window.spHiddenPackagesMarkers = [];
                    window.spHiddenPackagesMarkers[index] = marker;
                }
                // è®°å½• peyote_sp_land æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'peyote_sp_land') {
                    if (!window.peyoteSpLandMarkers) window.peyoteSpLandMarkers = [];
                    window.peyoteSpLandMarkers[index] = marker;
                }
                // è®°å½• peyote_sp_air æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'peyote_sp_air') {
                    if (!window.peyoteSpAirMarkers) window.peyoteSpAirMarkers = [];
                    window.peyoteSpAirMarkers[index] = marker;
                }
                // è®°å½• peyote_sp_water æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'peyote_sp_water') {
                    if (!window.peyoteSpWaterMarkers) window.peyoteSpWaterMarkers = [];
                    window.peyoteSpWaterMarkers[index] = marker;
                }
                // è®°å½• peyote_sp_special æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'peyote_sp_special') {
                    if (!window.peyoteSpSpecialMarkers) window.peyoteSpSpecialMarkers = [];
                    window.peyoteSpSpecialMarkers[index] = marker;
                }
                // è®°å½• submarine_pieces æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'submarine_pieces') {
                    if (!window.submarinePiecesMarkers) window.submarinePiecesMarkers = [];
                    window.submarinePiecesMarkers[index] = marker;
                }
                // è®°å½• spaceship_parts æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'spaceship_parts') {
                    if (!window.spaceshipPartsMarkers) window.spaceshipPartsMarkers = [];
                    window.spaceshipPartsMarkers[index] = marker;
                }
                // è®°å½• nuclear_waste æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'nuclear_waste') {
                    if (!window.nuclearWasteMarkers) window.nuclearWasteMarkers = [];
                    window.nuclearWasteMarkers[index] = marker;
                }
                // è®°å½• humans_of_ls æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'humans_of_ls') {
                    if (!window.humansOfLsMarkers) window.humansOfLsMarkers = [];
                    window.humansOfLsMarkers[index] = marker;
                }
                // è®°å½• monkey_mosaics æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'monkey_mosaics') {
                    if (!window.monkeyMosaicsMarkers) window.monkeyMosaicsMarkers = [];
                    window.monkeyMosaicsMarkers[index] = marker;
                }
                // è®°å½• skydives æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'skydives') {
                    if (!window.skydivesMarkers) window.skydivesMarkers = [];
                    window.skydivesMarkers[index] = marker;
                }
                // è®°å½• madrazo_hits æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'madrazo_hits') {
                    if (!window.madrazoHitsMarkers) window.madrazoHitsMarkers = [];
                    window.madrazoHitsMarkers[index] = marker;
                }
                // è®°å½• ls_tags æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ls_tags') {
                    if (!window.lsTagsMarkers) window.lsTagsMarkers = [];
                    window.lsTagsMarkers[index] = marker;
                }
                // è®°å½• shipwrecked æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'shipwrecked') {
                    if (!window.shipwreckedMarkers) window.shipwreckedMarkers = [];
                    window.shipwreckedMarkers[index] = marker;
                }
                // è®°å½• hidden_caches æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'hidden_caches') {
                    if (!window.hiddenCachesMarkers) window.hiddenCachesMarkers = [];
                    window.hiddenCachesMarkers[index] = marker;
                }
                // è®°å½• smoke_on_the_water_product æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'smoke_on_the_water_product') {
                    if (!window.smokeProductMarkers) window.smokeProductMarkers = [];
                    window.smokeProductMarkers[index] = marker;
                }
                // è®°å½• rc_time_trial æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'rc_time_trial') {
                    if (!window.rcTimeTrialMarkers) window.rcTimeTrialMarkers = [];
                    window.rcTimeTrialMarkers[index] = marker;
                }
                // è®°å½• bike_time_trial æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'bike_time_trial') {
                    if (!window.bikeTimeTrialMarkers) window.bikeTimeTrialMarkers = [];
                    window.bikeTimeTrialMarkers[index] = marker;
                }
                // è®°å½• signal_jammers æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'signal_jammers') {
                    if (!window.signalJammersMarkers) window.signalJammersMarkers = [];
                    window.signalJammersMarkers[index] = marker;
                }
                // è®°å½• jack_o_lanterns æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'jack_o_lanterns') {
                    if (!window.jackOLanternMarkers) window.jackOLanternMarkers = [];
                    window.jackOLanternMarkers[index] = marker;
                }
                // è®°å½• snowmen æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'snowmen') {
                    if (!window.snowmenMarkers) window.snowmenMarkers = [];
                    window.snowmenMarkers[index] = marker;
                }
                // è®°å½• yuanbao æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'yuanbao') {
                    if (!window.yuanbaoMarkers) window.yuanbaoMarkers = [];
                    window.yuanbaoMarkers[index] = marker;
                }
                // è®°å½• stunt_jumps æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'stunt_jumps') {
                    if (!window.stuntJumpsMarkers) window.stuntJumpsMarkers = [];
                    window.stuntJumpsMarkers[index] = marker;
                }
                // è®°å½• ppl æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ppl') {
                    if (!window.pplMarkers) window.pplMarkers = [];
                    window.pplMarkers[index] = marker;
                }
                // è®°å½• ppw æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ppw') {
                    if (!window.ppwMarkers) window.ppwMarkers = [];
                    window.ppwMarkers[index] = marker;
                }
                // è®°å½• spray æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'spray') {
                    if (!window.sprayMarkers) window.sprayMarkers = [];
                    window.sprayMarkers[index] = marker;
                }
                // è®°å½• for_sale_sign æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'for_sale_sign') {
                    if (!window.forSaleSignMarkers) window.forSaleSignMarkers = [];
                    window.forSaleSignMarkers[index] = marker;
                }
                // è®°å½• the_big_score_gauntlet æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'the_big_score_gauntlet') {
                    if (!window.theBigScoreGauntletMarkers) window.theBigScoreGauntletMarkers = [];
                    window.theBigScoreGauntletMarkers[index] = marker;
                }
                // è®°å½• hitchhikers æ ‡è®°ä»¥ä¾¿åç»­æ‰©å±•ï¼ˆå¯è§æ€§/è®¡æ•°å™¨ï¼‰
                else if (type === 'hitchhikers') {
                    if (!window.hitchhikersMarkers) window.hitchhikersMarkers = [];
                    window.hitchhikersMarkers[index] = marker;
                }
                // è®°å½• ghosts3 æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ghosts3') {
                    if (!window.ghosts3Markers) window.ghosts3Markers = [];
                    window.ghosts3Markers[index] = marker;
                }
                // è®°å½• ufo æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶
                else if (type === 'ufo') {
                    if (!window.ufoMarkers) window.ufoMarkers = [];
                    window.ufoMarkers[index] = marker;
                }
                // è®°å½• serial_killer_slasher æ ‡è®°ä»¥ä¾¿å¼¹çª—éšè—/æ˜¾ç¤ºæ§åˆ¶ï¼ˆå·²åœ¨createLeafletMarkerä¸­å¤„ç†ï¼‰
                // else if (type === 'serial_killer_slasher') {
                //     if (!window.slasherMarkers) window.slasherMarkers = [];
                //     window.slasherMarkers[index] = marker;
                // }
            } catch (e) {}
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            marker.on('click', function(e) {
                // ç‰¹æ®Šå¤„ç†drug_vehicleï¼Œä½¿ç”¨ä¸“é—¨çš„å¼¹çª—å‡½æ•°
                if (type === 'drug_vehicle') {
                    showDrugVehiclePopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†metal_detectorï¼Œä½¿ç”¨ä¸“é—¨çš„å¼¹çª—å‡½æ•°
                else if (type === 'metal_detector') {
                    showMetalDetectorPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†gun_vanï¼Œä½¿ç”¨ä¸“é—¨çš„æ­¦å™¨ä¿¡æ¯å¼¹çª—
                else if (type === 'gun_van') {
                    showGunVanWeapons();
                }
                // ç‰¹æ®Šå¤„ç†è¡—å¤´æ¯’è´©ï¼Œä½¿ç”¨ä¸“é—¨çš„ä¿¡æ¯å¼¹çª—
                else if (type === 'street_dealers') {
                    showStreetDealersPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†æœ‰æœºåŠäº§å“ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'ld_organics_products') {
                    showOrganicFarmImage(index);
                }
                // ç‰¹æ®Šå¤„ç†ä¿¡å·å¹²æ‰°å™¨ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'signal_jammers') {
                    showSignalJammerImage(index);
                }
                // ç‰¹æ®Šå¤„ç†çº¸ç‰Œï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'playing_cards') {
                    showPlayingCardsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ®‹ç¼ºä¿¡ä»¶ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'letter_scraps') {
                    showLetterScrapsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'sp_hidden_packages') {
                    showSpHiddenPackagesImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è¿·å¹»ä»™äººæŒé™†åœ°ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'peyote_sp_land') {
                    showPeyoteSpLandImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è¿·å¹»ä»™äººæŒé¸Ÿç±»ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'peyote_sp_air') {
                    showPeyoteSpAirImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è¿·å¹»ä»™äººæŒæ°´ä¸‹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'peyote_sp_water') {
                    showPeyoteSpWaterImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è¿·å¹»ä»™äººæŒé‡‘è‰²ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'peyote_sp_special') {
                    showPeyoteSpSpecialImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ½œæ°´è‰‡ç¢ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'submarine_pieces') {
                    showSubmarinePiecesImage(index);
                }
                // ç‰¹æ®Šå¤„ç†å®‡å®™é£èˆ¹éƒ¨ä»¶ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'spaceship_parts') {
                    showSpaceshipPartsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ ¸åºŸæ–™ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'nuclear_waste') {
                    showNuclearWasteImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ´›åœ£éƒ½çš„äººç±»ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'humans_of_ls') {
                    showHumansOfLsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†çŒ´å­é©¬èµ›å…‹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'monkey_mosaics') {
                    showMonkeyMosaicsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è°‹æ€ä¹‹è°œä¿¡æ¯ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'murder_mystery_message') {
                    showMurderMysteryMessageImage(index);
                }
                // ç‰¹æ®Šå¤„ç†åäº‘åé›¾é¦†äº§å“ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'smoke_on_the_water_product') {
                    showSmokeProductPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†æ‰‹åŠï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'action_figures') {
                    showActionFiguresImage(index);
                }
                // ç‰¹æ®Šå¤„ç†å…ƒå®ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'yuanbao') {
                    showYuanbaoImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ²‰èˆ¹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'shipwrecked') {
                    showShipwreckedPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†ç”µè¯æš—æ€ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'payphone_hits') {
                    showPayphoneHitsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†é«˜å°”å¤«çƒæ´ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'golf_holes') {
                    showGolfHolesImage(index);
                }
                // ç‰¹æ®Šå¤„ç†é›ªäººï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'snowmen') {
                    showSnowmenImage(index);
                }
                // ç‰¹æ®Šå¤„ç†æ°æ‹‰å¾·åŒ…è£¹ï¼Œæ˜¾ç¤ºå¢å¼ºç‰ˆå¼¹çª—
                else if (type === 'dead_drop') {
                    showDeadDropPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†ç‰¹æŠ€è·³è·ƒç‚¹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'stunt_jumps') {
                    showStuntJumpsImage(index);
                }
                // ç‰¹æ®Šå¤„ç†å–·ç½ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'spray') {
                    showSprayImage(index);
                }
                // ç‰¹æ®Šå¤„ç†å¸®æ´¾æ”»å‡»ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'gang_attacks') {
                    showGangAttackPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†å¹½çµæ›å…‰ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'ghosts3') {
                    showGhosts3Popup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†å¨æ³½å°”å¤§æ¥¼æªæˆ˜ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'wea') {
                    showWeaPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†é™†åœ°è¿·å¹»ä»™äººæŒï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'ppl') {
                    showPplPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†æ°´ä¸‹è¿·å¹»ä»™äººæŒï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'ppw') {
                    showPpwPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†å—ç“œç¯ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'jack_o_lanterns') {
                    showJackOLanternImage(index);
                }
                // ç‰¹æ®Šå¤„ç†RCæ—¶é—´æŒ‘æˆ˜èµ›ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'rc_time_trial') {
                    showRCTimeTrialImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'bike_time_trial') {
                    showBikeTimeTrialImage(index);
                }
                // ç‰¹æ®Šå¤„ç†è·³ä¼ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'skydives') {
                    showSkydivesImage(index);
                }
                // ç‰¹æ®Šå¤„ç†éšè—åŒ…è£¹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
                else if (type === 'hidden_caches') {
                    showHiddenCachesPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†LSæ¶‚é¸¦ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—ï¼ˆä¼ å…¥å¯¹è±¡ä»¥ä½¿ç”¨ sequenceNumberï¼‰
                else if (type === 'ls_tags') {
                    showLSTagsPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†å¾…å”®æ ‡å¿—ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'for_sale_sign') {
                    showForSaleSignPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†å¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰é“è…•
                else if (type === 'the_big_score_gauntlet') {
                    showTheBigScoreGauntletPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†æ­ä¾¿è½¦ï¼ˆæ½œåœ¨çš„åˆ©ä»–é‚ªæ•™å—å®³è€…ï¼‰
                else if (type === 'hitchhikers') {
                    showHitchhikersPopup(item, index);
                }
                // ç‰¹æ®Šå¤„ç†è½¦è¡Œæ ‡è®°ï¼Œä½¿ç”¨ä¸“é—¨çš„è½¦è¾†å±•ç¤ºå‡½æ•°
                else if (['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'].includes(type)) {
                    showDealershipVehicles(type, item.name);
                }
                // ç‰¹æ®Šå¤„ç†treasure_hunt_dba_revolverï¼ˆæŒ‰éšæœº/å›ºå®šå±•ç¤ºï¼‰
                else if (type === 'treasure_hunt_dba_revolver') {
                    const th = itemData.treasure_hunt_dba_revolver || { random_clue: [], static_clues: [] };
                    const rc = th.random_clue || [];
                    const sc = th.static_clues || [];
                    const fixedCount = sc.length;
                    // å°è¯•æ ¹æ®å°±è¿‘é›†åˆåˆ¤æ–­å­ç±»å‹ï¼ˆä¸ä¸¥æ ¼ï¼Œä½†è¶³å¤Ÿå±•ç¤ºï¼‰
                    if (index < rc.length) {
                        showTreasureHuntPopup(item, index, 'random');
                    } else {
                        showTreasureHuntPopup(item, index - rc.length, 'static');
                    }
                }
                // ç‰¹æ®Šå¤„ç†serial_killer_slasherï¼ˆæŒ‰first/lastå±•ç¤ºï¼‰
                else if (type === 'serial_killer_slasher') {
                    const first = itemData.serial_killer_slasher?.first?.length || 0;
                    if (index < first) {
                        showSlasherPopup(item, index, 'first');
                    } else {
                        showSlasherPopup(item, index - first, 'last');
                    }
                }
                // ç”µå½±é“å…·å¼¹çª—
                else if (type === 'movie_props') {
                    // ä¼˜å…ˆä½¿ç”¨æ•°æ®é‡Œçš„å­ç±»å‹
                    let subtype = item && item.type ? item.type : undefined;
                    if (!subtype) {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        const fixedCount = mp.fixed_position?.length || 0;
                        const ponyCount = mp.vehicles?.pony?.length || 0;
                        const rebelCount = mp.vehicles?.rebel?.length || 0;
                        if (index < fixedCount) subtype = 'fixed_position';
                        else if (index < fixedCount + ponyCount) subtype = 'pony';
                        else if (index < fixedCount + ponyCount + rebelCount) subtype = 'rebel';
                        else subtype = 'rumpo';
                    }
                    showMoviePropsPopup(item, index, subtype);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†çŠ¯ç½ªç°åœºï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'crime_scenes') {
                    console.log('ç‚¹å‡»çŠ¯ç½ªç°åœºæ ‡è®°:', item, index);
                    showCrimeScenesPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†è—åŒ¿å±‹ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'stash_houses') {
                    showStashHousesPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†ç›å¾·æ‹‰ç´¢é›‡å‡¶ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'madrazo_hits') {
                    showMadrazoHitsPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†å¸•ç‰¹é‡Œå…‹æ•‘æ´ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'police_rescue_patrick_mcreary') {
                    console.log('ç‚¹å‡»å¸•ç‰¹é‡Œå…‹æ•‘æ´æ ‡è®°:', item, index, item.subtype);
                    showPatrickRescuePopup(item, index, item.subtype || 'spawn');
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†éšæœºä»»åŠ¡ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'random_missions') {
                    console.log('ç‚¹å‡»éšæœºä»»åŠ¡æ ‡è®°:', item, index, item.timeSlot, item.missionIndex);
                    showRandomMissionPopup([item.x, item.y], item.timeSlot, item.missionIndex);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†æ²‰ç¡çš„ä¿å®‰ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'drunk_guard') {
                    showDrunkGuardPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†ç¤¾åŒºè¾¹ç•Œï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'community_outreach') {
                    showCommunityOutreachPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†å•†åº—æŠ¢åŠ«ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'store_robbery') {
                    showStoreRobberyPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†è£…ç”²è¿é’è½¦ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'armored_truck') {
                    showArmoredTruckPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†åª’ä½“è®°å¿†æ£’ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'media_sticks') {
                    showMediaStickPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†æœ›è¿œé•œï¼Œä½¿ç”¨é€šç”¨å¼¹çª—
                else if (type === 'v_telescopes') {
                    showNewItemPopup(type, item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†UFOè§‚å…‰ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'ufo') {
                    showUfoPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†ä¸‡åœ£èŠ‚åœ°ç‹±çŠ¬äº‹ä»¶ï¼Œæ˜¾ç¤ºå¼¹çª—
                else if (type === 'cerberus') {
                    console.log('ç‚¹å‡»ä¸‡åœ£èŠ‚åœ°ç‹±çŠ¬äº‹ä»¶æ ‡è®°:', item, index);
                    showCerberusPopup(item, index);
                }
                // æ–°å¢ï¼šç‰¹æ®Šå¤„ç†åœ°ç‚¹ä¸æœåŠ¡ç±»å‹ï¼Œä½¿ç”¨é€šç”¨å¼¹çª—
                else if (['metro', 'police', 'fire_stations', 'hospitals', 'clothing', 'tattoos', 'barbers', 'ammunation', 'mod_shop', 'car_wash', 'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'].includes(type)) {
                    showNewItemPopup(type, item, index);
                }
                else {
                    showItemInfo(item, type, index);
                }
            });
            
            return marker;
        }

        // æ¸…é™¤æ‰€æœ‰Leafletæ ‡è®°
        function clearLeafletMarkers() {
            leafletMarkers.forEach(marker => {
                // å¤„ç†å¤åˆæ ‡è®°çš„ç‰¹æ®Šæƒ…å†µï¼ˆåŒ…å«circleå’Œiconï¼‰
                // é€‚ç”¨äºï¼šhalloween_slashers, possessed_animals, yeti, gang_attacks, cerberusç­‰
                if (marker.circle && marker.icon) {
                    map.removeLayer(marker.circle);
                    map.removeLayer(marker.icon);
                } else if (marker.circle && !marker.icon) {
                    // å¤„ç†åªæœ‰åœ†åœˆçš„æ ‡è®°ï¼ˆå¦‚yetiçš„areaç±»å‹ï¼‰
                    map.removeLayer(marker.circle);
                } else if (marker.removeFrom && typeof marker.removeFrom === 'function') {
                    // å¤„ç†æœ‰è‡ªå®šä¹‰removeFromæ–¹æ³•çš„æ ‡è®°
                    marker.removeFrom(map);
                } else {
                    // å¤„ç†æ™®é€šæ ‡è®°
                    map.removeLayer(marker);
                }
            });
            leafletMarkers = [];
            
            // æ¸…ç©ºç‰¹æ®Šæ ‡è®°å­˜å‚¨æ•°ç»„ï¼ˆä½†ä¸æ¸…é™¤æœ‰è®¡æ•°å™¨çš„æ ‡è®°ï¼‰
            // æœ‰è®¡æ•°å™¨çš„æ ‡è®°éœ€è¦ä¿æŒçŠ¶æ€ï¼Œä¸æ¸…é™¤ï¼š
            // - streetDealersMarkers (è¡—å¤´æ¯’è´©)
            // - playingCardsMarkers (çº¸ç‰Œ)
            // - letterScrapsMarkers (æ®‹ç¼ºä¿¡ä»¶)
            // - yuanbaoMarkers (å…ƒå®)
            // - pplMarkers (é™†åœ°è¿·å¹»ä»™äººæŒ)
            // - ppwMarkers (æ°´ä¸‹è¿·å¹»ä»™äººæŒ)
            // - assumingTheTruthMarkers (åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·)
            // - chasingTheTruthMarkers (åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨)
            
            if (window.gunVanMarkers) {
                window.gunVanMarkers = [];
            }
            if (window.shipwreckedMarkers) {
                window.shipwreckedMarkers = [];
            }
            if (window.rcTimeTrialMarkers) {
                window.rcTimeTrialMarkers = [];
            }
            if (window.bikeTimeTrialMarkers) {
                window.bikeTimeTrialMarkers = [];
            }
            if (window.actionFiguresMarkers) {
                window.actionFiguresMarkers = [];
            }
            if (window.signalJammersMarkers) {
                window.signalJammersMarkers = [];
            }
            if (window.organicFarmMarkers) {
                window.organicFarmMarkers = [];
            }
            if (window.forSaleSignMarkers) {
                window.forSaleSignMarkers = [];
            }
            if (window.theBigScoreGauntletMarkers) {
                window.theBigScoreGauntletMarkers = [];
            }
            if (window.hitchhikersMarkers) {
                window.hitchhikersMarkers = [];
            }
            // ä¸æ¸…é™¤ç‰¹æŠ€è·³è·ƒç‚¹æ ‡è®°ï¼Œä¿æŒå…¶çŠ¶æ€
            // if (window.stuntJumpsMarkers) {
            //     window.stuntJumpsMarkers = [];
            // }
        }
        
        // æ›´æ–°Leafletæ ‡è®°çš„åŠå¾„ï¼ˆå“åº”åœ°å›¾ç¼©æ”¾ï¼‰
        function updateLeafletMarkersRadius() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const gameWidth = GAME_RIGHT - GAME_LEFT;
            
            leafletMarkers.forEach(marker => {
                if (marker.circle && marker.item) {
                    let newRadius;
                    
                    // æ ¹æ®æ ‡è®°ç±»å‹è®¡ç®—æ–°åŠå¾„
                    if (marker.type === 'gang_attacks') {
                        // å¸®æ´¾æ”»å‡»ï¼šå›ºå®š100æ¸¸æˆå•ä½
                        newRadius = (100 / gameWidth) * totalWidth;
                    } else if (marker.item.radius) {
                        // å…¶ä»–æœ‰radiuså±æ€§çš„æ ‡è®°ï¼ˆå¦‚possessed_animals, yetiç­‰ï¼‰
                        newRadius = (marker.item.radius / gameWidth) * totalWidth;
                    }
                    
                    if (newRadius !== undefined) {
                        marker.circle.setRadius(newRadius);
                    }
                }
            });
        }
        
        // è·å–æ€äººç‹‚é¢œè‰²é…ç½®
        function getSlasherColor(slasherType) {
            switch(slasherType) {
                case 'clown':
                    return {
                        border: '#FF9800', // æ©™è‰²
                        fill: '#FFE0B2'
                    };
                case 'psycho':
                    return {
                        border: '#F44336', // çº¢è‰²
                        fill: '#FFCDD2'
                    };
                case 'driver':
                    return {
                        border: '#9C27B0', // ç´«è‰²
                        fill: '#E1BEE7'
                    };
                case 'sackslasher':
                    return {
                        border: '#607D8B', // è“ç°è‰²
                        fill: '#CFD8DC'
                    };
                default:
                    return {
                        border: '#795548', // æ£•è‰²
                        fill: '#D7CCC8'
                    };
            }
        }
        
        // è·å–é¬¼ä¸Šèº«åŠ¨ç‰©é¢œè‰²é…ç½®
        function getPossessedAnimalColor(animalType) {
            switch(animalType) {
                case 'boar':
                    return {
                        border: '#8D6E63', // æ£•è‰²
                        fill: '#D7CCC8'
                    };
                case 'cougar':
                    return {
                        border: '#FF5722', // æ©™çº¢è‰²
                        fill: '#FFCCBC'
                    };
                case 'coyote':
                    return {
                        border: '#795548', // æ·±æ£•è‰²
                        fill: '#D7CCC8'
                    };
                case 'deer':
                    return {
                        border: '#4CAF50', // ç»¿è‰²
                        fill: '#C8E6C9'
                    };
                case 'pug':
                    return {
                        border: '#9C27B0', // ç´«è‰²
                        fill: '#E1BEE7'
                    };
                default:
                    return {
                        border: '#607D8B', // è“ç°è‰²
                        fill: '#CFD8DC'
                    };
            }
        }
        

        // DOM æ ‡è®°åˆ›å»ºå‡½æ•°å·²åºŸå¼ƒ

        // æ›´æ–°ç‰©å“æ ‡è®°ä½ç½®
        function updateItemMarkers() {
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // ä»…æ¸…é™¤ç°æœ‰ Leaflet æ ‡è®°ï¼ˆDOM æ ‡è®°å·²åºŸå¼ƒï¼‰
            clearLeafletMarkers();

            // å¤„ç†è¯•ç‚¹æ ‡è®°ç±»å‹ï¼ˆä½¿ç”¨LeafletåŸç”Ÿæ ‡è®°ï¼‰
            activeItemTypes.forEach(type => {
                if (pilotMarkerTypes.has(type)) {
                    // ç‰¹æ®Šå¤„ç†media_sticks
                    if (type === 'media_sticks') {
                        const mediaSticks = itemData.media_sticks || [];
                        mediaSticks.forEach((stick, index) => {
                            if (typeof stick.x === 'undefined' || typeof stick.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(stick, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†police_rescue_patrick_mcreary
                    else if (type === 'police_rescue_patrick_mcreary') {
                        const patrickData = itemData.police_rescue_patrick_mcreary;
                        
                        // å¤„ç†spawnç‚¹
                        if (patrickData && patrickData.spawn) {
                            patrickData.spawn.forEach((spawn, index) => {
                                if (typeof spawn.x === 'undefined' || typeof spawn.y === 'undefined') return;
                                
                                const spawnItem = { ...spawn, subtype: 'spawn' };
                                const marker = createLeafletMarker(spawnItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                        
                        // å¤„ç†dropoffç‚¹
                        if (patrickData && patrickData.dropoff) {
                            patrickData.dropoff.forEach((dropoff, index) => {
                                if (typeof dropoff.x === 'undefined' || typeof dropoff.y === 'undefined') return;
                                
                                const dropoffItem = { ...dropoff, subtype: 'dropoff' };
                                const marker = createLeafletMarker(dropoffItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // ç‰¹æ®Šå¤„ç†convoy - è½¦é˜Ÿæ ‡è®°
                    else if (type === 'convoy') {
                        const convoyData = itemData.convoy || [];
                        convoyData.forEach((group, index) => {
                            const tp = group.triggerpoint;
                            if (Array.isArray(tp) && tp.length >= 2) {
                                const convoyItem = {
                                    x: tp[0],
                                    y: tp[1],
                                    ...group
                                };
                                const marker = createLeafletMarker(convoyItem, index, type);
                                leafletMarkers.push(marker);
                                
                                // åˆ›å»ºè½¦é˜Ÿè·¯çº¿ï¼ˆä½¿ç”¨Leafletçš„Polylineï¼‰
                                if (group.routes && Array.isArray(group.routes)) {
                                    group.routes.forEach((route, routeIndex) => {
                                        if (Array.isArray(route) && route.length > 1) {
                                            const routePoints = route.map(point => {
                                                if (Array.isArray(point) && point.length === 2) {
                                                    const pixel = gameToPixel(point[0], point[1], map.getZoom());
                                                    return map.unproject(L.point(pixel.x, pixel.y), map.getZoom());
                                                }
                                                return null;
                                            }).filter(point => point !== null);
                                            
                                            if (routePoints.length > 1) {
                                                const polyline = L.polyline(routePoints, {
                                                    color: 'red',
                                                    weight: 3,
                                                    opacity: 0.8,
                                                    zIndexOffset: 650
                                                }).addTo(map);
                                                leafletMarkers.push(polyline);
                                            }
                                        }
                                    });
                                }
                            }
                        });
                        
                        // åŒæ—¶æ˜¾ç¤ºè½¦é˜Ÿç»ˆç‚¹
                        const convoyFinalData = itemData.convoy_final || [];
                        convoyFinalData.forEach((finalPoint, index) => {
                            if (typeof finalPoint.x !== 'undefined' && typeof finalPoint.y !== 'undefined') {
                                const marker = createLeafletMarker(finalPoint, index, 'convoy_final');
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†convoy_final - è½¦é˜Ÿç»ˆç‚¹æ ‡è®°ï¼ˆå•ç‹¬é€‰æ‹©æ—¶ï¼‰
                    else if (type === 'convoy_final') {
                        const convoyFinalData = itemData.convoy_final || [];
                        convoyFinalData.forEach((finalPoint, index) => {
                            if (typeof finalPoint.x !== 'undefined' && typeof finalPoint.y !== 'undefined') {
                                const marker = createLeafletMarker(finalPoint, index, type);
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†random_missions - éšæœºä»»åŠ¡
                    else if (type === 'random_missions') {
                        console.log('å¤„ç†éšæœºä»»åŠ¡æ ‡è®°ï¼Œæ•°æ®:', itemData.random_missions);
                        const randomMissions = itemData.random_missions || {};
                        let globalIndex = 0;
                        
                        Object.keys(randomMissions).forEach(timeSlot => {
                            const missions = randomMissions[timeSlot] || [];
                            console.log(`æ—¶é—´æ®µ ${timeSlot} æœ‰ ${missions.length} ä¸ªä»»åŠ¡`);
                            missions.forEach((mission, index) => {
                                // å¤„ç†ä¸åŒçš„æ•°æ®æ ¼å¼
                                let missionItem;
                                if (Array.isArray(mission) && mission.length >= 2) {
                                    // [x, y] æ•°ç»„æ ¼å¼
                                    missionItem = { 
                                        x: mission[0], 
                                        y: mission[1],
                                        timeSlot: timeSlot,
                                        missionIndex: index
                                    };
                                } else if (typeof mission === 'object' && mission.x !== undefined && mission.y !== undefined) {
                                    // {x, y} å¯¹è±¡æ ¼å¼
                                    missionItem = { 
                                        ...mission,
                                        timeSlot: timeSlot,
                                        missionIndex: index
                                    };
                                } else {
                                    console.log('è·³è¿‡æ— æ•ˆçš„éšæœºä»»åŠ¡æ•°æ®:', mission);
                                    return;
                                }
                                
                                console.log(`åˆ›å»ºéšæœºä»»åŠ¡æ ‡è®° ${globalIndex}:`, missionItem);
                                const marker = createLeafletMarker(missionItem, globalIndex, type);
                                leafletMarkers.push(marker);
                                globalIndex++;
                            });
                        });
                        console.log(`æ€»å…±åˆ›å»ºäº† ${globalIndex} ä¸ªéšæœºä»»åŠ¡æ ‡è®°`);
                    }
                    // ç‰¹æ®Šå¤„ç†èµ°ç§æ ‡è®°ï¼ˆæœ‰å¤æ‚çš„è·¯çº¿å’Œè¿æ¥çº¿ï¼‰
                    else if (type === 'smuggler_plane' || type === 'smuggler_trail') {
                        createSmugglerLeafletMarkers(type);
                    }
                    // ç‰¹æ®Šå¤„ç†è½¦è¡Œæ ‡è®°ï¼ˆcasino, car_meet, premium_deluxe_motorsport, luxury_autosï¼‰
                    else if (['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'].includes(type)) {
                        const dealership = dealershipData[type];
                        if (dealership && dealership.coordinates) {
                            dealership.coordinates.forEach((coord, index) => {
                                const item = {
                                    x: coord[0],
                                    y: coord[1],
                                    name: dealership.name,
                                    icon: dealership.icon
                                };
                                
                                const marker = createLeafletMarker(item, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // ç‰¹æ®Šå¤„ç†exotic_exports1 - å¤–è´¸å‡ºå£è½½å…·1
                    else if (type === 'exotic_exports1') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†exotic_exports2 - å¤–è´¸å‡ºå£è½½å…·2
                    else if (type === 'exotic_exports2') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†happy_holidays_hauler - èŠ‚æ—¥å¿«ä¹å¡è½¦ï¼ˆtriggerpoint + routesï¼‰
                    else if (type === 'happy_holidays_hauler') {
                        const groups = itemData.happy_holidays_hauler || [];
                        groups.forEach((group, index) => {
                            const tp = group.triggerpoint; // [x, y]
                            const routes = Array.isArray(group.routes) ? group.routes : [];
                            
                            if (Array.isArray(tp) && tp.length >= 2) {
                                // åˆ›å»ºtriggerpointæ ‡è®°
                                const item = {
                                    x: tp[0],
                                    y: tp[1],
                                    ...group
                                };
                                
                                const marker = createLeafletMarker(item, index, type);
                                leafletMarkers.push(marker);
                                
                                // åˆ›å»ºè·¯çº¿è¿æ¥çº¿ï¼ˆä½¿ç”¨Leafletçš„Polylineï¼‰
                                routes.forEach((route, routeIndex) => {
                                    if (Array.isArray(route) && route.length > 0) {
                                        // åˆ›å»ºè·¯çº¿ç‚¹æ•°ç»„ï¼Œä»triggerpointå¼€å§‹
                                        const z = map.getZoom();
                                        const routeLatLngs = [];
                                        
                                        // æ·»åŠ triggerpoint
                                        const tpPixel = gameToPixel(tp[0], tp[1], z);
                                        const tpLatLng = map.unproject(L.point(tpPixel.x, tpPixel.y), z);
                                        routeLatLngs.push(tpLatLng);
                                        
                                        // æ·»åŠ è·¯çº¿ç‚¹
                                        route.forEach(point => {
                                            if (Array.isArray(point) && point.length >= 2) {
                                                const pointPixel = gameToPixel(point[0], point[1], z);
                                                const pointLatLng = map.unproject(L.point(pointPixel.x, pointPixel.y), z);
                                                routeLatLngs.push(pointLatLng);
                                            }
                                        });
                                        
                                        // åˆ›å»ºLeaflet Polyline
                                        if (routeLatLngs.length > 1) {
                                            const polyline = L.polyline(routeLatLngs, {
                                                color: '#2196F3',
                                                weight: 3,
                                                opacity: 0.8
                                            }).addTo(map);
                                            
                                            leafletMarkers.push(polyline);
                                        }
                                    }
                                });
                            }
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†wea - å¨æ³½å°”å¤§æ¥¼æªæˆ˜
                    else if (type === 'wea') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†halloween_slashers - ä¸‡åœ£èŠ‚æ€äººç‹‚åœ†å½¢åŒºåŸŸ
                    else if (type === 'halloween_slashers') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined' || typeof item.radius === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†gang_attacks - å¸®æ´¾æ”»å‡»åœ†å½¢åŒºåŸŸ
                    else if (type === 'gang_attacks') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            if (marker) { // åªæœ‰åœ¨æ—¶é—´èŒƒå›´å†…æ‰ä¼šè¿”å›marker
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†ghosts3 - å¹½çµæ›å…‰
                    else if (type === 'ghosts3') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†cerberus - åœ°ç‹±çŠ¬ï¼ˆåªæ˜¾ç¤ºå›¾æ ‡ï¼‰
                    else if (type === 'cerberus') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†possessed_animals - é¬¼ä¸Šèº«åŠ¨ç‰©åœ†å½¢åŒºåŸŸ
                    else if (type === 'possessed_animals') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined' || typeof item.radius === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†yeti - é›ªæ€ªï¼ˆåœ†å½¢åŒºåŸŸå’Œçº¿ç´¢ç‚¹ï¼‰
                    else if (type === 'yeti') {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            if (marker) { // yetiå¯èƒ½è¿”å›nullï¼ˆå¦‚æœç±»å‹ä¸åŒ¹é…ï¼‰
                                leafletMarkers.push(marker);
                            }
                        });
                    }
                    // ç‰¹æ®Šå¤„ç†maude_bounty_targets - èŒ‰å¾·æ‚¬èµç›®æ ‡
                    else if (type === 'maude_bounty_targets') {
                        const maudeData = itemData.maude_bounty_targets;
                        
                        // å¤„ç†æ‚¬èµåŒºåŸŸ
                        if (maudeData && maudeData.areas) {
                            maudeData.areas.forEach((area, index) => {
                                if (typeof area.x === 'undefined' || typeof area.y === 'undefined') return;
                                
                                const areaItem = { ...area, subtype: 'area' };
                                const marker = createLeafletMarker(areaItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                        
                        // å¤„ç†æ‚¬èµç»ˆç‚¹
                        if (maudeData && maudeData.endpoints) {
                            maudeData.endpoints.forEach((endpoint, index) => {
                                if (typeof endpoint.x === 'undefined' || typeof endpoint.y === 'undefined') return;
                                
                                const endpointItem = { ...endpoint, subtype: 'endpoint' };
                                const marker = createLeafletMarker(endpointItem, index, type);
                                leafletMarkers.push(marker);
                            });
                        }
                    }
                    // ç‰¹æ®Šï¼šå·¦è½®å¯»å®ä¸¤ä¸ªå­ç±»å‹åˆ†åˆ«æ¸²æŸ“ï¼ˆLeafletï¼‰
                    else if (type === 'treasure_hunt_dba_revolver') {
                        const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
                        const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
                        
                        // åˆå§‹åŒ–æ ‡è®°å­˜å‚¨
                        if (!window.treasureHuntTh1Markers) window.treasureHuntTh1Markers = [];
                        if (!window.treasureHuntTh2Markers) window.treasureHuntTh2Markers = [];
                        
                        rc.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'random' }, i, 'treasure_hunt_dba_revolver');
                            leafletMarkers.push(marker);
                            // å­˜å‚¨th1æ ‡è®°
                            window.treasureHuntTh1Markers[i] = marker;
                        });
                        sc.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'static' }, i, 'treasure_hunt_dba_revolver');
                            leafletMarkers.push(marker);
                            // å­˜å‚¨th2æ ‡è®°
                            window.treasureHuntTh2Markers[i] = marker;
                        });
                    }
                    // ç‰¹æ®Šï¼šæ´›åœ£éƒ½æ€äººç‹‚ï¼ˆfirst/last åˆå¹¶ä¸ºä¸€ä¸ªé€‰é¡¹ï¼‰
                    else if (type === 'serial_killer_slasher') {
                        const first = itemData.serial_killer_slasher?.first || [];
                        const last = itemData.serial_killer_slasher?.last || [];
                        first.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker({ ...p, subtype: 'first' }, i, 'serial_killer_slasher');
                            leafletMarkers.push(marker);
                        });
                        last.forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const globalIndex = first.length + i; // ä½¿ç”¨å…¨å±€ç´¢å¼•
                            const marker = createLeafletMarker({ ...p, subtype: 'last' }, globalIndex, 'serial_killer_slasher');
                            leafletMarkers.push(marker);
                        });
                    }
                    // ç‰¹æ®Šï¼šç”µå½±é“å…·ï¼ˆå¤šä¸ªå­ç»„ï¼‰
                    else if (type === 'movie_props') {
                        const mp = itemData.movie_props || { fixed_position: [], vehicles: { pony: [], rebel: [], rumpo: [] } };
                        let globalIndex = 0;
                        
                        (mp.fixed_position || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.pony || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.rebel || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                        (mp.vehicles?.rumpo || []).forEach((p, i) => {
                            if (typeof p.x === 'undefined' || typeof p.y === 'undefined') return;
                            const marker = createLeafletMarker(p, globalIndex, 'movie_props');
                            leafletMarkers.push(marker);
                            globalIndex++;
                        });
                    }
                    // å…¶ä»–ç®€å•æ•°ç»„ç±»å‹ç»Ÿä¸€å¤„ç†
                    else if (['crime_scenes', 'ufo', 'community_outreach', 'store_robbery', 'ppl', 'ppw'].includes(type)) {
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    } else {
                        // æ™®é€šæ ‡è®°å¤„ç†
                        if (!itemData[type] || !Array.isArray(itemData[type])) return;
                        
                        itemData[type].forEach((item, index) => {
                            if (typeof item.x === 'undefined' || typeof item.y === 'undefined') return;
                            
                            const marker = createLeafletMarker(item, index, type);
                            leafletMarkers.push(marker);
                        });
                    }
                }
            });

            // DOM æ ‡è®°æ¸²æŸ“å·²åºŸå¼ƒï¼Œæ‰€æœ‰ç±»å‹å‡ç”± Leaflet æ ‡è®°ç³»ç»Ÿå¤„ç†

            // é‡æ–°åº”ç”¨éšè—å¯è§æ€§ç¼“å­˜ï¼Œç¡®ä¿è¢«éšè—çš„æ ‡è®°åœ¨åˆ‡æ¢æ˜¾ç¤ºåä»ä¿æŒçŠ¶æ€
            try { applySmugglerPlaneVisibilityCache(); } catch (e) {}
            try { applyStreetDealersVisibilityCache(); } catch (e) {}
            try { applySubmarinePiecesVisibilityCache(); } catch (e) {}
            try { applyNuclearWasteVisibilityCache(); } catch (e) {}
            try { applySlasherVisibilityCache(); } catch (e) {}
            try { applyTreasureHuntVisibilityCache(); } catch (e) {}
            try { applyUfoVisibilityCache(); } catch (e) {}
            try { applyGhosts3VisibilityCache(); } catch (e) {}
            try { applySnowmenVisibilityCache(); } catch (e) {}
            try { applyMediaStickVisibilityCache(); } catch (e) {}
            try { applyMoviePropsVisibilityCache(); } catch (e) {}
            try { applySprayVisibilityCache(); } catch (e) {}
            try { applyPplVisibilityCache(); } catch (e) {}
            try { applyPpwVisibilityCache(); } catch (e) {}
            // è¡¥å……åº”ç”¨å¯è§æ€§ç¼“å­˜ï¼šæ´›åœ£éƒ½çš„äººç±» ä¸ çŒ´å­é©¬èµ›å…‹
            // è§£å†³é—®é¢˜ï¼šå–æ¶ˆé€‰ä¸­åå†æ¬¡å‹¾é€‰ï¼Œè¿™ä¸¤ç±»æ ‡è®°å…ˆå‰çš„éšè—çŠ¶æ€ä¼šä¸¢å¤±ï¼Œå¯¼è‡´é‡æ–°æ˜¾ç¤ºä¸”è®¡æ•°å™¨ä¸åŒæ­¥
            try { applyHumansOfLsVisibilityCache(); } catch (e) {}
            try { applyMonkeyMosaicsVisibilityCache(); } catch (e) {}
            try { applyStuntJumpsVisibilityCache(); } catch (e) {}
            try { applyYuanbaoVisibilityCache(); } catch (e) {}
            try { applySignalJammersVisibilityCache(); } catch (e) {}
            try { applyActionFiguresVisibilityCache(); } catch (e) {}
            try { applyPlayingCardsVisibilityCache(); } catch (e) {}
            try { applyLetterScrapsVisibilityCache(); } catch (e) {}
            try { applySpaceshipPartsVisibilityCache(); } catch (e) {}
            try { applyOrganicFarmVisibilityCache(); } catch (e) {}
            try { applySkydivesVisibilityCache(); } catch (e) {}
            try { applyJackOLanternsVisibilityCache(); } catch (e) {}
            try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
            try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
            try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
            try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
            try { applyHitchhikersVisibilityCache(); } catch (e) {}
            try { applyRCTimeTrialVisibilityCache(); } catch (e) {}
            try { applyBikeTimeTrialVisibilityCache(); } catch (e) {}
            try { applyMadrazoHitsVisibilityCache(); } catch (e) {}
            try { applyStashHousesVisibilityCache(); } catch (e) {}
            try { applyLSTagsVisibilityCache(); } catch (e) {}
            try { applyShipwreckedVisibilityCache(); } catch (e) {}
            try { applyHiddenCachesVisibilityCache(); } catch (e) {}
            try { applySmokeProductVisibilityCache(); } catch (e) {}
            try { applyDeadDropVisibilityCache(); } catch (e) {}
            try { applyMurderMysteryMessageVisibilityCache(); } catch (e) {}
            try { applyAssumingTheTruthVisibilityCache(); } catch (e) {}
            try { applyChasingTheTruthVisibilityCache(); } catch (e) {}
            try { applyEpsilonTractsVisibilityCache(); } catch (e) {}
            try { applyForSaleSignVisibilityCache(); } catch (e) {}
            try { applyTheBigScoreGauntletVisibilityCache(); } catch (e) {}

            // ç‰¹æ®Šï¼šå·¦è½®å¯»å®ä¸¤ä¸ªå­ç±»å‹åˆ†åˆ«æ¸²æŸ“ï¼ˆDOMç‰ˆä¿ç•™å…¼å®¹ï¼Œè‹¥Leafletå·²å¤„ç†åˆ™è·³è¿‡ï¼‰
            if (false && activeItemTypes.has('treasure_hunt_dba_revolver') && !pilotMarkerTypes.has('treasure_hunt_dba_revolver')) {
                const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
                const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
                const renderList = [
                    ...rc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_random', __index: i })),
                    ...sc.map((p, i) => ({ ...p, __subtype: 'treasure_hunt_dba_revolver_static', __index: i }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // ç‰¹æ®Šï¼šæ´›åœ£éƒ½æ€äººç‹‚ä¸¤ä¸ªå­ç±»å‹ä¸€èµ·æ¸²æŸ“ï¼ˆDOMå…¼å®¹ï¼ŒLeafletå·²å¤„ç†åˆ™è·³è¿‡ï¼‰
            if (false && activeItemTypes.has('serial_killer_slasher') && !pilotMarkerTypes.has('serial_killer_slasher')) {
                const first = (itemData.serial_killer_slasher.first || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_first', __index:i }));
                const last = (itemData.serial_killer_slasher.last || []).map((p,i)=>({ ...p, __subtype:'serial_killer_slasher_last', __index:i }));
                const renderList = [...first, ...last];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // æ³¨æ„ï¼šä¸‡åœ£èŠ‚æ€äººç‹‚ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿæ¸²æŸ“ï¼Œä¸å†éœ€è¦DOMæ¸²æŸ“

            // æ³¨æ„ï¼šé¬¼ä¸Šèº«åŠ¨ç‰©ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿæ¸²æŸ“ï¼Œä¸å†éœ€è¦DOMæ¸²æŸ“

            // æ³¨æ„ï¼šåœ°ç‹±çŠ¬ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿæ¸²æŸ“ï¼Œä¸å†éœ€è¦DOMæ¸²æŸ“

            // æ³¨æ„ï¼šé›ªæ€ªç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿæ¸²æŸ“ï¼Œä¸å†éœ€è¦DOMæ¸²æŸ“


            // ç‰¹æ®Šï¼šç”µå½±é“å…·å¤šä¸ªå­ç±»å‹åˆ†åˆ«æ¸²æŸ“ï¼ˆDOMå…¼å®¹ï¼ŒLeafletå·²å¤„ç†åˆ™è·³è¿‡ï¼‰
            if (false && activeItemTypes.has('movie_props') && !pilotMarkerTypes.has('movie_props')) {
                const mp = itemData.movie_props;
                const renderList = [
                    ...(mp.fixed_position || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i })),
                    ...(mp.vehicles?.pony || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) })),
                    ...(mp.vehicles?.rebel || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) })),
                    ...(mp.vehicles?.rumpo || []).map((p, i) => ({ ...p, __subtype: 'movie_props', __index: i + (mp.fixed_position?.length || 0) + (mp.vehicles?.pony?.length || 0) + (mp.vehicles?.rebel?.length || 0) }))
                ];
                renderList.forEach(it => {
                    if (typeof it.x === 'undefined' || typeof it.y === 'undefined') return;
                    const percentX = (it.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                    const percentY = (GAME_TOP - it.y) / (GAME_TOP - GAME_BOTTOM);
                    const itemX = percentX * totalWidth;
                    const itemY = percentY * totalHeight;
                    const markerEl = createItemMarker(it, it.__index, it.__subtype);
                    if (markerEl) {
                        markerEl.style.left = `${itemX}px`;
                        markerEl.style.top = `${itemY}px`;
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: it.__subtype, index: it.__index, el: markerEl });
                    }
                });
            }

            // æ³¨æ„ï¼šèŒ‰å¾·æ‚¬èµç›®æ ‡ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿæ¸²æŸ“ï¼Œä¸å†éœ€è¦DOMæ¸²æŸ“


            // ç‰¹æ®Šï¼šèµ°ç§è´©é£æœºæ¸²æŸ“ï¼ˆå·²è¿ç§»åˆ°Leafletç³»ç»Ÿï¼‰
            if (false && activeItemTypes.has('smuggler_plane') && !pilotMarkerTypes.has('smuggler_plane')) {
                const groups = itemData.smuggler_plane || [];
                groups.forEach((group, gIndex) => {
                    const tp = group.triggerpoint; // [x, y]
                    const routes = Array.isArray(group.routes) ? group.routes : [];
                    if (Array.isArray(tp) && tp.length === 2) {
                        const percentX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        const marker = document.createElement('div');
                        marker.className = 'item-marker smuggler-triggerpoint-marker';
                        marker.dataset.type = 'smuggler_plane';
                        marker.dataset.index = String(gIndex);
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        const img = document.createElement('img');
                        img.src = '../src/assets/smuggler_plane.svg';
                        img.style.width = '28px';
                        img.style.height = '28px';
                        marker.appendChild(img);
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSmugglerPlanePopup(group, gIndex);
                        });
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: 'smuggler_plane', index: gIndex, el: marker });
                    }
                    // routes: array of arrays of [x,y]; draw marker at each and a red line from triggerpoint
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const percentX = (rx - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const percentY = (GAME_TOP - ry) / (GAME_TOP - GAME_BOTTOM);
                            const itemX = percentX * totalWidth;
                            const itemY = percentY * totalHeight;
                            const marker = document.createElement('div');
                            marker.className = 'item-marker smuggler-route-marker';
                            marker.dataset.type = 'smuggler_plane_route';
                            marker.dataset.index = String(gIndex);
                            marker.dataset.routeIndex = String(rIndex);
                            marker.style.position = 'absolute';
                            marker.style.left = `${itemX}px`;
                            marker.style.top = `${itemY}px`;
                            marker.style.transform = 'translate(-50%, -50%)';
                            marker.style.cursor = 'pointer';
                            marker.style.zIndex = '670';
                            const img = document.createElement('img');
                            img.src = '../src/assets/smuggler_plane2.svg';
                            img.style.width = '28px';
                            img.style.height = '28px';
                            marker.appendChild(img);
                            marker.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSmugglerPlanePopup(group, gIndex);
                            });
                            // DOM æ ‡è®°å±‚å·²ç§»é™¤
                            itemMarkers.push({ type: 'smuggler_plane_route', index: gIndex, el: marker });

                            // çº¢çº¿ï¼šç”¨ div ç»˜åˆ¶ä¸€æ¡è¿æ¥ tp ä¸ route ç‚¹çš„çº¿
                            if (Array.isArray(tp) && tp.length === 2) {
                                const tpPX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const tpPY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                const dx = itemX - tpPX;
                                const dy = itemY - tpPY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                const line = document.createElement('div');
                                line.className = 'smuggler-connector-line';
                                line.dataset.type = 'smuggler_plane_line';
                                line.dataset.index = String(gIndex);
                                line.dataset.routeIndex = String(rIndex);
                                line.style.position = 'absolute';
                                line.style.left = `${tpPX}px`;
                                line.style.top = `${tpPY}px`;
                                line.style.width = `${length}px`;
                                line.style.height = '2px';
                                line.style.background = 'red';
                                line.style.transformOrigin = '0 0';
                                line.style.transform = `rotate(${angle}deg)`;
                                line.style.zIndex = '660';
                                // DOM æ ‡è®°å±‚å·²ç§»é™¤
                                itemMarkers.push({ type: 'smuggler_plane_line', index: gIndex, el: line });
                            }
                        }
                    });
                });
            }

            // ç‰¹æ®Šï¼šèµ°ç§è´©è¸ªè¿¹æ¸²æŸ“ï¼ˆtriggerpoint + routes + è“çº¿ï¼‰
            if (false && activeItemTypes.has('smuggler_trail') && !pilotMarkerTypes.has('smuggler_trail')) {
                const groups = itemData.smuggler_trail || [];
                groups.forEach((group, gIndex) => {
                    const tp = group.triggerpoint; // [x, y]
                    const routes = Array.isArray(group.routes) ? group.routes : [];
                    if (Array.isArray(tp) && tp.length === 2) {
                        const percentX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        const marker = document.createElement('div');
                        marker.className = 'item-marker smuggler-trail-triggerpoint-marker';
                        marker.dataset.type = 'smuggler_trail';
                        marker.dataset.index = String(gIndex);
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        const img = document.createElement('img');
                        img.src = '../src/assets/smuggler_trail.svg';
                        img.style.width = '28px';
                        img.style.height = '28px';
                        marker.appendChild(img);
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showSmugglerTrailPopup(group, gIndex);
                        });
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: 'smuggler_trail', index: gIndex, el: marker });
                    }
                    // routes: array of arrays of [x,y]; draw numbered markers and blue lines connecting them in sequence
                    routes.forEach((route, rIndex) => {
                        if (Array.isArray(route) && route.length > 0 && Array.isArray(route[0]) && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const percentX = (rx - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const percentY = (GAME_TOP - ry) / (GAME_TOP - GAME_BOTTOM);
                            const itemX = percentX * totalWidth;
                            const itemY = percentY * totalHeight;
                            
                            // åˆ›å»ºæ•°å­—æ ‡è®°
                            const marker = document.createElement('div');
                            marker.className = 'item-marker smuggler-trail-route-marker';
                            marker.dataset.type = 'smuggler_trail_route';
                            marker.dataset.index = String(gIndex);
                            marker.dataset.routeIndex = String(rIndex);
                            marker.style.position = 'absolute';
                            marker.style.left = `${itemX}px`;
                            marker.style.top = `${itemY}px`;
                            marker.style.transform = 'translate(-50%, -50%)';
                            marker.style.cursor = 'pointer';
                            marker.style.zIndex = '670';
                            marker.style.width = '24px';
                            marker.style.height = '24px';
                            marker.style.borderRadius = '50%';
                            marker.style.backgroundColor = '#2196F3';
                            marker.style.border = '2px solid #fff';
                            marker.style.display = 'flex';
                            marker.style.alignItems = 'center';
                            marker.style.justifyContent = 'center';
                            marker.style.fontSize = '12px';
                            marker.style.fontWeight = 'bold';
                            marker.style.color = '#fff';
                            marker.textContent = String(rIndex + 1);
                            
                            marker.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showSmugglerTrailPopup(group, gIndex);
                            });
                            // DOM æ ‡è®°å±‚å·²ç§»é™¤
                            itemMarkers.push({ type: 'smuggler_trail_route', index: gIndex, el: marker });

                            // è“çº¿ï¼šè¿æ¥triggerpointåˆ°ç¬¬ä¸€ä¸ªrouteç‚¹ï¼Œç„¶åæŒ‰é¡ºåºè¿æ¥routeç‚¹
                            if (Array.isArray(tp) && tp.length === 2) {
                                const tpPX = (tp[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const tpPY = (GAME_TOP - tp[1]) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                let startX, startY;
                                
                                if (rIndex === 0) {
                                    // ç¬¬ä¸€ä¸ªrouteç‚¹ï¼šä»triggerpointè¿æ¥
                                    startX = tpPX;
                                    startY = tpPY;
                                } else {
                                    // åç»­routeç‚¹ï¼šä»å‰ä¸€ä¸ªrouteç‚¹è¿æ¥
                                    const prevRoute = routes[rIndex - 1];
                                    if (Array.isArray(prevRoute) && prevRoute[0] && prevRoute[0].length === 2) {
                                        const prevX = prevRoute[0][0];
                                        const prevY = prevRoute[0][1];
                                        const prevPercentX = (prevX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                                        const prevPercentY = (GAME_TOP - prevY) / (GAME_TOP - GAME_BOTTOM);
                                        startX = prevPercentX * totalWidth;
                                        startY = prevPercentY * totalHeight;
                                    } else {
                                        return; // å¦‚æœå‰ä¸€ä¸ªrouteæ— æ•ˆï¼Œè·³è¿‡
                                    }
                                }
                                
                                const dx = itemX - startX;
                                const dy = itemY - startY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                const line = document.createElement('div');
                                line.className = 'smuggler-trail-connector-line';
                                line.dataset.type = 'smuggler_trail_line';
                                line.dataset.index = String(gIndex);
                                line.dataset.routeIndex = String(rIndex);
                                line.style.position = 'absolute';
                                line.style.left = `${startX}px`;
                                line.style.top = `${startY}px`;
                                line.style.width = `${length}px`;
                                line.style.height = '2px';
                                line.style.background = 'blue';
                                line.style.transformOrigin = '0 0';
                                line.style.transform = `rotate(${angle}deg)`;
                                line.style.zIndex = '660';
                                // DOM æ ‡è®°å±‚å·²ç§»é™¤
                                itemMarkers.push({ type: 'smuggler_trail_line', index: gIndex, el: line });
                            }
                        }
                    });
                });
            }






            // ç‰¹æ®Šï¼šæ¯’å“è½½å…·æ¸²æŸ“ï¼ˆå·²è¿ç§»åˆ°Leafletç³»ç»Ÿï¼‰
            // if (activeItemTypes.has('drug_vehicle')) {
            //     const drugVehicles = itemData.drug_vehicle || [];
            //     drugVehicles.forEach((vehicle, index) => {
            //         if (typeof vehicle.x === 'undefined' || typeof vehicle.y === 'undefined') return;
            //         const percentX = (vehicle.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
            //         const percentY = (GAME_TOP - vehicle.y) / (GAME_TOP - GAME_BOTTOM);
            //         const itemX = percentX * totalWidth;
            //         const itemY = percentY * totalHeight;
                    
            //         // åˆ›å»ºæ¯’å“è½½å…·æ ‡è®°
            //         const marker = document.createElement('div');
            //         marker.className = 'item-marker drug-vehicle-marker';
            //         marker.dataset.type = 'drug_vehicle';
            //         marker.dataset.index = index;
            //         marker.style.position = 'absolute';
            //         marker.style.left = `${itemX}px`;
            //         marker.style.top = `${itemY}px`;
            //         marker.style.transform = 'translate(-50%, -50%)';
            //         marker.style.cursor = 'pointer';
            //         marker.style.zIndex = '670';
                    
            //         // åˆ›å»ºå›¾æ ‡
            //         const img = document.createElement('img');
            //         img.src = '../src/assets/drug_vehicle.svg';
            //         img.style.width = '32px';
            //         img.style.height = '32px';
            //         marker.appendChild(img);
                    
            //         // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            //         marker.addEventListener('click', (e) => {
            //             e.stopPropagation();
            //             showDrugVehiclePopup(vehicle, index);
            //         });
                    
            //         // DOM æ ‡è®°å±‚å·²ç§»é™¤
            //         itemMarkers.push({ type: 'drug_vehicle', index: index, el: marker });
            //     });
            // }
            
            // ç‰¹æ®Šï¼šéšæœºä»»åŠ¡æ¸²æŸ“ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†åµŒå¥—ç»“æ„ï¼‰- è‹¥å·²è¿ç§»åˆ°Leafletåˆ™è·³è¿‡DOMæ¸²æŸ“
            if (false && activeItemTypes.has('random_missions') && !pilotMarkerTypes.has('random_missions')) {
                console.log('å¤„ç†éšæœºä»»åŠ¡DOMæ ‡è®°ï¼Œæ•°æ®:', itemData.random_missions);
                console.log('pilotMarkerTypes.has(random_missions):', pilotMarkerTypes.has('random_missions'));
                const randomMissions = itemData.random_missions || {};
                let globalIndex = 0;
                
                Object.keys(randomMissions).forEach(timeSlot => {
                    const missions = randomMissions[timeSlot] || [];
                    console.log(`æ—¶é—´æ®µ ${timeSlot} æœ‰ ${missions.length} ä¸ªä»»åŠ¡`);
                    missions.forEach((mission, index) => {
                        // æ£€æŸ¥æ•°æ®æ ¼å¼ï¼šå¯èƒ½æ˜¯[x, y]æ•°ç»„æ ¼å¼
                        let x, y;
                        if (Array.isArray(mission) && mission.length >= 2) {
                            x = mission[0];
                            y = mission[1];
                        } else if (typeof mission === 'object' && mission.x !== undefined && mission.y !== undefined) {
                            x = mission.x;
                            y = mission.y;
                        } else {
                            console.log('è·³è¿‡æ— æ•ˆçš„éšæœºä»»åŠ¡æ•°æ®:', mission);
                            return;
                        }
                        
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        
                        // åˆ›å»ºéšæœºä»»åŠ¡æ ‡è®°
                        const marker = document.createElement('div');
                        marker.className = 'item-marker';
                        marker.dataset.index = globalIndex;
                        marker.dataset.type = 'random_missions';
                        marker.dataset.timeSlot = timeSlot;
                        marker.dataset.missionIndex = index;
                        marker.style.position = 'absolute';
                        marker.style.left = `${itemX}px`;
                        marker.style.top = `${itemY}px`;
                        marker.style.transform = 'translate(-50%, -50%)';
                        marker.style.cursor = 'pointer';
                        marker.style.zIndex = '670';
                        
                        const img = document.createElement('img');
                        img.src = '../src/assets/random.svg';
                        img.style.width = '32px';
                        img.style.height = '32px';
                        marker.appendChild(img);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const missionData = Array.isArray(mission) ? { x, y } : mission;
                            showRandomMissionPopup(missionData, timeSlot, index);
                        });
                        
                        // DOM æ ‡è®°å±‚å·²ç§»é™¤
                        itemMarkers.push({ type: 'random_missions', index: globalIndex, el: marker });
                        globalIndex++;
                    });
                });
                console.log(`æ€»å…±åˆ›å»ºäº† ${globalIndex} ä¸ªéšæœºä»»åŠ¡DOMæ ‡è®°`);
            }
        }

        // DOM æ ‡è®°å·²ç§»é™¤ï¼Œæ— éœ€æ›´æ–°ä½ç½®
        function updateItemMarkersPosition() {
            const z = map.getZoom();
            const level = getLevelOrNearest(z);
            if (!level) return;

            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;

            // æ›´æ–°ç°æœ‰æ ‡è®°ä½ç½®
            itemMarkers.forEach(({ type, index, el }) => {
                // è·³è¿‡è¯•ç‚¹æ ‡è®°ç±»å‹ï¼ˆLeafletæ ‡è®°ä¼šè‡ªåŠ¨è·Ÿéšåœ°å›¾ï¼‰
                if (pilotMarkerTypes.has(type)) return;
                let item;
                if (type === 'treasure_hunt_dba_revolver_random') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.random_clue && itemData.treasure_hunt_dba_revolver.random_clue[index];
                } else if (type === 'treasure_hunt_dba_revolver_static') {
                    item = itemData.treasure_hunt_dba_revolver && itemData.treasure_hunt_dba_revolver.static_clues && itemData.treasure_hunt_dba_revolver.static_clues[index];
                } else if (type === 'movie_props') {
                    // ç”µå½±é“å…·éœ€è¦æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„é¡¹ç›®
                    const mp = itemData.movie_props;
                    const fixedCount = mp.fixed_position?.length || 0;
                    const ponyCount = mp.vehicles?.pony?.length || 0;
                    const rebelCount = mp.vehicles?.rebel?.length || 0;
                    
                    if (index < fixedCount) {
                        item = mp.fixed_position[index];
                    } else if (index < fixedCount + ponyCount) {
                        item = mp.vehicles.pony[index - fixedCount];
                    } else if (index < fixedCount + ponyCount + rebelCount) {
                        item = mp.vehicles.rebel[index - fixedCount - ponyCount];
                    } else {
                        item = mp.vehicles.rumpo[index - fixedCount - ponyCount - rebelCount];
                    }
                } else if (type === 'serial_killer_slasher_first') {
                    // æ€äººç‹‚å‰å››æ¡çº¿ç´¢
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.first && itemData.serial_killer_slasher.first[index];
                } else if (type === 'serial_killer_slasher_last') {
                    // æ€äººç‹‚æœ€åä¸€æ¡çº¿ç´¢
                    item = itemData.serial_killer_slasher && itemData.serial_killer_slasher.last && itemData.serial_killer_slasher.last[index];
                } else if (type === 'maude_bounty_area') {
                    // èŒ‰å¾·æ‚¬èµåŒºåŸŸ
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.areas && itemData.maude_bounty_targets.areas[index];
                } else if (type === 'maude_bounty_endpoint') {
                    // èŒ‰å¾·æ‚¬èµç»ˆç‚¹
                    item = itemData.maude_bounty_targets && itemData.maude_bounty_targets.endpoints && itemData.maude_bounty_targets.endpoints[index];
                } else if (type === 'police_rescue_patrick_mcreary_spawn') {
                    // å¸•ç‰¹é‡Œå…‹æ•‘æ´ç”Ÿæˆç‚¹
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.spawn && itemData.police_rescue_patrick_mcreary.spawn[index];
                } else if (type === 'police_rescue_patrick_mcreary_dropoff') {
                    // å¸•ç‰¹é‡Œå…‹æ•‘æ´é€è¾¾ç‚¹
                    item = itemData.police_rescue_patrick_mcreary && itemData.police_rescue_patrick_mcreary.dropoff && itemData.police_rescue_patrick_mcreary.dropoff[index];
                } else if (type === 'random_missions') {
                    // éšæœºä»»åŠ¡éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºæ•°æ®ç»“æ„æ˜¯åµŒå¥—çš„
                    const randomMissions = itemData.random_missions || {};
                    let currentIndex = 0;
                    
                    // éå†æ‰€æœ‰æ—¶é—´æ®µæ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡
                    for (const timeSlot of Object.keys(randomMissions)) {
                        const missions = randomMissions[timeSlot] || [];
                        for (let i = 0; i < missions.length; i++) {
                            if (currentIndex === index) {
                                const mission = missions[i];
                                if (Array.isArray(mission) && mission.length >= 2) {
                                    item = { x: mission[0], y: mission[1] };
                                }
                                break;
                            }
                            currentIndex++;
                        }
                        if (item) break;
                    }
                } else if (type === 'smuggler_plane') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_route') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && group.routes[routeIndex][0] && group.routes[routeIndex][0].length === 2) {
                        const x = group.routes[routeIndex][0][0];
                        const y = group.routes[routeIndex][0][1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_plane_line') {
                    const group = itemData.smuggler_plane && itemData.smuggler_plane[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && group.routes && group.routes[routeIndex] && group.routes[routeIndex][0]) {
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const rtX = group.routes[routeIndex][0][0];
                        const rtY = group.routes[routeIndex][0][1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const rPX = (rtX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const rPY = (GAME_TOP - rtY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const dx = rPX - tpPX;
                        const dy = rPY - tpPY;
                        const length = Math.sqrt(dx*dx + dy*dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        el.style.left = `${tpPX}px`;
                        el.style.top = `${tpPY}px`;
                        el.style.width = `${length}px`;
                        el.style.transform = `rotate(${angle}deg)`;
                    }
                    return;
                } else if (type === 'smuggler_trail') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'smuggler_trail_route') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && group.routes[routeIndex][0] && group.routes[routeIndex][0].length === 2) {
                        const x = group.routes[routeIndex][0][0];
                        const y = group.routes[routeIndex][0][1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                        // ç¡®ä¿æ•°å­—æ ‡è®°çš„æ ·å¼æ­£ç¡®
                        el.style.width = '24px';
                        el.style.height = '24px';
                        el.style.borderRadius = '50%';
                        el.style.backgroundColor = '#2196F3';
                        el.style.border = '2px solid #fff';
                        el.style.display = 'flex';
                        el.style.alignItems = 'center';
                        el.style.justifyContent = 'center';
                        el.style.fontSize = '12px';
                        el.style.fontWeight = 'bold';
                        el.style.color = '#fff';
                        el.textContent = String(routeIndex + 1);
                    }
                    return;
                } else if (type === 'smuggler_trail_line') {
                    const group = itemData.smuggler_trail && itemData.smuggler_trail[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && group.routes && group.routes[routeIndex] && group.routes[routeIndex][0]) {
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const rtX = group.routes[routeIndex][0][0];
                        const rtY = group.routes[routeIndex][0][1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        const rPX = (rtX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const rPY = (GAME_TOP - rtY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        
                        let startX, startY;
                        
                        if (routeIndex === 0) {
                            // ç¬¬ä¸€ä¸ªrouteç‚¹ï¼šä»triggerpointè¿æ¥
                            startX = tpPX;
                            startY = tpPY;
                        } else {
                            // åç»­routeç‚¹ï¼šä»å‰ä¸€ä¸ªrouteç‚¹è¿æ¥
                            const prevRoute = group.routes[routeIndex - 1];
                            if (Array.isArray(prevRoute) && prevRoute[0] && prevRoute[0].length === 2) {
                                const prevX = prevRoute[0][0];
                                const prevY = prevRoute[0][1];
                                const prevPercentX = (prevX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                                const prevPercentY = (GAME_TOP - prevY) / (GAME_TOP - GAME_BOTTOM);
                                startX = prevPercentX * totalWidth;
                                startY = prevPercentY * totalHeight;
                            } else {
                                return; // å¦‚æœå‰ä¸€ä¸ªrouteæ— æ•ˆï¼Œè·³è¿‡
                            }
                        }
                        
                        const dx = rPX - startX;
                        const dy = rPY - startY;
                        const length = Math.sqrt(dx*dx + dy*dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        el.style.left = `${startX}px`;
                        el.style.top = `${startY}px`;
                        el.style.width = `${length}px`;
                        el.style.transform = `rotate(${angle}deg)`;
                    }
                    return;
                } else if (type === 'convoy') {
                    const group = itemData.convoy && itemData.convoy[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length >= 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'convoy_final') {
                    const final = itemData.convoy_final && itemData.convoy_final[index];
                    if (final && typeof final.x !== 'undefined' && typeof final.y !== 'undefined') {
                        const percentX = (final.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - final.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'convoy_line') {
                    const group = itemData.convoy && itemData.convoy[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    const segmentIndex = el.dataset && el.dataset.segmentIndex ? parseInt(el.dataset.segmentIndex, 10) : -1;
                    if (group && Array.isArray(group.routes) && group.routes[routeIndex] && Array.isArray(group.routes[routeIndex]) && group.routes[routeIndex].length > segmentIndex + 1) {
                        const route = group.routes[routeIndex];
                        const startPoint = route[segmentIndex];
                        const endPoint = route[segmentIndex + 1];
                        if (Array.isArray(startPoint) && startPoint.length === 2 && Array.isArray(endPoint) && endPoint.length === 2) {
                            const startPercentX = (startPoint[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const startPercentY = (GAME_TOP - startPoint[1]) / (GAME_TOP - GAME_BOTTOM);
                            const startX = startPercentX * totalWidth;
                            const startY = startPercentY * totalHeight;
                            
                            const endPercentX = (endPoint[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                            const endPercentY = (GAME_TOP - endPoint[1]) / (GAME_TOP - GAME_BOTTOM);
                            const endX = endPercentX * totalWidth;
                            const endY = endPercentY * totalHeight;
                            
                            const dx = endX - startX;
                            const dy = endY - startY;
                            const length = Math.sqrt(dx*dx + dy*dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            el.style.left = `${startX}px`;
                            el.style.top = `${startY}px`;
                            el.style.width = `${length}px`;
                            el.style.height = '3px';
                            el.style.background = 'red';
                            el.style.transformOrigin = '0 0';
                            el.style.transform = `rotate(${angle}deg)`;
                        }
                    }
                    return;
                } else if (type === 'armored_truck') {
                    const armoredTruck = itemData.armored_truck && itemData.armored_truck[index];
                    if (armoredTruck && typeof armoredTruck.x !== 'undefined' && typeof armoredTruck.y !== 'undefined') {
                        const percentX = (armoredTruck.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - armoredTruck.y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'happy_holidays_hauler') {
                    const group = itemData.happy_holidays_hauler && itemData.happy_holidays_hauler[index];
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                        const x = group.triggerpoint[0];
                        const y = group.triggerpoint[1];
                        const percentX = (x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - y) / (GAME_TOP - GAME_BOTTOM);
                        const itemX = percentX * totalWidth;
                        const itemY = percentY * totalHeight;
                        el.style.left = `${itemX}px`;
                        el.style.top = `${itemY}px`;
                    }
                    return;
                } else if (type === 'happy_holidays_hauler_line') {
                    const group = itemData.happy_holidays_hauler && itemData.happy_holidays_hauler[index];
                    const routeIndex = el.dataset && el.dataset.routeIndex ? parseInt(el.dataset.routeIndex, 10) : -1;
                    const routeSegment = el.dataset && el.dataset.routeSegment ? parseInt(el.dataset.routeSegment, 10) : -1;
                    
                    if (group && Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2 && 
                        group.routes && group.routes[routeIndex] && Array.isArray(group.routes[routeIndex])) {
                        
                        const tpX = group.triggerpoint[0];
                        const tpY = group.triggerpoint[1];
                        const tpPX = (tpX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                        const tpPY = (GAME_TOP - tpY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                        
                        if (routeSegment === -1) {
                            // è¿æ¥triggerpointåˆ°ç¬¬ä¸€ä¸ªrouteç‚¹
                            const route = group.routes[routeIndex];
                            if (route[0] && Array.isArray(route[0]) && route[0].length === 2) {
                                const routeX = route[0][0];
                                const routeY = route[0][1];
                                const routePX = (routeX - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const routePY = (GAME_TOP - routeY) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                const dx = routePX - tpPX;
                                const dy = routePY - tpPY;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                el.style.left = `${tpPX}px`;
                                el.style.top = `${tpPY}px`;
                                el.style.width = `${length}px`;
                                el.style.transform = `rotate(${angle}deg)`;
                            }
                        } else {
                            // è¿æ¥routeç‚¹ä¹‹é—´çš„çº¿æ¡
                            const route = group.routes[routeIndex];
                            if (route[routeSegment] && route[routeSegment + 1] && 
                                Array.isArray(route[routeSegment]) && Array.isArray(route[routeSegment + 1]) && 
                                route[routeSegment].length === 2 && route[routeSegment + 1].length === 2) {
                                
                                const x1 = route[routeSegment][0];
                                const y1 = route[routeSegment][1];
                                const x2 = route[routeSegment + 1][0];
                                const y2 = route[routeSegment + 1][1];
                                
                                const px1 = (x1 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const py1 = (GAME_TOP - y1) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                const px2 = (x2 - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT) * totalWidth;
                                const py2 = (GAME_TOP - y2) / (GAME_TOP - GAME_BOTTOM) * totalHeight;
                                
                                const dx = px2 - px1;
                                const dy = py2 - py1;
                                const length = Math.sqrt(dx*dx + dy*dy);
                                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                                
                                el.style.left = `${px1}px`;
                                el.style.top = `${py1}px`;
                                el.style.width = `${length}px`;
                                el.style.transform = `rotate(${angle}deg)`;
                            }
                        }
                    }
                    return;
                } else {
                    item = itemData[type] && itemData[type][index];
                }
                if (!item || typeof item.x === 'undefined' || typeof item.y === 'undefined') return;

                const percentX = (item.x - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                const percentY = (GAME_TOP - item.y) / (GAME_TOP - GAME_BOTTOM);

                const itemX = percentX * totalWidth;
                const itemY = percentY * totalHeight;

                el.style.left = `${itemX}px`;
                el.style.top = `${itemY}px`;
                
                // ç‰¹æ®Šå¤„ç†å¸®æ´¾æ”»å‡»åœ†åœˆå¤§å°æ›´æ–°
                if (type === 'gang_attacks') {
                    // è®¡ç®—æ¸¸æˆåæ ‡100å•ä½å¯¹åº”çš„åƒç´ å¤§å°
                    const gameRadius = 100; // æ¸¸æˆåæ ‡åŠå¾„
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // ç›´å¾„
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
                
                // ç‰¹æ®Šå¤„ç†èŒ‰å¾·æ‚¬èµç›®æ ‡åœ†åœˆå¤§å°æ›´æ–°
                if (type === 'maude_bounty_area') {
                    // è®¡ç®—æ¸¸æˆåæ ‡185å•ä½å¯¹åº”çš„åƒç´ å¤§å°
                    const gameRadius = 185; // æ¸¸æˆåæ ‡åŠå¾„
                    const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                    const pixelRadius = (gameRadius / gameWidth) * totalWidth;
                    const circleSize = pixelRadius * 2; // ç›´å¾„
                    
                    el.style.width = `${circleSize}px`;
                    el.style.height = `${circleSize}px`;
                }
            });
        }

        // === è½¦è¡Œæ ‡è®°åŠŸèƒ½ ===
        
        // åˆå§‹åŒ–è½¦è¡Œæ ‡è®°
        function initDealershipMarkers() {
            createDealershipMarkers();
            console.log('è½¦è¡Œæ ‡è®°åˆå§‹åŒ–å®Œæˆ');
        }
        
        // åˆ›å»ºè½¦è¡Œæ ‡è®°
        function createDealershipMarkers() {
            // å·²è¿ç§»åˆ°Leafletçš„è½¦è¡Œç±»å‹ï¼Œè·³è¿‡DOMæ ‡è®°åˆ›å»º
            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
            
            Object.keys(dealershipData).forEach(dealershipType => {
                // è·³è¿‡å·²è¿ç§»çš„è½¦è¡Œç±»å‹
                if (migratedDealerships.includes(dealershipType)) {
                    return;
                }
                
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord, index) => {
                    const marker = createDealershipMarker(coord[0], coord[1], dealership, dealershipType);
                    dealershipMarkers.push(marker);
                    // DOM æ ‡è®°å±‚å·²ç§»é™¤
                    // è®¾ç½®åˆå§‹å¯è§æ€§ï¼Œé˜²æ­¢åˆ›å»ºåéœ€ç¼©æ”¾æ‰æ˜¾ç¤º
                    try {
                        marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                    } catch (e) {
                        marker.style.display = 'block';
                    }
                });
            });
            updateDealershipMarkers();
        }
        
        // åˆ›å»ºå•ä¸ªè½¦è¡Œæ ‡è®°
        function createDealershipMarker(x, y, dealership, dealershipType) {
            const marker = document.createElement('div');
            marker.className = 'dealership-marker';
            marker.dataset.dealershipType = dealershipType;
            marker.style.cssText = `
                position: absolute;
                transform: translate(-50%, -50%);
                z-index: 680;
                cursor: pointer;
                transition: transform 0.2s ease;
            `;
            
            const img = document.createElement('img');
            img.src = itemIcons[dealership.icon];
            img.style.cssText = `
                width: 40px;
                height: 40px;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                
            `;
            
            marker.appendChild(img);
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            marker.addEventListener('mouseenter', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1.2)';
            });
            
            marker.addEventListener('mouseleave', () => {
                marker.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('dealership marker clicked:', dealershipType, dealership.name);
                showDealershipVehicles(dealershipType, dealership.name);
            });
            
            return marker;
        }
        
        // æ›´æ–°è½¦è¡Œæ ‡è®°ä½ç½®
        function updateDealershipMarkers() {
            const z = map.getZoom();
            let level = getLevelByZoom(z);
            // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…çš„ç¼©æ”¾çº§åˆ«ï¼Œé€‰å–æœ€è¿‘çš„ä¸€ä¸ªï¼Œé¿å…åœ¨å°æ•°ç¼©æ”¾æ—¶æ— æ³•æ›´æ–°æ ‡è®°ä½ç½®
            if (!level) {
                if (typeof zoomLevels !== 'undefined' && Array.isArray(zoomLevels) && zoomLevels.length > 0) {
                    level = zoomLevels.reduce((best, cur) => Math.abs(cur.zoom - z) < Math.abs(best.zoom - z) ? cur : best, zoomLevels[0]);
                } else {
                    return;
                }
            }
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            let markerIndex = 0;
            // å·²è¿ç§»åˆ°Leafletçš„è½¦è¡Œç±»å‹ï¼Œè·³è¿‡DOMæ ‡è®°æ›´æ–°
            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
            
            Object.keys(dealershipData).forEach(dealershipType => {
                // è·³è¿‡å·²è¿ç§»çš„è½¦è¡Œç±»å‹
                if (migratedDealerships.includes(dealershipType)) {
                    return;
                }
                
                const dealership = dealershipData[dealershipType];
                dealership.coordinates.forEach((coord) => {
                    if (markerIndex < dealershipMarkers.length) {
                        const marker = dealershipMarkers[markerIndex];
                        
                        const percentX = (coord[0] - GAME_LEFT) / (GAME_RIGHT - GAME_LEFT);
                        const percentY = (GAME_TOP - coord[1]) / (GAME_TOP - GAME_BOTTOM);
                        
                        const markerX = percentX * totalWidth;
                        const markerY = percentY * totalHeight;
                        
                        marker.style.left = `${markerX}px`;
                        marker.style.top = `${markerY}px`;
                        // æ ¹æ®ä¾§è¾¹æ é€‰æ‹©æ˜¾ç¤ºæˆ–éšè—è½¦è¡Œæ ‡è®°
                        try {
                            marker.style.display = activeItemTypes && activeItemTypes.has && activeItemTypes.has('dealerships') ? 'block' : 'none';
                        } catch (e) {
                            // å¦‚æœ activeItemTypes æœªå®šä¹‰ï¼Œé»˜è®¤æ˜¾ç¤º
                            marker.style.display = 'block';
                        }

                        markerIndex++;
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºè½¦è¡Œè½¦è¾†ä¿¡æ¯
        async function showDealershipVehicles(dealershipType, dealershipName) {
            try {
                let apiEndpoint = '';
                let vehicleTypes = [];
                
                // æ ¹æ®è½¦è¡Œç±»å‹ç¡®å®š API ç«¯ç‚¹å’Œè½¦è¾†ç±»å‹
                switch(dealershipType) {
                    case 'casino':
                        apiEndpoint = 'https://api-gta.antwen.com/api/dealerships/casino-prize';
                        vehicleTypes = ['èµŒåœºå¥–å“è½½å…·'];
                        break;
                    case 'car_meet':
                        // è½¦å‹ä¼šåŒ…å«å¤šç§è½¦è¾†ç±»å‹
                        await showCarMeetVehicles(dealershipName);
                        return;
                    case 'premium_deluxe_motorsport':
                        // è¥¿ç±³æ©ä½¿ç”¨å¤šè½¦è¾†API
                        await showSimeonVehicles(dealershipName);
                        return;
                    case 'luxury_autos':
                        // è±ªåè½¦è¡Œä½¿ç”¨å¤šè½¦è¾†API
                        await showLuxuryVehicles(dealershipName);
                        return;
                    default:
                        console.error('æœªçŸ¥çš„è½¦è¡Œç±»å‹:', dealershipType);
                        return;
                }
                
                // è·å–å•ä¸ªè½¦è¡Œçš„è½¦è¾†ä¿¡æ¯ï¼ˆä»…èµŒåœºï¼‰
                const response = await fetch(apiEndpoint);
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicle) {
                    showVehiclePopup([result.data.vehicle], dealershipName, vehicleTypes[0]);
                } else {
                    console.error('è·å–è½¦è¾†ä¿¡æ¯å¤±è´¥:', result.error);
                    alert('è·å–è½¦è¾†ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ˜¾ç¤ºè½¦å‹ä¼šè½¦è¾†ï¼ˆåŒ…å«å¤šç§ç±»å‹ï¼‰
        async function showCarMeetVehicles(dealershipName) {
            try {
                const endpoints = [
                    { url: 'https://api-gta.antwen.com/api/dealerships/car-meet-prize', name: 'è½¦å‹ä¼šå¥–å“è½½å…·' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/promo-test', name: 'æµ‹è¯•è½½å…·' },
                    { url: 'https://api-gta.antwen.com/api/dealerships/hsw-test', name: 'HSWè½½å…·' }
                ];
                
                const vehicles = [];
                const vehicleTypes = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url);
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            if (result.data.vehicle) {
                                // å•ä¸ªè½¦è¾†
                                vehicles.push(result.data.vehicle);
                                vehicleTypes.push(endpoint.name);
                            } else if (result.data.vehicles && Array.isArray(result.data.vehicles)) {
                                // å¤šä¸ªè½¦è¾†
                                result.data.vehicles.forEach(vehicle => {
                                    vehicles.push(vehicle);
                                    vehicleTypes.push(endpoint.name);
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`è·å–${endpoint.name}å¤±è´¥:`, error);
                    }
                }
                
                if (vehicles.length > 0) {
                    showVehiclePopup(vehicles, dealershipName, vehicleTypes);
                } else {
                    alert('æ²¡æœ‰è·å–åˆ°ä»»ä½•è½¦è¾†ä¿¡æ¯');
                }
            } catch (error) {
                console.error('è·å–è½¦å‹ä¼šè½¦è¾†ä¿¡æ¯å¤±è´¥:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ˜¾ç¤ºè¥¿ç±³æ©è½¦è¾†
        async function showSimeonVehicles(dealershipName) {
            try {
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/simeon-test');
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicles) {
                    showVehiclePopup(result.data.vehicles, dealershipName, 'è¥¿ç±³æ©æµ‹è¯•è½½å…·');
                } else {
                    console.error('è·å–è¥¿ç±³æ©è½¦è¾†ä¿¡æ¯å¤±è´¥:', result.error);
                    alert('è·å–è½¦è¾†ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('è·å–è¥¿ç±³æ©è½¦è¾†ä¿¡æ¯å¤±è´¥:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ˜¾ç¤ºè±ªåè½¦è¾†
        async function showLuxuryVehicles(dealershipName) {
            console.log('è°ƒç”¨showLuxuryVehiclesï¼Œè½¦è¡Œåç§°:', dealershipName);
            try {
                console.log('æ­£åœ¨è¯·æ±‚è±ªåè½¦è¾†API...');
                const response = await fetch('https://api-gta.antwen.com/api/dealerships/luxury-showcase');
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                const result = await response.json();
                console.log('APIå“åº”æ•°æ®:', result);
                
                if (result.success && result.data && result.data.vehicles) {
                    console.log('è½¦è¾†æ•°æ®:', result.data.vehicles);
                    showVehiclePopup(result.data.vehicles, dealershipName, 'è±ªåè½¦å±•å…');
                } else {
                    console.error('è·å–è±ªåè½¦è¾†ä¿¡æ¯å¤±è´¥:', result.error || result);
                    alert(`è·å–è½¦è¾†ä¿¡æ¯å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('è·å–è±ªåè½¦è¾†ä¿¡æ¯å¤±è´¥:', error);
                alert(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ˜¾ç¤ºè½¦è¾†å¼¹çª—
        function showVehiclePopup(vehicles, dealershipName, vehicleTypes) {
            console.log('showVehiclePopupè°ƒç”¨å‚æ•°:', {vehicles, dealershipName, vehicleTypes});
            console.log('vehiclesæ•°ç»„é•¿åº¦:', vehicles ? vehicles.length : 'vehiclesä¸ºç©º');
            
            const popup = document.createElement('div');
            popup.className = 'vehicle-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #FFD700;
                border-radius: 15px;
                padding: 25px;
                z-index: 10000;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;
            
            let popupContent = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #333; border-bottom: 2px solid #FFD700; padding-bottom: 10px;">
                    ğŸ¦ ${dealershipName}è½¦è¡Œ
                </div>
            `;
            
            vehicles.forEach((vehicle, index) => {
                const vehicleType = Array.isArray(vehicleTypes) ? vehicleTypes[index] : vehicleTypes;
                const imageUrl = vehicle.img ? `https://gta-images.antwen.com/${vehicle.img.replace(/^\/+/, '')}` : '';
                const detailUrl = vehicle.modelHash ? `/vehicles#/vehicle/${vehicle.modelHash.toLowerCase()}` : '';
                
                // å¤„ç†æ¶‚è£…ä»·æ ¼æ˜¾ç¤º
                let liveryPriceDisplay = '';
                if (vehicle.liveryPrice === 'free') {
                    liveryPriceDisplay = '<span style="color: #e91e63; font-weight: bold;">âœ¨ éšè—æ¶‚è£…</span>';
                } else if (vehicle.liveryPrice) {
                    liveryPriceDisplay = `<span style="color: #4caf50; font-weight: bold;">æ¶‚è£…ä»·æ ¼: ${vehicle.liveryPrice}</span>`;
                }
                
                popupContent += `
                    <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #FFD700;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 18px;">
                            ğŸš— ${vehicleType}
                        </div>
                        <div style="color: #333; font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                            ${vehicle.name || 'æœªçŸ¥è½¦è¾†'}
                        </div>
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 alt="${vehicle.name}" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        ` : ''}
                        <div style="margin: 10px 0; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>è½¦ç±»:</strong> ${vehicle.class || 'æœªçŸ¥'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>ä»·æ ¼:</strong> ${vehicle.price || 'æœªçŸ¥'}
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>çŠ¶æ€:</strong> ${vehicle.isPurchaseable ? 'å¯è´­ä¹°' : 'ä¸å¯è´­ä¹°'}
                            </div>
                        </div>
                        ${vehicle.liveryName ? `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>æ¶‚è£…:</strong> ${vehicle.liveryName}<br>
                                ${liveryPriceDisplay}
                            </div>
                        ` : ''}
                        ${detailUrl ? `
                            <a href="${detailUrl}" target="_blank" 
                               style="display: inline-block; margin-top: 10px; padding: 10px 20px; 
                                      background: #2196F3; color: white; text-decoration: none; 
                                      border-radius: 6px; font-weight: bold; transition: background 0.3s;"
                               onmouseover="this.style.background='#1976D2'" 
                               onmouseout="this.style.background='#2196F3'">
                                ğŸ” è½¦è¾†è¯¦ç»†ä¿¡æ¯
                            </a>
                        ` : ''}
                    </div>
                `;
            });
            
            popupContent += `
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-vehicle-popup" 
                            style="padding: 12px 24px; 
                                   background: #f44336; color: white; 
                                   border: none; border-radius: 6px; 
                                   cursor: pointer; font-size: 16px;
                                   font-weight: bold; transition: background 0.3s;">
                        å…³é—­
                    </button>
                </div>
            `;
            
            popup.innerHTML = popupContent;
            
            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
            popup.querySelector('#close-vehicle-popup').addEventListener('click', () => {
                popup.remove();
            });
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // æ£€æŸ¥ç‰¹æŠ€è·³è·ƒç‚¹ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºæ ‡è®°å…ƒç´ ç›´æ¥ç‚¹å‡»ï¼‰
        function checkStuntJumpsClick(e) {
            // è·å–æ ‡è®°å…ƒç´ 
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // è·å–ç´¢å¼•
            const index = parseInt(marker.dataset.index);
            
            // æ˜¾ç¤ºç‰©å“ä¿¡æ¯
            if (itemData.stunt_jumps && itemData.stunt_jumps[index]) {
                showItemInfo(itemData.stunt_jumps[index], 'stunt_jumps', index);
                
                // æ˜¾ç¤ºç‰¹æŠ€è·³è·ƒç‚¹å›¾ç‰‡å¼¹çª—
                showStuntJumpsImage(index);
            }
        }

        // æ˜¾ç¤ºç‰©å“ä¿¡æ¯
        function showItemInfo(item, type, index) {
            const titleMap = {
                stunt_jumps: 'ç‰¹æŠ€è·³è·ƒç‚¹',
                hidden_caches: 'éšè—åŒ…è£¹',
                shipwrecked: 'æ²‰èˆ¹',
                gun_van: 'æ­¦å™¨å¢å‹è½¦',
                ls_tags: 'LSæ¶‚é¸¦',
                spray: 'å–·ç½ä½ç½®',
                street_dealers: 'è¡—å¤´æ¯’è´©',
                playing_cards: 'çº¸ç‰Œ',
                smoke_on_the_water_product: 'åäº‘åé›¾é¦†äº§å“',
                action_figures: 'æ‰‹åŠ',
                yuanbao: 'å…ƒå®',
                ld_organics_products: 'æœ‰æœºåŠäº§å“',
                signal_jammers: 'ä¿¡å·å¹²æ‰°å™¨',
                jack_o_lanterns: 'å—ç“œç¯',
                payphone_hits: 'ç”µè¯æš—æ€',
                golf_holes: 'é«˜å°”å¤«çƒæ´',
                snowmen: 'é›ªäºº',
                rc_time_trial: 'RCæ—¶é—´æŒ‘æˆ˜èµ›',
                bike_time_trial: 'è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›',
                skydives: 'è·³ä¼',
                gang_attacks: 'å¸®æ´¾æ”»å‡»',
                ghosts3: 'å¹½çµæ›å…‰2025',
                treasure_hunt_dba_revolver: 'å·¦è½®å¯»å®',
                treasure_hunt_dba_revolver_random: 'å·¦è½®å¯»å® - éšæœºçº¿ç´¢',
                treasure_hunt_dba_revolver_static: 'å·¦è½®å¯»å® - å›ºå®šçº¿ç´¢',
                wea: 'å¨æ³½å°”å¤§æ¥¼æªæˆ˜',
                ppl: 'é™†åœ°è¿·å¹»ä»™äººæŒ',
                ppw: 'æ°´ä¸‹è¿·å¹»ä»™äººæŒ',
                metro: 'åœ°é“ç«™',
                police: 'è­¦å¯Ÿå±€',
                v_telescopes: 'æœ›è¿œé•œ',
                fire_stations: 'æ¶ˆé˜²å±€',
                hospitals: 'åŒ»é™¢',
                clothing: 'æœè£…åº—',
                tattoos: 'çº¹èº«åº—',
                barbers: 'ç†å‘åº—',
                ammunation: 'æ­¦è£…å›½åº¦',
                mod_shop: 'æ´›åœ£éƒ½æ”¹è½¦ç‹',
                car_wash: 'æ´—è½¦åº—',
                shops_to_rob: 'å¯æŠ¢åŠ«çš„å•†åº—',
                gas_stations: 'åŠ æ²¹ç«™',
                atms: 'ATMæœº',
                vend_sprunk: 'éœœç¢§å”®å–æœº',
                vend_ecola: 'æ˜“å¯ä¹å”®å–æœº',
                // æ–°å¢ç¼ºå¤±çš„æ ‡è®°ç±»å‹æ ‡é¢˜
                crime_scenes: 'çŠ¯ç½ªç°åœº',
                stash_houses: 'è—åŒ¿å±‹',
                madrazo_hits: 'ç›å¾·æ‹‰ç´¢é›‡å‡¶',
                police_rescue_patrick_mcreary: 'å¸•ç‰¹é‡Œå…‹æ•‘æ´',
                random_missions: 'éšæœºä»»åŠ¡',
                drunk_guard: 'æ²‰ç¡çš„ä¿å®‰',
                community_outreach: 'ç¤¾åŒºè¾¹ç•Œ',
                store_robbery: 'å•†åº—æŠ¢åŠ«',
                armored_truck: 'è£…ç”²è¿é’è½¦',
                media_sticks: 'åª’ä½“è®°å¿†æ£’',
                ufo: 'UFOè§‚å…‰',
                cerberus: 'ä¸‡åœ£èŠ‚åœ°ç‹±çŠ¬äº‹ä»¶'
            };


            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆ itemï¼Œåˆ™ä¸æ˜¾ç¤ºå°ä¿¡æ¯é¢æ¿
            if (!item) {
                itemInfo.style.display = 'none';
                return;
            }

            // å¡«å……å°é¢æ¿æ–‡æœ¬å†…å®¹
            const title = titleMap[type] || type;
            const coords = (typeof item.x !== 'undefined' && typeof item.y !== 'undefined') ? `${item.x}, ${item.y}` : (item.coords ? String(item.coords) : 'æœªçŸ¥');
            const location = item.name || (typeof index !== 'undefined' ? `#${index}` : 'æœªçŸ¥');
            const details = item.info || item.details || item.description || 'æ— ';

            const titleEl = document.getElementById('item-title');
            const coordsEl = document.getElementById('item-coords');
            const locationEl = document.getElementById('item-location');
            const detailsEl = document.getElementById('item-details');

            if (titleEl) titleEl.textContent = title;
            if (coordsEl) coordsEl.textContent = `åæ ‡: ${coords}`;
            if (locationEl) locationEl.textContent = `ä½ç½®: ${location}`;
            if (detailsEl) detailsEl.textContent = `è¯¦ç»†ä¿¡æ¯: ${details}`;

            // å¯¹äºä¼šæ˜¾ç¤ºå¤§å¼¹çª—/å›¾ç‰‡çš„ç±»å‹ï¼Œä¸æ˜¾ç¤ºå°æ–‡æœ¬é¢æ¿ï¼Œé¿å…é‡å¤
            const imageTypes = new Set([
                'ld_organics_products',
                'signal_jammers',
                'playing_cards',
                'smoke_on_the_water_product',
                'action_figures',
                'yuanbao',
                'shipwrecked',
                'payphone_hits',
                'golf_holes',
                'snowmen',
                'dead_drop',
                'stunt_jumps',
                'spray',
                'gang_attacks',
                'ghosts3',
                'treasure_hunt_dba_revolver',
                'treasure_hunt_dba_revolver_random',
                'treasure_hunt_dba_revolver_static',
                'wea',
                'ppl',
                'ppw'
            ]);

            if (!imageTypes.has(type)) {
                itemInfo.style.display = 'block';
            } else {
                // ç¡®ä¿éšè—å°é¢æ¿ï¼ˆå¤§å¼¹çª—ä¼šåŒæ—¶æ˜¾ç¤ºï¼‰
                itemInfo.style.display = 'none';
            }

            // å¦‚æœæ˜¯æœ‰æœºåŠäº§å“ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'ld_organics_products') {
                showOrganicFarmImage(index);
            }
            
            // å¦‚æœæ˜¯ä¿¡å·å¹²æ‰°å™¨ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'signal_jammers') {
                showSignalJammerImage(index);
            }
            
            // å¦‚æœæ˜¯çº¸ç‰Œï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'playing_cards') {
                showPlayingCardsImage(index);
            }
            
            // å¦‚æœæ˜¯åäº‘åé›¾é¦†äº§å“ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'smoke_on_the_water_product') {
                showSmokeProductPopup(item, index);
            }
            
            // å¦‚æœæ˜¯æ‰‹åŠï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'action_figures') {
                showActionFiguresImage(index);
            }
            
            // å¦‚æœæ˜¯å…ƒå®ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'yuanbao') {
                showYuanbaoImage(index);
            }
            
            // å¦‚æœæ˜¯æ²‰èˆ¹ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'shipwrecked') {
                showShipwreckedPopup(item, index);
            }
            
            // å¦‚æœæ˜¯ç”µè¯æš—æ€ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'payphone_hits') {
                showPayphoneHitsImage(index);
            }
            
            // å¦‚æœæ˜¯é«˜å°”å¤«çƒæ´ï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'golf_holes') {
                showGolfHolesImage(index);
            }
            
            // å¦‚æœæ˜¯é›ªäººï¼Œæ˜¾ç¤ºå›¾ç‰‡å¼¹çª—
            if (type === 'snowmen') {
                showSnowmenImage(index);
            }
            
            // å¦‚æœæ˜¯æ°æ‹‰å¾·åŒ…è£¹ï¼Œæ˜¾ç¤ºå¢å¼ºç‰ˆå¼¹çª—
            if (type === 'dead_drop') {
                showDeadDropPopup(item, index);
            }
            
            // å¦‚æœæ˜¯å¸®æ´¾æ”»å‡»ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'gang_attacks') {
                showGangAttackPopup(item, index);
            }

            // å¦‚æœæ˜¯å¹½çµæ›å…‰ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'ghosts3') {
                showGhosts3Popup(item, index);
            }

            // å¦‚æœæ˜¯å·¦è½®å¯»å®çº¿ç´¢ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'treasure_hunt_dba_revolver_random') {
                showTreasureHuntPopup(item, index, 'random');
            }
            if (type === 'treasure_hunt_dba_revolver_static') {
                showTreasureHuntPopup(item, index, 'static');
            }
            
            // å¦‚æœæ˜¯å¨æ³½å°”å¤§æ¥¼æªæˆ˜ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'wea') {
                showWeaPopup(item, index);
            }
            
            // å¦‚æœæ˜¯é™†åœ°è¿·å¹»ä»™äººæŒï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'ppl') {
                showPplPopup(item, index);
            }
            
            // å¦‚æœæ˜¯æ°´ä¸‹è¿·å¹»ä»™äººæŒï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'ppw') {
                showPpwPopup(item, index);
            }
            
            // å¦‚æœæ˜¯æ´›åœ£éƒ½æ€äººç‹‚çº¿ç´¢ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'serial_killer_slasher_first') {
                showSlasherPopup(item, index, 'first');
            }
            if (type === 'serial_killer_slasher_last') {
                showSlasherPopup(item, index, 'last');
            }
            
            // å¦‚æœæ˜¯ç”µå½±é“å…·ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (type === 'movie_props') {
                // ç”µå½±é“å…·éœ€è¦æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„é¡¹ç›®
                const mp = itemData.movie_props;
                const fixedCount = mp.fixed_position?.length || 0;
                const ponyCount = mp.vehicles?.pony?.length || 0;
                const rebelCount = mp.vehicles?.rebel?.length || 0;
                
                let subtype;
                if (index < fixedCount) {
                    subtype = 'fixed_position';
                } else if (index < fixedCount + ponyCount) {
                    subtype = 'pony';
                } else if (index < fixedCount + ponyCount + rebelCount) {
                    subtype = 'rebel';
                } else {
                    subtype = 'rumpo';
                }
                
                showMoviePropsPopup(item, index, subtype);
            }
        }

        function hideItemInfo() {
            itemInfo.style.display = 'none';
        }

        // RCæ—¶é—´æŒ‘æˆ˜èµ›å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showRCTimeTrialPopup(item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.rc-time-trial-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.rcTimeTrialMarkers && window.rcTimeTrialMarkers) || [];
            const totalCount = 1; // å›ºå®šä¸º1ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ RCæ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'rc-time-trial-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FF5722;">
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">ğŸ—ºï¸ åœ°ç‚¹</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || 'æœªçŸ¥åœ°ç‚¹'}</div>
                    
                    <div style="font-weight: bold; color: #FF5722; margin-bottom: 8px; font-size: 16px;">â±ï¸ æ—¶é—´è¦æ±‚</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #fff3e0; padding: 8px; border-radius: 4px;">${item.time || 'æœªçŸ¥æ—¶é—´'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #fff3e0; border-radius: 6px; color: #e65100; font-size: 14px; line-height: 1.4;">
                    ğŸ† æŒ‘æˆ˜æç¤ºï¼šä½¿ç”¨RCè½¦åœ¨é™å®šæ—¶é—´å†…å®Œæˆèµ›é“ï¼
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-rc-time-trial-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-rc-time-trial-btn');
            const hideBtn = popup.querySelector('#hide-rc-time-trial-btn');
            const showBtn = popup.querySelector('#show-rc-time-trial-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('rc_time_trial', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ RCæ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateRCTimeTrialSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ RCæ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateRCTimeTrialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // å…¼å®¹ï¼šæ—§è°ƒç”¨åˆ«åï¼ˆä¿®å¤ ReferenceErrorï¼‰
        function showRCTimeTrialImage(index) {
            const item = (itemData.rc_time_trial && itemData.rc_time_trial[index]) || null;
            if (!item) return;
            showRCTimeTrialPopup(item, index);
        }

        // è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showBikeTimeTrialPopup(item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.bike-time-trial-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.bikeTimeTrialMarkers && window.bikeTimeTrialMarkers) || [];
            const totalCount = 1; // å›ºå®šä¸º1ä¸ª

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸš´ è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'bike-time-trial-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">ğŸ—ºï¸ åœ°ç‚¹</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || 'æœªçŸ¥åœ°ç‚¹'}</div>
                    
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 8px; font-size: 16px;">â±ï¸ æ—¶é—´è¦æ±‚</div>
                    <div style="color: #333; font-size: 20px; font-weight: bold; background: #e8f5e8; padding: 8px; border-radius: 4px;">${item.time || 'æœªçŸ¥æ—¶é—´'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #e8f5e8; border-radius: 6px; color: #2e7d32; font-size: 14px; line-height: 1.4;">
                    ğŸ† æŒ‘æˆ˜æç¤ºï¼šä½¿ç”¨è‡ªè¡Œè½¦åœ¨é™å®šæ—¶é—´å†…å®Œæˆèµ›é“ï¼
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-bike-time-trial-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-bike-time-trial-btn');
            const hideBtn = popup.querySelector('#hide-bike-time-trial-btn');
            const showBtn = popup.querySelector('#show-bike-time-trial-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('bike_time_trial', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸš´ è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateBikeTimeTrialSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸš´ è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ› #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateBikeTimeTrialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // å…¼å®¹ï¼šæ—§è°ƒç”¨åˆ«åï¼ˆä¿®å¤ ReferenceErrorï¼‰
        function showBikeTimeTrialImage(index) {
            const item = (itemData.bike_time_trial && itemData.bike_time_trial[index]) || null;
            if (!item) return;
            showBikeTimeTrialPopup(item, index);
        }

        // ä¿¡å·å¹²æ‰°å™¨å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSignalJammerImage(index) {
            // åºå·ä»1å¼€å§‹
             const sequenceNumber = index + 1;
             // 1-9ä½¿ç”¨å•ä¸ªæ•°å­—ï¼Œ10+ä½¿ç”¨ä¸¤ä½æ•°
             const paddedNumber = sequenceNumber < 10 ? sequenceNumber.toString() : sequenceNumber.toString().padStart(2, '0');
             const imageUrl = `https://gta-maps.antwen.com/collectibles_images/signal_jammers/signal_jammers_${paddedNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.signal-jammer-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ“¡ ä¿¡å·å¹²æ‰°å™¨ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'signal-jammer-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="ä¿¡å·å¹²æ‰°å™¨å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: var(--gta-primary); margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    <div style="color: var(--gta-text); font-size: 14px; line-height: 1.4;">
                        æ¶ˆç­å…¨éƒ¨çš„50ä¸ªå¹²æ‰°å™¨å¯è§£é”èµŒåœºè±ªåŠ«éšè—é»‘å®¢ï¼šé˜¿ç»´Â·æ–½ç“¦å…¹æ›¼
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-signal-jammer-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-signal-jammer-btn');
            const hideBtn = popup.querySelector('#hide-signal-jammer-btn');
            const showBtn = popup.querySelector('#show-signal-jammer-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'signal-jammer-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('signal_jammers', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ“¡ ä¿¡å·å¹²æ‰°å™¨ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSignalJammersSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ“¡ ä¿¡å·å¹²æ‰°å™¨ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSignalJammersSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°ä¿¡å·å¹²æ‰°å™¨æ ‡è®°
        function applySignalJammersVisibilityCache() {
            const markers = (window.signalJammersMarkers && window.signalJammersMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('signal_jammers');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨ä¿¡å·å¹²æ‰°å™¨å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ˜¾ç¤ºå—ç“œç¯å›¾ç‰‡å¼¹çª—ï¼ˆæ”¹ä¸ºçº¸ç‰Œæ ·å¼ï¼Œä¿ç•™åŸå†…å®¹ï¼‰
        function showJackOLanternImage(index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/lantern/lantern_${sequenceNumber.toString().padStart(2, '0')}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.jack-o-lantern-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆæ€»æ•°ä¸ºç‰©å“æ€»æ•°ï¼‰
            const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
            // ä¼˜å…ˆä½¿ç”¨æ•°æ®æ€»æ•°
            const totalCount = Array.isArray(window.itemData?.jack_o_lanterns)
                ? window.itemData.jack_o_lanterns.length
                : (Array.isArray(markers) ? markers.length : 0);

            let hiddenCount = 0;
            if (Array.isArray(markers) && markers.length > 0) {
                markers.forEach((marker) => {
                    if (marker && typeof marker.getElement === 'function') {
                        const el = marker.getElement();
                        if (el && el.style.opacity === '0.3') hiddenCount++;
                    }
                });
            } else {
                // ä»ç¼“å­˜è¯»å–éšè—è®¡æ•°ä½œä¸ºå›é€€
                const cachedCounter = CounterCache.getCounter('jack_o_lanterns');
                hiddenCount = cachedCounter.hidden || 0;
            }

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            } else {
                // ä»å¯è§æ€§ç¼“å­˜è¯»å–å½“å‰æ ‡è®°çŠ¶æ€
                const visibilityMap = VisibilityCache.loadVisibility('jack_o_lanterns');
                isCurrentHidden = visibilityMap[index] === true;
            }

            const title = `ğŸƒ å—ç“œç¯ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—ï¼ˆé‡‡ç”¨çº¸ç‰Œæ ·å¼ï¼‰
            const popup = document.createElement('div');
            popup.className = 'jack-o-lantern-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="å—ç“œç¯ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(242, 111, 23, 0.12); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(242, 111, 23, 0.12); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #f26f17; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ”¶é›†å…¨éƒ¨å—ç“œç¯å¯è·å¾—ç‰¹æ®Šä¸‡åœ£èŠ‚å¥–åŠ±ï¼
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-jack-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-jack-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-jack-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-jack-btn');
            const hideBtn = popup.querySelector('#hide-jack-btn');
            const showBtn = popup.querySelector('#show-jack-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'jack-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('jack_o_lanterns', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸƒ å—ç“œç¯ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                });
            }

            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸƒ å—ç“œç¯ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å—ç“œç¯æ ‡è®°
        function applyJackOLanternsVisibilityCache() {
            const markers = (window.jackOLanternMarkers && window.jackOLanternMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('jack_o_lanterns');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨å—ç“œç¯å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // çº¸ç‰Œå¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showPlayingCardsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/playing_cards/playing_cards_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.playing-cards-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸƒ çº¸ç‰Œ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'playing-cards-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="çº¸ç‰Œ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                        æ”¶é›†æ‰€æœ‰54å¼ çº¸ç‰Œå¯è·å¾—ï¼šç‰¹æ®Šæœè£…å¥–åŠ±èµŒåœºè±ªèµŒå®¢å¥—è£…
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-playing-cards-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-playing-cards-btn');
            const hideBtn = popup.querySelector('#hide-playing-cards-btn');
            const showBtn = popup.querySelector('#show-playing-cards-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'playing-cards-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('playing_cards', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸƒ çº¸ç‰Œ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePlayingCardsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸƒ çº¸ç‰Œ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePlayingCardsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== å¢å¼ºç‰ˆæ®‹ç¼ºä¿¡ä»¶æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º letter_scraps å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachLetterScrapsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.letter-scraps-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'letter-scraps-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateLetterScrapsSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateLetterScrapsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-letter_scraps + label .letter-scraps-counter');
                if (!counterEl) return;

                const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
                const total = Array.isArray(window.itemData?.letter_scraps) ? window.itemData.letter_scraps.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                if (!hasRenderedMarker) {
                    const cachedCounter = CounterCache.getCounter('letter_scraps');
                    hidden = cachedCounter.hidden || 0;
                }

                CounterCache.updateCounter('letter_scraps', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ®‹ç¼ºä¿¡ä»¶è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // æ®‹ç¼ºä¿¡ä»¶å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showLetterScrapsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/letter_scraps/letter_scraps_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.letter-scraps-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ“œ æ®‹ç¼ºä¿¡ä»¶ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'letter-scraps-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ®‹ç¼ºä¿¡ä»¶ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ¸¸æˆä¸­æ€»å…±æœ‰ 50 ä¸ªæ®‹ç¼ºä¿¡ä»¶ã€‚è¦æ”¶é›†è¿™äº›ä¿¡ä»¶ï¼Œæ‚¨å¿…é¡»å®Œæˆä¸»çº¿ä»»åŠ¡æœ‰å€Ÿæœ‰è¿˜ã€‚<br>
                    æ¯ä¸ªè§’è‰²éƒ½å¯ä»¥æ‹¾å–æ®‹ç‰‡ã€‚å°æŸ¥è¿˜å¯ä»¥å¸®åŠ©å¯Œå…°å…‹æ—æ‰¾åˆ°å®ƒé™„è¿‘çš„æ®‹ç‰‡ã€‚æ”¶é›†æ‰€æœ‰ 50 ä¸ªæ®‹ç¼ºä¿¡ä»¶æ˜¯ 100% å®Œæˆåº¦çš„è¦æ±‚ä¹‹ä¸€ã€‚<br><br>
                    é›†é½æ®‹ç¼ºä¿¡ä»¶ï¼Œæ­ç¤ºå¥³æ¼”å‘˜é‡Œå¥¥è¯ºæ‹‰Â·çº¦ç¿°é€Šè°‹æ€æ¡ˆçš„çœŸç›¸ã€‚æ‚¨å°†è§£é”é™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡å¥½éº¦åæ˜æ—¥ä¹‹æ˜Ÿï¼ˆå¯Œå…°å…‹æ—ï¼‰ã€‚å®Œæˆåï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªæˆå°±ã€‚å®Œæˆæ­¤ä»»åŠ¡æ˜¯ 100% å®Œæˆåº¦çš„è¦æ±‚ä¹‹ä¸€ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-letter-scraps-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-letter-scraps-btn');
            const hideBtn = popup.querySelector('#hide-letter-scraps-btn');
            const showBtn = popup.querySelector('#show-letter-scraps-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'letter-scraps-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    overlay.addEventListener('click', () => overlay.remove());
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('letter_scraps', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ“œ æ®‹ç¼ºä¿¡ä»¶ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateLetterScrapsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ“œ æ®‹ç¼ºä¿¡ä»¶ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateLetterScrapsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ®‹ç¼ºä¿¡ä»¶æ ‡è®°
        function applyLetterScrapsVisibilityCache() {
            const markers = (window.letterScrapsMarkers && window.letterScrapsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('letter_scraps');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ®‹ç¼ºä¿¡ä»¶å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== å¢å¼ºç‰ˆéšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º sp_hidden_packages å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSpHiddenPackagesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.sp-hidden-packages-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'sp-hidden-packages-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSpHiddenPackagesSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSpHiddenPackagesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-sp_hidden_packages + label .sp-hidden-packages-counter');
                if (!counterEl) return;

                // è·å–éšè—åŒ…è£¹æ ‡è®°
                const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
                const total = Array.isArray(window.itemData?.sp_hidden_packages) ? window.itemData.sp_hidden_packages.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('sp_hidden_packages');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('sp_hidden_packages', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSpHiddenPackagesImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/sp_hidden_packages/sp_hidden_packages_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.sp-hidden-packages-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // è·å–å½“å‰åŒ…è£¹çš„æè¿°ä¿¡æ¯
            const item = window.itemData?.sp_hidden_packages?.[index];
            const description = item?.description || '';
            let contentText = description;
            
            // å¦‚æœæè¿°åŒ…å«trevorï¼Œæ·»åŠ ç‰¹æ®Šè¯´æ˜
            if (description.toLowerCase().includes('trevor')) {
                contentText += '\n\nåœ¨å´”ä½›å¸¦è¿‡ 4 åæ­è½¦äººï¼ˆä¸æ˜¯å¸¦äºº 4 æ¬¡ã€‚ä¸€æ¬¡å¸¦æ¥ 2 äººï¼Œè¿›åº¦åŠ  2ï¼‰åˆ°åˆ©ä»–è¥åœ°åï¼Œä¸é‚ªæ•™å¾’å‘ç”Ÿæªæˆ˜åè§£é”ã€‚';
            }

            const title = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'sp-hidden-packages-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;" id="sp-hidden-packages-title">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"/>
                <div style="display: none; padding: 40px; color: var(--gta-text-secondary); font-style: italic; text-align: center;">
                    å›¾ç‰‡åŠ è½½å¤±è´¥
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">ğŸ“ ä½ç½®ä¿¡æ¯</div>
                    ${contentText || 'å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼'}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="sp-hidden-packages-hide-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="sp-hidden-packages-show-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="sp-hidden-packages-close-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#sp-hidden-packages-close-btn');
            const hideBtn = popup.querySelector('#sp-hidden-packages-hide-btn');
            const showBtn = popup.querySelector('#sp-hidden-packages-show-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('#sp-hidden-packages-title');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'sp-hidden-packages-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('sp_hidden_packages', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰æ ‡è®°
        function applySpHiddenPackagesVisibilityCache() {
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('sp_hidden_packages');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== è¿·å¹»ä»™äººæŒé™†åœ°å¼¹çª—æ¨¡æ¿ ====================
        function showPeyoteSpLandImage(index) {
            // åºå·ä»1å¼€å§‹ï¼Œ1-9å‰é¢ä¸è¦å‡ºç°0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/land_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.peyote-sp-land-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.peyoteSpLandMarkers && window.peyoteSpLandMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸŒµ è¿·å¹»ä»™äººæŒé™†åœ° #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-land-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è¿·å¹»ä»™äººæŒé™†åœ° #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    æ•…äº‹æ¨¡å¼ä¸­ä¸€å…±æœ‰ 27 ä¸ªè¿·å¹»ä»™äººæŒï¼ˆ21 ä¸ªåœ¨é™†åœ°ä¸Šï¼Œ6 ä¸ªåœ¨æ°´ä¸‹ï¼‰ã€‚å½“æ‚¨é è¿‘å®ƒæ—¶ï¼Œæ‰‹æŸ„ä¼šæŒ¯åŠ¨ï¼Œè¿·å¹»ä»™äººæŒä¼šå‘å‡ºç±»ä¼¼åŠ¨ç‰©å«å£°çš„å£°éŸ³ã€‚åƒä¸‹ï¼ˆæŒ‰ä¸‹äº’åŠ¨é”®ï¼‰è¿·å¹»ä»™äººæŒåï¼Œæ‚¨ä¼šå˜æˆéšæœºåŠ¨ç‰©ä¸­çš„å…¶ä¸­ä¸€ç§ã€‚æ‚¨ä¼šä¸€ç›´ç»´æŒåŠ¨ç‰©å½¢æ€ï¼Œé™¤éæ‚¨ï¼šæ­»äº¡ã€å…¥æ°´/ä¸Šå²¸ã€æŒ‰ä½äº’åŠ¨é”®ã€‚æ‚¨é£Ÿç”¨æ‰€æœ‰è¿·å¹»ä»™äººæŒä¹‹åï¼Œåƒè¿‡çš„è¿·å¹»ä»™äººæŒå°†é‡æ–°å¯ç”¨ã€‚é£Ÿç”¨è¿‡æ‰€æœ‰é™†åœ°ä¸Šçš„è¿·å¹»ä»™äººæŒä¹‹åï¼Œæ‚¨å°†å¯åœ¨å¯¼æ¼”æ¨¡å¼é€‰ç”¨æ‰€æœ‰åŠ¨ç‰©ã€‚é€‰ç”¨å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ¼”å‘˜ï¼Œæ‚¨å°†è§£é”ä¸¤ä¸ªæˆå°±ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-peyote-sp-land-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-peyote-sp-land-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-land-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-land-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-land-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('peyote_sp_land', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸŒµ è¿·å¹»ä»™äººæŒé™†åœ° #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpLandSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸŒµ è¿·å¹»ä»™äººæŒé™†åœ° #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpLandSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== è¿·å¹»ä»™äººæŒé¸Ÿç±»å¼¹çª—æ¨¡æ¿ ====================
        function showPeyoteSpAirImage(index) {
            // åºå·ä»1å¼€å§‹ï¼Œ1-9å‰é¢ä¸è¦å‡ºç°0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/air_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.peyote-sp-air-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.peyoteSpAirMarkers && window.peyoteSpAirMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ¦… è¿·å¹»ä»™äººæŒé¸Ÿç±» #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-air-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è¿·å¹»ä»™äººæŒé¸Ÿç±» #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    æ•…äº‹æ¨¡å¼ä¸­ä¸€å…±æœ‰ 27 ä¸ªè¿·å¹»ä»™äººæŒï¼ˆ21 ä¸ªåœ¨é™†åœ°ä¸Šï¼Œ6 ä¸ªåœ¨æ°´ä¸‹ï¼‰ã€‚å½“æ‚¨é è¿‘å®ƒæ—¶ï¼Œæ‰‹æŸ„ä¼šæŒ¯åŠ¨ï¼Œè¿·å¹»ä»™äººæŒä¼šå‘å‡ºç±»ä¼¼åŠ¨ç‰©å«å£°çš„å£°éŸ³ã€‚åƒä¸‹ï¼ˆæŒ‰ä¸‹äº’åŠ¨é”®ï¼‰è¿·å¹»ä»™äººæŒåï¼Œæ‚¨ä¼šå˜æˆéšæœºåŠ¨ç‰©ä¸­çš„å…¶ä¸­ä¸€ç§ã€‚æ‚¨ä¼šä¸€ç›´ç»´æŒåŠ¨ç‰©å½¢æ€ï¼Œé™¤éæ‚¨ï¼šæ­»äº¡ã€å…¥æ°´/ä¸Šå²¸ã€æŒ‰ä½äº’åŠ¨é”®ã€‚æ‚¨é£Ÿç”¨æ‰€æœ‰è¿·å¹»ä»™äººæŒä¹‹åï¼Œåƒè¿‡çš„è¿·å¹»ä»™äººæŒå°†é‡æ–°å¯ç”¨ã€‚é£Ÿç”¨è¿‡æ‰€æœ‰é™†åœ°ä¸Šçš„è¿·å¹»ä»™äººæŒä¹‹åï¼Œæ‚¨å°†å¯åœ¨å¯¼æ¼”æ¨¡å¼é€‰ç”¨æ‰€æœ‰åŠ¨ç‰©ã€‚é€‰ç”¨å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ¼”å‘˜ï¼Œæ‚¨å°†è§£é”ä¸¤ä¸ªæˆå°±ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-peyote-sp-air-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-peyote-sp-air-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-air-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-air-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-air-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('peyote_sp_air', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ¦… è¿·å¹»ä»™äººæŒé¸Ÿç±» #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpAirSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ¦… è¿·å¹»ä»™äººæŒé¸Ÿç±» #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpAirSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== è¿·å¹»ä»™äººæŒæ°´ä¸‹å¼¹çª—æ¨¡æ¿ ====================
        function showPeyoteSpWaterImage(index) {
            // åºå·ä»1å¼€å§‹ï¼Œ1-9å‰é¢ä¸è¦å‡ºç°0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/water_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.peyote-sp-water-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.peyoteSpWaterMarkers && window.peyoteSpWaterMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸŒŠ è¿·å¹»ä»™äººæŒæ°´ä¸‹ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-water-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è¿·å¹»ä»™äººæŒæ°´ä¸‹ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    æ•…äº‹æ¨¡å¼ä¸­ä¸€å…±æœ‰ 27 ä¸ªè¿·å¹»ä»™äººæŒï¼ˆ21 ä¸ªåœ¨é™†åœ°ä¸Šï¼Œ6 ä¸ªåœ¨æ°´ä¸‹ï¼‰ã€‚å½“æ‚¨é è¿‘å®ƒæ—¶ï¼Œæ‰‹æŸ„ä¼šæŒ¯åŠ¨ï¼Œè¿·å¹»ä»™äººæŒä¼šå‘å‡ºç±»ä¼¼åŠ¨ç‰©å«å£°çš„å£°éŸ³ã€‚åƒä¸‹ï¼ˆæŒ‰ä¸‹äº’åŠ¨é”®ï¼‰è¿·å¹»ä»™äººæŒåï¼Œæ‚¨ä¼šå˜æˆéšæœºåŠ¨ç‰©ä¸­çš„å…¶ä¸­ä¸€ç§ã€‚æ‚¨ä¼šä¸€ç›´ç»´æŒåŠ¨ç‰©å½¢æ€ï¼Œé™¤éæ‚¨ï¼šæ­»äº¡ã€å…¥æ°´/ä¸Šå²¸ã€æŒ‰ä½äº’åŠ¨é”®ã€‚æ‚¨é£Ÿç”¨æ‰€æœ‰è¿·å¹»ä»™äººæŒä¹‹åï¼Œåƒè¿‡çš„è¿·å¹»ä»™äººæŒå°†é‡æ–°å¯ç”¨ã€‚é£Ÿç”¨è¿‡æ‰€æœ‰é™†åœ°ä¸Šçš„è¿·å¹»ä»™äººæŒä¹‹åï¼Œæ‚¨å°†å¯åœ¨å¯¼æ¼”æ¨¡å¼é€‰ç”¨æ‰€æœ‰åŠ¨ç‰©ã€‚é€‰ç”¨å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ¼”å‘˜ï¼Œæ‚¨å°†è§£é”ä¸¤ä¸ªæˆå°±ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-peyote-sp-water-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-peyote-sp-water-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-water-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-water-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-water-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('peyote_sp_water', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸŒŠ è¿·å¹»ä»™äººæŒæ°´ä¸‹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpWaterSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸŒŠ è¿·å¹»ä»™äººæŒæ°´ä¸‹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpWaterSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== è¿·å¹»ä»™äººæŒé‡‘è‰²å¼¹çª—æ¨¡æ¿ ====================
        function showPeyoteSpSpecialImage(index) {
            // åºå·ä»1å¼€å§‹ï¼Œ1-9å‰é¢ä¸è¦å‡ºç°0
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/peyote_sp/special_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.peyote-sp-special-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.peyoteSpSpecialMarkers && window.peyoteSpSpecialMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // æ˜ŸæœŸå‡ çš„æ˜ å°„ï¼ˆæŒ‰æ¨ªåæ ‡é€’å¢ï¼‰
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const currentWeekDay = weekDays[index] || 'æœªçŸ¥';

            const title = `âœ¨ è¿·å¹»ä»™äººæŒé‡‘è‰² #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'peyote-sp-special-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="è¿·å¹»ä»™äººæŒé‡‘è‰² #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #FFC107; margin-bottom: 5px;">ğŸ“… å‡ºç°æ—¶é—´ï¼šæ˜ŸæœŸ${currentWeekDay}</div>
                    é‡‘è‰²ä»™äººæŒåœ¨è¾¾æˆ 100% å®Œæˆåº¦ã€å®Œæˆé™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡æœ«ä»£å·¨å…½ï¼ˆå¯Œå…°å…‹æ—ï¼‰ï¼Œå¹¶åƒå®Œæ‰€æœ‰æ™®é€šä»™äººæŒåè§£é”ã€‚é‡‘è‰²ä»™äººæŒå°†æ ¹æ®æ¸¸æˆä¸­çš„æ˜ŸæœŸå‡ ç”Ÿæˆåœ¨åœ°å›¾ä¸Šçš„ä¸åŒä½ç½®ï¼Œä¸”ä»…åœ¨å¤§é›¾å¤©æ°”çš„æ—©ä¸Š 530 åˆ° 800 æœŸé—´å‡ºç°ã€‚é£Ÿç”¨å®ƒä»¬ä¼šè®©æ‚¨å˜æˆå¤§è„šæ€ªã€‚æ‚¨åŒæ—¶è¿˜ä¼šåœ¨å¯¼æ¼”æ¨¡å¼ä¸­è§£é”å¤§è„šæ€ªã€‚ä¾æ¬¡ä»å‘¨æ—¥åˆ°ä¸‹å‘¨å…­åƒä¸‹é‡‘è‰²ä»™äººæŒï¼Œæ‚¨å°†åœ¨å˜èº«åçœ‹åˆ°ä¸€å…·åŠ¨ç‰©æˆ–äººçš„å°¸ä½“ã€‚åƒä¸‹æœ€åä¸€ä¸ªä»™äººæŒåï¼Œæ‚¨å°†å‘ç°ä»»åŠ¡æœ«ä»£å·¨å…½ä¸­çš„çŒäººçš„å°¸ä½“ã€‚æ­¤æ—¶ï¼Œæ‚¨åº”è¯¥ç»§ç»­ä½¿ç”¨æ½œè¡Œæ¨¡å¼ï¼ˆCtrlï¼‰å€¾å¬å¹¶ç»§ç»­è¿½è¸ªã€‚æ‚¨å°†ä¼šæ‰¾åˆ°æ›´å¤šçš„å°¸ä½“ã€‚æœ€ç»ˆï¼Œæ‚¨å°†åœ¨æ±¤å§†æ£®åºŸè½¦åœºè¿›è¡Œå¤§è„šæ€ªå¤§æˆ˜é‡å…½äº‹ä»¶ã€‚å¦‚æœæ‚¨èµ¢å¾—è¿™åœºæˆ˜æ–—ï¼Œæ‚¨å°†åœ¨å¯¼æ¼”æ¨¡å¼ä¸­è§£é”é‡å…½ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-peyote-sp-special-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-peyote-sp-special-btn');
            const hideBtn = popup.querySelector('#hide-peyote-sp-special-btn');
            const showBtn = popup.querySelector('#show-peyote-sp-special-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'peyote-sp-special-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('peyote_sp_special', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `âœ¨ è¿·å¹»ä»™äººæŒé‡‘è‰² #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpSpecialSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `âœ¨ è¿·å¹»ä»™äººæŒé‡‘è‰² #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePeyoteSpSpecialSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== è¿·å¹»ä»™äººæŒè®¡æ•°å™¨å‡½æ•° ====================
        
        // è¿·å¹»ä»™äººæŒé™†åœ°è®¡æ•°å™¨
        function updatePeyoteSpLandSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_land + label .peyote-sp-land-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpLandMarkers && window.peyoteSpLandMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_land) ? window.itemData.peyote_sp_land.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('peyote_sp_land');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_land', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è¿·å¹»ä»™äººæŒé™†åœ°è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // è¿·å¹»ä»™äººæŒé¸Ÿç±»è®¡æ•°å™¨
        function updatePeyoteSpAirSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_air + label .peyote-sp-air-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpAirMarkers && window.peyoteSpAirMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_air) ? window.itemData.peyote_sp_air.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('peyote_sp_air');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_air', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è¿·å¹»ä»™äººæŒé¸Ÿç±»è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // è¿·å¹»ä»™äººæŒæ°´ä¸‹è®¡æ•°å™¨
        function updatePeyoteSpWaterSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_water + label .peyote-sp-water-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpWaterMarkers && window.peyoteSpWaterMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_water) ? window.itemData.peyote_sp_water.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('peyote_sp_water');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_water', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è¿·å¹»ä»™äººæŒæ°´ä¸‹è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // è¿·å¹»ä»™äººæŒé‡‘è‰²è®¡æ•°å™¨
        function updatePeyoteSpSpecialSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-peyote_sp_special + label .peyote-sp-special-counter');
                if (!counterEl) return;

                const markers = (window.peyoteSpSpecialMarkers && window.peyoteSpSpecialMarkers) || [];
                const total = Array.isArray(window.itemData?.peyote_sp_special) ? window.itemData.peyote_sp_special.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('peyote_sp_special');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('peyote_sp_special', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°è¿·å¹»ä»™äººæŒé‡‘è‰²è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆå®‡å®™é£èˆ¹éƒ¨ä»¶æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º spaceship_parts å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSpaceshipPartsCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.spaceship-parts-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'spaceship-parts-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSpaceshipPartsSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSpaceshipPartsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-spaceship_parts + label .spaceship-parts-counter');
                if (!counterEl) return;

                // è·å–å®‡å®™é£èˆ¹éƒ¨ä»¶æ ‡è®°
                const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
                const total = Array.isArray(window.itemData?.spaceship_parts) ? window.itemData.spaceship_parts.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('spaceship_parts');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('spaceship_parts', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°å®‡å®™é£èˆ¹éƒ¨ä»¶è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // å®‡å®™é£èˆ¹éƒ¨ä»¶å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSpaceshipPartsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/spaceship_parts/spaceship_parts_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.spaceship-parts-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ›¸ å®‡å®™é£èˆ¹éƒ¨ä»¶ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'spaceship-parts-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="å®‡å®™é£èˆ¹éƒ¨ä»¶ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ¸¸æˆä¸­æ€»å…±æœ‰ 50 ä¸ªå®‡å®™é£èˆ¹éƒ¨ä»¶ï¼Œè¦æ”¶é›†è¿™äº›éƒ¨ä»¶ï¼Œæ‚¨å¿…é¡»å®Œæˆé™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡æœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼ˆå¯Œå…°å…‹æ—ï¼‰ã€‚<br>
                    æ¯ä¸ªè§’è‰²éƒ½å¯ä»¥æ‹¾å–éƒ¨ä»¶ã€‚å°æŸ¥è¿˜å¯ä»¥å¸®åŠ©å¯Œå…°å…‹æ—æ‰¾åˆ°å®ƒé™„è¿‘çš„éƒ¨ä»¶ã€‚æ”¶é›†æ‰€æœ‰ 50 ä¸ªå®‡å®™é£èˆ¹éƒ¨ä»¶æ˜¯ 100% å®Œæˆåº¦çš„è¦æ±‚ä¹‹ä¸€ã€‚<br><br>
                    æ”¶é›†æ‰€æœ‰å®‡å®™é£èˆ¹ç¢ç‰‡ï¼Œæ‚¨å°†è§£é”é™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡å†²å‘å¤–å¤ªç©ºï¼ˆå¯Œå…°å…‹æ—ï¼‰ã€‚å®Œæˆæ­¤ä»»åŠ¡å°†è§£é”ä¸€ä¸ªæˆå°±ï¼Œä»¥åŠè½½å…·å¤ªç©ºç å¤´å·¥ã€‚æ­¤è½½å…·ä¼šåœ¨ä»»æ„è§’è‰²è½¦åº“ä¸­çš„ç‰¹æ®Šè½½å…·èœå•ä¸­è§£é”ã€‚å®Œæˆæ­¤ä»»åŠ¡æ˜¯ 100% å®Œæˆåº¦çš„è¦æ±‚ä¹‹ä¸€ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-spaceship-parts-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-spaceship-parts-btn');
            const hideBtn = popup.querySelector('#hide-spaceship-parts-btn');
            const showBtn = popup.querySelector('#show-spaceship-parts-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'spaceship-parts-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('spaceship_parts', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ›¸ å®‡å®™é£èˆ¹éƒ¨ä»¶ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpaceshipPartsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ›¸ å®‡å®™é£èˆ¹éƒ¨ä»¶ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpaceshipPartsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å®‡å®™é£èˆ¹éƒ¨ä»¶æ ‡è®°
        function applySpaceshipPartsVisibilityCache() {
            const markers = (window.spaceshipPartsMarkers && window.spaceshipPartsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('spaceship_parts');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨å®‡å®™é£èˆ¹éƒ¨ä»¶å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°çº¸ç‰Œæ ‡è®°
        function applyPlayingCardsVisibilityCache() {
            const markers = (window.playingCardsMarkers && window.playingCardsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('playing_cards');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨çº¸ç‰Œå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å…ƒå®æ ‡è®°
        function applyYuanbaoVisibilityCache() {
            const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('yuanbao');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨å…ƒå®å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ‰‹åŠå¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showActionFiguresImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/action_figures/action_figures_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.action-figures-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ­ æ‰‹åŠ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'action-figures-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ‰‹åŠ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(233, 30, 99, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(233, 30, 99, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #E91E63; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                        æ”¶é›†æ‰€æœ‰æ‰‹åŠå¯è·å¾—ï¼šç‰¹æ®Šè½½å…·å¥–åŠ±ã€æ¸¸æˆå¸å¥–åŠ±ã€è§£é”éšè—æˆå°±
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-action-figures-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-action-figures-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-action-figures-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-action-figures-btn');
            const hideBtn = popup.querySelector('#hide-action-figures-btn');
            const showBtn = popup.querySelector('#show-action-figures-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'action-figures-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('action_figures', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ­ æ‰‹åŠ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateActionFiguresSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ­ æ‰‹åŠ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateActionFiguresSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ‰‹åŠæ ‡è®°
        function applyActionFiguresVisibilityCache() {
            const markers = (window.actionFiguresMarkers && window.actionFiguresMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('action_figures');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ‰‹åŠå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // å…ƒå®å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showYuanbaoImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/yuanbao/yuanbao_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.yuanbao-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.yuanbaoMarkers && window.yuanbaoMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸª™ å…ƒå® #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'yuanbao-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="å…ƒå® #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #B8860B; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        æ”¶é›†æ‰€æœ‰å…ƒå®å¯è·å¾—ï¼š<br>
                        â€¢ é«˜é¢æ¸¸æˆå¸å¥–åŠ±<br>
                        â€¢ ç‰¹æ®Šæœè£…å¥–åŠ±<br>
                        â€¢ è§£é”éšè—æˆå°±
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-yuanbao-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-yuanbao-btn');
            const hideBtn = popup.querySelector('#hide-yuanbao-btn');
            const showBtn = popup.querySelector('#show-yuanbao-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'yuanbao-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('yuanbao', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸª™ å…ƒå® #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateYuanbaoSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸª™ å…ƒå® #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateYuanbaoSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }


        // æ˜¾ç¤ºç”µè¯æš—æ€å›¾ç‰‡å¼¹çª—
        function showPayphoneHitsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;            
            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'payphone-hits-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #E91E63;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // å¼¹çª—å†…å®¹
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #C2185B;">
                    ğŸ“ ç”µè¯æš—æ€ #${sequenceNumber}
                </div>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #E91E63;">
                    <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">ğŸ¯ ä»»åŠ¡è¯´æ˜</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        éœ€è¦è´­ä¹°äº‹åŠ¡æ‰€å®Œæˆä¸€ä¸ªå®‰ä¿åˆçº¦è§£é”
                    </div>
                </div>
                <button id="hide-payphone-hits-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #E91E63; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    éšè—æ ‡è®°
                </button>
                <button id="close-payphone-hits-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    å…³é—­
                </button>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);

            // æ·»åŠ éšè—æŒ‰é’®äº‹ä»¶ç›‘å¬
            const hideBtn = popup.querySelector('#hide-payphone-hits-btn');
            hideBtn.addEventListener('click', () => {
                 // æ‰¾åˆ°å¯¹åº”çš„æ ‡è®°å¹¶è®¾ç½®é€æ˜åº¦ä¸º25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('payphone_hits') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // å°†éšè—æŒ‰é’®æ”¹ä¸ºæ˜¾ç¤ºæŒ‰é’®
                         hideBtn.textContent = 'æ˜¾ç¤º';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-payphone-hits-btn';
                         
                         // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ æ–°çš„æ˜¾ç¤ºäº‹ä»¶
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // æ¢å¤é€æ˜åº¦ä¸º100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
            const closeBtn = popup.querySelector('#close-payphone-hits-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // æ˜¾ç¤ºé«˜å°”å¤«çƒæ´å›¾ç‰‡å¼¹çª—
        function showGolfHolesImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/golf_holes/golf_holes_${sequenceNumber}.webp`;
            
            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'golf-holes-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // å¼¹çª—å†…å®¹
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #2E7D32;">
                    â›³ é«˜å°”å¤«çƒæ´ #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="é«˜å°”å¤«çƒæ´ #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <div style="font-weight: bold; color: #2E7D32; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        å®Œæˆæ‰€æœ‰é«˜å°”å¤«çƒæ´æŒ‘æˆ˜å¯è·å¾—ç‰¹æ®Šå¥–åŠ±
                    </div>
                </div>
                <button id="hide-golf-holes-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #4CAF50; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    éšè—æ ‡è®°
                </button>
                <button id="close-golf-holes-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    å…³é—­
                </button>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);

            // æ·»åŠ éšè—æŒ‰é’®äº‹ä»¶ç›‘å¬
            const hideBtn = popup.querySelector('#hide-golf-holes-btn');
            hideBtn.addEventListener('click', () => {
                 // æ‰¾åˆ°å¯¹åº”çš„æ ‡è®°å¹¶è®¾ç½®é€æ˜åº¦ä¸º25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('golf_holes') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // å°†éšè—æŒ‰é’®æ”¹ä¸ºæ˜¾ç¤ºæŒ‰é’®
                         hideBtn.textContent = 'æ˜¾ç¤º';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-golf-holes-btn';
                         
                         // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ æ–°çš„æ˜¾ç¤ºäº‹ä»¶
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // æ¢å¤é€æ˜åº¦ä¸º100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
            const closeBtn = popup.querySelector('#close-golf-holes-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // å–·ç½ä½ç½®å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSprayImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/spray/spray_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.spray-popup');
            if (existingPopup) existingPopup.remove();

            // è®¡æ•°å™¨å›ºå®šä¸º1ï¼Œéšè—ä¸€ä¸ªæ ‡è®°åéšè—å…¨éƒ¨å›¾æ ‡
            const totalCount = 1;
            
            // æ£€æŸ¥å½“å‰éšè—çŠ¶æ€ï¼ˆä»ç¼“å­˜è·å–ï¼‰
            const cachedCounter = CounterCache.getCounter('spray');
            const hiddenCount = cachedCounter.hidden || 0;
            const isCurrentHidden = hiddenCount > 0;

            const title = `ğŸ¨ å–·ç½ä½ç½® #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'spray-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="å–·ç½ä½ç½® #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">ğŸ¯ æ”¶é›†è¯´æ˜</div>
                    æ‰¾åˆ°å–·ç½ä½ç½®ï¼Œæ”¶é›†å–·ç½é“å…·ï¼
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-spray-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-spray-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-spray-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-spray-btn');
            const hideBtn = popup.querySelector('#hide-spray-btn');
            const showBtn = popup.querySelector('#show-spray-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'spray-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºæ‰€æœ‰å–·ç½æ ‡è®°
            function setAllSprayVisibility(opacity) {
                const markers = (window.sprayMarkers && window.sprayMarkers) || [];
                markers.forEach((marker) => {
                    if (marker && typeof marker.setOpacity === 'function') {
                        marker.setOpacity(opacity);
                    } else if (marker && typeof marker.setStyle === 'function') {
                        marker.setStyle({ opacity });
                    }
                });
                
                // æ›´æ–°ç¼“å­˜çŠ¶æ€ - å›ºå®šè®¡æ•°å™¨ä¸º1
                const newHiddenCount = opacity === 0.3 ? 1 : 0;
                CounterCache.updateCounter('spray', newHiddenCount, 1);
                VisibilityCache.updateItemVisibility('spray', 0, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setAllSprayVisibility(0.3);
                    titleElement.textContent = `ğŸ¨ å–·ç½ä½ç½® #${sequenceNumber} (1/1)`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpraySidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setAllSprayVisibility(1);
                    titleElement.textContent = `ğŸ¨ å–·ç½ä½ç½® #${sequenceNumber} (0/1)`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpraySidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // ç‰¹æŠ€è·³è·ƒç‚¹å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showStuntJumpsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/stunt_jumps/stunt_jumps_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.stunt-jumps-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.stuntJumpsMarkers && window.stuntJumpsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸš€ ç‰¹æŠ€è·³è·ƒç‚¹ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'stunt-jumps-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="ç‰¹æŠ€è·³è·ƒç‚¹ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(56, 142, 60, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(56, 142, 60, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">ğŸ¯ æŒ‘æˆ˜è¯´æ˜</div>
                        é©¾é©¶è½¦è¾†å®Œæˆç‰¹æŠ€è·³è·ƒï¼Œè·å¾—é«˜åˆ†å’Œå¥–åŠ±ï¼
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-stunt-jumps-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-stunt-jumps-btn');
            const hideBtn = popup.querySelector('#hide-stunt-jumps-btn');
            const showBtn = popup.querySelector('#show-stunt-jumps-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'stunt-jumps-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('stunt_jumps', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸš€ ç‰¹æŠ€è·³è·ƒç‚¹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStuntJumpsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸš€ ç‰¹æŠ€è·³è·ƒç‚¹ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateStuntJumpsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // é›ªäººå¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSnowmenImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/snowmen/snowmen_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.snowmen-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.snowmenMarkers && window.snowmenMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `â›„ é›ªäºº #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'snowmen-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="é›ªäºº #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(3, 169, 244, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(3, 169, 244, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #0288D1; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                        æ”¶é›†æ‰€æœ‰é›ªäººå¯è·å¾—å†¬å­£ä¸»é¢˜å¥–åŠ±
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-snowmen-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-snowmen-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-snowmen-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-snowmen-btn');
            const hideBtn = popup.querySelector('#hide-snowmen-btn');
            const showBtn = popup.querySelector('#show-snowmen-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'snowmen-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('snowmen', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `â›„ é›ªäºº #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSnowmenSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `â›„ é›ªäºº #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSnowmenSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // è·³ä¼å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSkydivesPopup(item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.skydives-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
            const totalCount = 10; // å›ºå®š10ä¸ªè·³ä¼ä½ç½®

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸª‚ è·³ä¼æŒ‘æˆ˜ #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'skydives-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="font-weight: bold; color: #2196F3; margin-bottom: 8px; font-size: 16px;">ğŸ—ºï¸ åœ°ç‚¹</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.name || 'æœªçŸ¥åœ°ç‚¹'}</div>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ğŸ† <strong>æ¯æ—¥è·³ä¼æŒ‘æˆ˜</strong><br>
                    â€¢ æ¯å¤©å…±æœ‰10ä¸ªè·³ä¼ä½ç½®<br>
                    â€¢ å®Œæˆå¯è·å¾—<strong>ç»éªŒå€¼</strong>å’Œ<strong>æ¸¸æˆå¸å¥–åŠ±</strong><br>
                    â€¢ ä»é«˜ç©ºè·³ä¸‹ï¼Œä½“éªŒæé™åˆºæ¿€ï¼
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-skydives-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-skydives-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-skydives-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-skydives-btn');
            const hideBtn = popup.querySelector('#hide-skydives-btn');
            const showBtn = popup.querySelector('#show-skydives-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('skydives', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸª‚ è·³ä¼æŒ‘æˆ˜ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSkydivesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸª‚ è·³ä¼æŒ‘æˆ˜ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSkydivesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°è·³ä¼æ ‡è®°
        function applySkydivesVisibilityCache() {
            const markers = (window.skydivesMarkers && window.skydivesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('skydives');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨è·³ä¼å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // å…¼å®¹ï¼šæ—§è°ƒç”¨åˆ«åï¼ˆä¿®å¤ ReferenceErrorï¼‰
        function showSkydivesImage(index) {
            const item = (itemData.skydives && itemData.skydives[index]) || null;
            if (!item) return;
            showSkydivesPopup(item, index);
        }


        // æ˜¾ç¤ºæ°æ‹‰å¾·åŒ…è£¹å›¾ç‰‡å¼¹çª—
        function showDeadDropImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/dead_drop/dead_drop_${sequenceNumber}.webp`;
            
            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'dead-drop-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #9C6EAF;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 80vw;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // å¼¹çª—å†…å®¹
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #9C6EAF;">
                    ğŸ“¦ æ°æ‹‰å¾·åŒ…è£¹ #${sequenceNumber}
                </div>
                <img src="${imageUrl}" 
                     alt="æ°æ‹‰å¾·åŒ…è£¹ #${sequenceNumber}" 
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 15px;">
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9C6EAF;">
                    <div style="font-weight: bold; color: #9C6EAF; margin-bottom: 5px;">ğŸ¯ ä»»åŠ¡è¯´æ˜</div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        æ°æ‹‰å¾·æä¾›çš„ç§˜å¯†åŒ…è£¹æŠ•é€’ç‚¹ï¼Œå®Œæˆå¯è·å¾—ä¸°åšå¥–åŠ±
                    </div>
                </div>
                <button id="hide-dead-drop-btn" 
                        style="padding: 10px 20px; margin-right: 10px;
                               background: #9C6EAF; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    éšè—æ ‡è®°
                </button>
                <button id="close-dead-drop-btn" 
                        style="padding: 10px 20px; 
                               background: #f44336; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               transition: background-color 0.3s;">
                    å…³é—­
                </button>
                
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);

            // æ·»åŠ éšè—æŒ‰é’®äº‹ä»¶ç›‘å¬
            const hideBtn = popup.querySelector('#hide-dead-drop-btn');
            hideBtn.addEventListener('click', () => {
                 // æ‰¾åˆ°å¯¹åº”çš„æ ‡è®°å¹¶è®¾ç½®é€æ˜åº¦ä¸º25%
                 document.querySelectorAll('.item-marker').forEach(marker => {
                     const img = marker.querySelector('img');
                     if (img && img.src && img.src.includes('dead_drop') && marker.dataset.index == index) {
                         marker.style.opacity = '0.25';
                         // å°†éšè—æŒ‰é’®æ”¹ä¸ºæ˜¾ç¤ºæŒ‰é’®
                         hideBtn.textContent = 'æ˜¾ç¤º';
                         hideBtn.style.background = '#2196F3';
                         hideBtn.id = 'show-dead-drop-btn';
                         
                         // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ æ–°çš„æ˜¾ç¤ºäº‹ä»¶
                         const newShowBtn = hideBtn.cloneNode(true);
                         hideBtn.replaceWith(newShowBtn);
                         newShowBtn.addEventListener('click', () => {
                             // æ¢å¤é€æ˜åº¦ä¸º100%
                             const currentMarker = document.querySelector(`.item-marker[data-index="${index}"]`);
                             if (currentMarker) {
                                 currentMarker.style.opacity = '1';
                             }
                             popup.remove();
                         });
                     }
                 });
             });

            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
            const closeBtn = popup.querySelector('#close-dead-drop-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);
        }

        // æœ‰æœºåŠäº§å“å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showOrganicFarmImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            // ä¿®å¤å›¾ç‰‡é“¾æ¥é€»è¾‘ï¼Œç¬¬1-9ä¸ªä¸è¦å¸¦0
            const imageUrl = sequenceNumber <= 9 
                ? `https://gta-maps.antwen.com/collectibles_images/ld_organics/ld_organics_${sequenceNumber}.webp`
                : `https://gta-maps.antwen.com/collectibles_images/ld_organics/ld_organics_${sequenceNumber.toString().padStart(2, '0')}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.organic-farm-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.organicFarmMarkers && window.organicFarmMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸŒ¿ æœ‰æœºåŠäº§å“ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'organic-farm-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æœ‰æœºåŠäº§å“ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #4CAF50; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                        æ”¶é›†å…¨éƒ¨æœ‰æœºåŠäº§å“å¯è·å¾—ç‰¹æ®Šè¡£æœå’Œå¸½å­å¥–åŠ±ï¼
                    </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-organic-farm-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-organic-farm-btn');
            const hideBtn = popup.querySelector('#hide-organic-farm-btn');
            const showBtn = popup.querySelector('#show-organic-farm-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'organic-farm-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ld_organics_products', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸŒ¿ æœ‰æœºåŠäº§å“ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateOrganicFarmSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸŒ¿ æœ‰æœºåŠäº§å“ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateOrganicFarmSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

    // é¡¶éƒ¨ old select å·²ç§»é™¤ï¼›ä¾§è¾¹æ å¤é€‰æ¡†ä¸ reset æŒ‰é’®ç®¡ç† activeItemTypes

        // åœ°å›¾äº‹ä»¶
        map.on('move', updateTilePanePosition); // æ”¹ä¸ºmoveäº‹ä»¶å®ç°å®æ—¶è·Ÿéš
        map.on('moveend', updateTilePanePosition);
        map.on('zoom', updateTilePanePosition); // æ·»åŠ  zoom äº‹ä»¶ç›‘å¬ï¼Œåœ¨ç¼©æ”¾è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°æ ‡è®°ä½ç½®
        map.on('zoomend', () => {
            const z = map.getZoom();
            const centerPixel = map.project(map.getCenter(), z);
            resetViewForZoom(z, { x: centerPixel.x, y: centerPixel.y });
            updateTilePanePosition();
            probeTilesForStyleAndZoom(currentStyle, z);

        });

        // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ£€æµ‹åæ ‡å€¼
        const mapContainer = document.getElementById('map-container');
        mapContainer.addEventListener('click', (e) => {
            // è·å–ç‚¹å‡»ä½ç½®ç›¸å¯¹äºåœ°å›¾å®¹å™¨çš„åæ ‡
            const rect = mapContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            const z = map.getZoom();
            const level = getLevelByZoom(z);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            // DOM æ ‡è®°å±‚å·²ç§»é™¤ï¼Œæ— éœ€è¯»å– transform åç§»
            const translateX = 0;
            const translateY = 0;
            
            // è®¡ç®—ç‚¹å‡»ä½ç½®åœ¨ç“¦ç‰‡å®¹å™¨ä¸­çš„åƒç´ åæ ‡
            const tileX = clickX - translateX;
            const tileY = clickY - translateY;
            
            // å°†åƒç´ åæ ‡è½¬æ¢ä¸ºæ¸¸æˆåæ ‡
            const percentX = tileX / totalWidth;
            const percentY = tileY / totalHeight;
            
            const gameX = GAME_LEFT + percentX * (GAME_RIGHT - GAME_LEFT);
            const gameY = GAME_TOP - percentY * (GAME_TOP - GAME_BOTTOM);
            
            console.log('ç‚¹å‡»åæ ‡:', {
                container: { x: clickX, y: clickY },
                tile: { x: tileX, y: tileY },
                game: { x: gameX.toFixed(2), y: gameY.toFixed(2) }
            });

        });

        // æ£€æµ‹æ­¦å™¨å¢å‹è½¦ç‚¹å‡»
        function checkGunVanClick(clickX, clickY) {
            const GUN_VAN_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ­¦å™¨å¢å‹è½¦ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('gun_van') && itemData.gun_van) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æ­¦å™¨å¢å‹è½¦é™„è¿‘
                const nearbyVan = itemData.gun_van.find(van => {
                    const distance = Math.sqrt(Math.pow(van.x - clickX, 2) + Math.pow(van.y - clickY, 2));
                    return distance <= GUN_VAN_RADIUS;
                });

                if (nearbyVan) {
                    console.log('ç‚¹å‡»äº†æ­¦å™¨å¢å‹è½¦é™„è¿‘:', nearbyVan.name);
                    showGunVanWeapons();
                }
            }
        }

        // æ£€æµ‹è¡—å¤´æ¯’è´©ç‚¹å‡»
        function checkStreetDealersClick(clickX, clickY) {
            const STREET_DEALER_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè¡—å¤´æ¯’è´©ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('street_dealers') && itemData.street_dealers) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è¡—å¤´æ¯’è´©é™„è¿‘
                const nearbyDealer = itemData.street_dealers.find(dealer => {
                    const distance = Math.sqrt(Math.pow(dealer.x - clickX, 2) + Math.pow(dealer.y - clickY, 2));
                    return distance <= STREET_DEALER_RADIUS;
                });

                if (nearbyDealer) {
                    const index = itemData.street_dealers.findIndex(dealer => 
                        dealer.x === nearbyDealer.x && dealer.y === nearbyDealer.y
                    );
                    console.log('ç‚¹å‡»äº†è¡—å¤´æ¯’è´©é™„è¿‘:', nearbyDealer.name);
                    showStreetDealersPopup(nearbyDealer, index);
                }
            }
        }

        // æ£€æµ‹æœ‰æœºåŠäº§å“ç‚¹å‡»
        function checkOrganicFarmClick(clickX, clickY) {
            const ORGANIC_FARM_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæœ‰æœºåŠäº§å“ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ld_organics_products') && itemData.ld_organics_products) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æœ‰æœºåŠäº§å“é™„è¿‘
                const nearbyProduct = itemData.ld_organics_products.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= ORGANIC_FARM_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('ç‚¹å‡»äº†æœ‰æœºåŠäº§å“é™„è¿‘:', nearbyProduct.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const productIndex = itemData.ld_organics_products.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showOrganicFarmImage(productIndex);
                }
            }
        }

        // æ£€æµ‹ä¿¡å·å¹²æ‰°å™¨ç‚¹å‡»
        function checkSignalJammerClick(clickX, clickY) {
            const SIGNAL_JAMMER_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºä¿¡å·å¹²æ‰°å™¨ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('signal_jammers') && itemData.signal_jammers) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„ä¿¡å·å¹²æ‰°å™¨é™„è¿‘
                const nearbyJammer = itemData.signal_jammers.find((jammer, index) => {
                    const distance = Math.sqrt(Math.pow(jammer.x - clickX, 2) + Math.pow(jammer.y - clickY, 2));
                    return distance <= SIGNAL_JAMMER_RADIUS;
                });

                if (nearbyJammer) {
                    console.log('ç‚¹å‡»äº†ä¿¡å·å¹²æ‰°å™¨é™„è¿‘:', nearbyJammer.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const jammerIndex = itemData.signal_jammers.findIndex(jammer => 
                        jammer.x === nearbyJammer.x && jammer.y === nearbyJammer.y
                    );
                    showSignalJammerImage(jammerIndex);
                }
            }
        }

        // æ£€æµ‹å—ç“œç¯ç‚¹å‡»
        function checkJackOLanternClick(clickX, clickY) {
            const JACK_O_LANTERN_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå—ç“œç¯ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('jack_o_lanterns') && itemData.jack_o_lanterns) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å—ç“œç¯é™„è¿‘
                const nearbyLantern = itemData.jack_o_lanterns.find((lantern, index) => {
                    const distance = Math.sqrt(Math.pow(lantern.x - clickX, 2) + Math.pow(lantern.y - clickY, 2));
                    return distance <= JACK_O_LANTERN_RADIUS;
                });

                if (nearbyLantern) {
                    console.log('ç‚¹å‡»äº†å—ç“œç¯é™„è¿‘:', nearbyLantern.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const lanternIndex = itemData.jack_o_lanterns.findIndex(lantern => 
                        lantern.x === nearbyLantern.x && lantern.y === nearbyLantern.y
                    );
                    showJackOLanternImage(lanternIndex);
                }
            }
        }
        
        // æ£€æµ‹LSæ¶‚é¸¦ç‚¹å‡»
        function checkLSTagsClick(clickX, clickY) {
            const LS_TAGS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºLSæ¶‚é¸¦ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ls_tags') && itemData.ls_tags) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„LSæ¶‚é¸¦é™„è¿‘
                const nearbyTag = itemData.ls_tags.find((tag, index) => {
                    const distance = Math.sqrt(Math.pow(tag.x - clickX, 2) + Math.pow(tag.y - clickY, 2));
                    return distance <= LS_TAGS_RADIUS;
                });

                if (nearbyTag) {
                    const index = itemData.ls_tags.findIndex(tag => 
                        tag.x === nearbyTag.x && tag.y === nearbyTag.y
                    );
                    console.log('ç‚¹å‡»äº†LSæ¶‚é¸¦é™„è¿‘:', nearbyTag.name || `LSæ¶‚é¸¦ #${nearbyTag.sequenceNumber}`);
                    showLSTagsPopup(nearbyTag, index);
                }
            }
        }
        
        
        // æ£€æµ‹çº¸ç‰Œç‚¹å‡»
        function checkPlayingCardsClick(clickX, clickY) {
            const PLAYING_CARDS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºçº¸ç‰Œï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('playing_cards') && itemData.playing_cards) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„çº¸ç‰Œé™„è¿‘
                const nearbyCard = itemData.playing_cards.find((card, index) => {
                    const distance = Math.sqrt(Math.pow(card.x - clickX, 2) + Math.pow(card.y - clickY, 2));
                    return distance <= PLAYING_CARDS_RADIUS;
                });

                if (nearbyCard) {
                    console.log('ç‚¹å‡»äº†çº¸ç‰Œé™„è¿‘:', nearbyCard.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const cardIndex = itemData.playing_cards.findIndex(card => 
                        card.x === nearbyCard.x && card.y === nearbyCard.y
                    );
                    showPlayingCardsImage(cardIndex);
                }
            }
        }
        
        // æ£€æµ‹åäº‘åé›¾é¦†äº§å“ç‚¹å‡»
        function checkSmokeProductClick(clickX, clickY) {
            const SMOKE_PRODUCT_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºåäº‘åé›¾é¦†äº§å“ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('smoke_on_the_water_product') && itemData.smoke_on_the_water_product) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„åäº‘åé›¾é¦†äº§å“é™„è¿‘
                const nearbyProduct = itemData.smoke_on_the_water_product.find((product, index) => {
                    const distance = Math.sqrt(Math.pow(product.x - clickX, 2) + Math.pow(product.y - clickY, 2));
                    return distance <= SMOKE_PRODUCT_RADIUS;
                });

                if (nearbyProduct) {
                    console.log('ç‚¹å‡»äº†åäº‘åé›¾é¦†äº§å“é™„è¿‘:', nearbyProduct.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const productIndex = itemData.smoke_on_the_water_product.findIndex(product => 
                        product.x === nearbyProduct.x && product.y === nearbyProduct.y
                    );
                    showSmokeProductPopup(nearbyProduct, productIndex);
                }
            }
        }
        
        // æ£€æµ‹æ‰‹åŠç‚¹å‡»
        function checkActionFiguresClick(clickX, clickY) {
            const ACTION_FIGURES_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ‰‹åŠï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('action_figures') && itemData.action_figures) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æ‰‹åŠé™„è¿‘
                const nearbyFigure = itemData.action_figures.find((figure, index) => {
                    const distance = Math.sqrt(Math.pow(figure.x - clickX, 2) + Math.pow(figure.y - clickY, 2));
                    return distance <= ACTION_FIGURES_RADIUS;
                });

                if (nearbyFigure) {
                    console.log('ç‚¹å‡»äº†æ‰‹åŠé™„è¿‘:', nearbyFigure.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const figureIndex = itemData.action_figures.findIndex(figure => 
                        figure.x === nearbyFigure.x && figure.y === nearbyFigure.y
                    );
                    showActionFiguresImage(figureIndex);
                }
            }
        }
        
        // æ£€æµ‹å…ƒå®ç‚¹å‡»
        function checkYuanbaoClick(clickX, clickY) {
            const YUANBAO_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå…ƒå®ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('yuanbao') && itemData.yuanbao) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å…ƒå®é™„è¿‘
                const nearbyYuanbao = itemData.yuanbao.find((yuanbao, index) => {
                    const distance = Math.sqrt(Math.pow(yuanbao.x - clickX, 2) + Math.pow(yuanbao.y - clickY, 2));
                    return distance <= YUANBAO_RADIUS;
                });

                if (nearbyYuanbao) {
                    console.log('ç‚¹å‡»äº†å…ƒå®é™„è¿‘:', nearbyYuanbao.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const yuanbaoIndex = itemData.yuanbao.findIndex(yuanbao => 
                        yuanbao.x === nearbyYuanbao.x && yuanbao.y === nearbyYuanbao.y
                    );
                    showYuanbaoImage(yuanbaoIndex);
                }
            }
        }
        
        // æ£€æµ‹æ²‰èˆ¹ç‚¹å‡»
        function checkShipwrecksClick(clickX, clickY) {
            const SHIPWRECKS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ²‰èˆ¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('shipwrecked') && itemData.shipwrecked) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æ²‰èˆ¹é™„è¿‘
                const nearbyShipwreck = itemData.shipwrecked.find((shipwreck, index) => {
                    const distance = Math.sqrt(Math.pow(shipwreck.x - clickX, 2) + Math.pow(shipwreck.y - clickY, 2));
                    return distance <= SHIPWRECKS_RADIUS;
                });

                if (nearbyShipwreck) {
                    const index = itemData.shipwrecked.findIndex(shipwreck => 
                        shipwreck.x === nearbyShipwreck.x && shipwreck.y === nearbyShipwreck.y
                    );
                    console.log('ç‚¹å‡»äº†æ²‰èˆ¹é™„è¿‘:', nearbyShipwreck.name);
                    showShipwreckedPopup(nearbyShipwreck, index);
                }
            }
        }
        
        // æ£€æµ‹ç”µè¯æš—æ€ç‚¹å‡»
        function checkPayphoneHitsClick(clickX, clickY) {
            const PAYPHONE_HITS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºç”µè¯æš—æ€ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('payphone_hits') && itemData.payphone_hits) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„ç”µè¯æš—æ€é™„è¿‘
                const nearbyPayphoneHit = itemData.payphone_hits.find((payphoneHit, index) => {
                    const distance = Math.sqrt(Math.pow(payphoneHit.x - clickX, 2) + Math.pow(payphoneHit.y - clickY, 2));
                    return distance <= PAYPHONE_HITS_RADIUS;
                });

                if (nearbyPayphoneHit) {
                    console.log('ç‚¹å‡»äº†ç”µè¯æš—æ€é™„è¿‘:', nearbyPayphoneHit.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const payphoneHitIndex = itemData.payphone_hits.findIndex(payphoneHit => 
                        payphoneHit.x === nearbyPayphoneHit.x && payphoneHit.y === nearbyPayphoneHit.y
                    );
                    showPayphoneHitsImage(payphoneHitIndex);
                }
            }
        }
        
        // æ£€æµ‹é«˜å°”å¤«çƒæ´ç‚¹å‡»
        function checkGolfHolesClick(clickX, clickY) {
            const GOLF_HOLES_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºé«˜å°”å¤«çƒæ´ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('golf_holes') && itemData.golf_holes) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„é«˜å°”å¤«çƒæ´é™„è¿‘
                const nearbyGolfHole = itemData.golf_holes.find((golfHole, index) => {
                    const distance = Math.sqrt(Math.pow(golfHole.x - clickX, 2) + Math.pow(golfHole.y - clickY, 2));
                    return distance <= GOLF_HOLES_RADIUS;
                });

                if (nearbyGolfHole) {
                    console.log('ç‚¹å‡»äº†é«˜å°”å¤«çƒæ´é™„è¿‘:', nearbyGolfHole.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const golfHoleIndex = itemData.golf_holes.findIndex(golfHole => 
                        golfHole.x === nearbyGolfHole.x && golfHole.y === nearbyGolfHole.y
                    );
                    showGolfHolesImage(golfHoleIndex);
                }
            }
        }
        
        // æ£€æµ‹é›ªäººç‚¹å‡»
        function checkSnowmenClick(clickX, clickY) {
            const SNOWMEN_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºé›ªäººï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('snowmen') && itemData.snowmen) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„é›ªäººé™„è¿‘
                const nearbySnowman = itemData.snowmen.find((snowman, index) => {
                    const distance = Math.sqrt(Math.pow(snowman.x - clickX, 2) + Math.pow(snowman.y - clickY, 2));
                    return distance <= SNOWMEN_RADIUS;
                });

                if (nearbySnowman) {
                    console.log('ç‚¹å‡»äº†é›ªäººé™„è¿‘:', nearbySnowman.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const snowmanIndex = itemData.snowmen.findIndex(snowman => 
                        snowman.x === nearbySnowman.x && snowman.y === nearbySnowman.y
                    );
                    showSnowmenImage(snowmanIndex);
                }
            }
        }
        
        // æ£€æµ‹æ°æ‹‰å¾·åŒ…è£¹ç‚¹å‡»
        function checkDeadDropClick(clickX, clickY) {
            const DEAD_DROP_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ°æ‹‰å¾·åŒ…è£¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('dead_drop') && itemData.dead_drop) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æ°æ‹‰å¾·åŒ…è£¹é™„è¿‘
                const nearbyDeadDrop = itemData.dead_drop.find((deadDrop, index) => {
                    const distance = Math.sqrt(Math.pow(deadDrop.x - clickX, 2) + Math.pow(deadDrop.y - clickY, 2));
                    return distance <= DEAD_DROP_RADIUS;
                });

                if (nearbyDeadDrop) {
                    console.log('ç‚¹å‡»äº†æ°æ‹‰å¾·åŒ…è£¹é™„è¿‘:', nearbyDeadDrop.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const deadDropIndex = itemData.dead_drop.findIndex(deadDrop => 
                        deadDrop.x === nearbyDeadDrop.x && deadDrop.y === nearbyDeadDrop.y
                    );
                    showDeadDropPopup(nearbyDeadDrop, deadDropIndex);
                }
            }
        }
        
        // æ£€æµ‹å–·ç½ä½ç½®ç‚¹å‡»
        function checkSprayClick(e) {
            const marker = e.target.closest('.item-marker');
            if (!marker) return;
            
            // è·å–ç´¢å¼•
            const index = parseInt(marker.dataset.index);
            
            // æ˜¾ç¤ºç‰©å“ä¿¡æ¯
            if (itemData.spray && itemData.spray[index]) {
                showItemInfo(itemData.spray[index], 'spray', index);
                
                // æ˜¾ç¤ºå–·ç½ä½ç½®å›¾ç‰‡å¼¹çª—
                showSprayImage(index);
            }
        }

        // æ£€æµ‹ç‰¹æŠ€è·³è·ƒç‚¹ç‚¹å‡»ï¼ˆç”¨äºåœ°å›¾åæ ‡æ£€æµ‹ï¼‰
        function checkStuntJumpsClickNew(clickX, clickY) {
            const STUNT_JUMP_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºç‰¹æŠ€è·³è·ƒç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('stunt_jumps') && itemData.stunt_jumps) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„ç‰¹æŠ€è·³è·ƒç‚¹é™„è¿‘
                const nearbyJump = itemData.stunt_jumps.find(jump => {
                    const distance = Math.sqrt(Math.pow(jump.x - clickX, 2) + Math.pow(jump.y - clickY, 2));
                    return distance <= STUNT_JUMP_RADIUS;
                });

                if (nearbyJump) {
                    console.log('ç‚¹å‡»äº†ç‰¹æŠ€è·³è·ƒç‚¹é™„è¿‘:', nearbyJump.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const jumpIndex = itemData.stunt_jumps.findIndex(jump => 
                        jump.x === nearbyJump.x && jump.y === nearbyJump.y
                    );
                    
                    showItemInfo(nearbyJump, 'stunt_jumps', jumpIndex);
                    
                    // æ˜¾ç¤ºç‰¹æŠ€è·³è·ƒç‚¹å›¾ç‰‡å¼¹çª—
                    if (typeof showStuntJumpsImage === 'function') {
                        showStuntJumpsImage(jumpIndex);
                    }
                }
            }
        }
        
        // æ£€æµ‹å–·ç½ç‚¹å‡»ï¼ˆç”¨äºåœ°å›¾åæ ‡æ£€æµ‹ï¼‰
        function checkSprayClickNew(clickX, clickY) {
            const SPRAY_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå–·ç½ä½ç½®ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('spray') && itemData.spray) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å–·ç½é™„è¿‘
                const nearbySpray = itemData.spray.find(spray => {
                    const distance = Math.sqrt(Math.pow(spray.x - clickX, 2) + Math.pow(spray.y - clickY, 2));
                    return distance <= SPRAY_RADIUS;
                });

                if (nearbySpray) {
                    console.log('ç‚¹å‡»äº†å–·ç½é™„è¿‘:', nearbySpray.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const sprayIndex = itemData.spray.findIndex(spray => 
                        spray.x === nearbySpray.x && spray.y === nearbySpray.y
                    );

                    // æ˜¾ç¤ºç‰©å“ä¿¡æ¯
                    if (itemData.spray && itemData.spray[sprayIndex]) {
                        showItemInfo(itemData.spray[sprayIndex], 'spray', sprayIndex);
                        
                        // æ˜¾ç¤ºå–·ç½ä½ç½®å›¾ç‰‡å¼¹çª—
                        showSprayImage(sprayIndex);
                    }
                }
            }
        }

        // æ£€æµ‹RCæ—¶é—´æŒ‘æˆ˜èµ›ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkRCTimeTrialClickNew(clickX, clickY) {
            const RC_TIME_TRIAL_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºRCæ—¶é—´æŒ‘æˆ˜èµ›ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('rc_time_trial') && itemData.rc_time_trial) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„RCæ—¶é—´æŒ‘æˆ˜èµ›é™„è¿‘
                const nearbyTrial = itemData.rc_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= RC_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('ç‚¹å‡»äº†RCæ—¶é—´æŒ‘æˆ˜èµ›é™„è¿‘:', nearbyTrial.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const trialIndex = itemData.rc_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showRCTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // æ£€æµ‹è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkBikeTimeTrialClickNew(clickX, clickY) {
            const BIKE_TIME_TRIAL_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('bike_time_trial') && itemData.bike_time_trial) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›é™„è¿‘
                const nearbyTrial = itemData.bike_time_trial.find(trial => {
                    const distance = Math.sqrt(Math.pow(trial.x - clickX, 2) + Math.pow(trial.y - clickY, 2));
                    return distance <= BIKE_TIME_TRIAL_RADIUS;
                });

                if (nearbyTrial) {
                    console.log('ç‚¹å‡»äº†è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›é™„è¿‘:', nearbyTrial.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const trialIndex = itemData.bike_time_trial.findIndex(trial => 
                        trial.x === nearbyTrial.x && trial.y === nearbyTrial.y
                    );
                    showBikeTimeTrialPopup(nearbyTrial, trialIndex);
                }
            }
        }

        // æ£€æµ‹è·³ä¼ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkSkydivesClickNew(clickX, clickY) {
            const SKYDIVES_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè·³ä¼ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('skydives') && itemData.skydives) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è·³ä¼é™„è¿‘
                const nearbySkydive = itemData.skydives.find(skydive => {
                    const distance = Math.sqrt(Math.pow(skydive.x - clickX, 2) + Math.pow(skydive.y - clickY, 2));
                    return distance <= SKYDIVES_RADIUS;
                });

                if (nearbySkydive) {
                    console.log('ç‚¹å‡»äº†è·³ä¼é™„è¿‘:', nearbySkydive.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const skydiveIndex = itemData.skydives.findIndex(skydive => 
                        skydive.x === nearbySkydive.x && skydive.y === nearbySkydive.y
                    );
                    showSkydivesPopup(nearbySkydive, skydiveIndex);
                }
            }
        }

        // æ£€æµ‹è½¦è¡Œç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkDealershipClick(clickX, clickY) {
            const DEALERSHIP_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè½¦è¡Œï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('dealerships')) {
                // å·²è¿ç§»åˆ°Leafletçš„è½¦è¡Œç±»å‹ï¼Œè·³è¿‡DOMç‚¹å‡»æ£€æµ‹ï¼ˆç”±Leafletå¤„ç†ï¼‰
                const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                
                // éå†æ‰€æœ‰è½¦è¡Œåæ ‡è¿›è¡Œæ£€æµ‹
                Object.keys(dealershipData).forEach(dealershipType => {
                    // è·³è¿‡å·²è¿ç§»çš„è½¦è¡Œç±»å‹
                    if (migratedDealerships.includes(dealershipType)) {
                        return;
                    }
                    
                    const dealership = dealershipData[dealershipType];
                    dealership.coordinates.forEach(coord => {
                        const distance = Math.sqrt(Math.pow(coord[0] - clickX, 2) + Math.pow(coord[1] - clickY, 2));
                        if (distance <= DEALERSHIP_RADIUS) {
                            console.log(`ç‚¹å‡»äº†${dealership.name}é™„è¿‘åŒºåŸŸ`);
                            showDealershipVehicles(dealershipType, dealership.name);
                        }
                    });
                });
            }
        }

        // æ£€æµ‹å·¦è½®å¯»å®ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkTreasureHuntClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('treasure_hunt_dba_revolver')) return;
            const rc = itemData.treasure_hunt_dba_revolver?.random_clue || [];
            const sc = itemData.treasure_hunt_dba_revolver?.static_clues || [];
            const foundRandom = rc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundRandom) {
                const idx = rc.findIndex(p => p.x === foundRandom.x && p.y === foundRandom.y);
                showTreasureHuntPopup(foundRandom, idx, 'random');
                return;
            }
            const foundStatic = sc.find(p => Math.hypot(p.x - clickX, p.y - clickY) <= RADIUS);
            if (foundStatic) {
                const idx = sc.findIndex(p => p.x === foundStatic.x && p.y === foundStatic.y);
                showTreasureHuntPopup(foundStatic, idx, 'static');
            }
        }

        // æ£€æµ‹ç”µå½±é“å…·ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkMoviePropsClick(clickX, clickY) {
            const RADIUS = 100;
            if (!activeItemTypes.has('movie_props')) return;
            
            const mp = itemData.movie_props;
            const allItems = [
                ...(mp.fixed_position || []).map((item, i) => ({ ...item, __index: i, __type: 'fixed_position' })),
                ...(mp.vehicles?.pony || []).map((item, i) => ({ ...item, __index: i, __type: 'pony' })),
                ...(mp.vehicles?.rebel || []).map((item, i) => ({ ...item, __index: i, __type: 'rebel' })),
                ...(mp.vehicles?.rumpo || []).map((item, i) => ({ ...item, __index: i, __type: 'rumpo' }))
            ];
            
            const foundItem = allItems.find(item => Math.hypot(item.x - clickX, item.y - clickY) <= RADIUS);
            if (foundItem) {
                showMoviePropsPopup(foundItem, foundItem.__index, foundItem.__type);
            }
        }

        // æ£€æµ‹æ€äººç‹‚ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkSlasherClick(clickX, clickY) {
            const SLASHER_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ€äººç‹‚ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('serial_killer_slasher') && itemData.serial_killer_slasher) {
                // æ£€æŸ¥å‰å››æ¡çº¿ç´¢
                if (itemData.serial_killer_slasher.first) {
                    const nearbyFirst = itemData.serial_killer_slasher.first.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyFirst) {
                        const index = itemData.serial_killer_slasher.first.findIndex(item => 
                            item.x === nearbyFirst.x && item.y === nearbyFirst.y
                        );
                        console.log('ç‚¹å‡»äº†æ€äººç‹‚å‰å››æ¡çº¿ç´¢é™„è¿‘:', nearbyFirst.name);
                        showSlasherPopup(nearbyFirst, index, 'first');
                        return;
                    }
                }
                
                // æ£€æŸ¥æœ€åä¸€æ¡çº¿ç´¢
                if (itemData.serial_killer_slasher.last) {
                    const nearbyLast = itemData.serial_killer_slasher.last.find((item, index) => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= SLASHER_RADIUS;
                    });
                    
                    if (nearbyLast) {
                        const index = itemData.serial_killer_slasher.last.findIndex(item => 
                            item.x === nearbyLast.x && item.y === nearbyLast.y
                        );
                        console.log('ç‚¹å‡»äº†æ€äººç‹‚æœ€åä¸€æ¡çº¿ç´¢é™„è¿‘:', nearbyLast.name);
                        showSlasherPopup(nearbyLast, index, 'last');
                        return;
                    }
                }
            }
        }

        // æ³¨æ„ï¼šèŒ‰å¾·æ‚¬èµç›®æ ‡ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿï¼Œä¸å†éœ€è¦DOMç‚¹å‡»æ£€æµ‹

        // èŒ‰å¾·æ‚¬èµç›®æ ‡å¼¹çª—
        function showMaudeBountyPopup(item, index, subtype) {
            const isArea = subtype === 'area';
            const title = isArea ? `ğŸ¯ èŒ‰å¾·æ‚¬èµåŒºåŸŸ #${index + 1}` : `ğŸ¯ èŒ‰å¾·æ‚¬èµç»ˆç‚¹ #${index + 1}`;
            
            const popup = document.createElement('div');
            popup.className = 'maude-bounty-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FFD700; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #FFD700; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #fffbf0; border-radius: 8px; color: #4e342e; font-size: 13px; line-height: 1.6;">
                    å‰å¾€èŒ‰å¾·å¤„æ¥å—æ‚¬èµç›®æ ‡ä»»åŠ¡ã€‚ç­‰å¾…æ•°åˆ†é’Ÿåï¼Œå¥¹å°†é€šè¿‡ç”µå­é‚®ä»¶å‘ŠçŸ¥æ‚¬èµç›®æ ‡çš„ç›¸å…³ä¿¡æ¯ã€‚æ‚¬èµç›®æ ‡å°†éšæœºå‡ºç°åœ¨ 20 ä¸ªåŒºåŸŸä¹‹ä¸€ï¼Œå…¶å½“å‰æ´»åŠ¨çš„åŒºåŸŸä¼šåœ¨æ¸¸æˆå†…çš„åœ°å›¾ä¸Šæ ‡è®°å‡ºæ¥ã€‚æ¯ä¸ªåŒºåŸŸéƒ½æœ‰ 20 ä¸ªå¯ä¾›ç”Ÿæˆç›®æ ‡çš„ä½ç½®ã€‚è‹¥æ‚¨æˆåŠŸæŠ“ä½ç›®æ ‡ï¼Œå¹¶è½¬äº¤ç»™èŒ‰å¾·ï¼Œæ‚¨å¯èµšå– 10.000 GTA$ï¼›è‹¥æ‚¨ç›´æ¥æ€æ­»ç›®æ ‡ï¼Œæ‚¨å°†è·å¾— 5.000 GTA$ã€‚å®Œæˆä¸€ä¸ªæ‚¬èµç›®æ ‡ä»»åŠ¡åï¼Œæ‚¨å¿…é¡»å†ç­‰å‡ åˆ†é’Ÿæ‰ä¼šæ”¶åˆ°ä¸‹ä¸€ä¸ªæ‚¬èµç›®æ ‡çš„ç›¸å…³ä¿¡æ¯ã€‚è¯¥ç³»åˆ—ä»»åŠ¡å…±æœ‰ 5 ä¸ªæ‚¬èµç›®æ ‡éœ€è¦æŠ“æ•ã€‚å…¨éƒ¨å®Œæˆä¹‹åï¼ŒèŒ‰å¾·ä¼šå‘çŸ­ä¿¡ï¼Œå‘Šè¯‰æ‚¨çŸ³æ–§çš„è—åŒ¿ä½ç½®ï¼Œè¯¥ä½ç½®ä¼šåœ¨æ¸¸æˆå†…åœ°å›¾ä¸Šæ ‡è®°å‡ºæ¥ã€‚ä½¿ç”¨è¯¥æ­¦å™¨å®Œæˆ 25 æ¬¡å‡»æ€ï¼Œæ‚¨å°†å¾—åˆ° 250.000 GTA$ ä¸ 2.000 RPï¼Œå¹¶å¯åœ¨ Red Dead Redemption 2 ä¸­æ‰¾åˆ°è¿™æ¬¾æ­¦å™¨ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-maude-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-maude-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-maude-btn" style="padding: 10px 18px; background: #FFD700; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            // éšè—/æ˜¾ç¤º/å…³é—­æŒ‰é’®
            const hideBtn = popup.querySelector('#hide-maude-btn');
            const showBtn = popup.querySelector('#show-maude-btn');
            const closeBtn = popup.querySelector('#close-maude-btn');

            // è§£æç›®æ ‡æ ‡è®°å’Œç´¢å¼•
            function resolveTargetAndIndex() {
                let el;
                if (subtype === 'area') {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_area"][data-index="${index}"]`);
                } else {
                    el = document.querySelector(`.item-marker[data-type="maude_bounty_endpoint"][data-index="${index}"]`);
                }
                return { el, globalIndex: index };
            }

            // éšè—æŒ‰é’®ï¼šè®¾ç½®æ ‡è®°é€æ˜åº¦ä¸º25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // æ˜¾ç¤ºæŒ‰é’®ï¼šæ¢å¤æ ‡è®°é€æ˜åº¦ä¸º100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // å…³é—­æŒ‰é’®
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // æ£€æµ‹åª’ä½“è®°å¿†æ£’ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkMediaStickClick(clickX, clickY) {
            const MEDIA_STICK_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºåª’ä½“è®°å¿†æ£’
            if (activeItemTypes.has('media_sticks') && itemData.media_sticks) {
                const nearbyStick = itemData.media_sticks.find((stick, index) => {
                    const distance = Math.sqrt(Math.pow(stick.x - clickX, 2) + Math.pow(stick.y - clickY, 2));
                    return distance <= MEDIA_STICK_RADIUS;
                });
                
                if (nearbyStick) {
                    const index = itemData.media_sticks.findIndex(stick => 
                        stick.x === nearbyStick.x && stick.y === nearbyStick.y
                    );
                    console.log('ç‚¹å‡»äº†åª’ä½“è®°å¿†æ£’é™„è¿‘:', nearbyStick.name);
                    showMediaStickPopup(nearbyStick, index);
                    return;
                }
            }
        }

         // åª’ä½“è®°å¿†æ£’å¼¹çª—æ¨¡æ¿ï¼ˆå‚è€ƒçº¸ç‰Œå®ç°ï¼Œå«éšè—/æ˜¾ç¤ºåŠŸèƒ½ï¼‰
        function showMediaStickPopup(item, index) {
            const rawLabel = item && (item.label || item.name) || '';
            const label = String(rawLabel);
            const labelLower = label.toLowerCase();
            
            // æ ¹æ®æ ‡ç­¾åŒ¹é…ä¸åŒçš„å¼¹çª—å†…å®¹ï¼ˆç»Ÿä¸€å°å†™åŒ¹é…ï¼Œå…¼å®¹å¤šç§åˆ«åï¼‰
            let title, content, imageUrl;
            
            if (labelLower.includes('circoloco_green_ep')) {
                title = 'ğŸµ CircoLoco Records - Green EP';
                content = `æ¸¸æˆä¸­å…±æœ‰ 4 ä¸ªåŒ…å«éŸ³ä¹çš„ CircoLoco Records åª’ä½“è®°å¿†æ£’ã€‚æ”¶é›†ä¸€ä¸ªåª’ä½“è®°å¿†æ£’å¯è·å¾— 1.000 RPï¼ŒåŒæ—¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”ç›¸åº”æ›²ç›®ã€‚å®Œæˆå…¨éƒ¨æ”¶é›†è¿˜å¯è§£é”é¢å¤–çš„æ›²ç›®ï¼šCLR Launch Party (Seth Troxler)ï¼Œå¹¶è§£é”CircoLoco T æ¤ã€‚<br><br>Green EP - åœ¨æ¸¸æˆå…çš„å§å°ä¸Š - æ‚¨çš„æ¸¸æˆå…çš„ä½ç½®å¯èƒ½ä¸æœ¬æ ‡è®°ä¸åŒã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_green_ep.webp';
            } else if (labelLower.includes('circoloco_violet_ep')) {
                title = 'ğŸµ CircoLoco Records - Violet EP';
                content = `æ¸¸æˆä¸­å…±æœ‰ 4 ä¸ªåŒ…å«éŸ³ä¹çš„ CircoLoco Records åª’ä½“è®°å¿†æ£’ã€‚æ”¶é›†ä¸€ä¸ªåª’ä½“è®°å¿†æ£’å¯è·å¾— 1.000 RPï¼ŒåŒæ—¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”ç›¸åº”æ›²ç›®ã€‚å®Œæˆå…¨éƒ¨æ”¶é›†è¿˜å¯è§£é”é¢å¤–çš„æ›²ç›®ï¼šCLR Launch Party (Seth Troxler)ï¼Œå¹¶è§£é”CircoLoco T æ¤ã€‚<br><br>Violet EP - åœ¨å¤œæ€»ä¼šçš„æ¡Œå­ä¸Š - æ‚¨çš„å¤œæ€»ä¼šçš„ä½ç½®å¯èƒ½ä¸æœ¬åœ°å›¾çš„æ ‡è®°ä¸åŒã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_violet_ep.webp';
            } else if (labelLower.includes('circoloco_blue_ep')) {
                title = 'ğŸµ CircoLoco Records - Blue EP';
                content = `æ¸¸æˆä¸­å…±æœ‰ 4 ä¸ªåŒ…å«éŸ³ä¹çš„ CircoLoco Records åª’ä½“è®°å¿†æ£’ã€‚æ”¶é›†ä¸€ä¸ªåª’ä½“è®°å¿†æ£’å¯è·å¾— 1.000 RPï¼ŒåŒæ—¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”ç›¸åº”æ›²ç›®ã€‚å®Œæˆå…¨éƒ¨æ”¶é›†è¿˜å¯è§£é”é¢å¤–çš„æ›²ç›®ï¼šCLR Launch Party (Seth Troxler)ï¼Œå¹¶è§£é”CircoLoco T æ¤ã€‚<br><br>Blue EP - åœ¨åé’»å‡æ—¥èµŒåœºçš„éœ²å°ï¼Œå…¶ä¸­çš„ä¸€å¼ æ¡Œå­ä¸Šã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_blue_ep.webp';
            } else if (labelLower.includes('circoloco_black_ep')) {
                title = 'ğŸµ CircoLoco Records - Black EP';
                content = `æ¸¸æˆä¸­å…±æœ‰ 4 ä¸ªåŒ…å«éŸ³ä¹çš„ CircoLoco Records åª’ä½“è®°å¿†æ£’ã€‚æ”¶é›†ä¸€ä¸ªåª’ä½“è®°å¿†æ£’å¯è·å¾— 1.000 RPï¼ŒåŒæ—¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”ç›¸åº”æ›²ç›®ã€‚å®Œæˆå…¨éƒ¨æ”¶é›†è¿˜å¯è§£é”é¢å¤–çš„æ›²ç›®ï¼šCLR Launch Party (Seth Troxler)ï¼Œå¹¶è§£é”CircoLoco T æ¤ã€‚<br><br>Black EP - åœ¨æ´›åœ£éƒ½è½¦å‹ä¼šå†…ï¼Œåœ¨æ”¹è£…å·¥åŠæ—è¾¹çš„ä¸€ä¸ªå·¥å…·å°ä¸Šã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/circoloco_black_ep.webp';
            } else if (labelLower.includes('dam_funk') || labelLower.includes('damfunk')) {
                title = 'ğŸµ DÃ¢M-FunK â€“ Even the Score';
                content = `å®ƒå°†æä¾› 1.000 RP å¥–åŠ±ï¼Œå¹¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”æ–°çš„æ›²ç›®<br><br>å‘¼å« 6115550110 åä¼šåœ¨ 5 ä¸ªå¯èƒ½ä½ç½®ä¹‹ä¸€å‡ºç°ã€‚æ¸¸æˆå†…åœ°å›¾ä¸Šä¼šæ ‡å‡ºå¤§è‡´ä½ç½®ã€‚æœ¬åœ°å›¾æ˜¾ç¤ºçš„æ˜¯ç¡®åˆ‡ä½ç½®ã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/dam_funk.webp';
            } else if (labelLower.includes('dr_dre') || labelLower.includes('dre')) {
                title = 'ğŸµ Dr. Dre - åœ¨äº‹åŠ¡æ‰€é‡Œ';
                content = `å®ƒå°†å¥–åŠ±æ‚¨ é©¬æ‹‰æ¾è¿å¸½ä¸Šè¡£ ä¸ 1.000 RPï¼Œå¹¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”æ–°çš„æ›²ç›®<br><br>Dr. Dre - åœ¨äº‹åŠ¡æ‰€é‡Œ - æ‚¨çš„äº‹åŠ¡æ‰€çš„ä½ç½®å¯èƒ½ä¸æœ¬åœ°å›¾çš„æ ‡è®°ä¸åŒã€‚è¯¥åª’ä½“è®°å¿†æ£’å°†åœ¨ä»¥ä¸»æŒäººèº«ä»½å®Œæˆå…¨éƒ¨å¾·ç‘åšå£«çš„æ•…äº‹åå¯ç”¨ã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/dr_dre.webp';
            } else if (labelLower.includes('moodymann')) {
                title = 'ğŸµ Moodymann - Kenny\'s Backyard Boogie';
                content = `å®ƒå°†æä¾› 1.000 RP å¥–åŠ±ï¼Œå¹¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”æ–°çš„æ›²ç›®<br><br>Moodymann - Kenny's Backyard Boogie -åœ¨ç©†è¿ªæ›¼çš„è½¦çš„åå¤‡ç®±ä¸Š - è¿™è¾†è½¦åœ¨ æ´›åœ£éƒ½è½¦å‹ä¼š éšæœºç”Ÿæˆã€‚`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/moodymann.webp';
            } else if (labelLower.includes('nez_ft_schoolboyq') || labelLower.includes('nez')) {
                title = 'ğŸµ NEZ - You Wanna?';
                content = `å®ƒå°†æä¾› 1.000 RP å¥–åŠ±ï¼Œå¹¶åœ¨åª’ä½“æ’­æ”¾å™¨ä¸Šè§£é”æ–°çš„æ›²ç›®<br><br>NEZ - You Wanna?`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/nez.webp';
            } else {
                // é»˜è®¤å†…å®¹
                title = `ğŸµ åª’ä½“è®°å¿†æ£’ #${index + 1}`;
                content = `åª’ä½“è®°å¿†æ£’ä½ç½®ä¿¡æ¯ã€‚<br><br>æ ‡ç­¾: ${label}`;
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/media_sticks/default.webp';
            }
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.media-stick-popup');
            if (existingPopup) existingPopup.remove();

            // è·å–å½“å‰æ ‡è®°çŠ¶æ€
            const markers = (window.mediaStickMarkers && window.mediaStickMarkers) || [];
            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'media-stick-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="åª’ä½“è®°å¿†æ£’å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-media-stick-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-media-stick-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-media-stick-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-media-stick-btn');
            const hideBtn = popup.querySelector('#hide-media-stick-btn');
            const showBtn = popup.querySelector('#show-media-stick-btn');
            const popupClose = popup.querySelector('.popup-close');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'media-stick-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('media_sticks', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°åª’ä½“è®°å¿†æ£’æ ‡è®°
        function applyMediaStickVisibilityCache() {
            const markers = (window.mediaStickMarkers && window.mediaStickMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('media_sticks');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨åª’ä½“è®°å¿†æ£’å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ£€æµ‹è—åŒ¿å±‹ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkStashHouseClick(clickX, clickY) {
            const STASH_HOUSE_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè—åŒ¿å±‹
            if (activeItemTypes.has('stash_houses') && itemData.stash_houses) {
                const nearbyStash = itemData.stash_houses.find((stash, index) => {
                    const distance = Math.sqrt(Math.pow(stash.x - clickX, 2) + Math.pow(stash.y - clickY, 2));
                    return distance <= STASH_HOUSE_RADIUS;
                });
                
                if (nearbyStash) {
                    const index = itemData.stash_houses.findIndex(stash => 
                        stash.x === nearbyStash.x && stash.y === nearbyStash.y
                    );
                    console.log('ç‚¹å‡»äº†è—åŒ¿å±‹é™„è¿‘:', nearbyStash.name);
                    showStashHousesPopup(nearbyStash, index);
                    return;
                }
            }
        }


        // æ£€æµ‹ç›å¾·æ‹‰ç´¢é›‡å‡¶ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkMadrazoHitsClick(clickX, clickY) {
            const MADRAZO_HITS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºç›å¾·æ‹‰ç´¢é›‡å‡¶
            if (activeItemTypes.has('madrazo_hits') && itemData.madrazo_hits) {
                const nearbyHit = itemData.madrazo_hits.find((hit, index) => {
                    const distance = Math.sqrt(Math.pow(hit.x - clickX, 2) + Math.pow(hit.y - clickY, 2));
                    return distance <= MADRAZO_HITS_RADIUS;
                });
                
                if (nearbyHit) {
                    const index = itemData.madrazo_hits.findIndex(hit => 
                        hit.x === nearbyHit.x && hit.y === nearbyHit.y
                    );
                    console.log('ç‚¹å‡»äº†ç›å¾·æ‹‰ç´¢é›‡å‡¶é™„è¿‘:', nearbyHit.name);
                    showMadrazoHitsPopup(nearbyHit, index);
                    return;
                }
            }
        }

        // æ£€æµ‹å¸•ç‰¹é‡Œå…‹æ•‘æ´ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkPatrickRescueClick(clickX, clickY) {
            const PATRICK_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå¸•ç‰¹é‡Œå…‹æ•‘æ´
            if (activeItemTypes.has('police_rescue_patrick_mcreary') && itemData.police_rescue_patrick_mcreary) {
                const patrickData = itemData.police_rescue_patrick_mcreary;
                
                // æ£€æŸ¥spawnç‚¹
                if (patrickData.spawn) {
                    const nearbySpawn = patrickData.spawn.find((spawn, index) => {
                        const distance = Math.sqrt(Math.pow(spawn.x - clickX, 2) + Math.pow(spawn.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbySpawn) {
                        const index = patrickData.spawn.findIndex(spawn => 
                            spawn.x === nearbySpawn.x && spawn.y === nearbySpawn.y
                        );
                        console.log('ç‚¹å‡»äº†å¸•ç‰¹é‡Œå…‹æ•‘æ´ç”Ÿæˆç‚¹é™„è¿‘:', nearbySpawn);
                        showPatrickRescuePopup(nearbySpawn, index, 'spawn');
                        return;
                    }
                }
                
                // æ£€æŸ¥dropoffç‚¹
                if (patrickData.dropoff) {
                    const nearbyDropoff = patrickData.dropoff.find((dropoff, index) => {
                        const distance = Math.sqrt(Math.pow(dropoff.x - clickX, 2) + Math.pow(dropoff.y - clickY, 2));
                        return distance <= PATRICK_RADIUS;
                    });
                    
                    if (nearbyDropoff) {
                        const index = patrickData.dropoff.findIndex(dropoff => 
                            dropoff.x === nearbyDropoff.x && dropoff.y === nearbyDropoff.y
                        );
                        console.log('ç‚¹å‡»äº†å¸•ç‰¹é‡Œå…‹æ•‘æ´é€è¾¾ç‚¹é™„è¿‘:', nearbyDropoff);
                        showPatrickRescuePopup(nearbyDropoff, index, 'dropoff');
                        return;
                    }
                }
            }
        }

        // æ£€æµ‹éšæœºä»»åŠ¡ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkRandomMissionClick(clickX, clickY) {
            const RANDOM_MISSION_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºéšæœºä»»åŠ¡
            if (activeItemTypes.has('random_missions') && itemData.random_missions) {
                const randomMissions = itemData.random_missions;
                let globalIndex = 0;
                
                // éå†æ‰€æœ‰æ—¶é—´æ®µ
                for (const timeSlot of Object.keys(randomMissions)) {
                    const missions = randomMissions[timeSlot] || [];
                    
                    for (let i = 0; i < missions.length; i++) {
                        const mission = missions[i];
                        if (!Array.isArray(mission) || mission.length < 2) continue;
                        
                        const x = mission[0];
                        const y = mission[1];
                        const distance = Math.sqrt(Math.pow(x - clickX, 2) + Math.pow(y - clickY, 2));
                        
                        if (distance <= RANDOM_MISSION_RADIUS) {
                            console.log('ç‚¹å‡»äº†éšæœºä»»åŠ¡é™„è¿‘:', mission);
                            showRandomMissionPopup(mission, timeSlot, i);
                            return;
                        }
                        globalIndex++;
                    }
                }
            }
        }

        // æ£€æµ‹æ¯’å“è½½å…·ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkDrugVehicleClick(clickX, clickY) {
            const DRUG_VEHICLE_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ¯’å“è½½å…·
            if (activeItemTypes.has('drug_vehicle') && Array.isArray(itemData.drug_vehicle)) {
                const nearbyVehicle = itemData.drug_vehicle.find((vehicle) => {
                    const dx = vehicle.x - clickX;
                    const dy = vehicle.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUG_VEHICLE_RADIUS;
                });
                
                if (nearbyVehicle) {
                    const index = itemData.drug_vehicle.findIndex(v => v.x === nearbyVehicle.x && v.y === nearbyVehicle.y);
                    console.log('ç‚¹å‡»äº†æ¯’å“è½½å…·é™„è¿‘:', nearbyVehicle);
                    showDrugVehiclePopup(nearbyVehicle, index);
                    return;
                }
            }
        }

        // æ£€æµ‹æ²‰ç¡çš„ä¿å®‰ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkDrunkGuardClick(clickX, clickY) {
            const DRUNK_GUARD_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            if (activeItemTypes.has('drunk_guard') && Array.isArray(itemData.drunk_guard)) {
                const nearby = itemData.drunk_guard.find((g) => {
                    const dx = g.x - clickX;
                    const dy = g.y - clickY;
                    return Math.sqrt(dx * dx + dy * dy) <= DRUNK_GUARD_RADIUS;
                });
                
                if (nearby) {
                    const index = itemData.drunk_guard.findIndex(g => g.x === nearby.x && g.y === nearby.y);
                    console.log('ç‚¹å‡»äº†æ²‰ç¡çš„ä¿å®‰é™„è¿‘:', nearby);
                    showDrunkGuardPopup(nearby, index);
                    return;
                }
            }
        }

        // æ³¨æ„ï¼šé‡‘å±æ¢æµ‹å™¨ç‚¹å‡»æ£€æµ‹å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿå¤„ç†ç‚¹å‡»äº‹ä»¶

        // æ£€æµ‹èµ°ç§è´©é£æœºç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkSmugglerPlaneClick(clickX, clickY) {
            const RADIUS = 120; // æ£€æµ‹åŠå¾„ï¼ˆæ¸¸æˆåæ ‡ï¼‰
            if (!activeItemTypes.has('smuggler_plane') || !Array.isArray(itemData.smuggler_plane)) return;
            const groups = itemData.smuggler_plane;

            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                // æ£€æŸ¥ triggerpoint
                if (Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                    const dx = group.triggerpoint[0] - clickX;
                    const dy = group.triggerpoint[1] - clickY;
                    if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                        showSmugglerPlanePopup(group, i);
                        return;
                    }
                }
                // æ£€æŸ¥ routes çš„é¦–ç‚¹
                if (Array.isArray(group.routes)) {
                    for (let r = 0; r < group.routes.length; r++) {
                        const route = group.routes[r];
                        if (Array.isArray(route) && route[0] && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const dx = rx - clickX;
                            const dy = ry - clickY;
                            if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                                showSmugglerPlanePopup(group, i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        // æ£€æµ‹èµ°ç§è´©è¸ªè¿¹ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkSmugglerTrailClick(clickX, clickY) {
            const RADIUS = 120; // æ£€æµ‹åŠå¾„ï¼ˆæ¸¸æˆåæ ‡ï¼‰
            if (!activeItemTypes.has('smuggler_trail') || !Array.isArray(itemData.smuggler_trail)) return;
            const groups = itemData.smuggler_trail;

            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                // æ£€æŸ¥ triggerpoint
                if (Array.isArray(group.triggerpoint) && group.triggerpoint.length === 2) {
                    const dx = group.triggerpoint[0] - clickX;
                    const dy = group.triggerpoint[1] - clickY;
                    if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                        showSmugglerTrailPopup(group, i);
                        return;
                    }
                }
                // æ£€æŸ¥ routes çš„é¦–ç‚¹
                if (Array.isArray(group.routes)) {
                    for (let r = 0; r < group.routes.length; r++) {
                        const route = group.routes[r];
                        if (Array.isArray(route) && route[0] && route[0].length === 2) {
                            const rx = route[0][0];
                            const ry = route[0][1];
                            const dx = rx - clickX;
                            const dy = ry - clickY;
                            if (Math.sqrt(dx*dx + dy*dy) <= RADIUS) {
                                showSmugglerTrailPopup(group, i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        // æ£€æµ‹çŠ¯ç½ªç°åœºç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkCrimeScenesClick(clickX, clickY) {
            const CRIME_SCENES_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºçŠ¯ç½ªç°åœºï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('crime_scenes') && itemData.crime_scenes) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„çŠ¯ç½ªç°åœºé™„è¿‘
                const nearbyCrimeScene = itemData.crime_scenes.find(crimeScene => {
                    const distance = Math.sqrt(Math.pow(crimeScene.x - clickX, 2) + Math.pow(crimeScene.y - clickY, 2));
                    return distance <= CRIME_SCENES_RADIUS;
                });

                if (nearbyCrimeScene) {
                    console.log('ç‚¹å‡»äº†çŠ¯ç½ªç°åœºé™„è¿‘:', nearbyCrimeScene.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const crimeSceneIndex = itemData.crime_scenes.findIndex(crimeScene => 
                        crimeScene.x === nearbyCrimeScene.x && crimeScene.y === nearbyCrimeScene.y
                    );
                    showCrimeScenesPopup(nearbyCrimeScene, crimeSceneIndex);
                    return; // æ‰¾åˆ°çŠ¯ç½ªç°åœºï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºUFOè§‚å…‰ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ufo') && itemData.ufo) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„UFOè§‚å…‰é™„è¿‘
                const nearbyUfo = itemData.ufo.find(ufo => {
                    const distance = Math.sqrt(Math.pow(ufo.x - clickX, 2) + Math.pow(ufo.y - clickY, 2));
                    return distance <= CRIME_SCENES_RADIUS; // ä½¿ç”¨ç›¸åŒçš„æ£€æµ‹åŠå¾„
                });
                
                if (nearbyUfo) {
                    console.log('ç‚¹å‡»äº†UFOè§‚å…‰é™„è¿‘:', nearbyUfo.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const ufoIndex = itemData.ufo.findIndex(ufo => 
                        ufo.x === nearbyUfo.x && ufo.y === nearbyUfo.y
                    );
                    showUfoPopup(nearbyUfo, ufoIndex);
                    return; // æ‰¾åˆ°UFOè§‚å…‰ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
            
            // æ³¨æ„ï¼šhalloween_slashers ç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿï¼Œç‚¹å‡»äº‹ä»¶ç”±Leafletè‡ªåŠ¨å¤„ç†
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºé¬¼ä¸Šèº«çš„åŠ¨ç‰©ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('possessed_animals') && itemData.possessed_animals) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„é¬¼ä¸Šèº«åŠ¨ç‰©åœ†å½¢åŒºåŸŸå†…
                const nearbyAnimal = itemData.possessed_animals.find(animal => {
                    const distance = Math.sqrt(Math.pow(animal.x - clickX, 2) + Math.pow(animal.y - clickY, 2));
                    return distance <= animal.radius; // ä½¿ç”¨æ¯ä¸ªåŠ¨ç‰©è‡ªå·±çš„åŠå¾„
                });
                
                if (nearbyAnimal) {
                    console.log('ç‚¹å‡»äº†é¬¼ä¸Šèº«åŠ¨ç‰©åŒºåŸŸ:', nearbyAnimal.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const animalIndex = itemData.possessed_animals.findIndex(animal => 
                        animal.x === nearbyAnimal.x && animal.y === nearbyAnimal.y && 
                        animal.type === nearbyAnimal.type && animal.animalType === nearbyAnimal.animalType
                    );
                    showPossessedAnimalPopup(nearbyAnimal, animalIndex);
                    return; // æ‰¾åˆ°é¬¼ä¸Šèº«åŠ¨ç‰©ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºåœ°ç‹±çŠ¬ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('cerberus') && itemData.cerberus) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„åœ°ç‹±çŠ¬é™„è¿‘
                const nearbyCerberus = itemData.cerberus.find(cerberus => {
                    const distance = Math.sqrt(Math.pow(cerberus.x - clickX, 2) + Math.pow(cerberus.y - clickY, 2));
                    return distance <= 100; // æ£€æµ‹åŠå¾„100å•ä½
                });
                
                if (nearbyCerberus) {
                    console.log('ç‚¹å‡»äº†åœ°ç‹±çŠ¬:', nearbyCerberus.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const cerberusIndex = itemData.cerberus.findIndex(cerberus => 
                        cerberus.x === nearbyCerberus.x && cerberus.y === nearbyCerberus.y
                    );
                    showCerberusPopup(nearbyCerberus, cerberusIndex);
                    return; // æ‰¾åˆ°åœ°ç‹±çŠ¬ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
        }

        // æ£€æµ‹é›ªæ€ªå’ŒèŠ‚æ—¥å¿«ä¹å¡è½¦ç‚¹å‡»
        function checkYetiAndHaulerClick(clickX, clickY) {
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºé›ªæ€ªï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('yeti') && itemData.yeti) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„é›ªæ€ªçº¿ç´¢é™„è¿‘
                const nearbyYeti = itemData.yeti.find(yeti => {
                    if (yeti.type === 'clue') {
                        const distance = Math.sqrt(Math.pow(yeti.x - clickX, 2) + Math.pow(yeti.y - clickY, 2));
                        return distance <= 100; // æ£€æµ‹åŠå¾„100å•ä½
                    }
                    return false; // åªæ£€æµ‹çº¿ç´¢ç‚¹å‡»ï¼Œä¸æ£€æµ‹åŒºåŸŸç‚¹å‡»
                });
                
                if (nearbyYeti) {
                    console.log('ç‚¹å‡»äº†é›ªæ€ªçº¿ç´¢:', nearbyYeti.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const yetiIndex = itemData.yeti.findIndex(yeti => 
                        yeti.x === nearbyYeti.x && yeti.y === nearbyYeti.y && yeti.type === nearbyYeti.type
                    );
                    showYetiPopup(nearbyYeti, yetiIndex);
                    return; // æ‰¾åˆ°é›ªæ€ªçº¿ç´¢ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºèŠ‚æ—¥å¿«ä¹å¡è½¦ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('happy_holidays_hauler') && itemData.happy_holidays_hauler) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„èŠ‚æ—¥å¿«ä¹å¡è½¦triggerpointé™„è¿‘
                const nearbyHauler = itemData.happy_holidays_hauler.find(hauler => {
                    if (hauler.triggerpoint && Array.isArray(hauler.triggerpoint) && hauler.triggerpoint.length === 2) {
                        const distance = Math.sqrt(Math.pow(hauler.triggerpoint[0] - clickX, 2) + Math.pow(hauler.triggerpoint[1] - clickY, 2));
                        return distance <= 100; // æ£€æµ‹åŠå¾„100å•ä½
                    }
                    return false;
                });
                
                if (nearbyHauler) {
                    console.log('ç‚¹å‡»äº†èŠ‚æ—¥å¿«ä¹å¡è½¦:', nearbyHauler);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const haulerIndex = itemData.happy_holidays_hauler.findIndex(hauler => 
                        hauler.triggerpoint && Array.isArray(hauler.triggerpoint) && 
                        hauler.triggerpoint[0] === nearbyHauler.triggerpoint[0] && 
                        hauler.triggerpoint[1] === nearbyHauler.triggerpoint[1]
                    );
                    showHappyHolidaysHaulerPopup(nearbyHauler, haulerIndex);
                    return; // æ‰¾åˆ°èŠ‚æ—¥å¿«ä¹å¡è½¦ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
        }

        // æ£€æµ‹å¨æ³½å°”å¤§æ¥¼æªæˆ˜ç‚¹å‡»
        function checkWeaClick(clickX, clickY) {
            const WEA_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå¨æ³½å°”å¤§æ¥¼æªæˆ˜ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('wea') && itemData.wea) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å¨æ³½å°”å¤§æ¥¼æªæˆ˜é™„è¿‘
                const nearbyWea = itemData.wea.find(wea => {
                    const distance = Math.sqrt(Math.pow(wea.x - clickX, 2) + Math.pow(wea.y - clickY, 2));
                    return distance <= WEA_RADIUS;
                });
                
                if (nearbyWea) {
                    console.log('ç‚¹å‡»äº†å¨æ³½å°”å¤§æ¥¼æªæˆ˜:', nearbyWea);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const weaIndex = itemData.wea.findIndex(wea => 
                        wea.x === nearbyWea.x && wea.y === nearbyWea.y
                    );
                    showWeaPopup(nearbyWea, weaIndex);
                    return; // æ‰¾åˆ°å¨æ³½å°”å¤§æ¥¼æªæˆ˜ï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
        }

        // æ£€æµ‹é™†åœ°è¿·å¹»ä»™äººæŒç‚¹å‡»
        function checkPplClick(clickX, clickY) {
            const PPL_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºé™†åœ°è¿·å¹»ä»™äººæŒï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ppl') && itemData.ppl) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„é™†åœ°è¿·å¹»ä»™äººæŒé™„è¿‘
                const nearbyPpl = itemData.ppl.find(ppl => {
                    const distance = Math.sqrt(Math.pow(ppl.x - clickX, 2) + Math.pow(ppl.y - clickY, 2));
                    return distance <= PPL_RADIUS;
                });
                
                if (nearbyPpl) {
                    console.log('ç‚¹å‡»äº†é™†åœ°è¿·å¹»ä»™äººæŒ:', nearbyPpl);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const pplIndex = itemData.ppl.findIndex(ppl => 
                        ppl.x === nearbyPpl.x && ppl.y === nearbyPpl.y
                    );
                    showPplPopup(nearbyPpl, pplIndex);
                    return; // æ‰¾åˆ°é™†åœ°è¿·å¹»ä»™äººæŒï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
        }

        // æ£€æµ‹æ°´ä¸‹è¿·å¹»ä»™äººæŒç‚¹å‡»
        function checkPpwClick(clickX, clickY) {
            const PPW_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ°´ä¸‹è¿·å¹»ä»™äººæŒï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ppw') && itemData.ppw) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„æ°´ä¸‹è¿·å¹»ä»™äººæŒé™„è¿‘
                const nearbyPpw = itemData.ppw.find(ppw => {
                    const distance = Math.sqrt(Math.pow(ppw.x - clickX, 2) + Math.pow(ppw.y - clickY, 2));
                    return distance <= PPW_RADIUS;
                });
                
                if (nearbyPpw) {
                    console.log('ç‚¹å‡»äº†æ°´ä¸‹è¿·å¹»ä»™äººæŒ:', nearbyPpw);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const ppwIndex = itemData.ppw.findIndex(ppw => 
                        ppw.x === nearbyPpw.x && ppw.y === nearbyPpw.y
                    );
                    showPpwPopup(nearbyPpw, ppwIndex);
                    return; // æ‰¾åˆ°æ°´ä¸‹è¿·å¹»ä»™äººæŒï¼Œåœæ­¢åç»­æ£€æµ‹
                }
            }
        }

        // æ£€æµ‹æ–°ç‰©å“ç‚¹å‡»ï¼ˆåœ°é“ç«™ã€è­¦å¯Ÿå±€ã€æœ›è¿œé•œã€æ¶ˆé˜²å±€ã€åŒ»é™¢ã€å„ç§å•†åº—ï¼‰
        function checkNewItemClick(clickX, clickY) {
            const NEW_ITEM_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            const newItemTypes = [
                'metro', 'police', 'v_telescopes', 'fire_stations', 'hospitals',
                'clothing', 'tattoos', 'barbers', 'ammunation', 'mod_shop', 'car_wash',
                'shops_to_rob', 'gas_stations', 'atms', 'vend_sprunk', 'vend_ecola'
            ];
            
            newItemTypes.forEach(type => {
                // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè¯¥ç‰©å“ç±»å‹
                if (activeItemTypes.has(type) && itemData[type]) {
                    // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨è¯¥ç‰©å“é™„è¿‘
                    const nearbyItem = itemData[type].find(item => {
                        const distance = Math.sqrt(Math.pow(item.x - clickX, 2) + Math.pow(item.y - clickY, 2));
                        return distance <= NEW_ITEM_RADIUS;
                    });
                    
                    if (nearbyItem) {
                        console.log(`ç‚¹å‡»äº†${type}:`, nearbyItem);
                        // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                        const itemIndex = itemData[type].findIndex(item => 
                            item.x === nearbyItem.x && item.y === nearbyItem.y
                        );
                        showNewItemPopup(type, nearbyItem, itemIndex);
                        return; // æ‰¾åˆ°ç‰©å“ï¼Œåœæ­¢åç»­æ£€æµ‹
                    }
                }
            });
        }

        // æ£€æµ‹ç¤¾åŒºè¾¹ç•Œç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkCommunityOutreachClick(clickX, clickY) {
            const COMMUNITY_OUTREACH_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºç¤¾åŒºè¾¹ç•Œï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('community_outreach') && itemData.community_outreach) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„ç¤¾åŒºè¾¹ç•Œé™„è¿‘
                const nearbyCommunityOutreach = itemData.community_outreach.find(communityOutreach => {
                    const distance = Math.sqrt(Math.pow(communityOutreach.x - clickX, 2) + Math.pow(communityOutreach.y - clickY, 2));
                    return distance <= COMMUNITY_OUTREACH_RADIUS;
                });

                if (nearbyCommunityOutreach) {
                    console.log('ç‚¹å‡»äº†ç¤¾åŒºè¾¹ç•Œé™„è¿‘:', nearbyCommunityOutreach.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const communityOutreachIndex = itemData.community_outreach.findIndex(communityOutreach => 
                        communityOutreach.x === nearbyCommunityOutreach.x && communityOutreach.y === nearbyCommunityOutreach.y
                    );
                    showCommunityOutreachPopup(nearbyCommunityOutreach, communityOutreachIndex);
                }
            }
        }

        // æ£€æµ‹å¤–è´¸å‡ºå£è½½å…·ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkExoticExportsClick(clickX, clickY) {
            const EXOTIC_EXPORTS_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥exotic_exports1
            if (activeItemTypes.has('exotic_exports1') && itemData.exotic_exports1) {
                const nearbyExoticExport = itemData.exotic_exports1.find(exoticExport => {
                    const distance = Math.sqrt(Math.pow(exoticExport.x - clickX, 2) + Math.pow(exoticExport.y - clickY, 2));
                    return distance <= EXOTIC_EXPORTS_RADIUS;
                });

                if (nearbyExoticExport) {
                    console.log('ç‚¹å‡»äº†å¤–è´¸å‡ºå£è½½å…·1é™„è¿‘:', nearbyExoticExport.name);
                    const exoticExportIndex = itemData.exotic_exports1.findIndex(exoticExport => 
                        exoticExport.x === nearbyExoticExport.x && exoticExport.y === nearbyExoticExport.y
                    );
                    showExoticExportsPopup(nearbyExoticExport, exoticExportIndex, 'exotic_exports1');
                    return;
                }
            }
            
            // æ£€æŸ¥exotic_exports2
            if (activeItemTypes.has('exotic_exports2') && itemData.exotic_exports2) {
                const nearbyExoticExport = itemData.exotic_exports2.find(exoticExport => {
                    const distance = Math.sqrt(Math.pow(exoticExport.x - clickX, 2) + Math.pow(exoticExport.y - clickY, 2));
                    return distance <= EXOTIC_EXPORTS_RADIUS;
                });

                if (nearbyExoticExport) {
                    console.log('ç‚¹å‡»äº†å¤–è´¸å‡ºå£è½½å…·2é™„è¿‘:', nearbyExoticExport.name);
                    const exoticExportIndex = itemData.exotic_exports2.findIndex(exoticExport => 
                        exoticExport.x === nearbyExoticExport.x && exoticExport.y === nearbyExoticExport.y
                    );
                    showExoticExportsPopup(nearbyExoticExport, exoticExportIndex, 'exotic_exports2');
                    return;
                }
            }
        }

        // æ£€æµ‹å•†åº—æŠ¢åŠ«ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkStoreRobberyClick(clickX, clickY) {
            const STORE_ROBBERY_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå•†åº—æŠ¢åŠ«ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('store_robbery') && itemData.store_robbery) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å•†åº—æŠ¢åŠ«é™„è¿‘
                const nearbyStoreRobbery = itemData.store_robbery.find(storeRobbery => {
                    const distance = Math.sqrt(Math.pow(storeRobbery.x - clickX, 2) + Math.pow(storeRobbery.y - clickY, 2));
                    return distance <= STORE_ROBBERY_RADIUS;
                });

                if (nearbyStoreRobbery) {
                    console.log('ç‚¹å‡»äº†å•†åº—æŠ¢åŠ«é™„è¿‘:', nearbyStoreRobbery.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const storeRobberyIndex = itemData.store_robbery.findIndex(storeRobbery => 
                        storeRobbery.x === nearbyStoreRobbery.x && storeRobbery.y === nearbyStoreRobbery.y
                    );
                    showStoreRobberyPopup(nearbyStoreRobbery, storeRobberyIndex);
                }
            }
        }

        // æ£€æµ‹è½¦é˜Ÿç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkConvoyClick(clickX, clickY) {
            const CONVOY_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè½¦é˜Ÿï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('convoy') && itemData.convoy) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è½¦é˜Ÿé™„è¿‘
                const nearbyConvoy = itemData.convoy.find((convoy, index) => {
                    const tp = convoy.triggerpoint;
                    if (Array.isArray(tp) && tp.length >= 2) {
                        const distance = Math.sqrt(Math.pow(tp[0] - clickX, 2) + Math.pow(tp[1] - clickY, 2));
                        return distance <= CONVOY_RADIUS;
                    }
                    return false;
                });

                if (nearbyConvoy) {
                    console.log('ç‚¹å‡»äº†è½¦é˜Ÿé™„è¿‘:', nearbyConvoy.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const convoyIndex = itemData.convoy.findIndex(convoy => 
                        convoy.triggerpoint === nearbyConvoy.triggerpoint
                    );
                    showConvoyPopup(nearbyConvoy, convoyIndex);
                    return;
                }
            }

            // åŒæ—¶æ£€æŸ¥è½¦é˜Ÿç»ˆç‚¹
            if (activeItemTypes.has('convoy') && itemData.convoy_final) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è½¦é˜Ÿç»ˆç‚¹é™„è¿‘
                const nearbyConvoyFinal = itemData.convoy_final.find(convoyFinal => {
                    const distance = Math.sqrt(Math.pow(convoyFinal.x - clickX, 2) + Math.pow(convoyFinal.y - clickY, 2));
                    return distance <= CONVOY_RADIUS;
                });

                if (nearbyConvoyFinal) {
                    console.log('ç‚¹å‡»äº†è½¦é˜Ÿç»ˆç‚¹é™„è¿‘:', nearbyConvoyFinal.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const convoyFinalIndex = itemData.convoy_final.findIndex(convoyFinal => 
                        convoyFinal.x === nearbyConvoyFinal.x && convoyFinal.y === nearbyConvoyFinal.y
                    );
                    showConvoyFinalPopup(nearbyConvoyFinal, convoyFinalIndex);
                }
            }
        }

        // æ£€æµ‹è£…ç”²è¿é’è½¦ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkArmoredTruckClick(clickX, clickY) {
            const ARMORED_TRUCK_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè£…ç”²è¿é’è½¦ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('armored_truck') && itemData.armored_truck) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„è£…ç”²è¿é’è½¦é™„è¿‘
                const nearbyArmoredTruck = itemData.armored_truck.find(armoredTruck => {
                    const distance = Math.sqrt(Math.pow(armoredTruck.x - clickX, 2) + Math.pow(armoredTruck.y - clickY, 2));
                    return distance <= ARMORED_TRUCK_RADIUS;
                });

                if (nearbyArmoredTruck) {
                    console.log('ç‚¹å‡»äº†è£…ç”²è¿é’è½¦é™„è¿‘:', nearbyArmoredTruck.name);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const armoredTruckIndex = itemData.armored_truck.findIndex(armoredTruck => 
                        armoredTruck.x === nearbyArmoredTruck.x && armoredTruck.y === nearbyArmoredTruck.y
                    );
                    showArmoredTruckPopup(nearbyArmoredTruck, armoredTruckIndex);
                }
            }
        }

        // æ¯’å“è½½å…·å¼¹çª—
        function showDrugVehiclePopup(item, index) {
            const title = `ğŸš— æ¯’å“è½½å…· #${index + 1}`;
            const content = `æ¯’å“è½½å…·ä¼šåœ¨æ­¤ä½ç½®é™„è¿‘åˆ·æ–°ã€‚é è¿‘æ—¶ä¼šåœ¨æ¸¸æˆä¸­ä»¥è“ç‚¹æ ‡è®°ã€‚`;
            
            const popup = document.createElement('div');
            popup.className = 'drug-vehicle-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #2E7D32; text-align:center;">${title}</div>
                <img src="https://gta-maps.antwen.com/collectibles_images/drug_vehicle/drug_vehicle.webp" alt="æ¯’å“è½½å…·å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #1b5e20; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drug-vehicle-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-drug-vehicle-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-drug-vehicle-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            // æŒ‰é’®
            const hideBtn = popup.querySelector('#hide-drug-vehicle-btn');
            const showBtn = popup.querySelector('#show-drug-vehicle-btn');
            const closeBtn = popup.querySelector('#close-drug-vehicle-btn');

            // è§£æç›®æ ‡æ ‡è®°å’Œç´¢å¼•
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drug_vehicle"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // æ²‰ç¡çš„ä¿å®‰å¼¹çª—
        function showDrunkGuardPopup(item, index) {
            const title = `ğŸ›Œ æ²‰ç¡çš„ä¿å®‰ #${index + 1}`;
            const content = `æœåˆ®ä»–ï¼ˆé”®ç›˜ä¸Šçš„E ï¼‰ä»¥è·å¾— 7.007 GTA$ å’Œä½©é‡Œç§‘å²›é‡‘å‘è€å¤§åŠå…¬å®¤çš„æŠ½å±‰é’¥åŒ™ã€‚æŠ½å±‰é‡Œé¢æœ‰ä¸€æŠŠ ä½©é‡Œç§‘æ‰‹æªã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/drunk_guard/drunk_guard.webp';
            
            const popup = document.createElement('div');
            popup.className = 'drunk-guard-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #795548; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #5D4037; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="æ²‰ç¡çš„ä¿å®‰å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #efebe9; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-drunk-guard-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-drunk-guard-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-drunk-guard-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-drunk-guard-btn');
            const showBtn = popup.querySelector('#show-drunk-guard-btn');
            const closeBtn = popup.querySelector('#close-drunk-guard-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="drunk_guard"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // é‡‘å±æ¢æµ‹å™¨å¼¹çª—ï¼ˆé€‚é…Leafletæ ‡è®°ç³»ç»Ÿï¼‰
        function showMetalDetectorPopup(item, index) {
            const title = `ğŸ§­ é‡‘å±æ¢æµ‹å™¨ #${index + 1}`;
            const content = `æ‚¨å¯ä»¥ä½¿ç”¨é‡‘å±æ¢æµ‹å™¨åœ¨ ä½©é‡Œç§‘å²› ä¸Šå®šä½ åœ°ä¸‹è—åŒ¿å“ - ã€‚<br/>æœç´¢éª·é«…å¯è·å¾— 5.000 è‡³ 10.000 GTA$ ä¸ç­‰çš„ç°é‡‘å¥–åŠ±ã€‚`;
            const imgUrl = `https://gta-maps.antwen.com/collectibles_images/metal_detector/metal_detector_${index + 1}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'metal-detector-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #607D8B; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #455A64; text-align:center;">${title}</div>
                <img src="${imgUrl}" alt="é‡‘å±æ¢æµ‹å™¨å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #ECEFF1; border-radius: 8px; color: #263238; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="close-metal-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-metal-btn');

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // è¾…åŠ©å‡½æ•°ï¼šé€šè¿‡DOMå…ƒç´ æŸ¥æ‰¾å¯¹åº”çš„Leafletæ ‡è®°å¯¹è±¡
        function findLeafletMarkerByElement(element) {
            console.log('æŸ¥æ‰¾Leafletæ ‡è®°ï¼ŒleafletMarkers.length:', leafletMarkers.length);
            for (let i = 0; i < leafletMarkers.length; i++) {
                const marker = leafletMarkers[i];
                if (marker && marker.getElement) {
                    const markerElement = marker.getElement();
                    console.log(`æ ‡è®°${i}:`, marker, 'å…ƒç´ :', markerElement);
                    if (markerElement === element) {
                        console.log('æ‰¾åˆ°åŒ¹é…çš„æ ‡è®°!');
                        return marker;
                    }
                }
            }
            console.log('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ ‡è®°');
            return null;
        }

        // æ›´æ–°ä¾§è¾¹æ  smuggler_plane è®¡æ•°
        function updateSmugglerPlaneSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-smuggler_plane + label .smuggler-counter');
                if (!counterEl) return;
                const groups = (window.smugglerGroupMarkers && window.smugglerGroupMarkers['smuggler_plane']) || [];
                let total = 0;
                let hidden = 0;
                if (Array.isArray(groups) && groups.length > 0) {
                    total = groups.length;
                    groups.forEach((groupMarkers) => {
                        if (groupMarkers && groupMarkers.length > 0) {
                            const first = groupMarkers[0];
                            if (first && first.getElement) {
                                const el = first.getElement();
                                if (el && el.style.opacity === '0.3') hidden++;
                            }
                        }
                    });
                } else {
                    total = Array.isArray(itemData.smuggler_plane) ? itemData.smuggler_plane.length : 0;
                    hidden = 0;
                }
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {}
        }

        // gun_van ä¾§è¾¹è®¡æ•°å™¨å·²ç§»é™¤ï¼ˆå ä½ç©ºå‡½æ•°ï¼Œé¿å…æ—§è°ƒç”¨æŠ¥é”™ï¼‰
        function updateGunVanSidebarCount() {}


        // èµ°ç§è´©è¸ªè¿¹å¼¹çª—
        function showSmugglerTrailPopup(item, index) {
            const title = `ğŸ›¤ï¸ èµ°ç§è´©è¸ªè¿¹ #${index + 1}`;
            const content = `æ²¿ç€ç”±å‡ ä¸ªçƒŸé›¾ä¿¡å·æ ‡è®°çš„è½¨è¿¹ï¼Œæ‚¨å°†æ‰¾åˆ°ä¸€ä¸ªè£…æœ‰25.000 GTA$å’Œ2.000 RPçš„ç®±å­ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/smuggler_trail/smuggler_trail.webp';
            
            const popup = document.createElement('div');
            popup.className = 'smuggler-trail-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="èµ°ç§è´©è¸ªè¿¹å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-smuggler-trail-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-smuggler-trail-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-smuggler-trail-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-smuggler-trail-btn');
            const showBtn = popup.querySelector('#show-smuggler-trail-btn');
            const closeBtn = popup.querySelector('#close-smuggler-trail-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="smuggler_trail"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // çŠ¯ç½ªç°åœºå¼¹çª—
        function showCrimeScenesPopup(item, index) {
            const title = `ğŸ” çŠ¯ç½ªç°åœº #${index + 1}`;
            const content = `å‰ 5 æ¬¡å®Œæˆè¯¥éšæœºäº‹ä»¶æ—¶ï¼Œæ¯æ¬¡æ‚¨éƒ½å°†è·å¾— 5.000 GTA$ã€2.000 RP ä¸ 1 ä¸ªå¡å®¾æªéƒ¨ä»¶ã€‚é›†é½ 5 ä¸ªéƒ¨ä»¶åï¼Œæ‚¨å°†è·å¾— 50.000 GTA$ ä¸ åˆ¶å¼å¡å®¾æ­¥æªã€‚æ­¤åï¼Œå®Œæˆä¸€æ¬¡è¯¥éšæœºäº‹ä»¶å¯è·å¾— 25.000 GTA$ ä¸ 2.000 RP å¥–åŠ±ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/crime_scenes/crime_scenes.webp';
            
            const popup = document.createElement('div');
            popup.className = 'crime-scenes-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF5722; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #D84315; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="çŠ¯ç½ªç°åœºå›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #FFF3E0; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-crime-scenes-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-crime-scenes-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-crime-scenes-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-crime-scenes-btn');
            const showBtn = popup.querySelector('#show-crime-scenes-btn');
            const closeBtn = popup.querySelector('#close-crime-scenes-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="crime_scenes"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // UFOè§‚å…‰å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showUfoPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ufo/ufo_${sequenceNumber}.webp`;
            const content = `å¯äº æ™šä¸Š 1000è‡³æ¬¡æ—¥æ—©ä¸Š 400 ï¼ˆä¸‡åœ£èŠ‚å¤©æ°”æœŸé—´ä¸º æ™šä¸Š 730è‡³æ¬¡æ—¥æ—©ä¸Š 630 ï¼‰æœŸé—´æ‰¾åˆ°ã€‚
å¥–åŠ±:
æ‹æ‘„ UFO å¹¶å°†å…¶å‘é€ç»™æ¬§ç±³åŠ ï¼Œå³å¯è·å¾— 15.000 GTA$ å’Œ 1.000 RP å¥–åŠ±ã€‚
æ‹æ‘„æ‰€æœ‰ 26 å¼ ç…§ç‰‡ä»¥èµšå–é¢å¤– 100.000 GTA$ å¥–åŠ±ï¼Œå¹¶è§£é” UFO ä¸»é¢˜å¸½å­ã€‚
æ‹æ‘„ æ½œè¡Œ UFO ï¼Œä»¥èµšå–é¢å¤– 50.000 GTA$ ä¸ 1.000 RP å¥–åŠ±ã€‚
å¯è¢« UFO æ•è·æ—¶ï¼Œæœ¬ç½‘ç«™çš„æ¸¸æˆæ—¶é’Ÿç»„ä»¶ä¸‹ä¼šæœ‰  æ ‡è¯†ã€‚è¢« UFO æ•è·å³å¯è·å¾— UFO ä¸»é¢˜å¹³è§’è£¤ä¸ã€‚è‹¥æ‚¨åœ¨è¢«æ•è·æ—¶æœªæ³¨å†Œä¸ºè€å¤§ï¼ˆä¿é•–äº‹åŠ¡æ‰€ã€æ‘©æ‰˜å¸®ï¼‰æˆ–æ‹…ä»»å‰¯æ‰‹ï¼Œæ‚¨å°†æœ‰ 50% çš„æ¦‚ç‡è¿›å…¥æ¡‘åº“å¤šå ¡å’å†›äº‹åŸºåœ°çš„ç§˜å¯†åœ°ä¸‹å®éªŒå®¤ã€‚å®éªŒå®¤ä¸­æœ‰ä¸€ä¸ªç®±å­ã€‚é¦–æ¬¡å¼€å¯æ—¶å¯è·å¾—æ­¦å™¨ç”µå‡»æ£’ä¸ç°è‰²å¤ªç©ºå…¥ä¾µè€…ï¼›æ­¤åå†æ¬¡å¼€å¯æ—¶å¯è·å¾— 25.000 GTA$ï¼ˆè‹¥æ‚¨æ›¾åœ¨å‰ 60 åˆ†é’Ÿå†…äºæ­¤å¤„è·å¾—è¿‡æ­¤å¥–åŠ±ï¼Œåˆ™åªèƒ½è·å¾— 2.000 GTA$ï¼‰ä¸ 1.000 RP å¥–åŠ±ã€‚è¦é€ƒç¦»å®éªŒå®¤ï¼Œæ‚¨å¿…é¡»æŒ‰æ­£ç¡®é¡ºåºæ‹‰ä¸‹ 4 æ ¹æ§åˆ¶æ†ã€‚æ¯æ ¹æ§åˆ¶æ†éƒ½æœ‰å„è‡ªå¯¹åº”çš„ç‹¬ç‰¹å›¾æ¡ˆã€‚æ‹‰æ§åˆ¶æ†çš„é¡ºåºåˆ™ä»¥è¿™äº›å›¾æ¡ˆå‡ºç°åœ¨å®éªŒå®¤å†…çš„æ¬¡æ•°è€Œå†³å®šã€‚æˆåŠŸé€ƒç¦»å®éªŒå®¤ï¼Œæ‚¨å°†è·å¾— ??? T æ¤ã€25.000 GTA$ ä¸ 1.000 RP å¥–åŠ±ã€‚è‹¥æ‚¨æœªèƒ½åœ¨ 10 åˆ†é’Ÿå†…é€ƒç¦»ï¼Œæˆ–æ‹‰ä¸‹é”™è¯¯çš„æ§åˆ¶æ†è¾¾åˆ° 3 æ¬¡ï¼Œå®éªŒå®¤å°†é‡Šæ”¾æ¯’æ°”å°†æ‚¨è¿·æ™•ï¼Œæ‚¨å°†æ— æ³•è·å¾—æˆåŠŸé€ƒç¦»çš„å¥–åŠ±ã€‚
æ€»è®¡æ”¶ç›Šï¼ˆä¸åŒ…æ‹¬å®éªŒå®¤å†…çš„å¥–åŠ±ï¼‰ï¼š540.000 GTA$ã€27.000 RP`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.ufo-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.ufoMarkers && window.ufoMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸ›¸ UFOè§‚å…‰ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'ufo-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="UFOè§‚å…‰ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ufo-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ufo-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ufo-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ufo-btn');
            const hideBtn = popup.querySelector('#hide-ufo-btn');
            const showBtn = popup.querySelector('#show-ufo-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ufo-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ufo', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ›¸ UFOè§‚å…‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateUfoSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ›¸ UFOè§‚å…‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateUfoSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°UFOè§‚å…‰æ ‡è®°
        function applyUfoVisibilityCache() {
            const markers = (window.ufoMarkers && window.ufoMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ufo');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨UFOè§‚å…‰å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ä¸‡åœ£èŠ‚æ€äººç‹‚å¼¹çª—
        function showHalloweenSlasherPopup(item, index) {
            const title = `ğŸƒ ${item.type}`;
            const content = `æ€äººç‹‚å¯èƒ½ä¼šåœ¨ æ—©ä¸Š 100è‡³æ—©ä¸Š 600 ä¹‹é—´å‡ºç°åœ¨å¯¹åº”åŒºåŸŸã€‚æ¯æ¬¡å‡ºç°éƒ½æœ‰ 50% çš„æ¦‚ç‡è¢«å…‹éš†æ€äººç‹‚æ›¿ä»£ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/halloween_slashers/halloween_slashers.webp';
            
            // ä¸ºä¸åŒç§ç±»çš„æ€äººç‹‚è®¾ç½®ä¸åŒçš„é¢œè‰²
            let borderColor, titleColor, bgColor;
            switch(item.type) {
                case 'clown':
                    borderColor = '#FF9800'; // æ©™è‰²
                    titleColor = '#E65100';
                    bgColor = '#FFF3E0';
                    break;
                case 'psycho':
                    borderColor = '#F44336'; // çº¢è‰²
                    titleColor = '#C62828';
                    bgColor = '#FFEBEE';
                    break;
                case 'driver':
                    borderColor = '#9C27B0'; // ç´«è‰²
                    titleColor = '#7B1FA2';
                    bgColor = '#F3E5F5';
                    break;
                case 'sackslasher':
                    borderColor = '#607D8B'; // è“ç°è‰²
                    titleColor = '#37474F';
                    bgColor = '#ECEFF1';
                    break;
                default:
                    borderColor = '#795548'; // æ£•è‰²
                    titleColor = '#5D4037';
                    bgColor = '#EFEBE9';
            }
            
            const popup = document.createElement('div');
            popup.className = 'halloween-slasher-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${borderColor}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: ${titleColor}; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="ä¸‡åœ£èŠ‚æ€äººç‹‚å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: ${bgColor}; border-radius: 8px; color: ${titleColor}; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-halloween-slasher-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-halloween-slasher-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-halloween-slasher-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-halloween-slasher-btn');
            const showBtn = popup.querySelector('#show-halloween-slasher-btn');
            const closeBtn = popup.querySelector('#close-halloween-slasher-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="halloween_slashers"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // é¬¼ä¸Šèº«åŠ¨ç‰©å¼¹çª—
        function showPossessedAnimalPopup(item, index) {
            const animalName = item.animalType === 'boar' ? 'é‡çŒª' : 
                              item.animalType === 'cougar' ? 'ç¾æ´²ç‹®' : 
                              item.animalType === 'coyote' ? 'éƒŠç‹¼' : 
                              item.animalType === 'deer' ? 'é¹¿' : 
                              item.animalType === 'pug' ? 'å“ˆå·´ç‹—' : 
                              item.animalType;
            const title = `ğŸº ${animalName}`;
            const content = `é¬¼ä¸Šèº«çš„åŠ¨ç‰©åœ¨æ™šä¸Š 800è‡³æ¬¡æ—¥æ—©ä¸Š 100ä¹‹é—´æ´»è·ƒã€‚`;
            
            // æ ¹æ®åŠ¨ç‰©ç±»å‹é€‰æ‹©å›¾ç‰‡
            let imageUrl;
            if (item.animalType === 'boar') {
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_boar.webp';
            } else if (item.animalType === 'cougar') {
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_cougar.webp';
            } else {
                // é»˜è®¤ä½¿ç”¨é‡çŒªå›¾ç‰‡
                imageUrl = 'https://gta-maps.antwen.com/collectibles_images/possessed_animals/possessed_animals_boar.webp';
            }
            
            // ä¸ºä¸åŒç§ç±»çš„åŠ¨ç‰©è®¾ç½®ä¸åŒçš„é¢œè‰²
            let borderColor, titleColor, bgColor;
            switch(item.animalType) {
                case 'boar':
                    borderColor = '#8D6E63'; // æ£•è‰²
                    titleColor = '#5D4037';
                    bgColor = '#EFEBE9';
                    break;
                case 'cougar':
                    borderColor = '#FF5722'; // æ©™çº¢è‰²
                    titleColor = '#D84315';
                    bgColor = '#FFF3E0';
                    break;
                case 'coyote':
                    borderColor = '#795548'; // æ·±æ£•è‰²
                    titleColor = '#4E342E';
                    bgColor = '#F3E5F5';
                    break;
                case 'deer':
                    borderColor = '#4CAF50'; // ç»¿è‰²
                    titleColor = '#2E7D32';
                    bgColor = '#E8F5E8';
                    break;
                case 'pug':
                    borderColor = '#9C27B0'; // ç´«è‰²
                    titleColor = '#6A1B9A';
                    bgColor = '#F3E5F5';
                    break;
                default:
                    borderColor = '#607D8B'; // è“ç°è‰²
                    titleColor = '#37474F';
                    bgColor = '#ECEFF1';
            }
            
            const popup = document.createElement('div');
            popup.className = 'possessed-animal-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${borderColor}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: ${titleColor}; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="é¬¼ä¸Šèº«åŠ¨ç‰©å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: ${bgColor}; border-radius: 8px; color: ${titleColor}; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-possessed-animal-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-possessed-animal-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-possessed-animal-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-possessed-animal-btn');
            const showBtn = popup.querySelector('#show-possessed-animal-btn');
            const closeBtn = popup.querySelector('#close-possessed-animal-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="possessed_animals"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // åœ°ç‹±çŠ¬å¼¹çª—
        function showCerberusPopup(item, index) {
            const title = `åœ°ç‹±çŠ¬ #${index + 1}`;
            const content = `å·çªƒå¤–è´¸å‡ºå£è½½å…·çš„åŒæ—¶ï¼Œè¯·åŠ¡å¿…å°å¿ƒç´§è¿½æ‚¨çš„åœ°ç‹±çŠ¬ã€‚`;
            
            const popup = document.createElement('div');
            popup.className = 'cerberus-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF5722; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #D84315; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #FFF3E0; border-radius: 8px; color: #D84315; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-cerberus-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-cerberus-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-cerberus-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-cerberus-btn');
            const showBtn = popup.querySelector('#show-cerberus-btn');
            const closeBtn = popup.querySelector('#close-cerberus-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="cerberus"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // é›ªæ€ªå¼¹çª—
        function showYetiPopup(item, index) {
            const title = `â„ï¸ é›ªæ€ªçº¿ç´¢ #${item.clueIndex}`;
            const content = `ä¸€å…±æœ‰äº”æ¡çº¿ç´¢ï¼Œä¸”å¯ç”±ä»»æ„é¡ºåºæ”¶é›†ã€‚çº¿ç´¢ä¼šå‘å‡ºå£°éŸ³ä»¥å¸®åŠ©æ‚¨å¯»æ‰¾ï¼Œæ‰¾åˆ°åï¼Œæ‚¨éœ€æŒ‰Eè¿›è¡Œè°ƒæŸ¥ã€‚æ¯æ¡çº¿ç´¢éƒ½å°†å¥–åŠ±æ‚¨10.000 GTA$ä¸1.000 RPã€‚é›†é½æ‰€æœ‰çº¿ç´¢åï¼Œé›ªæ€ªå°†äºæ™šä¸Š 900è‡³æ¬¡æ—¥æ—©ä¸Š 600æœŸé—´æŒç»­è¿½æ€æ‚¨ï¼Œç›´åˆ°æ‚¨å°†å…¶å‡»æ€ã€‚å‡»æ€æ—¶ï¼Œæ‚¨å°†è·å¾—50.000 GTA$ä¸<span id="yeti-award-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">é›ªæ€ªå¥—è£…</span>å¥–åŠ±ã€‚`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/yeti/yeti_${item.clueIndex}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'yeti-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="é›ªæ€ªçº¿ç´¢å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #1976D2; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-yeti-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-yeti-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-yeti-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-yeti-btn');
            const showBtn = popup.querySelector('#show-yeti-btn');
            const closeBtn = popup.querySelector('#close-yeti-btn');
            const awardLink = popup.querySelector('#yeti-award-link');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="yeti"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            
            // é›ªæ€ªå¥—è£…ç‚¹å‡»äº‹ä»¶
            awardLink.addEventListener('click', () => {
                showYetiAwardPopup();
            });
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // é›ªæ€ªå¥—è£…å¥–åŠ±å¼¹çª—
        function showYetiAwardPopup() {
            const popup = document.createElement('div');
            popup.className = 'yeti-award-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF9800; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 400px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 18px; font-weight: bold; color: #F57C00;">ğŸ† é›ªæ€ªå¥—è£…å¥–åŠ±</div>
                <img src="https://gta-maps.antwen.com/collectibles_images/yeti/yeti_award.webp" alt="é›ªæ€ªå¥—è£…å¥–åŠ±" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin-top: 15px;">
                    <button id="close-yeti-award-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const closeBtn = popup.querySelector('#close-yeti-award-btn');
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // èŠ‚æ—¥å¿«ä¹å¡è½¦å¼¹çª—
        function showHappyHolidaysHaulerPopup(group, index) {
            console.log('æ˜¾ç¤ºèŠ‚æ—¥å¿«ä¹å¡è½¦å¼¹çª—:', group, index);
            const title = `ğŸ„ èŠ‚æ—¥å¿«ä¹å¡è½¦ #${index + 1}`;
            const content = `èŠ‚æ—¥æ¬¢ä¹è´§è¿è½¦å·²å¼€å§‹åœ¨æ´›åœ£éƒ½å››å¤„è¡Œé©¶ï¼Œæ¯ 85-95 ç§’æŠ•æ”¾ä¸€æ¬¡èŠ‚æ—¥ç¤¼ç‰©ã€‚<br><br>å¯èƒ½çš„ç¤¼ç‰©æ¸…å•ï¼š<br>â€“ <span id="coca-cola-sweater-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">æ˜“å¯ä¹èŠ‚åº†æ¯›è¡£</span><br>â€“ <span id="sprite-sweater-link" style="color: #2196F3; cursor: pointer; text-decoration: underline;">éœœç¢§èŠ‚åº†æ¯›è¡£</span><br>â€“ 9.000-11.000 GTA$ï¼Œ1.000 RPå’Œé›¶é£Ÿ<br>â€“ 9.000-11.000 GTA$ï¼Œ1.000 RPå’Œå¼¹è¯`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/yeti_award.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'happy-holidays-hauler-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="${imageUrl}" alt="èŠ‚æ—¥å¿«ä¹å¡è½¦" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="text-align: center;">
                    <button id="close-hauler-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-hauler-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // æ·»åŠ æ¯›è¡£é“¾æ¥ç‚¹å‡»äº‹ä»¶
            const cocaColaLink = popup.querySelector('#coca-cola-sweater-link');
            const spriteLink = popup.querySelector('#sprite-sweater-link');
            
            cocaColaLink.addEventListener('click', (e) => {
                e.stopPropagation();
                showCocaColaSweaterPopup();
            });
            
            spriteLink.addEventListener('click', (e) => {
                e.stopPropagation();
                showSpriteSweaterPopup();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // å¨æ³½å°”å¤§æ¥¼æªæˆ˜å¼¹çª—
        function showWeaPopup(wea, index) {
            console.log('æ˜¾ç¤ºå¨æ³½å°”å¤§æ¥¼æªæˆ˜å¼¹çª—:', wea, index);
            const title = `ğŸ¢ å¨æ³½å°”å¤§æ¥¼æªæˆ˜`;
            const content = `è¯¥äº‹ä»¶å¯ä»¥åœ¨æ™šä¸Š 800è‡³æ¬¡æ—¥æ—©ä¸Š 600ä¹‹é—´è§¦å‘ã€‚é¦–æ¬¡å®Œæˆè¯¥æ´»åŠ¨ï¼Œæ‚¨å°†è·å¾— 1.000 RPï¼ŒWM 29 æ‰‹æªå’Œ Mk 2 æ‰‹æªçš„èŠ‚æ—¥å¿«ä¹æ¶‚è£…ã€‚å†æ¬¡å®Œæˆè¯¥æ´»åŠ¨ï¼Œæ‚¨å°†è·å¾—25.000 GTA$å’Œ1.000 RPã€‚`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/wea/wea.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'wea-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #e03232; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #e03232; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="${imageUrl}" alt="å¨æ³½å°”å¤§æ¥¼æªæˆ˜" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="text-align: center;">
                    <button id="close-wea-btn" style="padding: 10px 18px; background: #e03232; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-wea-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // é™†åœ°è¿·å¹»ä»™äººæŒå¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showPplPopup(ppl, index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ppl/ppl_${sequenceNumber}.webp`;
            const content = `æ¸¸æˆä¸­å…±æœ‰ 76 ä¸ªè¿·å¹»ä»™äººæŒï¼ˆ52 ä¸ªåœ¨é™†åœ°ä¸Š ï¼ˆåŒ…å« 2 ä¸ªç‰¹æ®Šçš„è¿·å¹»ä»™äººæŒ ï¼‰ï¼Œå¦æœ‰ 24 ä¸ªåœ¨æ°´ä¸‹ ï¼‰ã€‚è¿·å¹»ä»™äººæŒå¹¶ä¸ç«‹å³å‡ºç°ï¼Œæœ‰æ—¶æ‚¨é¡»ç¨ç­‰ç‰‡åˆ»ã€‚å½“æ‚¨é è¿‘å®ƒæ—¶ï¼Œæ¸¸æˆæ‰‹æŸ„ä¼šæŒ¯åŠ¨ï¼Œå®ƒè¿˜ä¼šå‘å‡ºç±»ä¼¼åŠ¨ç‰©å«å£°çš„å£°éŸ³ã€‚åƒä¸‹ï¼ˆæŒ‰é”®ï¼šEï¼‰è¿·å¹»ä»™äººæŒåï¼Œæ‚¨å°†å˜æˆ éšæœºåŠ¨ç‰© ä¸­çš„å…¶ä¸­ä¸€ç§ï¼Œå¹¶è·å¾— 5.000 RPã€‚æ‚¨ä¼šä¸€ç›´ç»´æŒåŠ¨ç‰©å½¢æ€ï¼Œé™¤éæ‚¨ï¼šæ­»äº¡ã€å…¥æ°´/ä¸Šå²¸ï¼Œæˆ–æŒ‰ä½ Eã€‚ä»¥ä¸Šæƒ…å†µéƒ½ä¼šä»¤æ‚¨åœ¨æœ€è¿‘çš„åŒ»é™¢é‡ç”Ÿã€‚åƒè¿‡çš„è¿·å¹»ä»™äººæŒå°†åœ¨ 48 åˆ†é’Ÿååˆ·æ–°ã€‚åˆ‡æ¢æˆ˜å±€æˆ–é‡å¯æ¸¸æˆä¸ä¼šé‡ç½®å†·å´æ—¶é—´ã€‚`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.ppl-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸŒµ é™†åœ°è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'ppl-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;
            
            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="é™†åœ°è¿·å¹»ä»™äººæŒ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ppl-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ppl-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ppl-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;
            
            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ppl-btn');
            const hideBtn = popup.querySelector('#hide-ppl-btn');
            const showBtn = popup.querySelector('#show-ppl-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ppl-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ppl', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸŒµ é™†åœ°è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePplSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸŒµ é™†åœ°è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePplSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°é™†åœ°è¿·å¹»ä»™äººæŒæ ‡è®°
        function applyPplVisibilityCache() {
            const markers = (window.pplMarkers && window.pplMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppl');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨é™†åœ°è¿·å¹»ä»™äººæŒå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ°´ä¸‹è¿·å¹»ä»™äººæŒå¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showPpwPopup(ppw, index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/ppw/ppw_${sequenceNumber}.webp`;
            const content = `æ¸¸æˆä¸­å…±æœ‰ 76 ä¸ªè¿·å¹»ä»™äººæŒï¼ˆ52 ä¸ªåœ¨é™†åœ°ä¸Š ï¼ˆåŒ…å« 2 ä¸ªç‰¹æ®Šçš„è¿·å¹»ä»™äººæŒ ï¼‰ï¼Œå¦æœ‰ 24 ä¸ªåœ¨æ°´ä¸‹ ï¼‰ã€‚è¿·å¹»ä»™äººæŒå¹¶ä¸ç«‹å³å‡ºç°ï¼Œæœ‰æ—¶æ‚¨é¡»ç¨ç­‰ç‰‡åˆ»ã€‚å½“æ‚¨é è¿‘å®ƒæ—¶ï¼Œæ¸¸æˆæ‰‹æŸ„ä¼šæŒ¯åŠ¨ï¼Œå®ƒè¿˜ä¼šå‘å‡ºç±»ä¼¼åŠ¨ç‰©å«å£°çš„å£°éŸ³ã€‚åƒä¸‹ï¼ˆæŒ‰é”®ï¼šEï¼‰è¿·å¹»ä»™äººæŒåï¼Œæ‚¨å°†å˜æˆ éšæœºåŠ¨ç‰© ä¸­çš„å…¶ä¸­ä¸€ç§ï¼Œå¹¶è·å¾— 5.000 RPã€‚æ‚¨ä¼šä¸€ç›´ç»´æŒåŠ¨ç‰©å½¢æ€ï¼Œé™¤éæ‚¨ï¼šæ­»äº¡ã€å…¥æ°´/ä¸Šå²¸ï¼Œæˆ–æŒ‰ä½ Eã€‚ä»¥ä¸Šæƒ…å†µéƒ½ä¼šä»¤æ‚¨åœ¨æœ€è¿‘çš„åŒ»é™¢é‡ç”Ÿã€‚åƒè¿‡çš„è¿·å¹»ä»™äººæŒå°†åœ¨ 48 åˆ†é’Ÿååˆ·æ–°ã€‚åˆ‡æ¢æˆ˜å±€æˆ–é‡å¯æ¸¸æˆä¸ä¼šé‡ç½®å†·å´æ—¶é—´ã€‚`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.ppw-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸŒŠ æ°´ä¸‹è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'ppw-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;
            
            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ°´ä¸‹è¿·å¹»ä»™äººæŒ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ppw-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ppw-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ppw-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;
            
            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ppw-btn');
            const hideBtn = popup.querySelector('#hide-ppw-btn');
            const showBtn = popup.querySelector('#show-ppw-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ppw-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ppw', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸŒŠ æ°´ä¸‹è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePpwSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸŒŠ æ°´ä¸‹è¿·å¹»ä»™äººæŒ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updatePpwSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ°´ä¸‹è¿·å¹»ä»™äººæŒæ ‡è®°
        function applyPpwVisibilityCache() {
            const markers = (window.ppwMarkers && window.ppwMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('ppw');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ°´ä¸‹è¿·å¹»ä»™äººæŒå¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ–°ç‰©å“å¼¹çª—ï¼ˆåœ°é“ç«™ã€è­¦å¯Ÿå±€ã€æœ›è¿œé•œã€æ¶ˆé˜²å±€ã€åŒ»é™¢ï¼‰
        function showNewItemPopup(type, item, index) {
            console.log(`æ˜¾ç¤º${type}å¼¹çª—:`, item, index);
            
            const typeNames = {
                metro: { name: 'åœ°é“ç«™', emoji: 'ğŸš‡', color: '#2196F3' },
                police: { name: 'è­¦å¯Ÿå±€', emoji: 'ğŸš”', color: '#2196F3' },
                v_telescopes: { name: 'æœ›è¿œé•œ', emoji: 'ğŸ”­', color: '#9C27B0' },
                fire_stations: { name: 'æ¶ˆé˜²å±€', emoji: 'ğŸš’', color: '#f44336' },
                hospitals: { name: 'åŒ»é™¢', emoji: 'ğŸ¥', color: '#4CAF50' },
                clothing: { name: 'æœè£…åº—', emoji: 'ğŸ‘•', color: '#FF9800' },
                tattoos: { name: 'çº¹èº«åº—', emoji: 'ğŸ¨', color: '#E91E63' },
                barbers: { name: 'ç†å‘åº—', emoji: 'ğŸ’‡', color: '#795548' },
                ammunation: { name: 'æ­¦è£…å›½åº¦', emoji: 'ğŸ”«', color: '#FF5722' },
                mod_shop: { name: 'æ´›åœ£éƒ½æ”¹è½¦ç‹', emoji: 'ğŸ”§', color: '#607D8B' },
                car_wash: { name: 'æ´—è½¦åº—', emoji: 'ğŸ§½', color: '#00BCD4' },
                shops_to_rob: { name: 'å¯æŠ¢åŠ«çš„å•†åº—', emoji: 'ğŸª', color: '#F44336' },
                gas_stations: { name: 'åŠ æ²¹ç«™', emoji: 'â›½', color: '#FFC107' },
                atms: { name: 'ATMæœº', emoji: 'ğŸ’°', color: '#4CAF50' },
                vend_sprunk: { name: 'éœœç¢§å”®å–æœº', emoji: 'ğŸ¥¤', color: '#8BC34A' },
                vend_ecola: { name: 'æ˜“å¯ä¹å”®å–æœº', emoji: 'ğŸ¥¤', color: '#CDDC39' }
            };
            
            const typeInfo = typeNames[type];
            const title = `${typeInfo.emoji} ${typeInfo.name} #${index + 1}`;
            const content = getNewItemContent(type, item);
            
            const popup = document.createElement('div');
            popup.className = `${type}-popup`;
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid ${typeInfo.color}; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: ${typeInfo.color}; font-size: 18px; font-weight: bold;">${title}</h3>
                </div>
                <div style="color: #333; line-height: 1.5; margin-bottom: 16px; font-size: 14px;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-${type}-btn" style="padding: 10px 18px; background: ${typeInfo.color}; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-${type}-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-${type}-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;
            
            const hideBtn = popup.querySelector(`#hide-${type}-btn`);
            const showBtn = popup.querySelector(`#show-${type}-btn`);
            const closeBtn = popup.querySelector(`#close-${type}-btn`);

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // è·å–æ–°ç‰©å“çš„å†…å®¹ä¿¡æ¯
        function getNewItemContent(type, item) {
            const baseInfo = `åæ ‡: ${item.x}, ${item.y}`;
            const labelInfo = item.label ? `<br><br>æ ‡ç­¾: ${item.label}` : '';
            
            switch(type) {
                case 'metro':
                    return `åœ°é“ç«™ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>åœ°é“ç«™æ˜¯æ´›åœ£éƒ½å…¬å…±äº¤é€šç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè¿æ¥åŸå¸‚å„ä¸ªåŒºåŸŸã€‚`;
                case 'police':
                    return `è­¦å¯Ÿå±€ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>è­¦å¯Ÿå±€æ˜¯æ‰§æ³•éƒ¨é—¨çš„é‡è¦è®¾æ–½ï¼Œæä¾›å„ç§æ‰§æ³•æœåŠ¡ã€‚`;
                case 'v_telescopes':
                    return `æœ›è¿œé•œä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}<br><br>æœ›è¿œé•œæ˜¯è§‚å¯Ÿå’Œæ¢ç´¢æ´›åœ£éƒ½ç¾æ™¯çš„ç†æƒ³å·¥å…·ã€‚`;
                case 'fire_stations':
                    return `æ¶ˆé˜²å±€ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æ¶ˆé˜²å±€è´Ÿè´£å¤„ç†ç«ç¾å’Œå…¶ä»–ç´§æ€¥æƒ…å†µï¼Œä¿æŠ¤å¸‚æ°‘å®‰å…¨ã€‚`;
                case 'hospitals':
                    return `åŒ»é™¢ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>åŒ»é™¢æä¾›åŒ»ç–—æœåŠ¡ï¼Œæ˜¯å¸‚æ°‘å¥åº·çš„é‡è¦ä¿éšœã€‚`;
                case 'clothing':
                    return `æœè£…åº—ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æœè£…åº—æä¾›å„ç§æœè£…å’Œé…é¥°ï¼Œè®©æ‚¨æ‰“é€ ç‹¬ç‰¹çš„ä¸ªäººé£æ ¼ã€‚`;
                case 'tattoos':
                    return `çº¹èº«åº—ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>çº¹èº«åº—æä¾›ä¸“ä¸šçš„çº¹èº«æœåŠ¡ï¼Œè®©æ‚¨å±•ç°ä¸ªæ€§ã€‚`;
                case 'barbers':
                    return `ç†å‘åº—ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>ç†å‘åº—æä¾›ç†å‘å’Œé€ å‹æœåŠ¡ï¼Œè®©æ‚¨ä¿æŒæœ€ä½³å½¢è±¡ã€‚`;
                case 'ammunation':
                    return `æ­¦è£…å›½åº¦ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æ­¦è£…å›½åº¦æ˜¯è´­ä¹°æ­¦å™¨å’Œå¼¹è¯çš„ä¸“ä¸šå•†åº—ã€‚`;
                case 'mod_shop':
                    return `æ´›åœ£éƒ½æ”¹è½¦ç‹ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æ´›åœ£éƒ½æ”¹è½¦ç‹æä¾›ä¸“ä¸šçš„è½¦è¾†æ”¹è£…æœåŠ¡ï¼ŒåŒ…æ‹¬LSCã€ç­å°¼æ”¹è£…åŠå’Œæ´›åœ£éƒ½è½¦å‹ä¼šç­‰ä¸åŒç±»å‹çš„æ”¹è£…æœåŠ¡ã€‚`;
                case 'car_wash':
                    return `æ´—è½¦åº—ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æ´—è½¦åº—æä¾›ä¸“ä¸šçš„è½¦è¾†æ¸…æ´æœåŠ¡ã€‚`;
                case 'shops_to_rob':
                    return `å¯æŠ¢åŠ«çš„å•†åº—ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>è¿™äº›å•†åº—å¯ä»¥è¿›è¡ŒæŠ¢åŠ«æ´»åŠ¨ï¼Œä½†è¯·æ³¨æ„é£é™©ã€‚`;
                case 'gas_stations':
                    return `åŠ æ²¹ç«™ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>åŠ æ²¹ç«™ä¸ºæ‚¨çš„è½¦è¾†æä¾›ç‡ƒæ–™è¡¥ç»™æœåŠ¡ã€‚`;
                case 'atms':
                    return `ATMæœºä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>ATMæœºæä¾›ä¾¿æ·çš„ç°é‡‘å­˜å–æœåŠ¡ã€‚`;
                case 'vend_sprunk':
                    return `éœœç¢§å”®å–æœºä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>éœœç¢§å”®å–æœºæä¾›æ¸…çˆ½çš„éœœç¢§é¥®æ–™ã€‚`;
                case 'vend_ecola':
                    return `æ˜“å¯ä¹å”®å–æœºä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}<br><br>æ˜“å¯ä¹å”®å–æœºæä¾›ç»å…¸çš„æ˜“å¯ä¹é¥®æ–™ã€‚`;
                default:
                    return `${type}ä½ç½®ä¿¡æ¯ã€‚<br><br>${baseInfo}${labelInfo}`;
            }
        }

        // æ˜“å¯ä¹èŠ‚åº†æ¯›è¡£å¼¹çª—
        function showCocaColaSweaterPopup() {
            const popup = document.createElement('div');
            popup.className = 'coca-cola-sweater-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">ğŸ¥¤ æ˜“å¯ä¹èŠ‚åº†æ¯›è¡£</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/happy_holidays_hauler_sweater_0.webp" alt="æ˜“å¯ä¹èŠ‚åº†æ¯›è¡£" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="text-align: center;">
                    <button id="close-coca-cola-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-coca-cola-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // éœœç¢§èŠ‚åº†æ¯›è¡£å¼¹çª—
        function showSpriteSweaterPopup() {
            const popup = document.createElement('div');
            popup.className = 'sprite-sweater-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF6B6B; border-radius: 12px; padding: 18px;
                z-index: 10001; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                overflow-y: auto; font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #FF6B6B; font-size: 18px; font-weight: bold;">ğŸ¥¤ éœœç¢§èŠ‚åº†æ¯›è¡£</h3>
                </div>
                <div style="text-align: center; margin-bottom: 12px;">
                    <img src="https://gta-maps.antwen.com/collectibles_images/happy_holidays_hauler/happy_holidays_hauler_sweater_1.webp" alt="éœœç¢§èŠ‚åº†æ¯›è¡£" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                </div>
                <div style="text-align: center;">
                    <button id="close-sprite-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;
            
            const closeBtn = popup.querySelector('#close-sprite-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // ç¤¾åŒºè¾¹ç•Œå¼¹çª—
        function showCommunityOutreachPopup(item, index) {
            const title = `ğŸ˜ï¸ ç¤¾åŒºè¾¹ç•Œ #${index + 1}`;
            const content = `è¯¥äº‹ä»¶æ—¢æ²¡æœ‰ä»»åŠ¡ç›®æ ‡ï¼Œä¹Ÿæ²¡æœ‰å®Œæˆå¥–åŠ±ã€‚ä¸è¿‡ï¼Œæ‚¨å¯ä»¥è—‰æ­¤å…è´¹è¯•é©¾éå‡¡ è‰³å¦‡ D10 è¿½é€å’Œå¨æ‹‰å¾· è¾¹ç•Œå®—æ´¾ã€‚`;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/community_outreach/community_outreach_${index + 1}.webp`;
            
            const popup = document.createElement('div');
            popup.className = 'community-outreach-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #2E7D32; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="ç¤¾åŒºè¾¹ç•Œå›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #E8F5E8; border-radius: 8px; color: #2E7D32; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-community-outreach-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-community-outreach-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-community-outreach-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-community-outreach-btn');
            const showBtn = popup.querySelector('#show-community-outreach-btn');
            const closeBtn = popup.querySelector('#close-community-outreach-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="community_outreach"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // å¤–è´¸å‡ºå£è½½å…·å¼¹çª—
        function showExoticExportsPopup(item, index, type) {
            const title = `ğŸš— å¤–è´¸å‡ºå£è½½å…·${type === 'exotic_exports1' ? '1' : '2'} #${index + 1}`;
            
            // æ„å»ºè½¦è¾†åˆ—è¡¨å†…å®¹
            let vehicleListContent = '';
            if (item.vehicleList && item.vehicleList.length > 0) {
                vehicleListContent = item.vehicleList.map(vehicle => `â€¢ ${vehicle.trim()}`).join('<br>');
            } else {
                vehicleListContent = 'æš‚æ— è½¦è¾†æ•°æ®';
            }
            
            const content = `
                <div style="margin-bottom: 10px;">
                    <strong>ä»Šæ—¥å¤–è´¸å‡ºå£è½½å…·åˆ—è¡¨ï¼š</strong><br>
                    ${vehicleListContent}
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    è¯¥æ´»åŠ¨å°†åœ¨å®Œæˆä¸€ä¸ªæ”¹è½¦é“ºåˆçº¦åè§£é”ã€‚æ‚¨æ¯å¤©å¯ä»¥æ‰¾åˆ°å¹¶äº¤ä»˜ 10 è¾†å¤–è´¸è½½å…·ï¼Œè¿™ 10 è¾†å¤–è´¸è½½å…·ä»¥ç‰¹å®šé¡ºåºç”Ÿæˆã€‚æ¯é€è¾¾ä¸€è¾†å¤–è´¸è½½å…·ï¼Œæ‚¨å°†è·å¾— 20.000 GTA$ã€1.000 RP ä¸ 50 REP å¥–åŠ±ã€‚è‹¥åœ¨ä¸€å¤©å†…äº¤ä»˜å…¨éƒ¨ 10 è¾†å¤–è´¸è½½å…·ï¼Œè¿˜å¯è·å¾—é¢å¤– 100.000 GTA$ çš„å¥–åŠ±ã€‚
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'exotic-exports-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #E3F2FD; border-radius: 8px; color: #1565C0; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-exotic-exports-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-exotic-exports-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-exotic-exports-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-exotic-exports-btn');
            const showBtn = popup.querySelector('#show-exotic-exports-btn');
            const closeBtn = popup.querySelector('#close-exotic-exports-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // å•†åº—æŠ¢åŠ«å¼¹çª—
        function showStoreRobberyPopup(item, index) {
            const title = `ğŸª å•†åº—æŠ¢åŠ« #${index + 1}`;
            const content = `åœ¨ 2 åˆ†é’Ÿå†…å°†è¢«ç›—çš„ç°é‡‘è¿˜ç»™å•†åº—ï¼Œå³å¯è·å¾— 20.000 GTA$ ä¸ 2.500 RP å¥–åŠ±ã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©å°†å…¶æ®ä¸ºå·±æœ‰ï¼š25.000 GTA$ å’Œ 2 ä¸ªé€šç¼‰ç­‰çº§ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/store_robbery/store_robbery.webp';
            
            const popup = document.createElement('div');
            popup.className = 'store-robbery-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #FF9800; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #E65100; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="å•†åº—æŠ¢åŠ«å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #FFF8E1; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-store-robbery-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-store-robbery-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-store-robbery-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-store-robbery-btn');
            const showBtn = popup.querySelector('#show-store-robbery-btn');
            const closeBtn = popup.querySelector('#close-store-robbery-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="store_robbery"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // è½¦é˜Ÿå¼¹çª—
        function showConvoyPopup(item, index) {
            const title = `ğŸš› è½¦é˜Ÿ #${index + 1}`;
            const content = `è½¦é˜Ÿä»èµ·å§‹ç‚¹å‡ºå‘ï¼Œæ²¿ç€çº¢è‰²è·¯çº¿è¡Œé©¶ã€‚è½¦é˜Ÿèµ°å®Œè·¯çº¿åï¼Œå°†éšæœºé€‰æ‹©ä¸€ä¸ªç»ˆç‚¹ä½ç½®ç»§ç»­è¡Œé©¶ï¼Œå¹¶åœ¨æŠµè¾¾è¯¥ä½ç½®åæ¶ˆå¤±ã€‚<br><br>å·å–è½¦é˜Ÿè½½å…·å¹¶å°†å…¶é€è‡³æ‚¨çš„äº§ä¸šï¼Œæ‚¨å°†è·å¾—åŸææ–™è¡¥ç»™å’Œ 1.000 RPã€‚<br><br>æ¯ä¸ªåœ°ç‚¹åˆ†åˆ«å¯¹åº”ä¸åŒçš„è½½å…·ä¸äº§ä¸šã€‚<br><br>å¦‚æœæ‚¨æ²¡æœ‰å¯¹åº”çš„äº§ä¸šï¼Œå¯ä»¥æŠŠç›®æ ‡è½½å…·é€è‡³æŒ‡å®šæŠ•æ”¾ç‚¹ï¼Œæ‚¨å°†è·å¾— 25.000 GTA$ ä¸ 1.000 RPã€‚`;
            
            const popup = document.createElement('div');
            popup.className = 'convoy-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #F44336; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #C62828; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #FFEBEE; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-convoy-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-convoy-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-convoy-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-convoy-btn');
            const showBtn = popup.querySelector('#show-convoy-btn');
            const closeBtn = popup.querySelector('#close-convoy-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="convoy"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
                // åŒæ—¶éšè—å¯¹åº”çš„è·¯çº¿
                const lines = document.querySelectorAll(`.convoy-route-line[data-index="${index}"]`);
                lines.forEach(line => line.style.opacity = '0.25');
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
                // åŒæ—¶æ˜¾ç¤ºå¯¹åº”çš„è·¯çº¿
                const lines = document.querySelectorAll(`.convoy-route-line[data-index="${index}"]`);
                lines.forEach(line => line.style.opacity = '1');
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // è½¦é˜Ÿç»ˆç‚¹å¼¹çª—
        function showConvoyFinalPopup(item, index) {
            const title = `ğŸ è½¦é˜Ÿç»ˆç‚¹ #${index + 1}`;
            const content = `è¿™æ˜¯è½¦é˜Ÿå¯èƒ½åˆ°è¾¾çš„ç»ˆç‚¹ä½ç½®ä¹‹ä¸€ã€‚è½¦é˜Ÿèµ°å®Œè·¯çº¿åï¼Œå°†éšæœºé€‰æ‹©ä¸€ä¸ªç»ˆç‚¹ä½ç½®ç»§ç»­è¡Œé©¶ï¼Œå¹¶åœ¨æŠµè¾¾è¯¥ä½ç½®åæ¶ˆå¤±ã€‚<br><br>æ‚¨å¯ä»¥åœ¨è½¦é˜Ÿè·¯çº¿ä¸Šæ‹¦æˆªè½¦é˜Ÿï¼Œæˆ–è€…åœ¨ç»ˆç‚¹ç­‰å€™è½¦é˜Ÿåˆ°è¾¾ã€‚`;
            
            const popup = document.createElement('div');
            popup.className = 'convoy-final-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #4CAF50; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #388E3C; text-align:center;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #E8F5E8; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-convoy-final-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-convoy-final-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-convoy-final-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-convoy-final-btn');
            const showBtn = popup.querySelector('#show-convoy-final-btn');
            const closeBtn = popup.querySelector('#close-convoy-final-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="convoy_final"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // è£…ç”²è¿é’è½¦å¼¹çª—
        function showArmoredTruckPopup(item, index) {
            const title = `ğŸ’° è£…ç”²è¿é’è½¦ #${index + 1}`;
            const content = `ä½¿ç”¨é»å¼¹ç‚¸å¼€è¿é’è½¦çš„åé—¨ä»¥è·å–é‡Œé¢çš„ç°é‡‘â€”â€”25.000 GTA$å’Œ1.000 RPã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/armored_truck/armored_truck.webp';
            
            const popup = document.createElement('div');
            popup.className = 'armored-truck-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2; text-align:center;">${title}</div>
                <img src="${imageUrl}" alt="è£…ç”²è¿é’è½¦å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display:block;"/>
                <div style="margin: 10px 0; padding: 10px; background: #F3E5F5; border-radius: 8px; color: #3e2723; font-size: 13px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-armored-truck-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-armored-truck-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-armored-truck-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            const hideBtn = popup.querySelector('#hide-armored-truck-btn');
            const showBtn = popup.querySelector('#show-armored-truck-btn');
            const closeBtn = popup.querySelector('#close-armored-truck-btn');

            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="armored_truck"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            closeBtn.addEventListener('click', () => popup.remove());
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // ç›å¾·æ‹‰ç´¢é›‡å‡¶å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showMadrazoHitsPopup(item, index) {
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.madrazo-hits-popup');
            if (existingPopup) existingPopup.remove();

            // ç›å¾·æ‹‰ç´¢é›‡å‡¶ç‰¹æ®Šï¼šå›ºå®šä¸º1ä¸ªï¼Œè™½ç„¶ä¼šæ˜¾ç¤ºå¤šä¸ªå›¾æ ‡
            const totalCount = 1;
            let hiddenCount = 0;

            // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„éšè—çŠ¶æ€
            const visibilityMap = VisibilityCache.loadVisibility('madrazo_hits');
            if (visibilityMap[0] === true) {
                hiddenCount = 1;
            }

            const title = `ğŸ¯ ç›å¾·æ‹‰ç´¢é›‡å‡¶ #${index + 1} (${hiddenCount}/${totalCount})`;
            const content = `æ‚¨éœ€è¦æ‹¥æœ‰ä¿é‡‘åŠå…¬å®¤  æ‰èƒ½è¿›è¡Œç›å¾·æ‹‰ç´¢é›‡å‡¶ã€‚<br><br>æ‚¨æ¯å¤©éƒ½å¯æ¥ä¸‹é©¬ä¸Â·ç›å¾·æ‹‰ç´¢çš„é›‡å‡¶æš—æ€ã€‚å¹²æ‰ç›®æ ‡å³å¯è·å¾— 500 RP ä¸ 20.000 GTA$ å¥–åŠ±ï¼Œä½¿ç”¨ç›å¾·æ‹‰ç´¢æŒ‡å®šçš„æ­¦å™¨å®Œæˆæš—æ€è¿˜å¯é¢å¤–è·å¾— 10.000 GTA$ã€‚ç›®æ ‡çš„ä½ç½®å¸¸é©»äºæ¸¸æˆå†…åœ°å›¾ä¸Šï¼Œæ‚¨å¯å‚è€ƒæœ¬åœ°å›¾çš„å›¾æ ‡åœ¨æ¸¸æˆä¸­æŸ¥æ‰¾ã€‚`;
            
            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'madrazo-hits-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${hiddenCount > 0 ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${hiddenCount > 0 ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-madrazo-hits-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-madrazo-hits-btn');
            const hideBtn = popup.querySelector('#hide-madrazo-hits-btn');
            const showBtn = popup.querySelector('#show-madrazo-hits-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºæ‰€æœ‰ç›å¾·æ‹‰ç´¢é›‡å‡¶æ ‡è®°
            function setAllMadrazoHitsVisibility(opacity) {
                // éšè—/æ˜¾ç¤ºæ‰€æœ‰ç›å¾·æ‹‰ç´¢é›‡å‡¶æ ‡è®°
                const markers = (window.madrazoHitsMarkers && window.madrazoHitsMarkers) || [];
                markers.forEach((marker) => {
                    if (marker && typeof marker.setOpacity === 'function') {
                        marker.setOpacity(opacity);
                    } else if (marker && typeof marker.setStyle === 'function') {
                        marker.setStyle({ opacity });
                    }
                });
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('madrazo_hits', 0, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
            hideBtn.addEventListener('click', () => {
                    setAllMadrazoHitsVisibility(0.3);
                    const newHiddenCount = 1;
                    titleElement.textContent = `ğŸ¯ ç›å¾·æ‹‰ç´¢é›‡å‡¶ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateMadrazoHitsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
            showBtn.addEventListener('click', () => {
                    setAllMadrazoHitsVisibility(1);
                    const newHiddenCount = 0;
                    titleElement.textContent = `ğŸ¯ ç›å¾·æ‹‰ç´¢é›‡å‡¶ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateMadrazoHitsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // å¸•ç‰¹é‡Œå…‹æ•‘æ´å¼¹çª—
        function showPatrickRescuePopup(item, index, type) {
            const typeNames = {
                'spawn': 'ç”Ÿæˆç‚¹',
                'dropoff': 'é€è¾¾ç‚¹'
            };
            
            const title = `ğŸš” å¸•ç‰¹é‡Œå…‹æ•‘æ´ - ${typeNames[type]} #${index + 1}`;
            const content = `å¯»æ‰¾æ­£åœ¨é¸£ç¬›å·¡é€»çš„è­¦ç”¨è¿è¾“è½¦ã€‚è¿™è¾†è½¦ä»¥è“ç‚¹æ ‡è®°åœ¨åœ°å›¾ä¸Šã€‚æ‹¦æˆªå›šè½¦ï¼Œæ•‘å‡ºå›šçŠ¯ã€‚å›šè½¦ä¼šç”Ÿæˆåœ¨ ï¼Œæ‚¨éœ€è¦å°†å…¶é€è‡³ ã€‚è¿æ°”å¥½çš„è¯ï¼Œæ‚¨ä¹Ÿæœ‰å¯èƒ½åœ¨é€è¾¾ç‚¹å‘ç°äº‹ä»¶ã€‚<br><br>å¥–åŠ±ï¼š10.000 GTA$ã€2.000 RPï¼Œè§£é”åé’»èµŒåœºè±ªåŠ«çš„æªæ‰‹å¸•ç‰¹é‡Œå…‹Â·éº¦å…‹ç‘åˆ©ï¼ˆ8% åˆ†çº¢ï¼‰ã€‚`;
            const imageUrl = 'https://gta-maps.antwen.com/collectibles_images/patrick/patrick.webp';
            
            const popup = document.createElement('div');
            popup.className = 'patrick-rescue-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #2196F3; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: center; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #1976D2;">${title}</div>
                <img src="${imageUrl}" alt="å¸•ç‰¹é‡Œå…‹æ•‘æ´å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0;"/>
                <div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 8px; color: #4e342e; font-size: 13px; text-align: left; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-patrick-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-patrick-btn" style="padding: 10px 18px; background: #2196F3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-patrick-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            // éšè—/æ˜¾ç¤º/å…³é—­æŒ‰é’®
            const hideBtn = popup.querySelector('#hide-patrick-btn');
            const showBtn = popup.querySelector('#show-patrick-btn');
            const closeBtn = popup.querySelector('#close-patrick-btn');

            // è§£æç›®æ ‡æ ‡è®°å’Œç´¢å¼•
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="police_rescue_patrick_mcreary_${type}"][data-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // éšè—æŒ‰é’®ï¼šè®¾ç½®æ ‡è®°é€æ˜åº¦ä¸º25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // æ˜¾ç¤ºæŒ‰é’®ï¼šæ¢å¤æ ‡è®°é€æ˜åº¦ä¸º100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // å…³é—­æŒ‰é’®
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // éšæœºä»»åŠ¡å¼¹çª—
        function showRandomMissionPopup(mission, timeSlot, index) {
            if (!Array.isArray(mission) || mission.length < 4) return;
            
            const taskName = Array.isArray(mission[2]) ? mission[2][0] : mission[2];
            const details = mission[3];
            
            if (!Array.isArray(details) || details.length < 3) return;
            
            const level = details[0];
            const players = details[1];
            const timeRange = details[2];
            
            const title = `ğŸ² éšæœºä»»åŠ¡ - ${taskName}`;
            const content = `
                <div style="margin-bottom: 10px;">
                    <strong>ä»»åŠ¡å:</strong> ${taskName}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>å¼€æ”¾ç­‰çº§:</strong> ${level}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>äººæ•°:</strong> ${players}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>å¼€æ”¾æ—¶é—´:</strong> ${timeRange}
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.className = 'random-mission-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #fff; border: 3px solid #9C27B0; border-radius: 12px; padding: 18px;
                z-index: 10000; max-width: 520px; max-height: 80vh; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; text-align: left; overflow-y: auto;`;

            popup.innerHTML = `
                <div style="margin-bottom: 14px; font-size: 20px; font-weight: bold; color: #7B1FA2;">${title}</div>
                <div style="margin: 10px 0; padding: 10px; background: #f3e5f5; border-radius: 8px; color: #4e342e; font-size: 14px; line-height: 1.6;">
                    ${content}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="hide-random-mission-btn" style="padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">éšè—</button>
                    <button id="show-random-mission-btn" style="padding: 10px 18px; background: #9C27B0; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">æ˜¾ç¤º</button>
                    <button id="close-random-mission-btn" style="padding: 10px 18px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">å…³é—­</button>
                </div>
            `;

            // éšè—/æ˜¾ç¤º/å…³é—­æŒ‰é’®
            const hideBtn = popup.querySelector('#hide-random-mission-btn');
            const showBtn = popup.querySelector('#show-random-mission-btn');
            const closeBtn = popup.querySelector('#close-random-mission-btn');

            // è§£æç›®æ ‡æ ‡è®°å’Œç´¢å¼•
            function resolveTargetAndIndex() {
                const el = document.querySelector(`.item-marker[data-type="random_missions"][data-time-slot="${timeSlot}"][data-mission-index="${index}"]`);
                return { el, globalIndex: index };
            }

            // éšè—æŒ‰é’®ï¼šè®¾ç½®æ ‡è®°é€æ˜åº¦ä¸º25%
            hideBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '0.25';
            });

            // æ˜¾ç¤ºæŒ‰é’®ï¼šæ¢å¤æ ‡è®°é€æ˜åº¦ä¸º100%
            showBtn.addEventListener('click', () => {
                const { el } = resolveTargetAndIndex();
                if (!el) return;
                el.style.opacity = '1';
            });

            // å…³é—­æŒ‰é’®
            closeBtn.addEventListener('click', () => popup.remove());
            
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) { popup.remove(); document.removeEventListener('click', closePopupHandler); }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            document.body.appendChild(popup);
        }

        // ç”µå½±é“å…·å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showMoviePropsPopup(item, globalIndex, subtype) {
            const typeNames = {
                'fixed_position': 'å›ºå®šä½ç½®',
                'pony': 'Ponyè½½å…·',
                'rebel': 'Rebelè½½å…·',
                'rumpo': 'Rumpoè½½å…·'
            };
            
            const imageUrls = {
                'fixed_position': 'ls_c_mp_static',
                'pony': 'ls_c_mp_pony',
                'rebel': 'ls_c_mp_rebel',
                'rumpo': 'ls_c_mp_rumpo'
            };
            
            // è®¡ç®—å­ç±»å‹ç´¢å¼•
            const mp = itemData.movie_props;
            const fixedCount = mp.fixed_position?.length || 0;
            const ponyCount = mp.vehicles?.pony?.length || 0;
            const rebelCount = mp.vehicles?.rebel?.length || 0;
            
            let subtypeIndex = globalIndex;
            if (subtype === 'pony') subtypeIndex = globalIndex - fixedCount;
            else if (subtype === 'rebel') subtypeIndex = globalIndex - fixedCount - ponyCount;
            else if (subtype === 'rumpo') subtypeIndex = globalIndex - fixedCount - ponyCount - rebelCount;
            
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${imageUrls[subtype]}/${imageUrls[subtype]}_${(subtypeIndex + 1)}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.movie-props-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆå›ºå®šç‚¹é€ä¸ªè®¡æ•°ï¼Œä¸‰ç±»è½½å…·æŒ‰ç»„è®¡æ•°ï¼‰
            const markers = (window.moviePropsMarkers && window.moviePropsMarkers) || [];
            const totalCount = 10; // å›ºå®šä¸º10ä¸ªï¼ˆ7å›ºå®š + 3 è½½å…·ç»„ï¼‰

            // å¯è§æ€§æ¥æºï¼šä¼˜å…ˆç¼“å­˜
            let visibilityMap;
            try { visibilityMap = VisibilityCache.loadVisibility('movie_props') || []; } catch (_) { visibilityMap = []; }

            const getHiddenByIndex = (i) => {
                if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                const m = markers[i];
                if (!m) return false;
                if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                return false;
            };

            // å›ºå®šç‚¹é€ä¸€ç»Ÿè®¡
            let hiddenFixed = 0;
            for (let i = 0; i < fixedCount; i++) if (getHiddenByIndex(i)) hiddenFixed++;

            // ç»„èŒƒå›´
            const ponyStart = fixedCount;
            const ponyEnd = ponyStart + ponyCount;
            const rebelStart = ponyEnd;
            const rebelEnd = rebelStart + rebelCount;
            const rumpoStart = rebelEnd;
            const rumpoEnd = rumpoStart + (mp.vehicles?.rumpo?.length || 0);

            const rangeAllHidden = (start, end) => {
                if (start >= end) return false;
                for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                return true;
            };

            let ponyHidden = rangeAllHidden(ponyStart, ponyEnd);
            let rebelHidden = rangeAllHidden(rebelStart, rebelEnd);
            let rumpoHidden = rangeAllHidden(rumpoStart, rumpoEnd);

            const hiddenCount = hiddenFixed + (ponyHidden ? 1 : 0) + (rebelHidden ? 1 : 0) + (rumpoHidden ? 1 : 0);

            // å½“å‰æ ‡è®°å¼•ç”¨ï¼ˆç”¨äºå›ºå®šç‚¹ç›´æ¥è®¾ç½®é€æ˜åº¦ï¼‰
            const currentMarker = markers[globalIndex];

            // å½“å‰æ˜¯å¦éšè—ï¼ˆå›ºå®šç‚¹çœ‹è‡ªèº«ï¼›è½½å…·çœ‹æ‰€åœ¨ç»„ï¼‰
            let isCurrentHidden = false;
            if (subtype === 'fixed_position') {
                isCurrentHidden = getHiddenByIndex(globalIndex);
            } else if (subtype === 'pony') {
                isCurrentHidden = ponyHidden;
            } else if (subtype === 'rebel') {
                isCurrentHidden = rebelHidden;
            } else if (subtype === 'rumpo') {
                isCurrentHidden = rumpoHidden;
            }

            const title = `ğŸ¬ ç”µå½±é“å…· - ${typeNames[subtype]} #${subtypeIndex + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'movie-props-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="ç”µå½±é“å…· #${subtypeIndex + 1}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å‰å¾€  æ¥å–ç”µå½±é“å…·æœå¯»ä»»åŠ¡ã€‚ç”µå½±é“å…·å…±æœ‰ 10 ä¸ªï¼Œå…¶ä¸­ 7 ä¸ªä½ç½®å›ºå®šï¼Œå¦å¤– 3 ä¸ªåœ¨è½½å…·é‡Œã€‚æ¯è¾†è½½å…·éƒ½æœ‰ 3 ä¸ªå¯èƒ½çš„ç”Ÿæˆç‚¹ï¼Œå…¶ä¸­ 1 ä¸ªä¼šç”Ÿæˆç§»åŠ¨çš„è½½å…·ã€‚å½“æ‚¨ç¦»ç”Ÿæˆç‚¹è¶³å¤Ÿæ¥è¿‘æ—¶ï¼Œè½½å…·ä¼šä»¥è“ç‚¹æ ‡è®°åœ¨åœ°å›¾ä¸Šã€‚å¦‚è¿™äº›ç”Ÿæˆç‚¹éƒ½æ²¡æœ‰ç”Ÿæˆè½½å…·ï¼Œæ‚¨å¯ä»¥æ›´æ¢æˆ˜å±€ç»§ç»­å¯»æ‰¾ã€‚<br><br>
                    å¥–åŠ±ï¼šæ¯ä¸ªé“å…· 10.000 GTA$ã€‚è½½å…· 2.000 RPï¼Œå…¶ä»–å›ºå®šé“å…· 5.000 RPã€‚å‰å¾€  äº¤ä»˜é“å…·ä»¥é¢†å–å¥–åŠ±ã€‚æ‚¨æ²¡å¿…è¦æ¯æ”¶é›†ä¸€ä¸ªå°±äº¤ä»˜ä¸€ä¸ªï¼Œå¤šä¸ªé“å…·åŒæ—¶äº¤ä»˜æ—¶å¥–åŠ±ä¼šç´¯åŠ è®¡ç®—ã€‚æ­¤å¤–ï¼Œé›†é½å…¨å¥—æ”¶è—å“è¿˜å°†è·å¾— 50.000 GTA$ å¹¶è§£é” å¤ªç©ºå…¥ä¾µè€… å¥—è£…ï¼ˆå‰å¾€ ï¼Œä»ç›’å­  é‡Œé¢†å–ï¼‰ã€‚<br><br>
                    æ€»æ”¶ç›Šï¼š150.000 GTA$ã€41.000 RP å’Œå¥—è£…ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-movie-props-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-movie-props-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-movie-props-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-movie-props-btn');
            const hideBtn = popup.querySelector('#hide-movie-props-btn');
            const showBtn = popup.querySelector('#show-movie-props-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'movie-props-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°ï¼ˆå®ç°ç‰¹æ®Šéšè—é€»è¾‘ï¼‰
            function setCurrentMarkerVisibility(opacity) {
                if (subtype === 'fixed_position') {
                    // å›ºå®šä½ç½®ï¼šå•ç‹¬éšè—
                    if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                    // æ›´æ–°ç¼“å­˜
                    VisibilityCache.updateItemVisibility('movie_props', globalIndex, opacity === 0.3);
                } else {
                    // è½½å…·ç±»å‹ï¼šéšè—åŒç±»çš„æ‰€æœ‰å›¾æ ‡
                    let startIndex, endIndex;
                    if (subtype === 'pony') {
                        startIndex = fixedCount;
                        endIndex = fixedCount + ponyCount;
                    } else if (subtype === 'rebel') {
                        startIndex = fixedCount + ponyCount;
                        endIndex = fixedCount + ponyCount + rebelCount;
                    } else if (subtype === 'rumpo') {
                        startIndex = fixedCount + ponyCount + rebelCount;
                        endIndex = startIndex + (mp.vehicles?.rumpo?.length || 0);
                    }
                    
                    // éšè—åŒç±»å‹çš„æ‰€æœ‰æ ‡è®°
                    for (let idx = startIndex; idx < endIndex; idx++) {
                        const marker = markers[idx];
                        if (marker && typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (marker && typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        }
                        // æ›´æ–°ç¼“å­˜
                        VisibilityCache.updateItemVisibility('movie_props', idx, opacity === 0.3);
                    }
                }
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    let newHiddenCount;
                    if (subtype === 'fixed_position') {
                        newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    } else if (subtype === 'pony') {
                        newHiddenCount = hiddenCount + (ponyHidden ? 0 : 1);
                        ponyHidden = true;
                    } else if (subtype === 'rebel') {
                        newHiddenCount = hiddenCount + (rebelHidden ? 0 : 1);
                        rebelHidden = true;
                    } else {
                        newHiddenCount = hiddenCount + (rumpoHidden ? 0 : 1);
                        rumpoHidden = true;
                    }
                    titleElement.textContent = `ğŸ¬ ç”µå½±é“å…· - ${typeNames[subtype]} #${subtypeIndex + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateMoviePropsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    let newHiddenCount;
                    if (subtype === 'fixed_position') {
                        newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    } else if (subtype === 'pony') {
                        newHiddenCount = hiddenCount - (ponyHidden ? 1 : 0);
                        ponyHidden = false;
                    } else if (subtype === 'rebel') {
                        newHiddenCount = hiddenCount - (rebelHidden ? 1 : 0);
                        rebelHidden = false;
                    } else {
                        newHiddenCount = hiddenCount - (rumpoHidden ? 1 : 0);
                        rumpoHidden = false;
                    }
                    titleElement.textContent = `ğŸ¬ ç”µå½±é“å…· - ${typeNames[subtype]} #${subtypeIndex + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateMoviePropsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // æ´›åœ£éƒ½æ€äººç‹‚å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSlasherPopup(item, index, subtype) {
            const isFirst = subtype === 'first';
            const base = isFirst ? 'ls_slasher' : 'ls_slasher_final';
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index - 3 )}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.slasher-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.slasherMarkers && window.slasherMarkers) || [];
            const totalCount = 4; // å›ºå®šä¸º4ä¸ªï¼ˆ3ä¸ªslasher1.svg + 1ä¸ªslasher2.svgç»„ï¼‰

            // è¯»å–å­ç±»å‹æ•°é‡ï¼ˆä»æ•°æ®æºï¼‰
            const slasherData = (window.itemData && window.itemData.serial_killer_slasher) || { first: [], last: [] };
            const firstCount = slasherData.first?.length || 0;
            const lastCount = slasherData.last?.length || 0;

            // å¯è§æ€§æ¥æºï¼šä¼˜å…ˆç¼“å­˜
            let visibilityMap;
            try { visibilityMap = VisibilityCache.loadVisibility('serial_killer_slasher') || []; } catch (_) { visibilityMap = []; }

            const getHiddenByIndex = (i) => {
                if (Array.isArray(visibilityMap)) return !!visibilityMap[i];
                if (visibilityMap && typeof visibilityMap === 'object') return !!visibilityMap[i];
                const m = markers[i];
                if (!m) return false;
                if (typeof m.getOpacity === 'function') return m.getOpacity() === 0.3;
                if (m.options && typeof m.options.opacity !== 'undefined') return m.options.opacity === 0.3;
                if (typeof m.getElement === 'function') { const el = m.getElement(); return !!(el && el.style.opacity === '0.3'); }
                return false;
            };

            // slasher1.svg é€ä¸€ç»Ÿè®¡ï¼ˆå‰3ä¸ªï¼‰
            let hiddenFirst = 0;
            for (let i = 0; i < firstCount; i++) if (getHiddenByIndex(i)) hiddenFirst++;

            // slasher2.svg ç»„èŒƒå›´ï¼ˆæœ€å1ä¸ªç»„ï¼ŒåŒ…å«æ‰€æœ‰lastæ ‡è®°ï¼‰
            const lastStart = firstCount;
            const lastEnd = firstCount + lastCount;

            const rangeAllHidden = (start, end) => {
                if (start >= end) return false;
                for (let i = start; i < end; i++) if (!getHiddenByIndex(i)) return false;
                return true;
            };

            const lastHidden = rangeAllHidden(lastStart, lastEnd);
            const hiddenCount = hiddenFirst + (lastHidden ? 1 : 0);

            // è®¡ç®—å½“å‰æ ‡è®°çš„å…¨å±€ç´¢å¼•
            let globalIndex = index;
            if (subtype === 'last') {
                globalIndex = firstCount + index;
            }

            const currentMarker = markers[globalIndex];
            let isCurrentHidden = false;
            if (subtype === 'first') {
                isCurrentHidden = getHiddenByIndex(globalIndex);
            } else {
                isCurrentHidden = lastHidden;
            }

            const title = isFirst ? `ğŸ©¸ æ€äººç‹‚çº¿ç´¢ #${index + 1} (${hiddenCount}/${totalCount})` : `ğŸ©¸ æœ€åä¸€æ¡çº¿ç´¢ #${index - 3} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'slasher-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ€äººç‹‚çº¿ç´¢" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(183, 28, 28, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ä¸€å…±æœ‰ 5 æ¡çº¿ç´¢ã€‚å‰å››æ¡çº¿ç´¢ æ€»æ˜¯åœ¨ç›¸åŒçš„ä½ç½®ã€‚é›†é½å‰ 4 æ¡åï¼Œæœ€åä¸€æ¡çº¿ç´¢ å°†åœ¨ 5 ä¸ªå¯èƒ½ä½ç½®ä¸­çš„éšæœº 1 å¤„ç”Ÿæˆã€‚<br><br>
                    çº¿ç´¢ä¼šå‘å‡ºä»¤äººæ¯›éª¨æ‚šç„¶çš„å£°éŸ³ä»¥å¸®åŠ©æ‚¨å®šä½å®ƒï¼Œæ‚¨é¡»æŒ‰ E æ¥è°ƒæŸ¥å®ƒã€‚<br><br>
                    å¥–åŠ±ï¼šæ¯æ¡çº¿ç´¢éƒ½ä¼šç»™æ‚¨ 5.000 GTA$ å’Œ 2.000 RPã€‚æ‰¾åˆ°æ‰€æœ‰çº¿ç´¢åï¼Œæ€äººç‹‚ä¼šä¸€ç›´è¯•å›¾åŸ‹ä¼å¹¶æ€æ­»æ‚¨ï¼Œç›´åˆ°æ‚¨æ¶ˆç­ä»–ã€‚ä»–åªä¼šåœ¨æ™šä¸Š 700 å’Œæ—©ä¸Š 500 ä¹‹é—´å‡ºç°åœ¨å¸ƒè±æ©éƒ¡ ã€‚æ€æ­»ä»–æ‚¨å°†è·å¾— 50.000 GTA$ å’Œæµ·å†›å·¦è½®æ‰‹æªã€‚ç”¨æµ·å†›å·¦è½®æ‰‹æªå®Œæˆ 50 æ¬¡å‡»æ€ï¼Œå³å¯èµšå– 200.000 GTA$ï¼Œå¹¶åœ¨ Red Dead åœ¨çº¿æ¨¡å¼ä¸­è§£é”ä¸€æ¬¾ç‹¬å®¶æ­¦å™¨ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-slasher-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-slasher-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-slasher-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-slasher-btn');
            const hideBtn = popup.querySelector('#hide-slasher-btn');
            const showBtn = popup.querySelector('#show-slasher-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'slasher-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°ï¼ˆå®ç°ç‰¹æ®Šéšè—é€»è¾‘ï¼‰
            function setCurrentMarkerVisibility(opacity) {
                if (subtype === 'first') {
                    // slasher1.svgï¼šå•ç‹¬éšè—
                    if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                    // æ›´æ–°ç¼“å­˜
                    VisibilityCache.updateItemVisibility('serial_killer_slasher', globalIndex, opacity === 0.3);
                } else {
                    // slasher2.svgï¼šéšè—åŒç±»çš„æ‰€æœ‰å›¾æ ‡
                    const lastStart = firstCount;
                    const lastEnd = firstCount + lastCount;
                    
                    // éšè—åŒç±»å‹çš„æ‰€æœ‰æ ‡è®°
                    for (let idx = lastStart; idx < lastEnd; idx++) {
                        const marker = markers[idx];
                        if (marker && typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (marker && typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        }
                        // æ›´æ–°ç¼“å­˜
                        VisibilityCache.updateItemVisibility('serial_killer_slasher', idx, opacity === 0.3);
                    }
                }
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    let newHiddenCount;
                    if (subtype === 'first') {
                        newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    } else {
                        newHiddenCount = hiddenCount + (lastHidden ? 0 : 1);
                    }
                    titleElement.textContent = isFirst ? `ğŸ©¸ æ€äººç‹‚çº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})` : `ğŸ©¸ æœ€åä¸€æ¡çº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSlasherSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    let newHiddenCount;
                    if (subtype === 'first') {
                        newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    } else {
                        newHiddenCount = hiddenCount - (lastHidden ? 1 : 0);
                    }
                    titleElement.textContent = isFirst ? `ğŸ©¸ æ€äººç‹‚çº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})` : `ğŸ©¸ æœ€åä¸€æ¡çº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSlasherSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // å·¦è½®å¯»å®å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showTreasureHuntPopup(item, index, subtype) {
            const isRandom = subtype === 'random';
            const base = isRandom ? 'ls_th_dba_fc' : 'ls_th_dba_ltc';
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/${base}/${base}_${(index + 1)}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.treasure-hunt-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
            const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
            const totalCount = 4; // æ€»æ•°ä¸º4

            let hiddenCount = 0;
            // æ£€æŸ¥th1æ ‡è®°ï¼ˆä»»æ„ä¸€ä¸ªéšè—åˆ™å…¨éƒ¨éšè—ï¼Œä½†è®¡æ•°å™¨åª+1ï¼‰
            let th1Hidden = false;
            th1Markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') {
                        th1Hidden = true;
                    }
                }
            });
            if (th1Hidden) {
                hiddenCount += 1; // th1éšè—æ—¶è®¡æ•°å™¨åª+1
            }

            // æ£€æŸ¥th2æ ‡è®°ï¼ˆå•ç‹¬è®¡ç®—ï¼‰
            th2Markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') {
                        hiddenCount++;
                    }
                }
            });

            const currentMarker = isRandom ? th1Markers[index] : th2Markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = isRandom ? `ğŸ” å·¦è½®å¯»å® - éšæœºçº¿ç´¢ #${index + 1} (${hiddenCount}/${totalCount})` : `ğŸ” å·¦è½®å¯»å® - å›ºå®šçº¿ç´¢ #${index + 1} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'treasure-hunt-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(121, 85, 72, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    æ”¶åˆ° vanderlinde@eyefind.com çš„é‚®ä»¶åï¼Œç¬¬ä¸€æ¡å¯»å®çº¿ç´¢å°†éšæœºå‡ºç°åœ¨ 20 ä¸ªå¯èƒ½çš„ä½ç½®ï¼ˆæ­¤å¤„å¯¹åº” <strong>th1.svg</strong>ï¼‰ä¹‹ä¸€ã€‚æ‚¨å¯é€šè¿‡é‚®ä»¶ä¸­çš„é»‘ç™½ç…§ç‰‡æ¨æ–­æ­¤çº¿ç´¢çš„ä½ç½®ã€‚æ¸¸æˆä¹Ÿä¼šå°†çº¿ç´¢æ‰€åœ¨çš„åŒºåŸŸæ ‡è®°åœ¨åœ°å›¾ä¸Šã€‚æœ¬åœ°å›¾å±•ç¤ºçš„æ˜¯æ­¤çº¿ç´¢çš„å‡†ç¡®ä½ç½®ã€‚çº¿ç´¢ä¼šå‘å‡ºå£°éŸ³ä»¥å¸®åŠ©æ‚¨æ‰¾åˆ°å®ƒï¼Œæ‚¨éœ€æŒ‰ E å¯¹å…¶è¿›è¡Œè°ƒæŸ¥ã€‚<br><br>
                    æ‰¾åˆ°é¦–æ¡çº¿ç´¢åï¼Œæ‚¨è¿˜éœ€è¦å¯»æ‰¾å‰©ä½™ä¸‰å¤„çº¿ç´¢ï¼ˆæ­¤å¤„å¯¹åº” <strong>th2.svg</strong>ï¼‰ã€‚æ¯ä½ç©å®¶éƒ½å°†åœ¨ç›¸åŒçš„ä½ç½®æ‰¾åˆ°è¿™äº›çº¿ç´¢ã€‚æ‰€æœ‰å¯»å®çº¿ç´¢çš„ä»»åŠ¡æœºåˆ¶æ˜¯ä¸€è‡´çš„ï¼Œæ‚¨å¯å‚ç…§ä¸Šæ–‡çš„æ–¹å¼å¯»æ‰¾è¿™ä¸‰æ¡çº¿ç´¢ã€‚<br><br>
                    <strong>å¥–åŠ±ï¼š</strong> é›†é½æ‰€æœ‰çº¿ç´¢åï¼Œæ¸¸æˆä¸­å°†å‡ºç°è—æœ‰åŒåŠ¨å¼å·¦è½®æ‰‹æªçš„å®ç®±ã€‚å®ç®±çš„å‡†ç¡®ä½ç½®å°†è¢«æ ‡æ³¨åœ¨æ¸¸æˆå†…çš„åœ°å›¾ä¸Šã€‚ä½¿ç”¨è¯¥æ­¦å™¨å®Œæˆ 50 æ¬¡çˆ†å¤´å³å¯è·å¾— 250,000 GTA$ã€2,000 RPï¼Œå¹¶äº Red Dead Redemption 2 ä¸­è§£é”æ­¤æ­¦å™¨çš„ç‹¬å®¶å˜ä½“ã€‚
                </div>
                <img src="${imageUrl}" alt="çº¿ç´¢å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-treasure-hunt-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-treasure-hunt-btn');
            const hideBtn = popup.querySelector('#hide-treasure-hunt-btn');
            const showBtn = popup.querySelector('#show-treasure-hunt-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'treasure-hunt-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                const cacheKey = isRandom ? 'treasure_hunt_th1' : 'treasure_hunt_th2';
                VisibilityCache.updateItemVisibility(cacheKey, index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    
                    // å¦‚æœæ˜¯th1ï¼Œéšè—æ‰€æœ‰th1æ ‡è®°
                    if (isRandom) {
                        th1Markers.forEach((marker) => {
                            if (marker && typeof marker.setOpacity === 'function') {
                                marker.setOpacity(0.3);
                            } else if (marker && typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 0.3 });
                            }
                        });
                        // æ›´æ–°æ‰€æœ‰th1çš„ç¼“å­˜
                        th1Markers.forEach((_, i) => {
                            VisibilityCache.updateItemVisibility('treasure_hunt_th1', i, true);
                        });
                    }
                    
                    const newHiddenCount = isRandom ? 
                        1 + th2Markers.filter(m => m && m.getElement && m.getElement().style.opacity === '0.3').length :
                        hiddenCount + (isCurrentHidden ? 0 : 1);
                    
                    titleElement.textContent = isRandom ? 
                        `ğŸ” å·¦è½®å¯»å® - éšæœºçº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})` :
                        `ğŸ” å·¦è½®å¯»å® - å›ºå®šçº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateTreasureHuntSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    
                    // å¦‚æœæ˜¯th1ï¼Œæ˜¾ç¤ºæ‰€æœ‰th1æ ‡è®°
                    if (isRandom) {
                        th1Markers.forEach((marker) => {
                            if (marker && typeof marker.setOpacity === 'function') {
                                marker.setOpacity(1);
                            } else if (marker && typeof marker.setStyle === 'function') {
                                marker.setStyle({ opacity: 1 });
                            }
                        });
                        // æ›´æ–°æ‰€æœ‰th1çš„ç¼“å­˜
                        th1Markers.forEach((_, i) => {
                            VisibilityCache.updateItemVisibility('treasure_hunt_th1', i, false);
                        });
                    }
                    
                    const newHiddenCount = isRandom ? 
                        th2Markers.filter(m => m && m.getElement && m.getElement().style.opacity === '0.3').length :
                        hiddenCount - (isCurrentHidden ? 1 : 0);
                    
                    titleElement.textContent = isRandom ? 
                        `ğŸ” å·¦è½®å¯»å® - éšæœºçº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})` :
                        `ğŸ” å·¦è½®å¯»å® - å›ºå®šçº¿ç´¢ #${index + 1} (${newHiddenCount}/${totalCount})`;
                    
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateTreasureHuntSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°å·¦è½®å¯»å®æ ‡è®°
        function applyTreasureHuntVisibilityCache() {
            const th1Markers = (window.treasureHuntTh1Markers && window.treasureHuntTh1Markers) || [];
            const th2Markers = (window.treasureHuntTh2Markers && window.treasureHuntTh2Markers) || [];
            
            if (th1Markers.length > 0 || th2Markers.length > 0) {
                // åº”ç”¨th1ç¼“å­˜
                const th1VisibilityMap = VisibilityCache.loadVisibility('treasure_hunt_th1');
                th1Markers.forEach((marker, index) => {
                    const isHidden = th1VisibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                
                // åº”ç”¨th2ç¼“å­˜
                const th2VisibilityMap = VisibilityCache.loadVisibility('treasure_hunt_th2');
                th2Markers.forEach((marker, index) => {
                    const isHidden = th2VisibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                
                console.log('å·²åº”ç”¨å·¦è½®å¯»å®å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ£€æµ‹å¹½çµæ›å…‰ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkGhosts3Click(clickX, clickY) {
            const GHOSTS3_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå¹½çµæ›å…‰ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('ghosts3') && itemData.ghosts3) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å¹½çµæ›å…‰é™„è¿‘
                const nearbyGhost = itemData.ghosts3.find(ghost => {
                    const distance = Math.sqrt(Math.pow(ghost.x - clickX, 2) + Math.pow(ghost.y - clickY, 2));
                    return distance <= GHOSTS3_RADIUS;
                });

                if (nearbyGhost) {
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const ghostIndex = itemData.ghosts3.findIndex(ghost => 
                        ghost.x === nearbyGhost.x && ghost.y === nearbyGhost.y
                    );
                    showGhosts3Popup(nearbyGhost, ghostIndex);
                }
            }
        }

        // å¹½çµæ›å…‰2025å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showGhosts3Popup(item, index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = "https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png";
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.ghosts3-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.ghosts3Markers && window.ghosts3Markers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el) {
                        const opacity = el.style.opacity;
                        if (opacity === '0.3' || opacity === 0.3 || opacity === '0.30') {
                            hiddenCount++;
                        }
                    }
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                if (el) {
                    const opacity = el.style.opacity;
                    isCurrentHidden = opacity === '0.3' || opacity === 0.3 || opacity === '0.30';
                }
            }

            const title = `ğŸ‘» å¹½çµæ›å…‰2025 #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'ghosts3-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <div style="margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: bold; color: #9c27b0; margin-bottom: 6px; font-size: 14px;">â° å‡ºç°æ—¶é—´</div>
                    <div style="color: #333; font-size: 16px;">${item.time || 'æœªçŸ¥æ—¶é—´'}</div>
                </div>
                <div style="margin: 14px 0; padding: 10px; background: #f3e5f5; border-radius: 6px; color: #7b1fa2; font-size: 13px; line-height: 1.6;">
                    â€¢ åœ¨æŒ‡å®šæ—¶é—´å‰å¾€è¯¥åŒºåŸŸå¯»æ‰¾å¹½çµçº¿ç´¢<br>
                    â€¢ æ‹æ‘„ç…§ç‰‡æˆ–è§‚å¯Ÿå¼‚å¸¸ç°è±¡ï¼ˆå ä½è¯´æ˜ï¼‰
                </div>
                <div style="margin: 12px 0; padding: 8px; background: #fff; border-radius: 6px;">
                    <img src="${imageUrl}" alt="å¹½çµæ›å…‰2025 #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 4px; cursor: zoom-in;"/>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ghosts3-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ghosts3-btn');
            const hideBtn = popup.querySelector('#hide-ghosts3-btn');
            const showBtn = popup.querySelector('#show-ghosts3-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'ghosts3-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker) {
                    // å¯¹äºdivIconï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                    if (typeof currentMarker.getElement === 'function') {
                        const el = currentMarker.getElement();
                        if (el) {
                            // ç›´æ¥è®¾ç½®divIconå…ƒç´ çš„é€æ˜åº¦
                            el.style.opacity = opacity;
                        }
                    } else if (typeof currentMarker.setOpacity === 'function') {
                        currentMarker.setOpacity(opacity);
                    } else if (typeof currentMarker.setStyle === 'function') {
                        currentMarker.setStyle({ opacity });
                    }
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('ghosts3', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ‘» å¹½çµæ›å…‰2025 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateGhosts3SidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ‘» å¹½çµæ›å…‰2025 #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateGhosts3SidebarCount();
                });
            }

            document.body.appendChild(popup);
        }
        // æ£€æµ‹å¸®æ´¾æ”»å‡»ç‚¹å‡»ï¼ˆåæ ‡æ£€æµ‹ï¼‰
        function checkGangAttackClick(clickX, clickY) {
            const GANG_ATTACK_RADIUS = 100; // æ£€æµ‹åŠå¾„100å•ä½
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºå¸®æ´¾æ”»å‡»ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            if (activeItemTypes.has('gang_attacks') && itemData.gang_attacks) {
                // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨ä»»æ„å¸®æ´¾æ”»å‡»é™„è¿‘
                const nearbyAttack = itemData.gang_attacks.find((attack, index) => {
                    // é¦–å…ˆæ£€æŸ¥æ—¶é—´æ˜¯å¦åŒ¹é…
                    if (!isGangAttackActive(attack.time)) {
                        return false;
                    }
                    
                    const distance = Math.sqrt(Math.pow(attack.x - clickX, 2) + Math.pow(attack.y - clickY, 2));
                    return distance <= GANG_ATTACK_RADIUS;
                });

                if (nearbyAttack) {
                    console.log('ç‚¹å‡»äº†å¸®æ´¾æ”»å‡»é™„è¿‘:', nearbyAttack);
                    // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
                    const attackIndex = itemData.gang_attacks.findIndex(attack => 
                        attack.x === nearbyAttack.x && attack.y === nearbyAttack.y
                    );
                    showGangAttackPopup(nearbyAttack, attackIndex);
                }
            }
        }

        // æ˜¾ç¤ºå¸®æ´¾æ”»å‡»å¼¹çª—
        function showGangAttackPopup(item, index) {
            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'gang-attack-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #ff0000;
                border-radius: 12px;
                padding: 20px;
                z-index: 10000;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif;
                text-align: center;
            `;

            // å¼¹çª—å†…å®¹
            popup.innerHTML = `
                <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #ff0000;">
                    âš”ï¸ å¸®æ´¾æ”»å‡»
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff0000;">
                    <div style="font-weight: bold; color: #ff0000; margin-bottom: 8px; font-size: 16px;">â° æ—¶é—´é™åˆ¶</div>
                    <div style="color: #333; font-size: 18px; margin-bottom: 15px;">${item.time || 'æœªçŸ¥æ—¶é—´'}</div>
                </div>
                
                <div style="margin: 15px 0; padding: 12px; background: #ffebee; border-radius: 6px; color: #c62828; font-size: 14px; line-height: 1.6;">
                    ğŸ¯ <strong>å¸®æ´¾æ”»å‡»äº‹ä»¶</strong><br>
                    â€¢ åœ¨æŒ‡å®šæ—¶é—´å†…å‰å¾€è¯¥åŒºåŸŸ<br>
                    â€¢ ä¸æ•Œå¯¹å¸®æ´¾æˆå‘˜æˆ˜æ–—<br>
                    â€¢ å®Œæˆå¯è·å¾—<strong>ç»éªŒå€¼</strong>å’Œ<strong>æ¸¸æˆå¸å¥–åŠ±</strong><br>
                    â€¢ æ³¨æ„å®‰å…¨ï¼Œå‡†å¤‡å……è¶³çš„æ­¦å™¨å’Œå¼¹è¯ï¼
                </div>
                
                <button id="close-gang-attack-popup-btn" 
                        style="padding: 12px 24px; 
                               background: #ff0000; color: white; 
                               border: none; border-radius: 6px; 
                               cursor: pointer; font-size: 16px;
                               font-weight: bold;
                               transition: background-color 0.3s;">
                    å…³é—­
                </button>
            `;

            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
            const closeBtn = popup.querySelector('#close-gang-attack-popup-btn');
            closeBtn.addEventListener('click', () => {
                popup.remove();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            popup.addEventListener('click', (e) => e.stopPropagation());
            
            // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 100);

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(popup);
        }

        // æ˜¾ç¤ºæ­¦å™¨å¢å‹è½¦æ­¦å™¨ä¿¡æ¯
        function showGunVanWeapons() {
            // åŠ è½½labels.jsonæ•°æ®
            let labelsData = {};
            fetch('../src/data/labels.json')
                .then(response => response.json())
                .then(labels => {
                    labelsData = labels;
                    // ä»APIåŠ¨æ€è·å–æ­¦å™¨ä¿¡æ¯
                    return fetch('https://api-gta.antwen.com/api/items/gun-van');
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayGunVanWeapons(data.data.message, labelsData);
                    } else {
                        console.error('è·å–æ­¦å™¨å¢å‹è½¦ä¿¡æ¯å¤±è´¥:', data.error);
                        alert('è·å–æ­¦å™¨ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                })
                .catch(error => {
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });

            function displayGunVanWeapons(message, labels) {
                // è§£æAPIè¿”å›çš„æ¶ˆæ¯æ¥æå–æ­¦å™¨ä¿¡æ¯
                const lines = message.split('\n');
                const weapons = [];
                const throwables = [];
                let currentSection = '';

                lines.forEach(line => {
                    if (line.includes('æ­¦å™¨:')) {
                        currentSection = 'weapons';
                    } else if (line.includes('æŠ•æ·ç‰©:')) {
                        currentSection = 'throwables';
                    } else if (line.trim() && line.includes('-')) {
                        const match = line.match(/- (.+?) \((\d+)æŠ˜\)/);
                        if (match) {
                            // å°è¯•ä»labelsä¸­æŸ¥æ‰¾æ­¦å™¨çš„ä¸­æ–‡åç§°
                            let weaponName = match[1];
                            if (labels.hasOwnProperty(weaponName)) {
                                weaponName = labels[weaponName];
                            }
                            
                            const discountText = match[2] + 'æŠ˜';
                            
                            const weaponEntry = {
                                name: weaponName,
                                discountText: discountText
                            };

                            if (currentSection === 'weapons') {
                                weapons.push(weaponEntry);
                            } else if (currentSection === 'throwables') {
                                throwables.push(weaponEntry);
                            }
                        }
                    }
                });

                // åˆ›å»ºå¼¹çª—
                const popup = document.createElement('div');
                popup.className = 'gun-van-popup';
                popup.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: var(--gta-bg-medium);
                    border: 1px solid var(--gta-border);
                    border-radius: 8px;
                    box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                    padding: 15px;
                    z-index: 10000;
                    width: min(92vw, 520px);
                    max-height: 80vh;
                    color: var(--gta-text);
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    overflow-y: auto;
                `;

                // å¼¹çª—å†…å®¹
                const gunVanImageUrl = 'https://gtaweb.eu/_sources/maps_gtao/tips/gun_van.webp';
                popup.innerHTML = `
                    <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                        <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">ğŸš æ­¦å™¨å¢å‹è½¦å•†å“ä¿¡æ¯</h3>
                        <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                    </div>
                    <img src="${gunVanImageUrl}" alt="æ­¦å™¨å¢å‹è½¦å›¾ç‰‡" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                    <div style="margin-bottom: 10px; font-weight: bold; color: #555;">ä¸»æ­¦å™¨:</div>
                    ${weapons.map(weapon => `<div style=\"margin: 5px 0; color: #666;\">${weapon.name} - <span style=\"color: #e74c3c;\">${weapon.discountText}</span></div>`).join('')}
                        <div style="margin: 10px 0; font-weight: bold; color: #555;">æŠ•æ·æ­¦å™¨:</div>
                    ${throwables.map(throwable => `<div style=\"margin: 5px 0; color: #666;\">${throwable.name} - <span style=\"color: #e74c3c;\">${throwable.discountText}</span></div>`).join('')}
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <button id="close-popup-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                        </div>
                `;

                // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
                const closeBtn = popup.querySelector('#close-popup-btn');
                const popupClose = popup.querySelector('.popup-close');
                const removePopup = () => popup.remove();
                closeBtn.addEventListener('click', removePopup);
                if (popupClose) popupClose.addEventListener('click', removePopup);

                // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
                const popupImage = popup.querySelector('img');
                if (popupImage) {
                    popupImage.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const overlay = document.createElement('div');
                        overlay.className = 'gun-van-image-overlay';
                        overlay.style.cssText = `
                            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                            display: flex; align-items: center; justify-content: center;
                            z-index: 10002; cursor: zoom-out;
                        `;
                        const bigImg = document.createElement('img');
                        bigImg.src = popupImage.src;
                        bigImg.alt = popupImage.alt || '';
                        bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                        overlay.appendChild(bigImg);

                        const removeOverlay = () => {
                            document.removeEventListener('keydown', onKey);
                            overlay.remove();
                        };
                        const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                        overlay.addEventListener('click', removeOverlay);
                        document.addEventListener('keydown', onKey);
                        document.body.appendChild(overlay);
                    });
                }

                // ç§»é™¤éšè—/æ˜¾ç¤ºåŠŸèƒ½ï¼Œä¿ç•™ä»…å…³é—­

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(popup);

                // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
                popup.addEventListener('click', (e) => e.stopPropagation());
                
                // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ·»åŠ documentç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
                setTimeout(() => {
                    const closePopupHandler = (e) => {
                        if (!popup.contains(e.target)) {
                            removePopup();
                            document.removeEventListener('click', closePopupHandler);
                        }
                    };
                    document.addEventListener('click', closePopupHandler);
                }, 100);
            }
        }


        // åˆå§‹åŠ è½½
        map.whenReady(() => {
            updateTilePanePosition();
            updateOriginMarker();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            // æ¢å¤é˜¶æ®µï¼šå…ˆéšè— Leaflet é¢æ¿ï¼Œé¿å…â€œå…¨é‡åæ ‡â€é—ªçƒ
            hideLeafletPanesForRestore();
            loadItemData().then(() => {
                console.log('ç‰©å“æ•°æ®åŠ è½½å®Œæˆ');
                // é€šè¿‡"æ˜¾ç¤ºé€»è¾‘"æ¢å¤ç¼“å­˜ï¼ˆé¿å…ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨åæ ‡ï¼‰
                setTimeout(() => {
                    try { restoreCachedDisplayState(); } finally { showLeafletPanesForRestore(); }
                }, 0);
                
                // æ•°æ®åŠ è½½å®Œæˆåï¼Œå»¶è¿Ÿæ›´æ–°è¡—å¤´æ¯’è´©è®¡æ•°å™¨
                setTimeout(() => {
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                }, 500);
            }).catch(() => {
                // å¤±è´¥æ—¶ä¹Ÿè¦ç¡®ä¿æ¢å¤æ˜¾ç¤º
                showLeafletPanesForRestore();
            });
            
            // åˆå§‹åŒ–è½¦è¡Œæ ‡è®°
            initDealershipMarkers();
            
            // åˆå§‹åŒ–æ¸¸æˆæ—¶é—´å’Œå¤©æ°”æ˜¾ç¤º
            initGameTimeWeatherDisplay();
            
            // æ·»åŠ ç¼“å­˜ç®¡ç†æŒ‰é’®
            addCacheManagementButton();
        });

        window.addEventListener('resize', () => {
            resetViewForZoom(map.getZoom());
            updateTilePanePosition();
        });

        // ç“¦ç‰‡æ–‡ä»¶æ£€æµ‹ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
        async function probeTilesForStyleAndZoom(style, zoom) {
            // ... åŸæœ‰ä»£ç ä¿æŒä¸å˜
        }

        // æ ¹æ®åœ°å›¾æ ·å¼è®¾ç½®èƒŒæ™¯è‰²
        function setBackgroundColorByStyle(style) {
            const backgroundColorMap = {
                'game': 'rgb(56, 73, 80)',
                'render': 'rgb(13, 43, 79)',
                'print': 'rgb(78, 177, 208)'
            };
            
            document.body.style.backgroundColor = backgroundColorMap[style] || '#1a1a1a';
        }
        
        // æ›´æ–°é¬¼ä¸Šèº«åŠ¨ç‰©åœ†åœˆå¤§å°ä»¥å“åº”ç¼©æ”¾å˜åŒ–
        function updatePossessedAnimalsCircleSizes(zoom) {
            if (!activeItemTypes.has('possessed_animals') || !itemData.possessed_animals) return;
            
            const level = getLevelOrNearest(zoom);
            if (!level) return;
            
            const totalWidth = level.cols * TILE_SIZE;
            const totalHeight = level.rows * TILE_SIZE;
            
            // æ›´æ–°æ‰€æœ‰é¬¼ä¸Šèº«åŠ¨ç‰©åœ†åœˆçš„å¤§å°
            document.querySelectorAll('.possessed-animal-circle').forEach(marker => {
                const index = parseInt(marker.dataset.index);
                const animal = itemData.possessed_animals[index];
                if (!animal) return;
                
                // é‡æ–°è®¡ç®—åœ†åœˆå¤§å°
                const gameWidth = GAME_RIGHT - GAME_LEFT; // 9000
                const pixelRadius = (animal.radius / gameWidth) * totalWidth;
                const circleSize = pixelRadius * 2; // ç›´å¾„
                
                // æ›´æ–°åœ†åœˆå¤§å°
                marker.style.width = `${circleSize}px`;
                marker.style.height = `${circleSize}px`;
            });
        }
        
        // æ³¨æ„ï¼šé›ªæ€ªç°åœ¨ä½¿ç”¨Leafletæ ‡è®°ç³»ç»Ÿï¼Œä¸å†éœ€è¦DOMåœ†åœˆå¤§å°æ›´æ–°å‡½æ•°
        
        // æ ·å¼é€‰æ‹©äº‹ä»¶
        styleSelect.addEventListener('change', (e) => {
            currentStyle = e.target.value;
            tileLayer.redraw();
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
            setBackgroundColorByStyle(currentStyle);
        });
        
        // åˆå§‹åŒ–èƒŒæ™¯è‰²
        setBackgroundColorByStyle(currentStyle);

            // åˆå§‹åŒ–ç‰©å“ä¿¡æ¯å¼¹çª—æ ·å¼ï¼ˆè¦†ç›–é»˜è®¤æ ·å¼ï¼‰
            function initItemInfoTextStyles() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.display = 'none'; // ç¡®ä¿åˆå§‹çŠ¶æ€æ˜¯éšè—çš„
            }

            // æ˜¾ç¤ºç‰©å“ä¿¡æ¯ï¼ˆæ–‡æœ¬ç‰ˆï¼‰
            function showItemInfoText(title, coords, location, details) {
                const itemInfo = document.getElementById('item-info');
                document.getElementById('item-title').textContent = title;
                document.getElementById('item-coords').textContent = `åæ ‡: ${coords}`;
                document.getElementById('item-location').textContent = `ä½ç½®: ${location}`;
                document.getElementById('item-details').textContent = `è¯¦ç»†ä¿¡æ¯: ${details}`;
                
                // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
                itemInfo.style.display = 'block';
                itemInfo.style.opacity = '0';
                itemInfo.style.transition = 'opacity 0.3s ease';
                
                // ä½¿ç”¨setTimeoutè§¦å‘é‡æ’å’Œè¿‡æ¸¡åŠ¨ç”»
                setTimeout(() => {
                    itemInfo.style.opacity = '1';
                }, 10);
            }

            // éšè—ç‰©å“ä¿¡æ¯ï¼ˆæ–‡æœ¬ç‰ˆï¼‰
            function hideItemInfoText() {
                const itemInfo = document.getElementById('item-info');
                itemInfo.style.opacity = '0';
                
                // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆåéšè—å…ƒç´ 
                setTimeout(() => {
                    itemInfo.style.display = 'none';
                }, 300);
            };

            // åˆå§‹åŒ–ç‰©å“ä¿¡æ¯å¼¹çª—æ ·å¼ï¼ˆæ–‡æœ¬ç‰ˆï¼‰
            initItemInfoTextStyles();

        // åˆå§‹æ¢æµ‹
        setTimeout(() => {
            probeTilesForStyleAndZoom(currentStyle, map.getZoom());
        }, 300);

        // ç§»åŠ¨ç«¯èœå•äº¤äº’ï¼ˆâ€œæ›´å¤šâ€æŒ‰é’®ï¼‰
        (function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            if (!mobileMenuToggle || !mobileMenu) return;

            mobileMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('show');
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && e.target !== mobileMenuToggle) {
                    mobileMenu.classList.remove('show');
                }
            });
        })();

        // æ£€æŸ¥å¸®æ´¾æ”»å‡»æ—¶é—´æ˜¯å¦åŒ¹é…
        function isGangAttackActive(timeRange) {
            try {
                // è·å–å½“å‰æ¸¸æˆæ—¶é—´
                const timestamp = Math.floor(Date.now() / 1000);
                const currentHour = Math.floor(timestamp / 120) % 24;
                const currentMinute = Math.floor(timestamp / 2) % 60;
                const currentTime = currentHour * 60 + currentMinute; // è½¬æ¢ä¸ºåˆ†é’Ÿ
                
                // è§£ææ—¶é—´èŒƒå›´ "04:00 - 12:00"
                const [startTime, endTime] = timeRange.split(' - ');
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                const startTimeMinutes = startHour * 60 + startMinute;
                const endTimeMinutes = endHour * 60 + endMinute;
                
                // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨èŒƒå›´å†…
                if (startTimeMinutes <= endTimeMinutes) {
                    // æ­£å¸¸èŒƒå›´ï¼Œå¦‚ 04:00 - 12:00
                    return currentTime >= startTimeMinutes && currentTime <= endTimeMinutes;
                } else {
                    // è·¨å¤©èŒƒå›´ï¼Œå¦‚ 22:00 - 06:00
                    return currentTime >= startTimeMinutes || currentTime <= endTimeMinutes;
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¸®æ´¾æ”»å‡»æ—¶é—´å¤±è´¥:', error);
                return false;
            }
        }

        // æ¸¸æˆæ—¶é—´å’Œå¤©æ°”æ˜¾ç¤ºåŠŸèƒ½
        function initGameTimeWeatherDisplay() {
            // ç®€åŒ–æ ·å¼åˆ›å»ºï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨å¤´éƒ¨å®šä¹‰äº†æ ·å¼

            // åˆ›å»ºæ˜¾ç¤ºå…ƒç´ 
            const displayElement = document.createElement('div');
            displayElement.id = 'game-time-weather';
            displayElement.className = 'nav-weather';
            displayElement.innerHTML = '<span style="color: white;">ğŸ• åŠ è½½ä¸­...</span>';
            // é»˜è®¤æ”¾åœ¨åœ°å›¾å®¹å™¨çš„å³ä¸Šè§’ï¼ˆä¼šåœ¨åˆå§‹åŒ–æ—¶ç§»åŠ¨åˆ°åˆé€‚ä½ç½®ï¼‰
            document.getElementById('map-container').appendChild(displayElement);

            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼ˆå®½åº¦ <= 768pxï¼‰ï¼ŒæŠŠæ—¶é—´å¤©æ°”ç§»åŠ¨åˆ°ç§»åŠ¨èœå•é‡Œï¼Œé¿å…åº•éƒ¨ç©ºç™½
            function placeGameTimeWeatherForMobile() {
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile) {
                    // åœ¨ç§»åŠ¨ç«¯ï¼ŒæŠŠæ—¶é—´/å¤©æ°”æ”¾åœ¨æ ‡é¢˜å³è¾¹ï¼ˆh1.gta-title ä¹‹åï¼‰ï¼Œå¹¶å¼ºåˆ¶å¯è§æ ·å¼
                    const navLeft = document.querySelector('.gta-nav .nav-left');
                    if (navLeft) {
                        const titleEl = navLeft.querySelector('h1.gta-title');
                        if (titleEl) {
                            // æ— è®ºä¹‹å‰åœ¨å“ªï¼Œéƒ½æŠŠå…ƒç´ ç§»åˆ°æ ‡é¢˜åé¢
                            if (displayElement.parentElement) displayElement.parentElement.removeChild(displayElement);
                            titleEl.insertAdjacentElement('afterend', displayElement);
                            // å¼ºåˆ¶æ ·å¼ä»¥ç¡®ä¿å¯è§
                            displayElement.style.display = 'inline-flex';
                            displayElement.style.alignItems = 'center';
                            displayElement.style.marginLeft = '8px';
                            displayElement.style.color = 'white';
                            displayElement.style.fontSize = '13px';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0 6px';
                        }
                    }
                } else {
                    // æ¡Œé¢ç«¯ï¼šæ”¾åœ¨ nav-links ä¸­çš„â€œåœ¨çº¿æ–‡ä»¶â€ä¹‹åï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const navLinks = document.querySelector('.gta-nav .nav-left .nav-links');
                    if (navLinks) {
                        // æ‰¾åˆ°ç¬¬äºŒä¸ªé“¾æ¥ï¼ˆåœ¨çº¿æ–‡ä»¶ï¼‰å¹¶åœ¨å…¶åæ’å…¥æ˜¾ç¤ºå…ƒç´ 
                        const anchors = navLinks.querySelectorAll('a');
                        const target = anchors[1] || navLinks.lastElementChild;
                        if (target && !navLinks.contains(displayElement)) {
                            // æ¢å¤æ ·å¼ä¸ºå†…è”èœå•é¡¹
                            displayElement.style.position = '';
                            displayElement.style.bottom = '';
                            displayElement.style.right = '';
                            displayElement.style.pointerEvents = 'none';
                            displayElement.style.background = 'transparent';
                            displayElement.style.padding = '0';
                            displayElement.style.border = 'none';
                            displayElement.style.boxShadow = 'none';
                            displayElement.style.minWidth = '0';
                            displayElement.style.textAlign = 'left';
                            target.insertAdjacentElement('afterend', displayElement);
                        }
                    } else {
                        // å›é€€ï¼šæ”¾å› map-container
                        const container = document.getElementById('map-container');
                        if (!container.contains(displayElement)) container.appendChild(displayElement);
                    }
                }
            }

            // è·å–å¹¶æ˜¾ç¤ºæ¸¸æˆæ—¶é—´å’Œå¤©æ°”
            function updateGameTimeWeather() {
                try {
                    // å®šä¹‰å¤©æ°”æ˜ å°„è¡¨å’Œæ˜ŸæœŸè¡¨
                    const WEATHERS = {
                      0: 'â˜ï¸å¤šäº‘', 4: 'ğŸŒ«ï¸è–„é›¾', 7: 'â›…å¤§éƒ¨å¤šäº‘', 11: 'â˜€ï¸æ™´æœ—', 14: 'ğŸŒ«ï¸è–„é›¾', 16: 'â˜€ï¸æ™´æœ—',
                      28: 'ğŸŒ«ï¸è–„é›¾', 31: 'â˜€ï¸æ™´æœ—', 41: 'ğŸŒé˜´éœ¾', 45: 'â˜ï¸å¤šäº‘', 52: 'ğŸŒ«ï¸è–„é›¾', 55: 'â˜ï¸å¤šäº‘',
                      62: 'ğŸŒé›¾å¤©', 66: 'â˜ï¸å¤šäº‘', 72: 'â˜ï¸å¤šäº‘', 78: 'ğŸŒé›¾å¤©', 82: 'â˜ï¸å¤šäº‘', 92: 'ğŸŒ¤ï¸å¤§éƒ¨æ™´æœ—',
                      104: 'â˜ï¸å¤šäº‘', 105: 'ğŸŒ¦ï¸æ¯›æ¯›é›¨', 108: 'â˜ï¸å¤šäº‘', 125: 'ğŸŒ«ï¸è–„é›¾', 128: 'â˜ï¸å¤šäº‘',
                      131: 'ğŸŒ§ï¸ä¸‹é›¨', 134: 'ğŸŒ¦ï¸æ¯›æ¯›é›¨', 137: 'â˜ï¸å¤šäº‘', 148: 'ğŸŒ«ï¸è–„é›¾', 151: 'â›…å¤§éƒ¨å¤šäº‘',
                      155: 'ğŸŒé›¾å¤©', 159: 'â˜€ï¸æ™´æœ—', 176: 'ğŸŒ¤ï¸å¤§éƒ¨æ™´æœ—', 196: 'ğŸŒé›¾å¤©', 201: 'â˜ï¸å¤šäº‘',
                      220: 'ğŸŒ«ï¸è–„é›¾', 222: 'ğŸŒ¤ï¸å¤§éƒ¨æ™´æœ—', 244: 'ğŸŒ«ï¸è–„é›¾', 246: 'ğŸŒ¤ï¸å¤§éƒ¨æ™´æœ—', 247: 'ğŸŒ§ï¸ä¸‹é›¨',
                      250: 'ğŸŒ¦ï¸æ¯›æ¯›é›¨', 252: 'â˜ï¸å¤šäº‘', 268: 'ğŸŒ«ï¸è–„é›¾', 270: 'â˜ï¸å¤šäº‘', 272: 'â˜ï¸å¤šäº‘',
                      277: 'â˜ï¸å¤šäº‘', 292: 'ğŸŒ«ï¸è–„é›¾', 295: 'â˜ï¸å¤šäº‘', 300: 'â›…å¤§éƒ¨å¤šäº‘',
                      306: 'â˜ï¸å¤šäº‘', 318: 'â›…å¤§éƒ¨å¤šäº‘', 330: 'â˜ï¸å¤šäº‘', 337: 'â˜€ï¸æ™´æœ—',
                      367: 'â˜ï¸å¤šäº‘', 369: 'ğŸŒ§ï¸ä¸‹é›¨', 376: 'ğŸŒ¦ï¸æ¯›æ¯›é›¨', 377: 'â˜ï¸å¤šäº‘'
                    };
                    
                    const WEEKDAYS = {
                      0: 'æ˜ŸæœŸæ—¥', 1: 'æ˜ŸæœŸä¸€', 2: 'æ˜ŸæœŸäºŒ', 3: 'æ˜ŸæœŸä¸‰', 4: 'æ˜ŸæœŸå››', 5: 'æ˜ŸæœŸäº”', 6: 'æ˜ŸæœŸå…­'
                    };
                    
                    // è·å–æ˜ŸæœŸå‡ 
                    function getWeekday() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weekday_correction = Math.floor(timestamp / (365 * 2880)) % 7;
                      const weekdayIdx = Math.floor(timestamp / 2880 + 2 - weekday_correction) % 7;
                      return WEEKDAYS[weekdayIdx];
                    }
                    
                    // è·å–å°æ—¶å’Œåˆ†é’Ÿ
                    function getHourAndMinute() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const hour = Math.floor(timestamp / 120) % 24;
                      const minute = Math.floor(timestamp / 2) % 60;
                      const formatted_hour = hour < 10 ? '0' + hour : hour.toString();
                      const formatted_minute = minute < 10 ? '0' + minute : minute.toString();
                      return `${formatted_hour}:${formatted_minute}`;
                    }
                    
                    // è·å–å¤©æ°”è¯¦æƒ…
                    function getWeatherDetail() {
                      const timestamp = Math.floor(Date.now() / 1000);
                      const weather_period = timestamp / 120 % 384;
                      const periods = Object.keys(WEATHERS).map(Number).sort((a, b) => a - b);

                      // å½“å‰å¤©æ°”
                      let currIdx = 0;
                      for (let i = periods.length - 1; i >= 0; i--) {
                        if (periods[i] <= weather_period) {
                          currIdx = i;
                          break;
                        }
                      }
                      const currPeriod = periods[currIdx];
                      const currWeather = WEATHERS[currPeriod];

                      return currWeather;
                    }
                    
                    // æœ¬åœ°è®¡ç®—æ¸¸æˆæ—¶é—´å’Œå¤©æ°”
                    const weekday = getWeekday();
                    const time = getHourAndMinute();
                    const weatherDetail = getWeatherDetail();
                    
                    // æ ¹æ®å¤©æ°”è®¾ç½®emoji
                    let weatherEmoji = 'ğŸŒ¤ï¸';
                    const weather = weatherDetail.toLowerCase();
                    if (weather.includes('é›¨') || weather.includes('æ¯›æ¯›é›¨')) {
                        weatherEmoji = 'ğŸŒ§ï¸';
                    } else if (weather.includes('é›·') || weather.includes('thunder')) {
                        weatherEmoji = 'â›ˆï¸';
                    } else if (weather.includes('é›¾') || weather.includes('éœ¾')) {
                        weatherEmoji = 'ğŸŒ«ï¸';
                    } else if (weather.includes('é˜´') || weather.includes('cloud') || weather.includes('å¤šäº‘')) {
                        weatherEmoji = 'â˜ï¸';
                    } else if (weather.includes('æ™´') || weather.includes('clear') || weather.includes('sun') || weather.includes('æ™´æœ—')) {
                        weatherEmoji = 'â˜€ï¸';
                    }

                    // å¹³æ»‘æ›´æ–°æ–‡æœ¬ï¼šé¿å…æ”¹å˜èƒŒæ™¯é€æ˜åº¦ä»¥é˜²æ­¢é—ªçƒ
                    const newText = `${weekday} ${time} ${weatherEmoji}`;
                    const safeHtml = `<span style="color:white">${newText}</span>`;
                    if (displayElement.innerHTML !== safeHtml) {
                        // ä½¿ç”¨ innerHTML ä¸”å¸¦æ ·å¼ï¼Œç¡®ä¿åœ¨å¯¼èˆªä¸Šçš„å¯è§æ€§
                        displayElement.innerHTML = safeHtml;
                    }
                } catch (error) {
                    displayElement.textContent = 'âŒ è®¡ç®—å¤±è´¥';
                    console.error('è®¡ç®—æ¸¸æˆæ—¶é—´å’Œå¤©æ°”ä¿¡æ¯å¤±è´¥:', error);
                }
            }

            // åˆå§‹åŠ è½½
            updateGameTimeWeather();
            // æ”¾ç½®åˆ°åˆé€‚çš„ä½ç½®ï¼ˆåŸºäºå½“å‰å±å¹•å®½åº¦ï¼‰
            placeGameTimeWeatherForMobile();
            // å¼ºåˆ¶åˆ·æ–°æ–‡æœ¬å’Œå¯è§æ€§ä»¥é˜²æ­¢ç¬¬ä¸€æ¬¡æœªæ˜¾ç¤º
            try { updateGameTimeWeather(); if (displayElement) { displayElement.style.display = 'inline-flex'; displayElement.style.color='white'; } } catch(e) {}
            // åœ¨çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´ä½ç½®
            window.addEventListener('resize', placeGameTimeWeatherForMobile);
            // ç°å®5ç§’ç­‰äºæ¸¸æˆå†…1åˆ†é’Ÿï¼Œæ¯5ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(updateGameTimeWeather, 1000);
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡å¸®æ´¾æ”»å‡»æ˜¾ç¤ºçŠ¶æ€
            setInterval(() => {
                if (activeItemTypes.has('gang_attacks')) {
                    updateItemMarkers(); // å¸®æ´¾æ”»å‡»éœ€è¦é‡æ–°åˆ›å»ºæ ‡è®°
                }
            }, 30000);
        }

        // ä½©é‡Œç§‘å²›æ ·å¼ï¼šä¾§è¾¹æ æŠ˜å /ç¼©æ”¾æŒ‰é’®ä¸å¤šé€‰æ ·å¼/é‡ç½®è¡Œä¸º
        (function initCayoStyleControls() {
            const panelToggle = document.getElementById('panel-toggle');
            const sidePanel = document.getElementById('side-panel');
            if (panelToggle && sidePanel) {
                panelToggle.addEventListener('click', () => {
                    sidePanel.classList.toggle('collapsed');
                    const icon = panelToggle.querySelector('i');
                    if (sidePanel.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-left');
                    }
                });
                // é¢å¤–ç›‘å¬ï¼Œè¦†ç›–å¯èƒ½çš„äº‹ä»¶å†’æ³¡/é˜»æ­¢é—®é¢˜
                panelToggle.addEventListener('touchstart', (ev) => {
                    ev.preventDefault();
                    panelToggle.click();
                });
                // é˜²æ­¢ä¾§è¾¹æ å†…çš„äº¤äº’è§¦å‘åœ°å›¾è¡Œä¸ºï¼ˆæ»šåŠ¨/æ‹–æ‹½/ç‚¹å‡»ç­‰ï¼‰
                try {
                    if (typeof L !== 'undefined' && L.DomEvent) {
                        L.DomEvent.disableClickPropagation(sidePanel);
                        L.DomEvent.disableScrollPropagation(sidePanel);
                    }
                } catch (e) {}
                const stopEvents = ['wheel','mousewheel','DOMMouseScroll','touchstart','touchmove','touchend','pointerdown','pointermove','pointerup','mousedown','mousemove','mouseup','click','dblclick','contextmenu'];
                stopEvents.forEach(evtName => {
                    sidePanel.addEventListener(evtName, (ev) => {
                        ev.stopPropagation();
                    }, { passive: false });
                });
            }

            // ç¼©æ”¾æŒ‰é’®ç»‘å®š
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => map.zoomIn());
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => map.zoomOut());

            // åˆ†ç»„æ¸²æŸ“ + æœç´¢è¿‡æ»¤
            const sidebarContainer = document.getElementById('sidebar-item-selectors');
            const searchInput = document.getElementById('sidebar-item-search');
            if (sidebarContainer) {
                const groupMap = {
                    'è½¦è¡Œé…ç½®': [
                        'dealerships'
                    ],
                    'æ¯æ—¥æ´»åŠ¨': [
                        'gun_van',
                        'dead_drop',
                        'street_dealers',
                        'smoke_on_the_water_product'
                    ],
                    'ä»»åŠ¡ä¸æ´»åŠ¨': [
                        'yuanbao',
                        'stunt_jumps',
                        'payphone_hits',
                        'rc_time_trial',
                        'bike_time_trial',
                        'skydives',
                        'gang_attacks',
                        'treasure_hunt_dba_revolver',
                        'serial_killer_slasher',
                        'maude_bounty_targets',
                        'stash_houses',
                        'madrazo_hits',
                        'police_rescue_patrick_mcreary',
                        'random_missions',
                        'drug_vehicle',
                        'drunk_guard',
                        'metal_detector',
                        'smuggler_plane',
                        'smuggler_trail',
                        'crime_scenes',
                        'wea',
                        'community_outreach',
                        'store_robbery',
                        'convoy',
                        'armored_truck',
                        'exotic_exports1',
                        'exotic_exports2'
                    ],
                    'æ”¶è—å“': [
                        'hidden_caches',
                        'shipwrecked',
                        'ls_tags',
                        'playing_cards',
                        'action_figures',
                        'spray',
                        'ld_organics_products',
                        'signal_jammers',
                        'movie_props',
                        'media_sticks',
                        'v_telescopes',
                        'ppl',
                        'ppw'
                    ],
                    'çº¿ä¸‹æ”¶é›†å“': [
                        'letter_scraps',
                        'sp_hidden_packages',
                        'peyote_sp_land',
                        'peyote_sp_air',
                        'peyote_sp_water',
                        'peyote_sp_special',
                        'submarine_pieces',
                        'spaceship_parts',
                        'nuclear_waste',
                        'humans_of_ls',
                        'monkey_mosaics',
                        'murder_mystery_message'
                    ],
                    'çº¿ä¸‹æ”¯çº¿ä»»åŠ¡': [
                        'assuming_the_truth',
                        'chasing_the_truth',
                        'epsilon_tracts',
                        'for_sale_sign',
                        'the_big_score_gauntlet'
                    ],
                    'çº¿ä¸‹éšæœºä»»åŠ¡':[
                        'hitchhikers'
                    ],
                    'åœ°ç‚¹ä¸æœåŠ¡': [
                        'golf_holes',
                        'metro',
                        'police',
                        'fire_stations',
                        'hospitals',
                        'clothing',
                        'tattoos',
                        'barbers',
                        'ammunation',
                        'mod_shop',
                        'car_wash',
                        'shops_to_rob',
                        'gas_stations',
                        'atms',
                        'vend_sprunk',
                        'vend_ecola'
                    ],
                    'å­£èŠ‚æ€§/ç‰¹æ®Šäº‹ä»¶': [
                        'jack_o_lanterns',
                        'snowmen',
                        'ghosts3',
                        'ufo',
                        'halloween_slashers',
                        'possessed_animals',
                        'cerberus',
                        'yeti',
                        'happy_holidays_hauler'
                    ]
                };

                const typeToOption = Object.fromEntries(sidebarItemOptions.map(o => [o.value, o]));

                function createCheckboxRow(opt) {
                    const type = opt.value;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'item-checkbox-wrapper';

                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.className = 'item-checkbox';
                    chk.dataset.itemType = type;
                    chk.id = `sidebar-item-${type}`;
                    chk.checked = activeItemTypes && activeItemTypes.has && activeItemTypes.has(type);

                    const label = document.createElement('label');
                    label.setAttribute('for', chk.id);
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';

                    if (type !== 'dealerships' && type !== 'gang_attacks') {
                        let iconSrc = null;
                        if (opt.icon) {
                            iconSrc = opt.icon;
                        } else if (typeof itemIcons !== 'undefined' && itemIcons[type]) {
                            iconSrc = itemIcons[type];
                        }
                        if (iconSrc) {
                        const ico = document.createElement('img');
                            ico.src = iconSrc;
                        ico.alt = '';
                        ico.className = 'item-icon';
                            ico.style.width = '16px';
                            ico.style.height = '16px';
                        label.appendChild(ico);
                        }
                    }

                    const span = document.createElement('span');
                    span.textContent = opt.text;
                    label.appendChild(span);

                    // å³ä¾§è®¡æ•°å™¨ï¼ˆsmuggler_planeã€street_dealers å’Œ ghosts3 ä½¿ç”¨ï¼‰
                    if (type === 'smuggler_plane') {
                        const counter = document.createElement('span');
                        counter.className = 'smuggler-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                    }
                    // è¡—å¤´æ¯’è´©è®¡æ•°å™¨
                    else if (type === 'street_dealers') {
                        const counter = document.createElement('span');
                        counter.className = 'street-dealers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateStreetDealersSidebarCount(); } catch(e) {}
                    }
                    // æ´›åœ£éƒ½æ€äººç‹‚è®¡æ•°å™¨
                    else if (type === 'serial_killer_slasher') {
                        const counter = document.createElement('span');
                        counter.className = 'slasher-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSlasherSidebarCount(); } catch(e) {}
                    }
                    // å·¦è½®å¯»å®è®¡æ•°å™¨
                    else if (type === 'treasure_hunt_dba_revolver') {
                        const counter = document.createElement('span');
                        counter.className = 'treasure-hunt-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateTreasureHuntSidebarCount(); } catch(e) {}
                    }
                    // UFOè§‚å…‰è®¡æ•°å™¨
                    else if (type === 'ufo') {
                        const counter = document.createElement('span');
                        counter.className = 'ufo-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateUfoSidebarCount(); } catch(e) {}
                    }
                    // å¹½çµæ›å…‰2025è®¡æ•°å™¨
                    else if (type === 'ghosts3') {
                        const counter = document.createElement('span');
                        counter.className = 'ghosts3-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateGhosts3SidebarCount(); } catch(e) {}
                    }
                    // é›ªäººè®¡æ•°å™¨
                    else if (type === 'snowmen') {
                        const counter = document.createElement('span');
                        counter.className = 'snowmen-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSnowmenSidebarCount(); } catch(e) {}
                    }
                    // å—ç“œç¯è®¡æ•°å™¨
                    else if (type === 'jack_o_lanterns') {
                        const counter = document.createElement('span');
                        counter.className = 'jack-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateJackOLanternsSidebarCount(); } catch(e) {}
                    }
                    // ç”µå½±é“å…·è®¡æ•°å™¨
                    else if (type === 'movie_props') {
                        const counter = document.createElement('span');
                        counter.className = 'movie-props-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateMoviePropsSidebarCount(); } catch(e) {}
                    }
                    // å–·ç½ä½ç½®è®¡æ•°å™¨
                    else if (type === 'spray') {
                        const counter = document.createElement('span');
                        counter.className = 'spray-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSpraySidebarCount(); } catch(e) {}
                    }
                    // é™†åœ°è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                    else if (type === 'ppl') {
                        const counter = document.createElement('span');
                        counter.className = 'ppl-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updatePplSidebarCount(); } catch(e) {}
                    }
                    // æ°´ä¸‹è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                    else if (type === 'ppw') {
                        const counter = document.createElement('span');
                        counter.className = 'ppw-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updatePpwSidebarCount(); } catch(e) {}
                    }
                    // ç‰¹æŠ€è·³è·ƒç‚¹è®¡æ•°å™¨
                    else if (type === 'stunt_jumps') {
                        const counter = document.createElement('span');
                        counter.className = 'stunt-jumps-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateStuntJumpsSidebarCount(); } catch(e) {}
                    }
                    // å…ƒå®è®¡æ•°å™¨
                    else if (type === 'yuanbao') {
                        const counter = document.createElement('span');
                        counter.className = 'yuanbao-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateYuanbaoSidebarCount(); } catch(e) {}
                    }
                    // ä¿¡å·å¹²æ‰°å™¨è®¡æ•°å™¨
                    else if (type === 'signal_jammers') {
                        const counter = document.createElement('span');
                        counter.className = 'signal-jammers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSignalJammersSidebarCount(); } catch(e) {}
                    }
                    // æ‰‹åŠè®¡æ•°å™¨
                    else if (type === 'action_figures') {
                        const counter = document.createElement('span');
                        counter.className = 'action-figures-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateActionFiguresSidebarCount(); } catch(e) {}
                    }
                    // çº¸ç‰Œè®¡æ•°å™¨
                    else if (type === 'playing_cards') {
                        const counter = document.createElement('span');
                        counter.className = 'playing-cards-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updatePlayingCardsSidebarCount(); } catch(e) {}
                    }
                    // æ®‹ç¼ºä¿¡ä»¶è®¡æ•°å™¨
                    else if (type === 'letter_scraps') {
                        const counter = document.createElement('span');
                        counter.className = 'letter-scraps-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateLetterScrapsSidebarCount(); } catch(e) {}
                    }
                     // éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰è®¡æ•°å™¨
                     else if (type === 'sp_hidden_packages') {
                         const counter = document.createElement('span');
                         counter.className = 'sp-hidden-packages-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                         try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                     }
                     // è¿·å¹»ä»™äººæŒé™†åœ°è®¡æ•°å™¨
                     else if (type === 'peyote_sp_land') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-land-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                         try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                     }
                     // è¿·å¹»ä»™äººæŒé¸Ÿç±»è®¡æ•°å™¨
                     else if (type === 'peyote_sp_air') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-air-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                         try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                     }
                     // è¿·å¹»ä»™äººæŒæ°´ä¸‹è®¡æ•°å™¨
                     else if (type === 'peyote_sp_water') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-water-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                         try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                     }
                     // è¿·å¹»ä»™äººæŒé‡‘è‰²è®¡æ•°å™¨
                     else if (type === 'peyote_sp_special') {
                         const counter = document.createElement('span');
                         counter.className = 'peyote-sp-special-counter';
                         counter.style.marginLeft = '6px';
                         counter.style.color = 'var(--gta-text-secondary)';
                         counter.textContent = '';
                         label.appendChild(counter);
                         // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                         try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                     }
                    // æ½œæ°´è‰‡ç¢ç‰‡è®¡æ•°å™¨
                    else if (type === 'submarine_pieces') {
                        const counter = document.createElement('span');
                        counter.className = 'submarine-pieces-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                    }
                    // assuming_the_truth è®¡æ•°å™¨
                    else if (type === 'assuming_the_truth') {
                    const counter = document.createElement('span');
                    counter.className = 'assuming-the-truth-counter';
                    counter.style.marginLeft = '6px';
                    counter.style.color = 'var(--gta-text-secondary)';
                    counter.textContent = '';
                    label.appendChild(counter);
                    // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    }
                    // å®‡å®™é£èˆ¹éƒ¨ä»¶è®¡æ•°å™¨
                    else if (type === 'spaceship_parts') {
                        const counter = document.createElement('span');
                        counter.className = 'spaceship-parts-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                    }
                    // assuming_the_truth è®¡æ•°å™¨
                    else if (type === 'assuming_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'assuming-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œé˜²æ­¢é¦–æ¬¡æ„å»ºæ—¶æ•°æ®/ç¼“å­˜å°šæœªåˆ°ä½
                        setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // æ ¸åºŸæ–™è®¡æ•°å™¨
                    else if (type === 'nuclear_waste') {
                        const counter = document.createElement('span');
                        counter.className = 'nuclear-waste-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateNuclearWasteSidebarCount(); } catch(e) {}
                    }
                    // æ´›åœ£éƒ½çš„äººç±»è®¡æ•°å™¨
                    else if (type === 'humans_of_ls') {
                        const counter = document.createElement('span');
                        counter.className = 'humans-of-ls-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateHumansOfLsSidebarCount(); } catch(e) {}
                    }
                    // çŒ´å­é©¬èµ›å…‹è®¡æ•°å™¨
                    else if (type === 'monkey_mosaics') {
                        const counter = document.createElement('span');
                        counter.className = 'monkey-mosaics-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateMonkeyMosaicsSidebarCount(); } catch(e) {}
                    }
                    // è°‹æ€ä¹‹è°œä¿¡æ¯è®¡æ•°å™¨
                    else if (type === 'murder_mystery_message') {
                        const counter = document.createElement('span');
                        counter.className = 'murder-mystery-message-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œé˜²æ­¢é¦–æ¬¡æ„å»ºæ—¶æ•°æ®/ç¼“å­˜å°šæœªåˆ°ä½
                        setTimeout(() => { try { updateMurderMysteryMessageSidebarCount(); } catch(e) {} }, 200);
                    }
                    // åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·è®¡æ•°å™¨
                    else if (type === 'assuming_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'assuming-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œé˜²æ­¢é¦–æ¬¡æ„å»ºæ—¶æ•°æ®/ç¼“å­˜å°šæœªåˆ°ä½
                        setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨è®¡æ•°å™¨
                    else if (type === 'chasing_the_truth') {
                        const counter = document.createElement('span');
                        counter.className = 'chasing-the-truth-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateChasingTheTruthSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œé˜²æ­¢é¦–æ¬¡æ„å»ºæ—¶æ•°æ®/ç¼“å­˜å°šæœªåˆ°ä½
                        setTimeout(() => { try { updateChasingTheTruthSidebarCount(); } catch(e) {} }, 200);
                    }
                    // åŸƒæ™®è¥¿éš†ä¼ å•è®¡æ•°å™¨
                    else if (type === 'epsilon_tracts') {
                        const counter = document.createElement('span');
                        counter.className = 'epsilon-tracts-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateEpsilonTractsSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®/ç¼“å­˜å°±ç»ª
                        setTimeout(() => { try { updateEpsilonTractsSidebarCount(); } catch(e) {} }, 200);
                    }
                    // å¾…å”®æ ‡å¿—è®¡æ•°å™¨
                    else if (type === 'for_sale_sign') {
                        const counter = document.createElement('span');
                        counter.className = 'for-sale-sign-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateForSaleSignSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®/ç¼“å­˜å°±ç»ª
                        setTimeout(() => { try { updateForSaleSignSidebarCount(); } catch(e) {} }, 200);
                    }
                    // å¤§å¹²ä¸€ç¥¨ï¼ˆå·§å¦™ï¼‰- é“è…• è®¡æ•°å™¨
                    else if (type === 'the_big_score_gauntlet') {
                        const counter = document.createElement('span');
                        counter.className = 'the-big-score-gauntlet-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {}
                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®/ç¼“å­˜å°±ç»ª
                        setTimeout(() => { try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {} }, 200);
                    }
                    // æ­ä¾¿è½¦è®¡æ•°å™¨
                    else if (type === 'hitchhikers') {
                        const counter = document.createElement('span');
                        counter.className = 'hitchhikers-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“
                        try { updateHitchhikersSidebarCount(); } catch (e) {}
                        // å»¶è¿Ÿä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®/ç¼“å­˜å°±ç»ª
                        setTimeout(() => { try { updateHitchhikersSidebarCount(); } catch (e) {} }, 200);
                    }
                    // å–·çŒä½ç½®è®¡æ•°å™¨
                    else if (type === 'spray') {
                        const counter = document.createElement('span');
                        counter.className = 'spray-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSpraySidebarCount(); } catch(e) {}
                    }
                    // é™†åœ°è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                    else if (type === 'ppl') {
                        const counter = document.createElement('span');
                        counter.className = 'ppl-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updatePplSidebarCount(); } catch(e) {}
                    }
                    // æ°´ä¸‹è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                    else if (type === 'ppw') {
                        const counter = document.createElement('span');
                        counter.className = 'ppw-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updatePpwSidebarCount(); } catch(e) {}
                    }
                    // æœ‰æœºåŠäº§å“è®¡æ•°å™¨
                    else if (type === 'ld_organics_products') {
                        const counter = document.createElement('span');
                        counter.className = 'organic-farm-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateOrganicFarmSidebarCount(); } catch(e) {}
                    }
                    // è·³ä¼è®¡æ•°å™¨
                    else if (type === 'skydives') {
                        const counter = document.createElement('span');
                        counter.className = 'skydives-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSkydivesSidebarCount(); } catch(e) {}
                    }
                    // RCæ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨
                    else if (type === 'rc_time_trial') {
                        const counter = document.createElement('span');
                        counter.className = 'rc-time-trial-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                    }
                    // è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨
                    else if (type === 'bike_time_trial') {
                        const counter = document.createElement('span');
                        counter.className = 'bike-time-trial-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                    }
                    // ç›å¾·æ‹‰ç´¢é›‡å‡¶è®¡æ•°å™¨
                    else if (type === 'madrazo_hits') {
                        const counter = document.createElement('span');
                        counter.className = 'madrazo-hits-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                    }
                    // è—åŒ¿å±‹è®¡æ•°å™¨
                    else if (type === 'stash_houses') {
                        const counter = document.createElement('span');
                        counter.className = 'stash-houses-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateStashHousesSidebarCount(); } catch(e) {}
                    }
                    // LSæ¶‚é¸¦è®¡æ•°å™¨
                    else if (type === 'ls_tags') {
                        const counter = document.createElement('span');
                        counter.className = 'ls-tags-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateLSTagsSidebarCount(); } catch(e) {}
                    }
                    // æ²‰èˆ¹è®¡æ•°å™¨
                    else if (type === 'shipwrecked') {
                        const counter = document.createElement('span');
                        counter.className = 'shipwrecked-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateShipwreckedSidebarCount(); } catch(e) {}
                    }
                    // éšè—åŒ…è£¹è®¡æ•°å™¨
                    else if (type === 'hidden_caches') {
                        const counter = document.createElement('span');
                        counter.className = 'hidden-caches-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateHiddenCachesSidebarCount(); } catch(e) {}
                    }
                    // åäº‘åé›¾é¦†äº§å“è®¡æ•°å™¨
                    else if (type === 'smoke_on_the_water_product') {
                        const counter = document.createElement('span');
                        counter.className = 'smoke-product-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateSmokeProductSidebarCount(); } catch(e) {}
                    }
                    // å³ä¾§è®¡æ•°å™¨ï¼ˆgun_vanï¼‰å·²ç§»é™¤
                    // å³ä¾§è®¡æ•°å™¨ï¼ˆdead_dropï¼‰
                    if (type === 'dead_drop') {
                        const counter = document.createElement('span');
                        counter.className = 'dead-drop-counter';
                        counter.style.marginLeft = '6px';
                        counter.style.color = 'var(--gta-text-secondary)';
                        counter.textContent = '';
                        label.appendChild(counter);
                        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
                        try { updateDeadDropSidebarCount(); } catch(e) {}
                    }

                    wrapper.appendChild(chk);
                    wrapper.appendChild(label);

                    chk.addEventListener('change', (e) => {
                        const t = e.target.dataset.itemType;
                        if (t === 'dealerships') {
                            const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                            if (e.target.checked) {
                                activeItemTypes.add(t);
                                migratedDealerships.forEach(dealershipType => activeItemTypes.add(dealershipType));
                            } else {
                                activeItemTypes.delete(t);
                                migratedDealerships.forEach(dealershipType => activeItemTypes.delete(dealershipType));
                            }
                        } else {
                            if (e.target.checked) { activeItemTypes.add(t); } else { activeItemTypes.delete(t); }
                        }

                        if (activeItemTypes.size > 0) {
                            updateItemMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        } else {
                            clearAllItemMarkers();
                            if (typeof clearLeafletMarkers === 'function') clearLeafletMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                        }

                        // å‹¾é€‰çŠ¶æ€å˜åŒ–åå°è¯•åˆ·æ–°è®¡æ•°å™¨
                        if (t === 'smuggler_plane') {
                            try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                        }
                        // è¡—å¤´æ¯’è´©è®¡æ•°å™¨
                        if (t === 'street_dealers') {
                            try { updateStreetDealersSidebarCount(); } catch(e) {}
                        }
                        // æ½œæ°´è‰‡ç¢ç‰‡è®¡æ•°å™¨
                        if (t === 'submarine_pieces') {
                            try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                        }
                        // assuming_the_truth è®¡æ•°å™¨
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        // æ ¸åºŸæ–™è®¡æ•°å™¨
                        if (t === 'nuclear_waste') {
                            try { updateNuclearWasteSidebarCount(); } catch(e) {}
                        }
                        // æ´›åœ£éƒ½çš„äººç±»è®¡æ•°å™¨
                        if (t === 'humans_of_ls') {
                            try { updateHumansOfLsSidebarCount(); } catch(e) {}
                        }
                        // çŒ´å­é©¬èµ›å…‹è®¡æ•°å™¨
                        if (t === 'monkey_mosaics') {
                            try { updateMonkeyMosaicsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateMonkeyMosaicsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // è°‹æ€ä¹‹è°œä¿¡æ¯è®¡æ•°å™¨
                        if (t === 'murder_mystery_message') {
                            try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateMurderMysteryMessageSidebarCount(); } catch(e) {} }, 200);
                        }
                        // åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·è®¡æ•°å™¨
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        // åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨è®¡æ•°å™¨
                        if (t === 'chasing_the_truth') {
                            try { updateChasingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateChasingTheTruthSidebarCount(); } catch(e) {} }, 200);
                        }
                        if (t === 'epsilon_tracts') {
                            try { updateEpsilonTractsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateEpsilonTractsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // æ´›åœ£éƒ½æ€äººç‹‚è®¡æ•°å™¨
                        if (t === 'serial_killer_slasher') {
                            try { updateSlasherSidebarCount(); } catch(e) {}
                        }
                        if (t === 'for_sale_sign') {
                            try { updateForSaleSignSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateForSaleSignSidebarCount(); } catch(e) {} }, 200);
                        }
                        if (t === 'the_big_score_gauntlet') {
                            try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateTheBigScoreGauntletSidebarCount(); } catch(e) {} }, 200);
                        }
                        // å·¦è½®å¯»å®è®¡æ•°å™¨
                        if (t === 'treasure_hunt_dba_revolver') {
                            try { updateTreasureHuntSidebarCount(); } catch(e) {}
                        }
                        // UFOè§‚å…‰è®¡æ•°å™¨
                        if (t === 'ufo') {
                            try { updateUfoSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateUfoSidebarCount(); } catch(e) {} }, 200);
                        }
                        // å¹½çµæ›å…‰2025è®¡æ•°å™¨
                        if (t === 'ghosts3') {
                            try { updateGhosts3SidebarCount(); } catch(e) {}
                        }
                        // é›ªäººè®¡æ•°å™¨
                        if (t === 'snowmen') {
                            try { updateSnowmenSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateSnowmenSidebarCount(); } catch(e) {} }, 200);
                        }
                        // ç”µå½±é“å…·è®¡æ•°å™¨
                        if (t === 'movie_props') {
                            try { updateMoviePropsSidebarCount(); } catch(e) {}
                        }
                        // å–·ç½ä½ç½®è®¡æ•°å™¨
                        if (t === 'spray') {
                            try { updateSpraySidebarCount(); } catch(e) {}
                        }
                        // é™†åœ°è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                        if (t === 'ppl') {
                            try { updatePplSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePplSidebarCount(); } catch(e) {} }, 200);
                        }
                        // æ°´ä¸‹è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                        if (t === 'ppw') {
                            try { updatePpwSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePpwSidebarCount(); } catch(e) {} }, 200);
                        }
                        // ç‰¹æŠ€è·³è·ƒç‚¹è®¡æ•°å™¨
                        if (t === 'stunt_jumps') {
                            try { updateStuntJumpsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateStuntJumpsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // å…ƒå®è®¡æ•°å™¨
                        if (t === 'yuanbao') {
                            try { updateYuanbaoSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateYuanbaoSidebarCount(); } catch(e) {} }, 200);
                        }
                        // ä¿¡å·å¹²æ‰°å™¨è®¡æ•°å™¨
                        if (t === 'signal_jammers') {
                            try { updateSignalJammersSidebarCount(); } catch(e) {}
                        }
                        // æ‰‹åŠè®¡æ•°å™¨
                        if (t === 'action_figures') {
                            try { updateActionFiguresSidebarCount(); } catch(e) {}
                        }
                        // çº¸ç‰Œè®¡æ•°å™¨
                        if (t === 'playing_cards') {
                            try { updatePlayingCardsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updatePlayingCardsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // æ®‹ç¼ºä¿¡ä»¶è®¡æ•°å™¨
                        if (t === 'letter_scraps') {
                            try { updateLetterScrapsSidebarCount(); } catch(e) {}
                        }
                         // éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰è®¡æ•°å™¨
                         if (t === 'sp_hidden_packages') {
                             try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                             setTimeout(() => { try { updateSpHiddenPackagesSidebarCount(); } catch(e) {} }, 200);
                         }
                         // è¿·å¹»ä»™äººæŒé™†åœ°è®¡æ•°å™¨
                         if (t === 'peyote_sp_land') {
                             try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                         }
                         // è¿·å¹»ä»™äººæŒé¸Ÿç±»è®¡æ•°å™¨
                         if (t === 'peyote_sp_air') {
                             try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                         }
                         // è¿·å¹»ä»™äººæŒæ°´ä¸‹è®¡æ•°å™¨
                         if (t === 'peyote_sp_water') {
                             try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                         }
                         // è¿·å¹»ä»™äººæŒé‡‘è‰²è®¡æ•°å™¨
                         if (t === 'peyote_sp_special') {
                             try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                         }
                        // å®‡å®™é£èˆ¹éƒ¨ä»¶è®¡æ•°å™¨
                        if (t === 'spaceship_parts') {
                            try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                        }
                        if (t === 'assuming_the_truth') {
                            try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateAssumingTheTruthSidebarCount(); } catch(e) {} }, 200);
                            }
                        // å—ç“œç¯è®¡æ•°å™¨
                        if (t === 'jack_o_lanterns') {
                            try { updateJackOLanternsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateJackOLanternsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // humans_of_ls å»¶è¿Ÿåˆ·æ–°
                        if (t === 'humans_of_ls') {
                            try { updateHumansOfLsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateHumansOfLsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // å–·çŒä½ç½®è®¡æ•°å™¨
                        if (t === 'spray') {
                            try { updateSpraySidebarCount(); } catch(e) {}
                        }
                        // é™†åœ°è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                        if (t === 'ppl') {
                            try { updatePplSidebarCount(); } catch(e) {}
                        }
                        // æ°´ä¸‹è¿·å¹»ä»™äººæŒè®¡æ•°å™¨
                        if (t === 'ppw') {
                            try { updatePpwSidebarCount(); } catch(e) {}
                        }
                        // æœ‰æœºåŠäº§å“è®¡æ•°å™¨
                        if (t === 'ld_organics_products') {
                            try { updateOrganicFarmSidebarCount(); } catch(e) {}
                        }
                        // è·³ä¼è®¡æ•°å™¨
                        if (t === 'skydives') {
                            try { updateSkydivesSidebarCount(); } catch(e) {}
                        }
                        // RCæ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨
                        if (t === 'rc_time_trial') {
                            try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                        }
                        // è‡ªè¡Œè½¦æ—¶é—´æŒ‘æˆ˜èµ›è®¡æ•°å™¨
                        if (t === 'bike_time_trial') {
                            try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                        }
                        // ç›å¾·æ‹‰ç´¢é›‡å‡¶è®¡æ•°å™¨
                        if (t === 'madrazo_hits') {
                            try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                        }
                        // è—åŒ¿å±‹è®¡æ•°å™¨
                        if (t === 'stash_houses') {
                            try { updateStashHousesSidebarCount(); } catch(e) {}
                        }
                        // LSæ¶‚é¸¦è®¡æ•°å™¨
                        if (t === 'ls_tags') {
                            try { updateLSTagsSidebarCount(); } catch(e) {}
                            setTimeout(() => { try { updateLSTagsSidebarCount(); } catch(e) {} }, 200);
                        }
                        // æ²‰èˆ¹è®¡æ•°å™¨
                        if (t === 'shipwrecked') {
                            try { updateShipwreckedSidebarCount(); } catch(e) {}
                        }
                        // éšè—åŒ…è£¹è®¡æ•°å™¨
                        if (t === 'hidden_caches') {
                            try { updateHiddenCachesSidebarCount(); } catch(e) {}
                        }
                        // åäº‘åé›¾é¦†äº§å“è®¡æ•°å™¨
                        if (t === 'smoke_on_the_water_product') {
                            try { updateSmokeProductSidebarCount(); } catch(e) {}
                        }
                        // gun_van ä¸å†æœ‰ä¾§è¾¹è®¡æ•°å™¨
                        if (t === 'dead_drop') {
                            try { updateDeadDropSidebarCount(); } catch(e) {}
                        }
                    });

                    return wrapper;
                }

                function renderSidebar(filterText = '') {
                    sidebarContainer.innerHTML = '';
                    const normalized = (filterText || '').trim().toLowerCase();
                    Object.keys(groupMap).forEach(groupName => {
                        const types = groupMap[groupName];
                        const visibleOpts = types
                            .map(t => typeToOption[t])
                            .filter(Boolean)
                            .filter(opt => {
                                if (!normalized) return true;
                                const text = (opt.text || '').toLowerCase();
                                const value = (opt.value || '').toLowerCase();
                                return text.includes(normalized) || value.includes(normalized);
                            });
                        if (visibleOpts.length === 0) return;

                        const header = document.createElement('div');
                        header.className = 'item-group-header';
                        const titleSpan = document.createElement('span');
                        titleSpan.textContent = groupName;
                        const chevron = document.createElement('i');
                        chevron.className = 'fas fa-chevron-down chevron';
                        header.appendChild(titleSpan);
                        header.appendChild(chevron);

                        const content = document.createElement('div');
                        content.className = 'item-group-content';

                        visibleOpts.forEach(opt => {
                            const row = createCheckboxRow(opt);
                            content.appendChild(row);
                        });

                        header.addEventListener('click', () => {
                            const isCollapsed = content.classList.toggle('collapsed');
                            chevron.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
                        });

                        sidebarContainer.appendChild(header);
                        sidebarContainer.appendChild(content);
                    });

                    // æ¸²æŸ“å®Œæˆåï¼Œåˆ·æ–°ä¸€æ¬¡è®¡æ•°å™¨
                    try { updateSmugglerPlaneSidebarCount(); } catch(e) {}
                    try { updateStreetDealersSidebarCount(); } catch(e) {}
                    try { updateSubmarinePiecesSidebarCount(); } catch(e) {}
                    try { updateNuclearWasteSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    try { updateSlasherSidebarCount(); } catch(e) {}
                    try { updateTreasureHuntSidebarCount(); } catch(e) {}
                    try { updateUfoSidebarCount(); } catch(e) {}
                    try { updateGhosts3SidebarCount(); } catch(e) {}
                    try { updateSnowmenSidebarCount(); } catch(e) {}
                    try { updateMoviePropsSidebarCount(); } catch(e) {}
                    try { updateSpraySidebarCount(); } catch(e) {}
                    try { updatePplSidebarCount(); } catch(e) {}
                    try { updatePpwSidebarCount(); } catch(e) {}
                    try { updateStuntJumpsSidebarCount(); } catch(e) {}
                    try { updateYuanbaoSidebarCount(); } catch(e) {}
                    try { updateSignalJammersSidebarCount(); } catch(e) {}
                    try { updateActionFiguresSidebarCount(); } catch(e) {}
                    try { updatePlayingCardsSidebarCount(); } catch(e) {}
                    try { updateLetterScrapsSidebarCount(); } catch(e) {}
                    try { updateMurderMysteryMessageSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                     try { updateSpHiddenPackagesSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpLandSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpAirSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpWaterSidebarCount(); } catch(e) {}
                     try { updatePeyoteSpSpecialSidebarCount(); } catch(e) {}
                     try { updateSpaceshipPartsSidebarCount(); } catch(e) {}
                    try { updateSpraySidebarCount(); } catch(e) {}
                    try { updateOrganicFarmSidebarCount(); } catch(e) {}
                    try { updateSkydivesSidebarCount(); } catch(e) {}
                    try { updateRCTimeTrialSidebarCount(); } catch(e) {}
                    try { updateBikeTimeTrialSidebarCount(); } catch(e) {}
                    try { updateMadrazoHitsSidebarCount(); } catch(e) {}
                    try { updateStashHousesSidebarCount(); } catch(e) {}
                    try { updateLSTagsSidebarCount(); } catch(e) {}
                    try { updateShipwreckedSidebarCount(); } catch(e) {}
                    try { updateHiddenCachesSidebarCount(); } catch(e) {}
                    try { updateSmokeProductSidebarCount(); } catch(e) {}
                    try { updateDeadDropSidebarCount(); } catch(e) {}
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                    
                    // å»¶è¿Ÿæ›´æ–°è®¡æ•°å™¨ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½
                    setTimeout(() => {
                        try { updateStreetDealersSidebarCount(); } catch(e) {}
                    }, 100);
                }

                // åº”ç”¨ç¼“å­˜çš„ä¾§è¾¹æ çŠ¶æ€
                const hasCachedState = SidebarCache.applyState(activeItemTypes);
                if (hasCachedState) {
                    console.log('å·²æ¢å¤ä¾§è¾¹æ ç¼“å­˜çŠ¶æ€');
                }

                renderSidebar('');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => renderSidebar(e.target.value));
                }

                // å¦‚æœæœ‰ç¼“å­˜çŠ¶æ€ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“æ ‡è®°
                if (hasCachedState) {
                    setTimeout(() => {
                        try {
                            updateItemMarkers();
                            if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                            if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                            console.log('å·²æ ¹æ®ç¼“å­˜çŠ¶æ€é‡æ–°æ¸²æŸ“æ ‡è®°');
                        } catch (e) {
                            console.warn('é‡æ–°æ¸²æŸ“æ ‡è®°æ—¶å‡ºé”™:', e);
                        }
                    }, 100);
                }

                // ä¿å­˜ä¾§è¾¹æ çŠ¶æ€åˆ°ç¼“å­˜ï¼ˆåœ¨çŠ¶æ€å˜åŒ–æ—¶ï¼‰
                const originalAdd = activeItemTypes.add.bind(activeItemTypes);
                const originalDelete = activeItemTypes.delete.bind(activeItemTypes);
                const originalClear = activeItemTypes.clear.bind(activeItemTypes);
                
                activeItemTypes.add = function(value) {
                    const result = originalAdd(value);
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
                
                activeItemTypes.delete = function(value) {
                    const result = originalDelete(value);
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
                
                activeItemTypes.clear = function() {
                    const result = originalClear();
                    setTimeout(() => SidebarCache.saveState(activeItemTypes), 0);
                    return result;
                };
            }

            // æ˜¾ç¤ºå…¨éƒ¨/éšè—å…¨éƒ¨æŒ‰é’®
            const showAllBtn = document.getElementById('show-all-items');
            const hideAllBtn = document.getElementById('hide-all-items');
            // ç®€æ˜“é€šç”¨ç¡®è®¤å¼¹çª—å‡½æ•°
            function openConfirmModal(message, onOk, onCancel) {
                const modal = document.getElementById('confirm-modal');
                const msgEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                const overlay = modal.querySelector('.confirm-modal-overlay');
                if (!modal || !msgEl || !okBtn || !cancelBtn) return onOk && onOk();

                msgEl.textContent = message;
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');

                const cleanup = () => {
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    okBtn.removeEventListener('click', okHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    if (overlay) overlay.removeEventListener('click', cancelHandler);
                };

                const okHandler = () => { cleanup(); if (onOk) onOk(); };
                const cancelHandler = () => { cleanup(); if (onCancel) onCancel(); };

                okBtn.addEventListener('click', okHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                if (overlay) overlay.addEventListener('click', cancelHandler);
            }

            if (showAllBtn) {
                showAllBtn.addEventListener('click', () => {
                    openConfirmModal('ç‰©å“ä¿¡æ¯è¾ƒå¤šï¼Œæ˜¾ç¤ºå…¨éƒ¨å¯èƒ½é€ æˆå¡é¡¿ï¼Œæ˜¯å¦ç»§ç»­æ˜¾ç¤ºï¼Ÿ', () => {
                    // å…¨é€‰å¤é€‰æ¡†
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = true);
                    // é‡å»º activeItemTypes
                    try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                    const migratedDealerships = ['casino', 'car_meet', 'premium_deluxe_motorsport', 'luxury_autos'];
                    sidebarItemOptions.forEach(opt => {
                        activeItemTypes.add(opt.value);
                        if (opt.value === 'dealerships') {
                            migratedDealerships.forEach(t => activeItemTypes.add(t));
                        }
                    });
                    // åˆ·æ–°æ ‡è®°
                    updateItemMarkers();
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                    }, () => {
                        // å–æ¶ˆæ— æ“ä½œ
                    });
                });
            }
            if (hideAllBtn) {
                hideAllBtn.addEventListener('click', () => {
                    openConfirmModal('æ˜¯å¦è¦éšè—å…¨éƒ¨å†…å®¹ï¼Ÿ', () => {
                        // å–æ¶ˆå…¨é€‰
                        document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = false);
                        // æ¸…é™¤æ ‡è®°ä¸æ¿€æ´»é›†åˆ
                        clearAllItemMarkers();
                        // åŒæ­¥æ¸…ç†Leafletæ ‡è®°
                        if (typeof clearLeafletMarkers === 'function') clearLeafletMarkers();
                        try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                        if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                        if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                    }, () => {
                        // å–æ¶ˆæ— æ“ä½œ
                    });
                });
            }

            // é‡ç½®æŒ‰é’®
            const resetBtn = document.getElementById('reset-checkboxes');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    document.querySelectorAll('#sidebar-item-selectors .item-checkbox').forEach(c => c.checked = false);
                    // æ¸…ç©ºæ‰€æœ‰ item markers
                    clearAllItemMarkers();
                    // æ¸…ç©º activeItemTypesï¼Œç¡®ä¿é‡ç½®åä¸ä¼šåœ¨åç»­æ“ä½œä¸­é‡æ–°æ˜¾ç¤ºå·²å–æ¶ˆçš„ç±»å‹
                    try { if (activeItemTypes && typeof activeItemTypes.clear === 'function') activeItemTypes.clear(); } catch(e) {}
                    // åŒæ­¥æ›´æ–°è½¦è¡Œæ ‡è®°ï¼ˆå…¨éƒ¨éšè—ï¼‰å¹¶åˆ·æ–° tilePane ä½ç½®
                    if (typeof updateDealershipMarkers === 'function') updateDealershipMarkers();
                    if (typeof updateTilePanePosition === 'function') updateTilePanePosition();
                });
            }
        })();

        // é¢å¤–ä¿éšœï¼šå…¨å±€ç›‘å¬ï¼Œç”¨äºç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨æ—¶è‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ ï¼ˆé¿å…ä¸æŒ‰é’®çš„åŒé‡è§¦å‘å†²çªï¼‰
        document.addEventListener('click', (e) => {
            const sidePanel = document.getElementById('side-panel');
            if (!sidePanel) return;
            // å¦‚æœç‚¹å‡»äº†æŠ˜å æŒ‰é’®æœ¬èº«ï¼Œäº¤ç”±æŒ‰é’®çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†ï¼Œé¿å…åŒé‡åˆ‡æ¢
            if (e.target.closest && e.target.closest('.side-panel-toggle')) return;
            // å¦‚æœå½“å‰æœªæŠ˜å ï¼Œä¸”ç‚¹å‡»ç›®æ ‡ä½äºä¾§è¾¹æ å¤–éƒ¨ï¼Œåˆ™æŠ˜å ä¾§è¾¹æ 
            if (!sidePanel.classList.contains('collapsed') && !sidePanel.contains(e.target)) {
                sidePanel.classList.add('collapsed');
                // æ›´æ–°æŒ‰é’®å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const toggleBtn = document.querySelector('.side-panel-toggle');
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    }
                }
            }
        });

        // è¾…åŠ©ï¼šæ¸…é™¤ç‰¹å®šç±»å‹çš„ item markersï¼ˆæ”¯æŒ itemMarkers ä¸º {type,index,el} ç»“æ„ï¼‰
        function clearItemMarkersOfType(type) {
            if (!itemMarkers || itemMarkers.length === 0) return;
            // è¿‡æ»¤å¹¶ç§»é™¤å¯¹åº”ç±»å‹çš„ DOM å…ƒç´ 
            const remaining = [];
            itemMarkers.forEach(m => {
                if (m && ((m.type && m.type === type) || (!m.type && m.dataset && m.dataset.type === type))) {
                    // m å¯èƒ½æ˜¯å¯¹è±¡ {type,index,el} æˆ–è€å¼ DOM å…ƒç´ 
                    const el = m.el ? m.el : m;
                    if (el && el.remove) el.remove();
                } else {
                    remaining.push(m);
                }
            });
            itemMarkers = remaining;
            // ä¸å†é‡ç½® currentItemTypeï¼Œè¿™æ ·åœ¨ multi-select åœºæ™¯ä¸‹ä¸ä¼šæ„å¤–æ¸…ç©ºå•é€‰çŠ¶æ€
        }

        // æ¸…é™¤æ‰€æœ‰ item markers
        function clearAllItemMarkers() {
            if (!itemMarkers || itemMarkers.length === 0) return;
            itemMarkers.forEach(m => {
                const el = m && m.el ? m.el : m;
                if (el && el.remove) el.remove();
            });
            itemMarkers = [];
            
            // æ¸…é™¤Leafletæ ‡è®°
            clearLeafletMarkers();
            
            // ä¿æŒ currentItemType ä¸å˜ï¼Œè¿™é‡Œåªæ¸…ç†å¯è§†æ ‡è®°
        }



        // ä¿è¯ä¾§è¾¹æ å†…å®¹åœ¨ç§»åŠ¨ç«¯å¯æ»šåŠ¨ä¸”æ»šåŠ¨æ—¶ä¸è§¦å‘åœ°å›¾æ‹–åŠ¨
        document.addEventListener('DOMContentLoaded', function() {
            const sidePanelContent = document.querySelector('.side-panel-content');
            if (sidePanelContent) {
                // ä¼˜åŒ– CSSï¼šå¯ç”¨åŸç”Ÿå¹³æ»‘æ»šåŠ¨ï¼ˆiOSï¼‰
                sidePanelContent.style.webkitOverflowScrolling = 'touch';
                sidePanelContent.style.touchAction = 'pan-y';

                // é¼ æ ‡æ»šè½®ï¼ˆæ¡Œé¢ï¼‰æ»šåŠ¨æ—¶é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ°å›¾
                sidePanelContent.addEventListener('wheel', function(e) {
                    const atTop = sidePanelContent.scrollTop === 0;
                    const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                    if ((e.deltaY < 0 && !atTop) || (e.deltaY > 0 && !atBottom)) {
                        e.stopPropagation();
                    }
                }, { passive: false });

                // ç§»åŠ¨ç«¯è§¦æ‘¸å¤„ç†ï¼šæ£€æµ‹å‚ç›´æ»‘åŠ¨å¹¶é˜»æ­¢å†’æ³¡ï¼Œä»è€Œé¿å…åœ°å›¾å“åº”
                let startY = 0;
                let startX = 0;
                let isScrolling = undefined;

                sidePanelContent.addEventListener('touchstart', function(e) {
                    if (e.touches && e.touches.length === 1) {
                        startY = e.touches[0].clientY;
                        startX = e.touches[0].clientX;
                        isScrolling = undefined; // æœªç¡®å®šæ–¹å‘
                    }
                }, { passive: true });

                sidePanelContent.addEventListener('touchmove', function(e) {
                    if (!(e.touches && e.touches.length === 1)) return;
                    const curY = e.touches[0].clientY;
                    const curX = e.touches[0].clientX;
                    const dy = Math.abs(curY - startY);
                    const dx = Math.abs(curX - startX);

                    if (typeof isScrolling === 'undefined') {
                        isScrolling = dy > dx; // å¦‚æœå‚ç›´ä½ç§»å¤§äºæ°´å¹³ä½ç§»ï¼Œåˆ¤å®šä¸ºæ»šåŠ¨
                    }

                    if (isScrolling) {
                        // å½“é¢æ¿å¯ä»¥ç»§ç»­æ»šåŠ¨æ—¶ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ°å›¾
                        const atTop = sidePanelContent.scrollTop === 0;
                        const atBottom = sidePanelContent.scrollTop + sidePanelContent.clientHeight >= sidePanelContent.scrollHeight - 1;
                        const movingUp = (curY - startY) > 0;
                        const movingDown = !movingUp;

                        // å¦‚æœå°šæœªåˆ°è¾¾è¾¹ç•Œï¼Œåˆ™é˜»æ­¢å†’æ³¡ï¼ˆå…è®¸å®¹å™¨å†…éƒ¨æ»šåŠ¨ï¼‰
                        if ((movingUp && !atTop) || (movingDown && !atBottom)) {
                            e.stopPropagation();
                            // ä¸è°ƒç”¨ preventDefaultï¼šå…è®¸æ»šåŠ¨å‘ç”Ÿï¼ŒåŒæ—¶é˜»æ­¢åœ°å›¾æ•è·
                        }
                    }
                }, { passive: false });

                // æ¸…ç†çŠ¶æ€
                sidePanelContent.addEventListener('touchend', function() {
                    isScrolling = undefined;
                });
            }
        });
    </script>

    <script>
        // å¼ºåˆ¶åœ¨æ”¯æŒçš„æµè§ˆå™¨ä¸Šé˜»æ­¢æ‰‹åŠ¿ç¼©æ”¾ï¼ˆiOS çš„ gesture eventsï¼‰
        (function preventPinchZoom() {
            // Prevent iOS gesture events
            function stopEvent(e) { e.preventDefault(); }
            try {
                document.addEventListener('gesturestart', stopEvent, { passive: false });
                document.addEventListener('gesturechange', stopEvent, { passive: false });
                document.addEventListener('gestureend', stopEvent, { passive: false });
            } catch (err) {
                // æŸäº›æµè§ˆå™¨ä¸æ”¯æŒ gesture* äº‹ä»¶ï¼Œå¿½ç•¥é”™è¯¯
            }

            // Prevent pinch-zoom via two-finger touchmove
            document.addEventListener('touchstart', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent double-tap zoom (by blocking very quick successive touchend)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            // Prevent zooming with Ctrl + wheel (desktop/tablet)
            window.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
        })();

        // ==================== åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…· å¼¹çª—ï¼ˆæ ·å¼ä¸æ ¸åºŸæ–™ä¸€è‡´ï¼šåº•éƒ¨æŒ‰é’®ï¼Œç§»é™¤å³ä¸Šè§’Ã—ï¼‰
        function showAssumingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/assuming_the_truth/assuming_the_truth_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.assuming-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            const totalCount = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const name = item?.name || `è½½å…· #${sequenceNumber}`;
            const title = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—ï¼ˆæ— å³ä¸Šè§’ Ã—ï¼Œä¿ç•™åº•éƒ¨æŒ‰é’®ï¼‰
            const popup = document.createElement('div');
            popup.className = 'assuming-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="assuming_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>è¿™æ˜¯éœ€è¦è¿é€ç»™åŸƒæ™®è¥¿éš†è®¡åˆ’çš„è½½å…·ï¼Œæ˜¯é™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡è´¨ç–‘çœŸç†ï¼ˆéº¦å…‹ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚<br/>è½½å…·æ€»æ˜¯åœ¨å›¾ç¤ºçš„ç¡®åˆ‡ä½ç½®ç”Ÿæˆã€‚</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-att-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-att-btn');
            const hideBtn = popup.querySelector('#hide-att-btn');
            const showBtn = popup.querySelector('#show-att-btn');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // éšè—/æ˜¾ç¤ºé€»è¾‘ + ç¼“å­˜ + è®¡æ•°å™¨
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('assuming_the_truth', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·å¯è§æ€§ç¼“å­˜
        function applyAssumingTheTruthVisibilityCache() {
            try {
                const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
                if (!Array.isArray(markers) || markers.length === 0) return;
                const visibilityMap = VisibilityCache.loadVisibility('assuming_the_truth') || {};
                markers.forEach((marker, i) => {
                    if (!marker) return;
                    const isHidden = !!visibilityMap[i];
                    const opacity = isHidden ? 0.3 : 1;
                    if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                    else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                });
                // åº”ç”¨ç¼“å­˜åå°è¯•åˆ·æ–°è®¡æ•°å™¨
                try { updateAssumingTheTruthSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('åº”ç”¨åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…·å¯è§æ€§ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–° assuming_the_truth ä¾§è¾¹æ è®¡æ•°å™¨
        function updateAssumingTheTruthSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-assuming_the_truth + label .assuming-the-truth-counter');
                if (!counterEl) return;

                const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
                const total = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('assuming_the_truth');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                CounterCache.updateCounter('assuming_the_truth', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–° assuming_the_truth è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–° chasing_the_truth ä¾§è¾¹æ è®¡æ•°å™¨
        function updateChasingTheTruthSidebarCount() {
            try {
                let counterEl = document.querySelector('#sidebar-item-chasing_the_truth + label .chasing-the-truth-counter');
                // å…œåº•ï¼šé€šè¿‡ nextElementSibling ç²¾ç¡®å®šä½ label å†æ‰¾ counter
                if (!counterEl) {
                    const inputEl = document.getElementById('sidebar-item-chasing_the_truth');
                    const labelEl = inputEl && inputEl.nextElementSibling;
                    if (labelEl) counterEl = labelEl.querySelector('.chasing-the-truth-counter');
                }
                if (!counterEl) return;
                // ä»…åŸºäº VisibilityCache è®¡ç®—ï¼ˆLeaflet æ¨¡å¼ä¸‹ä¸ä¾èµ– DOMï¼‰
                const total = Array.isArray(window.itemData?.chasing_the_truth) ? window.itemData.chasing_the_truth.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) {
                    if (visibilityMap[i] === true) hidden++;
                }

                CounterCache.updateCounter('chasing_the_truth', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–° chasing_the_truth è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨ å¼¹çª—ï¼ˆæ ·å¼ä¸æ ¸åºŸæ–™ä¸€è‡´ï¼šåº•éƒ¨æŒ‰é’®ï¼Œç§»é™¤å³ä¸Šè§’Ã—ï¼‰
        function showChasingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            // ç›´æ¥ä½¿ç”¨åºå·ï¼Œä¸åŠ å‰å¯¼0
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/chasing_the_truth/chasing_the_truth_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.chasing-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆåŸºäº VisibilityCacheï¼‰
            const arr = Array.isArray(window.itemData?.chasing_the_truth) ? window.itemData.chasing_the_truth : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) {
                if (visibilityMap[i] === true) hiddenCount++;
            }
            let isCurrentHidden = visibilityMap[index] === true;

            const name = item?.name || `ç¥å™¨ #${sequenceNumber}`;
            const title = `â˜¯ï¸ åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç† - ${name} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—ï¼ˆæ— å³ä¸Šè§’ Ã—ï¼Œä¿ç•™åº•éƒ¨æŒ‰é’®ï¼‰
            const popup = document.createElement('div');
            popup.className = 'chasing-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="chasing_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>è¿™æ˜¯éœ€è¦æ”¶é›†çš„åŸƒæ™®æ–¯éš†ç¥å™¨ï¼Œæ˜¯é™·ç”Ÿäººä¸æ€ªå’•ä»»åŠ¡è¿½æ±‚çœŸç†ï¼ˆéº¦å…‹ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚<br/>ç¥å™¨æ€»æ˜¯åœ¨å›¾ç¤ºçš„ç¡®åˆ‡ä½ç½®ç”Ÿæˆã€‚</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-ctt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-ctt-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-ctt-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-ctt-btn');
            const hideBtn = popup.querySelector('#hide-ctt-btn');
            const showBtn = popup.querySelector('#show-ctt-btn');
            const titleElement = popup.querySelector('h3');

            // å½“å‰ marker ä»¥åŠè®¾ç½®é€æ˜åº¦çš„å‡½æ•°
            const cttMarkers = (window.chasingTheTruthMarkers && window.chasingTheTruthMarkers) || [];
            const currentCttMarker = cttMarkers[index];
            function setCurrentCttMarkerVisibility(opacity) {
                if (currentCttMarker && typeof currentCttMarker.setOpacity === 'function') currentCttMarker.setOpacity(opacity);
                else if (currentCttMarker && typeof currentCttMarker.setStyle === 'function') currentCttMarker.setStyle({ opacity });
                else if (currentCttMarker && typeof currentCttMarker.getElement === 'function') {
                    const el = currentCttMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
                const map = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                if (opacity === 0.3) map[index] = true; else delete map[index];
                VisibilityCache.saveVisibility('chasing_the_truth', map);
            }

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆè¦†ç›–å±‚ï¼Œä¸æ‰“å¼€æ–°æ ‡ç­¾ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // éšè—/æ˜¾ç¤ºæŒ‰é’®äº‹ä»¶ï¼ˆåŒæ—¶ä¿®æ”¹é€æ˜åº¦ï¼‰
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentCttMarkerVisibility(0.3);
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    hiddenCount = newHiddenCount;
                    isCurrentHidden = true;
                    titleElement.textContent = `â˜¯ï¸ åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                    try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                });
            }
            
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentCttMarkerVisibility(1);
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    hiddenCount = newHiddenCount;
                    isCurrentHidden = false;
                    titleElement.textContent = `â˜¯ï¸ åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                    try { updateChasingTheTruthSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        

        // åº”ç”¨åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨å¯è§æ€§ç¼“å­˜ï¼ˆè®¾ç½®é€æ˜åº¦+åˆ·æ–°è®¡æ•°å™¨ï¼‰
        function applyChasingTheTruthVisibilityCache() {
            try {
                const markers = (window.chasingTheTruthMarkers && window.chasingTheTruthMarkers) || [];
                const visibilityMap = VisibilityCache.loadVisibility('chasing_the_truth') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!visibilityMap[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') marker.setOpacity(opacity);
                        else if (typeof marker.setStyle === 'function') marker.setStyle({ opacity });
                        else if (typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) el.style.opacity = String(opacity);
                        }
                    });
                }
                try { updateChasingTheTruthSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('åº”ç”¨åŸƒæ™®æ–¯éš†è¿½æ±‚çœŸç†-ç¥å™¨å¯è§æ€§ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // ==================== åŸƒæ™®è¥¿éš†ä¼ å•ï¼ˆepsilon_tractsï¼‰ ====================

        // ä¾§è¾¹æ è®¡æ•°å™¨ï¼šåŸºäº VisibilityCache ç»Ÿè®¡éšè—/æ€»æ•°
        function updateEpsilonTractsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-epsilon_tracts + label .epsilon-tracts-counter');
                if (!counterEl) return;

                const total = Array.isArray(window.itemData?.epsilon_tracts) ? window.itemData.epsilon_tracts.length : 0;
                const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
                let hidden = 0;
                for (let i = 0; i < total; i++) if (visibilityMap[i] === true) hidden++;

                CounterCache.updateCounter('epsilon_tracts', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–° epsilon_tracts è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // åº”ç”¨å¯è§æ€§ç¼“å­˜ï¼šæ ¹æ®ç¼“å­˜æ¢å¤æ ‡è®°é€æ˜åº¦ï¼Œå¹¶åˆ·æ–°è®¡æ•°å™¨ï¼ˆè®¡æ•°åŸºäºç¼“å­˜ï¼Œä¸ä¾èµ–DOMï¼‰
        function applyEpsilonTractsVisibilityCache() {
            try {
                const markers = (window.epsilonTractsMarkers && window.epsilonTractsMarkers) || [];
                const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
                if (Array.isArray(markers) && markers.length > 0) {
                    markers.forEach((marker, i) => {
                        if (!marker) return;
                        const isHidden = !!visibilityMap[i];
                        const opacity = isHidden ? 0.3 : 1;
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(opacity);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity });
                        } else if (typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) el.style.opacity = String(opacity);
                        }
                    });
                }
                try { updateEpsilonTractsSidebarCount(); } catch (e) {}
            } catch (e) {
                console.warn('åº”ç”¨ epsilon_tracts å¯è§æ€§ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // å¼¹çª—ï¼ˆæ ·å¼åŒç¥å™¨ï¼‰ï¼šåº•éƒ¨æŒ‰é’® + å›¾ç‰‡ + æ–‡æ¡ˆ
        function showEpsilonTractsPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/epsilon_tracts/epsilon_tracts_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.epsilon-tracts-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°ï¼ˆåŸºäº VisibilityCacheï¼‰
            const arr = Array.isArray(window.itemData?.epsilon_tracts) ? window.itemData.epsilon_tracts : [];
            const totalCount = arr.length;
            const visibilityMap = VisibilityCache.loadVisibility('epsilon_tracts') || {};
            let hiddenCount = 0;
            for (let i = 0; i < totalCount; i++) if (visibilityMap[i] === true) hiddenCount++;
            let isCurrentHidden = visibilityMap[index] === true;

            const name = item?.name || `ä¼ å• #${sequenceNumber}`;
            const title = `â˜¯ï¸ åŸƒæ™®è¥¿éš†ä¼ å• - ${name} (${hiddenCount}/${totalCount})`;

            const popup = document.createElement('div');
            popup.className = 'epsilon-tracts-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                </div>
                <img src="${imageUrl}" alt="epsilon_tracts #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                    <div>æ¸¸æˆä¸­å…±æœ‰ 10 å¼ ä¼ å•ï¼Œç©å®¶éœ€è¦æŒ‰ç‰¹å®šçš„é¡ºåºæ”¶é›†ã€‚<br/>æ­¤æ”¶è—å“åœ¨å®Œæˆé™Œç”Ÿäººå’Œæ€ªèƒä»»åŠ¡æ¨¡ç³ŠçœŸç†ï¼ˆéº¦å…‹ï¼‰åè§£é”ã€‚é©¬å°”å°¼ä¼šå‘ç©å®¶å‘é€ä¸€æ¡çŸ­ä¿¡ï¼Œå‘ŠçŸ¥æ­¤æ”¶è—å“çš„ç›¸å…³ä¿¡æ¯ã€‚<br/>ä¼ å•å¯ä»¥ç”±ä»»æ„è§’è‰²æ”¶é›†ã€‚æ¯æ”¶é›†ä¸€å¼ ä¼ å•ï¼Œé©¬å°”å°¼ä¼šå‘éº¦å…‹å‘é€çŸ­ä¿¡ï¼Œæç¤ºä¸‹ä¸€å¼ ä¼ å•çš„ä½ç½®ã€‚<br/>é›†é½è¯¥æ”¶è—å“ï¼Œæ‚¨å°†è§£é”ç¬¬ä¹å…¸èŒƒçš„åŸƒæ™®è¥¿éš†ä¼ å•ï¼Œ157 å¹´ã€‚</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-et-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-et-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-et-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-et-btn');
            const hideBtn = popup.querySelector('#hide-et-btn');
            const showBtn = popup.querySelector('#show-et-btn');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—ï¼ˆç‚¹å‡»å¤–éƒ¨ï¼‰
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆè¦†ç›–å±‚ï¼Œä¸æ‰“å¼€æ–°æ ‡ç­¾ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);
                    const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å½“å‰ markerï¼ˆè‹¥å­˜åœ¨ï¼‰åŠè®¾ç½®å‡½æ•°
            const markers = (window.epsilonTractsMarkers && window.epsilonTractsMarkers) || [];
            const currentMarker = markers[index];
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') currentMarker.setOpacity(opacity);
                else if (currentMarker && typeof currentMarker.setStyle === 'function') currentMarker.setStyle({ opacity });
                else if (currentMarker && typeof currentMarker.getElement === 'function') {
                    const el = currentMarker.getElement();
                    if (el) el.style.opacity = String(opacity);
                }
                VisibilityCache.updateItemVisibility('epsilon_tracts', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    if (!isCurrentHidden) hiddenCount = hiddenCount + 1;
                    setCurrentMarkerVisibility(0.3);
                    titleElement.textContent = `â˜¯ï¸ åŸƒæ™®è¥¿éš†ä¼ å• - ${name} (${hiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;
                    try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    if (isCurrentHidden) hiddenCount = hiddenCount - 1;
                    setCurrentMarkerVisibility(1);
                    titleElement.textContent = `â˜¯ï¸ åŸƒæ™®è¥¿éš†ä¼ å• - ${name} (${hiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;
                    try { updateEpsilonTractsSidebarCount(); } catch (e) {}
                });
            }

            document.body.appendChild(popup);
        }

        // ==================== å¢å¼ºç‰ˆæ ¸åºŸæ–™æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º nuclear_waste å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachNuclearWasteCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.nuclear-waste-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'nuclear-waste-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateNuclearWasteSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateNuclearWasteSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-nuclear_waste + label .nuclear-waste-counter');
                if (!counterEl) return;

                // è·å–æ ¸åºŸæ–™æ ‡è®°
                const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
                const total = Array.isArray(window.itemData?.nuclear_waste) ? window.itemData.nuclear_waste.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('nuclear_waste');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('nuclear_waste', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ ¸åºŸæ–™è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // ==================== å¢å¼ºç‰ˆéšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º sp_hidden_packages å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSpHiddenPackagesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.sp-hidden-packages-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'sp-hidden-packages-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSpHiddenPackagesSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSpHiddenPackagesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-sp_hidden_packages + label .sp-hidden-packages-counter');
                if (!counterEl) return;

                // è·å–éšè—åŒ…è£¹æ ‡è®°
                const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
                const total = Array.isArray(window.itemData?.sp_hidden_packages) ? window.itemData.sp_hidden_packages.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('sp_hidden_packages');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('sp_hidden_packages', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }
            // åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç†-è½½å…· å¼¹çª—ï¼ˆæ ·å¼ä¸æ ¸åºŸæ–™ä¸€è‡´ï¼šåº•éƒ¨æŒ‰é’®ï¼Œç§»é™¤å³ä¸Šè§’Ã—ï¼‰
            function showAssumingTheTruthPopup(item, index) {
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/assuming_the_truth/assuming_the_truth_${sequenceNumber}.webp`;

            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.assuming-the-truth-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.assumingTheTruthMarkers && window.assumingTheTruthMarkers) || [];
            const totalCount = Array.isArray(window.itemData?.assuming_the_truth) ? window.itemData.assuming_the_truth.length : markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                const el = marker.getElement();
                if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const name = item?.name || `è½½å…· #${sequenceNumber}`;
            const title = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—ï¼ˆæ— å³ä¸Šè§’ Ã—ï¼Œä¿ç•™åº•éƒ¨æŒ‰é’®ï¼‰
            const popup = document.createElement('div');
            popup.className = 'assuming-the-truth-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                <!-- ç§»é™¤å³ä¸Šè§’ Ã— -->
                </div>
                <img src="${imageUrl}" alt="assuming_the_truth #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                <div style="font-weight: 700; margin-bottom: 6px;">${name}</div>
                <div>è¿™æ˜¯éœ€è¦è¿é€ç»™åŸƒæ™®è¥¿éš†è®¡åˆ’çš„è½½å…·ï¼Œæ˜¯é™Œç”Ÿäººä¸æ€ªå’–ä»»åŠ¡è´¨ç–‘çœŸç†ï¼ˆéº¦å…‹ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚<br/>è½½å…·æ€»æ˜¯åœ¨å›¾ç¤ºçš„ç¡®åˆ‡ä½ç½®ç”Ÿæˆã€‚</div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="hide-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                <button id="show-att-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                <button id="close-att-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-att-btn');
            const hideBtn = popup.querySelector('#hide-att-btn');
            const showBtn = popup.querySelector('#show-att-btn');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn && closeBtn.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                if (!popup.contains(e.target)) {
                    removePopup();
                    document.removeEventListener('click', closePopupHandler);
                }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆåŒæ ¸åºŸæ–™/çº¿ä¸‹åŒ…è£¹ï¼‰
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                e.stopPropagation();
                const overlay = document.createElement('div');
                overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10002; cursor: zoom-out;`;
                const bigImg = document.createElement('img');
                bigImg.src = popupImage.src;
                bigImg.alt = popupImage.alt || '';
                bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                overlay.appendChild(bigImg);
                const removeOverlay = () => { document.removeEventListener('keydown', onKey); overlay.remove(); };
                const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                overlay.addEventListener('click', removeOverlay);
                document.addEventListener('keydown', onKey);
                document.body.appendChild(overlay);
                });
            }

            // éšè—/æ˜¾ç¤ºé€»è¾‘ + ç¼“å­˜ + è®¡æ•°å™¨
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                currentMarker.setStyle({ opacity });
                }
                VisibilityCache.updateItemVisibility('assuming_the_truth', index, opacity === 0.3);
            }

            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                setCurrentMarkerVisibility(0.3);
                const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                titleElement.textContent = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                hideBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
                isCurrentHidden = true;
                try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                setCurrentMarkerVisibility(1);
                const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                titleElement.textContent = `â˜¸ï¸ åŸƒæ™®è¥¿éš†è´¨ç–‘çœŸç† - ${name} (${newHiddenCount}/${totalCount})`;
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
                isCurrentHidden = false;
                try { updateAssumingTheTruthSidebarCount(); } catch(e) {}
                });
            }

            document.body.appendChild(popup);
            }
        // éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSpHiddenPackagesImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/sp_hidden_packages/sp_hidden_packages_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.sp-hidden-packages-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // è·å–æè¿°ä¿¡æ¯
            const item = window.itemData?.sp_hidden_packages?.[index];
            const description = item?.description || '';
            let displayDescription = description;
            
            // å¦‚æœæè¿°åŒ…å«trevorï¼Œæ·»åŠ é¢å¤–ä¿¡æ¯
            if (description.toLowerCase().includes('trevor')) {
                displayDescription += ' åœ¨å´”ä½›å¸¦è¿‡ 4 åæ­è½¦äºº ï¼ˆä¸æ˜¯å¸¦äºº 4 æ¬¡ã€‚ä¸€æ¬¡å¸¦æ¥ 2 äººï¼Œè¿›åº¦åŠ  2ï¼‰åˆ°åˆ©ä»–è¥åœ°åï¼Œä¸é‚ªæ•™å¾’å‘ç”Ÿæªæˆ˜  åè§£é”ã€‚';
            }

            const title = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'sp-hidden-packages-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${displayDescription || 'å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼'}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-sp-hidden-packages-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-sp-hidden-packages-btn');
            const hideBtn = popup.querySelector('#hide-sp-hidden-packages-btn');
            const showBtn = popup.querySelector('#show-sp-hidden-packages-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'sp-hidden-packages-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('sp_hidden_packages', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ“¦ éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSpHiddenPackagesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰æ ‡è®°
        function applySpHiddenPackagesVisibilityCache() {
            const markers = (window.spHiddenPackagesMarkers && window.spHiddenPackagesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('sp_hidden_packages');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨éšè—åŒ…è£¹ï¼ˆçº¿ä¸‹ï¼‰å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== å¢å¼ºç‰ˆæ½œæ°´è‰‡ç¢ç‰‡æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // åˆ›å»ºä¾§è¾¹æ æ¡ç›®æ—¶ï¼Œä¸º submarine_pieces å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨å ä½
        function attachSubmarinePiecesCounterToLabel(sidebarCheckboxId) {
            const label = document.querySelector(`#${sidebarCheckboxId} + label`);
            if (!label) return;

            let counter = label.querySelector('.submarine-pieces-counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'submarine-pieces-counter';
                counter.style.marginLeft = '6px';
                counter.style.color = 'var(--gta-text-secondary)';
                label.appendChild(counter);
            }

            // åˆæ¬¡æ¸²æŸ“è®¡æ•°
            updateSubmarinePiecesSidebarCount();
        }

        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateSubmarinePiecesSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-submarine_pieces + label .submarine-pieces-counter');
                if (!counterEl) return;

                // è·å–æ½œæ°´è‰‡ç¢ç‰‡æ ‡è®°
                const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
                const total = Array.isArray(window.itemData?.submarine_pieces) ? window.itemData.submarine_pieces.length : 0;
                let hidden = 0;

                let hasRenderedMarker = false;
                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el) {
                                hasRenderedMarker = true;
                                if (el.style.opacity === '0.3') hidden++;
                            }
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('submarine_pieces');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('submarine_pieces', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ½œæ°´è‰‡ç¢ç‰‡è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // æ½œæ°´è‰‡ç¢ç‰‡å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showSubmarinePiecesImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/submarine_pieces/submarine_pieces_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.submarine-pieces-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `ğŸš¢ æ½œæ°´è‰‡ç¢ç‰‡ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'submarine-pieces-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ½œæ°´è‰‡ç¢ç‰‡ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ¸¸æˆä¸­æ€»å…±æœ‰ 30 ä¸ªæ½œæ°´è‰‡ç¢ç‰‡ã€‚è¦æ”¶é›†è¿™äº›ç¢ç‰‡ï¼Œæ‚¨å¿…é¡»åœ¨å®Œæˆä¸»çº¿ä»»åŠ¡æŠ¢åŠ«æ¢…åˆ©å¨ç‘Ÿä¸é—ªç”µçªè¢­åï¼Œä½¿ç”¨ä»»æ„è§’è‰²è´­ä¹°å£°å‘æ‰“æç å¤´ï¼ˆ250.000 GTA$ï¼‰ï¼Œä»¥æ­¤æ¥å–é™Œç”Ÿäººå’Œæ€ªèƒä»»åŠ¡æ·±æµ·æ„å¤–ï¼ˆéº¦å…‹ï¼‰ã€‚<br><br>
                    æ¯ä¸ªè§’è‰²éƒ½å¯ä»¥æ‹¾å–ç¢ç‰‡ï¼Œä½†åªæœ‰éº¦å…‹å¯ä»¥äº¤ä»˜å®ƒä»¬ã€‚æ‚¨æœ€å¥½ä½¿ç”¨è´­ä¹°ç å¤´é™„èµ çš„å°è‰‡ã€‚é©¾é©¶è¯¥è½½å…·æ—¶ï¼Œæ¸¸æˆä¼šæ˜¾ç¤ºç¢ç‰‡æ‰€åœ¨çš„åŒºåŸŸï¼Œå¹¶ä»¥ç»¿è‰²åŒºåŸŸæ ‡è¯†åœ¨åœ°å›¾ä¸Šã€‚ç¢ç‰‡ä¼šå‘å‡ºå£°æ³¢ï¼Œæ‚¨å¯ä»¥åœ¨å°åœ°å›¾ä¸Šçœ‹åˆ°ã€‚<br><br>
                    ä¸€æ—¦é›†é½æ‰€æœ‰ç¢ç‰‡ï¼Œæ‚¨å°†è§£é”é™Œç”Ÿäººå’Œæ€ªèƒä»»åŠ¡çœŸç›¸æµ®ç°ï¼ˆéº¦å…‹ï¼‰ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-submarine-pieces-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-submarine-pieces-btn');
            const hideBtn = popup.querySelector('#hide-submarine-pieces-btn');
            const showBtn = popup.querySelector('#show-submarine-pieces-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'submarine-pieces-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('submarine_pieces', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸš¢ æ½œæ°´è‰‡ç¢ç‰‡ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSubmarinePiecesSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸš¢ æ½œæ°´è‰‡ç¢ç‰‡ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateSubmarinePiecesSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ½œæ°´è‰‡ç¢ç‰‡æ ‡è®°
        function applySubmarinePiecesVisibilityCache() {
            const markers = (window.submarinePiecesMarkers && window.submarinePiecesMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('submarine_pieces');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ½œæ°´è‰‡ç¢ç‰‡å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // æ ¸åºŸæ–™å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showNuclearWasteImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/nuclear_waste/nuclear_waste_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.nuclear-waste-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            const title = `â˜¢ï¸ æ ¸åºŸæ–™ #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'nuclear-waste-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ ¸åºŸæ–™ #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    å¯åœ¨ä¸Šå›¾ä½ç½®æ‰¾åˆ°ï¼
                </div>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ğŸ¯ æ”¶é›†å¥–åŠ±</div>
                    æ€»å…±æœ‰ 30 ä¸ªæ ¸åºŸæ–™æ¡¶ï¼Œè¦æƒ³æ”¶é›†è¿™äº›æ ¸åºŸæ–™ï¼Œæ‚¨å¿…é¡»å®Œæˆä¸»çº¿ä»»åŠ¡ æŠ¢åŠ«æ¢…åˆ©å¨ç‘Ÿï¼Œå¹¶ç”¨ä»»æ„è§’è‰²è´­ä¹° å£°å‘æ‰“æç å¤´ (250.000 GTA$)ã€‚<br>
                    æ¯ä¸ªè§’è‰²éƒ½å¯ä»¥æ‹¾å–æ ¸åºŸæ–™æ¡¶ï¼Œä½†åªæœ‰æ‹¥æœ‰ç å¤´çš„è§’è‰²æ‰å¯ä»¥è·å¾—ç°é‡‘å¥–åŠ±ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è´­ä¹°ç å¤´é™„èµ çš„ æ½œæ°´è‰‡/æµ·æ€ªã€‚é©¾é©¶è¯¥è½½å…·æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Trackify APPï¼Œå®ƒå¯ä»¥æŒ‡ç¤ºæ ¸åºŸæ–™çš„ä½ç½®ã€‚æ­¤å¤–ï¼Œæœ‰äº›æ ¸åºŸæ–™æ¡¶çš„ä½ç½®ç¡®å®å¾ˆæ·±ã€‚<br><br>
                    æ¯ä¸ªæ ¸åºŸæ–™çš„å¥–åŠ±æ˜¯ 23.000 GTA$ ï¼Œå®Œæˆè¯¥æ”¶é›†å°†è·å¾— 250.000 GTA$ å’Œä¸€ä¸ªæˆå°±ã€‚
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-nuclear-waste-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-nuclear-waste-btn');
            const hideBtn = popup.querySelector('#hide-nuclear-waste-btn');
            const showBtn = popup.querySelector('#show-nuclear-waste-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'nuclear-waste-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('nuclear_waste', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `â˜¢ï¸ æ ¸åºŸæ–™ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateNuclearWasteSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `â˜¢ï¸ æ ¸åºŸæ–™ #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateNuclearWasteSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ°æ ¸åºŸæ–™æ ‡è®°
        function applyNuclearWasteVisibilityCache() {
            const markers = (window.nuclearWasteMarkers && window.nuclearWasteMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('nuclear_waste');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ ¸åºŸæ–™å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }

        // ==================== å¢å¼ºç‰ˆæ´›åœ£éƒ½çš„äººç±»æ¨¡æ¿ï¼ˆé›†æˆç¼“å­˜ï¼‰ ====================
        
        // ç»Ÿè®¡éšè—/æ€»æ•°ï¼Œå¹¶æ›´æ–°ä¾§è¾¹æ è®¡æ•°å™¨æ–‡æœ¬ï¼ˆé›†æˆç¼“å­˜ï¼‰
        function updateHumansOfLsSidebarCount() {
            try {
                const counterEl = document.querySelector('#sidebar-item-humans_of_ls + label .humans-of-ls-counter');
                if (!counterEl) return;

                // è·å– humans_of_ls æ ‡è®°
                const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
                const total = Array.isArray(window.itemData?.humans_of_ls) ? window.itemData.humans_of_ls.length : 0;
                let hidden = 0;

                if (Array.isArray(markers) && markers.length > 0) {
                    for (const marker of markers) {
                        if (marker && typeof marker.getElement === 'function') {
                            const el = marker.getElement();
                            if (el && el.style.opacity === '0.3') hidden++;
                        }
                    }
                }

                // ä¸ç¼“å­˜åˆå¹¶ï¼Œé˜²æ­¢é‡æ–°æ˜¾ç¤ºåéšè—è®¡æ•°è¢«æ¸…é›¶
                const cachedCounter = CounterCache.getCounter('humans_of_ls');
                hidden = Math.max(hidden, cachedCounter.hidden || 0);

                // æ›´æ–°ç¼“å­˜
                CounterCache.updateCounter('humans_of_ls', hidden, total);
                counterEl.textContent = total > 0 ? ` (${hidden}/${total})` : '';
            } catch (e) {
                console.warn('æ›´æ–°æ´›åœ£éƒ½çš„äººç±»è®¡æ•°å™¨å¤±è´¥:', e);
            }
        }

        // æ´›åœ£éƒ½çš„äººç±»å¼¹çª—æ¨¡æ¿ï¼ˆå«éšè—/æ˜¾ç¤ºè”åŠ¨ä¸è®¡æ•°å™¨ã€ç¼“å­˜é›†æˆï¼‰
        function showHumansOfLsImage(index) {
            // åºå·ä»1å¼€å§‹
            const sequenceNumber = index + 1;
            const imageUrl = `https://gta-maps.antwen.com/collectibles_images/humans_of_ls/humans_of_ls_${sequenceNumber}.webp`;
            
            // å…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingPopup = document.querySelector('.humans-of-ls-popup');
            if (existingPopup) existingPopup.remove();

            // ç»Ÿè®¡éšè—/æ€»æ•°
            const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
            const totalCount = markers.length;

            let hiddenCount = 0;
            markers.forEach((marker) => {
                if (marker && typeof marker.getElement === 'function') {
                    const el = marker.getElement();
                    if (el && el.style.opacity === '0.3') hiddenCount++;
                }
            });

            const currentMarker = markers[index];
            let isCurrentHidden = false;
            if (currentMarker && typeof currentMarker.getElement === 'function') {
                const el = currentMarker.getElement();
                isCurrentHidden = el && el.style.opacity === '0.3';
            }

            // æè¿°å†…å®¹ï¼šä½¿ç”¨ zones.json ä¸­çš„ ID + å›ºå®šè¯´æ˜
            const item = window.itemData?.humans_of_ls?.[index];
            const idText = item?.id || `humans_of_ls_${sequenceNumber}`;
            const displayDescription = `${idText}ï¼šä¸æ‚¨é‡åˆ°çš„è§’è‰²äº¤è°ˆï¼Œå³å¯åœ¨å¯¼æ¼”æ¨¡å¼ä¸­è§£é”ä»–ä»¬ã€‚ä¸€æ—¦æ‚¨è§£é”äº†æ‰€æœ‰è§’è‰²ï¼Œå¹¶ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªæˆå°±ã€‚`;

            const title = `ğŸ‘¤ æ´›åœ£éƒ½çš„äººç±» #${sequenceNumber} (${hiddenCount}/${totalCount})`;

            // æ„å»ºå¼¹çª—ï¼ˆæ ·å¼ä¸æ ¸åºŸæ–™ä¸€è‡´ï¼‰
            const popup = document.createElement('div');
            popup.className = 'humans-of-ls-popup';
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--gta-bg-medium);
                border: 1px solid var(--gta-border);
                border-radius: 8px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.5);
                padding: 15px;
                z-index: 10000;
                width: min(92vw, 520px);
                max-height: 80vh;
                color: var(--gta-text);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <div class="popup-header" style="position: relative; margin-bottom: 14px;">
                    <h3 style="color: var(--gta-primary); font-size: 18px; margin: 0; font-weight: bold;">${title}</h3>
                    <span class="popup-close" style="position: absolute; top: 0; right: 0; color: var(--gta-text-secondary); font-size: 20px; cursor: pointer; transition: color 0.3s ease;">Ã—</span>
                </div>
                <img src="${imageUrl}" alt="æ´›åœ£éƒ½çš„äººç±» #${sequenceNumber}" style="max-width: 100%; height: auto; border-radius: 6px; margin: 8px 0; display: block; cursor: zoom-in;"/>
                <div style="margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; color: var(--gta-text); font-size: 14px; line-height: 1.6;">
                    ${displayDescription}
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="hide-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'none' : 'inline-block'};">éšè—</button>
                    <button id="show-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-bg-dark); color: var(--gta-text); border: 1px solid var(--gta-border); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: ${isCurrentHidden ? 'inline-block' : 'none'};">æ˜¾ç¤º</button>
                    <button id="close-humans-of-ls-btn" style="padding: 8px 16px; background: var(--gta-primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">å…³é—­</button>
                </div>
            `;

            // ç»‘å®šå…ƒç´ 
            const closeBtn = popup.querySelector('#close-humans-of-ls-btn');
            const hideBtn = popup.querySelector('#hide-humans-of-ls-btn');
            const showBtn = popup.querySelector('#show-humans-of-ls-btn');
            const popupClose = popup.querySelector('.popup-close');
            const titleElement = popup.querySelector('h3');

            // å…³é—­å¼¹çª—
            const removePopup = () => popup.remove();
            closeBtn.addEventListener('click', removePopup);
            popupClose.addEventListener('click', removePopup);
            popup.addEventListener('click', (e) => e.stopPropagation());
            setTimeout(() => {
                const closePopupHandler = (e) => {
                    if (!popup.contains(e.target)) {
                        removePopup();
                        document.removeEventListener('click', closePopupHandler);
                    }
                };
                document.addEventListener('click', closePopupHandler);
            }, 50);

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            const popupImage = popup.querySelector('img');
            if (popupImage) {
                popupImage.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const overlay = document.createElement('div');
                    overlay.className = 'humans-of-ls-image-overlay';
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                        display: flex; align-items: center; justify-content: center;
                        z-index: 10002; cursor: zoom-out;
                    `;
                    const bigImg = document.createElement('img');
                    bigImg.src = popupImage.src;
                    bigImg.alt = popupImage.alt || '';
                    bigImg.style.cssText = `max-width: 95vw; max-height: 95vh; border-radius: 6px; box-shadow: 0 4px 24px rgba(0,0,0,0.6);`;
                    overlay.appendChild(bigImg);

                    const removeOverlay = () => {
                        document.removeEventListener('keydown', onKey);
                        overlay.remove();
                    };
                    const onKey = (ev) => { if (ev.key === 'Escape') removeOverlay(); };
                    overlay.addEventListener('click', removeOverlay);
                    document.addEventListener('keydown', onKey);
                    document.body.appendChild(overlay);
                });
            }

            // å·¥å…·ï¼šéšè—/æ˜¾ç¤ºå½“å‰æ ‡è®°
            function setCurrentMarkerVisibility(opacity) {
                if (currentMarker && typeof currentMarker.setOpacity === 'function') {
                    currentMarker.setOpacity(opacity);
                } else if (currentMarker && typeof currentMarker.setStyle === 'function') {
                    currentMarker.setStyle({ opacity });
                }
                
                // æ›´æ–°ç¼“å­˜
                VisibilityCache.updateItemVisibility('humans_of_ls', index, opacity === 0.3);
            }

            // éšè—æŒ‰é’®
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(0.3);
                    const newHiddenCount = hiddenCount + (isCurrentHidden ? 0 : 1);
                    titleElement.textContent = `ğŸ‘¤ æ´›åœ£éƒ½çš„äººç±» #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    hideBtn.style.display = 'none';
                    showBtn.style.display = 'inline-block';
                    isCurrentHidden = true;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateHumansOfLsSidebarCount();
                });
            }

            // æ˜¾ç¤ºæŒ‰é’®
            if (showBtn) {
                showBtn.addEventListener('click', () => {
                    setCurrentMarkerVisibility(1);
                    const newHiddenCount = hiddenCount - (isCurrentHidden ? 1 : 0);
                    titleElement.textContent = `ğŸ‘¤ æ´›åœ£éƒ½çš„äººç±» #${sequenceNumber} (${newHiddenCount}/${totalCount})`;
                    showBtn.style.display = 'none';
                    hideBtn.style.display = 'inline-block';
                    isCurrentHidden = false;

                    // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                    updateHumansOfLsSidebarCount();
                });
            }

            document.body.appendChild(popup);
        }

        // åº”ç”¨ç¼“å­˜çš„å¯è§æ€§çŠ¶æ€åˆ° humans_of_ls æ ‡è®°
        function applyHumansOfLsVisibilityCache() {
            const markers = (window.humansOfLsMarkers && window.humansOfLsMarkers) || [];
            if (markers.length > 0) {
                const visibilityMap = VisibilityCache.loadVisibility('humans_of_ls');
                markers.forEach((marker, index) => {
                    const isHidden = visibilityMap[index];
                    if (isHidden && marker) {
                        if (typeof marker.setOpacity === 'function') {
                            marker.setOpacity(0.3);
                        } else if (typeof marker.setStyle === 'function') {
                            marker.setStyle({ opacity: 0.3 });
                        }
                    }
                });
                console.log('å·²åº”ç”¨æ´›åœ£éƒ½çš„äººç±»å¯è§æ€§ç¼“å­˜');
                return true;
            }
            return false;
        }
    </script>

</body>
</html>

